/**
 * Generated Reports AMD module for Adeptus Insights.
 *
 * @module     report_adeptus_insights/generated_reports
 * @package    report_adeptus_insights
 * @copyright  2026 Adeptus 360 <info@adeptus360.com>
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("report_adeptus_insights/generated_reports",["jquery","core/ajax","core/str","core/chartjs"],(function($,Ajax,Str,Chart){var STRINGS={},GeneratedReports={backendUrl:"",cachedReports:[],cachedCategories:[],currentReport:null,currentReportData:null,reportsDataTable:null,retryCount:0,maxRetries:3,currentView:"table",chartInstance:null,Chart:Chart,strings:STRINGS,isFreePlan:!0,init:function(config){this.backendUrl=config.backendUrl||"",this.isFreePlan=!1!==config.isFreePlan,this.strings=STRINGS,this.loadReports(),this.loadCategories(),this.bindViewToggle(),this.bindCategoryManagement()},showExportUpgradePrompt:function(format){var subscriptionUrl=M.cfg.wwwroot+"/report/adeptus_insights/subscription.php",formatName={csv:"CSV",excel:"Excel",json:"JSON"}[format]||format.toUpperCase();Swal.fire({title:STRINGS.premiumExportFormat,html:'<div style="text-align: center; padding: 20px;"><div style="font-size: 48px; color: #f39c12; margin-bottom: 15px;"><i class="fa fa-crown"></i></div><h3 style="color: #2c3e50; margin-bottom: 15px;">'+formatName+" "+STRINGS.premiumFeature+'</h3><p style="color: #7f8c8d; font-size: 16px; line-height: 1.6; margin-bottom: 25px;">'+STRINGS.exportUpgradeMessage.replace("{format}",formatName)+'</p><div style="background: #ecf0f1; padding: 15px; border-radius: 8px; margin-bottom: 20px;"><p style="margin: 0; font-size: 14px; color: #34495e;"><strong>'+STRINGS.freePlan+"</strong> "+STRINGS.freePlanPdfOnly+"<br><strong>"+STRINGS.paidPlans+"</strong> "+STRINGS.paidPlansAllFormats+"</p></div></div>",showCancelButton:!0,confirmButtonText:'<i class="fa fa-arrow-up"></i> '+STRINGS.upgradeNow,cancelButtonText:'<i class="fa fa-times"></i> '+STRINGS.cancel,confirmButtonColor:"#3498db",cancelButtonColor:"#95a5a6",width:500}).then((function(result){result.isConfirmed&&window.open(subscriptionUrl,"_blank")}))},checkExportEligibility:function(format){return new Promise((function(resolve){Ajax.call([{methodname:"report_adeptus_insights_check_export_eligibility",args:{format:format}}])[0].done((function(result){var data=result.data?result.data:result;resolve(data)})).fail((function(error){window.console.error("Error checking export eligibility:",error),resolve({success:!1,eligible:!1,message:"Unable to verify export eligibility."})}))}))},captureChartImage:function(){var self=this;return new Promise((function(resolve){setTimeout((function(){var chartCanvas=document.getElementById("report-chart");if(!chartCanvas)return window.console.warn("[GeneratedReports] Chart canvas not found"),void resolve(null);try{var dataUrl=chartCanvas.toDataURL("image/png",.8);if(dataUrl&&dataUrl.length>100&&dataUrl.length<2e6)return window.console.log("[GeneratedReports] Chart captured via toDataURL, size:",dataUrl.length),void resolve(dataUrl)}catch(e){window.console.warn("[GeneratedReports] Native canvas capture failed:",e)}self.loadHtml2Canvas().then((function(){window.html2canvas?window.html2canvas(chartCanvas,{backgroundColor:"#ffffff",scale:1.5,useCORS:!0,allowTaint:!0,logging:!1}).then((function(capturedCanvas){var dataUrl=capturedCanvas.toDataURL("image/png",.8);if(dataUrl&&dataUrl.length>100&&dataUrl.length<2e6)return window.console.log("[GeneratedReports] Chart captured via html2canvas, size:",dataUrl.length),void resolve(dataUrl);resolve(null)})).catch((function(){resolve(null)})):resolve(null)})).catch((function(){resolve(null)}))}),300)}))},loadHtml2Canvas:function(){return new Promise((function(resolve,reject){if(window.html2canvas)resolve();else{var script=document.createElement("script");script.src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js",script.onload=function(){resolve()},script.onerror=function(){reject(new Error("Failed to load html2canvas"))},document.head.appendChild(script)}}))},showToast:function(message,type){type=type||"success";var toastContainer=document.getElementById("adeptus-toast-container");toastContainer||((toastContainer=document.createElement("div")).id="adeptus-toast-container",toastContainer.style.cssText="position: fixed; top: 20px; right: 20px; z-index: 10000;",document.body.appendChild(toastContainer));var toast=document.createElement("div");toast.style.cssText="background: "+{success:"#28a745",error:"#dc3545",warning:"#ffc107",info:"#17a2b8"}[type]+"; color: "+{success:"white",error:"white",warning:"#212529",info:"white"}[type]+"; padding: 12px 20px; border-radius: 8px; margin-bottom: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); display: flex; align-items: center; gap: 10px; animation: slideIn 0.3s ease; min-width: 280px;",toast.innerHTML='<i class="fa '+{success:"fa-check-circle",error:"fa-times-circle",warning:"fa-exclamation-triangle",info:"fa-info-circle"}[type]+'"></i><span>'+message+"</span>",toastContainer.appendChild(toast),setTimeout((function(){toast.style.animation="slideOut 0.3s ease forwards",setTimeout((function(){toast.parentNode&&toast.parentNode.removeChild(toast)}),300)}),3e3)},trackExport:function(format,reportName){fetch(M.cfg.wwwroot+"/report/adeptus_insights/ajax/track_export.php",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:"format="+encodeURIComponent(format)+"&report_name="+encodeURIComponent(reportName)+"&sesskey="+M.cfg.sesskey}).then((function(response){return response.json()})).then((function(data){window.console.log("[GeneratedReports] Export tracked:",data)})).catch((function(error){window.console.error("[GeneratedReports] Error tracking export:",error)}))},bindViewToggle:function(){var self=this;$(document).on("click",".adeptus-view-toggle-btn",(function(){var view=$(this).data("view");self.switchView(view)})),$(document).on("change","#chart-type-select, #chart-x-axis, #chart-y-axis",(function(){self.renderChart()}))},bindCategoryManagement:function(){var self=this;$("#manage-categories-btn").on("click",(function(){self.showCategoryManagementModal()}))},loadCategories:function(){var self=this;$.ajax({url:M.cfg.wwwroot+"/report/adeptus_insights/ajax/manage_category.php",method:"POST",dataType:"json",data:{action:"list",sesskey:M.cfg.sesskey},success:function(response){response.success&&response.data&&(self.cachedCategories=response.data)},error:function(){self.cachedCategories=[]}})},showCategoryManagementModal:function(){var self=this,systemCategories=self.cachedCategories.filter((function(c){return c.is_system})),customCategories=self.cachedCategories.filter((function(c){return!c.is_system})),customCategoriesHtml=customCategories.length>0?customCategories.map((function(cat){return'<div class="adeptus-cat-card" data-id="'+cat.id+'"><div class="adeptus-cat-card-color" style="background: '+(cat.color||"#6c757d")+';"></div><div class="adeptus-cat-card-content"><div class="adeptus-cat-card-name">'+cat.name+'</div><div class="adeptus-cat-card-meta">'+(cat.report_count||0)+" report"+(1!==cat.report_count?"s":"")+'</div></div><div class="adeptus-cat-card-actions"><button class="adeptus-cat-action-btn edit-cat-btn" data-id="'+cat.id+'" title="Edit"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg></button><button class="adeptus-cat-action-btn adeptus-cat-action-btn-danger delete-cat-btn" data-id="'+cat.id+'" title="Delete"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button></div></div>'})).join(""):'<div class="adeptus-cat-empty-state"><div class="adeptus-cat-empty-icon"><svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path><line x1="12" y1="11" x2="12" y2="17"></line><line x1="9" y1="14" x2="15" y2="14"></line></svg></div><div class="adeptus-cat-empty-text">'+STRINGS.noCustomCategories+'</div><div class="adeptus-cat-empty-hint">'+STRINGS.createFirstCategory+"</div></div>",systemCategoriesHtml=systemCategories.map((function(cat){return'<div class="adeptus-cat-system-item"><span class="adeptus-cat-system-dot" style="background: '+(cat.color||"#6c757d")+';"></span><span class="adeptus-cat-system-name">'+cat.name+'</span><span class="adeptus-cat-system-count">'+(cat.report_count||0)+"</span></div>"})).join(""),colorSwatchesHtml=["#3b82f6","#10b981","#f59e0b","#ef4444","#8b5cf6","#ec4899","#06b6d4","#84cc16"].map((function(color){return'<button type="button" class="adeptus-cat-color-swatch" data-color="'+color+'" style="background: '+color+';"></button>'})).join("");Swal.fire({title:STRINGS.categories,html:'<div class="adeptus-cat-modal"><div class="adeptus-cat-add-section"><div class="adeptus-cat-add-header">'+STRINGS.createNewCategory+'</div><div class="adeptus-cat-add-form"><div class="adeptus-cat-add-input-wrapper"><input type="text" id="new-category-name" class="adeptus-cat-add-input" placeholder="'+STRINGS.categoryName+'"><div class="adeptus-cat-add-color-wrapper"><button type="button" class="adeptus-cat-add-color-btn" id="color-picker-toggle"><span class="adeptus-cat-add-color-preview" id="selected-color-preview" style="background: #3b82f6;"></span><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"></polyline></svg></button><div class="adeptus-cat-color-dropdown" id="color-dropdown"><div class="adeptus-cat-color-swatches">'+colorSwatchesHtml+'</div><div class="adeptus-cat-color-custom"><input type="color" id="new-category-color" value="#3b82f6"><span>'+STRINGS.customColor+'</span></div></div></div></div><button type="button" class="adeptus-cat-add-btn" id="add-category-btn"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg> Add</button></div></div><div class="adeptus-cat-section"><div class="adeptus-cat-section-header"><span class="adeptus-cat-section-title">'+STRINGS.yourCategories+'</span><span class="adeptus-cat-section-count">'+customCategories.length+'</span></div><div class="adeptus-cat-cards-list">'+customCategoriesHtml+'</div></div><div class="adeptus-cat-section adeptus-cat-section-system"><div class="adeptus-cat-section-header"><span class="adeptus-cat-section-title">'+STRINGS.defaultCategories+'</span><span class="adeptus-cat-section-badge">'+STRINGS.readOnly+'</span></div><div class="adeptus-cat-system-list">'+systemCategoriesHtml+"</div></div></div>",showConfirmButton:!1,showCloseButton:!0,width:"480px",customClass:{popup:"adeptus-cat-modal-popup",title:"adeptus-cat-modal-title",closeButton:"adeptus-cat-modal-close",htmlContainer:"adeptus-cat-modal-container"},didOpen:function(){var selectedColor="#3b82f6";$("#color-picker-toggle").on("click",(function(e){e.preventDefault(),e.stopPropagation(),$("#color-dropdown").toggleClass("show")})),$("#color-dropdown").on("click",(function(e){e.stopPropagation()})),$(document).on("click.colorDropdown",(function(e){$(e.target).closest(".adeptus-cat-add-color-wrapper").length||$("#color-dropdown").removeClass("show")})),$(".adeptus-cat-color-swatch").on("click",(function(e){e.preventDefault(),e.stopPropagation(),selectedColor=$(this).data("color"),$("#selected-color-preview").css("background",selectedColor),$("#new-category-color").val(selectedColor),$("#color-dropdown").removeClass("show")})),$("#new-category-color").on("input change",(function(e){e.stopPropagation(),selectedColor=$(this).val(),$("#selected-color-preview").css("background",selectedColor)})),$("#add-category-btn").on("click",(function(){var name=$("#new-category-name").val().trim();name?self.createCategory(name,selectedColor):($("#new-category-name").addClass("error").focus(),setTimeout((function(){$("#new-category-name").removeClass("error")}),500))})),$("#new-category-name").on("keypress",(function(e){13===e.which&&$("#add-category-btn").click()})),$(".edit-cat-btn").on("click",(function(e){e.stopPropagation();var catId=$(this).data("id"),cat=self.cachedCategories.find((function(c){return c.id==catId}));cat&&($(document).off("click.colorDropdown"),self.showEditCategoryDialog(cat))})),$(".delete-cat-btn").on("click",(function(e){e.stopPropagation();var catId=$(this).data("id"),cat=self.cachedCategories.find((function(c){return c.id==catId}));cat&&($(document).off("click.colorDropdown"),self.confirmDeleteCategory(cat))}))},willClose:function(){$(document).off("click.colorDropdown")}})},createCategory:function(name,color){var self=this;$.ajax({url:M.cfg.wwwroot+"/report/adeptus_insights/ajax/manage_category.php",method:"POST",dataType:"json",data:{action:"create",name:name,color:color,sesskey:M.cfg.sesskey},success:function(response){response.success?(self.cachedCategories.push(response.data),Swal.close(),Swal.fire({icon:"success",title:STRINGS.categoryCreated,timer:1500,showConfirmButton:!1}).then((function(){self.showCategoryManagementModal()}))):Swal.showValidationMessage(response.message)},error:function(xhr){var msg=xhr.responseJSON&&xhr.responseJSON.message||"Failed to create category";Swal.fire({icon:"error",title:STRINGS.error,text:msg})}})},showEditCategoryDialog:function(category){var self=this,colorSwatchesHtml=["#3b82f6","#10b981","#f59e0b","#ef4444","#8b5cf6","#ec4899","#06b6d4","#84cc16"].map((function(color){return'<button type="button" class="adeptus-edit-color-swatch'+(color.toLowerCase()===(category.color||"#6c757d").toLowerCase()?" selected":"")+'" data-color="'+color+'" style="background: '+color+';"></button>'})).join("");Swal.fire({title:STRINGS.editCategory,html:'<div class="adeptus-cat-edit-modal"><div class="adeptus-cat-edit-preview" id="edit-preview"><div class="adeptus-cat-edit-preview-color" id="edit-preview-color" style="background: '+(category.color||"#6c757d")+';"></div><span class="adeptus-cat-edit-preview-name" id="edit-preview-name">'+category.name+'</span></div><div class="adeptus-cat-edit-field"><label class="adeptus-cat-edit-label">'+STRINGS.name+'</label><input type="text" id="edit-cat-name" class="adeptus-cat-edit-input" value="'+category.name.replace(/"/g,"&quot;")+'"></div><div class="adeptus-cat-edit-field"><label class="adeptus-cat-edit-label">'+STRINGS.color+'</label><div class="adeptus-cat-edit-colors"><div class="adeptus-cat-edit-swatches">'+colorSwatchesHtml+'</div><div class="adeptus-cat-edit-custom"><input type="color" id="edit-adeptus-cat-color" value="'+(category.color||"#6c757d")+'"><span>'+STRINGS.custom+"</span></div></div></div></div>",showCancelButton:!0,confirmButtonText:STRINGS.saveChanges,cancelButtonText:STRINGS.cancel,customClass:{popup:"adeptus-cat-edit-popup",confirmButton:"adeptus-cat-edit-confirm-btn",cancelButton:"adeptus-cat-edit-cancel-btn"},didOpen:function(){var selectedColor=category.color||"#6c757d";$("#edit-cat-name").on("input",(function(){$("#edit-preview-name").text($(this).val()||"Category")})),$(".adeptus-edit-color-swatch").on("click",(function(){selectedColor=$(this).data("color"),$(".adeptus-edit-color-swatch").removeClass("selected"),$(this).addClass("selected"),$("#edit-preview-color").css("background",selectedColor),$("#edit-adeptus-cat-color").val(selectedColor)})),$("#edit-adeptus-cat-color").on("input",(function(){selectedColor=$(this).val(),$(".adeptus-edit-color-swatch").removeClass("selected"),$("#edit-preview-color").css("background",selectedColor)}))},preConfirm:function(){var name=document.getElementById("edit-cat-name").value.trim(),color=document.getElementById("edit-adeptus-cat-color").value;return name?{name:name,color:color}:(Swal.showValidationMessage(STRINGS.pleaseEnterCategoryName),!1)}}).then((function(result){result.isConfirmed&&self.updateCategory(category.id,result.value.name,result.value.color)}))},updateCategory:function(categoryId,name,color){var self=this;$.ajax({url:M.cfg.wwwroot+"/report/adeptus_insights/ajax/manage_category.php",method:"POST",dataType:"json",data:{action:"update",category_id:categoryId,name:name,color:color,sesskey:M.cfg.sesskey},success:function(response){if(response.success){var idx=self.cachedCategories.findIndex((function(c){return c.id==categoryId}));-1!==idx&&(self.cachedCategories[idx]=response.data),Swal.fire({icon:"success",title:STRINGS.categoryUpdated,timer:1500,showConfirmButton:!1}).then((function(){self.showCategoryManagementModal()}))}else Swal.fire({icon:"error",title:STRINGS.error,text:response.message})},error:function(xhr){var msg=xhr.responseJSON&&xhr.responseJSON.message||"";Swal.fire({icon:"error",title:STRINGS.error,text:msg})}})},confirmDeleteCategory:function(category){var self=this;Swal.fire({title:STRINGS.deleteCategoryConfirm,html:"<p>"+STRINGS.deleteCategoryWarning.replace("{name}","<strong>"+category.name+"</strong>")+"</p>",icon:"warning",showCancelButton:!0,confirmButtonColor:"#dc3545",confirmButtonText:STRINGS.yesDelete,cancelButtonText:STRINGS.cancel}).then((function(result){result.isConfirmed&&self.deleteCategory(category.id)}))},deleteCategory:function(categoryId){var self=this;$.ajax({url:M.cfg.wwwroot+"/report/adeptus_insights/ajax/manage_category.php",method:"POST",dataType:"json",data:{action:"delete",category_id:categoryId,sesskey:M.cfg.sesskey},success:function(response){response.success?(self.cachedCategories=self.cachedCategories.filter((function(c){return c.id!=categoryId})),Swal.fire({icon:"success",title:STRINGS.categoryDeleted,timer:2e3,showConfirmButton:!1}).then((function(){self.showCategoryManagementModal()}))):Swal.fire({icon:"error",title:STRINGS.error,text:response.message})},error:function(xhr){var msg=xhr.responseJSON&&xhr.responseJSON.message||"Failed to delete category";Swal.fire({icon:"error",title:STRINGS.error,text:msg})}})},confirmDeleteReport:function(report){var self=this;if(report||(report=self.currentReport),report&&report.slug){var reportName=report.description||report.name||STRINGS.untitledReport,source=(report.source||"assistant").toLowerCase();"wizard"===source?STRINGS.wizard:STRINGS.ai;Swal.fire({title:STRINGS.deleteReportConfirm,html:"<p>"+STRINGS.deleteReportWarning.replace("{name}","<strong>"+reportName+"</strong>")+"</p>",icon:"warning",showCancelButton:!0,confirmButtonColor:"#dc3545",confirmButtonText:'<i class="fa fa-trash"></i> '+STRINGS.yesDelete,cancelButtonText:STRINGS.cancel}).then((function(result){result.isConfirmed&&self.deleteReport(report.slug,source,reportName)}))}else Swal.fire({icon:"warning",title:STRINGS.noReportSelected,text:STRINGS.selectAReport})},deleteReport:function(slug,source,reportName){var self=this;Swal.fire({title:STRINGS.deletingReport,text:STRINGS.deletingReportWait,allowOutsideClick:!1,allowEscapeKey:!1,didOpen:function(){Swal.showLoading()}}),$.ajax({url:M.cfg.wwwroot+"/report/adeptus_insights/ajax/manage_generated_reports.php",method:"POST",dataType:"json",data:{action:"remove_single",slug:slug,source:source,sesskey:M.cfg.sesskey}}).then((function(response){if(!response.success)return Swal.close(),void Swal.fire({icon:"error",title:STRINGS.deleteFailed,text:response.message});self.trackReportDeleted(reportName,"assistant"===source),self.cachedReports=self.cachedReports.filter((function(r){return r.slug!==slug})),self.currentReport&&self.currentReport.slug===slug&&(self.currentReport=null,self.currentReportData=null),self.renderReportsList(self.cachedReports),self.updateReportCount(self.cachedReports.length),$("#report-content").addClass("d-none"),$("#report-placeholder").removeClass("d-none"),$("#report-category-selector").addClass("d-none"),$(".adeptus-report-view-title").text(STRINGS.selectAReport),Swal.close(),self.showToast(STRINGS.reportDeletedSuccess,"success")})).catch((function(xhr){Swal.close();var errorMsg="";try{errorMsg=JSON.parse(xhr.responseText).message||""}catch(e){xhr.responseJSON&&xhr.responseJSON.message&&(errorMsg=xhr.responseJSON.message)}Swal.fire({icon:"error",title:STRINGS.deleteFailed,text:errorMsg})}))},trackReportDeleted:function(reportName,isAiGenerated){$.ajax({url:M.cfg.wwwroot+"/report/adeptus_insights/ajax/track_report_deleted.php",method:"POST",dataType:"json",data:{report_name:reportName,is_ai_generated:isAiGenerated?1:0,sesskey:M.cfg.sesskey}}).done((function(response){window.console.log("[GeneratedReports] Report deletion tracked:",response)})).fail((function(error){window.console.warn("[GeneratedReports] Failed to track report deletion:",error)}))},showReportCategorySelector:function(report){var self=this,categoryInfo=report.category_info||{name:report.category||STRINGS.general,color:"#6c757d"};this.currentCategoryReport=report,$("#category-dot").css("background",categoryInfo.color||"#6c757d"),$("#category-name").text(categoryInfo.name||STRINGS.general),$("#report-category-selector").removeClass("d-none");var buildDropdown=function(){var menuHtml=self.cachedCategories.map((function(cat){var isSelected=categoryInfo.id&&cat.id===categoryInfo.id||!categoryInfo.id&&cat.name.toLowerCase()===(categoryInfo.name||"general").toLowerCase();return'<button type="button" class="adeptus-category-menu-item'+(isSelected?" selected":"")+'" data-id="'+cat.id+'" data-name="'+cat.name+'" data-color="'+(cat.color||"#6c757d")+'"><span class="adeptus-category-menu-dot" style="background: '+(cat.color||"#6c757d")+';"></span><span class="adeptus-category-menu-name">'+cat.name+"</span>"+(isSelected?'<svg class="adeptus-category-menu-check" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"></polyline></svg>':"")+"</button>"})).join("");$("#category-dropdown-menu").html(menuHtml),$(".adeptus-category-menu-item").off("click").on("click",(function(e){e.preventDefault(),e.stopPropagation();var catId=$(this).data("id"),catName=$(this).data("name"),catColor=$(this).data("color");$("#category-dropdown-menu").removeClass("show"),self.updateReportCategory(report.slug,catId,catName,catColor,report)}))};this.cachedCategories&&0!==this.cachedCategories.length?buildDropdown():$.ajax({url:M.cfg.wwwroot+"/report/adeptus_insights/ajax/manage_category.php",method:"POST",dataType:"json",data:{action:"list",sesskey:M.cfg.sesskey},success:function(response){response.success&&response.data&&(self.cachedCategories=response.data),buildDropdown()},error:function(){self.cachedCategories=[],buildDropdown()}}),$("#category-current-btn").off("click").on("click",(function(e){e.preventDefault(),e.stopPropagation(),$("#category-dropdown-menu").toggleClass("show")})),$("#category-dropdown-menu").off("click").on("click",(function(e){e.stopPropagation()})),$(document).off("click.categoryDropdown").on("click.categoryDropdown",(function(e){$(e.target).closest(".category-dropdown-wrapper").length||$("#category-dropdown-menu").removeClass("show")}))},updateReportCategory:function(slug,categoryId,categoryName,categoryColor,report){var self=this,source=report&&report.source||"assistant";$("#category-dot").css("background",categoryColor),$("#category-name").text(categoryName),$.ajax({url:M.cfg.wwwroot+"/report/adeptus_insights/ajax/update_report_category.php",method:"POST",dataType:"json",data:{slug:slug,category_id:categoryId,source:source,sesskey:M.cfg.sesskey},success:function(response){if(response.success){var cacheIndex=self.cachedReports.findIndex((function(r){return r.slug===slug}));-1!==cacheIndex&&(self.cachedReports[cacheIndex].category=categoryName,self.cachedReports[cacheIndex].category_id=categoryId,self.cachedReports[cacheIndex].category_info={id:categoryId,name:categoryName,color:categoryColor}),$("#category-current-btn").addClass("success-flash"),setTimeout((function(){$("#category-current-btn").removeClass("success-flash")}),600)}else Swal.fire({icon:"error",title:STRINGS.error,text:response.message})},error:function(xhr){var msg=xhr.responseJSON&&xhr.responseJSON.message||"";Swal.fire({icon:"error",title:STRINGS.error,text:msg})}})},detectNumericColumns:function(data,headers){return data&&0!==data.length?headers.filter((function(header){for(var numericCount=0,sampleSize=Math.min(data.length,20),i=0;i<sampleSize;i++){var val=data[i][header];if(null!=val&&""!==val){var num=parseFloat(val);!isNaN(num)&&isFinite(num)&&numericCount++}}return numericCount>=.5*sampleSize})):[]},switchView:function(view){this.currentView=view,$(".adeptus-view-toggle-btn").removeClass("active"),$('.adeptus-view-toggle-btn[data-view="'+view+'"]').addClass("active"),"table"===view?($("#report-table-view").removeClass("d-none"),$("#report-chart-view").addClass("d-none")):($("#report-table-view").addClass("d-none"),$("#report-chart-view").removeClass("d-none"),this.renderChart())},getAuthToken:function(){var authData=window.adeptusAuthData;return authData&&authData.api_key?authData.api_key:null},formatDate:function(dateStr){if(!dateStr)return"N/A";var date=new Date(dateStr),diff=new Date-date,days=Math.floor(diff/864e5);if(0===days)return"Today, "+date.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"});if(1===days)return"Yesterday, "+date.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"});if(days<7){return["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"][date.getDay()]+", "+date.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}return date.toLocaleDateString()+", "+date.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})},loadReports:function(){var self=this,token=this.getAuthToken();if(!token)return self.retryCount<self.maxRetries?(self.retryCount++,void setTimeout((function(){self.loadReports()}),500)):($("#reports-loader").addClass("d-none"),void $("#no-reports-message").removeClass("d-none").html('<i class="fa fa-exclamation-triangle fa-3x text-warning mb-3"></i><h5 class="text-muted">Authentication Required</h5><p class="text-muted">Please ensure you are logged in to view reports.</p>'));var assistantPromise=$.ajax({url:this.backendUrl+"/ai-reports",method:"GET",headers:{Authorization:"Bearer "+token,"Content-Type":"application/json"},timeout:15e3}).catch((function(){return{reports:[],data:[]}})),wizardPromise=new Promise((function(resolve){Ajax.call([{methodname:"report_adeptus_insights_get_wizard_reports",args:{}}])[0].done((function(result){var response=result&&result.data?result.data:result||{};resolve({success:!0,reports:response.reports||[]})})).fail((function(){resolve({success:!0,reports:[]})}))}));$.when(assistantPromise,wizardPromise).then((function(assistantRes,wizardRes){var aRes=assistantRes[0]||assistantRes||{},wRes=wizardRes[0]||wizardRes||{},assistantReports=aRes.reports||aRes.data||[],wizardReports=wRes.reports||[];assistantReports=(Array.isArray(assistantReports)?assistantReports:[]).map((function(r){return r.source=r.source||"assistant",r})),wizardReports=(Array.isArray(wizardReports)?wizardReports:[]).map((function(r){return r.source="wizard",r})),self.cachedReports=assistantReports.concat(wizardReports),self.cachedReports.sort((function(a,b){return new Date(b.created_at)-new Date(a.created_at)})),self.renderReportsList(self.cachedReports),self.updateReportCount(self.cachedReports.length)}),(function(xhr){$("#reports-loader").addClass("d-none"),401===xhr.status?$("#no-reports-message").removeClass("d-none").html('<i class="fa fa-lock fa-3x text-warning mb-3"></i><h5 class="text-muted">'+STRINGS.sessionExpired+'</h5><p class="text-muted">'+STRINGS.refreshPageToContinue+'</p><button class="btn btn-primary btn-sm" onclick="location.reload()"><i class="fa fa-refresh"></i> '+STRINGS.refreshPage+"</button>"):$("#no-reports-message").removeClass("d-none").html('<i class="fa fa-exclamation-circle fa-3x text-danger mb-3"></i><h5 class="text-muted">'+STRINGS.failedToLoadReports+'</h5><p class="text-muted">'+STRINGS.tryAgainLater+'</p><button class="btn btn-outline-primary btn-sm" onclick="location.reload()"><i class="fa fa-refresh"></i> '+STRINGS.retry+"</button>")}))},updateReportCount:function(count){var countText=1===count?STRINGS.reportCount:count+" "+STRINGS.reportsCount;$(".adeptus-page-header-subtitle").text(STRINGS.youHaveReportsSaved.replace("{count}",countText.toLowerCase()))},renderReportsList:function(reports){var self=this;this.reportsDataTable&&(this.reportsDataTable.destroy(),this.reportsDataTable=null);var tbody=$("#reports-tbody");if(tbody.empty(),$("#reports-loader").addClass("d-none"),!reports||0===reports.length)return $("#no-reports-message").removeClass("d-none"),void $("#reports-table-wrapper").addClass("d-none");$("#no-reports-message").addClass("d-none"),$("#reports-table-wrapper").removeClass("d-none"),reports.forEach((function(report){var date=self.formatDate(report.created_at),rowCount=report.row_count||report.data_count||"",rowCountBadge=rowCount?'<span class="badge bg-info ms-1" title="'+rowCount+' rows"><i class="fa fa-table"></i> '+rowCount+"</span>":"",categoryBadge=report.category?'<span class="badge bg-secondary ms-1">'+report.category+"</span>":"",source=(report.source||"assistant").toLowerCase(),sourceBadge="";sourceBadge="wizard"===source?'<span class="badge adeptus-badge-wizard"><i class="fa fa-magic"></i> '+STRINGS.wizard+"</span>":'<span class="badge adeptus-badge-ai"><i class="fa fa-robot"></i> '+STRINGS.ai+"</span>";var row=$('<tr class="adeptus-report-row" data-report-slug="'+report.slug+'" data-report-source="'+source+'"></tr>');row.html('<td><div class="adeptus-report-name-cell"><span class="adeptus-report-name">'+(report.description||report.name||STRINGS.untitledReport)+'</span><div class="adeptus-report-badges mt-1">'+categoryBadge+rowCountBadge+'</div></div></td><td><small class="text-muted">'+date+"</small></td><td>"+sourceBadge+"</td>"),tbody.append(row)})),$("#reports-table-wrapper").off("click",".adeptus-report-row").on("click",".adeptus-report-row",(function(){var $row=$(this),slug=$row.data("report-slug");$(".adeptus-report-row").removeClass("table-primary"),$row.addClass("table-primary"),self.loadReportDetails(slug)})),setTimeout((function(){try{self.reportsDataTable=new window.simpleDatatables.DataTable("#reports-table",{searchable:!0,fixedHeight:!1,perPage:15,loading:!1,labels:{placeholder:STRINGS.searchReports,noRows:STRINGS.noReportsFound,info:STRINGS.showingReports}}),setTimeout((function(){$(".datatable-wrapper").removeClass("datatable-loading")}),100),setTimeout((function(){var firstRow=$(".adeptus-report-row").first();if(firstRow.length&&!self.currentReport){firstRow.addClass("table-primary");var firstSlug=firstRow.data("report-slug");firstSlug&&self.loadReportDetails(firstSlug)}}),150)}catch(e){window.console.warn("DataTable initialization failed:",e)}}),100)},loadReportDetails:function(slug){var self=this,token=this.getAuthToken();$("#report-placeholder").addClass("d-none"),$("#report-content").addClass("d-none"),$("#report-loading").removeClass("d-none");var cachedReport=this.cachedReports.find((function(r){return r.slug===slug})),source=cachedReport&&cachedReport.source||"assistant";cachedReport&&($(".adeptus-report-view-title").text(cachedReport.description||cachedReport.name||STRINGS.reportDetails),self.showReportCategorySelector(cachedReport)),"wizard"===source&&cachedReport?self.loadWizardReport(cachedReport):$.ajax({url:this.backendUrl+"/ai-reports/"+slug,method:"GET",headers:{Authorization:"Bearer "+token,"Content-Type":"application/json"},timeout:3e4,success:function(response){var report=response.report||response,data=response.data||[];report.source=source;var sqlQuery=response.sql||report&&report.sql_query||report&&report.sql;if((response.execution_required||(!data||0===data.length)&&sqlQuery)&&sqlQuery)self.executeReportLocally(sqlQuery,report.params||{}).then((function(executionResult){var localData=executionResult.data||[];self.currentReport=report,self.currentReportData=localData;var cacheIndex=self.cachedReports.findIndex((function(r){return r.slug===slug}));-1!==cacheIndex&&(self.cachedReports[cacheIndex]=Object.assign({},report,{data:localData,source:source})),self.renderReportContent(report,localData)})).catch((function(error){$("#report-loading").addClass("d-none"),$("#report-content").html('<div class="alert alert-danger"><i class="fa fa-exclamation-circle"></i> '+STRINGS.failedToExecuteReport+": "+error.message+'<button class="btn btn-sm btn-outline-danger ms-3" onclick="GeneratedReports.loadReportDetails(\''+slug+'\')"><i class="fa fa-refresh"></i> '+STRINGS.retry+"</button></div>").removeClass("d-none")}));else{self.currentReport=report,self.currentReportData=data;var cacheIndex=self.cachedReports.findIndex((function(r){return r.slug===slug}));-1!==cacheIndex&&(self.cachedReports[cacheIndex]=Object.assign({},report,{data:data,source:source})),self.renderReportContent(report,data)}},error:function(){$("#report-loading").addClass("d-none"),$("#report-content").html('<div class="alert alert-danger"><i class="fa fa-exclamation-circle"></i> '+STRINGS.failedToLoadReportDetails+'<button class="btn btn-sm btn-outline-danger ms-3" onclick="GeneratedReports.loadReportDetails(\''+slug+'\')"><i class="fa fa-refresh"></i> '+STRINGS.retry+"</button></div>").removeClass("d-none")}})},loadWizardReport:function(cachedReport){var self=this,parameters=cachedReport.parameters||{},reportTemplateId=cachedReport.report_template_id||cachedReport.name;$.ajax({url:M.cfg.wwwroot+"/lib/ajax/service.php?sesskey="+M.cfg.sesskey+"&info=report_adeptus_insights_generate_report",method:"POST",contentType:"application/json",data:JSON.stringify([{index:0,methodname:"report_adeptus_insights_generate_report",args:{reportid:reportTemplateId,parameters:JSON.stringify(parameters),reexecution:!0}}]),timeout:6e4,success:function(results){var result=Array.isArray(results)&&results.length>0?results[0]:null;if(result&&result.error)return $("#report-loading").addClass("d-none"),void $("#report-content").html('<div class="alert alert-danger"><i class="fa fa-exclamation-circle"></i> '+(result.exception&&result.exception.message||result.error)+'<button class="btn btn-sm btn-outline-danger ms-3" onclick="GeneratedReports.loadReportDetails(\''+cachedReport.slug+'\')"><i class="fa fa-refresh"></i> '+STRINGS.retry+"</button></div>").removeClass("d-none");var response=result&&result.data?result.data:result||{};if(response.success){var data=(response.results||response.data||[]).map((function(row){if(row.cells&&Array.isArray(row.cells)){var flatRow={};return row.cells.forEach((function(cell){flatRow[cell.key]=cell.value})),flatRow}return row})),report={name:cachedReport.name,description:cachedReport.description||cachedReport.name,category:response.report&&response.report.category||cachedReport.category||"Wizard Report",created_at:cachedReport.created_at,source:"wizard",slug:cachedReport.slug};self.currentReport=report,self.currentReportData=data;var cacheIndex=self.cachedReports.findIndex((function(r){return r.slug===cachedReport.slug}));-1!==cacheIndex&&(self.cachedReports[cacheIndex].data=data,self.cachedReports[cacheIndex].row_count=data.length),self.renderReportContent(report,data)}else $("#report-loading").addClass("d-none"),$("#report-content").html('<div class="alert alert-warning"><i class="fa fa-exclamation-triangle"></i> '+(response.message||STRINGS.failedToGenerateReport)+'<button class="btn btn-sm btn-outline-warning ms-3" onclick="GeneratedReports.loadReportDetails(\''+cachedReport.slug+'\')"><i class="fa fa-refresh"></i> '+STRINGS.retry+"</button></div>").removeClass("d-none")},error:function(){$("#report-loading").addClass("d-none"),$("#report-content").html('<div class="alert alert-danger"><i class="fa fa-exclamation-circle"></i> '+STRINGS.failedToExecuteWizardReport+'<button class="btn btn-sm btn-outline-danger ms-3" onclick="GeneratedReports.loadReportDetails(\''+cachedReport.slug+'\')"><i class="fa fa-refresh"></i> '+STRINGS.retry+"</button></div>").removeClass("d-none")}})},executeReportLocally:function(sql,params){return params=params||{},new Promise((function(resolve,reject){$.ajax({url:M.cfg.wwwroot+"/report/adeptus_insights/ajax/execute_ai_report.php",method:"POST",contentType:"application/json",data:JSON.stringify({sql:sql,params:params,sesskey:M.cfg.sesskey}),timeout:6e4,success:function(response){response.success?resolve({data:response.data||[],headers:response.headers||[],row_count:response.row_count||0,error:null}):resolve({data:[],headers:[],row_count:0,error:response.message||"Query execution failed"})},error:function(xhr,status,error){var errorMessage="Failed to execute report";try{errorMessage=JSON.parse(xhr.responseText).message||errorMessage}catch(e){errorMessage=error||errorMessage}reject(new Error(errorMessage))}})}))},renderReportContent:function(report,data){var self=this;$("#report-loading").addClass("d-none");var contentHtml="",rowCount=data?data.length:0;contentHtml+='<div class="adeptus-report-detail-header mb-4">',contentHtml+='<h4 class="mb-2">'+(report.description||report.name||STRINGS.report)+"</h4>",contentHtml+='<div class="adeptus-report-meta d-flex flex-wrap align-items-center gap-2">';var reportSource=(report.source||"assistant").toLowerCase();contentHtml+="wizard"===reportSource?'<span class="badge adeptus-badge-wizard"><i class="fa fa-magic"></i> '+STRINGS.wizard+"</span>":'<span class="badge adeptus-badge-ai"><i class="fa fa-robot"></i> '+STRINGS.ai+"</span>",contentHtml+='<span class="badge adeptus-badge-rowcount"><i class="fa fa-table"></i> '+rowCount+" "+STRINGS.rows+"</span>",contentHtml+="</div>",contentHtml+="</div>",contentHtml+='<div class="adeptus-action-bar d-flex justify-content-between align-items-center mb-3">',contentHtml+='<div class="adeptus-view-toggle btn-group" role="group">',contentHtml+='<button type="button" class="btn btn-sm adeptus-view-toggle-btn active" data-view="table"><i class="fa fa-table"></i> '+STRINGS.table+"</button>",contentHtml+='<button type="button" class="btn btn-sm adeptus-view-toggle-btn" data-view="chart"><i class="fa fa-bar-chart"></i> '+STRINGS.chart+"</button>",contentHtml+="</div>";var premiumClass=self.isFreePlan?" adeptus-export-premium":"";if(contentHtml+='<div class="adeptus-export-buttons d-flex gap-2">',contentHtml+='<button class="btn btn-outline-danger btn-sm adeptus-export-pdf-btn"><i class="fa fa-file-pdf-o"></i> '+STRINGS.exportPdf+"</button>",contentHtml+='<button class="btn btn-outline-primary btn-sm adeptus-export-csv-btn'+premiumClass+'"><i class="fa fa-file-excel-o"></i> '+STRINGS.exportCsv+(self.isFreePlan?' <i class="fa fa-crown text-warning" style="font-size: 10px;"></i>':"")+"</button>",contentHtml+='<button class="btn btn-outline-secondary btn-sm adeptus-export-json-btn'+premiumClass+'"><i class="fa fa-code"></i> '+STRINGS.exportJson+(self.isFreePlan?' <i class="fa fa-crown text-warning" style="font-size: 10px;"></i>':"")+"</button>",contentHtml+="</div>",contentHtml+="</div>",data&&data.length>0){var headers=Object.keys(data[0]);contentHtml+='<div id="report-table-view" class="adeptus-report-view">',contentHtml+='<div class="adeptus-report-data-wrapper">',contentHtml+='<div class="table-responsive report-table-container">',contentHtml+='<table class="table table-striped table-hover table-sm report-data-table">',contentHtml+='<thead class="table-light sticky-header"><tr>',headers.forEach((function(header){var formattedHeader=header.replace(/_/g," ").replace(/\b\w/g,(function(l){return l.toUpperCase()}));contentHtml+="<th>"+formattedHeader+"</th>"})),contentHtml+="</tr></thead>",contentHtml+="<tbody>",data.slice(0,100).forEach((function(row){contentHtml+="<tr>",headers.forEach((function(header){var value=row[header];null==value&&(value="");var displayValue=String(value);displayValue.length>100&&(displayValue=displayValue.substring(0,100)+"..."),contentHtml+='<td title="'+String(value).replace(/"/g,"&quot;")+'">'+displayValue+"</td>"})),contentHtml+="</tr>"})),contentHtml+="</tbody></table>",contentHtml+="</div>",contentHtml+="</div>",data.length>100&&(contentHtml+='<div class="alert alert-info mt-3 d-flex align-items-center justify-content-between">',contentHtml+='<span><i class="fa fa-info-circle"></i> '+STRINGS.showingFirstRows.replace("{first}",100).replace("{total}",data.length)+"</span>",contentHtml+='<span class="text-primary">'+STRINGS.exportToSeeAll+"</span>",contentHtml+="</div>"),contentHtml+="</div>",contentHtml+='<div id="report-chart-view" class="adeptus-report-view d-none">',contentHtml+='<div class="adeptus-chart-controls-wrapper mb-3">',contentHtml+='<div class="adeptus-chart-controls d-flex flex-wrap align-items-center gap-3">',contentHtml+='<div class="adeptus-control-group">',contentHtml+='<label for="chart-type-select" class="form-label">'+STRINGS.chartType+"</label>",contentHtml+='<select id="chart-type-select" class="form-select form-select-sm">',contentHtml+='<option value="bar">'+STRINGS.barChart+"</option>",contentHtml+='<option value="line">'+STRINGS.lineChart+"</option>",contentHtml+='<option value="pie">'+STRINGS.pieChart+"</option>",contentHtml+='<option value="doughnut">'+STRINGS.doughnutChart+"</option>",contentHtml+="</select>",contentHtml+="</div>",contentHtml+='<div class="adeptus-control-group">',contentHtml+='<label for="chart-x-axis" class="form-label">'+STRINGS.xAxisLabels+"</label>",contentHtml+='<select id="chart-x-axis" class="form-select form-select-sm">',headers.forEach((function(header,idx){var formattedHeader=header.replace(/_/g," ").replace(/\b\w/g,(function(l){return l.toUpperCase()}));contentHtml+='<option value="'+header+'"'+(0===idx?" selected":"")+">"+formattedHeader+"</option>"})),contentHtml+="</select>",contentHtml+="</div>";var numericCols=self.detectNumericColumns(data,headers);contentHtml+='<div class="adeptus-control-group">',contentHtml+='<label for="chart-y-axis" class="form-label">'+STRINGS.yAxisValues+"</label>",contentHtml+='<select id="chart-y-axis" class="form-select form-select-sm">',numericCols.length>0?numericCols.forEach((function(col,idx){var formattedHeader=col.replace(/_/g," ").replace(/\b\w/g,(function(l){return l.toUpperCase()})),selected=idx===numericCols.length-1?" selected":"";contentHtml+='<option value="'+col+'"'+selected+">"+formattedHeader+"</option>"})):headers.forEach((function(header,idx){var formattedHeader=header.replace(/_/g," ").replace(/\b\w/g,(function(l){return l.toUpperCase()})),selected=idx===headers.length-1?" selected":"";contentHtml+='<option value="'+header+'"'+selected+">"+formattedHeader+"</option>"})),contentHtml+="</select>",contentHtml+="</div>",contentHtml+="</div>",contentHtml+="</div>",contentHtml+='<div class="adeptus-chart-container" style="position: relative; height: 400px;">',contentHtml+='<canvas id="report-chart"></canvas>',contentHtml+="</div>",contentHtml+="</div>"}else contentHtml+='<div class="alert alert-warning text-center py-4">',contentHtml+='<i class="fa fa-inbox fa-2x mb-2 d-block"></i>',contentHtml+="<strong>"+STRINGS.noDataAvailable+"</strong><br>",contentHtml+='<small class="text-muted">'+STRINGS.noDataRows+"</small>",contentHtml+="</div>";$("#report-content").html(contentHtml).removeClass("d-none"),self.currentView="table",$("#report-content .adeptus-export-pdf-btn").on("click",(function(){self.exportReport(report.slug,"pdf")})),$("#report-content .adeptus-export-csv-btn").on("click",(function(){$(this).hasClass("adeptus-export-premium")?self.showExportUpgradePrompt("csv"):self.exportReport(report.slug,"csv")})),$("#report-content .adeptus-export-json-btn").on("click",(function(){$(this).hasClass("adeptus-export-premium")?self.showExportUpgradePrompt("json"):self.exportReport(report.slug,"json")})),$("#delete-report-header-btn").off("click").on("click",(function(){self.confirmDeleteReport(report)}))},renderChart:function(){var data=this.currentReportData;if(data&&0!==data.length){var chartType=$("#chart-type-select").val()||"bar",canvas=document.getElementById("report-chart");if(canvas){this.chartInstance&&(this.chartInstance.destroy(),this.chartInstance=null);var labelKey=$("#chart-x-axis").val(),valueKey=$("#chart-y-axis").val();if(!labelKey||!valueKey){var headers=Object.keys(data[0]);labelKey=labelKey||headers[0],valueKey=valueKey||headers[headers.length-1]}var valueKeyFormatted=valueKey.replace(/_/g," ").replace(/\b\w/g,(function(l){return l.toUpperCase()})),chartData=data.slice(0,50),labels=chartData.map((function(r){var label=r[labelKey];if(null==label)return STRINGS.unknown;var labelStr=String(label);return labelStr.length>30?labelStr.substring(0,30)+"...":labelStr})),values=chartData.map((function(r){return parseFloat(r[valueKey])||0})),colors=this.generateChartColors(values.length,chartType),chartConfig=this.createChartConfig(chartType,labels,values,valueKeyFormatted,colors);try{this.chartInstance=new this.Chart(canvas.getContext("2d"),chartConfig)}catch(error){window.console.error("Error creating chart:",error),$("#report-chart-view .adeptus-chart-container").html('<div class="alert alert-danger"><i class="fa fa-exclamation-triangle"></i> '+STRINGS.errorRenderingChart+": "+error.message+"</div>")}}}},generateChartColors:function(count){for(var baseColors=["#2563eb","#10b981","#f59e0b","#ef4444","#8b5cf6","#06b6d4","#ec4899","#84cc16","#f97316","#6366f1","#14b8a6","#a855f7","#eab308","#22c55e","#3b82f6"],colors=[],i=0;i<count;i++)colors.push(baseColors[i%baseColors.length]);return colors},createChartConfig:function(chartType,labels,values,valueKey,colors){var baseConfig={responsive:!0,maintainAspectRatio:!1,plugins:{title:{display:!0,text:this.currentReport&&this.currentReport.description||this.currentReport&&this.currentReport.name||STRINGS.report,font:{size:16,weight:"bold"},padding:{top:10,bottom:20}},legend:{display:"pie"===chartType||"doughnut"===chartType,position:"right"}}};return"pie"===chartType||"doughnut"===chartType?{type:chartType,data:{labels:labels,datasets:[{data:values,backgroundColor:colors,borderColor:"#fff",borderWidth:2}]},options:baseConfig}:"line"===chartType?{type:"line",data:{labels:labels,datasets:[{label:valueKey,data:values,borderColor:colors[0],backgroundColor:colors[0]+"40",borderWidth:3,fill:!0,tension:.4}]},options:Object.assign({},baseConfig,{scales:{y:{beginAtZero:!0},x:{ticks:{maxRotation:45,minRotation:45}}}})}:{type:"bar",data:{labels:labels,datasets:[{label:valueKey,data:values,backgroundColor:colors,borderColor:colors.map((function(c){return c})),borderWidth:1}]},options:Object.assign({},baseConfig,{scales:{y:{beginAtZero:!0},x:{ticks:{maxRotation:45,minRotation:45}}}})}},exportReport:function(reportSlug,format){var self=this;self.currentReportData&&Array.isArray(self.currentReportData)&&0!==self.currentReportData.length?(Swal.fire({title:STRINGS.exportingAs.replace("{format}",format.toUpperCase()),allowOutsideClick:!1,didOpen:function(){Swal.showLoading()}}),self.checkExportEligibility(format).then((function(eligibility){if(!eligibility.success||!eligibility.eligible)return Swal.close(),void(self.isFreePlan&&"pdf"!==format?self.showExportUpgradePrompt(format):Swal.fire({icon:"error",title:STRINGS.exportNotAvailable,text:eligibility.message||STRINGS.exportNotEligible}));var reportId=reportSlug;self.currentReport&&"wizard"===self.currentReport.source&&self.currentReport.name&&(reportId=self.currentReport.name);var body="reportid="+encodeURIComponent(reportId)+"&format="+format+"&sesskey="+M.cfg.sesskey;body+="&view="+self.currentView;var headers=self.currentReportData.length>0?Object.keys(self.currentReportData[0]):[],reportDataPayload={results:self.currentReportData,headers:headers,report_name:self.currentReport&&self.currentReport.description||self.currentReport&&self.currentReport.name||"report",report_category:self.currentReport&&self.currentReport.category||""};body+="&report_data="+encodeURIComponent(JSON.stringify(reportDataPayload));var chartImagePromise=Promise.resolve(null);"pdf"===format&&"chart"===self.currentView&&(chartImagePromise=self.captureChartImage().catch((function(){return null}))),chartImagePromise.then((function(chartImage){return chartImage&&chartImage.length>100&&(body+="&chart_image="+encodeURIComponent(chartImage),window.console.log("[GeneratedReports] Chart image included in export")),fetch(M.cfg.wwwroot+"/report/adeptus_insights/ajax/export_report.php",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:body,credentials:"same-origin"})})).then((function(response){var contentType=response.headers.get("content-type"),contentDisposition=response.headers.get("content-disposition");if(contentType&&contentType.includes("application/json")&&!contentDisposition)return response.json().then((function(errorData){throw new Error(errorData.message||"Export failed")}));if(!response.ok)throw new Error("Export failed with status: "+response.status);return response.blob()})).then((function(blob){var reportName=self.currentReport&&self.currentReport.description||self.currentReport&&self.currentReport.name||"report",sanitizedName=reportName.replace(/[^a-zA-Z0-9\s-]/g,"").replace(/\s+/g,"_").toLowerCase(),dateSuffix=(new Date).toISOString().split("T")[0],url=window.URL.createObjectURL(blob),link=document.createElement("a");link.href=url,link.download=sanitizedName+"_"+dateSuffix+"."+format,document.body.appendChild(link),link.click(),window.URL.revokeObjectURL(url),document.body.removeChild(link),Swal.close(),self.trackExport(format,reportName),self.showToast(format.toUpperCase()+" "+STRINGS.fileDownloadedSuccess,"success")})).catch((function(error){Swal.close(),Swal.fire({icon:"error",title:STRINGS.exportFailed,text:error.message||STRINGS.exportFailedMessage})}))}))):Swal.fire({icon:"warning",title:STRINGS.noData,text:STRINGS.noDataToExport})}};return window.GeneratedReports=GeneratedReports,{init:function(config){Str.get_strings([{key:"general",component:"report_adeptus_insights"},{key:"wizard",component:"report_adeptus_insights"},{key:"ai",component:"report_adeptus_insights"},{key:"report",component:"report_adeptus_insights"},{key:"report_details",component:"report_adeptus_insights"},{key:"untitled_report",component:"report_adeptus_insights"},{key:"unknown",component:"report_adeptus_insights"},{key:"rows",component:"report_adeptus_insights"},{key:"table",component:"report_adeptus_insights"},{key:"chart",component:"report_adeptus_insights"},{key:"retry",component:"report_adeptus_insights"},{key:"cancel",component:"report_adeptus_insights"},{key:"error",component:"report_adeptus_insights"},{key:"export_pdf",component:"report_adeptus_insights"},{key:"export_csv",component:"report_adeptus_insights"},{key:"export_json",component:"report_adeptus_insights"},{key:"exporting_as",component:"report_adeptus_insights"},{key:"export_not_available",component:"report_adeptus_insights"},{key:"export_not_eligible",component:"report_adeptus_insights"},{key:"export_failed",component:"report_adeptus_insights"},{key:"export_failed_message",component:"report_adeptus_insights"},{key:"file_downloaded_success",component:"report_adeptus_insights"},{key:"no_data",component:"report_adeptus_insights"},{key:"no_data_to_export",component:"report_adeptus_insights"},{key:"no_data_available",component:"report_adeptus_insights"},{key:"no_data_rows",component:"report_adeptus_insights"},{key:"premium_export_format",component:"report_adeptus_insights"},{key:"premium_feature",component:"report_adeptus_insights"},{key:"upgrade_now",component:"report_adeptus_insights"},{key:"free_plan_label",component:"report_adeptus_insights"},{key:"free_plan_pdf_only",component:"report_adeptus_insights"},{key:"paid_plans_label",component:"report_adeptus_insights"},{key:"paid_plans_all_formats",component:"report_adeptus_insights"},{key:"export_upgrade_message",component:"report_adeptus_insights"},{key:"categories",component:"report_adeptus_insights"},{key:"create_new_category",component:"report_adeptus_insights"},{key:"custom_color",component:"report_adeptus_insights"},{key:"your_categories",component:"report_adeptus_insights"},{key:"default_categories",component:"report_adeptus_insights"},{key:"read_only",component:"report_adeptus_insights"},{key:"no_custom_categories",component:"report_adeptus_insights"},{key:"create_first_category",component:"report_adeptus_insights"},{key:"category_created",component:"report_adeptus_insights"},{key:"category_updated",component:"report_adeptus_insights"},{key:"category_deleted",component:"report_adeptus_insights"},{key:"edit_category",component:"report_adeptus_insights"},{key:"delete_category",component:"report_adeptus_insights"},{key:"delete_category_confirm",component:"report_adeptus_insights"},{key:"delete_category_warning",component:"report_adeptus_insights"},{key:"yes_delete",component:"report_adeptus_insights"},{key:"category_name",component:"report_adeptus_insights"},{key:"please_enter_category_name",component:"report_adeptus_insights"},{key:"name",component:"report_adeptus_insights"},{key:"color",component:"report_adeptus_insights"},{key:"custom",component:"report_adeptus_insights"},{key:"save_changes",component:"report_adeptus_insights"},{key:"select_a_report",component:"report_adeptus_insights"},{key:"no_report_selected",component:"report_adeptus_insights"},{key:"delete_report",component:"report_adeptus_insights"},{key:"delete_report_confirm",component:"report_adeptus_insights"},{key:"delete_report_warning",component:"report_adeptus_insights"},{key:"deleting_report",component:"report_adeptus_insights"},{key:"deleting_report_wait",component:"report_adeptus_insights"},{key:"delete_failed",component:"report_adeptus_insights"},{key:"report_deleted_success",component:"report_adeptus_insights"},{key:"report_count",component:"report_adeptus_insights"},{key:"reports_count",component:"report_adeptus_insights"},{key:"you_have_reports_saved",component:"report_adeptus_insights"},{key:"session_expired",component:"report_adeptus_insights"},{key:"refresh_page",component:"report_adeptus_insights"},{key:"refresh_page_to_continue",component:"report_adeptus_insights"},{key:"failed_to_load_reports",component:"report_adeptus_insights"},{key:"try_again_later",component:"report_adeptus_insights"},{key:"failed_to_execute_report",component:"report_adeptus_insights"},{key:"failed_to_load_report_details",component:"report_adeptus_insights"},{key:"failed_to_generate_report",component:"report_adeptus_insights"},{key:"failed_to_execute_wizard_report",component:"report_adeptus_insights"},{key:"authentication_required",component:"report_adeptus_insights"},{key:"authentication_required_message",component:"report_adeptus_insights"},{key:"search_reports",component:"report_adeptus_insights"},{key:"no_reports_found",component:"report_adeptus_insights"},{key:"showing_reports",component:"report_adeptus_insights"},{key:"showing_first_rows",component:"report_adeptus_insights"},{key:"export_to_see_all",component:"report_adeptus_insights"},{key:"chart_type",component:"report_adeptus_insights"},{key:"bar_chart",component:"report_adeptus_insights"},{key:"line_chart",component:"report_adeptus_insights"},{key:"pie_chart",component:"report_adeptus_insights"},{key:"doughnut_chart",component:"report_adeptus_insights"},{key:"x_axis_labels",component:"report_adeptus_insights"},{key:"y_axis_values",component:"report_adeptus_insights"},{key:"error_rendering_chart",component:"report_adeptus_insights"},{key:"loading",component:"report_adeptus_insights"}]).then((function(results){return["general","wizard","ai","report","reportDetails","untitledReport","unknown","rows","table","chart","retry","cancel","error","exportPdf","exportCsv","exportJson","exportingAs","exportNotAvailable","exportNotEligible","exportFailed","exportFailedMessage","fileDownloadedSuccess","noData","noDataToExport","noDataAvailable","noDataRows","premiumExportFormat","premiumFeature","upgradeNow","freePlan","freePlanPdfOnly","paidPlans","paidPlansAllFormats","exportUpgradeMessage","categories","createNewCategory","customColor","yourCategories","defaultCategories","readOnly","noCustomCategories","createFirstCategory","categoryCreated","categoryUpdated","categoryDeleted","editCategory","deleteCategory","deleteCategoryConfirm","deleteCategoryWarning","yesDelete","categoryName","pleaseEnterCategoryName","name","color","custom","saveChanges","selectAReport","noReportSelected","deleteReport","deleteReportConfirm","deleteReportWarning","deletingReport","deletingReportWait","deleteFailed","reportDeletedSuccess","reportCount","reportsCount","youHaveReportsSaved","sessionExpired","refreshPage","refreshPageToContinue","failedToLoadReports","tryAgainLater","failedToExecuteReport","failedToLoadReportDetails","failedToGenerateReport","failedToExecuteWizardReport","authenticationRequired","authenticationRequiredMessage","searchReports","noReportsFound","showingReports","showingFirstRows","exportToSeeAll","chartType","barChart","lineChart","pieChart","doughnutChart","xAxisLabels","yAxisValues","errorRenderingChart","loading"].forEach((function(key,index){STRINGS[key]=results[index]||key})),STRINGS})).catch((function(){return STRINGS={general:"General",wizard:"Wizard",ai:"AI",report:"Report",reportDetails:"Report Details",untitledReport:"Untitled Report",unknown:"Unknown",rows:"rows",table:"Table",chart:"Chart",retry:"Retry",cancel:"Cancel",error:"Error",exportPdf:"Export PDF",exportCsv:"Export CSV",exportJson:"Export JSON",exportingAs:"Exporting as {format}...",exportNotAvailable:"Export Not Available",exportNotEligible:"Export not eligible",exportFailed:"Export Failed",exportFailedMessage:"Failed to export report",fileDownloadedSuccess:"file downloaded successfully",noData:"No Data",noDataToExport:"No data to export",noDataAvailable:"No data available",noDataRows:"This report contains no data rows",premiumExportFormat:"Premium Export Format",premiumFeature:"Premium Feature",upgradeNow:"Upgrade Now",freePlan:"Free Plan:",freePlanPdfOnly:"PDF export only",paidPlans:"Paid Plans:",paidPlansAllFormats:"All formats (PDF, CSV, JSON)",exportUpgradeMessage:"{format} export requires a paid plan",categories:"Categories",createNewCategory:"Create New Category",customColor:"Custom color",yourCategories:"Your Categories",defaultCategories:"Default Categories",readOnly:"Read Only",noCustomCategories:"No custom categories yet",createFirstCategory:"Create your first category above",categoryCreated:"Category Created",categoryUpdated:"Category Updated",categoryDeleted:"Category Deleted",editCategory:"Edit Category",deleteCategory:"Delete Category",deleteCategoryConfirm:"Delete Category?",deleteCategoryWarning:"Are you sure you want to delete {name}?",yesDelete:"Yes, Delete",categoryName:"Category name",pleaseEnterCategoryName:"Please enter a category name",name:"Name",color:"Color",custom:"Custom",saveChanges:"Save Changes",selectAReport:"Select a Report",noReportSelected:"No Report Selected",deleteReport:"Delete Report",deleteReportConfirm:"Delete Report?",deleteReportWarning:"Are you sure you want to delete {name}?",deletingReport:"Deleting Report",deletingReportWait:"Please wait...",deleteFailed:"Delete Failed",reportDeletedSuccess:"Report deleted successfully",reportCount:"1 report",reportsCount:"reports",youHaveReportsSaved:"You have {count} saved",sessionExpired:"Session Expired",refreshPage:"Refresh Page",refreshPageToContinue:"Please refresh the page to continue",failedToLoadReports:"Failed to Load Reports",tryAgainLater:"Please try again later",failedToExecuteReport:"Failed to execute report",failedToLoadReportDetails:"Failed to load report details",failedToGenerateReport:"Failed to generate report",failedToExecuteWizardReport:"Failed to execute wizard report",authenticationRequired:"Authentication Required",authenticationRequiredMessage:"Please ensure you are logged in",searchReports:"Search reports...",noReportsFound:"No reports found",showingReports:"Showing reports",showingFirstRows:"Showing first {first} of {total} rows",exportToSeeAll:"Export to see all data",chartType:"Chart Type",barChart:"Bar Chart",lineChart:"Line Chart",pieChart:"Pie Chart",doughnutChart:"Doughnut Chart",xAxisLabels:"X-Axis (Labels)",yAxisValues:"Y-Axis (Values)",errorRenderingChart:"Error rendering chart",loading:"Loading..."}})).then((function(){var checkAuth=setInterval((function(){window.adeptusAuthData&&(clearInterval(checkAuth),GeneratedReports.init(config))}),100);setTimeout((function(){clearInterval(checkAuth),window.adeptusAuthData||($("#reports-loader").addClass("d-none"),$("#no-reports-message").removeClass("d-none").html('<i class="fa fa-exclamation-triangle fa-3x text-warning mb-3"></i><h5 class="text-muted">'+STRINGS.authenticationRequired+'</h5><p class="text-muted">'+STRINGS.authenticationRequiredMessage+"</p>"))}),5e3)}))}}}));

//# sourceMappingURL=generated_reports.min.js.map