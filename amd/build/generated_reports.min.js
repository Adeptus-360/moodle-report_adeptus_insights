/**
 * Generated Reports AMD module for Adeptus Insights.
 *
 * @module     report_adeptus_insights/generated_reports
 * @copyright  2026 Adeptus 360 <info@adeptus360.com>
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define(["jquery","core/ajax","core/str","core/chartjs"],function(e,t,a,o){"use strict";var r={},n={backendUrl:"",cachedReports:[],cachedCategories:[],currentReport:null,currentReportData:null,reportsDataTable:null,retryCount:0,maxRetries:3,currentView:"table",chartInstance:null,Chart:o,strings:r,isFreePlan:!0,init:function(e){var t=this;t.backendUrl=e.backendUrl||"",t.isFreePlan=!1!==e.isFreePlan,t.strings=r,t.loadReports(),t.loadCategories(),t.bindViewToggle(),t.bindCategoryManagement()},showExportUpgradePrompt:function(e){var t=M.cfg.wwwroot+"/report/adeptus_insights/subscription.php",a={csv:"CSV",excel:"Excel",json:"JSON"}[e]||e.toUpperCase();Swal.fire({title:r.premiumExportFormat,html:'<div style="text-align: center; padding: 20px;"><div style="font-size: 48px; color: #f39c12; margin-bottom: 15px;"><i class="fa fa-crown"></i></div><h3 style="color: #2c3e50; margin-bottom: 15px;">'+a+" "+r.premiumFeature+'</h3><p style="color: #7f8c8d; font-size: 16px; line-height: 1.6; margin-bottom: 25px;">'+r.exportUpgradeMessage.replace("{format}",a)+'</p><div style="background: #ecf0f1; padding: 15px; border-radius: 8px; margin-bottom: 20px;"><p style="margin: 0; font-size: 14px; color: #34495e;"><strong>'+r.freePlan+"</strong> "+r.freePlanPdfOnly+"<br><strong>"+r.paidPlans+"</strong> "+r.paidPlansAllFormats+"</p></div></div>",showCancelButton:!0,confirmButtonText:'<i class="fa fa-arrow-up"></i> '+r.upgradeNow,cancelButtonText:'<i class="fa fa-times"></i> '+r.cancel,confirmButtonColor:"#3498db",cancelButtonColor:"#95a5a6",width:500}).then(function(e){e.isConfirmed&&window.open(t,"_blank")})},checkExportEligibility:function(e){return new Promise(function(a){t.call([{methodname:"report_adeptus_insights_check_export_eligibility",args:{format:e}}])[0].done(function(e){var t=e.data?e.data:e;a(t)}).fail(function(e){window.console.error("Error checking export eligibility:",e),a({success:!1,eligible:!1,message:"Unable to verify export eligibility."})})})},captureChartImage:function(){var e=this;return new Promise(function(t){setTimeout(function(){var a=document.getElementById("report-chart");if(!a)return window.console.warn("[GeneratedReports] Chart canvas not found"),void t(null);try{var o=a.toDataURL("image/png",.8);if(o&&o.length>100&&o.length<2e6)return window.console.log("[GeneratedReports] Chart captured via toDataURL, size:",o.length),void t(o)}catch(e){window.console.warn("[GeneratedReports] Native canvas capture failed:",e)}e.loadHtml2Canvas().then(function(){window.html2canvas?window.html2canvas(a,{backgroundColor:"#ffffff",scale:1.5,useCORS:!0,allowTaint:!0,logging:!1}).then(function(e){var a=e.toDataURL("image/png",.8);if(a&&a.length>100&&a.length<2e6)return window.console.log("[GeneratedReports] Chart captured via html2canvas, size:",a.length),void t(a);t(null)}).catch(function(){t(null)}):t(null)}).catch(function(){t(null)})},300)})},loadHtml2Canvas:function(){return new Promise(function(e,t){if(window.html2canvas)e();else{var a=document.createElement("script");a.src=M.cfg.wwwroot+"/report/adeptus_insights/lib/html2canvas/html2canvas.min.js",a.onload=function(){e()},a.onerror=function(){t(new Error("Failed to load html2canvas"))},document.head.appendChild(a)}})},showToast:function(e,t){t=t||"success";var a=document.getElementById("adeptus-toast-container");a||((a=document.createElement("div")).id="adeptus-toast-container",a.style.cssText="position: fixed; top: 20px; right: 20px; z-index: 10000;",document.body.appendChild(a));var o=document.createElement("div");o.style.cssText="background: "+{success:"#28a745",error:"#dc3545",warning:"#ffc107",info:"#17a2b8"}[t]+"; color: "+{success:"white",error:"white",warning:"#212529",info:"white"}[t]+"; padding: 12px 20px; border-radius: 8px; margin-bottom: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); display: flex; align-items: center; gap: 10px; animation: slideIn 0.3s ease; min-width: 280px;",o.innerHTML='<i class="fa '+{success:"fa-check-circle",error:"fa-times-circle",warning:"fa-exclamation-triangle",info:"fa-info-circle"}[t]+'"></i><span>'+e+"</span>",a.appendChild(o),setTimeout(function(){o.style.animation="slideOut 0.3s ease forwards",setTimeout(function(){o.parentNode&&o.parentNode.removeChild(o)},300)},3e3)},trackExport:function(e,t){fetch(M.cfg.wwwroot+"/report/adeptus_insights/ajax/track_export.php",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:"format="+encodeURIComponent(e)+"&report_name="+encodeURIComponent(t)+"&sesskey="+M.cfg.sesskey}).then(function(e){return e.json()}).then(function(e){window.console.log("[GeneratedReports] Export tracked:",e)}).catch(function(e){window.console.error("[GeneratedReports] Error tracking export:",e)})},bindViewToggle:function(){var t=this;e(document).on("click",".adeptus-view-toggle-btn",function(){var a=e(this).data("view");t.switchView(a)}),e(document).on("change","#chart-type-select, #chart-x-axis, #chart-y-axis",function(){t.renderChart()})},bindCategoryManagement:function(){var t=this;e("#manage-categories-btn").on("click",function(){t.showCategoryManagementModal()})},loadCategories:function(){var t=this;e.ajax({url:M.cfg.wwwroot+"/report/adeptus_insights/ajax/manage_category.php",method:"POST",dataType:"json",data:{action:"list",sesskey:M.cfg.sesskey},success:function(e){e.success&&e.data&&(t.cachedCategories=e.data,t.cachedReports&&t.cachedReports.length>0&&t.enrichReportsWithCategoryInfo())},error:function(){t.cachedCategories=[]}})},enrichReportsWithCategoryInfo:function(){var e=this;this.cachedCategories&&0!==this.cachedCategories.length&&this.cachedReports.forEach(function(t){if(!(t.category_info&&t.category_info.id&&t.category_info.color)){var a=null;if(t.category_id&&(a=e.cachedCategories.find(function(e){return e.id===t.category_id||e.id===parseInt(t.category_id,10)})),!a&&t.category&&(a=e.cachedCategories.find(function(e){return e.name&&e.name.toLowerCase()===t.category.toLowerCase()})),!a&&t.category_info&&t.category_info.name&&(a=e.cachedCategories.find(function(e){return e.name&&e.name.toLowerCase()===t.category_info.name.toLowerCase()})),a)t.category_info={id:a.id,name:a.name,color:a.color||"#6c757d"},t.category=a.name,t.category_id=a.id;else{var o=e.cachedCategories.find(function(e){return e.name&&"general"===e.name.toLowerCase()});o&&(t.category_info={id:o.id,name:o.name,color:o.color||"#6c757d"})}}})},showCategoryManagementModal:function(){var t=this,a=t.cachedCategories.filter(function(e){return e.is_system}),o=t.cachedCategories.filter(function(e){return!e.is_system}),n=o.length>0?o.map(function(e){return'<div class="adeptus-cat-card" data-id="'+e.id+'"><div class="adeptus-cat-card-color" style="background: '+(e.color||"#6c757d")+';"></div><div class="adeptus-cat-card-content"><div class="adeptus-cat-card-name">'+e.name+'</div><div class="adeptus-cat-card-meta">'+(e.report_count||0)+" report"+(1!==e.report_count?"s":"")+'</div></div><div class="adeptus-cat-card-actions"><button class="adeptus-cat-action-btn edit-cat-btn" data-id="'+e.id+'" title="Edit"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg></button><button class="adeptus-cat-action-btn adeptus-cat-action-btn-danger delete-cat-btn" data-id="'+e.id+'" title="Delete"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button></div></div>'}).join(""):'<div class="adeptus-cat-empty-state"><div class="adeptus-cat-empty-icon"><svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path><line x1="12" y1="11" x2="12" y2="17"></line><line x1="9" y1="14" x2="15" y2="14"></line></svg></div><div class="adeptus-cat-empty-text">'+r.noCustomCategories+'</div><div class="adeptus-cat-empty-hint">'+r.createFirstCategory+"</div></div>",s=a.map(function(e){return'<div class="adeptus-cat-system-item"><span class="adeptus-cat-system-dot" style="background: '+(e.color||"#6c757d")+';"></span><span class="adeptus-cat-system-name">'+e.name+'</span><span class="adeptus-cat-system-count">'+(e.report_count||0)+"</span></div>"}).join(""),i=["#3b82f6","#10b981","#f59e0b","#ef4444","#8b5cf6","#ec4899","#06b6d4","#84cc16"].map(function(e){return'<button type="button" class="adeptus-cat-color-swatch" data-color="'+e+'" style="background: '+e+';"></button>'}).join("");Swal.fire({title:r.categories,html:'<div class="adeptus-cat-modal"><div class="adeptus-cat-add-section"><div class="adeptus-cat-add-header">'+r.createNewCategory+'</div><div class="adeptus-cat-add-form"><div class="adeptus-cat-add-input-wrapper"><input type="text" id="new-category-name" class="adeptus-cat-add-input" placeholder="'+r.categoryName+'"><div class="adeptus-cat-add-color-wrapper"><button type="button" class="adeptus-cat-add-color-btn" id="color-picker-toggle"><span class="adeptus-cat-add-color-preview" id="selected-color-preview" style="background: #3b82f6;"></span><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"></polyline></svg></button><div class="adeptus-cat-color-dropdown" id="color-dropdown"><div class="adeptus-cat-color-swatches">'+i+'</div><div class="adeptus-cat-color-custom"><input type="color" id="new-category-color" value="#3b82f6"><span>'+r.customColor+'</span></div></div></div></div><button type="button" class="adeptus-cat-add-btn" id="add-category-btn"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg> Add</button></div></div><div class="adeptus-cat-section"><div class="adeptus-cat-section-header"><span class="adeptus-cat-section-title">'+r.yourCategories+'</span><span class="adeptus-cat-section-count">'+o.length+'</span></div><div class="adeptus-cat-cards-list">'+n+'</div></div><div class="adeptus-cat-section adeptus-cat-section-system"><div class="adeptus-cat-section-header"><span class="adeptus-cat-section-title">'+r.defaultCategories+'</span><span class="adeptus-cat-section-badge">'+r.readOnly+'</span></div><div class="adeptus-cat-system-list">'+s+"</div></div></div>",showConfirmButton:!1,showCloseButton:!0,width:"480px",customClass:{popup:"adeptus-cat-modal-popup",title:"adeptus-cat-modal-title",closeButton:"adeptus-cat-modal-close",htmlContainer:"adeptus-cat-modal-container"},didOpen:function(){var a="#3b82f6";e("#color-picker-toggle").on("click",function(t){t.preventDefault(),t.stopPropagation(),e("#color-dropdown").toggleClass("show")}),e("#color-dropdown").on("click",function(e){e.stopPropagation()}),e(document).on("click.colorDropdown",function(t){e(t.target).closest(".adeptus-cat-add-color-wrapper").length||e("#color-dropdown").removeClass("show")}),e(".adeptus-cat-color-swatch").on("click",function(t){t.preventDefault(),t.stopPropagation(),a=e(this).data("color"),e("#selected-color-preview").css("background",a),e("#new-category-color").val(a),e("#color-dropdown").removeClass("show")}),e("#new-category-color").on("input change",function(t){t.stopPropagation(),a=e(this).val(),e("#selected-color-preview").css("background",a)}),e("#add-category-btn").on("click",function(){var o=e("#new-category-name").val().trim();o?t.createCategory(o,a):(e("#new-category-name").addClass("error").focus(),setTimeout(function(){e("#new-category-name").removeClass("error")},500))}),e("#new-category-name").on("keypress",function(t){13===t.which&&e("#add-category-btn").click()}),e(".edit-cat-btn").on("click",function(a){a.stopPropagation();var o=e(this).data("id"),r=t.cachedCategories.find(function(e){return e.id==o});r&&(e(document).off("click.colorDropdown"),t.showEditCategoryDialog(r))}),e(".delete-cat-btn").on("click",function(a){a.stopPropagation();var o=e(this).data("id"),r=t.cachedCategories.find(function(e){return e.id==o});r&&(e(document).off("click.colorDropdown"),t.confirmDeleteCategory(r))})},willClose:function(){e(document).off("click.colorDropdown")}})},createCategory:function(t,a){var o=this;e.ajax({url:M.cfg.wwwroot+"/report/adeptus_insights/ajax/manage_category.php",method:"POST",dataType:"json",data:{action:"create",name:t,color:a,sesskey:M.cfg.sesskey},success:function(e){e.success?(o.cachedCategories.push(e.data),Swal.close(),Swal.fire({icon:"success",title:r.categoryCreated,timer:1500,showConfirmButton:!1}).then(function(){o.showCategoryManagementModal()})):Swal.showValidationMessage(e.message)},error:function(e){var t=e.responseJSON&&e.responseJSON.message||"Failed to create category";Swal.fire({icon:"error",title:r.error,text:t})}})},showEditCategoryDialog:function(t){var a=this,o=["#3b82f6","#10b981","#f59e0b","#ef4444","#8b5cf6","#ec4899","#06b6d4","#84cc16"].map(function(e){return'<button type="button" class="adeptus-edit-color-swatch'+(e.toLowerCase()===(t.color||"#6c757d").toLowerCase()?" selected":"")+'" data-color="'+e+'" style="background: '+e+';"></button>'}).join("");Swal.fire({title:r.editCategory,html:'<div class="adeptus-cat-edit-modal"><div class="adeptus-cat-edit-preview" id="edit-preview"><div class="adeptus-cat-edit-preview-color" id="edit-preview-color" style="background: '+(t.color||"#6c757d")+';"></div><span class="adeptus-cat-edit-preview-name" id="edit-preview-name">'+t.name+'</span></div><div class="adeptus-cat-edit-field"><label class="adeptus-cat-edit-label">'+r.name+'</label><input type="text" id="edit-cat-name" class="adeptus-cat-edit-input" value="'+t.name.replace(/"/g,"&quot;")+'"></div><div class="adeptus-cat-edit-field"><label class="adeptus-cat-edit-label">'+r.color+'</label><div class="adeptus-cat-edit-colors"><div class="adeptus-cat-edit-swatches">'+o+'</div><div class="adeptus-cat-edit-custom"><input type="color" id="edit-adeptus-cat-color" value="'+(t.color||"#6c757d")+'"><span>'+r.custom+"</span></div></div></div></div>",showCancelButton:!0,confirmButtonText:r.saveChanges,cancelButtonText:r.cancel,customClass:{popup:"adeptus-cat-edit-popup",confirmButton:"adeptus-cat-edit-confirm-btn",cancelButton:"adeptus-cat-edit-cancel-btn"},didOpen:function(){var a=t.color||"#6c757d";e("#edit-cat-name").on("input",function(){e("#edit-preview-name").text(e(this).val()||"Category")}),e(".adeptus-edit-color-swatch").on("click",function(){a=e(this).data("color"),e(".adeptus-edit-color-swatch").removeClass("selected"),e(this).addClass("selected"),e("#edit-preview-color").css("background",a),e("#edit-adeptus-cat-color").val(a)}),e("#edit-adeptus-cat-color").on("input",function(){a=e(this).val(),e(".adeptus-edit-color-swatch").removeClass("selected"),e("#edit-preview-color").css("background",a)})},preConfirm:function(){var e=document.getElementById("edit-cat-name").value.trim(),t=document.getElementById("edit-adeptus-cat-color").value;return e?{name:e,color:t}:(Swal.showValidationMessage(r.pleaseEnterCategoryName),!1)}}).then(function(e){e.isConfirmed&&a.updateCategory(t.id,e.value.name,e.value.color)})},updateCategory:function(t,a,o){var n=this;e.ajax({url:M.cfg.wwwroot+"/report/adeptus_insights/ajax/manage_category.php",method:"POST",dataType:"json",data:{action:"update",category_id:t,name:a,color:o,sesskey:M.cfg.sesskey},success:function(e){if(e.success){var a=n.cachedCategories.findIndex(function(e){return e.id==t});-1!==a&&(n.cachedCategories[a]=e.data),Swal.fire({icon:"success",title:r.categoryUpdated,timer:1500,showConfirmButton:!1}).then(function(){n.showCategoryManagementModal()})}else Swal.fire({icon:"error",title:r.error,text:e.message})},error:function(e){var t=e.responseJSON&&e.responseJSON.message||"";Swal.fire({icon:"error",title:r.error,text:t})}})},confirmDeleteCategory:function(e){var t=this;Swal.fire({title:r.deleteCategoryConfirm,html:"<p>"+r.deleteCategoryWarning.replace("{name}","<strong>"+e.name+"</strong>")+"</p>",icon:"warning",showCancelButton:!0,confirmButtonColor:"#dc3545",confirmButtonText:r.yesDelete,cancelButtonText:r.cancel}).then(function(a){a.isConfirmed&&t.deleteCategory(e.id)})},deleteCategory:function(t){var a=this;e.ajax({url:M.cfg.wwwroot+"/report/adeptus_insights/ajax/manage_category.php",method:"POST",dataType:"json",data:{action:"delete",category_id:t,sesskey:M.cfg.sesskey},success:function(e){e.success?(a.cachedCategories=a.cachedCategories.filter(function(e){return e.id!=t}),Swal.fire({icon:"success",title:r.categoryDeleted,timer:2e3,showConfirmButton:!1}).then(function(){a.showCategoryManagementModal()})):Swal.fire({icon:"error",title:r.error,text:e.message})},error:function(e){var t=e.responseJSON&&e.responseJSON.message||"Failed to delete category";Swal.fire({icon:"error",title:r.error,text:t})}})},confirmDeleteReport:function(e){var t=this;if(e||(e=t.currentReport),e&&e.slug){var a=e.description||e.name||r.untitledReport,o=(e.source||"assistant").toLowerCase();Swal.fire({title:r.deleteReportConfirm,html:"<p>"+r.deleteReportWarning.replace("{name}","<strong>"+a+"</strong>")+"</p>",icon:"warning",showCancelButton:!0,confirmButtonColor:"#dc3545",confirmButtonText:'<i class="fa fa-trash"></i> '+r.yesDelete,cancelButtonText:r.cancel}).then(function(r){r.isConfirmed&&t.deleteReport(e.slug,o,a)})}else Swal.fire({icon:"warning",title:r.noReportSelected,text:r.selectAReport})},deleteReport:function(t,a,o){var n=this;Swal.fire({title:r.deletingReport,text:r.deletingReportWait,allowOutsideClick:!1,allowEscapeKey:!1,didOpen:function(){Swal.showLoading()}}),e.ajax({url:M.cfg.wwwroot+"/report/adeptus_insights/ajax/manage_generated_reports.php",method:"POST",dataType:"json",data:{action:"remove_single",slug:t,source:a,sesskey:M.cfg.sesskey}}).then(function(s){if(!s.success)return Swal.close(),void Swal.fire({icon:"error",title:r.deleteFailed,text:s.message});n.trackReportDeleted(o,"assistant"===a),n.cachedReports=n.cachedReports.filter(function(e){return e.slug!==t}),n.currentReport&&n.currentReport.slug===t&&(n.currentReport=null,n.currentReportData=null),n.renderReportsList(n.cachedReports),n.updateReportCount(n.cachedReports.length),e("#report-content").addClass("d-none"),e("#report-placeholder").removeClass("d-none"),e("#report-category-selector").addClass("d-none"),e(".adeptus-report-view-title").text(r.selectAReport),Swal.close(),n.showToast(r.reportDeletedSuccess,"success")}).catch(function(e){Swal.close();var t="";try{t=JSON.parse(e.responseText).message||""}catch(a){e.responseJSON&&e.responseJSON.message&&(t=e.responseJSON.message)}Swal.fire({icon:"error",title:r.deleteFailed,text:t})})},trackReportDeleted:function(t,a){e.ajax({url:M.cfg.wwwroot+"/report/adeptus_insights/ajax/track_report_deleted.php",method:"POST",dataType:"json",data:{report_name:t,is_ai_generated:a?1:0,sesskey:M.cfg.sesskey}}).done(function(e){window.console.log("[GeneratedReports] Report deletion tracked:",e)}).fail(function(e){window.console.warn("[GeneratedReports] Failed to track report deletion:",e)})},showReportCategorySelector:function(t){var a=this;this.currentCategoryReportSlug=t.slug;var o,n=function(){return a.cachedReports.find(function(e){return e.slug===a.currentCategoryReportSlug})||t},s=function(){var e=n();return e.category_info||{name:e.category||r.general,color:"#6c757d"}};o=s(),e("#category-dot").css("background",o.color||"#6c757d"),e("#category-name").text(o.name||r.general),e("#report-category-selector").removeClass("d-none");var i=function(){var t=n(),o=s(),r=a.cachedCategories.map(function(e){var a=o.id&&e.id===o.id||t.category_id&&e.id===t.category_id||!o.id&&!t.category_id&&e.name.toLowerCase()===(o.name||"general").toLowerCase();return'<button type="button" class="adeptus-category-menu-item'+(a?" selected":"")+'" data-id="'+e.id+'" data-name="'+e.name+'" data-color="'+(e.color||"#6c757d")+'"><span class="adeptus-category-menu-dot" style="background: '+(e.color||"#6c757d")+';"></span><span class="adeptus-category-menu-name">'+e.name+"</span>"+(a?'<svg class="adeptus-category-menu-check" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"></polyline></svg>':"")+"</button>"}).join("");e("#category-dropdown-menu").html(r),e(".adeptus-category-menu-item").off("click").on("click",function(t){t.preventDefault(),t.stopPropagation();var o=e(this).data("id"),r=e(this).data("name"),s=e(this).data("color");e("#category-dropdown-menu").removeClass("show");var i=n();a.updateReportCategory(i.slug,o,r,s,i),e("#category-dot").css("background",s),e("#category-name").text(r)})};e("#category-current-btn").off("click").on("click",function(t){t.preventDefault(),t.stopPropagation(),a.cachedCategories&&a.cachedCategories.length>0&&i(),e("#category-dropdown-menu").toggleClass("show")}),this.cachedCategories&&0!==this.cachedCategories.length?i():e.ajax({url:M.cfg.wwwroot+"/report/adeptus_insights/ajax/manage_category.php",method:"POST",dataType:"json",data:{action:"list",sesskey:M.cfg.sesskey},success:function(e){e.success&&e.data&&(a.cachedCategories=e.data),i()},error:function(){a.cachedCategories=[],i()}}),e("#category-dropdown-menu").off("click").on("click",function(e){e.stopPropagation()}),e(document).off("click.categoryDropdown").on("click.categoryDropdown",function(t){e(t.target).closest(".category-dropdown-wrapper").length||e("#category-dropdown-menu").removeClass("show")})},updateReportCategory:function(t,a,o,n,s){var i=this,c=s&&s.source||"assistant";e("#category-dot").css("background",n),e("#category-name").text(o);var d=i.cachedReports.findIndex(function(e){return e.slug===t}),l=null,p=null,u=null;-1!==d&&(l=i.cachedReports[d].category,p=i.cachedReports[d].category_id,u=i.cachedReports[d].category_info,i.cachedReports[d].category=o,i.cachedReports[d].category_id=a,i.cachedReports[d].category_info={id:a,name:o,color:n}),e.ajax({url:M.cfg.wwwroot+"/report/adeptus_insights/ajax/update_report_category.php",method:"POST",dataType:"json",data:{slug:t,category_id:a,source:c,sesskey:M.cfg.sesskey},success:function(t){if(t.success)e("#category-current-btn").addClass("success-flash"),setTimeout(function(){e("#category-current-btn").removeClass("success-flash")},600);else{if(-1!==d){i.cachedReports[d].category=l,i.cachedReports[d].category_id=p,i.cachedReports[d].category_info=u;var a=u&&u.color||"#6c757d",o=u&&u.name||l||r.general;e("#category-dot").css("background",a),e("#category-name").text(o)}Swal.fire({icon:"error",title:r.error,text:t.message})}},error:function(t){if(-1!==d){i.cachedReports[d].category=l,i.cachedReports[d].category_id=p,i.cachedReports[d].category_info=u;var a=u&&u.color||"#6c757d",o=u&&u.name||l||r.general;e("#category-dot").css("background",a),e("#category-name").text(o)}var n=t.responseJSON&&t.responseJSON.message||"";Swal.fire({icon:"error",title:r.error,text:n})}})},detectNumericColumns:function(e,t){return e&&0!==e.length?t.filter(function(t){for(var a=0,o=Math.min(e.length,20),r=0;r<o;r++){var n=e[r][t];if(null!=n&&""!==n){var s=parseFloat(n);!isNaN(s)&&isFinite(s)&&a++}}return a>=.5*o}):[]},switchView:function(t){this.currentView=t,e(".adeptus-view-toggle-btn").removeClass("active"),e('.adeptus-view-toggle-btn[data-view="'+t+'"]').addClass("active"),"table"===t?(e("#report-table-view").removeClass("d-none"),e("#report-chart-view").addClass("d-none")):(e("#report-table-view").addClass("d-none"),e("#report-chart-view").removeClass("d-none"),this.renderChart())},getAuthToken:function(){var e=window.adeptusAuthData;return e&&e.api_key?e.api_key:null},formatDate:function(e){if(!e)return"N/A";var t=new Date(e),a=new Date-t,o=Math.floor(a/864e5);if(0===o)return"Today, "+t.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"});if(1===o)return"Yesterday, "+t.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"});if(o<7){return["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"][t.getDay()]+", "+t.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}return t.toLocaleDateString()+", "+t.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})},loadReports:function(){var a=this;if(!this.getAuthToken())return a.retryCount<a.maxRetries?(a.retryCount++,void setTimeout(function(){a.loadReports()},500)):(e("#reports-loader").addClass("d-none"),void e("#no-reports-message").removeClass("d-none").html('<i class="fa fa-exclamation-triangle fa-3x text-warning mb-3"></i><h5 class="text-muted">Authentication Required</h5><p class="text-muted">Please ensure you are logged in to view reports.</p>'));var o=new Promise(function(e){t.call([{methodname:"report_adeptus_insights_get_ai_reports",args:{}}])[0].done(function(t){try{var a=JSON.parse(t.data||"{}");e([a])}catch(t){e([{reports:[],data:[]}])}}).fail(function(){e([{reports:[],data:[]}])})}),n=new Promise(function(e){t.call([{methodname:"report_adeptus_insights_get_wizard_reports",args:{}}])[0].done(function(t){var a=t&&t.data?t.data:t||{};e({success:!0,reports:a.reports||[]})}).fail(function(){e({success:!0,reports:[]})})});e.when(o,n).then(function(e,t){var o=e[0]||e||{},r=t[0]||t||{},n=o.reports||o.data||[],s=r.reports||[];n=(Array.isArray(n)?n:[]).map(function(e){if(e.source=e.source||"assistant",e.category_info&&"string"==typeof e.category_info)try{e.category_info=JSON.parse(e.category_info)}catch(t){e.category_info=null}return e}),s=(Array.isArray(s)?s:[]).map(function(e){if(e.source="wizard",e.category_info&&"string"==typeof e.category_info)try{e.category_info=JSON.parse(e.category_info)}catch(t){e.category_info=null}return e}),a.cachedReports=n.concat(s),a.cachedReports.sort(function(e,t){return new Date(t.created_at)-new Date(e.created_at)}),a.enrichReportsWithCategoryInfo(),a.renderReportsList(a.cachedReports),a.updateReportCount(a.cachedReports.length)},function(t){e("#reports-loader").addClass("d-none"),401===t.status?e("#no-reports-message").removeClass("d-none").html('<i class="fa fa-lock fa-3x text-warning mb-3"></i><h5 class="text-muted">'+r.sessionExpired+'</h5><p class="text-muted">'+r.refreshPageToContinue+'</p><button class="btn btn-primary btn-sm" onclick="location.reload()"><i class="fa fa-refresh"></i> '+r.refreshPage+"</button>"):e("#no-reports-message").removeClass("d-none").html('<i class="fa fa-exclamation-circle fa-3x text-danger mb-3"></i><h5 class="text-muted">'+r.failedToLoadReports+'</h5><p class="text-muted">'+r.tryAgainLater+'</p><button class="btn btn-outline-primary btn-sm" onclick="location.reload()"><i class="fa fa-refresh"></i> '+r.retry+"</button>")})},updateReportCount:function(t){var a=1===t?r.reportCount:t+" "+r.reportsCount;e(".adeptus-page-header-subtitle").text(r.youHaveReportsSaved.replace("{count}",a.toLowerCase()))},renderReportsList:function(t){var a=this;this.reportsDataTable&&(this.reportsDataTable.destroy(),this.reportsDataTable=null);var o=e("#reports-tbody");if(o.empty(),e("#reports-loader").addClass("d-none"),!t||0===t.length)return e("#no-reports-message").removeClass("d-none"),void e("#reports-table-wrapper").addClass("d-none");e("#no-reports-message").addClass("d-none"),e("#reports-table-wrapper").removeClass("d-none"),t.forEach(function(t){var n=a.formatDate(t.created_at),s=t.row_count||t.data_count||"",i=s?'<span class="badge bg-info ms-1" title="'+s+' rows"><i class="fa fa-table"></i> '+s+"</span>":"",c=t.category?'<span class="badge bg-secondary ms-1">'+t.category+"</span>":"",d=(t.source||"assistant").toLowerCase(),l="";l="wizard"===d?'<span class="badge adeptus-badge-wizard"><i class="fa fa-magic"></i> '+r.wizard+"</span>":'<span class="badge adeptus-badge-ai"><i class="fa fa-robot"></i> '+r.ai+"</span>";var p=e('<tr class="adeptus-report-row" data-report-slug="'+t.slug+'" data-report-source="'+d+'"></tr>');p.html('<td><div class="adeptus-report-name-cell"><span class="adeptus-report-name">'+(t.description||t.name||r.untitledReport)+'</span><div class="adeptus-report-badges mt-1">'+c+i+'</div></div></td><td><small class="text-muted">'+n+"</small></td><td>"+l+"</td>"),o.append(p)}),e("#reports-table-wrapper").off("click",".adeptus-report-row").on("click",".adeptus-report-row",function(){var t=e(this),o=t.data("report-slug");e(".adeptus-report-row").removeClass("table-primary"),t.addClass("table-primary"),a.loadReportDetails(o)}),setTimeout(function(){try{a.reportsDataTable=new window.simpleDatatables.DataTable("#reports-table",{searchable:!0,fixedHeight:!1,perPage:15,loading:!1,labels:{placeholder:r.searchReports,noRows:r.noReportsFound,info:r.showingReports}}),setTimeout(function(){e(".datatable-wrapper").removeClass("datatable-loading")},100),setTimeout(function(){var t=e(".adeptus-report-row").first();if(t.length&&!a.currentReport){t.addClass("table-primary");var o=t.data("report-slug");o&&a.loadReportDetails(o)}},150)}catch(e){window.console.warn("DataTable initialization failed:",e)}},100)},loadReportDetails:function(a){var o=this;e("#report-placeholder").addClass("d-none"),e("#report-content").addClass("d-none"),e("#report-loading").removeClass("d-none");var n=this.cachedReports.find(function(e){return e.slug===a}),s=n&&n.source||"assistant";n&&(e(".adeptus-report-view-title").text(n.description||n.name||r.reportDetails),o.showReportCategorySelector(n)),"wizard"===s&&n?o.loadWizardReport(n):t.call([{methodname:"report_adeptus_insights_proxy_backend_request",args:{endpoint:"/ai-reports/"+a,method:"GET",body:""}}])[0].done(function(t){try{var n=JSON.parse(t.data||"{}"),i=n.report||n,c=n.data||[];i.source=s;var d=n.sql||i&&i.sql_query||i&&i.sql;if((n.execution_required||(!c||0===c.length)&&d)&&d)return void o.executeReportLocally(d,i.params||{}).then(function(e){var t=e.data||[];o.currentReport=i,o.currentReportData=t;var r=o.cachedReports.findIndex(function(e){return e.slug===a});-1!==r&&(o.cachedReports[r]=Object.assign({},i,{data:t,source:s})),o.renderReportContent(i,t)}).catch(function(t){e("#report-loading").addClass("d-none"),e("#report-content").html('<div class="alert alert-danger"><i class="fa fa-exclamation-circle"></i> '+r.failedToExecuteReport+": "+t.message+'<button class="btn btn-sm btn-outline-danger ms-3" onclick="GeneratedReports.loadReportDetails(\''+a+'\')"><i class="fa fa-refresh"></i> '+r.retry+"</button></div>").removeClass("d-none")});o.currentReport=i,o.currentReportData=c;var l=o.cachedReports.findIndex(function(e){return e.slug===a});-1!==l&&(o.cachedReports[l]=Object.assign({},i,{data:c,source:s})),o.renderReportContent(i,c)}catch(t){e("#report-loading").addClass("d-none"),e("#report-content").html('<div class="alert alert-danger"><i class="fa fa-exclamation-circle"></i> '+r.failedToLoadReportDetails+'<button class="btn btn-sm btn-outline-danger ms-3" onclick="GeneratedReports.loadReportDetails(\''+a+'\')"><i class="fa fa-refresh"></i> '+r.retry+"</button></div>").removeClass("d-none")}}).fail(function(){e("#report-loading").addClass("d-none"),e("#report-content").html('<div class="alert alert-danger"><i class="fa fa-exclamation-circle"></i> '+r.failedToLoadReportDetails+'<button class="btn btn-sm btn-outline-danger ms-3" onclick="GeneratedReports.loadReportDetails(\''+a+'\')"><i class="fa fa-refresh"></i> '+r.retry+"</button></div>").removeClass("d-none")})},loadWizardReport:function(t){var a=this,o=t.parameters||{},n=t.report_template_id||t.name;e.ajax({url:M.cfg.wwwroot+"/lib/ajax/service.php?sesskey="+M.cfg.sesskey+"&info=report_adeptus_insights_generate_report",method:"POST",contentType:"application/json",data:JSON.stringify([{index:0,methodname:"report_adeptus_insights_generate_report",args:{reportid:n,parameters:JSON.stringify(o),reexecution:!0}}]),timeout:6e4,success:function(o){var n=Array.isArray(o)&&o.length>0?o[0]:null;if(n&&n.error)return e("#report-loading").addClass("d-none"),void e("#report-content").html('<div class="alert alert-danger"><i class="fa fa-exclamation-circle"></i> '+(n.exception&&n.exception.message||n.error)+'<button class="btn btn-sm btn-outline-danger ms-3" onclick="GeneratedReports.loadReportDetails(\''+t.slug+'\')"><i class="fa fa-refresh"></i> '+r.retry+"</button></div>").removeClass("d-none");var s=n&&n.data?n.data:n||{};if(s.success){var i=(s.results||s.data||[]).map(function(e){if(e.cells&&Array.isArray(e.cells)){var t={};return e.cells.forEach(function(e){t[e.key]=e.value}),t}return e}),c={name:t.name,description:t.description||t.name,category:s.report&&s.report.category||t.category||"Wizard Report",created_at:t.created_at,source:"wizard",slug:t.slug};a.currentReport=c,a.currentReportData=i;var d=a.cachedReports.findIndex(function(e){return e.slug===t.slug});-1!==d&&(a.cachedReports[d].data=i,a.cachedReports[d].row_count=i.length),a.renderReportContent(c,i)}else e("#report-loading").addClass("d-none"),e("#report-content").html('<div class="alert alert-warning"><i class="fa fa-exclamation-triangle"></i> '+(s.message||r.failedToGenerateReport)+'<button class="btn btn-sm btn-outline-warning ms-3" onclick="GeneratedReports.loadReportDetails(\''+t.slug+'\')"><i class="fa fa-refresh"></i> '+r.retry+"</button></div>").removeClass("d-none")},error:function(){e("#report-loading").addClass("d-none"),e("#report-content").html('<div class="alert alert-danger"><i class="fa fa-exclamation-circle"></i> '+r.failedToExecuteWizardReport+'<button class="btn btn-sm btn-outline-danger ms-3" onclick="GeneratedReports.loadReportDetails(\''+t.slug+'\')"><i class="fa fa-refresh"></i> '+r.retry+"</button></div>").removeClass("d-none")}})},executeReportLocally:function(t,a){return a=a||{},new Promise(function(o,r){e.ajax({url:M.cfg.wwwroot+"/report/adeptus_insights/ajax/execute_ai_report.php",method:"POST",contentType:"application/json",data:JSON.stringify({sql:t,params:a,sesskey:M.cfg.sesskey}),timeout:6e4,success:function(e){if(e.success){var t=e.data,a=e.headers;if("string"==typeof t)try{t=JSON.parse(t)}catch(e){t=[]}if("string"==typeof a)try{a=JSON.parse(a)}catch(e){a=[]}o({data:t||[],headers:a||[],row_count:e.row_count||0,error:null})}else o({data:[],headers:[],row_count:0,error:e.message||"Query execution failed"})},error:function(e,t,a){var o="Failed to execute report";try{o=JSON.parse(e.responseText).message||o}catch(e){o=a||o}r(new Error(o))}})})},renderReportContent:function(t,a){var o=this;e("#report-loading").addClass("d-none");var n="",s=a?a.length:0;n+='<div class="adeptus-report-detail-header mb-4">',n+='<h4 class="mb-2">'+(t.description||t.name||r.report)+"</h4>",n+='<div class="adeptus-report-meta d-flex flex-wrap align-items-center gap-2">';var i=(t.source||"assistant").toLowerCase();n+="wizard"===i?'<span class="badge adeptus-badge-wizard"><i class="fa fa-magic"></i> '+r.wizard+"</span>":'<span class="badge adeptus-badge-ai"><i class="fa fa-robot"></i> '+r.ai+"</span>",n+='<span class="badge adeptus-badge-rowcount"><i class="fa fa-table"></i> '+s+" "+r.rows+"</span>",n+="</div>",n+="</div>",n+='<div class="adeptus-action-bar d-flex justify-content-between align-items-center mb-3">',n+='<div class="adeptus-view-toggle btn-group" role="group">',n+='<button type="button" class="btn btn-sm adeptus-view-toggle-btn active" data-view="table"><i class="fa fa-table"></i> '+r.table+"</button>",n+='<button type="button" class="btn btn-sm adeptus-view-toggle-btn" data-view="chart"><i class="fa fa-bar-chart"></i> '+r.chart+"</button>",n+="</div>";var c=o.isFreePlan?" adeptus-export-premium":"";if(n+='<div class="adeptus-export-buttons d-flex gap-2">',n+='<button class="btn btn-outline-danger btn-sm adeptus-export-pdf-btn"><i class="fa fa-file-pdf-o"></i> '+r.exportPdf+"</button>",n+='<button class="btn btn-outline-primary btn-sm adeptus-export-csv-btn'+c+'"><i class="fa fa-file-excel-o"></i> '+r.exportCsv+(o.isFreePlan?' <i class="fa fa-crown text-warning" style="font-size: 10px;"></i>':"")+"</button>",n+='<button class="btn btn-outline-secondary btn-sm adeptus-export-json-btn'+c+'"><i class="fa fa-code"></i> '+r.exportJson+(o.isFreePlan?' <i class="fa fa-crown text-warning" style="font-size: 10px;"></i>':"")+"</button>",n+="</div>",n+="</div>",a&&a.length>0){var d=Object.keys(a[0]);n+='<div id="report-table-view" class="adeptus-report-view">',n+='<div class="adeptus-report-data-wrapper">',n+='<div class="table-responsive report-table-container">',n+='<table class="table table-striped table-hover table-sm report-data-table">',n+='<thead class="table-light sticky-header"><tr>',d.forEach(function(e){var t=e.replace(/_/g," ").replace(/\b\w/g,function(e){return e.toUpperCase()});n+="<th>"+t+"</th>"}),n+="</tr></thead>",n+="<tbody>",a.slice(0,100).forEach(function(e){n+="<tr>",d.forEach(function(t){var a=e[t];null==a&&(a="");var o=String(a);o.length>100&&(o=o.substring(0,100)+"..."),n+='<td title="'+String(a).replace(/"/g,"&quot;")+'">'+o+"</td>"}),n+="</tr>"}),n+="</tbody></table>",n+="</div>",n+="</div>",a.length>100&&(n+='<div class="alert alert-info mt-3 d-flex align-items-center justify-content-between">',n+='<span><i class="fa fa-info-circle"></i> '+r.showingFirstRows.replace("{first}",100).replace("{total}",a.length)+"</span>",n+='<span class="text-primary">'+r.exportToSeeAll+"</span>",n+="</div>"),n+="</div>",n+='<div id="report-chart-view" class="adeptus-report-view d-none">',n+='<div class="adeptus-chart-controls-wrapper mb-3">',n+='<div class="adeptus-chart-controls d-flex flex-wrap align-items-center gap-3">',n+='<div class="adeptus-control-group">',n+='<label for="chart-type-select" class="form-label">'+r.chartType+"</label>",n+='<select id="chart-type-select" class="form-select form-select-sm">',n+='<option value="bar">'+r.barChart+"</option>",n+='<option value="line">'+r.lineChart+"</option>",n+='<option value="pie">'+r.pieChart+"</option>",n+='<option value="doughnut">'+r.doughnutChart+"</option>",n+="</select>",n+="</div>",n+='<div class="adeptus-control-group">',n+='<label for="chart-x-axis" class="form-label">'+r.xAxisLabels+"</label>",n+='<select id="chart-x-axis" class="form-select form-select-sm">',d.forEach(function(e,t){var a=e.replace(/_/g," ").replace(/\b\w/g,function(e){return e.toUpperCase()});n+='<option value="'+e+'"'+(0===t?" selected":"")+">"+a+"</option>"}),n+="</select>",n+="</div>";var l=o.detectNumericColumns(a,d);n+='<div class="adeptus-control-group">',n+='<label for="chart-y-axis" class="form-label">'+r.yAxisValues+"</label>",n+='<select id="chart-y-axis" class="form-select form-select-sm">',l.length>0?l.forEach(function(e,t){var a=e.replace(/_/g," ").replace(/\b\w/g,function(e){return e.toUpperCase()}),o=t===l.length-1?" selected":"";n+='<option value="'+e+'"'+o+">"+a+"</option>"}):d.forEach(function(e,t){var a=e.replace(/_/g," ").replace(/\b\w/g,function(e){return e.toUpperCase()}),o=t===d.length-1?" selected":"";n+='<option value="'+e+'"'+o+">"+a+"</option>"}),n+="</select>",n+="</div>",n+="</div>",n+="</div>",n+='<div class="adeptus-chart-container" style="position: relative; height: 400px;">',n+='<canvas id="report-chart"></canvas>',n+="</div>",n+="</div>"}else n+='<div class="alert alert-warning text-center py-4">',n+='<i class="fa fa-inbox fa-2x mb-2 d-block"></i>',n+="<strong>"+r.noDataAvailable+"</strong><br>",n+='<small class="text-muted">'+r.noDataRows+"</small>",n+="</div>";e("#report-content").html(n).removeClass("d-none"),o.currentView="table",e("#report-content .adeptus-export-pdf-btn").on("click",function(){o.exportReport(t.slug,"pdf")}),e("#report-content .adeptus-export-csv-btn").on("click",function(){e(this).hasClass("adeptus-export-premium")?o.showExportUpgradePrompt("csv"):o.exportReport(t.slug,"csv")}),e("#report-content .adeptus-export-json-btn").on("click",function(){e(this).hasClass("adeptus-export-premium")?o.showExportUpgradePrompt("json"):o.exportReport(t.slug,"json")}),e("#delete-report-header-btn").off("click").on("click",function(){o.confirmDeleteReport(t)})},renderChart:function(){var t=this.currentReportData;if(t&&0!==t.length){var a=e("#chart-type-select").val()||"bar",o=document.getElementById("report-chart");if(o){this.chartInstance&&(this.chartInstance.destroy(),this.chartInstance=null);var n=e("#chart-x-axis").val(),s=e("#chart-y-axis").val();if(!n||!s){var i=Object.keys(t[0]);n=n||i[0],s=s||i[i.length-1]}var c=s.replace(/_/g," ").replace(/\b\w/g,function(e){return e.toUpperCase()}),d=t.slice(0,50),l=d.map(function(e){var t=e[n];if(null==t)return r.unknown;var a=String(t);return a.length>30?a.substring(0,30)+"...":a}),p=d.map(function(e){return parseFloat(e[s])||0}),u=this.generateChartColors(p.length),g=this.createChartConfig(a,l,p,c,u);try{this.chartInstance=new this.Chart(o.getContext("2d"),g)}catch(t){window.console.error("Error creating chart:",t),e("#report-chart-view .adeptus-chart-container").html('<div class="alert alert-danger"><i class="fa fa-exclamation-triangle"></i> '+r.errorRenderingChart+": "+t.message+"</div>")}}}},generateChartColors:function(e){for(var t=["#2563eb","#10b981","#f59e0b","#ef4444","#8b5cf6","#06b6d4","#ec4899","#84cc16","#f97316","#6366f1","#14b8a6","#a855f7","#eab308","#22c55e","#3b82f6"],a=[],o=0;o<e;o++)a.push(t[o%t.length]);return a},createChartConfig:function(e,t,a,o,n){var s={responsive:!0,maintainAspectRatio:!1,plugins:{title:{display:!0,text:this.currentReport&&this.currentReport.description||this.currentReport&&this.currentReport.name||r.report,font:{size:16,weight:"bold"},padding:{top:10,bottom:20}},legend:{display:"pie"===e||"doughnut"===e,position:"right"}}};return"pie"===e||"doughnut"===e?{type:e,data:{labels:t,datasets:[{data:a,backgroundColor:n,borderColor:"#fff",borderWidth:2}]},options:s}:"line"===e?{type:"line",data:{labels:t,datasets:[{label:o,data:a,borderColor:n[0],backgroundColor:n[0]+"40",borderWidth:3,fill:!0,tension:.4}]},options:Object.assign({},s,{scales:{y:{beginAtZero:!0},x:{ticks:{maxRotation:45,minRotation:45}}}})}:{type:"bar",data:{labels:t,datasets:[{label:o,data:a,backgroundColor:n,borderColor:n.map(function(e){return e}),borderWidth:1}]},options:Object.assign({},s,{scales:{y:{beginAtZero:!0},x:{ticks:{maxRotation:45,minRotation:45}}}})}},exportReport:function(e,t){var a=this;a.currentReportData&&Array.isArray(a.currentReportData)&&0!==a.currentReportData.length?(Swal.fire({title:r.exportingAs.replace("{format}",t.toUpperCase()),allowOutsideClick:!1,didOpen:function(){Swal.showLoading()}}),a.checkExportEligibility(t).then(function(o){if(!o.success||!o.eligible)return Swal.close(),void(a.isFreePlan&&"pdf"!==t?a.showExportUpgradePrompt(t):Swal.fire({icon:"error",title:r.exportNotAvailable,text:o.message||r.exportNotEligible}));var n=e;a.currentReport&&"wizard"===a.currentReport.source&&a.currentReport.name&&(n=a.currentReport.name);var s="reportid="+encodeURIComponent(n)+"&format="+t+"&sesskey="+M.cfg.sesskey;s+="&view="+a.currentView;var i=a.currentReportData.length>0?Object.keys(a.currentReportData[0]):[],c=a.currentReport&&a.currentReport.description||a.currentReport&&a.currentReport.name||"report",d={results:a.currentReportData,headers:i,report_name:c,report_category:a.currentReport&&a.currentReport.category||""};s+="&report_data="+encodeURIComponent(JSON.stringify(d));var l=Promise.resolve(null);"pdf"===t&&"chart"===a.currentView&&(l=a.captureChartImage().catch(function(){return null})),l.then(function(e){return e&&e.length>100&&(s+="&chart_image="+encodeURIComponent(e),window.console.log("[GeneratedReports] Chart image included in export")),fetch(M.cfg.wwwroot+"/report/adeptus_insights/ajax/export_report.php",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:s,credentials:"same-origin"})}).then(function(e){var t=e.headers.get("content-type"),a=e.headers.get("content-disposition");if(t&&t.includes("application/json")&&!a)return e.json().then(function(e){throw new Error(e.message||"Export failed")});if(!e.ok)throw new Error("Export failed with status: "+e.status);return e.blob()}).then(function(e){var o=a.currentReport&&a.currentReport.description||a.currentReport&&a.currentReport.name||"report",n=o.replace(/[^a-zA-Z0-9\s-]/g,"").replace(/\s+/g,"_").toLowerCase(),s=(new Date).toISOString().split("T")[0],i=window.URL.createObjectURL(e),c=document.createElement("a");c.href=i,c.download=n+"_"+s+"."+t,document.body.appendChild(c),c.click(),window.URL.revokeObjectURL(i),document.body.removeChild(c),Swal.close(),a.trackExport(t,o),a.showToast(t.toUpperCase()+" "+r.fileDownloadedSuccess,"success")}).catch(function(e){Swal.close(),Swal.fire({icon:"error",title:r.exportFailed,text:e.message||r.exportFailedMessage})})})):Swal.fire({icon:"warning",title:r.noData,text:r.noDataToExport})}};return window.GeneratedReports=n,{init:function(t){a.get_strings([{key:"general",component:"report_adeptus_insights"},{key:"wizard",component:"report_adeptus_insights"},{key:"ai",component:"report_adeptus_insights"},{key:"report",component:"report_adeptus_insights"},{key:"report_details",component:"report_adeptus_insights"},{key:"untitled_report",component:"report_adeptus_insights"},{key:"unknown",component:"report_adeptus_insights"},{key:"rows",component:"report_adeptus_insights"},{key:"table",component:"report_adeptus_insights"},{key:"chart",component:"report_adeptus_insights"},{key:"retry",component:"report_adeptus_insights"},{key:"cancel",component:"report_adeptus_insights"},{key:"error",component:"report_adeptus_insights"},{key:"export_pdf",component:"report_adeptus_insights"},{key:"export_csv",component:"report_adeptus_insights"},{key:"export_json",component:"report_adeptus_insights"},{key:"exporting_as",component:"report_adeptus_insights"},{key:"export_not_available",component:"report_adeptus_insights"},{key:"export_not_eligible",component:"report_adeptus_insights"},{key:"export_failed",component:"report_adeptus_insights"},{key:"export_failed_message",component:"report_adeptus_insights"},{key:"file_downloaded_success",component:"report_adeptus_insights"},{key:"no_data",component:"report_adeptus_insights"},{key:"no_data_to_export",component:"report_adeptus_insights"},{key:"no_data_available",component:"report_adeptus_insights"},{key:"no_data_rows",component:"report_adeptus_insights"},{key:"premium_export_format",component:"report_adeptus_insights"},{key:"premium_feature",component:"report_adeptus_insights"},{key:"upgrade_now",component:"report_adeptus_insights"},{key:"free_plan_label",component:"report_adeptus_insights"},{key:"free_plan_pdf_only",component:"report_adeptus_insights"},{key:"paid_plans_label",component:"report_adeptus_insights"},{key:"paid_plans_all_formats",component:"report_adeptus_insights"},{key:"export_upgrade_message",component:"report_adeptus_insights"},{key:"categories",component:"report_adeptus_insights"},{key:"create_new_category",component:"report_adeptus_insights"},{key:"custom_color",component:"report_adeptus_insights"},{key:"your_categories",component:"report_adeptus_insights"},{key:"default_categories",component:"report_adeptus_insights"},{key:"read_only",component:"report_adeptus_insights"},{key:"no_custom_categories",component:"report_adeptus_insights"},{key:"create_first_category",component:"report_adeptus_insights"},{key:"category_created",component:"report_adeptus_insights"},{key:"category_updated",component:"report_adeptus_insights"},{key:"category_deleted",component:"report_adeptus_insights"},{key:"edit_category",component:"report_adeptus_insights"},{key:"delete_category",component:"report_adeptus_insights"},{key:"delete_category_confirm",component:"report_adeptus_insights"},{key:"delete_category_warning",component:"report_adeptus_insights"},{key:"yes_delete",component:"report_adeptus_insights"},{key:"category_name",component:"report_adeptus_insights"},{key:"please_enter_category_name",component:"report_adeptus_insights"},{key:"name",component:"report_adeptus_insights"},{key:"color",component:"report_adeptus_insights"},{key:"custom",component:"report_adeptus_insights"},{key:"save_changes",component:"report_adeptus_insights"},{key:"select_a_report",component:"report_adeptus_insights"},{key:"no_report_selected",component:"report_adeptus_insights"},{key:"delete_report",component:"report_adeptus_insights"},{key:"delete_report_confirm",component:"report_adeptus_insights"},{key:"delete_report_warning",component:"report_adeptus_insights"},{key:"deleting_report",component:"report_adeptus_insights"},{key:"deleting_report_wait",component:"report_adeptus_insights"},{key:"delete_failed",component:"report_adeptus_insights"},{key:"report_deleted_success",component:"report_adeptus_insights"},{key:"report_count",component:"report_adeptus_insights"},{key:"reports_count",component:"report_adeptus_insights"},{key:"you_have_reports_saved",component:"report_adeptus_insights"},{key:"session_expired",component:"report_adeptus_insights"},{key:"refresh_page",component:"report_adeptus_insights"},{key:"refresh_page_to_continue",component:"report_adeptus_insights"},{key:"failed_to_load_reports",component:"report_adeptus_insights"},{key:"try_again_later",component:"report_adeptus_insights"},{key:"failed_to_execute_report",component:"report_adeptus_insights"},{key:"failed_to_load_report_details",component:"report_adeptus_insights"},{key:"failed_to_generate_report",component:"report_adeptus_insights"},{key:"failed_to_execute_wizard_report",component:"report_adeptus_insights"},{key:"authentication_required",component:"report_adeptus_insights"},{key:"authentication_required_message",component:"report_adeptus_insights"},{key:"search_reports",component:"report_adeptus_insights"},{key:"no_reports_found",component:"report_adeptus_insights"},{key:"showing_reports",component:"report_adeptus_insights"},{key:"showing_first_rows",component:"report_adeptus_insights"},{key:"export_to_see_all",component:"report_adeptus_insights"},{key:"chart_type",component:"report_adeptus_insights"},{key:"bar_chart",component:"report_adeptus_insights"},{key:"line_chart",component:"report_adeptus_insights"},{key:"pie_chart",component:"report_adeptus_insights"},{key:"doughnut_chart",component:"report_adeptus_insights"},{key:"x_axis_labels",component:"report_adeptus_insights"},{key:"y_axis_values",component:"report_adeptus_insights"},{key:"error_rendering_chart",component:"report_adeptus_insights"},{key:"loading",component:"report_adeptus_insights"}]).then(function(e){return["general","wizard","ai","report","reportDetails","untitledReport","unknown","rows","table","chart","retry","cancel","error","exportPdf","exportCsv","exportJson","exportingAs","exportNotAvailable","exportNotEligible","exportFailed","exportFailedMessage","fileDownloadedSuccess","noData","noDataToExport","noDataAvailable","noDataRows","premiumExportFormat","premiumFeature","upgradeNow","freePlan","freePlanPdfOnly","paidPlans","paidPlansAllFormats","exportUpgradeMessage","categories","createNewCategory","customColor","yourCategories","defaultCategories","readOnly","noCustomCategories","createFirstCategory","categoryCreated","categoryUpdated","categoryDeleted","editCategory","deleteCategory","deleteCategoryConfirm","deleteCategoryWarning","yesDelete","categoryName","pleaseEnterCategoryName","name","color","custom","saveChanges","selectAReport","noReportSelected","deleteReport","deleteReportConfirm","deleteReportWarning","deletingReport","deletingReportWait","deleteFailed","reportDeletedSuccess","reportCount","reportsCount","youHaveReportsSaved","sessionExpired","refreshPage","refreshPageToContinue","failedToLoadReports","tryAgainLater","failedToExecuteReport","failedToLoadReportDetails","failedToGenerateReport","failedToExecuteWizardReport","authenticationRequired","authenticationRequiredMessage","searchReports","noReportsFound","showingReports","showingFirstRows","exportToSeeAll","chartType","barChart","lineChart","pieChart","doughnutChart","xAxisLabels","yAxisValues","errorRenderingChart","loading"].forEach(function(t,a){r[t]=e[a]||t}),r}).catch(function(){return r={general:"General",wizard:"Wizard",ai:"AI",report:"Report",reportDetails:"Report Details",untitledReport:"Untitled Report",unknown:"Unknown",rows:"rows",table:"Table",chart:"Chart",retry:"Retry",cancel:"Cancel",error:"Error",exportPdf:"Export PDF",exportCsv:"Export CSV",exportJson:"Export JSON",exportingAs:"Exporting as {format}...",exportNotAvailable:"Export Not Available",exportNotEligible:"Export not eligible",exportFailed:"Export Failed",exportFailedMessage:"Failed to export report",fileDownloadedSuccess:"file downloaded successfully",noData:"No Data",noDataToExport:"No data to export",noDataAvailable:"No data available",noDataRows:"This report contains no data rows",premiumExportFormat:"Premium Export Format",premiumFeature:"Premium Feature",upgradeNow:"Upgrade Now",freePlan:"Free Plan:",freePlanPdfOnly:"PDF export only",paidPlans:"Paid Plans:",paidPlansAllFormats:"All formats (PDF, CSV, JSON)",exportUpgradeMessage:"{format} export requires a paid plan",categories:"Categories",createNewCategory:"Create New Category",customColor:"Custom color",yourCategories:"Your Categories",defaultCategories:"Default Categories",readOnly:"Read Only",noCustomCategories:"No custom categories yet",createFirstCategory:"Create your first category above",categoryCreated:"Category Created",categoryUpdated:"Category Updated",categoryDeleted:"Category Deleted",editCategory:"Edit Category",deleteCategory:"Delete Category",deleteCategoryConfirm:"Delete Category?",deleteCategoryWarning:"Are you sure you want to delete {name}?",yesDelete:"Yes, Delete",categoryName:"Category name",pleaseEnterCategoryName:"Please enter a category name",name:"Name",color:"Color",custom:"Custom",saveChanges:"Save Changes",selectAReport:"Select a Report",noReportSelected:"No Report Selected",deleteReport:"Delete Report",deleteReportConfirm:"Delete Report?",deleteReportWarning:"Are you sure you want to delete {name}?",deletingReport:"Deleting Report",deletingReportWait:"Please wait...",deleteFailed:"Delete Failed",reportDeletedSuccess:"Report deleted successfully",reportCount:"1 report",reportsCount:"reports",youHaveReportsSaved:"You have {count} saved",sessionExpired:"Session Expired",refreshPage:"Refresh Page",refreshPageToContinue:"Please refresh the page to continue",failedToLoadReports:"Failed to Load Reports",tryAgainLater:"Please try again later",failedToExecuteReport:"Failed to execute report",failedToLoadReportDetails:"Failed to load report details",failedToGenerateReport:"Failed to generate report",failedToExecuteWizardReport:"Failed to execute wizard report",authenticationRequired:"Authentication Required",authenticationRequiredMessage:"Please ensure you are logged in",searchReports:"Search reports...",noReportsFound:"No reports found",showingReports:"Showing reports",showingFirstRows:"Showing first {first} of {total} rows",exportToSeeAll:"Export to see all data",chartType:"Chart Type",barChart:"Bar Chart",lineChart:"Line Chart",pieChart:"Pie Chart",doughnutChart:"Doughnut Chart",xAxisLabels:"X-Axis (Labels)",yAxisValues:"Y-Axis (Values)",errorRenderingChart:"Error rendering chart",loading:"Loading..."}}).then(function(){var a=setInterval(function(){window.adeptusAuthData&&(clearInterval(a),n.init(t))},100);setTimeout(function(){clearInterval(a),window.adeptusAuthData||(e("#reports-loader").addClass("d-none"),e("#no-reports-message").removeClass("d-none").html('<i class="fa fa-exclamation-triangle fa-3x text-warning mb-3"></i><h5 class="text-muted">'+r.authenticationRequired+'</h5><p class="text-muted">'+r.authenticationRequiredMessage+"</p>"))},5e3)})}}});