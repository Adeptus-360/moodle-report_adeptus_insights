{"version":3,"file":"installation_step.min.js","sources":["../src/installation_step.js"],"sourcesContent":["/**\n * Subscription Installation Step JavaScript Module\n *\n * Handles billing toggle, plan selection, and Stripe billing portal integration\n * during the plugin installation wizard.\n *\n * @module     report_adeptus_insights/installation_step\n * @package    report_adeptus_insights\n * @copyright  2026 Adeptus 360 <info@adeptus360.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\ndefine(['jquery', 'core/ajax', 'core/notification', 'core/str'], function($, Ajax, Notification, Str) {\n    'use strict';\n\n    /**\n     * Localized strings loaded via core/str API.\n     * @type {Object}\n     */\n    var STRINGS = {};\n\n    /**\n     * Plans data passed from PHP.\n     * @type {Object}\n     */\n    var plansData = {};\n\n    /**\n     * Current billing interval selection.\n     * @type {string}\n     */\n    var currentInterval = 'monthly';\n\n    /**\n     * Load all required localized strings.\n     * @returns {Promise} Promise resolved when strings are loaded\n     */\n    var loadStrings = function() {\n        return Str.get_strings([\n            {key: 'annual_plans_coming_soon', component: 'report_adeptus_insights'},\n            {key: 'current_plan', component: 'report_adeptus_insights'},\n            {key: 'most_popular', component: 'report_adeptus_insights'},\n            {key: 'free', component: 'report_adeptus_insights'},\n            {key: 'forever', component: 'report_adeptus_insights'},\n            {key: 'per_year', component: 'report_adeptus_insights'},\n            {key: 'per_month', component: 'report_adeptus_insights'},\n            {key: 'save', component: 'report_adeptus_insights'},\n            {key: 'select_free_plan', component: 'report_adeptus_insights'},\n            {key: 'upgrade_to', component: 'report_adeptus_insights'},\n            {key: 'ai_tokens', component: 'report_adeptus_insights'},\n            {key: 'exports_mo', component: 'report_adeptus_insights'},\n            {key: 'saved_reports', component: 'report_adeptus_insights'},\n            {key: 'formats', component: 'report_adeptus_insights'},\n            {key: 'redirecting_to_billing', component: 'report_adeptus_insights'},\n            {key: 'failed_billing_session', component: 'report_adeptus_insights'},\n            {key: 'connection_error', component: 'report_adeptus_insights'}\n        ]).then(function(results) {\n            STRINGS = {\n                annualPlansSoon: results[0],\n                currentPlan: results[1],\n                mostPopular: results[2],\n                free: results[3],\n                forever: results[4],\n                perYear: results[5],\n                perMonth: results[6],\n                save: results[7],\n                selectFreePlan: results[8],\n                upgradeTo: results[9],\n                aiTokens: results[10],\n                exportsMo: results[11],\n                savedReports: results[12],\n                formats: results[13],\n                redirectingToBilling: results[14],\n                failedBillingSession: results[15],\n                connectionError: results[16]\n            };\n            return STRINGS;\n        }).catch(function() {\n            // Fallback strings if loading fails\n            STRINGS = {\n                annualPlansSoon: 'Annual plans coming soon',\n                currentPlan: 'Current Plan',\n                mostPopular: 'Most Popular',\n                free: 'Free',\n                forever: 'Forever',\n                perYear: 'per year',\n                perMonth: 'per month',\n                save: 'Save',\n                selectFreePlan: 'Select Free Plan',\n                upgradeTo: 'Upgrade to',\n                aiTokens: 'AI Tokens',\n                exportsMo: 'Exports/mo',\n                savedReports: 'Saved Reports',\n                formats: 'Formats',\n                redirectingToBilling: 'Redirecting to billing portal...',\n                failedBillingSession: 'Failed to create billing session',\n                connectionError: 'Connection error. Please try again.'\n            };\n            return STRINGS;\n        });\n    };\n\n    /**\n     * Update the plans display based on billing interval.\n     * @param {string} interval - 'monthly' or 'yearly'\n     */\n    var updatePlansDisplay = function(interval) {\n        var plans = plansData[interval] || plansData.monthly;\n        var container = $('#plans-container');\n\n        if (!plans || plans.length === 0) {\n            // No plans for this interval, show message\n            container.html('<div class=\"text-center p-4\"><p class=\"text-muted\">' +\n                STRINGS.annualPlansSoon + '</p></div>');\n            return;\n        }\n\n        // Rebuild cards with new interval data\n        var html = '';\n        plans.forEach(function(plan) {\n            html += buildPlanCard(plan, interval);\n        });\n        container.html(html);\n    };\n\n    /**\n     * Build HTML for a single plan card.\n     * @param {Object} plan - Plan data object\n     * @param {string} interval - Billing interval\n     * @returns {string} HTML string for the plan card\n     */\n    var buildPlanCard = function(plan, interval) {\n        var badgeHtml = '';\n        if (plan.is_current) {\n            badgeHtml = '<div class=\"adeptus-plan-badge current\">' + STRINGS.currentPlan + '</div>';\n        } else if (plan.is_popular) {\n            badgeHtml = '<div class=\"adeptus-plan-badge popular\">' + STRINGS.mostPopular + '</div>';\n        }\n\n        var priceHtml = '';\n        if (plan.is_free) {\n            priceHtml = '<div class=\"adeptus-price-free\">' + STRINGS.free + '</div>' +\n                '<div class=\"adeptus-price-period\">' + STRINGS.forever + '</div>';\n        } else {\n            var periodText = interval === 'yearly' ? STRINGS.perYear : STRINGS.perMonth;\n            priceHtml = '<div class=\"adeptus-price-amount\">' + plan.price_formatted + '</div>' +\n                '<div class=\"adeptus-price-period\">' + periodText + '</div>';\n            if (plan.has_savings) {\n                priceHtml += '<div class=\"adeptus-savings-badge\">' + STRINGS.save + ' ' +\n                    plan.savings_percent + '%</div>';\n            }\n        }\n\n        var featuresHtml = '';\n        if (plan.features && plan.features.length > 0) {\n            plan.features.forEach(function(feature) {\n                featuresHtml += '<li><i class=\"fa fa-check\"></i> ' + feature + '</li>';\n            });\n        }\n\n        var actionHtml = '';\n        if (plan.is_current) {\n            actionHtml = '<button class=\"adeptus-plan-btn adeptus-plan-btn-current\" disabled>' +\n                '<i class=\"fa fa-check-circle\"></i> ' + STRINGS.currentPlan + '</button>';\n        } else if (plan.is_free) {\n            actionHtml = '<button class=\"adeptus-plan-btn adeptus-plan-btn-outline select-adeptus-plan-btn\" ' +\n                'data-plan-id=\"' + plan.id + '\" data-adeptus-plan-name=\"' + plan.name + '\">' +\n                STRINGS.selectFreePlan + '</button>';\n        } else {\n            actionHtml = '<button class=\"adeptus-plan-btn adeptus-plan-btn-primary select-adeptus-plan-btn\" ' +\n                'data-plan-id=\"' + plan.id + '\" data-adeptus-plan-name=\"' + plan.name + '\" ' +\n                'data-stripe-product=\"' + (plan.stripe_product_id || '') + '\">' +\n                '<i class=\"fa fa-arrow-up\"></i> ' + STRINGS.upgradeTo + ' ' + plan.short_name + '</button>';\n        }\n\n        var cardClasses = 'adeptus-plan-card';\n        if (plan.is_popular) {\n            cardClasses += ' popular';\n        }\n        if (plan.is_current) {\n            cardClasses += ' current';\n        }\n\n        return '<div class=\"' + cardClasses + '\" data-tier=\"' + plan.tier + '\" data-interval=\"' + interval + '\">' +\n            badgeHtml +\n            '<div class=\"adeptus-plan-header\">' +\n                '<div class=\"adeptus-plan-name\">' + plan.short_name + '</div>' +\n                '<div class=\"adeptus-plan-description\">' + plan.description + '</div>' +\n            '</div>' +\n            '<div class=\"adeptus-plan-price\">' + priceHtml + '</div>' +\n            '<div class=\"adeptus-plan-limits\">' +\n                '<div class=\"adeptus-limit-item\">' +\n                    '<div class=\"adeptus-limit-value\">' + plan.tokens_limit + '</div>' +\n                    '<div class=\"adeptus-limit-label\">' + STRINGS.aiTokens + '</div>' +\n                '</div>' +\n                '<div class=\"adeptus-limit-item\">' +\n                    '<div class=\"adeptus-limit-value\">' + plan.exports_limit + '</div>' +\n                    '<div class=\"adeptus-limit-label\">' + STRINGS.exportsMo + '</div>' +\n                '</div>' +\n                '<div class=\"adeptus-limit-item\">' +\n                    '<div class=\"adeptus-limit-value\">' + plan.reports_limit + '</div>' +\n                    '<div class=\"adeptus-limit-label\">' + STRINGS.savedReports + '</div>' +\n                '</div>' +\n                '<div class=\"adeptus-limit-item\">' +\n                    '<div class=\"adeptus-limit-value\">' + plan.export_formats + '</div>' +\n                    '<div class=\"adeptus-limit-label\">' + STRINGS.formats + '</div>' +\n                '</div>' +\n            '</div>' +\n            '<div class=\"adeptus-plan-features\"><ul>' + featuresHtml + '</ul></div>' +\n            '<div class=\"adeptus-plan-action\">' + actionHtml + '</div>' +\n        '</div>';\n    };\n\n    /**\n     * Create a Stripe billing portal session and redirect.\n     * @param {string} stripeProductId - Stripe product ID\n     * @param {string} planName - Plan name for display\n     */\n    var createBillingPortalSession = function(stripeProductId, planName) {\n        var returnUrl = window.location.href;\n\n        Ajax.call([{\n            methodname: 'report_adeptus_insights_create_billing_portal_session',\n            args: {\n                return_url: returnUrl,\n                sesskey: M.cfg.sesskey\n            },\n            done: function(response) {\n                if (response && response.success && response.portal_url) {\n                    Notification.addNotification({\n                        message: STRINGS.redirectingToBilling,\n                        type: 'success'\n                    });\n                    setTimeout(function() {\n                        window.location.href = response.portal_url;\n                    }, 1000);\n                } else {\n                    Notification.addNotification({\n                        message: (response && response.message) ? response.message : STRINGS.failedBillingSession,\n                        type: 'error'\n                    });\n                }\n            },\n            fail: function(error) {\n                window.console.error('Billing portal error:', error);\n                Notification.addNotification({\n                    message: STRINGS.connectionError,\n                    type: 'error'\n                });\n            }\n        }]);\n    };\n\n    /**\n     * Initialize event handlers.\n     */\n    var initEventHandlers = function() {\n        // Billing toggle handler\n        $('.adeptus-billing-toggle-btn').on('click', function() {\n            var interval = $(this).data('interval');\n            if (interval === currentInterval) {\n                return;\n            }\n\n            // Update toggle UI\n            $('.adeptus-billing-toggle-btn').removeClass('active');\n            $(this).addClass('active');\n            currentInterval = interval;\n\n            // Update plans display\n            updatePlansDisplay(interval);\n        });\n\n        // Plan selection handler\n        $(document).on('click', '.select-adeptus-plan-btn', function() {\n            var planId = $(this).data('plan-id');\n            var planName = $(this).data('adeptus-plan-name');\n            var stripeProduct = $(this).data('stripe-product');\n\n            if (stripeProduct) {\n                // Paid plan - redirect to billing portal\n                createBillingPortalSession(stripeProduct, planName);\n            } else {\n                // Free plan - complete installation\n                $('#complete-installation-form').submit();\n            }\n        });\n    };\n\n    return {\n        /**\n         * Initialize the installation step module.\n         * @param {Object} config - Configuration object from PHP\n         * @param {Object} config.plansData - Plans data organized by interval\n         */\n        init: function(config) {\n            plansData = config.plansData || {};\n            currentInterval = 'monthly';\n\n            loadStrings().then(function() {\n                initEventHandlers();\n            });\n        }\n    };\n});\n"],"names":["define","$","Ajax","Notification","Str","STRINGS","plansData","currentInterval","buildPlanCard","plan","interval","badgeHtml","is_current","currentPlan","is_popular","mostPopular","priceHtml","is_free","free","forever","periodText","perYear","perMonth","price_formatted","has_savings","save","savings_percent","featuresHtml","features","length","forEach","feature","actionHtml","id","name","selectFreePlan","stripe_product_id","upgradeTo","short_name","cardClasses","tier","description","tokens_limit","aiTokens","exports_limit","exportsMo","reports_limit","savedReports","export_formats","formats","initEventHandlers","on","this","data","removeClass","addClass","plans","monthly","container","html","annualPlansSoon","updatePlansDisplay","document","returnUrl","stripeProduct","window","location","href","call","methodname","args","return_url","sesskey","M","cfg","done","response","success","portal_url","addNotification","message","redirectingToBilling","type","setTimeout","failedBillingSession","fail","error","console","connectionError","submit","init","config","get_strings","key","component","then","results","catch"],"mappings":"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"}