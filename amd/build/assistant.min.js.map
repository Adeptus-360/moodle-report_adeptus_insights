{"version":3,"file":"assistant.min.js","sources":["../src/assistant.js"],"sourcesContent":["define(['jquery', 'core/ajax', 'core/notification', 'core/chartjs', 'core/templates', 'report_adeptus_insights/auth_utils'], function ($, Ajax, Notification, Chart, Templates, AuthUtils) {\n    var Swal = window.Swal;\n\n    var assistant = {\n        currentChatId: 0,\n        currentMCQ: null,\n        isSending: false,\n        mcqQueue: [],\n        reportsDataTable: null,\n        cachedReports: [],\n        cachedCategories: [],\n        _initCalled: false,\n        isCreditLimitExceeded: false,\n        init: function (authenticated) {\n            if (this._initCalled) return;\n            this._initCalled = true;\n            this.currentChatId = 0;\n\n            // Get the specific AI Assistant container (sibling of .assistant-header)\n            const getAssistantContainer = () => $('.assistant-header').siblings('.container-fluid').first();\n            getAssistantContainer().hide();\n\n            // Initialize loader CSS styles on startup\n            this.initializeLoaderStyles();\n\n            // Initialize authentication system\n            try {\n                // Check if user is authenticated\n                if (AuthUtils.isAuthenticated()) {\n                    this.setUserName(AuthUtils.getAuthStatus()?.user?.name || \"User\");\n                    this.updateSubscriptionInfo();\n                    this.setupEventListeners();\n                    this.loadChatHistory();\n                    this.loadReportsHistory();\n                    this.loadCategories(); // Load report categories for save dialog\n                    getAssistantContainer().fadeIn(200);\n                } else {\n                    // Try to refresh authentication\n                    AuthUtils.refreshAuthStatus();\n\n                    // Check authentication status after refresh\n                    setTimeout(() => {\n                        if (AuthUtils.isAuthenticated()) {\n                            this.setUserName(AuthUtils.getAuthStatus()?.user?.name || \"User\");\n                            this.updateSubscriptionInfo();\n                            this.setupEventListeners();\n                            this.loadChatHistory();\n                            this.loadReportsHistory();\n                            this.loadCategories(); // Load report categories for save dialog\n                            getAssistantContainer().fadeIn(200);\n                        } else {\n                            // Show read-only mode or error message\n                            this.showAuthenticationError();\n                        }\n                    }, 500);\n                }\n            } catch (error) {\n                console.error('[AI Assistant] Failed to initialize authentication:', error);\n                // Fallback to basic initialization\n                this.setupEventListeners();\n                getAssistantContainer().fadeIn(200);\n            }\n        },\n\n        initializeLoaderStyles: function() {\n            // Add loader CSS styles early to ensure they're available\n            if ($('#ai-loader-styles').length === 0) {\n                $('head').append(`\n                    <style id=\"ai-loader-styles\">\n                        .ai-thinking-loader-wrapper {\n                            animation: fadeInLoader 0.3s ease-out forwards;\n                        }\n\n                        .ai-thinking-loader {\n                            opacity: 1 !important;\n                        }\n\n                        @keyframes bounce-loader {\n                            0%, 80%, 100% {\n                                transform: scale(0.8);\n                                opacity: 0.5;\n                            }\n                            40% {\n                                transform: scale(1.2);\n                                opacity: 1;\n                            }\n                        }\n\n                        @keyframes fadeInLoader {\n                            from {\n                                opacity: 0;\n                                transform: translateY(10px);\n                            }\n                            to {\n                                opacity: 1;\n                                transform: translateY(0);\n                            }\n                        }\n\n                        @keyframes pulse-glow-loader {\n                            0% {\n                                box-shadow: 0 0 0 0 rgba(14, 165, 233, 0.4);\n                            }\n                            70% {\n                                box-shadow: 0 0 0 8px rgba(14, 165, 233, 0);\n                            }\n                            100% {\n                                box-shadow: 0 0 0 0 rgba(14, 165, 233, 0);\n                            }\n                        }\n                    </style>\n                `);\n            }\n        },\n\n        showAuthenticationError: function() {\n            // Show authentication error message in the AI Assistant container\n            const assistantContainer = $('.assistant-header').siblings('.container-fluid').first();\n            assistantContainer.html(`\n                <div class=\"alert alert-danger\">\n                    <h4>Authentication Required</h4>\n                    <p>You need to be authenticated to use the AI Assistant. Please contact your administrator for assistance.</p>\n                    <button class=\"btn btn-primary\" onclick=\"location.reload()\">Refresh Page</button>\n                </div>\n            `).show();\n        },\n\n        setupEventListeners: function () {\n            const self = this;\n\n            // Send message\n            $('#send-button').on('click', () => this.sendMessage());\n            $('#message-input').on('keydown', (e) => {\n                if (e.key === 'Enter' && !e.shiftKey) {\n                    e.preventDefault();\n                    this.sendMessage();\n                }\n            });\n\n            // Chart type change\n            $('#chart-type').on('change', () => this.updateChart());\n\n            // Auto-resize textarea\n            $('#message-input').on('input', function () {\n                this.style.height = 'auto';\n                this.style.height = (this.scrollHeight) + 'px';\n            });\n\n            $('#create-new-chat').on('click', () => this.createNewChat());\n        },\n\n        // Flag to prevent double message sending\n        isSending: false,\n\n        renderMCQ: function(mcq) {\n            this.currentMCQ = mcq;\n            var c = $('#mcq-container').empty();\n            c.append(`<p><strong>${mcq.question}</strong></p>`);\n            mcq.options.forEach(opt => {\n                c.append(`\n                  <div class=\"form-check\">\n                    <input class=\"form-check-input\" type=\"radio\"\n                           name=\"mcq-option\" id=\"mcq-${opt.key}\"\n                           value=\"${opt.key}\">\n                    <label class=\"form-check-label\" for=\"mcq-${opt.key}\">\n                      ${opt.key}. ${opt.label}\n                    </label>\n                  </div>`);\n            });\n            c.append(`<button id=\"mcq-cancel\" class=\"btn btn-link\">Cancel</button>`);\n        },\n\n        clearMCQ: function() {\n            this.currentMCQ = null;\n            $('#mcq-container').empty().hide();\n            // re-enable text input and send button\n            $('#message-input').prop('disabled', false);\n            $('#send-button').prop('disabled', false);\n        },\n\n        /**\n         * Extract MCQ data from message text (handles both JSON array and individual JSON objects)\n         */\n        extractMCQFromText: function(text) {\n            if (!text || typeof text !== 'string') return null;\n            \n            try {\n                // Try to parse as JSON array first (e.g., ```json [...] ```)\n                const jsonArrayMatch = text.match(/```json\\s*(\\[[\\s\\S]*?\\])\\s*```/);\n                if (jsonArrayMatch) {\n                    const questions = JSON.parse(jsonArrayMatch[1]);\n                    if (Array.isArray(questions) && questions.length > 0 && questions[0].type === 'mcq') {\n                        // Check if there's a selected answer in the next message (if this is history)\n                        return { questions: questions, selectedAnswer: null };\n                    }\n                }\n                \n                // Try to extract individual JSON objects (fallback for older format)\n                const jsonMatches = text.match(/\\{[\\s\\S]*?\\}/g) || [];\n                const questions = [];\n                jsonMatches.forEach(jsonStr => {\n                    try {\n                        const obj = JSON.parse(jsonStr);\n                        if (obj.type === 'mcq' && Array.isArray(obj.options)) {\n                            questions.push(obj);\n                        }\n                    } catch (e) {\n                        // Skip invalid JSON\n                    }\n                });\n                \n                if (questions.length > 0) {\n                    return { questions: questions, selectedAnswer: null };\n                }\n            } catch (e) {\n            }\n            \n            return null;\n        },\n\n        /**\n         * Render MCQ history view (disabled, showing selected answer if available)\n         */\n        renderMCQHistory: function(questions, selectedAnswer = null) {\n            let html = '<div class=\"mcq-history-container\" style=\"display:flex; flex-direction:column; gap:15px;\">';\n            \n            questions.forEach((mcq, idx) => {\n                // Each MCQ gets its own separate container with border and background\n                html += `\n                    <div class=\"mcq-history-item\" style=\"background:#f8f9fa; padding:15px; border-radius:8px; border:1px solid #dee2e6; box-shadow:0 1px 3px rgba(0,0,0,0.05);\">\n                        <p style=\"font-weight:600; margin-bottom:12px; color:#333; font-size:14px;\">\n                            <i class=\"fa fa-question-circle\" style=\"color:#007bff; margin-right:8px;\"></i>${mcq.question}\n                        </p>\n                        <div class=\"mcq-options\" style=\"margin-left:24px;\">\n                `;\n                \n                mcq.options.forEach((option, optIdx) => {\n                    const optionText = typeof option === 'string' ? option : option.label || option;\n                    const isSelected = selectedAnswer && (selectedAnswer === option || selectedAnswer === optionText || selectedAnswer.includes(optionText));\n                    const selectedStyle = isSelected ? 'background:#e3f0ff; border:2px solid #007bff; font-weight:600;' : 'border:1px solid #ced4da;';\n                    const selectedIcon = isSelected ? '<i class=\"fa fa-check-circle\" style=\"color:#28a745; margin-right:5px;\"></i>' : '';\n                    \n                    html += `\n                        <div class=\"form-check\" style=\"padding:10px 14px; border-radius:6px; margin-bottom:8px; ${selectedStyle} transition:all 0.2s;\">\n                            <input class=\"form-check-input\" type=\"radio\" name=\"mcq-${idx}\" disabled ${isSelected ? 'checked' : ''} style=\"margin-top:0.3em;\">\n                            <label class=\"form-check-label\" style=\"color:#555; cursor:not-allowed; margin-left:5px;\">\n                                ${selectedIcon}${optionText}\n                            </label>\n                        </div>\n                    `;\n                });\n                \n                html += `\n                        </div>\n                        <p style=\"margin-top:12px; margin-bottom:0; font-size:11px; color:#6c757d; font-style:italic;\">\n                            <i class=\"fa fa-info-circle\" style=\"margin-right:4px;\"></i>Previous question from chat history\n                        </p>\n                    </div>\n                `;\n            });\n            \n            html += '</div>';\n            \n            return html;\n        },\n\n        checkAuth: function () {\n            if (!AuthUtils.isAuthenticated()) {\n                this.showAuthenticationError();\n                return false;\n            } else {\n                this.loadChatHistory();\n                return true;\n            }\n        },\n\n        handleResponse: function (response) {\n            // Route responses based on type\n            if (response.error) {\n                // Handle token/credit limit errors specifically\n                if (response.error_type === 'credit_limit' || response.error_type === 'token_limit') {\n                    this.handleCreditLimitError(response.message);\n                    return;\n                }\n                // error bubble from backend\n                this.addMessage(response.message, 'error');\n                // Show resend icon on the last user message\n                this.showResendIconOnLastUserMessage();\n            } else if (response.type === 'mcq') {\n                // Add MCQ as AI message first\n                if (response.questions && response.questions.length > 0) {\n                    const firstQuestion = response.questions[0];\n                    const mcqText = `Question: ${firstQuestion.question}\\nOptions: ${firstQuestion.options.join(', ')}`;\n                    this.addMessage(mcqText, 'ai', false, null, null, null, response.credit_info);\n                }\n                // show multiple-choice question\n                this.enqueueMCQs(response.questions);\n                return;\n            } else if (response.type === 'sql' || response.type === 'report') {\n                // Handle report generation with confirmation workflow\n                if (response.awaiting_confirmation && response.report) {\n                    // Show report data first, then confirmation prompt\n                    this.showReportConfirmation(\n                        response.report,\n                        response.report_data || null,\n                        response.message,\n                        response.credit_info,\n                        response.execution_error || null\n                    );\n                    return;\n                }\n                // Legacy handling for direct report generation\n                const reportData = response.report || response;\n                this.addMessage(reportData.description || response.message, 'ai', true, reportData, null, null, response.credit_info);\n                this.updateChatHistoryBadge(this.currentChatId);\n                // Update cache and UI directly\n                this.cachedReports.unshift(reportData);\n                this.updateReportsHistory(this.cachedReports);\n                // Reinitialize DataTable for updated history\n                if (this.reportsDataTable) {\n                    this.reportsDataTable.destroy();\n                    this.reportsDataTable = null;\n                }\n                \n                // Wait for DOM to be updated before reinitializing DataTable\n                setTimeout(() => {\n                    try {\n                        const tableElement = document.getElementById('reports-history-table');\n                        if (tableElement) {\n                            const thead = tableElement.querySelector('thead');\n                            const tbody = tableElement.querySelector('tbody');\n                            \n                            if (thead && tbody && thead.rows.length > 0 && thead.rows[0].cells.length > 0) {\n                                const headerCells = thead.rows[0].cells.length;\n                                const dataRows = tbody.rows;\n                                let dataCells = 0;\n                                \n                                if (dataRows.length > 0) {\n                                    dataCells = dataRows[0].cells.length;\n                                }\n                                \n                                if (headerCells === dataCells && headerCells > 0) {\n                                    // Only initialize DataTable if we have actual data rows (not just empty state)\n                                    if (dataRows.length > 0 && !dataRows[0].cells[0].textContent.includes('No reports')) {\n                this.reportsDataTable = new simpleDatatables.DataTable(\"#reports-history-table\", {\n                    searchable: true,\n                    fixedHeight: false,\n                    perPage: 10,\n                    loading: false  // Disable loading indicator\n                });\n                                        // Remove the loading class from the wrapper\n                                        setTimeout(() => {\n                                            $('.datatable-wrapper').removeClass('datatable-loading');\n                                            $('#report-history-table-wrapper .datatable-wrapper').removeClass('datatable-loading');\n                                        }, 100);\n                                    }\n                                }\n                            }\n                        }\n                    } catch (error) {\n                        console.error('Error reinitializing DataTable:', error);\n                    }\n                }, 100);\n                // Show SweetAlert loader for report generation\n                Swal.fire({\n                    title: 'Generating Report',\n                    html: `\n                        <div class=\"text-center\">\n                            <div class=\"spinner-border text-primary mb-3\" role=\"status\">\n                            </div>\n                            <p>Please wait while we generate your report...</p>\n                        </div>\n                    `,\n                    showConfirmButton: false,\n                    allowOutsideClick: false,\n                    allowEscapeKey: false,\n                    timer: 2000,\n                    timerProgressBar: true\n                }).then(() => {\n                    this.switchToReportsTab();\n                    this.displayCurrentReport(response.report);\n                    // Automatically execute the report\n                    this.executeReport(response.report.slug);\n                });\n                return;\n            } else {\n                // normal AI or SQL response\n                this.addMessage(response.message, 'ai', false, null, null, null, response.credit_info);\n            }\n\n            // Update report data if available\n            if (response.data) {\n                this.updateReportData(response.data);\n            }\n\n            // Update visualizations if available\n            if (response.visualizations) {\n                this.updateVisualizations(response.visualizations);\n            }\n            \n            // Show immediate credit usage feedback if available\n            if (response.credit_info) {\n                this.showCreditUsageFeedback(response.credit_info);\n            }\n            \n            this.scrollToBottom();\n        },\n\n        /**\n         * Show immediate credit usage feedback\n         */\n        showCreditUsageFeedback: function(creditInfo) {\n            if (!creditInfo) return;\n            \n            // Create a temporary notification for credit usage\n            const notification = $(`\n                <div class=\"credit-usage-notification\" style=\"\n                    position: fixed;\n                    top: 20px;\n                    right: 20px;\n                    background: #28a745;\n                    color: white;\n                    padding: 12px 20px;\n                    border-radius: 6px;\n                    box-shadow: 0 4px 12px rgba(0,0,0,0.15);\n                    z-index: 9999;\n                    font-size: 14px;\n                    font-weight: 500;\n                    opacity: 0;\n                    transform: translateX(100%);\n                    transition: all 0.3s ease;\n                \">\n                    <i class=\"fa fa-coins me-2\"></i>\n                    <span class=\"credit-text\">Credits used: ${creditInfo.credits_charged || 0} (${creditInfo.credit_type || 'basic'})</span>\n                </div>\n            `);\n            \n            // Add to body\n            $('body').append(notification);\n            \n            // Animate in\n            setTimeout(() => {\n                notification.css({\n                    'opacity': '1',\n                    'transform': 'translateX(0)'\n                });\n            }, 100);\n            \n            // Animate out and remove after 3 seconds\n            setTimeout(() => {\n                notification.css({\n                    'opacity': '0',\n                    'transform': 'translateX(100%)'\n                });\n                setTimeout(() => {\n                    notification.remove();\n                }, 300);\n            }, 3000);\n            \n            // Also update the subscription info immediately\n            this.updateSubscriptionInfoWithCreditUsage(creditInfo);\n        },\n\n        /**\n         * Update subscription info with immediate credit usage\n         */\n        updateSubscriptionInfoWithCreditUsage: function(creditInfo) {\n            const authStatus = AuthUtils.getAuthStatus();\n            if (!authStatus || !authStatus.subscription) return;\n            \n            const subscription = authStatus.subscription;\n            const creditsUsed = creditInfo.credits_charged || 0;\n            \n            // Update the credit counters immediately\n            if (creditInfo.credit_type === 'premium') {\n                subscription.premium_credits_used_this_month = (subscription.premium_credits_used_this_month || 0) + creditsUsed;\n            } else {\n                subscription.basic_credits_used_this_month = (subscription.basic_credits_used_this_month || 0) + creditsUsed;\n            }\n            \n            // Update total AI credits\n            subscription.ai_credits_used_this_month = (subscription.ai_credits_used_this_month || 0) + creditsUsed;\n            \n            // Animate the counter updates\n            this.animateCreditCounterUpdate(creditInfo.credit_type, creditsUsed);\n            \n            // Update the display\n            this.updateSubscriptionInfo();\n        },\n\n        /**\n         * Animate credit counter updates\n         */\n        animateCreditCounterUpdate: function(creditType, creditsUsed) {\n            const counterClass = creditType === 'premium' ? '.premium-credits-counter' : '.basic-credits-counter';\n            const $counter = $(counterClass);\n            \n            if ($counter.length) {\n                // Add highlight animation\n                $counter.addClass('credit-update-highlight');\n                \n                // Remove highlight after animation\n                setTimeout(() => {\n                    $counter.removeClass('credit-update-highlight');\n                }, 1000);\n            }\n            \n            // Also animate total credits counter\n            const $totalCounter = $('.total-credits-counter');\n            if ($totalCounter.length) {\n                $totalCounter.addClass('credit-update-highlight');\n                setTimeout(() => {\n                    $totalCounter.removeClass('credit-update-highlight');\n                }, 1000);\n            }\n        },\n\n        addMessage: function (text, type, isReportLink = false, reportData = null, messageId = null, timestamp = null, creditInfo = null) {\n            // Filter out \"Confidence: X%\" from AI messages as it's not useful for users\n            if (type === 'ai' && text) {\n                text = text.replace(/\\nConfidence:\\s*\\d+%\\n?/gi, '\\n').replace(/Confidence:\\s*\\d+%/gi, '').trim();\n            }\n\n            const template = document.getElementById('message-template');\n            const frag = template.content.cloneNode(true);\n            const messageEl = frag.querySelector('.message');\n            messageEl.classList.add(type + '-message');\n            if (messageId) {\n                messageEl.setAttribute('data-message-id', messageId);\n            }\n\n            // Check if message contains MCQ JSON\n            const mcqData = this.extractMCQFromText(text);\n            \n            if (mcqData && mcqData.questions.length > 0) {\n                // Render as disabled MCQ view\n                const mcqHtml = this.renderMCQHistory(mcqData.questions, mcqData.selectedAnswer);\n                frag.querySelector('.message-text').innerHTML = mcqHtml;\n            } else if (isReportLink && reportData) {\n                // Create a clickable report link\n                frag.querySelector('.message-text').innerHTML = `\n                    <a href=\"javascript:void(0)\"\n                       class=\"report-link\"\n                       data-report-slug=\"${reportData.slug}\"\n                       style=\"color: #007bff; text-decoration: none; cursor:pointer; padding:4px 8px; border:1px solid #dee2e6; border-radius:4px; background:#f8f9fa; display:inline-block; transition:all 0.2s;\">\n                        ðŸ“Š ${text}\n                    </a>\n                `;\n                const self = this;\n                setTimeout(() => {\n                    const link = messageEl.querySelector('.report-link');\n                    link.onclick = function() { self.openReportFromLink(link.getAttribute('data-report-slug')); };\n                    link.onmouseenter = function() { $(this).css({'background-color':'#e9ecef','border-color':'#adb5bd','transform':'translateY(-1px)'}); };\n                    link.onmouseleave = function() { $(this).css({'background-color':'#f8f9fa','border-color':'#dee2e6','transform':'translateY(0)'}); };\n                }, 0);\n            } else if (type === 'report-preview' || type === 'system-action') {\n                // Render HTML content directly for report previews and system actions\n                frag.querySelector('.message-text').innerHTML = text;\n                // Remove the message bubble styling for these types\n                messageEl.classList.add(type + '-message');\n                if (type === 'report-preview') {\n                    messageEl.style.background = 'transparent';\n                    messageEl.style.padding = '0';\n                    messageEl.style.border = 'none';\n                    messageEl.style.maxWidth = '100%';\n                } else if (type === 'system-action') {\n                    messageEl.style.background = 'transparent';\n                    messageEl.style.padding = '0';\n                    messageEl.style.border = 'none';\n                    messageEl.style.maxWidth = '100%';\n                }\n            } else {\n                // Check if this is a multiple choice question from AI\n                if (type === 'ai' && this.isMultipleChoiceQuestion(text)) {\n                    const mcqHtml = this.renderMultipleChoiceOptions(text);\n                    frag.querySelector('.message-text').innerHTML = mcqHtml;\n                } else {\n                    frag.querySelector('.message-text').textContent = text;\n                }\n            }\n            \n            // Add credit information for AI messages\n            if (type === 'ai' && creditInfo) {\n                this.addCreditInfoToMessage(frag, creditInfo);\n            }\n            \n            const timeEl = frag.querySelector('.message-time');\n            timeEl.textContent = this.formatTimestamp(timestamp || new Date().toISOString());\n            $('#chat-container').append(frag);\n            this.scrollToBottom();\n            return $(messageEl);\n        },\n\n        addCreditInfoToMessage: function (frag, creditInfo) {\n            const messageEl = frag.querySelector('.message');\n            const creditBadge = document.createElement('div');\n            creditBadge.className = 'credit-info-badge';\n            creditBadge.style.cssText = `\n                display: inline-block;\n                margin-left: 8px;\n                padding: 2px 6px;\n                border-radius: 12px;\n                font-size: 11px;\n                font-weight: 500;\n                text-transform: uppercase;\n                letter-spacing: 0.5px;\n            `;\n            \n            // Set badge color and text based on credit type\n            if (creditInfo.credit_type === 'premium') {\n                creditBadge.style.backgroundColor = '#6f42c1';\n                creditBadge.style.color = 'white';\n                creditBadge.textContent = 'Premium';\n            } else {\n                creditBadge.style.backgroundColor = '#28a745';\n                creditBadge.style.color = 'white';\n                creditBadge.textContent = 'Basic';\n            }\n            \n            // Add tooltip with detailed information\n            creditBadge.title = `${creditInfo.credit_type.toUpperCase()} Response\\nTokens: ${creditInfo.tokens_used}\\nCredits: ${creditInfo.credits_charged}\\nProvider: ${creditInfo.provider}`;\n            \n            // Insert after message text\n            const messageText = messageEl.querySelector('.message-text');\n            messageText.appendChild(creditBadge);\n        },\n\n        /**\n         * Check if the message contains multiple choice options\n         */\n        isMultipleChoiceQuestion: function(text) {\n            // Look for pattern like \"A. option\" or \"A) option\" or \"1. option\" with at least 2 options\n            const letterPattern = /^[A-Z][\\.\\)]\\s+.+$/gmi;\n            const numberPattern = /^[1-9][0-9]*[\\.\\)]\\s+.+$/gm;\n            const letterMatches = text.match(letterPattern);\n            const numberMatches = text.match(numberPattern);\n\n\n            // Check if we have consecutive letters or consecutive numbers\n            if (letterMatches && letterMatches.length >= 2) {\n                // Check if options are consecutive (A, B, C...)\n                const letters = letterMatches.map(m => m.match(/^([A-Z])/i)[1].toUpperCase());\n                const firstLetter = letters[0].charCodeAt(0);\n                let isConsecutive = true;\n                for (let i = 1; i < Math.min(letters.length, 4); i++) {\n                    if (letters[i].charCodeAt(0) !== firstLetter + i) {\n                        isConsecutive = false;\n                        break;\n                    }\n                }\n                return isConsecutive;\n            }\n\n            if (numberMatches && numberMatches.length >= 2) {\n                // Check if options are consecutive (1, 2, 3...)\n                const numbers = numberMatches.map(m => parseInt(m.match(/^([0-9]+)/)[1]));\n                let isConsecutive = true;\n                for (let i = 1; i < Math.min(numbers.length, 4); i++) {\n                    if (numbers[i] !== numbers[0] + i) {\n                        isConsecutive = false;\n                        break;\n                    }\n                }\n                return isConsecutive;\n            }\n\n            return false;\n        },\n\n        /**\n         * Render multiple choice options as clickable buttons\n         */\n        renderMultipleChoiceOptions: function(text) {\n            const self = this;\n\n            // Split the text into question and options\n            const lines = text.split('\\n');\n            let questionText = [];\n            let options = [];\n\n            lines.forEach(line => {\n                const trimmedLine = line.trim();\n                // Check if line is an option (A., B., C., D. or A), B), C), D) or 1., 2., etc.)\n                const letterMatch = trimmedLine.match(/^([A-Z])[\\.\\)]\\s+(.+)$/i);\n                const numberMatch = trimmedLine.match(/^([1-9][0-9]*)[\\.\\)]\\s+(.+)$/);\n\n                if (letterMatch) {\n                    options.push({\n                        letter: letterMatch[1].toUpperCase(),\n                        text: letterMatch[2].trim(),\n                        isLetter: true\n                    });\n                } else if (numberMatch) {\n                    options.push({\n                        letter: numberMatch[1],\n                        text: numberMatch[2].trim(),\n                        isLetter: false\n                    });\n                } else if (trimmedLine) {\n                    questionText.push(trimmedLine);\n                }\n            });\n\n            // Build the HTML\n            let html = '<div class=\"mcq-question-container\">';\n\n            // Add the question text\n            html += '<div class=\"mcq-question-text\" style=\"margin-bottom: 15px; white-space: pre-wrap;\">';\n            html += this.escapeHtml(questionText.join('\\n'));\n            html += '</div>';\n\n            // Add the options as buttons\n            if (options.length > 0) {\n                html += '<div class=\"mcq-options-grid\" style=\"display: grid; gap: 10px; grid-template-columns: 1fr;\">';\n\n                options.forEach(option => {\n                    const optionId = 'mcq-option-' + Date.now() + '-' + option.letter;\n                    html += `\n                        <button class=\"mcq-option-button\"\n                                data-option=\"${option.letter}\"\n                                id=\"${optionId}\"\n                                style=\"\n                                    padding: 12px 16px;\n                                    display: flex;\n                                    align-items: center;\n                                    gap: 12px;\n                                    font-size: 14px;\n                                    line-height: 1.5;\n                                    color: #333;\n                                    min-height: 50px;\n                                \">\n                            <span class=\"mcq-option-letter\" style=\"\n                                background: linear-gradient(135deg, #0ea5e9 0%, #2563eb 100%);\n                                color: white;\n                                width: 32px;\n                                height: 32px;\n                                border-radius: 50%;\n                                display: flex;\n                                align-items: center;\n                                justify-content: center;\n                                font-weight: bold;\n                                flex-shrink: 0;\n                            \">${option.letter}</span>\n                            <span class=\"mcq-option-text\" style=\"flex: 1;\">${this.escapeHtml(option.text)}</span>\n                        </button>\n                    `;\n                });\n\n                html += '</div>';\n            }\n\n            html += '</div>';\n\n            // Attach click handlers after DOM insertion\n            setTimeout(() => {\n                const container = document.querySelector('#chat-container');\n                const latestButtons = container.querySelectorAll('.mcq-option-button:not([data-handler-attached])');\n\n                latestButtons.forEach(button => {\n                    button.setAttribute('data-handler-attached', 'true');\n                    button.addEventListener('click', function() {\n                        // Prevent if already disabled\n                        if (this.disabled) return;\n\n                        const selectedOption = this.getAttribute('data-option');\n                        const selectedText = options.find(o => o.letter === selectedOption);\n\n                        // Disable all buttons in this question to prevent double-clicking\n                        const parentContainer = this.closest('.mcq-question-container');\n                        const allButtons = parentContainer.querySelectorAll('.mcq-option-button');\n\n                        allButtons.forEach(btn => {\n                            btn.disabled = true;\n                            btn.classList.add('disabled');\n                        });\n\n                        // Highlight selected option\n                        this.classList.add('selected');\n\n                        // Add checkmark to selected option\n                        const letterSpan = this.querySelector('.mcq-option-letter');\n                        letterSpan.innerHTML = 'âœ“';\n\n                        // Format and send the answer\n                        let answer;\n                        if (selectedText.isLetter !== false) {\n                            // Letter option: send full text for clarity\n                            answer = `${selectedOption}. ${selectedText.text}`;\n                        } else {\n                            // Number option: send full text\n                            answer = `${selectedOption}. ${selectedText.text}`;\n                        }\n\n                        // Send the answer (this will show it as a user message)\n                        self.sendMessage(answer);\n                    });\n                });\n            }, 100);\n\n            return html;\n        },\n\n        /**\n         * Escape HTML to prevent XSS\n         */\n        escapeHtml: function(text) {\n            const map = {\n                '&': '&amp;',\n                '<': '&lt;',\n                '>': '&gt;',\n                '\"': '&quot;',\n                \"'\": '&#039;'\n            };\n            return text.replace(/[&<>\"']/g, m => map[m]);\n        },\n\n        handleCreditLimitError: function (message, creditData = null) {\n            // Update subscription data with latest credit information from API response\n            if (creditData && creditData.summary) {\n                this.updateSubscriptionDataFromCreditResponse(creditData);\n            }\n\n            // Set credit limit exceeded flag to disable send button\n            this.isCreditLimitExceeded = true;\n            this.updateSendMessageandCreateNewChatButton();\n\n            // Show persistent credit limit message at the top\n            this.showPersistentCreditLimitMessage(message);\n\n            // Show user-friendly credit limit error in chat\n            this.addMessage(message, 'error');\n\n            // Show upgrade prompt\n            Swal.fire({\n                icon: 'warning',\n                title: 'Token Limit Reached',\n                html: `\n                    <div class=\"text-center\">\n                        <p>${message}</p>\n                        <p class=\"text-muted\">Your monthly token allowance has been used up.</p>\n                        <p class=\"text-muted\">Tokens reset on the 1st of each month.</p>\n                    </div>\n                `,\n                showCancelButton: true,\n                confirmButtonText: 'View Usage',\n                cancelButtonText: 'Close',\n                confirmButtonColor: '#007bff'\n            }).then((result) => {\n                if (result.isConfirmed) {\n                    this.showCreditUsageModal();\n                }\n            });\n        },\n\n        /**\n         * Update subscription data from token limit error response\n         */\n        updateSubscriptionDataFromCreditResponse: function(creditData) {\n            const authStatus = AuthUtils.getAuthStatus();\n            if (!authStatus || !authStatus.subscription) return;\n\n            const subscription = authStatus.subscription;\n\n            // Update token usage with actual data from API\n            if (creditData.tokens_used !== undefined) {\n                subscription.tokens_used = creditData.tokens_used;\n            }\n            if (creditData.tokens_limit !== undefined) {\n                subscription.tokens_limit = creditData.tokens_limit;\n            }\n            if (creditData.tokens_remaining !== undefined) {\n                subscription.tokens_remaining = creditData.tokens_remaining;\n            }\n\n            // Force refresh of auth status to persist the changes\n            AuthUtils.setAuthStatus(authStatus);\n\n            // Update the display immediately\n            this.updateSubscriptionInfo();\n        },\n\n        handleTimeoutError: function (message) {\n            // Show user-friendly timeout error\n            this.addMessage(message, 'error');\n            \n            // Show retry prompt\n            Swal.fire({\n                icon: 'info',\n                title: 'AI Service Busy',\n                html: `\n                    <div class=\"text-center\">\n                        <p>${message}</p>\n                        <p class=\"text-muted\">The AI service is experiencing high demand. Please try again in a moment.</p>                                                                                       \n                    </div>\n                `,\n                showCancelButton: true,\n                confirmButtonText: 'Try Again',\n                cancelButtonText: 'Cancel',\n                confirmButtonColor: '#007bff',\n                cancelButtonColor: '#6c757d'\n            }).then((result) => {\n                if (result.isConfirmed) {\n                    // Focus on the input field for retry\n                    $('#message-input').focus();\n                }\n            });\n        },\n\n        showPersistentCreditLimitMessage: function (message) {\n            // Remove any existing limit message\n            $('.credit-limit-alert').remove();\n\n            // Create persistent token limit message\n            const alertHtml = `\n                <div class=\"alert alert-danger credit-limit-alert\" role=\"alert\" style=\"margin: 10px 0; border-left: 4px solid #dc3545; background-color: #f8d7da; border-color: #f5c6cb;\">\n                    <div class=\"d-flex align-items-center\">\n\n                        <div class=\"flex-grow-1\">\n                            <strong class=\"text-danger\">Token Limit Reached</strong><br>\n                            <small class=\"text-muted\">${message}</small>\n                        </div>\n                        <div class=\"ms-3\">\n                            <button type=\"button\" class=\"btn btn-sm btn-outline-danger me-2\" onclick=\"window.assistant.showCreditUsageModal()\">\n                                <i class=\"fas fa-chart-bar me-1\"></i> View Usage\n                            </button>\n\n                        </div>\n                    </div>\n                </div>\n            `;\n            \n            // Insert at the top of the subscription header area\n            // Insert before the second occurrence of class 'main-inner'\n            var $mainInners = $('.main-inner');\n            if ($mainInners.length >= 2) {\n                $mainInners.eq(1).before(alertHtml);\n            } else if ($mainInners.length === 1) {\n                $mainInners.eq(0).before(alertHtml);\n            } else {\n                // Fallback: append to body if .main-inner not found\n                $('body').prepend(alertHtml);\n            }\n\n        },\n\n        hidePersistentCreditLimitMessage: function () {\n            $('.credit-limit-alert').fadeOut(300, function() {\n                $(this).remove();\n            });\n        },\n\n        showCreditUsageModal: function () {\n            // Show loading modal first\n            Swal.fire({\n                title: 'Loading Usage Data...',\n                text: 'Please wait while we fetch your usage information',\n                allowOutsideClick: false,\n                showConfirmButton: false,\n                willOpen: () => {\n                    Swal.showLoading();\n                }\n            });\n\n            // Fetch detailed usage data\n            this.ajaxWithAuth({\n                url: 'https://a360backend.stagingwithswift.com/api/v1/chat/credits/detailed-usage',\n                method: 'GET',\n                success: (response) => {\n                    if (response.success) {\n                        this.displayDetailedUsageModal(response.data);\n                    } else {\n                        Swal.fire('Error', 'Failed to load usage information', 'error');\n                    }\n                },\n                error: () => {\n                    Swal.fire('Error', 'Failed to load usage information', 'error');\n                }\n            });\n        },\n\n        displayDetailedUsageModal: function (data) {\n            const summary = data.summary;\n            const usage = data.usage || [];\n            const pagination = data.pagination || { total: 0 };\n\n            // Helper function to format tokens\n            const formatTokens = (tokens) => {\n                if (tokens >= 1000000) return (tokens / 1000000).toFixed(1) + 'M';\n                if (tokens >= 1000) return (tokens / 1000).toFixed(1) + 'K';\n                return tokens.toString();\n            };\n\n            // Calculate usage percentage\n            const usagePercent = summary.tokens_limit > 0 && summary.tokens_remaining !== -1\n                ? Math.min(100, Math.round((summary.total_tokens_used / summary.tokens_limit) * 100))\n                : 0;\n            const limitDisplay = summary.tokens_remaining === -1 ? 'Unlimited' : formatTokens(summary.tokens_limit);\n\n            // Create the comprehensive modal HTML with optimized styling\n            const modalHtml = `\n                <div class=\"detailed-usage-modal\" style=\"font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;\">\n                    <!-- Header with close button -->\n                    <div class=\"usage-modal-header mb-3\" style=\"background: linear-gradient(135deg, #0f6cbf 0%, #3a8dd4 100%); padding: 16px 20px; border-radius: 10px; color: white; box-shadow: 0 2px 8px rgba(0,0,0,0.1);\">\n                        <div class=\"d-flex justify-content-between align-items-center\">\n                            <h5 class=\"mb-0\" style=\"color: white; font-weight: 600;\">\n                                <i class=\"fas fa-chart-line me-2\"></i> Token Usage Dashboard\n                            </h5>\n                            <button type=\"button\" class=\"usage-modal-close-btn\" onclick=\"Swal.close()\" style=\"background: rgba(255,255,255,0.2); border: none; color: white; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s ease;\">\n                                <i class=\"fas fa-times\" style=\"font-size: 14px;\"></i>\n                            </button>\n                        </div>\n                    </div>\n\n                    <!-- Summary Cards with proper spacing -->\n                    <div class=\"row mb-3 g-2\">\n                        <div class=\"col-md-3\">\n                            <div class=\"card border-0 h-100\" style=\"background: linear-gradient(135deg, #0ea5e9 0%, #2563eb 100%); color: white; border-radius: 12px; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);\">\n                                <div class=\"card-body text-center\" style=\"padding: 16px 12px;\">\n                                    <h6 class=\"card-title mb-2\" style=\"font-weight: 600; opacity: 0.9; font-size: 0.85rem;\">Monthly Usage</h6>\n                                    <div class=\"d-flex align-items-center justify-content-center mb-2\">\n                                        <i class=\"fas fa-chart-pie me-2\" style=\"opacity: 0.8; font-size: 1.2rem;\"></i>\n                                        <span style=\"font-weight: 700; font-size: 1.5rem;\">${usagePercent}%</span>\n                                    </div>\n                                    <small style=\"opacity: 0.8; font-size: 0.75rem;\">${formatTokens(summary.total_tokens_used)} / ${limitDisplay}</small>\n                                </div>\n                            </div>\n                        </div>\n                        <div class=\"col-md-3\">\n                            <div class=\"card border-0 h-100\" style=\"background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; border-radius: 12px; box-shadow: 0 4px 12px rgba(17, 153, 142, 0.2);\">\n                                <div class=\"card-body text-center\" style=\"padding: 16px 12px;\">\n                                    <h6 class=\"card-title mb-2\" style=\"font-weight: 600; opacity: 0.9; font-size: 0.85rem;\">Tokens Used</h6>\n                                    <div class=\"d-flex align-items-center justify-content-center mb-2\">\n                                        <i class=\"fas fa-code me-2\" style=\"opacity: 0.8; font-size: 1.2rem;\"></i>\n                                        <span style=\"font-weight: 700; font-size: 1.5rem;\">${formatTokens(summary.total_tokens_used)}</span>\n                                    </div>\n                                    <small style=\"opacity: 0.8; font-size: 0.75rem;\">This Billing Period</small>\n                                </div>\n                            </div>\n                        </div>\n                        <div class=\"col-md-3\">\n                            <div class=\"card border-0 h-100\" style=\"background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; border-radius: 12px; box-shadow: 0 4px 12px rgba(240, 147, 251, 0.2);\">\n                                <div class=\"card-body text-center\" style=\"padding: 16px 12px;\">\n                                    <h6 class=\"card-title mb-2\" style=\"font-weight: 600; opacity: 0.9; font-size: 0.85rem;\">Total Requests</h6>\n                                    <div class=\"d-flex align-items-center justify-content-center mb-2\">\n                                        <i class=\"fas fa-paper-plane me-2\" style=\"opacity: 0.8; font-size: 1.2rem;\"></i>\n                                        <span style=\"font-weight: 700; font-size: 1.5rem;\">${summary.total_requests}</span>\n                                    </div>\n                                    <small style=\"opacity: 0.8; font-size: 0.75rem;\">Messages Processed</small>\n                                </div>\n                            </div>\n                        </div>\n                        <div class=\"col-md-3\">\n                            <div class=\"card border-0 h-100\" style=\"background: linear-gradient(135deg, #ff6b6b 0%, #ffa500 100%); color: white; border-radius: 12px; box-shadow: 0 4px 12px rgba(255, 107, 107, 0.2);\">\n                                <div class=\"card-body text-center\" style=\"padding: 16px 12px;\">\n                                    <h6 class=\"card-title mb-2\" style=\"font-weight: 600; opacity: 0.9; font-size: 0.85rem;\">Today's Tokens</h6>\n                                    <div class=\"d-flex align-items-center justify-content-center mb-2\">\n                                        <i class=\"fas fa-calendar-day me-2\" style=\"opacity: 0.8; font-size: 1.2rem;\"></i>\n                                        <span style=\"font-weight: 700; font-size: 1.5rem;\">${formatTokens(summary.today_tokens_used || 0)}</span>\n                                    </div>\n                                    <small style=\"opacity: 0.8; font-size: 0.75rem;\">Tokens Used Today</small>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n\n                    <!-- Compact Data Table -->\n                    <div class=\"card border-0\" style=\"border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.06);\">\n                        <div class=\"card-header\" style=\"background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-radius: 12px 12px 0 0; border: none; padding: 12px 16px;\">\n                            <div class=\"d-flex justify-content-between align-items-center\">\n                                <h6 class=\"mb-0\" style=\"font-weight: 600; color: #333;\">\n                                    Detailed Usage History\n                                </h6>\n                                <span class=\"badge bg-primary\" style=\"font-size: 0.7rem; padding: 4px 8px; border-radius: 12px; color: white; background: linear-gradient(135deg, #0ea5e9 0%, #2563eb 100%);\">\n                                    ${usage.length} of ${pagination.total} records\n                                </span>\n                            </div>\n                        </div>\n                        <div class=\"card-body p-0\">\n                            <div class=\"table-responsive\">\n                                <table id=\"usage-datatable\" class=\"table table-hover mb-0\" style=\"font-size: 0.9rem;\">\n                                    <thead style=\"background: linear-gradient(135deg, #0ea5e9 0%, #2563eb 100%); color: white;\">\n                                        <tr>\n                                            <th style=\"border: none; padding: 15px 12px; font-weight: 600; text-align: center;\">Date</th>\n                                            <th style=\"border: none; padding: 15px 12px; font-weight: 600; text-align: center;\">Action</th>\n                                            <th style=\"border: none; padding: 15px 12px; font-weight: 600; text-align: center;\">Model</th>\n                                            <th style=\"border: none; padding: 15px 12px; font-weight: 600; text-align: center;\">Input</th>\n                                            <th style=\"border: none; padding: 15px 12px; font-weight: 600; text-align: center;\">Output</th>\n                                            <th style=\"border: none; padding: 15px 12px; font-weight: 600; text-align: center;\">Total Tokens</th>\n                                        </tr>\n                                    </thead>\n                                    <tbody>\n                                        ${usage.length > 0 ? usage.map(item => `\n                                            <tr style=\"border-bottom: 1px solid #f8f9fa;\">\n                                                <td style=\"padding: 12px; vertical-align: middle; font-weight: 500;\">\n                                                    ${(() => {\n                                                        const d = new Date(item.created_at);\n                                                        const day = d.getDate();\n                                                        const month = d.toLocaleString('en-US', { month: 'short' });\n                                                        const year = d.getFullYear();\n                                                        const hours = d.getHours().toString().padStart(2, '0');\n                                                        const minutes = d.getMinutes().toString().padStart(2, '0');\n                                                        return `${day} ${month} ${year} - ${hours}:${minutes}`;\n                                                    })()}\n                                                </td>\n                                                <td style=\"padding: 12px; vertical-align: middle;\">\n                                                    <span class=\"badge ${item.action_type === 'report_generation' ? 'bg-primary' : item.action_type === 'mcq_generation' ? 'bg-warning' : 'bg-success'}\" style=\"border-radius: 20px; padding: 6px 12px; font-weight: 500;\">\n                                                        <i class=\"fas ${item.action_type === 'report_generation' ? 'fa-file-alt' : item.action_type === 'mcq_generation' ? 'fa-question-circle' : 'fa-comment'} me-1\"></i>\n                                                        ${item.action_type.replace('_', ' ')}\n                                                    </span>\n                                                </td>\n                                                <td style=\"padding: 12px; vertical-align: middle;\">\n                                                    <span class=\"badge bg-light text-dark\" style=\"border-radius: 20px; padding: 4px 8px;\">\n                                                        ${item.model || 'N/A'}\n                                                    </span>\n                                                </td>\n                                                <td style=\"padding: 12px; vertical-align: middle; font-weight: 500; color: #11998e;\">${(item.prompt_tokens || 0).toLocaleString()}</td>\n                                                <td style=\"padding: 12px; vertical-align: middle; font-weight: 500; color: #f5576c;\">${(item.completion_tokens || 0).toLocaleString()}</td>\n                                                <td style=\"padding: 12px; vertical-align: middle; font-weight: 600; color: #667eea;\">${(item.tokens_used || 0).toLocaleString()}</td>\n                                            </tr>\n                                        `).join('') : `\n                                            <tr>\n                                                <td colspan=\"6\" style=\"padding: 40px; text-align: center;\">\n                                                    <div style=\"color: #6c757d;\">\n                                                        <i class=\"fas fa-inbox fa-3x mb-3\" style=\"opacity: 0.5;\"></i>\n                                                        <h5 style=\"font-weight: 600; margin-bottom: 10px;\">No Usage Data Yet</h5>\n                                                        <p style=\"margin: 0; font-size: 0.9rem;\">Start using the AI Assistant to generate reports and your usage history will appear here.</p>\n                                                    </div>\n                                                </td>\n                                            </tr>\n                                        `}\n                                    </tbody>\n                                </table>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n            `;\n\n            Swal.fire({\n                html: modalHtml,\n                width: '80%',\n                showConfirmButton: false,\n                showCancelButton: false,\n                showCloseButton: false,\n                allowOutsideClick: true,\n                customClass: {\n                    popup: 'usage-modal-popup',\n                    htmlContainer: 'usage-modal-container'\n                },\n                didOpen: () => {\n                    // Add hover effect to close button\n                    const closeBtn = document.querySelector('.usage-modal-close-btn');\n                    if (closeBtn) {\n                        closeBtn.addEventListener('mouseenter', () => {\n                            closeBtn.style.background = 'rgba(255,255,255,0.3)';\n                        });\n                        closeBtn.addEventListener('mouseleave', () => {\n                            closeBtn.style.background = 'rgba(255,255,255,0.2)';\n                        });\n                    }\n                    this.setupUsageModalEventListeners(data);\n                }\n            });\n        },\n\n        setupUsageModalEventListeners: function (data) {\n            const self = this;\n            let currentFilters = data.filters;\n            self.usageDataTable = null;\n\n            // Initialize Simple DataTable using the same library as reports table\n            setTimeout(() => {\n                // Check if simpleDatatables is available\n                if (typeof simpleDatatables === 'undefined' || !simpleDatatables.DataTable) {\n                    console.error('simpleDatatables library not available');\n                    return;\n                }\n                \n                // Check if table exists\n                if (!$('#usage-datatable').length) {\n                    console.error('Usage datatable element not found');\n                    return;\n                }\n                \n                try {\n                    \n                    // Check if table has data before initializing\n                    const tableElement = document.getElementById('usage-datatable');\n                    if (tableElement) {\n                        const tbody = tableElement.querySelector('tbody');\n                        const hasData = tbody && tbody.rows.length > 0;\n                        \n                        if (hasData) {\n                            self.usageDataTable = new simpleDatatables.DataTable(\"#usage-datatable\", {\n                                searchable: true,\n                                fixedHeight: false,\n                                perPage: 25,\n                                perPageSelect: [10, 25, 50, 100],\n                                sortable: true,\n                                labels: {\n                                    placeholder: \"Search usage history...\",\n                                    noRows: \"No usage data found\",\n                                    info: \"Showing {start} to {end} of {rows} entries\"\n                                }\n                            });\n                            \n                        } else {\n                        }\n                    }\n                } catch (error) {\n                    console.error('Error initializing Simple DataTable:', error);\n                    console.error('Error details:', error.message, error.stack);\n                }\n            }, 500);\n\n            // Apply filters button\n            $('#apply-filters').on('click', function() {\n                const userId = $('#user-filter').val();\n                const creditType = $('#credit-type-filter').val();\n                const startDate = $('#start-date-filter').val();\n                const endDate = $('#end-date-filter').val();\n\n                currentFilters = {\n                    user_id: userId,\n                    credit_type: creditType,\n                    start_date: startDate,\n                    end_date: endDate\n                };\n\n                self.loadUsageDataWithFilters(currentFilters, 1);\n            });\n\n            // Clear filters button\n            $('#clear-filters').on('click', function() {\n                $('#user-filter').val('');\n                $('#credit-type-filter').val('');\n                $('#start-date-filter').val('');\n                $('#end-date-filter').val('');\n                \n                currentFilters = {};\n                self.loadUsageDataWithFilters({}, 1);\n            });\n\n            // Quick filter buttons\n            $('.quick-filter').on('click', function() {\n                const period = $(this).data('period');\n                const today = new Date();\n                let startDate = '';\n                let endDate = today.toISOString().split('T')[0];\n                \n                switch(period) {\n                    case 'today':\n                        startDate = endDate;\n                        break;\n                    case 'week':\n                        const weekAgo = new Date(today);\n                        weekAgo.setDate(today.getDate() - 7);\n                        startDate = weekAgo.toISOString().split('T')[0];\n                        break;\n                    case 'month':\n                        const monthAgo = new Date(today);\n                        monthAgo.setMonth(today.getMonth() - 1);\n                        startDate = monthAgo.toISOString().split('T')[0];\n                        break;\n                }\n                \n                // Update date inputs\n                $('#start-date-filter').val(startDate);\n                $('#end-date-filter').val(endDate);\n                \n                // Apply filters automatically\n                currentFilters = {\n                    user_id: $('#user-filter').val(),\n                    credit_type: $('#credit-type-filter').val(),\n                    start_date: startDate,\n                    end_date: endDate\n                };\n                \n                self.loadUsageDataWithFilters(currentFilters, 1);\n            });\n        },\n\n        loadUsageDataWithFilters: function(filters, page = 1) {\n            // Show loading\n            Swal.fire({\n                title: 'Loading...',\n                text: 'Applying filters and loading data',\n                allowOutsideClick: false,\n                showConfirmButton: false,\n                willOpen: () => {\n                    Swal.showLoading();\n                }\n            });\n\n            // Build query string\n            const params = new URLSearchParams();\n            if (filters.user_id) params.append('user_id', filters.user_id);\n            if (filters.credit_type) params.append('credit_type', filters.credit_type);\n            if (filters.start_date) params.append('start_date', filters.start_date);\n            if (filters.end_date) params.append('end_date', filters.end_date);\n            params.append('page', page);\n            params.append('per_page', 1000); // Get more data for DataTable\n\n            this.ajaxWithAuth({\n                url: `https://a360backend.stagingwithswift.com/api/v1/chat/credits/detailed-usage?${params.toString()}`,\n                method: 'GET',\n                success: (response) => {\n                    if (response.success) {\n                        this.updateUsageModalData(response.data);\n                    } else {\n                        Swal.fire('Error', 'Failed to load filtered data', 'error');\n                    }\n                },\n                error: () => {\n                    Swal.fire('Error', 'Failed to load filtered data', 'error');\n                }\n            });\n        },\n\n        updateUsageModalData: function(data) {\n            const summary = data.summary;\n            const usage = data.usage;\n\n            // Update summary cards\n            $('.detailed-usage-modal .card h2').eq(0).text(summary.total_credits_used);\n            $('.detailed-usage-modal .card h2').eq(1).text(summary.total_tokens_used.toLocaleString());\n            $('.detailed-usage-modal .card h2').eq(2).text(summary.total_requests);\n            $('.detailed-usage-modal .card h2').eq(3).text(summary.unique_users);\n            $('.detailed-usage-modal .card h3').eq(0).text(summary.premium_credits);\n            $('.detailed-usage-modal .card h3').eq(1).text(summary.basic_credits);\n\n            // Update record count badge\n            $('.detailed-usage-modal .badge.bg-primary').text(`${usage.length} of ${data.pagination.total} records`);\n\n            // Clear and rebuild table data\n            const tableBody = $('#usage-datatable tbody');\n            tableBody.empty();\n\n            usage.forEach(item => {\n                const row = `\n                    <tr style=\"border-bottom: 1px solid #f8f9fa;\">\n                        <td style=\"padding: 12px; vertical-align: middle; font-weight: 500;\">${new Date(item.created_at).toLocaleDateString()}</td>\n                        <td style=\"padding: 12px; vertical-align: middle;\">\n                            <span class=\"badge bg-light text-dark\" style=\"border-radius: 20px; padding: 4px 8px;\">\n                                ${item.user_id || 'N/A'}\n                            </span>\n                        </td>\n                        <td style=\"padding: 12px; vertical-align: middle;\">\n                            <span class=\"badge ${item.credit_type === 'premium' ? 'bg-primary' : 'bg-success'}\" style=\"border-radius: 20px; padding: 6px 12px; font-weight: 500;\">\n                                <i class=\"fas ${item.credit_type === 'premium' ? 'fa-crown' : 'fa-layer-group'} me-1\"></i>\n                                ${item.credit_type}\n                            </span>\n                        </td>\n                        <td style=\"padding: 12px; vertical-align: middle; font-weight: 600; color: #667eea;\">${item.credits_charged}</td>\n                        <td style=\"padding: 12px; vertical-align: middle; font-weight: 500;\">${item.tokens_used.toLocaleString()}</td>\n                        <td style=\"padding: 12px; vertical-align: middle;\">\n                            <span class=\"badge bg-info text-white\" style=\"border-radius: 20px; padding: 4px 8px;\">\n                                ${item.llm_provider}\n                            </span>\n                        </td>\n                        <td style=\"padding: 12px; vertical-align: middle; max-width: 200px;\">\n                            <div style=\"overflow: hidden; text-overflow: ellipsis; white-space: nowrap;\" title=\"${item.message_preview || 'No message'}\">\n                                ${item.message_preview ? item.message_preview.substring(0, 50) + '...' : 'N/A'}\n                            </div>\n                        </td>\n                    </tr>\n                `;\n                tableBody.append(row);\n            });\n\n        // Update Simple DataTable if it exists\n        if (this.usageDataTable && typeof this.usageDataTable.refresh === 'function') {\n            try {\n                this.usageDataTable.refresh();\n            } catch (error) {\n                console.error('Error refreshing Simple DataTable:', error);\n            }\n        } else {\n            }\n        },\n\n        updateReportData: function (data) {\n            const table = $('#report-table');\n            table.empty();\n\n            // Add headers\n            const thead = $('<thead><tr></tr></thead>');\n            data.columns.forEach(column => {\n                thead.find('tr').append(`<th>${column}</th>`);\n            });\n            table.append(thead);\n\n            // Add rows\n            const tbody = $('<tbody></tbody>');\n            data.rows.forEach(row => {\n                const tr = $('<tr></tr>');\n                row.forEach(cell => {\n                    tr.append(`<td>${cell}</td>`);\n                });\n                tbody.append(tr);\n            });\n            table.append(tbody);\n        },\n\n        updateVisualizations: function (visualizations) {\n            const container = $('#chart-container');\n            container.empty();\n\n            // Create canvas for chart\n            const canvas = $('<canvas></canvas>');\n            container.append(canvas);\n\n            // Get chart type\n            const type = $('#chart-type').val();\n\n            // Create chart\n            new Chart(canvas[0], {\n                type: type,\n                data: {\n                    labels: visualizations.labels,\n                    datasets: visualizations.datasets.map(dataset => ({\n                        label: dataset.label,\n                        data: dataset.data,\n                        backgroundColor: dataset.backgroundColor,\n                        borderColor: dataset.borderColor,\n                        borderWidth: 1\n                    }))\n                },\n                options: {\n                    responsive: true,\n                    maintainAspectRatio: false,\n                    plugins: {\n                        legend: {\n                            position: 'top'\n                        },\n                        title: {\n                            display: true,\n                            text: visualizations.title\n                        }\n                    }\n                }\n            });\n        },\n\n        /**\n         * Detect numeric columns in data\n         */\n        detectNumericColumns: function(data, headers) {\n            if (!data || data.length === 0) return [];\n            return headers.filter(header => {\n                let numericCount = 0;\n                const sampleSize = Math.min(data.length, 20);\n                for (let i = 0; i < sampleSize; i++) {\n                    const val = data[i][header];\n                    if (val !== null && val !== undefined && val !== '') {\n                        const num = parseFloat(val);\n                        if (!isNaN(num) && isFinite(num)) {\n                            numericCount++;\n                        }\n                    }\n                }\n                return numericCount >= sampleSize * 0.5;\n            });\n        },\n\n        /**\n         * Generate chart colors\n         */\n        generateChartColors: function(count) {\n            const baseColors = [\n                '#2563eb', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6',\n                '#06b6d4', '#ec4899', '#84cc16', '#f97316', '#6366f1',\n                '#14b8a6', '#a855f7', '#eab308', '#22c55e', '#3b82f6'\n            ];\n            const colors = [];\n            for (let i = 0; i < count; i++) {\n                colors.push(baseColors[i % baseColors.length]);\n            }\n            return colors;\n        },\n\n        /**\n         * Create chart configuration\n         */\n        createReportChartConfig: function(chartType, labels, values, valueKey, colors, reportName) {\n            const baseConfig = {\n                responsive: true,\n                maintainAspectRatio: false,\n                plugins: {\n                    title: {\n                        display: true,\n                        text: reportName || 'Report Chart',\n                        font: { size: 16, weight: 'bold' },\n                        padding: { top: 10, bottom: 20 }\n                    },\n                    legend: {\n                        display: chartType === 'pie' || chartType === 'doughnut',\n                        position: 'right'\n                    }\n                }\n            };\n\n            if (chartType === 'pie' || chartType === 'doughnut') {\n                return {\n                    type: chartType,\n                    data: {\n                        labels: labels,\n                        datasets: [{\n                            data: values,\n                            backgroundColor: colors,\n                            borderColor: '#fff',\n                            borderWidth: 2\n                        }]\n                    },\n                    options: baseConfig\n                };\n            } else if (chartType === 'line') {\n                return {\n                    type: 'line',\n                    data: {\n                        labels: labels,\n                        datasets: [{\n                            label: valueKey,\n                            data: values,\n                            borderColor: colors[0],\n                            backgroundColor: colors[0] + '40',\n                            borderWidth: 3,\n                            fill: true,\n                            tension: 0.4\n                        }]\n                    },\n                    options: {\n                        ...baseConfig,\n                        scales: {\n                            y: { beginAtZero: true },\n                            x: { ticks: { maxRotation: 45, minRotation: 45 } }\n                        }\n                    }\n                };\n            } else {\n                // Bar chart (default)\n                return {\n                    type: 'bar',\n                    data: {\n                        labels: labels,\n                        datasets: [{\n                            label: valueKey,\n                            data: values,\n                            backgroundColor: colors,\n                            borderColor: colors,\n                            borderWidth: 1\n                        }]\n                    },\n                    options: {\n                        ...baseConfig,\n                        scales: {\n                            y: { beginAtZero: true },\n                            x: { ticks: { maxRotation: 45, minRotation: 45 } }\n                        }\n                    }\n                };\n            }\n        },\n\n        /**\n         * Render report chart with current settings\n         */\n        renderReportChartFromSelectors: function(data, reportName) {\n            const self = this;\n            if (!data || data.length === 0) return;\n\n            const chartType = $('#report-chart-type').val() || 'bar';\n            const labelKey = $('#report-chart-x-axis').val();\n            const valueKey = $('#report-chart-y-axis').val();\n\n            if (!labelKey || !valueKey) return;\n\n            const valueKeyFormatted = valueKey.replace(/_/g, ' ').replace(/\\b\\w/g, l => l.toUpperCase());\n\n            // Limit data for chart (max 50 items for readability)\n            const chartData = data.slice(0, 50);\n            const labels = chartData.map(r => {\n                const label = r[labelKey];\n                if (label === null || label === undefined) return 'Unknown';\n                const labelStr = String(label);\n                return labelStr.length > 30 ? labelStr.substring(0, 30) + '...' : labelStr;\n            });\n            const values = chartData.map(r => parseFloat(r[valueKey]) || 0);\n            const colors = this.generateChartColors(values.length);\n\n            const chartConfig = this.createReportChartConfig(chartType, labels, values, valueKeyFormatted, colors, reportName);\n\n            const chartEl = document.getElementById('reportChart');\n            if (!chartEl) return;\n\n            if (self.reportChartInstance) {\n                self.reportChartInstance.destroy();\n            }\n\n            try {\n                self.reportChartInstance = new Chart(chartEl.getContext('2d'), chartConfig);\n            } catch (error) {\n                console.error('Error creating chart:', error);\n            }\n        },\n\n        showLoading: function () {\n            // Remove any existing loader first (use wrapper class for complete cleanup)\n            $('.ai-thinking-loader-wrapper').remove();\n\n            // Track when loader was shown for minimum display time\n            this.loaderShownAt = Date.now();\n            // Create the loader element with proper message wrapper structure\n            const loaderHtml = `\n                <div class=\"message-wrapper ai-message-wrapper ai-thinking-loader-wrapper\" style=\"margin: 10px 0;\">\n                    <div class=\"message ai-message ai-thinking-loader\" style=\"\n                        max-width: 70%;\n                        margin-left: 20px;\n                        padding: 15px 20px;\n                        background: linear-gradient(135deg, #f0f4f8 0%, #e9ecef 100%);\n                        border-radius: 18px 18px 18px 4px;\n                        box-shadow: 0 2px 8px rgba(0,0,0,0.08);\n                        display: flex;\n                        align-items: center;\n                        gap: 12px;\n                    \">\n                        <div class=\"ai-avatar-loader\" style=\"\n                            padding: 8px 12px;\n                            background: linear-gradient(135deg, #0ea5e9 0%, #2563eb 100%);\n                            border-radius: 20px;\n                            display: flex;\n                            align-items: center;\n                            justify-content: center;\n                            color: white;\n                            font-weight: 600;\n                            font-size: 13px;\n                            flex-shrink: 0;\n                            animation: pulse-glow-loader 2s infinite;\n                            font-family: system-ui, -apple-system, sans-serif;\n                            letter-spacing: 0.5px;\n                        \">Adeptus AI</div>\n                        <div class=\"thinking-dots\" style=\"\n                            display: flex;\n                            align-items: center;\n                            gap: 4px;\n                        \">\n                            <span class=\"thinking-text\" style=\"\n                                color: #6c757d;\n                                font-size: 14px;\n                                margin-right: 8px;\n                                font-style: italic;\n                            \">Thinking</span>\n                            <span class=\"dot dot-1\" style=\"\n                                width: 8px;\n                                height: 8px;\n                                border-radius: 50%;\n                                background: #0ea5e9;\n                                display: inline-block;\n                                animation: bounce-loader 1.4s infinite ease-in-out both;\n                                animation-delay: -0.32s;\n                            \"></span>\n                            <span class=\"dot dot-2\" style=\"\n                                width: 8px;\n                                height: 8px;\n                                border-radius: 50%;\n                                background: #2563eb;\n                                display: inline-block;\n                                animation: bounce-loader 1.4s infinite ease-in-out both;\n                                animation-delay: -0.16s;\n                            \"></span>\n                            <span class=\"dot dot-3\" style=\"\n                                width: 8px;\n                                height: 8px;\n                                border-radius: 50%;\n                                background: #0ea5e9;\n                                display: inline-block;\n                                animation: bounce-loader 1.4s infinite ease-in-out both;\n                            \"></span>\n                        </div>\n                    </div>\n                </div>\n            `;\n\n            // Add the loader to chat container\n            const $chatContainer = $('#chat-container');\n            if ($chatContainer.length > 0) {\n                $chatContainer.append(loaderHtml);\n\n                // Scroll to bottom immediately to show the loader\n                this.scrollToBottom();\n            }\n        },\n\n        hideLoading: function () {\n            // Calculate how long the loader has been shown\n            const loaderShownDuration = this.loaderShownAt ? Date.now() - this.loaderShownAt : 0;\n            const minimumDisplayTime = 800; // Minimum 800ms display time\n            const remainingTime = Math.max(0, minimumDisplayTime - loaderShownDuration);\n\n            // Delay removal to ensure minimum display time\n            setTimeout(() => {\n                // Remove the thinking loader wrapper with fade animation\n                $('.ai-thinking-loader-wrapper').fadeOut(200, function() {\n                    $(this).remove();\n                });\n                // Also remove just the loader element if wrapper doesn't exist\n                $('.ai-thinking-loader').fadeOut(200, function() {\n                    $(this).remove();\n                });\n                // Also hide the old loading indicator if it exists\n                $('#loading-indicator').addClass('d-none');\n            }, remainingTime);\n        },\n\n        showError: function (message) {\n            const errorDiv = $('#error-message');\n            $('#error-text').text(message);\n            errorDiv.removeClass('d-none');\n\n            // Auto-hide after 5 seconds\n            setTimeout(() => {\n                errorDiv.addClass('d-none');\n            }, 5000);\n        },\n\n        showSuccess: function (message) {\n            // Create success alert if it doesn't exist\n            if ($('#success-message').length === 0) {\n                const successHtml = `\n                    <div class=\"alert alert-success alert-dismissible fade show d-none\" role=\"alert\" id=\"success-message\" style=\"position:fixed; top:20px; right:20px; z-index:1050;\">\n                        <i class=\"fa fa-check-circle me-2\"></i>\n                        <span id=\"success-text\"></span>\n                        <button type=\"button\" class=\"btn-close\" data-bs-dismiss=\"alert\" aria-label=\"Close\"></button>\n                    </div>\n                `;\n                $('body').append(successHtml);\n            }\n            \n            const successDiv = $('#success-message');\n            $('#success-text').text(message);\n            successDiv.removeClass('d-none');\n\n            // Auto-hide after 3 seconds\n            setTimeout(() => {\n                successDiv.addClass('d-none');\n            }, 3000);\n        },\n\n        scrollToBottom: function () {\n            const container = $('#chat-container');\n            container.scrollTop(container[0].scrollHeight);\n        },\n\n        /**\n         * Fetch chat history, show spinner, then render list or \"No chats\"\n         */\n        loadChatHistory: function () {\n            const list = $('#chat-history-list');\n\n            // Show loading spinner\n            list.html(`\n                <li class=\"list-group-item d-flex justify-content-center\" id=\"chat-history-loading\">\n                    <div class=\"spinner-border text-secondary\" role=\"status\">\n                        <span class=\"sr-only\">Loading...</span>\n                    </div>\n                </li>\n            `);\n\n            this.ajaxWithAuth({\n                url: 'https://a360backend.stagingwithswift.com/api/v1/chat/history',\n                method: 'GET',\n                success: (response) => {\n                    list.empty();\n\n                    // Ensure response has chats array\n                    if (!response || !response.chats || !Array.isArray(response.chats)) {\n                        list.append(`\n                            <li class=\"list-group-item text-center\">\n                                <div class=\"text-muted\">\n                                    <i class=\"fa fa-comments fa-2x mb-2\"></i>\n                                    <p class=\"mb-1\">No chat history available</p>\n                                    <small>Start a conversation to see your chat history here</small>\n                                </div>\n                            </li>\n                        `);\n                        return;\n                    }\n\n                    if (!response.chats.length) {\n                        // Check if we also have no reports\n                        const authStatus = AuthUtils.getAuthStatus();\n                        const hasReports = authStatus && authStatus.subscription && \n                            authStatus.subscription.reports_generated_this_month > 0;\n                        \n                        if (!hasReports) {\n                            list.append(`\n                                <li class=\"list-group-item text-center\">\n                                    <div class=\"text-muted\">\n                                        <i class=\"fa fa-comments fa-2x mb-2\"></i>\n                                        <p class=\"mb-1\">No chat history yet</p>\n                                        <small>Start a conversation to see your chat history here</small>\n                                    </div>\n                                </li>\n                            `);\n\n                            // Show welcome message in chat container when no history exists\n                            if ($('#chat-container').children().length === 0) {\n                                this.showWelcomeMessage();\n                            }\n                        } else {\n                            list.append(`<li class=\"list-group-item text-center\">No chats yet</li>`);\n                        }\n                    } else {\n                        response.chats.forEach((chat) => {\n                            // Safely handle date with fallback\n                            const date = chat.created_at ? new Date(chat.created_at).toLocaleString() : 'Unknown date';\n\n                            // Map backend field names to frontend expected names\n                            // Backend returns: title, last_message, message_count\n                            // Frontend expects: snippet or first_message\n                            // Prefer last_message as it contains actual content, title is often \"New Chat\"\n                            const snippet = chat.last_message || chat.title || chat.snippet || chat.first_message || 'Chat session';\n\n                            // Safely handle report count\n                            const reportCount = chat.report_count || 0;\n                            const badgeHtml = reportCount > 0\n                                ? `<span class=\"badge bg-primary d-flex align-items-center report-count\"><i class=\"fa fa-chart-bar me-1\"></i>${reportCount}</span>`\n                                : '';\n\n                            // Only create item if we have a valid chat ID\n                            if (chat.id) {\n                                const item = $(`\n                                    <li class=\"list-group-item d-flex justify-content-between align-items-start chat-history-item\" data-chat-id=\"${chat.id}\">\n                                        <div>\n                                            <small class=\"text-muted\">${date}</small><br>\n                                            ${snippet}\n                                        </div>\n                                        ${badgeHtml}\n                                    </li>\n                                `);\n                                list.append(item);  // Changed from prepend to append - backend already returns newest first\n                            }\n                        });\n\n                        // Set up click handlers\n                        $('.chat-history-item').on('click', (e) => {\n                            const li = $(e.currentTarget);\n                            const chatId = li.data('chat-id');\n                            this.loadChatMessages(chatId, li);\n                        });\n\n                        // Don't auto-load any chat - show welcome message on initial page load\n                        // Only show welcome message if chat container is empty\n                        if (this.currentChatId === 0 && $('#chat-container').children().length === 0) {\n                            this.showWelcomeMessage();\n                        }\n                    }\n                },\n                error: (xhr, status, error) => {\n                    console.error('[Chat History] Failed to load:', error);\n                    list.html(`\n                        <li class=\"list-group-item text-center\">\n                            <div class=\"text-danger\">\n                                <i class=\"fa fa-exclamation-triangle fa-2x mb-2\"></i>\n                                <p class=\"mb-2\">Failed to load chat history</p>\n                                <button id=\"reload-chat-history\" class=\"btn btn-outline-primary btn-sm\">\n                                    <i class=\"fa fa-refresh\"></i> Try Again\n                                </button>\n                            </div>\n                        </li>\n                    `);\n                    $('#reload-chat-history').on('click', () => this.loadChatHistory());\n                }\n            });\n        },\n\n        /**\n         * Load a specific chat's messages, highlight the selected item\n         */\n        loadChatMessages: function (chatId, listItem) {\n            this.currentChatId = chatId;\n            $('#chat-history-list li').removeClass('active');\n            listItem.addClass('active');\n            $('#chat-container').empty();\n            this.clearMCQ(); // Clear and hide MCQ container when loading different chat\n            this.showLoading();\n\n            const messageUrl = `https://a360backend.stagingwithswift.com/api/v1/chat/${chatId}/messages`;\n\n            this.ajaxWithAuth({\n                url: messageUrl,\n                method: 'GET',\n                success: (response) => {\n                    this.hideLoading();\n                    \n                    // Check for credit limit information in response and update button state\n                    if (response.credit_data && response.credit_data.summary) {\n                        this.updateSubscriptionDataFromCreditResponse(response.credit_data);\n                    }\n                    \n                    // Always check current subscription status and update button state\n                    const authStatus = AuthUtils.getAuthStatus();\n                    if (authStatus && authStatus.subscription) {\n                        this.checkAndShowCreditLimitWarning(authStatus.subscription);\n                    }\n                    \n                    // Render chat messages with message IDs, filtering out SQL-tagged messages and passing timestamp\n                    response.messages.forEach((msg, idx) => {\n                        // Map backend field names to frontend expected names\n                        msg.sender_type = msg.role || msg.sender_type;  // Backend uses 'role', frontend expects 'sender_type'\n                        msg.body = msg.content || msg.body;              // Backend uses 'content', frontend expects 'body'\n                        msg.timestamp = msg.created_at || msg.timestamp; // Backend uses 'created_at', frontend expects 'timestamp'\n\n                        // Convert 'ai' role to 'ai' sender_type if needed\n                        if (msg.sender_type === 'assistant') {\n                            msg.sender_type = 'ai';\n                        }\n\n                        if (msg.tag === 'sql') {\n                            return;\n                        }\n                        \n                        // Check if this is an MCQ message followed by a user answer\n                        if (msg.sender_type === 'ai' && msg.tag === 'mcq') {\n                            // Look for the next user message as the selected answer\n                            const nextMsg = response.messages[idx + 1];\n                            const selectedAnswer = (nextMsg && nextMsg.sender_type === 'user') ? nextMsg.body : null;\n                            \n                            // Extract MCQ data and render with selected answer\n                            const mcqData = this.extractMCQFromText(msg.body);\n                            if (mcqData && mcqData.questions.length > 0) {\n                                mcqData.selectedAnswer = selectedAnswer;\n                                const mcqHtml = this.renderMCQHistory(mcqData.questions, selectedAnswer);\n                                \n                                // Add as AI message with MCQ HTML\n                                const template = document.getElementById('message-template');\n                                const frag = template.content.cloneNode(true);\n                                const messageEl = frag.querySelector('.message');\n                                messageEl.classList.add('ai-message');\n                                messageEl.setAttribute('data-message-id', msg.id);\n                                frag.querySelector('.message-text').innerHTML = mcqHtml;\n                                frag.querySelector('.message-time').textContent = this.formatTimestamp(msg.timestamp);\n                                $('#chat-container').append(frag);\n                                return; // Skip the normal addMessage call\n                            }\n                        }\n                        \n                        // Skip rendering the user's MCQ answer separately if it was already shown in the MCQ\n                        if (msg.sender_type === 'user' && idx > 0) {\n                            const prevMsg = response.messages[idx - 1];\n                            if (prevMsg && prevMsg.sender_type === 'ai' && prevMsg.tag === 'mcq') {\n                                // This is the MCQ answer, already rendered in the MCQ view above\n                                return;\n                            }\n                        }\n\n                        // Check if this is a report message\n                        // Check both metadata and message content pattern for backward compatibility\n                        const isReportMessage = (msg.metadata && msg.metadata.type === 'report') ||\n                                               (msg.body && msg.body.startsWith('ðŸ“Š Report saved:'));\n\n                        if (isReportMessage) {\n                            // Extract report info from message if metadata is missing\n                            if (!msg.metadata && msg.body) {\n                                // Parse report name from message like \"ðŸ“Š Report saved: Daily Login Activity\"\n                                const reportNameMatch = msg.body.match(/ðŸ“Š Report saved: (.+)/);\n                                const reportName = reportNameMatch ? reportNameMatch[1] : 'Report';\n\n                                // Try to guess slug from report name\n                                const reportSlug = reportName.toLowerCase()\n                                    .replace(/\\s+/g, '-')\n                                    .replace(/[^a-z0-9-]/g, '');\n\n                                msg.metadata = {\n                                    type: 'report',\n                                    report_name: reportName,\n                                    report_slug: reportSlug\n                                };\n                            }\n                            // Display as a report link\n                            this.displayReportLink(msg);\n                        } else {\n                            this.addMessage(msg.body, msg.sender_type, false, null, msg.id, msg.timestamp);\n                        }\n                    });\n                    this.scrollToBottom();\n                    // After messages, insert report links from response\n                    if (response.reports && response.reports.length) {\n                        response.reports.forEach(report => {\n                            this.insertReportLinkInChat(report);\n                        });\n                    }\n                    // If last message was an MCQ, enqueue and render MCQ view\n                    if (response.messages.length > 0) {\n                        const lastMsg = response.messages[response.messages.length - 1];\n                        if (lastMsg.tag === 'mcq') {\n                            // Extract JSON objects from the message body\n                            const jsonMatches = lastMsg.body.match(/\\{[\\s\\S]*?\\}/g) || [];\n                            const questions = [];\n                            jsonMatches.forEach(jsonStr => {\n                                try {\n                                    const obj = JSON.parse(jsonStr);\n                                    if (obj.type === 'mcq' && Array.isArray(obj.options)) {\n                                        questions.push(obj);\n                                    }\n                                } catch (e) {}\n                            });\n                            if (questions.length) {\n                                this.enqueueMCQs(questions);\n                            }\n                        }\n                    }\n                },\n                error: () => {\n                    this.hideLoading();\n                    this.showError('Could not load conversation.');\n                }\n            });\n        },\n\n        /**\n         * Insert a report link into the chat after the corresponding message\n         */\n        insertReportLinkInChat: function(report) {\n            const $msg = $(`#chat-container .message[data-message-id=\"${report.message_after_id}\"]`);\n            if (!$msg.length) return;\n            // Build report link message\n            const linkHtml = `\n                <div class=\"message ai-message\">\n                  <div class=\"message-content\">\n                    <div class=\"message-text\">\n                      <a href=\"javascript:void(0)\" class=\"report-link\" data-report-slug=\"${report.slug}\" \n                         style=\"color: #007bff; text-decoration: none; padding:4px 8px; border:1px solid #dee2e6; border-radius:4px; background:#f8f9fa; display:inline-block; transition:all 0.2s;\">\n                        ðŸ“Š ${report.description}\n                      </a>\n                    </div>\n                    <div class=\"message-time small text-muted\">${new Date(report.created_at).toLocaleTimeString()}</div>\n                  </div>\n                </div>\n            `;\n            const $linkMsg = $(linkHtml);\n            // Bind click and hover\n            const self = this;\n            $linkMsg.find('.report-link')\n                .on('click', function() {\n                    const slug = $(this).data('report-slug');\n                    self.openReportFromLink(slug);\n                })\n                .on('mouseenter', function() {\n                    $(this).css({ 'background-color':'#e9ecef', 'border-color':'#adb5bd', 'transform':'translateY(-1px)' });\n                })\n                .on('mouseleave', function() {\n                    $(this).css({ 'background-color':'#f8f9fa', 'border-color':'#dee2e6', 'transform':'translateY(0)' });\n                });\n            // Insert after message\n            $msg.after($linkMsg);\n        },\n\n        sendMessage: function (providedMessage) {\n            if (this.currentMCQ) {\n                // Ignore text input while MCQ active\n                return;\n            }\n\n            // Prevent double sending\n            if (this.isSending) {\n                return;\n            }\n\n            const input = $('#message-input');\n            // Use provided message if given, otherwise read from input field\n            const rawValue = providedMessage ? String(providedMessage).trim() : (input.val() || '').trim();\n            if (!rawValue) {\n                Swal.fire({ icon: 'error', title: 'Oops...', text: 'Please enter a message' });\n                return;\n            }\n            const message = rawValue.trim();\n            if (!message) {\n                return;\n            }\n\n            this.isSending = true;\n\n            // Clear welcome message if it exists\n            $('.welcome-message').remove();\n\n            // Add user message first\n            const $userMsg = this.addMessage(message, 'user');\n            // Only clear input if we read from it (not for provided messages like inline MCQ answers)\n            if (!providedMessage) {\n                input.val('').trigger('input');\n            }\n\n            // Show the AI thinking loader immediately after the user message\n            this.showLoading();\n\n            // Get user information from auth status\n            const authStatus = AuthUtils.getAuthStatus();\n            const userInfo = authStatus?.user || {};\n\n            // If this is a provided message (MCQ selection), wrap with context for AI clarity\n            const messageToSend = providedMessage ? `I selected: ${message}` : message;\n\n            const requestData = {\n                message: messageToSend,\n                chat_id: this.currentChatId || 0,\n                user_id: userInfo.id || null,\n                user_name: userInfo.name || null\n            };\n\n            this.ajaxWithAuth({\n                url: 'https://a360backend.stagingwithswift.com/api/v1/chat/message',\n                method: 'POST',\n                contentType: 'application/json',\n                data: JSON.stringify(requestData),\n                success: (response) => {\n                    this.hideLoading();\n                    this.isSending = false;\n                    if (response.error) {\n                        // Handle specific error types\n                        if (response.error_type === 'credit_limit' || response.error_type === 'token_limit') {\n                            this.handleCreditLimitError(response.message, response.credit_data);\n                        } else if (response.error_type === 'timeout') {\n                            this.handleTimeoutError(response.message);\n                        } else {\n                        // Display backend error as chat bubble\n                        this.addMessage(response.message, 'error');\n                        // Show resend icon on the specific user message that failed\n                        this.showResendIconOnMessage($userMsg, message);\n                        }\n                        return;\n                    }\n                    // Remove any existing resend icons on success (clean up from previous failures)\n                    $('.failed-reload-icon').remove();\n                    // update chat_id on first message\n                    if (!this.currentChatId && response.chat_id) {\n                        this.currentChatId = response.chat_id;\n                        this.addChatToChatHistory(response.chat_id, message);\n                    }\n                    \n                    // Handle response based on type\n                    this.handleResponse(response);\n                    \n                    // Refresh subscription info to update credit usage (reduced delay for faster updates)\n                    // setTimeout(() => {\n                        this.refreshSubscriptionInfo();\n                    // }, 500);\n                },\n                error: (err) => {\n                    this.hideLoading();\n                    this.isSending = false;\n                    if (err.status === 401) {\n                        AuthUtils.clearAuthData();\n                        this.showAuthenticationError();\n                    } else if (err.status === 429) {\n                        // Handle credit limit exceeded (429 Too Many Requests)\n                        let errorMessage = 'You have reached your credit limit. Please upgrade your plan or wait until your credits refresh.';\n                        let creditData = null;\n\n                        // Try to extract error details from response\n                        if (err.responseJSON) {\n                            errorMessage = err.responseJSON.message || errorMessage;\n                            creditData = err.responseJSON.credit_data || null;\n                        }\n\n                        // Handle credit limit error with proper UI updates\n                        this.handleCreditLimitError(errorMessage, creditData);\n\n                        // Don't show resend icon for credit limit errors\n                        $userMsg.remove(); // Remove the user message that couldn't be sent\n                    } else {\n                        // Show resend icon on the specific user message that failed\n                        this.showResendIconOnMessage($userMsg, message);\n                        this.addMessage('Network error occurred. Please try again.', 'error');\n                        return;\n                    }\n                }\n            });\n        },\n\n        updateSendMessageandCreateNewChatButton: function() {\n            if (this.isCreditLimitExceeded) {\n                $('#send-button')\n                    .prop('disabled', true)\n                    .attr('title', 'Credit limit reached. Your credits will reset on the 1st of next month.')\n                    .addClass('credit-limit-disabled');\n                $('#create-new-chat')\n                    .prop('disabled', true)\n                    .attr('title', 'Credit limit reached. Your credits will reset on the 1st of next month.')\n                    .addClass('credit-limit-disabled');\n                $('#message-input')\n                    .prop('disabled', true)\n                    .attr('placeholder', 'Credit limit reached. Your credits will reset on the 1st of next month.');\n            } else {\n                $('#send-button')\n                    .prop('disabled', false)\n                    .removeAttr('title')\n                    .removeClass('credit-limit-disabled');\n                $('#create-new-chat')\n                    .prop('disabled', false)\n                    .removeAttr('title')\n                    .removeClass('credit-limit-disabled');\n                $('#message-input')\n                    .prop('disabled', false)\n                    .attr('placeholder', 'Type your message...');\n            }\n        },\n\n        createNewChat: function () {\n            this.currentChatId = 0;\n            $('#chat-history-list li').removeClass('active');\n            $('#chat-container').empty();\n            this.clearMCQ(); // Clear and hide MCQ container\n\n            // Show welcome message in the new empty chat\n            this.showWelcomeMessage();\n        },\n\n        showWelcomeMessage: function() {\n            const welcomeHtml = `\n                <div class=\"welcome-message text-center p-5\">\n                    <div style=\"max-width: 600px; margin: 0 auto;\">\n                        <h3 class=\"mb-4\">Welcome to Adeptus AI Assistant</h3>\n                        <p class=\"text-muted mb-4\">\n                            I'm here to help you analyze your Moodle data and generate insightful reports.\n                        </p>\n                        <div class=\"row g-3\">\n                            <div class=\"col-md-6\">\n                                <div class=\"p-3 bg-light rounded\">\n                                    <i class=\"fa fa-chart-bar fa-2x mb-2 text-primary\"></i>\n                                    <h5>Generate Reports</h5>\n                                    <small class=\"text-muted\">Ask me to create custom reports about courses, users, grades, and more.</small>\n                                </div>\n                            </div>\n                            <div class=\"col-md-6\">\n                                <div class=\"p-3 bg-light rounded\">\n                                    <i class=\"fa fa-question-circle fa-2x mb-2 text-info\"></i>\n                                    <h5>Get Insights</h5>\n                                    <small class=\"text-muted\">I can help you understand your data and provide actionable insights.</small>\n                                </div>\n                            </div>\n                        </div>\n                        <hr class=\"my-4\">\n                        <p class=\"text-muted\">\n                            <i class=\"fa fa-lightbulb\"></i> Try asking: \"Show me all active courses with their enrollment counts\"\n                        </p>\n                    </div>\n                </div>\n            `;\n            $('#chat-container').html(welcomeHtml);\n        },\n\n        addChatToChatHistory(chatId, firstMessage) {\n\n            const list = $('#chat-history-list');\n\n            // Remove any placeholders\n            list.find('li:contains(\"No chat history\")').remove();\n            list.find('li:contains(\"No chats yet\")').remove();\n            list.find('li:contains(\"Start a conversation\")').remove();\n\n            const date = new Date().toLocaleString();\n            // Truncate message if too long for display\n            const displayMessage = firstMessage && firstMessage.length > 100\n                ? firstMessage.substring(0, 97) + '...'\n                : firstMessage || 'New chat';\n\n            const item = $(\n                `<li class=\"list-group-item d-flex justify-content-between align-items-start chat-history-item\" data-chat-id=\"${chatId}\">\n                    <div>\n                        <small class=\"text-muted\">${date}</small><br>\n                        ${displayMessage}\n                    </div>\n                </li>`\n            );\n            list.prepend(item);\n            item.on('click', (e) => {\n                const li = $(e.currentTarget);\n                const clickedChatId = li.data('chat-id');\n                this.loadChatMessages(clickedChatId, li);\n            });\n        },\n\n        initializeCharts: function () {\n            // Initialize with empty chart\n            const container = $('#chart-container');\n            const canvas = $('<canvas></canvas>');\n            container.append(canvas);\n\n            new Chart(canvas[0], {\n                type: 'bar',\n                data: {\n                    labels: [],\n                    datasets: []\n                },\n                options: {\n                    responsive: true,\n                    maintainAspectRatio: false\n                }\n            });\n        },\n\n        setUserName: function (user) {\n            let userName = \"User\";\n            if (typeof user === 'string') {\n                userName = user;\n            } else if (user && user.name) {\n                userName = user.name;\n            } else if (user && user.admin_name) {\n                userName = user.admin_name;\n            }\n            \n            // Update the card title with the user's name\n            $(\".card-title\").each(function () {\n                if ($(this).text().includes('AI Report Assistant')) {\n                    $(this).text(userName + ': AI Report Assistant');\n                }\n            });\n        },\n\n        /**\n         * Check if credit usage exceeds the limit\n         */\n        isCreditExceeded: function(used, limit) {\n            if (limit === 0 || limit === 'âˆž' || limit === null || limit === undefined) {\n                return false;\n            }\n            return used >= limit;\n        },\n\n        /**\n         * Check if user has exceeded credit limits and show persistent warning\n         */\n        checkAndShowCreditLimitWarning: function(subscription) {\n            \n            // Check if any credit type is exceeded\n            const basicExceeded = this.isCreditExceeded(\n                subscription.basic_credits_used_this_month || 0, \n                subscription.plan_basic_credits_limit || 0\n            );\n            const premiumExceeded = this.isCreditExceeded(\n                subscription.premium_credits_used_this_month || 0, \n                subscription.plan_premium_credits_limit || 0\n            );\n            const totalExceeded = this.isCreditExceeded(\n                subscription.ai_credits_used_this_month || 0, \n                subscription.plan_ai_credits_limit || 0\n            );\n            \n            if (basicExceeded || premiumExceeded || totalExceeded) {\n                const message = \"You've used all your AI credits for this month. Your credits will reset on the 1st of next month. Consider upgrading your plan for more credits.\";\n                this.showPersistentCreditLimitMessage(message);\n                // set global variable to true\n                this.isCreditLimitExceeded = true;\n                this.updateSendMessageandCreateNewChatButton();\n            }else{\n                this.isCreditLimitExceeded = false;\n                this.updateSendMessageandCreateNewChatButton();\n            }\n        },\n\n        updateSubscriptionInfo: async function() {\n            const self = this;\n            \n            // First, fetch latest subscription data from the server (like wizard does)\n            try {\n                const response = await fetch(`${M.cfg.wwwroot}/report/adeptus_insights/ajax/check_subscription_status.php?t=${Date.now()}`, {\n                    method: 'GET',\n                    headers: {\n                        'Content-Type': 'application/json',\n                        'Cache-Control': 'no-cache'\n                    }\n                });\n\n                const data = await response.json();\n                \n                // Log exactly what fields we're receiving for debugging\n                if (data.success && data.data) {\n                    \n                    // Update AuthUtils with fresh data\n                    const authStatus = AuthUtils.getAuthStatus() || {};\n                    authStatus.subscription = data.data;\n                    // Store updated auth status\n                    if (typeof AuthUtils.updateSubscription === 'function') {\n                        AuthUtils.updateSubscription(data.data);\n                    }\n                }\n            } catch (error) {\n                console.error('[AI Assistant] Error fetching latest subscription status:', error);\n            }\n            \n            // Get subscription info from auth status (now updated with fresh data)\n            const authStatus = AuthUtils.getAuthStatus();\n            \n            \n            if (authStatus && authStatus.subscription) {\n                const subscription = authStatus.subscription;\n                \n                // Check if user has exceeded credit limits and show persistent message\n                this.checkAndShowCreditLimitWarning(subscription);\n                \n                // Don't remove the template header - it's correctly positioned\n                // Just remove any dynamically added subscription info to prevent duplicates\n                $('.subscription-status-bar').remove();\n\n                // Create subscription info display (separate from main header)\n                let subscriptionHtml = `\n                    <div class=\"subscription-status-bar\">\n                        <div class=\"subscription-bar-row\">\n                            <div class=\"subscription-info-left\">\n                                <h6 class=\"subscription-title\">\n                                    <i class=\"fa fa-chart-line subscription-icon\"></i> Subscription Status\n                                    <button class=\"btn btn-outline-secondary btn-sm\" id=\"refresh-subscription-btn\" title=\"Refresh subscription data\">\n                                        <i class=\"fa fa-refresh\"></i>\n                                    </button>\n                                </h6>\n                                <div class=\"subscription-details\">\n                                    <span><strong>Plan:</strong> ${subscription.plan_name || 'Unknown'}</span>\n                                    <span class=\"ms-3\"><strong>Status:</strong> <span class=\"badge bg-${subscription.status === 'active' ? 'success' : 'warning'}\">${subscription.status || 'Unknown'}</span></span>\n                                </div>\n                            </div>\n                            <div class=\"subscription-actions-right\">\n                                <a href=\"javascript:void(0)\" onclick=\"window.assistant.showCreditUsageModal()\" class=\"btn btn-view-usage\">\n                                    <i class=\"fa fa-chart-bar\"></i> View Usage\n                                </a>\n                            </div>\n                        </div>\n                    </div>\n                `;\n                \n                // Template already has the header banner - no need to create assistantHtml\n                // Insert subscription status bar at the bottom of the page\n\n                // Insert subscription bar at the bottom of the AI Assistant container\n                // Use specific selector to avoid duplicates on multiple .container-fluid elements\n                const assistantContainer = $('.assistant-header').siblings('.container-fluid').first();\n                if (assistantContainer.length) {\n                    assistantContainer.append(subscriptionHtml);\n                } else {\n                    // Fallback: insert after the template header\n                    const templateHeader = $('.assistant-header');\n                    if (templateHeader.length) {\n                        templateHeader.after(subscriptionHtml);\n                    }\n                }\n                \n                // Bind refresh button event\n                const self = this;\n                $('#refresh-subscription-btn').off('click').on('click', function() {\n                    const $btn = $(this);\n                    const $icon = $btn.find('i');\n                    \n                    // Show loading state\n                    $icon.removeClass('fa-refresh').addClass('fa-spinner fa-spin');\n                    $btn.prop('disabled', true);\n                    \n                    // Refresh subscription info\n                    self.refreshSubscriptionInfo();\n                    \n                    // Reset button state after refresh\n                    setTimeout(() => {\n                        $icon.removeClass('fa-spinner fa-spin').addClass('fa-refresh');\n                        $btn.prop('disabled', false);\n                    }, 1000);\n                });\n            } else {\n                // Remove subscription info if no data available\n                $('.subscription-info').remove();\n            }\n        },\n\n        /**\n         * Transform backend auth data to match frontend expectations\n         */\n        transformBackendAuthData: function(backendData) {\n            if (!backendData) return null;\n            \n            // Get current auth data to preserve existing structure\n            const currentAuthData = window.adeptusAuthData || {};\n            \n            // Transform the data to match the expected frontend structure\n            const transformedData = {\n                ...currentAuthData, // Preserve existing auth data\n                user_authorized: true,\n                has_api_key: true,\n                installation: backendData.installation,\n                subscription: backendData.subscription ? {\n                    ...backendData.subscription,\n                    // Map the usage data to the expected format\n                    premium_credits_used_this_month: backendData.usage ? (backendData.usage.premium_credits_used_this_month || 0) : 0,\n                    basic_credits_used_this_month: backendData.usage ? (backendData.usage.basic_credits_used_this_month || 0) : 0,\n                    ai_credits_used_this_month: backendData.usage ? (backendData.usage.ai_credits_used_this_month || 0) : 0,\n                    reports_generated_this_month: backendData.usage ? (backendData.usage.reports_generated_this_month || 0) : 0,\n                    // Map plan data\n                    plan_name: backendData.plan ? backendData.plan.name : 'Unknown',\n                    plan_premium_credits_limit: backendData.plan ? (backendData.plan.premium_credits_per_month || 0) : 0,\n                    plan_basic_credits_limit: backendData.plan ? (backendData.plan.basic_credits_per_month || 'âˆž') : 'âˆž',\n                    plan_ai_credits_limit: backendData.plan ? (backendData.plan.ai_credits || 0) : 0,\n                    plan_exports_limit: backendData.plan ? (backendData.plan.exports || 'âˆž') : 'âˆž'\n                } : null,\n                plan: backendData.plan,\n                usage: backendData.usage\n            };\n            \n            return transformedData;\n        },\n\n        /**\n         * Refresh subscription info by getting fresh data from backend\n         */\n        refreshSubscriptionInfo: async function() {\n            \n            // Show loading state on refresh button\n            const $refreshBtn = $('#refresh-subscription-btn');\n            const $refreshIcon = $refreshBtn.find('i');\n            if ($refreshBtn.length && $refreshIcon.length) {\n                $refreshIcon.removeClass('fa-refresh').addClass('fa-spinner fa-spin');\n                $refreshBtn.prop('disabled', true);\n            }\n            \n            try {\n                // First, get fresh local subscription data (like wizard does)\n                const localResponse = await fetch(`${M.cfg.wwwroot}/report/adeptus_insights/ajax/check_subscription_status.php?t=${Date.now()}`, {\n                    method: 'GET',\n                    headers: {\n                        'Content-Type': 'application/json',\n                        'Cache-Control': 'no-cache'\n                    }\n                });\n\n                const localData = await localResponse.json();\n\n                if (localData.success && localData.data) {\n                    // Update AuthUtils with fresh data\n                    const authStatus = AuthUtils.getAuthStatus() || {};\n                    authStatus.subscription = localData.data;\n                    \n                    // Also update the global auth data\n                    if (window.adeptusAuthData) {\n                        window.adeptusAuthData.subscription = localData.data;\n                    }\n                }\n                \n                // Then update the display with fresh data\n                await this.updateSubscriptionInfo();\n                \n                \n                // Show success feedback\n                this.showRefreshSuccessFeedback();\n                \n            } catch (error) {\n                console.error('[AI Assistant] Failed to refresh subscription info:', error);\n                this.showRefreshErrorFeedback();\n            } finally {\n                // Reset button state\n                if ($refreshBtn.length && $refreshIcon.length) {\n                    $refreshIcon.removeClass('fa-spinner fa-spin').addClass('fa-refresh');\n                    $refreshBtn.prop('disabled', false);\n                }\n            }\n        },\n\n        /**\n         * Show success feedback for subscription refresh\n         */\n        showRefreshSuccessFeedback: function() {\n            const notification = $(`\n                <div class=\"refresh-success-notification\" style=\"\n                    position: fixed;\n                    top: 20px;\n                    right: 20px;\n                    background: #28a745;\n                    color: white;\n                    padding: 8px 16px;\n                    border-radius: 4px;\n                    box-shadow: 0 2px 8px rgba(0,0,0,0.15);\n                    z-index: 9999;\n                    font-size: 12px;\n                    opacity: 0;\n                    transform: translateY(-20px);\n                    transition: all 0.3s ease;\n                \">\n                    <i class=\"fa fa-check me-1\"></i>\n                    Usage updated\n                </div>\n            `);\n            \n            $('body').append(notification);\n            \n            // Animate in\n            setTimeout(() => {\n                notification.css({\n                    'opacity': '1',\n                    'transform': 'translateY(0)'\n                });\n            }, 100);\n            \n            // Remove after 2 seconds\n            setTimeout(() => {\n                notification.css({\n                    'opacity': '0',\n                    'transform': 'translateY(-20px)'\n                });\n                setTimeout(() => notification.remove(), 300);\n            }, 2000);\n        },\n\n        /**\n         * Show error feedback for subscription refresh\n         */\n        showRefreshErrorFeedback: function() {\n            const notification = $(`\n                <div class=\"refresh-error-notification\" style=\"\n                    position: fixed;\n                    top: 20px;\n                    right: 20px;\n                    background: #dc3545;\n                    color: white;\n                    padding: 8px 16px;\n                    border-radius: 4px;\n                    box-shadow: 0 2px 8px rgba(0,0,0,0.15);\n                    z-index: 9999;\n                    font-size: 12px;\n                    opacity: 0;\n                    transform: translateY(-20px);\n                    transition: all 0.3s ease;\n                \">\n                    <i class=\"fa fa-exclamation-triangle me-1\"></i>\n                    Failed to update usage\n                </div>\n            `);\n            \n            $('body').append(notification);\n            \n            // Animate in\n            setTimeout(() => {\n                notification.css({\n                    'opacity': '1',\n                    'transform': 'translateY(0)'\n                });\n            }, 100);\n            \n            // Remove after 3 seconds\n            setTimeout(() => {\n                notification.css({\n                    'opacity': '0',\n                    'transform': 'translateY(-20px)'\n                });\n                setTimeout(() => notification.remove(), 300);\n            }, 3000);\n        },\n\n        /**\n         * Calculate usage percentage for progress bar\n         */\n        calculateUsagePercentage: function(used, limit) {\n            if (!limit || limit === 'âˆž' || limit === 0) {\n                return 0;\n            }\n            const percentage = (used / limit) * 100;\n            return Math.min(percentage, 100); // Cap at 100%\n        },\n\n\n\n        ajaxWithAuth: function (options) {\n            // Check authentication before making the request\n            if (!AuthUtils.isAuthenticated()) {\n                this.showAuthenticationError();\n                return Promise.reject(new Error('Authentication required'));\n            }\n\n            // Add authentication headers to the request\n            const authHeaders = AuthUtils.getAuthHeaders();\n            options.headers = { ...options.headers, ...authHeaders };\n\n            // Set default timeout to 60 seconds for AI operations (can be slow)\n            if (!options.timeout) {\n                options.timeout = 60000;\n            }\n\n            // Make the authenticated request\n            return $.ajax(options);\n        },\n\n        /**\n         * Load report categories from the backend API\n         * Caches the categories for use in save dialogs\n         */\n        loadCategories: function() {\n            const self = this;\n\n            this.ajaxWithAuth({\n                url: 'https://a360backend.stagingwithswift.com/api/v1/reports/categories',\n                method: 'GET',\n                contentType: 'application/json',\n                success: (response) => {\n                    if (response.success && response.data) {\n                        self.cachedCategories = response.data;\n                    }\n                },\n                error: (xhr) => {\n                    console.error('[AI Assistant] Failed to load categories:', xhr);\n                    // Set default category as fallback\n                    self.cachedCategories = [\n                        { id: null, name: 'General', slug: 'general', color: '#6c757d', icon: 'fa-folder' }\n                    ];\n                }\n            });\n        },\n\n        /**\n         * Get category options HTML for the save dialog dropdown\n         * @param {string} suggestedCategory - The AI-suggested category name\n         * @returns {string} HTML options string\n         */\n        getCategoryOptionsHtml: function(suggestedCategory) {\n            if (!this.cachedCategories || this.cachedCategories.length === 0) {\n                return '<option value=\"\">General</option>';\n            }\n\n            // Normalize the suggested category for comparison\n            const normalizedSuggested = (suggestedCategory || 'general').toLowerCase().replace(/[^a-z0-9]/g, '');\n\n            return this.cachedCategories.map(cat => {\n                const normalizedCatName = cat.name.toLowerCase().replace(/[^a-z0-9]/g, '');\n                const normalizedCatSlug = (cat.slug || '').toLowerCase().replace(/[^a-z0-9]/g, '');\n                const isSelected = normalizedCatName === normalizedSuggested ||\n                                   normalizedCatSlug === normalizedSuggested;\n                return `<option value=\"${cat.id}\" ${isSelected ? 'selected' : ''}>${cat.name}</option>`;\n            }).join('');\n        },\n\n        validateToken: function () {\n            return AuthUtils.isAuthenticated();\n        },\n\n        resendMessage: function ($msgElem, message) {\n            if (this.isSending) {\n                return;\n            }\n            \n            this.isSending = true;\n\n            // Show the AI thinking loader after the user's choice\n            this.showLoading();\n\n            // Get user information from auth status\n            const authStatus = AuthUtils.getAuthStatus();\n            const userInfo = authStatus?.user || {};\n            \n            this.ajaxWithAuth({\n                url: 'https://a360backend.stagingwithswift.com/api/v1/chat/message',\n                method: 'POST',\n                contentType: 'application/json',\n                data: JSON.stringify({ \n                    message: message, \n                    chat_id: this.currentChatId || 0,\n                    user_id: userInfo.id || null,\n                    user_name: userInfo.name || null\n                }),\n                success: (response) => {\n                    this.hideLoading();\n                    this.isSending = false;\n                    if (response.error) {\n                        // Handle specific error types\n                        if (response.error_type === 'credit_limit' || response.error_type === 'token_limit') {\n                            this.handleCreditLimitError(response.message, response.credit_data);\n                        } else {\n                        // Display backend error as chat bubble\n                        this.addMessage(response.message, 'error');\n                        // Show resend icon on the specific message that failed\n                        this.showResendIconOnMessage($msgElem, message);\n                        }\n                        return;\n                    }\n                    // Remove all resend icons on successful resend\n                    $('.failed-reload-icon').remove();\n                    \n                    if (!this.currentChatId && response.chat_id) {\n                        this.currentChatId = response.chat_id;\n                        this.addChatToChatHistory(response.chat_id, message);\n                    }\n                    this.handleResponse(response);\n                },\n                error: (err) => {\n                    this.hideLoading();\n                    this.isSending = false;\n                    if (err.status === 401) {\n                        AuthUtils.clearAuthData();\n                        this.showAuthenticationError();\n                    } else {\n                        // Show resend icon on the specific message that failed\n                        this.showResendIconOnMessage($msgElem, message);\n                        this.addMessage('Network error occurred. Please try again.', 'error');\n                    }\n                }\n            });\n        },\n\n        /**\n         * Push an array of MCQs into our queue and display the first one.\n         * @param {Array} questions  Array of {question: string, options: []}\n         */\n        enqueueMCQs: function(questions) {\n            if (!Array.isArray(questions) || questions.length === 0) {\n                return;\n            }\n            this.mcqQueue = questions.slice(); // copy\n            this.showNextMCQ();\n        },\n\n        /**\n         * Display the next MCQ in the queue, or end MCQ mode if none left.\n         */\n        showNextMCQ: function() {\n            if (this.mcqQueue.length === 0) {\n                return this.clearMCQ();\n            }\n            const next = this.mcqQueue.shift();\n            this.renderMCQ(next.question, next.options);\n        },\n\n        /**\n         * Render a single MCQ question with radio buttons.\n         * @param {string} question\n         * @param {string[]} options\n         */\n        renderMCQ: function(question, options) {\n            this.currentMCQ = true;\n            $('#message-input, #send-button').prop('disabled', true);\n            const c = $('#mcq-container').empty().show();\n            c.append(`<p class=\"mcq-question\"><strong>${question}</strong></p>`);\n            options.forEach((opt, idx) => {\n                const key = String.fromCharCode(65 + idx);\n                c.append(`\n                <div class=\"form-check\">\n                    <input class=\"form-check-input\" type=\"radio\"\n                        name=\"mcq-option\" id=\"mcq-${idx}\"\n                        value=\"${opt}\">\n                    <label class=\"form-check-label\" for=\"mcq-${idx}\">\n                    ${key}. ${opt}\n                    </label>\n                </div>`);\n            });\n            c.append(`<button type=\"button\" class=\"btn btn-link\" id=\"mcq-cancel\">Cancel</button>`);\n            // bind selection\n            c.find('input[name=\"mcq-option\"]').on('change', () => {\n                $('#mcq-submit').remove();\n                c.append(`<button type=\"button\" id=\"mcq-submit\" class=\"btn btn-primary mt-2\">Submit</button>`);\n                $('#mcq-submit').off('click').on('click', (e) => {\n                    e.preventDefault();\n                    e.stopPropagation();\n                    const selected = c.find('input[name=\"mcq-option\"]:checked').val();\n                    if (selected) {\n                        this.sendMCQ(selected);\n                    }\n                });\n            });\n            // cancel\n            c.find('#mcq-cancel').off('click').on('click', (e) => {\n                e.preventDefault();\n                this.mcqQueue = [];\n                this.clearMCQ();\n            });\n        },\n\n        /**\n         * Send the selected MCQ answer to the backend, then show next question if any.\n         */\n        sendMCQ: function(answer) {\n            if (this.isSending) {\n                return;\n            }\n\n            // Validate answer is not empty\n            if (!answer || typeof answer !== 'string' || !answer.trim()) {\n                return;\n            }\n\n            this.showLoading();\n            this.isSending = true;\n            this.clearMCQ();                       // clear current UI\n            const $userMsg = this.addMessage(answer, 'user');      // echo user choice (clean display)\n            // Get user information from auth status\n            const authStatus = AuthUtils.getAuthStatus();\n            const userInfo = authStatus?.user || {};\n\n            // Wrap answer with context so AI understands this is a selection, not a new question\n            const messageToSend = `I selected: ${answer.trim()}`;\n\n            this.ajaxWithAuth({\n                url: 'https://a360backend.stagingwithswift.com/api/v1/chat/message',\n                method: 'POST',\n                contentType: 'application/json',\n                data: JSON.stringify({\n                    message: messageToSend,\n                    chat_id: this.currentChatId || 0,\n                    user_id: userInfo.id || null,\n                    user_name: userInfo.name || null\n                }),\n                success: (response) => {\n                    this.hideLoading();\n                    this.isSending = false;\n                    if (response.error) {\n                        // Handle specific error types\n                        if (response.error_type === 'credit_limit' || response.error_type === 'token_limit') {\n                            this.handleCreditLimitError(response.message);\n                        } else {\n                        this.addMessage(response.message, 'error');\n                        this.showResendIconOnMessage($userMsg, answer);\n                        }\n                        return;\n                    }\n                    // Remove any existing resend icons on success\n                    $('.failed-reload-icon').remove();\n                    // Handle response using the same logic as regular messages\n                    this.handleResponse(response);\n                },\n                error: () => {\n                    this.hideLoading();\n                    this.isSending = false;\n                    this.addMessage('Failed to send choice', 'error');\n                    this.showResendIconOnMessage($userMsg, answer);\n                }\n            });\n        },\n\n        /**\n         * Show report confirmation dialog\n         */\n        showReportConfirmation: function(report, reportData, message, creditInfo, executionError) {\n            // First add the AI message to chat\n            this.addMessage(message || `I've generated a report: ${report.description}`, 'ai', false, null, null, null, creditInfo);\n\n            // Display the report data immediately\n            if (reportData && reportData.length > 0) {\n                // Create a report display in the chat\n                this.displayReportInChat(report, reportData);\n            } else if (executionError) {\n                // Show error message but still allow saving\n                this.addMessage(`âš ï¸ The report could not be executed: ${executionError}\\n\\nYou can still save it and try executing it later.`, 'system');\n            } else {\n                // No data returned\n                this.addMessage('â„¹ï¸ The report returned no data. You can still save it for later use.', 'system');\n            }\n\n            // Add save/decline buttons directly in the chat\n            this.addReportActionButtons(report);\n        },\n\n        /**\n         * Display report data in the chat\n         */\n        displayReportInChat: function(report, data) {\n            // Create a nice table display\n            let tableHtml = '<div class=\"report-preview-container\" style=\"margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 8px; border: 1px solid #dee2e6;\">';\n            tableHtml += `<h5 style=\"margin-bottom: 10px; color: #495057;\">${report.name || report.description}</h5>`;\n\n            if (data && data.length > 0) {\n                const headers = Object.keys(data[0]);\n                // Show more rows for better preview (20 instead of 10)\n                const maxPreviewRows = 20;\n                const previewRows = data.slice(0, maxPreviewRows);\n\n                // Remove fixed height and scrolling - let table be its natural size\n                tableHtml += '<div class=\"table-responsive\">';\n                tableHtml += '<table class=\"table table-sm table-striped table-hover\" style=\"font-size: 0.9rem; margin-bottom: 0;\">';\n\n                // Simplified header without sticky positioning in chat preview\n                tableHtml += '<thead class=\"table-light\"><tr>';\n                headers.forEach(header => {\n                    tableHtml += `<th style=\"background: #e9ecef; white-space: nowrap;\">${header.replace(/_/g, ' ').replace(/\\b\\w/g, l => l.toUpperCase())}</th>`;\n                });\n                tableHtml += '</tr></thead><tbody>';\n\n                previewRows.forEach(row => {\n                    tableHtml += '<tr>';\n                    headers.forEach(header => {\n                        let value = row[header] || '';\n                        // Truncate long values\n                        if (value.toString().length > 50) {\n                            value = value.toString().substring(0, 47) + '...';\n                        }\n                        tableHtml += `<td>${value}</td>`;\n                    });\n                    tableHtml += '</tr>';\n                });\n                tableHtml += '</tbody></table></div>';\n\n                // Show remaining row count and add view full report hint\n                if (data.length > maxPreviewRows) {\n                    const remainingRows = data.length - maxPreviewRows;\n                    tableHtml += `<div class=\"text-center mt-3\">`;\n                    tableHtml += `<p class=\"text-muted mb-2\" style=\"font-size: 0.85rem;\">`;\n                    tableHtml += `<strong>Showing ${maxPreviewRows} of ${data.length} rows</strong>`;\n                    tableHtml += ` (${remainingRows} more rows available)`;\n                    tableHtml += `</p>`;\n                    tableHtml += `<small class=\"text-info\"><i class=\"fa fa-info-circle\"></i> Save the report to view all data in the Reports panel</small>`;\n                    tableHtml += `</div>`;\n                } else {\n                    tableHtml += `<p class=\"text-muted text-center mt-2\" style=\"font-size: 0.85rem;\">Showing all ${data.length} rows</p>`;\n                }\n\n                // Add report metadata (category only)\n                tableHtml += '<div class=\"mt-3 p-2 bg-light rounded\" style=\"font-size: 0.85rem;\">';\n                tableHtml += `<span class=\"badge badge-secondary\">${report.category}</span>`;\n                tableHtml += '</div>';\n            }\n\n            tableHtml += '</div>';\n\n            // Add the table as a special message in the chat\n            this.addMessage(tableHtml, 'report-preview', false);\n        },\n\n        /**\n         * Add report action buttons in the chat\n         */\n        addReportActionButtons: function(report) {\n            const self = this;\n\n            // Check if action buttons for this report already exist\n            const existingActions = document.querySelectorAll('.report-action-container');\n            if (existingActions.length > 0) {\n                // Remove any existing action containers to prevent duplicates\n                existingActions.forEach(container => {\n                    if (!container.querySelector('.fa-check-circle') &&\n                        !container.querySelector('.fa-info-circle') &&\n                        !container.querySelector('.fa-exclamation-triangle')) {\n                        // Only remove if it's still showing buttons (not completed/error state)\n                        container.remove();\n                    }\n                });\n            }\n\n            const buttonId = 'report-action-' + Date.now();\n\n            // Create the action buttons HTML\n            const buttonsHtml = `\n                <div class=\"report-action-container\" id=\"${buttonId}\" style=\"margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 8px; border: 1px solid #dee2e6;\">\n                    <p style=\"margin-bottom: 15px; font-weight: 500;\">Would you like to save this report to your Reports list?</p>\n                    <div class=\"report-actions\" style=\"display: flex; gap: 10px; flex-wrap: wrap;\">\n                        <button class=\"btn btn-primary btn-save-report\" style=\"padding: 8px 20px;\">\n                            <i class=\"fa fa-check-circle\"></i> Save Report\n                        </button>\n                        <button class=\"btn btn-secondary btn-decline-report\" style=\"padding: 8px 20px;\">\n                            <i class=\"fa fa-times-circle\"></i> Don't Save\n                        </button>\n                        <button class=\"btn btn-outline-secondary btn-decline-feedback\" style=\"padding: 8px 20px;\">\n                            <i class=\"fa fa-comment\"></i> Decline & Give Feedback\n                        </button>\n                    </div>\n                </div>\n            `;\n\n            // Add the buttons as a system message\n            this.addMessage(buttonsHtml, 'system-action', false);\n\n            // Attach event handlers after DOM insertion\n            setTimeout(() => {\n                const container = document.getElementById(buttonId);\n                if (!container) return;\n\n                // Save button\n                const saveBtn = container.querySelector('.btn-save-report');\n                if (saveBtn && !saveBtn.hasAttribute('data-handler-attached')) {\n                    // Mark that we've attached a handler to prevent duplicates\n                    saveBtn.setAttribute('data-handler-attached', 'true');\n                    saveBtn.addEventListener('click', function() {\n                        // Get category options HTML\n                        const categoryOptions = self.getCategoryOptionsHtml(report.category);\n                        const defaultName = report.name || report.description || 'SCORM Activities Report';\n\n                        // Prompt for report name and category using SweetAlert\n                        Swal.fire({\n                            title: 'Save Your Report',\n                            html: `\n                                <div style=\"text-align: left;\">\n                                    <div style=\"margin-bottom: 15px;\">\n                                        <label for=\"swal-report-name\" style=\"display: block; margin-bottom: 5px; font-weight: 500;\">\n                                            Report Name\n                                        </label>\n                                        <input type=\"text\" id=\"swal-report-name\" class=\"swal2-input\"\n                                               placeholder=\"e.g., Monthly Student Progress Report\"\n                                               value=\"${defaultName.replace(/\"/g, '&quot;')}\"\n                                               style=\"margin: 0; width: 100%;\">\n                                    </div>\n                                    <div>\n                                        <label for=\"swal-report-category\" style=\"display: block; margin-bottom: 5px; font-weight: 500;\">\n                                            Category\n                                        </label>\n                                        <select id=\"swal-report-category\" class=\"swal2-select\"\n                                                style=\"margin: 0; width: 100%; padding: 8px 12px; border: 1px solid #d9d9d9; border-radius: 4px;\">\n                                            ${categoryOptions}\n                                        </select>\n                                    </div>\n                                </div>\n                            `,\n                            showCancelButton: true,\n                            confirmButtonText: '<i class=\"fa fa-save\"></i> Save Report',\n                            cancelButtonText: 'Cancel',\n                            confirmButtonColor: '#28a745',\n                            focusConfirm: false,\n                            preConfirm: () => {\n                                const name = document.getElementById('swal-report-name').value;\n                                const categoryId = document.getElementById('swal-report-category').value;\n\n                                if (!name || name.trim() === '') {\n                                    Swal.showValidationMessage('Please enter a name for the report');\n                                    return false;\n                                }\n                                if (name.length > 255) {\n                                    Swal.showValidationMessage('Report name is too long (max 255 characters)');\n                                    return false;\n                                }\n\n                                return { name: name.trim(), categoryId: categoryId };\n                            }\n                        }).then((result) => {\n                            if (result.isConfirmed) {\n                                // Update report with user input\n                                report.name = result.value.name;\n                                report.description = result.value.name;\n                                report.category_id = result.value.categoryId ? parseInt(result.value.categoryId) : null;\n\n                                // Disable all buttons\n                                container.querySelectorAll('button').forEach(btn => btn.disabled = true);\n\n                                // Update the container to show saving state\n                                container.innerHTML = `\n                                    <div style=\"text-align: center; color: #28a745;\">\n                                        <i class=\"fa fa-spinner fa-spin\"></i> Saving \"${report.name}\" to your Reports list...\n                                    </div>\n                                `;\n\n                                // Send confirmation to backend\n                                self.confirmReport('accept', report, null);\n                            }\n                        });\n                    });\n                }\n\n                // Don't save button\n                const declineBtn = container.querySelector('.btn-decline-report');\n                if (declineBtn && !declineBtn.hasAttribute('data-handler-attached')) {\n                    declineBtn.setAttribute('data-handler-attached', 'true');\n                    declineBtn.addEventListener('click', function() {\n                        // Update container to show declined state\n                        container.innerHTML = `\n                            <div style=\"text-align: center; color: #6c757d;\">\n                                <i class=\"fa fa-info-circle\"></i> Report not saved. You can ask me to generate it again anytime.\n                            </div>\n                        `;\n\n                        // Also add a message in the chat\n                        self.addMessage(\"Report was not saved. Feel free to ask me to generate a different report or refine this one.\", 'system');\n                    });\n                }\n\n                // Decline with feedback button\n                const feedbackBtn = container.querySelector('.btn-decline-feedback');\n                if (feedbackBtn && !feedbackBtn.hasAttribute('data-handler-attached')) {\n                    feedbackBtn.setAttribute('data-handler-attached', 'true');\n                    feedbackBtn.addEventListener('click', function() {\n                        // Replace buttons with feedback form\n                        container.innerHTML = `\n                            <div class=\"feedback-form\">\n                                <p style=\"margin-bottom: 10px;\">What would you like to change about this report?</p>\n                                <textarea id=\"feedback-text-${buttonId}\" class=\"form-control\" rows=\"3\" placeholder=\"Please provide your feedback...\"></textarea>\n                                <div style=\"margin-top: 10px; display: flex; gap: 10px;\">\n                                    <button class=\"btn btn-primary btn-send-feedback\">\n                                        <i class=\"fa fa-paper-plane\"></i> Send Feedback\n                                    </button>\n                                    <button class=\"btn btn-secondary btn-cancel-feedback\">\n                                        Cancel\n                                    </button>\n                                </div>\n                            </div>\n                        `;\n\n                        // Attach feedback form handlers\n                        const sendFeedbackBtn = container.querySelector('.btn-send-feedback');\n                        const cancelFeedbackBtn = container.querySelector('.btn-cancel-feedback');\n                        const feedbackText = container.querySelector(`#feedback-text-${buttonId}`);\n\n                        if (sendFeedbackBtn) {\n                            sendFeedbackBtn.addEventListener('click', function() {\n                                const feedback = feedbackText ? feedbackText.value : '';\n                                if (feedback.trim()) {\n                                    container.innerHTML = `\n                                        <div style=\"text-align: center; color: #007bff;\">\n                                            <i class=\"fa fa-spinner fa-spin\"></i> Sending feedback...\n                                        </div>\n                                    `;\n                                    self.confirmReport('decline', report, feedback);\n                                } else {\n                                    feedbackText.style.borderColor = '#dc3545';\n                                    feedbackText.focus();\n                                }\n                            });\n                        }\n\n                        if (cancelFeedbackBtn) {\n                            cancelFeedbackBtn.addEventListener('click', function() {\n                                container.innerHTML = `\n                                    <div style=\"text-align: center; color: #6c757d;\">\n                                        <i class=\"fa fa-info-circle\"></i> Report not saved.\n                                    </div>\n                                `;\n                            });\n                        }\n                    });\n                }\n            }, 100);\n        },\n\n        /**\n         * Send report confirmation to backend\n         */\n        /**\n         * View a saved report by slug\n         */\n        viewSavedReport: function(slug) {\n            if (!slug) {\n                return;\n            }\n\n            // Switch to Reports tab\n            $('[href=\"#reports-history\"]').tab('show');\n\n            // Give the tab time to render\n            setTimeout(() => {\n                // Find the report row with the matching slug\n                const reportRow = $(`.report-row[data-report-slug=\"${slug}\"]`);\n\n                if (reportRow.length) {\n                    // Trigger click on the report row\n                    reportRow.click();\n                } else {\n                    // If not found, try to refresh the reports list\n                    this.loadReportsHistory(() => {\n                        setTimeout(() => {\n                            const refreshedRow = $(`.report-row[data-report-slug=\"${slug}\"]`);\n                            if (refreshedRow.length) {\n                                refreshedRow.click();\n                            } else {\n                                // Show error message to user\n                                Notification.addNotification({\n                                    message: 'Report not found. Please check if it still exists in the Reports tab.',\n                                    type: 'error'\n                                });\n                            }\n                        }, 500);\n                    });\n                }\n            }, 300);\n        },\n\n        /**\n         * Display a report link in the chat\n         */\n        displayReportLink: function(msg) {\n            const template = document.getElementById('message-template');\n            const frag = template.content.cloneNode(true);\n            const messageEl = frag.querySelector('.message');\n            messageEl.classList.add('ai-message');\n            messageEl.setAttribute('data-message-id', msg.id);\n\n            // Create report link HTML\n            const reportSlug = msg.metadata?.report_slug || '';\n            const reportName = msg.metadata?.report_name || 'Report';\n            const reportDescription = msg.metadata?.report_description || '';\n\n            const reportLinkHtml = `\n                <div class=\"report-link-message\">\n                    <div style=\"padding: 15px; background: linear-gradient(135deg, #007bff 0%, #0056b3 100%); color: white; border-radius: 10px; margin: 10px 0;\">\n                        <div style=\"display: flex; align-items: center; justify-content: space-between; gap: 20px;\">\n                            <div style=\"flex: 1;\">\n                                <h5 style=\"margin: 0; color: white;\">\n                                    <i class=\"fa fa-chart-bar\"></i> ${reportName}\n                                </h5>\n                                ${reportDescription ? `<small style=\"opacity: 0.9;\">${reportDescription}</small>` : ''}\n                            </div>\n                            ${reportSlug ? `\n                                <button class=\"btn btn-light btn-sm view-saved-report-btn\"\n                                        data-slug=\"${reportSlug}\"\n                                        style=\"cursor: pointer; border-radius: 5px; flex-shrink: 0;\">\n                                    <i class=\"fa fa-eye\"></i> View Report\n                                </button>\n                            ` : ''}\n                        </div>\n                    </div>\n                </div>\n            `;\n\n            frag.querySelector('.message-text').innerHTML = reportLinkHtml;\n            frag.querySelector('.message-time').textContent = this.formatTimestamp(msg.timestamp);\n            $('#chat-container').append(frag);\n\n            // Add click handler using the same pattern as the working buttons\n            const self = this;\n            setTimeout(() => {\n                const viewBtn = $('#chat-container').find('.view-saved-report-btn[data-slug=\"' + reportSlug + '\"]').last();\n                if (viewBtn.length && !viewBtn.hasClass('click-handler-attached')) {\n                    viewBtn.addClass('click-handler-attached');\n                    viewBtn.on('click', function(e) {\n                        e.preventDefault();\n                        e.stopPropagation();\n\n                        // Use the same pattern as the working View Report button\n                        self.switchToReportsTab();\n\n                        // Find and click the report row\n                        const reportRow = $(`.report-row[data-report-slug=\"${reportSlug}\"]`);\n                        if (reportRow.length > 0) {\n                            reportRow.trigger('click');\n                        } else {\n                            // If row doesn't exist, fetch and display directly\n                            self.fetchAndDisplayReport(reportSlug);\n                        }\n                    });\n                }\n            }, 100);\n        },\n\n        /**\n         * Send a message to persist report link in chat history\n         */\n        sendReportMessage: function(report) {\n            // Get user information from auth status\n            const authStatus = AuthUtils.getAuthStatus();\n            const userInfo = authStatus?.user || {};\n\n            // Create a message that includes report metadata\n            const reportMessage = `ðŸ“Š Report saved: ${report.description || report.name}`;\n\n            // Also display the report link immediately in the current chat\n            const reportLinkMsg = {\n                id: Date.now(), // Temporary ID\n                sender_type: 'ai',\n                body: reportMessage,\n                timestamp: new Date().toISOString(),\n                metadata: {\n                    type: 'report',\n                    report_slug: report.slug,\n                    report_name: report.name || report.description,\n                    report_description: report.description\n                }\n            };\n\n            // Display the report link in the chat immediately\n            this.displayReportLink(reportLinkMsg);\n\n            // Send to backend with report metadata\n            this.ajaxWithAuth({\n                url: 'https://a360backend.stagingwithswift.com/api/v1/chat/message',\n                method: 'POST',\n                contentType: 'application/json',\n                data: JSON.stringify({\n                    message: reportMessage,\n                    chat_id: this.currentChatId,\n                    user_id: userInfo.id || null,\n                    user_name: userInfo.name || null,\n                    // Include report metadata\n                    metadata: {\n                        type: 'report',\n                        report_slug: report.slug,\n                        report_name: report.name || report.description,\n                        report_description: report.description\n                    }\n                }),\n                success: () => {\n                    // Report message saved successfully\n                },\n                error: () => {\n                    // Failed to save report message - non-critical\n                }\n            });\n        },\n\n        confirmReport: function(action, report, feedback) {\n            const self = this;\n            this.showLoading();\n            const authStatus = AuthUtils.getAuthStatus();\n            const userInfo = authStatus?.user || {};\n\n            // Ensure all required fields are present\n            const reportData = {\n                name: report.name || report.description || 'Generated Report',\n                description: report.description || '',\n                sql: report.sql || '',\n                category: report.category || 'general',\n                category_id: report.category_id || null\n            };\n\n            // Ensure chat_id is a valid integer\n            const chatId = parseInt(this.currentChatId) || 0;\n\n            this.ajaxWithAuth({\n                url: 'https://a360backend.stagingwithswift.com/api/v1/chat/report-confirmation',\n                method: 'POST',\n                contentType: 'application/json',\n                timeout: 90000, // 90 seconds for feedback processing (AI can be slow)\n                data: JSON.stringify({\n                    chat_id: chatId,\n                    action: action,\n                    feedback: feedback || null,\n                    report: reportData,\n                    user_id: userInfo.id || null\n                }),\n                success: (response) => {\n                    this.hideLoading();\n                    if (action === 'accept' && response.report) {\n                        // Report accepted - add to list\n                        if (!Array.isArray(this.cachedReports)) {\n                            this.cachedReports = [];\n                        }\n                        this.cachedReports.unshift(response.report);\n                        this.updateReportsHistory(this.cachedReports);\n\n                        // Send a message to persist the report link in chat history\n                        this.sendReportMessage(response.report);\n\n                        // Make sure the reports table is visible and loader is hidden\n                        $('#report-history-loader').addClass('d-none');\n                        $('#report-history-table-wrapper').removeClass('d-none');\n\n                        // Ensure the report history table is fully visible\n                        $('#reports-history-table').removeClass('d-none');\n\n                        // Update any active report action containers to show simple success\n                        // The blue gradient card (from sendReportMessage) will have the View Report button\n                        document.querySelectorAll('.report-action-container').forEach(container => {\n                            container.innerHTML = `\n                                <div style=\"text-align: center; color: #28a745; padding: 10px;\">\n                                    <i class=\"fa fa-check-circle\"></i> Report saved successfully!\n                                </div>\n                            `;\n                        });\n                    } else {\n                        // Feedback sent - handle refined response\n                        if (response.chat_response) {\n                            // Check if the response indicates an AI service error\n                            const chatResponse = response.chat_response;\n                            const isServiceError = chatResponse.error ||\n                                (chatResponse.message && (\n                                    chatResponse.message.toLowerCase().includes('trouble connecting') ||\n                                    chatResponse.message.toLowerCase().includes('service') ||\n                                    chatResponse.message.toLowerCase().includes('try again')\n                                ));\n\n                            if (isServiceError) {\n                                // AI service had an issue - show error with retry option\n                                const errorMsg = chatResponse.message || 'The AI service is temporarily unavailable.';\n                                document.querySelectorAll('.report-action-container').forEach(container => {\n                                    const retryBtnId = 'retry-feedback-' + Date.now();\n                                    container.innerHTML = `\n                                        <div style=\"text-align: center; padding: 10px;\">\n                                            <div style=\"color: #dc3545; margin-bottom: 10px;\">\n                                                <i class=\"fa fa-exclamation-circle\"></i> ${errorMsg}\n                                            </div>\n                                            <button id=\"${retryBtnId}\" class=\"btn btn-primary btn-sm\">\n                                                <i class=\"fa fa-refresh\"></i> Retry\n                                            </button>\n                                        </div>\n                                    `;\n                                    // Attach retry handler\n                                    const retryBtn = document.getElementById(retryBtnId);\n                                    if (retryBtn) {\n                                        retryBtn.addEventListener('click', function() {\n                                            self.confirmReport(action, report, feedback);\n                                        });\n                                    }\n                                });\n                                // Also show the error in the chat\n                                this.addMessage(errorMsg, 'error');\n                            } else {\n                                // Check if response has proper report structure\n                                const hasReportStructure = chatResponse.type &&\n                                    (chatResponse.type === 'sql' || chatResponse.type === 'report') &&\n                                    chatResponse.report &&\n                                    chatResponse.awaiting_confirmation;\n\n                                // Check if message indicates a report was generated\n                                const looksLikeReportGeneration = chatResponse.message &&\n                                    (chatResponse.message.toLowerCase().includes('report generated') ||\n                                     chatResponse.message.toLowerCase().includes('generated a report') ||\n                                     chatResponse.message.toLowerCase().includes('i\\'ve generated'));\n\n                                // Log response structure for debugging\n                                console.log('[AI Assistant] Feedback response:', {\n                                    hasReportStructure: hasReportStructure,\n                                    looksLikeReportGeneration: looksLikeReportGeneration,\n                                    type: chatResponse.type,\n                                    hasReport: !!chatResponse.report,\n                                    awaitingConfirmation: chatResponse.awaiting_confirmation,\n                                    message: chatResponse.message?.substring(0, 100)\n                                });\n\n                                if (looksLikeReportGeneration && !hasReportStructure) {\n                                    // \"Ghost report\" - AI says report generated but no structure to display it\n                                    document.querySelectorAll('.report-action-container').forEach(container => {\n                                        const retryBtnId = 'retry-ghost-' + Date.now();\n                                        container.innerHTML = `\n                                            <div style=\"text-align: center; padding: 10px;\">\n                                                <div style=\"color: #856404; background: #fff3cd; padding: 12px; border-radius: 6px; margin-bottom: 10px;\">\n                                                    <i class=\"fa fa-exclamation-triangle\"></i>\n                                                    The refined report was generated but could not be displayed properly.\n                                                </div>\n                                                <button id=\"${retryBtnId}\" class=\"btn btn-primary btn-sm\">\n                                                    <i class=\"fa fa-refresh\"></i> Try Again\n                                                </button>\n                                            </div>\n                                        `;\n                                        const retryBtn = document.getElementById(retryBtnId);\n                                        if (retryBtn) {\n                                            retryBtn.addEventListener('click', function() {\n                                                self.confirmReport(action, report, feedback);\n                                            });\n                                        }\n                                    });\n                                    // Add informative message in chat\n                                    this.addMessage('The report refinement encountered an issue. Please try again using the button above, or start a new request.', 'system');\n                                } else if (hasReportStructure) {\n                                    // Normal success with proper report structure\n                                    document.querySelectorAll('.report-action-container').forEach(container => {\n                                        container.innerHTML = `\n                                            <div style=\"text-align: center; color: #007bff;\">\n                                                <i class=\"fa fa-info-circle\"></i> Feedback sent. I'll refine the report based on your input.\n                                            </div>\n                                        `;\n                                    });\n                                    this.handleResponse(response.chat_response);\n                                } else {\n                                    // Regular response (not a report) - just show the message\n                                    document.querySelectorAll('.report-action-container').forEach(container => {\n                                        container.innerHTML = `\n                                            <div style=\"text-align: center; color: #007bff;\">\n                                                <i class=\"fa fa-info-circle\"></i> Feedback sent.\n                                            </div>\n                                        `;\n                                    });\n                                    this.handleResponse(response.chat_response);\n                                }\n                            }\n                        } else {\n                            // No chat_response - unexpected, show generic feedback sent\n                            document.querySelectorAll('.report-action-container').forEach(container => {\n                                container.innerHTML = `\n                                    <div style=\"text-align: center; color: #007bff;\">\n                                        <i class=\"fa fa-info-circle\"></i> Feedback sent.\n                                    </div>\n                                `;\n                            });\n                        }\n                    }\n                },\n                error: (xhr, status, error) => {\n                    this.hideLoading();\n\n                    // Log the error for debugging\n                    console.error('[AI Assistant] Report confirmation failed:', {\n                        status: xhr.status,\n                        statusText: status,\n                        error: error,\n                        responseText: xhr.responseText,\n                        responseJSON: xhr.responseJSON\n                    });\n\n                    // Determine error type and message\n                    let errorMessage = 'Failed to process request. Please try again.';\n                    let showRetry = true;\n\n                    if (status === 'timeout') {\n                        errorMessage = 'Request timed out. The AI service may be busy. Please try again.';\n                    } else if (xhr.status === 0) {\n                        errorMessage = 'Network error. Please check your connection and try again.';\n                    } else if (xhr.status === 401) {\n                        errorMessage = 'Session expired. Please refresh the page and log in again.';\n                        showRetry = false;\n                    } else if (xhr.status === 429) {\n                        errorMessage = 'Too many requests. Please wait a moment and try again.';\n                    } else if (xhr.status >= 500) {\n                        errorMessage = 'Server error. Please try again in a moment.';\n                    } else if (xhr.responseJSON && xhr.responseJSON.errors) {\n                        console.error('[AI Assistant] Validation errors:', xhr.responseJSON.errors);\n                        const errors = xhr.responseJSON.errors;\n                        const errorDetails = Object.keys(errors).map(field => `${field}: ${errors[field].join(', ')}`).join('; ');\n                        errorMessage = `Validation failed: ${errorDetails}`;\n                        showRetry = false;\n                    } else if (xhr.responseJSON && xhr.responseJSON.message) {\n                        errorMessage = xhr.responseJSON.message;\n                    }\n\n                    // Update containers with error and optional retry button\n                    document.querySelectorAll('.report-action-container').forEach(container => {\n                        const retryBtnId = 'retry-error-' + Date.now();\n                        let retryHtml = '';\n                        if (showRetry) {\n                            retryHtml = `\n                                <button id=\"${retryBtnId}\" class=\"btn btn-outline-primary btn-sm\" style=\"margin-top: 10px;\">\n                                    <i class=\"fa fa-refresh\"></i> Try Again\n                                </button>\n                            `;\n                        }\n                        container.innerHTML = `\n                            <div style=\"text-align: center; padding: 10px;\">\n                                <div style=\"color: #dc3545;\">\n                                    <i class=\"fa fa-exclamation-triangle\"></i> ${errorMessage}\n                                </div>\n                                ${retryHtml}\n                            </div>\n                        `;\n                        // Attach retry handler if button exists\n                        if (showRetry) {\n                            const retryBtn = document.getElementById(retryBtnId);\n                            if (retryBtn) {\n                                retryBtn.addEventListener('click', function() {\n                                    self.confirmReport(action, report, feedback);\n                                });\n                            }\n                        }\n                    });\n                }\n            });\n        },\n\n        /**\n         * Switch to the reports tab\n         */\n        switchToReportsTab: function() {\n            // Remove the datatable-loading class when switching to Reports tab\n            setTimeout(() => {\n                $('.datatable-wrapper').removeClass('datatable-loading');\n                $('#report-history-table-wrapper .datatable-wrapper').removeClass('datatable-loading');\n            }, 200);\n            $('#reports-tab').tab('show');\n            $('#assistant-tab').removeClass('active').attr('aria-selected', 'false');\n            $('#reports-tab').addClass('active').attr('aria-selected', 'true');\n            $('#assistant-panel').removeClass('show active');\n            $('#reports-panel').addClass('show active');\n\n            // Reset view placeholder\n            $('.report-view-title').text('Select a Report');\n            $('.report-view-body').html(\n                '<div class=\"text-center py-4\"><p class=\"text-muted\">Select a report from history to view details here.</p></div>'\n            );\n\n            // Check if reports have been loaded\n            if (!this.cachedReports || (Array.isArray(this.cachedReports) && this.cachedReports.length === 0 && !this.reportsLoaded)) {\n                // Reports not loaded yet, trigger loading\n                this.loadReportsHistory();\n            } else {\n                // Reports already loaded, just ensure table is visible\n                $('#report-history-loader').addClass('d-none');\n                $('#report-history-table-wrapper').removeClass('d-none');\n\n                // Update the table with cached reports\n                if (this.cachedReports) {\n                    this.updateReportsHistory(this.cachedReports);\n                }\n            }\n        },\n\n        /**\n         * Load reports history\n         */\n        loadReportsHistory: function(callback) {\n            // Initialize cachedReports if not already\n            if (!this.cachedReports) {\n                this.cachedReports = [];\n            }\n\n            $('#report-history-loader').removeClass('d-none');\n            $('#report-history-table-wrapper').addClass('d-none');\n            \n            this.ajaxWithAuth({\n                url: 'https://a360backend.stagingwithswift.com/api/v1/ai-reports',\n                method: 'GET',\n                timeout: 10000, // 10 second timeout\n                success: (response) => {\n\n                    // Cache reports for reuse - handle different response formats\n                    const reports = response.reports || response.data || [];\n                    this.cachedReports = Array.isArray(reports) ? reports : [];\n\n                    // Mark that reports have been loaded\n                    this.reportsLoaded = true;\n\n\n                    this.updateReportsHistory(this.cachedReports);\n                    $('#report-history-loader').addClass('d-none');\n                    $('#report-history-table-wrapper').removeClass('d-none');\n\n                    // Destroy existing DataTable if it exists\n                    if (this.reportsDataTable) {\n                        this.reportsDataTable.destroy();\n                        this.reportsDataTable = null;\n                    }\n                    \n                    // Only initialize DataTable if we have data and table structure is ready\n                    setTimeout(() => {\n                        try {\n                            const tableElement = document.getElementById('reports-history-table');\n                            if (!tableElement) {\n                                console.warn('Table element not found');\n                                return;\n                            }\n                            \n                            const tbody = tableElement.querySelector('tbody');\n                            const thead = tableElement.querySelector('thead');\n                            \n                            // Verify table structure before initializing DataTable\n                            if (thead && tbody && thead.rows.length > 0 && thead.rows[0].cells.length > 0) {\n                                // Check if DataTable is already initialized and destroy it first\n                                if (this.reportsDataTable) {\n                                    this.reportsDataTable.destroy();\n                                    this.reportsDataTable = null;\n                                }\n                                \n                                // Count header and data columns to ensure they match\n                                const headerCells = thead.rows[0].cells.length;\n                                const dataRows = tbody.rows;\n                                let dataCells = 0;\n                                \n                                if (dataRows.length > 0) {\n                                    dataCells = dataRows[0].cells.length;\n                                }\n                                \n                                \n                                if (headerCells === dataCells && headerCells > 0) {\n                                    // Only initialize DataTable if we have actual data rows (not just empty state)\n                                    if (dataRows.length > 0 && !dataRows[0].cells[0].textContent.includes('No reports')) {\n                    this.reportsDataTable = new simpleDatatables.DataTable(\"#reports-history-table\", {\n                        searchable: true,\n                        fixedHeight: false,\n                        perPage: 10,\n                        loading: false  // Disable loading indicator\n                    });\n\n                                        // Remove the loading class from the wrapper\n                                        setTimeout(() => {\n                                            // Remove the datatable-loading class from the wrapper\n                                            $('.datatable-wrapper').removeClass('datatable-loading');\n                                            $('#report-history-table-wrapper .datatable-wrapper').removeClass('datatable-loading');\n                                            // Also remove any actual loading elements if they exist\n                                            $('.dataTable-loading').remove();\n                                        }, 100);\n                                    } else {\n                                    }\n                                } else {\n                                    console.warn(`Column mismatch - Headers: ${headerCells}, Data: ${dataCells}`);\n                                }\n                            } else {\n                                console.warn('Table structure not ready for DataTable initialization');\n                            }\n                        } catch (error) {\n                            console.error('Error initializing DataTable:', error);\n                            // Fallback: table will still be functional without DataTable features\n                        }\n\n                    if (typeof callback === 'function') {\n                        callback();\n                    }\n                    }, 100); // Small delay to ensure DOM is ready\n                },\n                error: (xhr, status, error) => {\n                    console.error('[AI Assistant] Failed to load report history:', {\n                        status: xhr.status,\n                        statusText: xhr.statusText,\n                        error: error,\n                        responseText: xhr.responseText\n                    });\n\n                    // Always hide loader and show table\n                    $('#report-history-loader').addClass('d-none');\n                    $('#report-history-table-wrapper').removeClass('d-none');\n\n                    // Show appropriate error message\n                    const tbody = $('#reports-history-table tbody');\n                    tbody.empty();\n\n                    if (status === 'timeout') {\n                        tbody.append(\n                            `<tr><td colspan=\"3\" class=\"text-center text-warning\">Loading reports timed out. Please refresh the page.</td></tr>`\n                        );\n                    } else if (xhr.status === 401 || xhr.status === 403) {\n                        tbody.append(\n                            `<tr><td colspan=\"3\" class=\"text-center text-danger\">Authentication error. Please log in again.</td></tr>`\n                        );\n                    } else {\n                        // Use cached reports if available\n                        if (this.cachedReports && this.cachedReports.length > 0) {\n                            this.updateReportsHistory(this.cachedReports);\n                        } else {\n                            tbody.append(\n                                `<tr><td colspan=\"3\" class=\"text-center text-muted\">Unable to load reports. Please try again later.</td></tr>`\n                            );\n                        }\n                    }\n\n                    if (typeof callback === 'function') {\n                        callback();\n                    }\n                }\n            });\n        },\n\n        /**\n         * Update the reports history table\n         */\n        updateReportsHistory: function(reports) {\n            const tbody = $('#reports-history-table tbody');\n            const self = this; // capture context\n            tbody.empty();\n            if (!reports || reports.length === 0) {\n                // Check if we also have no chat history\n                const authStatus = AuthUtils.getAuthStatus();\n                const hasChats = authStatus && authStatus.subscription && \n                    authStatus.subscription.reports_generated_this_month > 0;\n                \n                if (!hasChats) {\n                    tbody.append(`\n                        <tr>\n                            <td colspan=\"3\" class=\"text-center text-muted\">\n                                <div class=\"py-4\">\n                                    <i class=\"fa fa-chart-bar fa-2x mb-2\"></i>\n                                    <p class=\"mb-1\">No reports generated yet</p>\n                                    <small>Ask the AI assistant to create reports for you</small>\n                                </div>\n                            </td>\n                        </tr>\n                    `);\n                } else {\n                tbody.append(\n                    `<tr><td colspan=\"3\" class=\"text-center text-muted\">No reports yet</td></tr>`\n                );\n                }\n                return;\n            }\n            reports.forEach(report => {\n                const statusBadge = self.getStatusBadge(report.status);\n                const date = new Date(report.created_at).toLocaleDateString();\n                const row = $(`\n                    <tr class=\"report-row\" data-report-slug=\"${report.slug}\">\n                        <td>${report.description}</td>\n                        <td>${date}</td>\n                        <td>${statusBadge}</td>\n                    </tr>`\n                );\n                // Don't attach click handler here - we'll use event delegation instead\n                tbody.append(row);\n            });\n\n            // Use event delegation for report row clicks to handle filtered/searched results\n            // Remove any existing delegated handlers first to avoid duplicates\n            $('#report-history-table-wrapper').off('click', '.report-row');\n\n            // Attach delegated click handler that will work even after DataTable filtering\n            $('#report-history-table-wrapper').on('click', '.report-row', function() {\n                const $row = $(this);\n                const reportSlug = $row.data('report-slug');\n\n                // Find the report from cached reports\n                const report = self.cachedReports.find(r => r.slug === reportSlug);\n                if (!report) {\n                    console.error('Report not found in cache:', reportSlug);\n                    return;\n                }\n\n                // Hide the report history loader when clicking on a report\n                $('#report-history-loader').addClass('d-none');\n                $('#report-history-table-wrapper').removeClass('d-none');\n\n                // Always show loading spinner in carousel container\n                const reportsView = $('#reports-panel .col-md-8 .card-body');\n                reportsView.find('.report-display-wrapper').html('<div class=\"w-100 d-flex justify-content-center align-items-center\" style=\"min-height:200px\"><div class=\"spinner-border text-primary\" role=\"status\"></div></div>');\n\n                // Check if cachedReports exists and has the report WITH DATA\n                if (Array.isArray(self.cachedReports) && self.cachedReports.length > 0) {\n                    const rep = self.cachedReports.find(r => r.slug === report.slug);\n                    if (rep) {\n\n                        // Check if cached report has data, if not fetch it\n                        if (rep.data && Array.isArray(rep.data) && rep.data.length > 0) {\n                            setTimeout(() => { self.updateReportsView(rep, rep.data); }, 300); // simulate async for spinner UX\n                        } else {\n                            self.fetchAndDisplayReport(report.slug, $row);\n                        }\n                    } else {\n                        self.fetchAndDisplayReport(report.slug, $row);\n                    }\n                } else {\n                    self.fetchAndDisplayReport(report.slug, $row);\n                }\n                // Highlight the current report in the history\n                $('.report-row').removeClass('table-primary');\n                $row.addClass('table-primary');\n            });\n        },\n\n        // Helper to fetch report from API, update cache, and display\n        fetchAndDisplayReport: function(reportSlug, rowElem) {\n            const reportsView = $('#reports-panel .col-md-8 .card-body');\n\n            // Ensure report history loader is hidden since we're displaying a report\n            $('#report-history-loader').addClass('d-none');\n            $('#report-history-table-wrapper').removeClass('d-none');\n\n            // Ensure loading spinner is visible\n            reportsView.html('<div class=\"report-display-wrapper w-100\"><div class=\"w-100 d-flex justify-content-center align-items-center\" style=\"min-height:200px\"><div class=\"spinner-border text-primary\" role=\"status\"></div></div></div>');\n            \n            this.ajaxWithAuth({\n                url: `https://a360backend.stagingwithswift.com/api/v1/ai-reports/${reportSlug}`,\n                method: 'GET',\n                success: (response) => {\n                    \n                    // Add or update in cache\n                    if (!Array.isArray(this.cachedReports)) this.cachedReports = [];\n                    let idx = this.cachedReports.findIndex(r => r.slug === reportSlug);\n                    if (idx > -1) {\n                        this.cachedReports[idx] = Object.assign({}, response.report, { data: response.data });\n                    } else {\n                        this.cachedReports.push(Object.assign({}, response.report, { data: response.data }));\n                    }\n                    \n                    // Check if data exists before displaying\n                    if (!response.data || (Array.isArray(response.data) && response.data.length === 0)) {\n                        console.warn('No data returned from backend for report:', reportSlug);\n                        reportsView.find('.report-display-wrapper').html('<div class=\"w-100 text-center text-warning py-4\"><i class=\"fa fa-exclamation-triangle\"></i> Report completed but no data is available. The report may need to be re-executed.</div>');\n                        return;\n                    }\n                    \n                    this.updateReportsView(response.report, response.data);\n                    \n                    // Highlight the current report in the history\n                    $('.report-row').removeClass('table-primary');\n                    if (rowElem) rowElem.addClass('table-primary');\n                },\n                error: (xhr, status, error) => {\n                    console.error('fetchAndDisplayReport error:', reportSlug, status, error);\n                    console.error('XHR:', xhr);\n                    reportsView.find('.report-display-wrapper').html('<div class=\"w-100 text-center text-danger py-4\">Failed to load report. Please try again.</div>');\n                }\n            });\n        },\n\n        /**\n         * Display the current report in the reports view\n         */\n        displayCurrentReport: function(report) {\n            // Update the reports view with the current report\n            this.updateReportsView(report);\n            \n            // Highlight the current report in the history\n            $(`.report-row[data-report-slug=\"${report.slug}\"]`).addClass('table-primary');\n        },\n\n        /**\n         * Display a specific report\n         */\n        displayReport: function(reportSlug) {\n            const rep = this.cachedReports.find(r => r.slug === reportSlug);\n            if (rep) {\n                this.updateReportsView(rep, rep.data);\n                // Highlight the current report in the history\n                $('.report-row').removeClass('table-primary');\n                $(`.report-row[data-report-slug=\"${reportSlug}\"]`).addClass('table-primary');\n            }\n        },\n\n        /**\n         * Update the reports view with report data\n         */\n        updateReportsView: function(report, data = null) {\n            const self = this;\n\n            // Store current report and data for export functionality\n            self.currentViewedReport = report;\n            self.currentViewedReportData = data;\n\n            // Always destroy any existing chart/graph instances to prevent data mixup\n            if (self.reportChartInstance) {\n                self.reportChartInstance.destroy();\n                self.reportChartInstance = null;\n            }\n            if (self.reportGraphInstance) {\n                self.reportGraphInstance.destroy();\n                self.reportGraphInstance = null;\n            }\n            // Destroy any existing VTE instance\n            if (self._vteController && typeof self._vteController.destroy === 'function') {\n                try {\n                    self._vteController.destroy();\n                } catch (e) {\n                    console.error('Error destroying VTE controller:', e);\n                }\n                self._vteController = null;\n            }\n            const reportsView = $('#reports-panel .col-md-8 .card-body');\n            // Inject custom styles for view toggle and chart controls\n            if ($('#display-type-icon-style').length === 0) {\n                $('head').append(`\n                    <style id=\"display-type-icon-style\">\n                        /* View toggle buttons */\n                        .view-toggle .view-toggle-btn {\n                            background: #f8f9fa;\n                            border: 1px solid #dee2e6;\n                            color: #495057;\n                            padding: 0.35rem 0.75rem;\n                            font-size: 13px;\n                            transition: all 0.2s ease;\n                        }\n                        .view-toggle .view-toggle-btn:first-child {\n                            border-radius: 6px 0 0 6px;\n                        }\n                        .view-toggle .view-toggle-btn:last-child {\n                            border-radius: 0 6px 6px 0;\n                        }\n                        .view-toggle .view-toggle-btn:hover {\n                            background: #e9ecef;\n                        }\n                        .view-toggle .view-toggle-btn.active {\n                            background: #2563eb;\n                            border-color: #2563eb;\n                            color: white;\n                        }\n                        .view-toggle .view-toggle-btn i {\n                            margin-right: 5px;\n                        }\n\n                        /* Chart controls wrapper */\n                        .chart-controls-wrapper {\n                            background: #f8f9fa;\n                            border-radius: 8px;\n                            padding: 1rem;\n                            border: 1px solid #e9ecef;\n                        }\n                        .chart-controls {\n                            display: flex;\n                            align-items: flex-end;\n                            flex-wrap: wrap;\n                        }\n                        .chart-controls .control-group {\n                            display: flex;\n                            flex-direction: column;\n                            gap: 0.25rem;\n                        }\n                        .chart-controls .form-label {\n                            font-size: 11px;\n                            font-weight: 600;\n                            color: #6c757d;\n                            margin-bottom: 0;\n                            text-transform: uppercase;\n                            letter-spacing: 0.5px;\n                        }\n                        .chart-controls .form-select {\n                            font-size: 13px;\n                            padding: 0.4rem 2rem 0.4rem 0.75rem;\n                            border-radius: 6px;\n                            border: 1px solid #dee2e6;\n                            background-color: white;\n                            min-width: 140px;\n                        }\n                        .chart-controls .form-select:focus {\n                            border-color: #2563eb;\n                            box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.15);\n                        }\n\n                        /* Legacy icon button styles */\n                        .btn-icon {\n                            transition: transform 0.15s cubic-bezier(.4,2,.6,1), background 0.2s, border 0.2s;\n                            background: #f8f9fa;\n                            border: 1.5px solid #e0e0e0;\n                            color: #333;\n                        }\n                        .btn-icon:hover {\n                            transform: scale(1.15);\n                            background: #e9ecef;\n                            border-color: #b3d7ff;\n                            color: #007bff;\n                            z-index: 2;\n                        }\n                        .btn-icon.active, .btn-icon:focus {\n                            background: #e3f0ff;\n                            border-color: #007bff;\n                            color: #007bff;\n                            box-shadow: 0 0 0 2px #b3d7ff33;\n                        }\n                    </style>\n                `);\n            }\n            // Set the report description as the title\n            $('.report-view-title').text(report.description);\n            if (!Array.isArray(data) || data.length === 0) {\n                reportsView.find('.report-display-wrapper').html('<div class=\"w-100 text-center text-muted py-4\">No data available for this report.</div>');\n                return;\n            }\n\n            // Get headers and detect numeric columns for chart axes\n            const headers = Object.keys(data[0] || {});\n            const numericCols = this.detectNumericColumns(data, headers);\n\n            // Build chart controls HTML\n            let chartControlsHtml = '<div class=\"chart-controls-wrapper mb-3\">';\n            chartControlsHtml += '<div class=\"chart-controls d-flex flex-wrap align-items-end gap-3\">';\n\n            // Chart type selector\n            chartControlsHtml += '<div class=\"control-group\">';\n            chartControlsHtml += '<label for=\"report-chart-type\" class=\"form-label\">Chart Type</label>';\n            chartControlsHtml += '<select id=\"report-chart-type\" class=\"form-select form-select-sm\">';\n            chartControlsHtml += '<option value=\"bar\">Bar Chart</option>';\n            chartControlsHtml += '<option value=\"line\">Line Chart</option>';\n            chartControlsHtml += '<option value=\"pie\">Pie Chart</option>';\n            chartControlsHtml += '<option value=\"doughnut\">Doughnut Chart</option>';\n            chartControlsHtml += '</select></div>';\n\n            // X-Axis selector\n            chartControlsHtml += '<div class=\"control-group\">';\n            chartControlsHtml += '<label for=\"report-chart-x-axis\" class=\"form-label\">X-Axis (Labels)</label>';\n            chartControlsHtml += '<select id=\"report-chart-x-axis\" class=\"form-select form-select-sm\">';\n            headers.forEach((header, idx) => {\n                const formattedHeader = header.replace(/_/g, ' ').replace(/\\b\\w/g, l => l.toUpperCase());\n                const selected = idx === 0 ? ' selected' : '';\n                chartControlsHtml += `<option value=\"${header}\"${selected}>${formattedHeader}</option>`;\n            });\n            chartControlsHtml += '</select></div>';\n\n            // Y-Axis selector (only numeric columns)\n            chartControlsHtml += '<div class=\"control-group\">';\n            chartControlsHtml += '<label for=\"report-chart-y-axis\" class=\"form-label\">Y-Axis (Values)</label>';\n            chartControlsHtml += '<select id=\"report-chart-y-axis\" class=\"form-select form-select-sm\">';\n            if (numericCols.length > 0) {\n                numericCols.forEach((col, idx) => {\n                    const formattedHeader = col.replace(/_/g, ' ').replace(/\\b\\w/g, l => l.toUpperCase());\n                    const selected = idx === numericCols.length - 1 ? ' selected' : '';\n                    chartControlsHtml += `<option value=\"${col}\"${selected}>${formattedHeader}</option>`;\n                });\n            } else {\n                // Fallback to all columns if no numeric found\n                headers.forEach((header, idx) => {\n                    const formattedHeader = header.replace(/_/g, ' ').replace(/\\b\\w/g, l => l.toUpperCase());\n                    const selected = idx === headers.length - 1 ? ' selected' : '';\n                    chartControlsHtml += `<option value=\"${header}\"${selected}>${formattedHeader}</option>`;\n                });\n            }\n            chartControlsHtml += '</select></div>';\n            chartControlsHtml += '</div></div>'; // End chart-controls and wrapper\n\n            // Controls row: export buttons (left), view toggle (right)\n            let controlsHtml = `\n                <div class=\"d-flex justify-content-between align-items-center mb-3 flex-wrap\">\n                    <div class=\"action-buttons d-flex gap-2\">\n                        <button class=\"btn btn-outline-secondary btn-sm export-csv-btn mr-10\">\n                            <i class=\"fa fa-download me-1\"></i>Export CSV\n                        </button>\n                        <button class=\"btn btn-outline-secondary btn-sm export-json-btn\">\n                            <i class=\"fa fa-code me-1\"></i>Export JSON\n                        </button>\n                    </div>\n                    <div class=\"view-toggle btn-group\" role=\"group\">\n                        <button type=\"button\" class=\"btn btn-sm view-toggle-btn${report.display_type !== 'chart' ? ' active' : ''}\" data-type=\"table\"><i class=\"fa fa-table\"></i> Table</button>\n                        <button type=\"button\" class=\"btn btn-sm view-toggle-btn${report.display_type === 'chart' ? ' active' : ''}\" data-type=\"chart\"><i class=\"fa fa-bar-chart\"></i> Chart</button>\n                    </div>\n                </div>\n            `;\n\n            // Display containers\n            const isChartActive = report.display_type === 'chart';\n            let displayHtml = '<div class=\"report-display-area w-100\">';\n\n            // Table view\n            displayHtml += `<div class=\"report-view-panel${!isChartActive ? '' : ' d-none'}\" data-type=\"table\">`;\n            displayHtml += this.renderReportData(data);\n            displayHtml += '</div>';\n\n            // Chart view with controls\n            displayHtml += `<div class=\"report-view-panel${isChartActive ? '' : ' d-none'}\" data-type=\"chart\">`;\n            displayHtml += chartControlsHtml;\n            displayHtml += '<div class=\"chart-container\" style=\"position: relative; height: 400px; border: 1px solid #e9ecef; border-radius: 8px; padding: 1rem; background: #fff;\">';\n            displayHtml += '<canvas id=\"reportChart\"></canvas>';\n            displayHtml += '</div></div>';\n\n            displayHtml += '</div>';\n            reportsView.html(`\n                ${controlsHtml}\n                <div class=\"report-display-wrapper w-100 position-relative\">\n                    ${displayHtml}\n                </div>\n            `);\n            \n            // Store current report data for chart rendering\n            self._currentReportData = data;\n            self._currentReportName = report.description || report.name || 'Report';\n\n            // Initialize Vanilla Table Enhancer if table is active\n            if (this._pendingTableId && report.display_type !== 'chart') {\n                setTimeout(() => {\n                    const tableElement = document.getElementById(this._pendingTableId);\n                    if (tableElement && window.VTE) {\n                        try {\n                            this._vteController = window.VTE.enhance('#' + this._pendingTableId, {\n                                perPage: 10,\n                                perPageOptions: [10, 25, 50, 100],\n                                labels: {\n                                    search: 'Search',\n                                    rows: 'Rows per page',\n                                    info: (start, end, total) => `Showing ${start}â€“${end} of ${total} entries`,\n                                    noData: 'No matching records found'\n                                }\n                            })[0];\n                        } catch (e) {\n                            console.error('Error initializing Vanilla Table Enhancer:', e);\n                        }\n                    }\n                    this._pendingTableId = null;\n                }, 100);\n            }\n\n            // Initialize chart if chart view is active\n            if (report.display_type === 'chart') {\n                setTimeout(() => {\n                    self.renderReportChartFromSelectors(data, self._currentReportName);\n                }, 100);\n            }\n\n            // View toggle button click handler\n            reportsView.find('.view-toggle-btn').on('click', function() {\n                const type = $(this).data('type');\n                reportsView.find('.view-toggle-btn').removeClass('active');\n                $(this).addClass('active');\n\n                // Toggle view panels\n                reportsView.find('.report-view-panel').addClass('d-none');\n                reportsView.find(`.report-view-panel[data-type=\"${type}\"]`).removeClass('d-none');\n\n                // Initialize table enhancer if switching to table\n                if (type === 'table' && !self._vteController && self._pendingTableId) {\n                    setTimeout(() => {\n                        const tableElement = document.getElementById(self._pendingTableId);\n                        if (tableElement && window.VTE) {\n                            try {\n                                self._vteController = window.VTE.enhance('#' + self._pendingTableId, {\n                                    perPage: 10,\n                                    perPageOptions: [10, 25, 50, 100],\n                                    labels: {\n                                        search: 'Search',\n                                        rows: 'Rows per page',\n                                        info: (start, end, total) => `Showing ${start}â€“${end} of ${total} entries`,\n                                        noData: 'No matching records found'\n                                    }\n                                })[0];\n                            } catch (e) {\n                                console.error('Error initializing Vanilla Table Enhancer on view switch:', e);\n                            }\n                        }\n                    }, 100);\n                }\n\n                // Render chart if switching to chart view\n                if (type === 'chart') {\n                    setTimeout(() => {\n                        self.renderReportChartFromSelectors(self._currentReportData, self._currentReportName);\n                    }, 100);\n                }\n\n                // Save display type if changed\n                if (type !== report.display_type) {\n                    if (reportsView.find('.save-display-type-btn').length === 0) {\n                        reportsView.find('.view-toggle').after('<button class=\"btn btn-sm btn-outline-primary save-display-type-btn ms-2\"><i class=\"fa fa-save\"></i> Save View</button>');\n                        reportsView.find('.save-display-type-btn').on('click', function() { self.saveDisplayType(report.slug, type); });\n                    }\n                } else {\n                    reportsView.find('.save-display-type-btn').remove();\n                }\n            });\n\n            // Chart controls change handlers\n            reportsView.find('#report-chart-type, #report-chart-x-axis, #report-chart-y-axis').on('change', function() {\n                self.renderReportChartFromSelectors(self._currentReportData, self._currentReportName);\n            });\n\n            // Export buttons\n            reportsView.find('.export-csv-btn').on('click', () => self.exportReport(report.slug, 'csv'));\n            reportsView.find('.export-json-btn').on('click', () => self.exportReport(report.slug, 'json'));\n        },\n\n        /**\n         * Linkify URLs in text - converts URLs to clickable links\n         * @param {string} text - The text that may contain URLs\n         * @returns {string} Text with URLs converted to anchor tags\n         */\n        linkifyUrls: function(text) {\n            if (!text || typeof text !== 'string') {\n                return text || '';\n            }\n\n            // URL regex pattern - matches http(s) URLs\n            const urlPattern = /(\\bhttps?:\\/\\/[^\\s<>\"']+)/gi;\n\n            // Escape HTML first to prevent XSS, then linkify\n            const escaped = String(text)\n                .replace(/&/g, '&amp;')\n                .replace(/</g, '&lt;')\n                .replace(/>/g, '&gt;')\n                .replace(/\"/g, '&quot;');\n\n            // Replace URLs with anchor tags\n            return escaped.replace(urlPattern, function(url) {\n                // Truncate display text if URL is too long\n                const displayUrl = url.length > 50 ? url.substring(0, 47) + '...' : url;\n                return `<a href=\"${url}\" target=\"_blank\" rel=\"noopener noreferrer\" class=\"report-url-link\" title=\"${url}\">${displayUrl}</a>`;\n            });\n        },\n\n        /**\n         * Format cell value for display - handles URLs, nulls, and special formatting\n         * @param {*} value - The cell value\n         * @param {string} header - The column header (used for context-aware formatting)\n         * @returns {string} Formatted HTML for the cell\n         */\n        formatCellValue: function(value, header) {\n            if (value === null || value === undefined || value === '') {\n                return '';\n            }\n\n            const strValue = String(value);\n\n            // Check if this looks like a URL column or contains a URL\n            const headerLower = (header || '').toLowerCase();\n            const isUrlColumn = headerLower.includes('url') ||\n                                headerLower.includes('link') ||\n                                headerLower.includes('profile') ||\n                                headerLower.includes('href');\n\n            // If it's a URL column or contains http, linkify it\n            if (isUrlColumn || strValue.match(/^https?:\\/\\//i)) {\n                return this.linkifyUrls(strValue);\n            }\n\n            // For other values, just escape HTML\n            return String(strValue)\n                .replace(/&/g, '&amp;')\n                .replace(/</g, '&lt;')\n                .replace(/>/g, '&gt;')\n                .replace(/\"/g, '&quot;');\n        },\n\n        /**\n         * Render report data as a table\n         */\n        renderReportData: function(data) {\n            if (!data || data.length === 0) {\n                return '<p class=\"text-muted\">No data available.</p>';\n            }\n\n            const self = this;\n            const headers = Object.keys(data[0]);\n            const tableId = 'enhanced-report-table-' + Date.now();\n            let tableHtml = `<div class=\"table-responsive\"><table id=\"${tableId}\" class=\"table table-striped table-hover\">`;\n\n            // Add headers with data type hints for proper sorting\n            tableHtml += '<thead><tr>';\n            headers.forEach(header => {\n                // Detect if column contains numeric data\n                const isNumeric = data.every(row => {\n                    const val = row[header];\n                    return val === null || val === undefined || val === '' || !isNaN(parseFloat(val));\n                });\n\n                // Detect if column contains date data\n                const isDate = !isNumeric && data.some(row => {\n                    const val = row[header];\n                    return val && !isNaN(Date.parse(val));\n                });\n\n                const dataType = isNumeric ? ' data-vte=\"number\"' : (isDate ? ' data-vte=\"date\"' : '');\n                tableHtml += `<th${dataType}>${header.replace(/_/g, ' ').replace(/\\b\\w/g, l => l.toUpperCase())}</th>`;\n            });\n            tableHtml += '</tr></thead>';\n\n            // Add data rows with formatted cell values (including URL linkification)\n            tableHtml += '<tbody>';\n            data.forEach(row => {\n                tableHtml += '<tr>';\n                headers.forEach(header => {\n                    const formattedValue = self.formatCellValue(row[header], header);\n                    tableHtml += `<td>${formattedValue}</td>`;\n                });\n                tableHtml += '</tr>';\n            });\n            tableHtml += '</tbody></table></div>';\n\n            // Store table ID for enhancement after DOM insertion\n            this._pendingTableId = tableId;\n\n            return tableHtml;\n        },\n\n        /**\n         * Get status badge HTML\n         */\n        getStatusBadge: function(status) {\n            const badgeClass = this.getStatusBadgeClass(status);\n            return `<span class=\"badge ${badgeClass}\" style=\"color: white;\">${status}</span>`;\n        },\n\n        /**\n         * Get status badge CSS class\n         */\n        getStatusBadgeClass: function(status) {\n            switch (status) {\n                case 'completed': return 'bg-success';\n                case 'ready': return 'bg-success';  // Ready reports are successfully ready to view\n                case 'processing': return 'bg-warning text-dark';\n                case 'pending': return 'bg-info';\n                case 'failed': return 'bg-danger';\n                case 'error': return 'bg-danger';\n                default: return 'bg-secondary';\n            }\n        },\n\n        /**\n         * Execute a pending report\n         */\n        executeReport: function(reportSlug) {\n            // Show loading indicator\n            const reportRow = $(`.report-row[data-report-slug=\"${reportSlug}\"]`);\n            const originalContent = reportRow.html();\n            reportRow.html('<td colspan=\"3\" class=\"text-center\"><div class=\"spinner-border spinner-border-sm text-primary\" role=\"status\"><span class=\"visually-hidden\">Executing...</span></div> Executing report...</td>');\n            \n            this.ajaxWithAuth({\n                url: `https://a360backend.stagingwithswift.com/api/v1/ai-reports/${reportSlug}/execute`,\n                method: 'POST',\n                success: (response) => {\n                    if (response.success) {\n                        // Update the cached report status\n                        if (Array.isArray(this.cachedReports)) {\n                            const reportIndex = this.cachedReports.findIndex(r => r.slug === reportSlug);\n                            if (reportIndex !== -1) {\n                                this.cachedReports[reportIndex] = Object.assign({}, this.cachedReports[reportIndex], response.report);\n                            }\n                        }\n                        \n                        // Refresh the report display\n                        setTimeout(() => {\n                            this.fetchAndDisplayReport(reportSlug, reportRow);\n                        }, 1000); // Small delay to show completion\n                        \n                        this.showSuccess('Report executed successfully!');\n                    } else {\n                        reportRow.html(originalContent);\n                        this.showError('Failed to execute report: ' + (response.error || 'Unknown error'));\n                    }\n                },\n                error: (xhr, status, error) => {\n                    reportRow.html(originalContent);\n                    \n                    let errorMessage = 'Failed to execute report';\n                    \n                    // Handle different error scenarios\n                    if (xhr.status === 500) {\n                        errorMessage = 'Server error occurred while executing the report. Please check the SQL query and try again.';\n                    } else if (xhr.status === 403) {\n                        errorMessage = 'You do not have permission to execute this report.';\n                    } else if (xhr.status === 404) {\n                        errorMessage = 'Report not found.';\n                    } else if (xhr.responseJSON && xhr.responseJSON.error) {\n                        errorMessage = xhr.responseJSON.error;\n                    } else {\n                        errorMessage += ': ' + error;\n                    }\n                    \n                    console.error('Report execution failed:', {\n                        status: xhr.status,\n                        error: error,\n                        response: xhr.responseText\n                    });\n                    \n                    this.showError(errorMessage);\n                }\n            });\n        },\n\n        /**\n         * Export report using local Moodle endpoint (same as Wizard)\n         */\n        exportReport: async function(reportSlug, format) {\n            const self = this;\n\n            // Show loader\n            Swal.fire({\n                title: `Exporting as ${format.toUpperCase()}...`,\n                allowOutsideClick: false,\n                didOpen: () => Swal.showLoading()\n            });\n\n            try {\n                // Build the request body\n                let body = `reportid=${encodeURIComponent(reportSlug)}&format=${format}&sesskey=${M.cfg.sesskey}`;\n\n                // Add view type (default to table)\n                body += `&view=table`;\n\n                // Include the report data if we have it stored\n                if (self.currentViewedReportData && Array.isArray(self.currentViewedReportData)) {\n                    // Get headers from the first row's keys\n                    const headers = self.currentViewedReportData.length > 0\n                        ? Object.keys(self.currentViewedReportData[0])\n                        : [];\n\n                    const reportDataPayload = {\n                        results: self.currentViewedReportData,\n                        headers: headers\n                    };\n                    body += `&report_data=${encodeURIComponent(JSON.stringify(reportDataPayload))}`;\n                }\n\n                // Make the request to the local Moodle endpoint\n                const response = await fetch(`${M.cfg.wwwroot}/report/adeptus_insights/ajax/export_report.php`, {\n                    method: 'POST',\n                    headers: {\n                        'Content-Type': 'application/x-www-form-urlencoded',\n                    },\n                    body: body\n                });\n\n                // Check if response is an error (JSON without Content-Disposition is an error)\n                const contentType = response.headers.get('content-type');\n                const contentDisposition = response.headers.get('content-disposition');\n\n                // If it's JSON but has Content-Disposition: attachment, it's a valid JSON file download\n                // If it's JSON without Content-Disposition, it's an error response\n                if (contentType && contentType.includes('application/json') && !contentDisposition) {\n                    const errorData = await response.json();\n                    throw new Error(errorData.message || 'Export failed');\n                }\n\n                // Check if response is OK\n                if (!response.ok) {\n                    throw new Error(`Export failed with status: ${response.status}`);\n                }\n\n                // Generate meaningful filename\n                const reportName = self.currentViewedReport?.description || self.currentViewedReport?.name || 'report';\n                const sanitizedName = reportName.replace(/[^a-zA-Z0-9\\s-]/g, '').replace(/\\s+/g, '_').toLowerCase();\n                const dateSuffix = new Date().toISOString().split('T')[0]; // YYYY-MM-DD\n\n                // Download the file\n                const blob = await response.blob();\n                const url = window.URL.createObjectURL(blob);\n                const link = document.createElement('a');\n                link.href = url;\n                link.download = `${sanitizedName}_${dateSuffix}.${format}`;\n                document.body.appendChild(link);\n                link.click();\n                window.URL.revokeObjectURL(url);\n                document.body.removeChild(link);\n\n                Swal.close();\n                self.showSuccess(`${format.toUpperCase()} file downloaded successfully!`);\n\n                // Track export in backend after successful download\n                await self.trackExport(format, reportSlug);\n\n            } catch (error) {\n                Swal.close();\n                self.showError(error.message || 'Failed to export report.');\n            }\n        },\n\n        /**\n         * Track export usage in backend\n         */\n        trackExport: async function(format, reportName) {\n            try {\n                const response = await fetch(`${M.cfg.wwwroot}/report/adeptus_insights/ajax/track_export.php`, {\n                    method: 'POST',\n                    headers: {\n                        'Content-Type': 'application/x-www-form-urlencoded',\n                    },\n                    body: `format=${encodeURIComponent(format)}&report_name=${encodeURIComponent(reportName)}&sesskey=${M.cfg.sesskey}`\n                });\n\n                const data = await response.json();\n                if (!data.success) {\n                    console.warn('Failed to track export:', data.message);\n                }\n            } catch (error) {\n                console.error('Error tracking export:', error);\n            }\n        },\n\n        /**\n         * Open report from chat link\n         */\n        openReportFromLink: function(reportSlug) {\n            \n            // Switch to reports tab\n            this.switchToReportsTab();\n            \n            // Refresh history from cache\n            this.updateReportsHistory(this.cachedReports);\n            \n            // Highlight the report row\n            $('.report-row').removeClass('table-primary');\n            const reportRow = $(`.report-row[data-report-slug=\"${reportSlug}\"]`);\n            reportRow.addClass('table-primary');\n            \n            // Check if report has full data in cache\n            const cached = this.cachedReports.find(r => r.slug === reportSlug);\n            \n            // If cached report has data, use it; otherwise fetch from API\n            if (cached && cached.data && Array.isArray(cached.data) && cached.data.length > 0) {\n                this.updateReportsView(cached, cached.data);\n            } else {\n                this.fetchAndDisplayReport(reportSlug, reportRow);\n            }\n        },\n\n        /**\n         * Format timestamps like WhatsApp (today: HH:mm, yesterday: Weekday - HH:mm, same year: D Month - HH:mm, previous years: D Month YYYY - HH:mm)\n         */\n        formatTimestamp: function(ts) {\n            const date = (ts instanceof Date) ? ts : new Date(ts);\n            const now = new Date();\n            const pad = (n) => n.toString().padStart(2, '0');\n            const time = `${pad(date.getHours())}:${pad(date.getMinutes())}`;\n            // Different years\n            if (date.getFullYear() !== now.getFullYear()) {\n                const month = date.toLocaleString('default', { month: 'long' });\n                return `${date.getDate()} ${month} ${date.getFullYear()} - ${time}`;\n            }\n            // Today\n            if (date.toDateString() === now.toDateString()) {\n                return time;\n            }\n            // Yesterday\n            const yesterday = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 1);\n            if (date.toDateString() === yesterday.toDateString()) {\n                const weekday = date.toLocaleString('default', { weekday: 'long' });\n                return `${weekday} - ${time}`;\n            }\n            // Earlier this year\n            const month = date.toLocaleString('default', { month: 'long' });\n            return `${date.getDate()} ${month} - ${time}`;\n        },\n\n        /**\n         * Increment or add report badge count in chat history list\n         */\n        updateChatHistoryBadge: function(chatId) {\n            const $item = $(`#chat-history-list li.chat-history-item[data-chat-id=\"${chatId}\"]`);\n            if (!$item.length) return;\n            let $badge = $item.find('.report-count');\n            if ($badge.length) {\n                const current = parseInt($badge.text(), 10) || 0;\n                $badge.text(current + 1);\n            } else {\n                const $newBadge = $(`<span class=\"badge bg-primary d-flex align-items-center report-count\" style=\"color: white;\"><i class=\"fa fa-chart-bar me-1\"></i>1</span>`);\n                $item.append($newBadge);\n            }\n        },\n\n        /**\n         * Persist display type to server\n         */\n        saveDisplayType: function(reportSlug, displayType) {\n            const self = this;\n            // Show SweetAlert loader\n            Swal.fire({\n                title: 'Saving default view...',\n                allowOutsideClick: false,\n                didOpen: () => Swal.showLoading()\n            });\n            this.ajaxWithAuth({\n                url: `https://a360backend.stagingwithswift.com/api/v1/ai-reports/${reportSlug}/display-type`,\n                method: 'POST',\n                contentType: 'application/json',\n                data: JSON.stringify({ display_type: displayType }),\n                success: () => {\n                    // Show success toast\n                    Swal.fire({ icon: 'success', title: 'Default view saved', showConfirmButton: false, timer: 1500 });\n                    // Update cache and hide save button\n                    const rep = this.cachedReports.find(r => r.slug === reportSlug);\n                    if (rep) { rep.display_type = displayType; }\n                    $('.save-display-type-btn').remove();\n                },\n                error: () => {\n                    // Show error toast\n                    Swal.fire({ icon: 'error', title: 'Save failed', text: 'Could not save default view. Please try again.' });\n                }\n            });\n        },\n\n        // New method to show resend icon on a specific user message\n        showResendIconOnMessage: function($messageElement, messageText) {\n            if (!$messageElement || !$messageElement.length) {\n                return;\n            }\n            \n            // Remove any existing resend icons on this message\n            $messageElement.siblings('.failed-reload-icon').remove();\n                \n                // Create retry icon\n                const $icon = $(`\n                    <i class=\"fa fa-refresh failed-reload-icon text-danger\"\n                   title=\"Retry sending this message\"\n                       style=\"cursor:pointer; float:left; margin-right:0.5rem;\"></i>\n                `);\n                \n                // Insert it to the left of the user-message bubble\n            $messageElement.after($icon);\n                \n                // Bind click event to resend the message\n                $icon.on('click', () => {\n                    $icon.remove();\n                this.resendMessage($messageElement, messageText);\n            });\n        },\n\n        // Legacy method for backward compatibility - shows resend icon on last user message\n        showResendIconOnLastUserMessage: function() {\n            const $lastUserMessage = $('#chat-container .user-message:last');\n            if ($lastUserMessage.length) {\n                // Get the message text from the last user message\n                const messageText = $lastUserMessage.find('.message-text').text();\n                this.showResendIconOnMessage($lastUserMessage, messageText);\n            }\n        },\n\n        /**\n         * Show the Compare Data modal for the current report\n         */\n        showCompareDataModal: function(report) {\n            const self = this;\n            const reportSlug = report.slug;\n            let timeline = [];\n            let currentData = null;\n            let selectedA = null;\n            let selectedB = null;\n            let loadingA = false;\n            let loadingB = false;\n            let error = null;\n            let displayTypeA = 'table';\n            let displayTypeB = 'table';\n            let currentSnapshotId = null;\n            let compareDataA = null;\n            let compareDataB = null;\n            let currentDataFetched = false;\n            let nextSection = 'a'; // Alternating selection\n\n            // Helper: fetch timeline\n            function fetchTimeline(cb) {\n                self.ajaxWithAuth({\n                    url: `https://a360backend.stagingwithswift.com/api/v1/ai-reports/${reportSlug}/snapshots`,\n                    method: 'GET',\n                    success: function(res) {\n                        timeline = res.snapshots || [];\n                        currentSnapshotId = (timeline.find(s => s.is_current_version) || {}).id || null;\n                        if (cb) cb();\n                    },\n                    error: function() {\n                        error = 'Failed to load timeline.';\n                        if (cb) cb();\n                    }\n                });\n            }\n\n            // Helper: fetch current data for A or B\n            function fetchCurrent(section, cb) {\n                if (section === 'a') loadingA = true;\n                if (section === 'b') loadingB = true;\n                renderSections();\n                self.ajaxWithAuth({\n                    url: `https://a360backend.stagingwithswift.com/api/v1/ai-reports/${reportSlug}/data/current`,\n                    method: 'GET',\n                    success: function(res) {\n                        currentData = res.data || [];\n                        if (section === 'a') {\n                        compareDataA = currentData;\n                        selectedA = 'current';\n                            loadingA = false;\n                        } else {\n                            compareDataB = currentData;\n                            selectedB = 'current';\n                            loadingB = false;\n                        }\n                        currentDataFetched = true;\n                        renderSections();\n                        if (cb) cb();\n                    },\n                    error: function() {\n                        error = 'Failed to fetch current data.';\n                        if (section === 'a') loadingA = false;\n                        if (section === 'b') loadingB = false;\n                        renderSections();\n                        if (cb) cb();\n                    }\n                });\n            }\n\n            // Helper: fetch a single snapshot's data for A or B\n            function fetchSnapshotData(snapId, section, cb) {\n                if (section === 'a') loadingA = true;\n                if (section === 'b') loadingB = true;\n                renderSections();\n                self.ajaxWithAuth({\n                    url: `https://a360backend.stagingwithswift.com/api/v1/ai-reports/${reportSlug}/snapshots/${snapId}`,\n                    method: 'GET',\n                    success: function(res) {\n                        if (section === 'a') {\n                            compareDataA = res.data;\n                            selectedA = snapId;\n                            loadingA = false;\n                        } else {\n                            compareDataB = res.data;\n                            selectedB = snapId;\n                            loadingB = false;\n                        }\n                        renderSections();\n                        if (cb) cb();\n                    },\n                    error: function() {\n                        error = 'Failed to fetch snapshot data.';\n                        if (section === 'a') loadingA = false;\n                        if (section === 'b') loadingB = false;\n                        renderSections();\n                        if (cb) cb();\n                    }\n                });\n            }\n\n            // Helper: compare two snapshots (for diff table)\n            function fetchCompare(aId, bId, cb) {\n                loadingA = true;\n                loadingB = true;\n                renderSections();\n                self.ajaxWithAuth({\n                    url: `https://a360backend.stagingwithswift.com/api/v1/ai-reports/${reportSlug}/snapshots/${aId}/compare/${bId}`,\n                    method: 'GET',\n                    success: function(res) {\n                        compareDataA = res.a.data;\n                        compareDataB = res.b.data;\n                        loadingA = false;\n                        loadingB = false;\n                        renderSections();\n                        if (cb) cb(res);\n                    },\n                    error: function() {\n                        error = 'Failed to compare snapshots.';\n                        loadingA = false;\n                        loadingB = false;\n                        renderSections();\n                        if (cb) cb();\n                    }\n                });\n            }\n\n            // Helper: get color and note\n            function getSnapshotColor(snapId) {\n                if (!snapId) return { bg: '#f8f9fa', border: '#dee2e6', text: '#6c757d' };\n                const snapIndex = timeline.findIndex(s => s.id === snapId);\n                if (snapIndex === -1) return { bg: '#f8f9fa', border: '#dee2e6', text: '#6c757d' };\n                const colors = [\n                    { bg: '#e3f2fd', border: '#2196f3', text: '#1976d2' },\n                    { bg: '#f3e5f5', border: '#9c27b0', text: '#7b1fa2' },\n                    { bg: '#e8f5e8', border: '#4caf50', text: '#388e3c' },\n                    { bg: '#fff3e0', border: '#ff9800', text: '#f57c00' },\n                    { bg: '#fce4ec', border: '#e91e63', text: '#c2185b' },\n                    { bg: '#e0f2f1', border: '#009688', text: '#00695c' },\n                    { bg: '#f1f8e9', border: '#8bc34a', text: '#689f38' },\n                    { bg: '#fff8e1', border: '#ffc107', text: '#ffa000' }\n                ];\n                return colors[snapIndex % colors.length];\n            }\n            function getSnapshotNote(snapId) {\n                if (!snapId) return '';\n                if (typeof snapId === 'string' && snapId === 'current') return 'Current Data';\n                const snap = timeline.find(s => s.id === snapId);\n                return snap && snap.note ? snap.note : '';\n            }\n\n            // Render section A\n            function renderSectionA() {\n                let html = '';\n                const colorA = getSnapshotColor(selectedA);\n                const noteA = getSnapshotNote(selectedA);\n                html += `<div class=\"w-100 droppable-snapshot compare-section\" id=\"compare-section-a\" data-drop-target=\"a\" style=\"border: 2px solid ${colorA.border}; border-radius: 8px; padding: 12px; background-color: ${colorA.bg}; height: 100%; min-height: 300px; position:relative;\">\n                    <div class=\"d-flex justify-content-between align-items-center mb-2\">\n                        <span class=\"fw-bold\" style=\"color: ${colorA.text};\">Snapshot A${noteA ? ': ' + noteA : ''}</span>\n                        <div class=\"btn-group display-type-switcher-a\" role=\"group\" aria-label=\"Display type switcher\">\n                            <button class=\"btn btn-icon btn-sm${displayTypeA === 'table' ? ' active' : ''}\" data-type=\"table\" data-side=\"a\" tabindex=\"0\" aria-label=\"Table view\" title=\"Table view\"><i class=\"fa fa-table\"></i></button>\n                            <button class=\"btn btn-icon btn-sm${displayTypeA === 'chart' ? ' active' : ''}\" data-type=\"chart\" data-side=\"a\" tabindex=\"0\" aria-label=\"Chart view\" title=\"Chart view\"><i class=\"fa fa-bar-chart\"></i></button>\n                            <button class=\"btn btn-icon btn-sm${displayTypeA === 'graph' ? ' active' : ''}\" data-type=\"graph\" data-side=\"a\" tabindex=\"0\" aria-label=\"Graph view\" title=\"Graph view\"><i class=\"fa fa-line-chart\"></i></button>\n                            </div>\n                        </div>`;\n                if (loadingA) {\n                    html += '<div class=\"w-100 d-flex justify-content-center align-items-center\" style=\"min-height:200px\"><div class=\"spinner-border text-primary\" role=\"status\"></div></div>';\n                } else if (compareDataA) {\n                    html += `<div class=\"comparison-fade${displayTypeA ? ' comparison-fade-in' : ''}\" style=\"animation:fadeIn .3s; overflow-x: auto; max-height: calc(100% - 50px);\">`;\n                    if (displayTypeA === 'table') {\n                        html += self.renderDiffTable(compareDataA, compareDataB);\n                    } else if (displayTypeA === 'chart') {\n                        html += `<div class=\"chart-container\" style=\"min-height:260px;\" tabindex=\"0\" aria-label=\"Bar chart\" role=\"region\"><canvas id=\"compareChartA\"></canvas></div>`;\n                    } else if (displayTypeA === 'graph') {\n                        html += `<div class=\"chart-container\" style=\"min-height:260px;\" tabindex=\"0\" aria-label=\"Line graph\" role=\"region\"><canvas id=\"compareGraphA\"></canvas></div>`;\n                    }\n                    html += '</div>';\n                } else {\n                    html += `<div class=\"text-muted small text-center\" style=\"min-height:200px;\">No snapshot selected for A</div>`;\n                }\n                html += '</div>';\n                return html;\n            }\n            // Render section B\n            function renderSectionB() {\n                let html = '';\n                const colorB = getSnapshotColor(selectedB);\n                const noteB = getSnapshotNote(selectedB);\n                html += `<div class=\"w-100 droppable-snapshot compare-section\" id=\"compare-section-b\" data-drop-target=\"b\" style=\"border: 2px solid ${colorB.border}; border-radius: 8px; padding: 12px; background-color: ${colorB.bg}; height: 100%; min-height: 300px; position:relative;\">\n                    <div class=\"d-flex justify-content-between align-items-center mb-2\">\n                        <span class=\"fw-bold\" style=\"color: ${colorB.text};\">Snapshot B${noteB ? ': ' + noteB : ''}</span>\n                        <div class=\"btn-group display-type-switcher-b\" role=\"group\" aria-label=\"Display type switcher B\">\n                            <button class=\"btn btn-icon btn-sm${displayTypeB === 'table' ? ' active' : ''}\" data-type=\"table\" data-side=\"b\" tabindex=\"0\" aria-label=\"Table view for B\" title=\"Table view\"><i class=\"fa fa-table\"></i></button>\n                            <button class=\"btn btn-icon btn-sm${displayTypeB === 'chart' ? ' active' : ''}\" data-type=\"chart\" data-side=\"b\" tabindex=\"0\" aria-label=\"Chart view for B\" title=\"Chart view\"><i class=\"fa fa-bar-chart\"></i></button>\n                            <button class=\"btn btn-icon btn-sm${displayTypeB === 'graph' ? ' active' : ''}\" data-type=\"graph\" data-side=\"b\" tabindex=\"0\" aria-label=\"Graph view for B\" title=\"Graph view\"><i class=\"fa fa-line-chart\"></i></button>\n                        </div>\n                    </div>`;\n                if (loadingB) {\n                    html += '<div class=\"w-100 d-flex justify-content-center align-items-center\" style=\"min-height:200px\"><div class=\"spinner-border text-primary\" role=\"status\"></div></div>';\n                } else if (compareDataB) {\n                    html += `<div class=\"comparison-fade${displayTypeB ? ' comparison-fade-in' : ''}\" style=\"animation:fadeIn .3s; overflow-x: auto; max-height: calc(100% - 50px);\">`;\n                    if (displayTypeB === 'table') {\n                        html += self.renderDiffTable(compareDataB, compareDataA);\n                    } else if (displayTypeB === 'chart') {\n                        html += `<div class=\"chart-container\" style=\"min-height:260px;\" tabindex=\"0\" aria-label=\"Bar chart for B\" role=\"region\"><canvas id=\"compareChartB\"></canvas></div>`;\n                    } else if (displayTypeB === 'graph') {\n                        html += `<div class=\"chart-container\" style=\"min-height:260px;\" tabindex=\"0\" aria-label=\"Line graph for B\" role=\"region\"><canvas id=\"compareGraphB\"></canvas></div>`;\n                    }\n                    html += '</div>';\n                    } else {\n                    html += `<div class=\"text-muted small text-center\" style=\"min-height:200px;\">No snapshot selected for B</div>`;\n                }\n                html += '</div>';\n                return html;\n            }\n\n            // Render both sections\n            function renderSections() {\n                $('#compare-section-a').replaceWith(renderSectionA());\n                $('#compare-section-b').replaceWith(renderSectionB());\n                // Chart.js rendering for A\n                if (displayTypeA === 'chart' && Array.isArray(compareDataA) && compareDataA.length > 0) {\n                    const ctxA = document.getElementById('compareChartA');\n                    if (ctxA) {\n                        const headers = Object.keys(compareDataA[0]);\n                        let labelKey = headers.find(h => typeof compareDataA[0][h] === 'string') || headers[0];\n                        let valueKey = headers.find(h => typeof compareDataA[0][h] === 'number') || headers[1];\n                        const labels = compareDataA.map(r => r[labelKey]);\n                        const values = compareDataA.map(r => r[valueKey]);\n                        if (window.compareChartAInstance) window.compareChartAInstance.destroy();\n                        window.compareChartAInstance = new Chart(ctxA.getContext('2d'), {\n                            type: 'bar',\n                            data: { labels: labels, datasets: [{ label: valueKey, data: values, backgroundColor: 'rgba(0,123,255,0.5)', borderColor: 'rgba(0,123,255,1)', borderWidth: 1 }] },\n                            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }\n                        });\n                    }\n                }\n                if (displayTypeA === 'graph' && Array.isArray(compareDataA) && compareDataA.length > 0) {\n                    const ctxA = document.getElementById('compareGraphA');\n                    if (ctxA) {\n                        const headers = Object.keys(compareDataA[0]);\n                        let labelKey = headers.find(h => typeof compareDataA[0][h] === 'string') || headers[0];\n                        let valueKey = headers.find(h => typeof compareDataA[0][h] === 'number') || headers[1];\n                        const labels = compareDataA.map((r, i) => r[labelKey] || i + 1);\n                        const values = compareDataA.map(r => r[valueKey]);\n                        if (window.compareGraphAInstance) window.compareGraphAInstance.destroy();\n                        window.compareGraphAInstance = new Chart(ctxA.getContext('2d'), {\n                            type: 'line',\n                            data: { labels: labels, datasets: [{ label: valueKey, data: values, backgroundColor: 'rgba(40,167,69,0.5)', borderColor: 'rgba(40,167,69,1)', borderWidth: 2, fill: false }] },\n                            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }\n                        });\n                    }\n                }\n                // Chart.js rendering for B\n                if (displayTypeB === 'chart' && Array.isArray(compareDataB) && compareDataB.length > 0) {\n                    const ctxB = document.getElementById('compareChartB');\n                    if (ctxB) {\n                        const headers = Object.keys(compareDataB[0]);\n                        let labelKey = headers.find(h => typeof compareDataB[0][h] === 'string') || headers[0];\n                        let valueKey = headers.find(h => typeof compareDataB[0][h] === 'number') || headers[1];\n                        const labels = compareDataB.map(r => r[labelKey]);\n                        const values = compareDataB.map(r => r[valueKey]);\n                        if (window.compareChartBInstance) window.compareChartBInstance.destroy();\n                        window.compareChartBInstance = new Chart(ctxB.getContext('2d'), {\n                            type: 'bar',\n                            data: { labels: labels, datasets: [{ label: valueKey, data: values, backgroundColor: 'rgba(0,123,255,0.5)', borderColor: 'rgba(0,123,255,1)', borderWidth: 1 }] },\n                            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }\n                        });\n                    }\n                }\n                if (displayTypeB === 'graph' && Array.isArray(compareDataB) && compareDataB.length > 0) {\n                    const ctxB = document.getElementById('compareGraphB');\n                    if (ctxB) {\n                        const headers = Object.keys(compareDataB[0]);\n                        let labelKey = headers.find(h => typeof compareDataB[0][h] === 'string') || headers[0];\n                        let valueKey = headers.find(h => typeof compareDataB[0][h] === 'number') || headers[1];\n                        const labels = compareDataB.map((r, i) => r[labelKey] || i + 1);\n                        const values = compareDataB.map(r => r[valueKey]);\n                        if (window.compareGraphBInstance) window.compareGraphBInstance.destroy();\n                        window.compareGraphBInstance = new Chart(ctxB.getContext('2d'), {\n                            type: 'line',\n                            data: { labels: labels, datasets: [{ label: valueKey, data: values, backgroundColor: 'rgba(40,167,69,0.5)', borderColor: 'rgba(40,167,69,1)', borderWidth: 2, fill: false }] },\n                            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }\n                        });\n                    }\n                }\n            }\n\n            // Helper: render timeline sidebar (unchanged)\n            function renderTimeline(selectedAId, selectedBId) {\n                let html = '<div class=\"timeline-sidebar\" style=\"width:220px;max-width:220px;overflow-y:auto;height:100%;background:#f8f9fa;border-right:1.5px solid #e0e0e0;padding:0.5rem 0.25rem;\">';\n                html += '<div class=\"d-flex flex-column gap-2 mb-3\">';\n                html += `<button class=\"btn btn-outline-primary btn-sm w-100 mb-1 fetch-current-btn\" title=\"Fetch current data from database\" aria-label=\"Fetch current data\"><i class=\"fa fa-sync\"></i> Fetch Current Data</button>`;\n                const isCurrentDataInContext = currentDataFetched && selectedA === 'current';\n                if (isCurrentDataInContext) {\n                    html += `<div class=\"mb-2\">\n                        <input type=\"text\" id=\"add-timeline-note\" class=\"form-control form-control-sm mb-1\" placeholder=\"Enter snapshot name (required)\" required aria-label=\"Snapshot name\">\n                        <div class=\"invalid-feedback\" style=\"display:none;\">Snapshot name is required.</div>\n                        <button class=\"btn btn-outline-success btn-sm w-100 add-timeline-btn\" id=\"add-timeline-btn\" title=\"Create snapshot from current data\" aria-label=\"Create snapshot from current data\" disabled><span class=\"btn-label\"><i class=\"fa fa-plus\"></i> Create Snapshot From Current Data</span><span class=\"spinner-border spinner-border-sm ms-2\" id=\"snapshot-loading\" style=\"display:none;\" role=\"status\" aria-hidden=\"true\"></span></button>\n                    </div>`;\n                }\n                html += '<div class=\"small text-muted text-center px-2 py-1 mb-2\" style=\"border: 1px dashed #dee2e6; border-radius: 4px;\">Click or <b>drag</b> snapshots to select for comparison. Each snapshot gets a unique color. You can also drag and drop from the side menu into the snapshot viewer.</div>';\n                html += '</div>';\n                html += '<div class=\"timeline-list\">';\n                if (timeline.length === 0) {\n                    if (error) {\n                        html += `<div class=\"text-danger small text-center py-2\">Error: ${error}</div>`;\n                    } else {\n                        html += '<div class=\"text-muted small text-center py-2\">No timeline snapshots yet. [DEBUG: Timeline is empty]</div>';\n                    }\n                } else {\n                    timeline.forEach((snap, index) => {\n                        // Color coding system\n                        const colors = [\n                            { bg: '#e3f2fd', border: '#2196f3', text: '#1976d2' }, // Light blue\n                            { bg: '#f3e5f5', border: '#9c27b0', text: '#7b1fa2' }, // Light purple\n                            { bg: '#e8f5e8', border: '#4caf50', text: '#388e3c' }, // Light green\n                            { bg: '#fff3e0', border: '#ff9800', text: '#f57c00' }, // Light orange\n                            { bg: '#fce4ec', border: '#e91e63', text: '#c2185b' }, // Light pink\n                            { bg: '#e0f2f1', border: '#009688', text: '#00695c' }, // Light teal\n                            { bg: '#f1f8e9', border: '#8bc34a', text: '#689f38' }, // Light lime\n                            { bg: '#fff8e1', border: '#ffc107', text: '#ffa000' }  // Light amber\n                        ];\n                        const colorIndex = index % colors.length;\n                        const color = colors[colorIndex];\n                        const isSelected = selectedAId === snap.id || selectedBId === snap.id;\n                        const selectedStyle = isSelected ? \n                            `background-color: ${color.bg}; border-color: ${color.border}; border-width: 2px;` : \n                            `background-color: #fff; border-color: #dee2e6; border-width: 1px;`;\n                        const isCurrent = snap.is_current_version ? '<span class=\"badge bg-primary ms-1\">Current</span>' : '';\n                        // Drag and drop attributes\n                        const dragDisabled = isSelected ? 'draggable=\"false\"' : 'draggable=\"true\"';\n                        const dragClass = isSelected ? 'drag-disabled' : 'draggable-snapshot';\n                        const dragTitle = isSelected ? 'This snapshot is currently selected' : 'Drag to assign to Snapshot A or B';\n                        const dragText = isSelected ? '<span class=\"text-muted small\">(Selected)</span>' : '';\n                        html += `<div class=\"timeline-item p-2 mb-1 rounded border ${dragClass}\" \n                                      style=\"cursor:pointer; animation:fadeIn .3s; ${selectedStyle}\" \n                                      data-snap-id=\"${snap.id}\" \n                                      data-color-bg=\"${color.bg}\" \n                                      data-color-border=\"${color.border}\" \n                                      data-color-text=\"${color.text}\"\n                                      tabindex=\"0\" \n                                      aria-label=\"Snapshot from ${self.formatTimestamp(snap.created_at)}${snap.is_current_version ? ' (current)' : ''}\"\n                                      ${dragDisabled}\n                                      title=\"${dragTitle}\"\n                                      >\n                            <div class=\"d-flex justify-content-between align-items-center\">\n                                <span class=\"fw-bold small\">${self.formatTimestamp(snap.created_at)}</span>\n                                ${isCurrent}\n                            </div>\n                            <div class=\"small text-muted\">${snap.note ? snap.note : ''} ${dragText}</div>\n                            <div class=\"d-flex gap-1 mt-1\">\n                                <button class=\"btn btn-outline-secondary btn-xs btn-sm set-current-btn\" data-snap-id=\"${snap.id}\" title=\"Set as current version\" aria-label=\"Set as current\"><i class=\"fa fa-check\"></i></button>\n                            </div>\n                        </div>`;\n                    });\n                }\n                html += '</div></div>';\n                return html;\n            }\n\n            // Helper: render modal\n            function renderModal() {\n                Swal.update({\n                    html: `<div class='d-flex flex-row' style='height:70vh;min-height:500px;max-height:80vh;'>\n                        <div id='timeline-sidebar-modal'></div>\n                        <div class='flex-fill px-3' style='overflow:auto;max-width:calc(100% - 220px);'>\n                            <div class='d-flex flex-row gap-3 w-100 h-100'>\n                                <div class='flex-fill' id='compare-section-a'></div>\n                                <div class='flex-fill' id='compare-section-b'></div>\n                            </div>\n                        </div>\n                    </div>`\n                });\n                $('#timeline-sidebar-modal').html(renderTimeline(selectedA, selectedB));\n                renderSections();\n                // Bind timeline actions\n                $('.fetch-current-btn').off('click').on('click', function() {\n                    fetchCurrent(nextSection);\n                });\n                // Timeline item click handler for alternating selection\n                $('.timeline-item').off('click').on('click', function(e) {\n                    const snapId = $(this).data('snap-id');\n                    if (nextSection === 'a') {\n                        fetchSnapshotData(snapId, 'a', () => {\n                            nextSection = 'b';\n                        });\n                    } else {\n                        fetchSnapshotData(snapId, 'b', () => {\n                            nextSection = 'a';\n                        });\n                    }\n                });\n                // Display type switchers\n                $('.display-type-switcher-a .btn-icon').off('click').on('click', function() {\n                    displayTypeA = $(this).data('type');\n                    renderSections();\n                });\n                $('.display-type-switcher-b .btn-icon').off('click').on('click', function() {\n                    displayTypeB = $(this).data('type');\n                    renderSections();\n                });\n                // Drag and drop logic\n                $('.draggable-snapshot').attr('draggable', true).off('dragstart').on('dragstart', function(e) {\n                    e.originalEvent.dataTransfer.setData('text/plain', $(this).data('snap-id'));\n                    $(this).addClass('dragging');\n                });\n                $('.draggable-snapshot').off('dragend').on('dragend', function(e) {\n                    $(this).removeClass('dragging');\n                });\n                // Section highlight on drag over\n                $('.compare-section').off('dragover').on('dragover', function(e) {\n                    e.preventDefault();\n                    $(this).addClass('drag-over-section');\n                });\n                $('.compare-section').off('dragleave').on('dragleave', function(e) {\n                    $(this).removeClass('drag-over-section');\n                });\n                $('.compare-section').off('drop').on('drop', function(e) {\n                    e.preventDefault();\n                    $(this).removeClass('drag-over-section');\n                    const snapId = e.originalEvent.dataTransfer.getData('text/plain');\n                    const target = $(this).data('drop-target');\n                    fetchSnapshotData(snapId, target, () => {\n                        nextSection = target === 'a' ? 'b' : 'a';\n                    });\n                });\n                // Add highlight CSS if not present\n                if ($('#compare-section-highlight-style').length === 0) {\n                    $('head').append('<style id=\"compare-section-highlight-style\">.drag-over-section { box-shadow: 0 0 0 4px #90caf9 !important; border-color: #1976d2 !important; }</style>');\n                }\n            }\n\n            // Show modal\n            Swal.fire({\n                title: `<span class='fw-bold'>Compare Report Data</span>`,\n                html: `<div class='d-flex flex-row' style='height:60vh;min-height:400px;max-height:70vh;'>\n                    <div id='timeline-sidebar-modal'></div>\n                    <div class='flex-fill px-3' style='overflow:auto;max-width:calc(100% - 220px);'>\n                        <div class='d-flex flex-row gap-3 w-100 h-100'>\n                            <div class='flex-fill' id='compare-section-a'></div>\n                            <div class='flex-fill' id='compare-section-b'></div>\n                        </div>\n                    </div>\n                </div>`,\n                width: '90vw',\n                heightAuto: false,\n                showCancelButton: true,\n                showConfirmButton: false,\n                customClass: { popup: 'swal2-modal-compare-data' },\n                didOpen: () => {\n                    fetchTimeline(() => {\n                        // Default: set A to current version, B to latest snapshot (if >1)\n                        if (timeline.length > 0) {\n                            selectedA = timeline.find(s => s.is_current_version)?.id || timeline[0].id;\n                            selectedB = timeline.length > 1 ? timeline[1].id : null;\n                            if (selectedA && selectedB) {\n                                fetchCompare(selectedA, selectedB, () => {\n                                    nextSection = 'a';\n                                    renderModal();\n                                });\n                            } else if (selectedA) {\n                                fetchSnapshotData(selectedA, 'a', () => {\n                                    nextSection = 'b';\n                                    renderModal();\n                                });\n                            } else {\n                                renderModal();\n                            }\n                        } else {\n                            renderModal();\n                        }\n                    });\n                }\n            });\n        },\n\n        /**\n         * Render a diff table (side-by-side, highlight differences)\n         */\n        renderDiffTable: function(a, b) {\n            // Lightweight diff: highlight cells in a that differ from b\n            if (!Array.isArray(a) || a.length === 0) {\n                return '<div class=\"text-muted small\">No data</div>';\n            }\n            const headers = Object.keys(a[0]);\n            let html = '<div class=\"table-responsive\"><table class=\"table table-striped table-hover table-sm\">';\n            html += '<thead><tr>';\n            headers.forEach(h => { html += `<th>${h}</th>`; });\n            html += '</tr></thead><tbody>';\n            a.forEach((row, i) => {\n                html += '<tr>';\n                headers.forEach(h => {\n                    let diff = false;\n                    // Only highlight differences if we have comparison data\n                    if (b && Array.isArray(b) && b[i] && b[i][h] !== row[h]) {\n                        diff = true;\n                    }\n                    html += `<td${diff ? ' style=\"background:#ffe5e5;\"' : ''}>${row[h] != null ? row[h] : ''}</td>`;\n                });\n                html += '</tr>';\n            });\n            html += '</tbody></table></div>';\n            return html;\n        },\n\n        /**\n         * Test method to simulate a multiple choice question\n         * Call this from browser console: require(['report_adeptus_insights/assistant'], function(a) { a.testMCQ(); });\n         */\n        testMCQ: function() {\n            const testMessage = `I found an existing wizard report that might meet your needs. However, it doesn't include all the fields you requested.\n\nWhat would you like to do?\n\nA. Use the existing wizard report as-is\nB. Generate a new custom SQL report with all fields\nC. Use the wizard report and create a separate supplementary report\nD. Cancel and try a different approach`;\n\n            // Add the test message as if it came from AI\n            this.addMessage(testMessage, 'ai');\n        },\n\n        /**\n         * Test with numbered options\n         */\n        testMCQNumbered: function() {\n            const testMessage = `Please select your preferred report format:\n\n1. PDF Export with charts and graphs\n2. Excel spreadsheet with raw data\n3. CSV file for data analysis\n4. Interactive web dashboard\n5. Email summary report`;\n\n            this.addMessage(testMessage, 'ai');\n        }\n    };\n\n    // Expose assistant to global scope for onclick handlers\n    window.assistant = assistant;\n    \n    return assistant;\n});"],"names":["define","$","Ajax","Notification","Chart","Templates","AuthUtils","Swal","window","assistant","currentChatId","currentMCQ","isSending","mcqQueue","reportsDataTable","cachedReports","cachedCategories","_initCalled","isCreditLimitExceeded","init","authenticated","this","getAssistantContainer","siblings","first","hide","initializeLoaderStyles","isAuthenticated","setUserName","getAuthStatus","user","name","updateSubscriptionInfo","setupEventListeners","loadChatHistory","loadReportsHistory","loadCategories","fadeIn","refreshAuthStatus","setTimeout","showAuthenticationError","error","console","length","append","html","show","on","sendMessage","e","key","shiftKey","preventDefault","updateChart","style","height","scrollHeight","createNewChat","renderMCQ","mcq","c","empty","question","options","forEach","opt","label","clearMCQ","prop","extractMCQFromText","text","jsonArrayMatch","match","questions","JSON","parse","Array","isArray","type","selectedAnswer","jsonMatches","jsonStr","obj","push","renderMCQHistory","idx","option","optIdx","optionText","isSelected","includes","selectedIcon","checkAuth","handleResponse","response","error_type","handleCreditLimitError","message","addMessage","showResendIconOnLastUserMessage","firstQuestion","mcqText","join","credit_info","enqueueMCQs","awaiting_confirmation","report","showReportConfirmation","report_data","execution_error","reportData","description","updateChatHistoryBadge","unshift","updateReportsHistory","destroy","tableElement","document","getElementById","thead","querySelector","tbody","rows","cells","headerCells","dataRows","dataCells","textContent","simpleDatatables","DataTable","searchable","fixedHeight","perPage","loading","removeClass","fire","title","showConfirmButton","allowOutsideClick","allowEscapeKey","timer","timerProgressBar","then","switchToReportsTab","displayCurrentReport","executeReport","slug","data","updateReportData","visualizations","updateVisualizations","showCreditUsageFeedback","scrollToBottom","creditInfo","notification","credits_charged","credit_type","css","remove","updateSubscriptionInfoWithCreditUsage","authStatus","subscription","creditsUsed","premium_credits_used_this_month","basic_credits_used_this_month","ai_credits_used_this_month","animateCreditCounterUpdate","creditType","$counter","addClass","$totalCounter","isReportLink","messageId","timestamp","replace","trim","template","frag","content","cloneNode","messageEl","classList","add","setAttribute","mcqData","mcqHtml","innerHTML","self","link","onclick","openReportFromLink","getAttribute","onmouseenter","onmouseleave","background","padding","border","maxWidth","isMultipleChoiceQuestion","renderMultipleChoiceOptions","addCreditInfoToMessage","timeEl","formatTimestamp","Date","toISOString","creditBadge","createElement","className","cssText","backgroundColor","color","toUpperCase","tokens_used","provider","appendChild","letterMatches","numberMatches","letters","map","m","firstLetter","charCodeAt","isConsecutive","i","Math","min","numbers","parseInt","lines","split","questionText","line","trimmedLine","letterMatch","numberMatch","letter","isLetter","escapeHtml","optionId","now","querySelectorAll","button","addEventListener","disabled","selectedOption","selectedText","find","o","closest","btn","answer","creditData","summary","updateSubscriptionDataFromCreditResponse","updateSendMessageandCreateNewChatButton","showPersistentCreditLimitMessage","icon","showCancelButton","confirmButtonText","cancelButtonText","confirmButtonColor","result","isConfirmed","showCreditUsageModal","undefined","tokens_limit","tokens_remaining","setAuthStatus","handleTimeoutError","cancelButtonColor","focus","alertHtml","$mainInners","eq","before","prepend","hidePersistentCreditLimitMessage","fadeOut","willOpen","showLoading","ajaxWithAuth","url","method","success","displayDetailedUsageModal","usage","pagination","total","formatTokens","tokens","toFixed","toString","usagePercent","round","total_tokens_used","limitDisplay","modalHtml","total_requests","today_tokens_used","item","d","created_at","day","getDate","month","toLocaleString","year","getFullYear","hours","getHours","padStart","minutes","getMinutes","action_type","model","prompt_tokens","completion_tokens","width","showCloseButton","customClass","popup","htmlContainer","didOpen","closeBtn","setupUsageModalEventListeners","currentFilters","filters","usageDataTable","perPageSelect","sortable","labels","placeholder","noRows","info","stack","userId","val","startDate","endDate","user_id","start_date","end_date","loadUsageDataWithFilters","period","today","weekAgo","setDate","monthAgo","setMonth","getMonth","page","params","URLSearchParams","updateUsageModalData","total_credits_used","unique_users","premium_credits","basic_credits","tableBody","row","toLocaleDateString","llm_provider","message_preview","substring","refresh","table","columns","column","tr","cell","container","canvas","datasets","dataset","borderColor","borderWidth","responsive","maintainAspectRatio","plugins","legend","position","display","detectNumericColumns","headers","filter","header","numericCount","sampleSize","num","parseFloat","isNaN","isFinite","generateChartColors","count","baseColors","colors","createReportChartConfig","chartType","values","valueKey","reportName","baseConfig","font","size","weight","top","bottom","fill","tension","scales","y","beginAtZero","x","ticks","maxRotation","minRotation","renderReportChartFromSelectors","labelKey","valueKeyFormatted","l","chartData","slice","r","labelStr","String","chartConfig","chartEl","reportChartInstance","getContext","loaderShownAt","$chatContainer","hideLoading","loaderShownDuration","remainingTime","max","showError","errorDiv","showSuccess","successHtml","successDiv","scrollTop","list","chats","chat","date","snippet","last_message","first_message","reportCount","report_count","badgeHtml","id","li","currentTarget","chatId","loadChatMessages","children","showWelcomeMessage","reports_generated_this_month","xhr","status","listItem","messageUrl","credit_data","checkAndShowCreditLimitWarning","messages","msg","sender_type","role","body","tag","nextMsg","prevMsg","metadata","startsWith","reportNameMatch","reportSlug","toLowerCase","report_name","report_slug","displayReportLink","reports","insertReportLinkInChat","lastMsg","$msg","message_after_id","linkHtml","toLocaleTimeString","$linkMsg","after","providedMessage","input","rawValue","$userMsg","trigger","userInfo","requestData","chat_id","user_name","contentType","stringify","showResendIconOnMessage","addChatToChatHistory","refreshSubscriptionInfo","err","clearAuthData","errorMessage","responseJSON","attr","removeAttr","firstMessage","displayMessage","clickedChatId","initializeCharts","userName","admin_name","each","isCreditExceeded","used","limit","basicExceeded","plan_basic_credits_limit","premiumExceeded","plan_premium_credits_limit","totalExceeded","plan_ai_credits_limit","async","fetch","M","cfg","wwwroot","json","updateSubscription","subscriptionHtml","plan_name","assistantContainer","templateHeader","off","$btn","$icon","transformBackendAuthData","backendData","adeptusAuthData","user_authorized","has_api_key","installation","plan","premium_credits_per_month","basic_credits_per_month","ai_credits","plan_exports_limit","exports","$refreshBtn","$refreshIcon","localResponse","localData","showRefreshSuccessFeedback","showRefreshErrorFeedback","calculateUsagePercentage","percentage","Promise","reject","Error","authHeaders","getAuthHeaders","timeout","ajax","getCategoryOptionsHtml","suggestedCategory","normalizedSuggested","cat","normalizedCatName","normalizedCatSlug","validateToken","resendMessage","$msgElem","showNextMCQ","next","shift","fromCharCode","stopPropagation","selected","sendMCQ","messageToSend","executionError","displayReportInChat","addReportActionButtons","tableHtml","Object","keys","maxPreviewRows","previewRows","value","remainingRows","category","existingActions","buttonId","buttonsHtml","saveBtn","hasAttribute","categoryOptions","defaultName","focusConfirm","preConfirm","categoryId","showValidationMessage","category_id","confirmReport","declineBtn","feedbackBtn","sendFeedbackBtn","cancelFeedbackBtn","feedbackText","feedback","viewSavedReport","tab","reportRow","click","refreshedRow","addNotification","reportDescription","report_description","reportLinkHtml","viewBtn","last","hasClass","fetchAndDisplayReport","sendReportMessage","reportMessage","reportLinkMsg","action","sql","chat_response","chatResponse","errorMsg","retryBtnId","retryBtn","hasReportStructure","looksLikeReportGeneration","log","hasReport","awaitingConfirmation","_chatResponse$message","statusText","responseText","showRetry","errors","errorDetails","field","retryHtml","reportsLoaded","callback","warn","statusBadge","getStatusBadge","$row","rep","updateReportsView","rowElem","reportsView","findIndex","assign","displayReport","currentViewedReport","currentViewedReportData","reportGraphInstance","_vteController","numericCols","chartControlsHtml","formattedHeader","col","controlsHtml","display_type","isChartActive","displayHtml","renderReportData","_currentReportData","_currentReportName","_pendingTableId","VTE","enhance","perPageOptions","search","start","end","noData","saveDisplayType","exportReport","linkifyUrls","displayUrl","formatCellValue","strValue","headerLower","tableId","isNumeric","every","isDate","some","formattedValue","badgeClass","getStatusBadgeClass","originalContent","reportIndex","format","encodeURIComponent","sesskey","reportDataPayload","results","get","contentDisposition","errorData","ok","sanitizedName","_self$currentViewedRe2","dateSuffix","blob","URL","createObjectURL","href","download","revokeObjectURL","removeChild","close","trackExport","cached","ts","pad","n","time","toDateString","yesterday","weekday","$item","$badge","current","$newBadge","displayType","$messageElement","messageText","$lastUserMessage","showCompareDataModal","timeline","currentData","selectedA","selectedB","loadingA","loadingB","displayTypeA","displayTypeB","currentSnapshotId","compareDataA","compareDataB","currentDataFetched","nextSection","fetchSnapshotData","snapId","section","cb","renderSections","res","getSnapshotColor","bg","snapIndex","s","getSnapshotNote","snap","note","replaceWith","colorA","noteA","renderDiffTable","renderSectionA","colorB","noteB","renderSectionB","ctxA","h","compareChartAInstance","compareGraphAInstance","ctxB","compareChartBInstance","compareGraphBInstance","renderModal","update","selectedAId","selectedBId","index","selectedStyle","isCurrent","is_current_version","dragDisabled","dragTitle","dragText","renderTimeline","originalEvent","dataTransfer","setData","getData","target","heightAuto","aId","bId","a","b","snapshots","diff","testMCQ","testMCQNumbered"],"mappings":"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"}