{"version":3,"file":"assistant.min.js","sources":["../src/assistant.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * AI Assistant interface for Adeptus Insights plugin.\n *\n * Handles the AI chat interface, message sending/receiving, report generation,\n * chart rendering, and conversation management for the insights assistant.\n *\n * @module     report_adeptus_insights/assistant\n * @copyright  2026 Adeptus 360 <info@adeptus360.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\ndefine([\n    'jquery',\n    'core/ajax',\n    'core/notification',\n    'core/chartjs',\n    'core/templates',\n    'core/str',\n    'report_adeptus_insights/auth_utils'\n], function($, Ajax, Notification, Chart, Templates, Str, AuthUtils) {\n    var Swal = window.Swal;\n\n    // Language strings storage\n    var strings = {};\n\n    /**\n     * Load all language strings needed for the module\n     * @returns {Promise} Promise that resolves when strings are loaded\n     */\n    var loadStrings = function() {\n        return Str.get_strings([\n            {key: 'js_generating_report', component: 'report_adeptus_insights'},\n            {key: 'js_token_limit_reached', component: 'report_adeptus_insights'},\n            {key: 'js_token_limit_message', component: 'report_adeptus_insights'},\n            {key: 'js_view_usage', component: 'report_adeptus_insights'},\n            {key: 'js_report_limit_reached', component: 'report_adeptus_insights'},\n            {key: 'js_report_limit_message', component: 'report_adeptus_insights'},\n            {key: 'js_view_reports', component: 'report_adeptus_insights'},\n            {key: 'js_upgrade_your_plan', component: 'report_adeptus_insights'},\n            {key: 'js_upgrade_plan_message', component: 'report_adeptus_insights'},\n            {key: 'js_ai_service_busy', component: 'report_adeptus_insights'},\n            {key: 'js_ai_service_busy_message', component: 'report_adeptus_insights'},\n            {key: 'js_try_again', component: 'report_adeptus_insights'},\n            {key: 'js_loading_usage_data', component: 'report_adeptus_insights'},\n            {key: 'js_fetching_usage_info', component: 'report_adeptus_insights'},\n            {key: 'js_applying_filters', component: 'report_adeptus_insights'},\n            {key: 'js_report_chart', component: 'report_adeptus_insights'},\n            {key: 'js_please_enter_message', component: 'report_adeptus_insights'},\n            {key: 'js_oops', component: 'report_adeptus_insights'},\n            {key: 'js_save_your_report', component: 'report_adeptus_insights'},\n            {key: 'js_report_name_label', component: 'report_adeptus_insights'},\n            {key: 'js_enter_report_name', component: 'report_adeptus_insights'},\n            {key: 'js_category_label', component: 'report_adeptus_insights'},\n            {key: 'js_select_category', component: 'report_adeptus_insights'},\n            {key: 'js_save_report', component: 'report_adeptus_insights'},\n            {key: 'js_report_not_found', component: 'report_adeptus_insights'},\n            {key: 'js_export_not_available', component: 'report_adeptus_insights'},\n            {key: 'js_not_eligible_export', component: 'report_adeptus_insights'},\n            {key: 'js_saving_default_view', component: 'report_adeptus_insights'},\n            {key: 'js_default_view_saved', component: 'report_adeptus_insights'},\n            {key: 'js_save_failed', component: 'report_adeptus_insights'},\n            {key: 'js_could_not_save_view', component: 'report_adeptus_insights'},\n            {key: 'js_unable_verify_eligibility', component: 'report_adeptus_insights'},\n            {key: 'js_unable_verify_export', component: 'report_adeptus_insights'},\n            {key: 'js_authentication_required', component: 'report_adeptus_insights'},\n            {key: 'js_auth_required_message', component: 'report_adeptus_insights'},\n            {key: 'js_refresh_page', component: 'report_adeptus_insights'},\n            {key: 'js_delete_chat', component: 'report_adeptus_insights'},\n            {key: 'js_delete_chat_confirm', component: 'report_adeptus_insights'},\n            {key: 'js_yes_delete', component: 'report_adeptus_insights'},\n            {key: 'js_chat_deleted', component: 'report_adeptus_insights'},\n            {key: 'js_error_deleting_chat', component: 'report_adeptus_insights'},\n            {key: 'js_new_chat', component: 'report_adeptus_insights'},\n            {key: 'js_no_chats_yet', component: 'report_adeptus_insights'},\n            {key: 'js_start_conversation', component: 'report_adeptus_insights'},\n            {key: 'js_error_loading_chats', component: 'report_adeptus_insights'},\n            {key: 'js_report_saved', component: 'report_adeptus_insights'},\n            {key: 'js_report_saved_message', component: 'report_adeptus_insights'},\n            {key: 'js_error_saving_report', component: 'report_adeptus_insights'},\n            {key: 'js_delete_report', component: 'report_adeptus_insights'},\n            {key: 'js_delete_report_confirm', component: 'report_adeptus_insights'},\n            {key: 'js_report_deleted', component: 'report_adeptus_insights'},\n            {key: 'js_error_deleting_report', component: 'report_adeptus_insights'},\n            {key: 'js_no_reports', component: 'report_adeptus_insights'},\n            {key: 'js_generate_reports_message', component: 'report_adeptus_insights'},\n            {key: 'js_error_loading_reports', component: 'report_adeptus_insights'},\n            {key: 'js_no_data_available', component: 'report_adeptus_insights'},\n            {key: 'js_export_success', component: 'report_adeptus_insights'},\n            {key: 'js_export_error', component: 'report_adeptus_insights'},\n            {key: 'js_processing', component: 'report_adeptus_insights'},\n            {key: 'js_please_wait', component: 'report_adeptus_insights'},\n            {key: 'js_success', component: 'report_adeptus_insights'},\n            {key: 'js_error', component: 'report_adeptus_insights'},\n            {key: 'js_warning', component: 'report_adeptus_insights'},\n            {key: 'js_confirm', component: 'report_adeptus_insights'},\n            {key: 'js_yes', component: 'report_adeptus_insights'},\n            {key: 'js_no', component: 'report_adeptus_insights'},\n            {key: 'js_deleted', component: 'report_adeptus_insights'},\n            {key: 'js_saved', component: 'report_adeptus_insights'},\n            {key: 'js_untitled_report', component: 'report_adeptus_insights'},\n            {key: 'js_general_category', component: 'report_adeptus_insights'},\n            {key: 'loading', component: 'report_adeptus_insights'},\n            {key: 'close', component: 'report_adeptus_insights'},\n            {key: 'cancel', component: 'report_adeptus_insights'},\n            {key: 'export_premium_feature', component: 'report_adeptus_insights'},\n            {key: 'export_premium_description', component: 'report_adeptus_insights'},\n            {key: 'export_free_plan_info', component: 'report_adeptus_insights'},\n            {key: 'export_paid_plan_info', component: 'report_adeptus_insights'},\n            {key: 'upgrade_now', component: 'report_adeptus_insights'},\n            {key: 'js_view_plans', component: 'report_adeptus_insights'},\n            {key: 'js_monthly_allowance_used', component: 'report_adeptus_insights'},\n            {key: 'js_tokens_reset_monthly', component: 'report_adeptus_insights'},\n            {key: 'js_used_of_reports', component: 'report_adeptus_insights'},\n            {key: 'js_delete_reports_or_upgrade', component: 'report_adeptus_insights'},\n            {key: 'js_unlock_features', component: 'report_adeptus_insights'},\n            {key: 'js_current_usage', component: 'report_adeptus_insights'},\n            {key: 'js_unlimited', component: 'report_adeptus_insights'},\n            {key: 'js_reports', component: 'report_adeptus_insights'},\n            {key: 'js_report_limit_reached_banner', component: 'report_adeptus_insights'},\n            {key: 'js_manage_reports', component: 'report_adeptus_insights'},\n            {key: 'js_upgrade_plan', component: 'report_adeptus_insights'},\n            {key: 'js_ask_moodle_data', component: 'report_adeptus_insights'},\n            {key: 'js_report_limit_placeholder', component: 'report_adeptus_insights'},\n            {key: 'js_export_premium_feature', component: 'report_adeptus_insights'},\n            {key: 'js_export_premium_description', component: 'report_adeptus_insights'},\n            {key: 'js_free_plan_exports', component: 'report_adeptus_insights'},\n            {key: 'js_paid_plan_exports', component: 'report_adeptus_insights'},\n            {key: 'js_free_plan_label', component: 'report_adeptus_insights'},\n            {key: 'js_paid_plans_label', component: 'report_adeptus_insights'},\n            {key: 'js_no_reports_generated', component: 'report_adeptus_insights'},\n            {key: 'js_ask_ai_create_reports', component: 'report_adeptus_insights'},\n            {key: 'js_compare_report_data', component: 'report_adeptus_insights'},\n            {key: 'js_failed_load_usage', component: 'report_adeptus_insights'},\n            {key: 'js_failed_load_filtered', component: 'report_adeptus_insights'}\n        ]).then(function(results) {\n            strings = {\n                generating_report: results[0],\n                token_limit_reached: results[1],\n                token_limit_message: results[2],\n                view_usage: results[3],\n                report_limit_reached: results[4],\n                report_limit_message: results[5],\n                view_reports: results[6],\n                upgrade_your_plan: results[7],\n                upgrade_plan_message: results[8],\n                ai_service_busy: results[9],\n                ai_service_busy_message: results[10],\n                try_again: results[11],\n                loading_usage_data: results[12],\n                fetching_usage_info: results[13],\n                applying_filters: results[14],\n                report_chart: results[15],\n                please_enter_message: results[16],\n                oops: results[17],\n                save_your_report: results[18],\n                report_name_label: results[19],\n                enter_report_name: results[20],\n                category_label: results[21],\n                select_category: results[22],\n                save_report: results[23],\n                report_not_found: results[24],\n                export_not_available: results[25],\n                not_eligible_export: results[26],\n                saving_default_view: results[27],\n                default_view_saved: results[28],\n                save_failed: results[29],\n                could_not_save_view: results[30],\n                unable_verify_eligibility: results[31],\n                unable_verify_export: results[32],\n                authentication_required: results[33],\n                auth_required_message: results[34],\n                refresh_page: results[35],\n                delete_chat: results[36],\n                delete_chat_confirm: results[37],\n                yes_delete: results[38],\n                chat_deleted: results[39],\n                error_deleting_chat: results[40],\n                new_chat: results[41],\n                no_chats_yet: results[42],\n                start_conversation: results[43],\n                error_loading_chats: results[44],\n                report_saved: results[45],\n                report_saved_message: results[46],\n                error_saving_report: results[47],\n                delete_report: results[48],\n                delete_report_confirm: results[49],\n                report_deleted: results[50],\n                error_deleting_report: results[51],\n                no_reports: results[52],\n                generate_reports_message: results[53],\n                error_loading_reports: results[54],\n                no_data_available: results[55],\n                export_success: results[56],\n                export_error: results[57],\n                processing: results[58],\n                please_wait: results[59],\n                success: results[60],\n                error: results[61],\n                warning: results[62],\n                confirm: results[63],\n                yes: results[64],\n                no: results[65],\n                deleted: results[66],\n                saved: results[67],\n                untitled_report: results[68],\n                general_category: results[69],\n                loading: results[70],\n                close: results[71],\n                cancel: results[72],\n                export_premium_feature: results[73],\n                export_premium_description: results[74],\n                export_free_plan_info: results[75],\n                export_paid_plan_info: results[76],\n                upgrade_now: results[77],\n                view_plans: results[78],\n                monthly_allowance_used: results[79],\n                tokens_reset_monthly: results[80],\n                used_of_reports: results[81],\n                delete_reports_or_upgrade: results[82],\n                unlock_features: results[83],\n                current_usage: results[84],\n                unlimited: results[85],\n                reports: results[86],\n                report_limit_reached_banner: results[87],\n                manage_reports: results[88],\n                upgrade_plan: results[89],\n                ask_moodle_data: results[90],\n                report_limit_placeholder: results[91],\n                export_is_premium: results[92],\n                export_premium_desc: results[93],\n                free_plan_exports: results[94],\n                paid_plan_exports: results[95],\n                free_plan_label: results[96],\n                paid_plans_label: results[97],\n                no_reports_generated: results[98],\n                ask_ai_create_reports: results[99],\n                compare_report_data: results[100],\n                failed_load_usage: results[101],\n                failed_load_filtered: results[102]\n            };\n            return strings;\n        });\n    };\n\n    /**\n     * Get a loaded string, with fallback\n     * @param {string} key - The string key\n     * @param {string} fallback - Fallback value if string not loaded\n     * @returns {string} The string value\n     */\n    var getString = function(key, fallback) {\n        return strings[key] || fallback || key;\n    };\n\n    var assistant = {\n        currentChatId: 0,\n        currentMCQ: null,\n        isSending: false,\n        mcqQueue: [],\n        reportsDataTable: null,\n        cachedReports: [],\n        cachedCategories: [],\n        _initCalled: false,\n        isCreditLimitExceeded: false,\n        backendUrl: 'https://backend.adeptus360.com/api/v1',\n        isFreePlan: true,\n        _currentReportView: 'table', // Track current view: 'table' or 'chart'\n        _currentReportData: null, // Store current report data for chart rendering\n        _currentReportName: '', // Store current report name for chart title\n        currentViewedReport: null, // Store current report object for export\n        currentViewedReportData: null, // Store current report data for export\n\n        // Report limit tracking\n        isReportLimitReached: false,\n        reportsUsed: 0,\n        reportsLimit: 0,\n        reportsRemaining: 0,\n        reportEligibilityChecked: false,\n        init: function(config) {\n            var self = this;\n\n            // Handle both object config and legacy positional params.\n            var authenticated, isFreePlan, backendUrl;\n            if (config && typeof config === 'object' && !Array.isArray(config)) {\n                authenticated = config.authenticated !== false;\n                isFreePlan = config.isFreePlan !== false;\n                backendUrl = config.backendUrl || this.backendUrl;\n            } else {\n                // Legacy: init(authenticated, isFreePlan)\n                authenticated = config !== false;\n                isFreePlan = arguments[1] !== false;\n                backendUrl = this.backendUrl;\n            }\n\n            this.isFreePlan = isFreePlan;\n            this.authenticated = authenticated;\n            if (backendUrl) {\n                this.backendUrl = backendUrl;\n            }\n            if (this._initCalled) {\n return;\n}\n            this._initCalled = true;\n            this.currentChatId = 0;\n\n            // Get the specific AI Assistant container by ID (more reliable than sibling selection)\n            var getAssistantContainer = function() {\n                return $('#adeptus-assistant-container');\n            };\n            getAssistantContainer().hide();\n\n            // Initialize loader CSS styles on startup\n            this.initializeLoaderStyles();\n\n            // Load language strings first, then initialize\n            loadStrings().then(function() {\n                self._initAfterStrings(getAssistantContainer);\n            }).catch(function() {\n                // Fallback: continue without strings (will use fallbacks)\n                self._initAfterStrings(getAssistantContainer);\n            });\n        },\n\n        _initAfterStrings: function(getAssistantContainer) {\n            var self = this;\n            // Initialize authentication system\n            try {\n                // Check if user is authenticated\n                if (AuthUtils.isAuthenticated()) {\n                    var authStatus = AuthUtils.getAuthStatus();\n                    var userName = (authStatus && authStatus.user && authStatus.user.name) || 'User';\n                    this.setUserName(userName);\n                    this.updateSubscriptionInfo();\n                    this.setupEventListeners();\n                    this.loadChatHistory();\n                    this.loadReportsHistory();\n                    this.loadCategories(); // Load report categories for save dialog\n                    this.checkReportEligibility(); // Check report limits on startup\n                    getAssistantContainer().fadeIn(200);\n                } else {\n                    // Try to refresh authentication\n                    AuthUtils.refreshAuthStatus();\n\n                    // Check authentication status after refresh\n                    setTimeout(function() {\n                        if (AuthUtils.isAuthenticated()) {\n                            var authStat = AuthUtils.getAuthStatus();\n                            var uName = (authStat && authStat.user && authStat.user.name) || 'User';\n                            self.setUserName(uName);\n                            self.updateSubscriptionInfo();\n                            self.setupEventListeners();\n                            self.loadChatHistory();\n                            self.loadReportsHistory();\n                            self.loadCategories();\n                            self.checkReportEligibility();\n                            getAssistantContainer().fadeIn(200);\n                        } else {\n                            // Show read-only mode or error message\n                            self.showAuthenticationError();\n                        }\n                    }, 500);\n                }\n            } catch (error) {\n                // Fallback to basic initialization\n                this.setupEventListeners();\n                this.checkReportEligibility(); // Check report limits even on fallback\n                getAssistantContainer().fadeIn(200);\n            }\n        },\n\n        initializeLoaderStyles: function() {\n            // Add loader CSS styles early to ensure they're available\n            if ($('#ai-loader-styles').length === 0) {\n                var loaderCss = '<style id=\"ai-loader-styles\">' +\n                    '.adeptus-ai-thinking-loader-wrapper {' +\n                    'animation: fadeInLoader 0.3s ease-out forwards;' +\n                    '}' +\n                    '.adeptus-ai-thinking-loader {' +\n                    'opacity: 1 !important;' +\n                    '}' +\n                    '@keyframes bounce-loader {' +\n                    '0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }' +\n                    '40% { transform: scale(1.2); opacity: 1; }' +\n                    '}' +\n                    '@keyframes fadeInLoader {' +\n                    'from { opacity: 0; transform: translateY(10px); }' +\n                    'to { opacity: 1; transform: translateY(0); }' +\n                    '}' +\n                    '@keyframes pulse-glow-loader {' +\n                    '0% { box-shadow: 0 0 0 0 rgba(14, 165, 233, 0.4); }' +\n                    '70% { box-shadow: 0 0 0 8px rgba(14, 165, 233, 0); }' +\n                    '100% { box-shadow: 0 0 0 0 rgba(14, 165, 233, 0); }' +\n                    '}' +\n                    '</style>';\n                $('head').append(loaderCss);\n            }\n        },\n\n        showAuthenticationError: function() {\n            // Show authentication error message in the AI Assistant container\n            var assistantContainer = $('#adeptus-assistant-container');\n            var authReqTitle = getString('authentication_required', 'Authentication Required');\n            var authReqMsg = getString('auth_required_message',\n                'You need to be authenticated to use the AI Assistant. Please contact your administrator.');\n            var refreshBtn = getString('refresh_page', 'Refresh Page');\n            assistantContainer.html(\n                '<div class=\"alert alert-danger\">' +\n                '<h4>' + authReqTitle + '</h4>' +\n                '<p>' + authReqMsg + '</p>' +\n                '<button class=\"btn btn-primary\" onclick=\"location.reload()\">' + refreshBtn + '</button>' +\n                '</div>'\n            ).show();\n        },\n\n        setupEventListeners: function() {\n            var self = this;\n\n            // Send message\n            $('#send-button').on('click', function() {\n                self.sendMessage();\n            });\n            $('#message-input').on('keydown', function(e) {\n                if (e.key === 'Enter' && !e.shiftKey) {\n                    e.preventDefault();\n                    self.sendMessage();\n                }\n            });\n\n            // Chart type change\n            $('#chart-type').on('change', function() {\n                self.updateChart();\n            });\n\n            // Auto-resize textarea\n            $('#message-input').on('input', function() {\n                this.style.height = 'auto';\n                this.style.height = (this.scrollHeight) + 'px';\n            });\n\n            $('#create-new-chat').on('click', function() {\n                self.createNewChat();\n            });\n        },\n\n        clearMCQ: function() {\n            this.currentMCQ = null;\n            $('#adeptus-mcq-container').empty().hide();\n            // Re-enable text input and send button\n            $('#message-input').prop('disabled', false);\n            $('#send-button').prop('disabled', false);\n        },\n\n        /**\n         * Extract MCQ data from message text (handles both JSON array and individual JSON objects)\n         * @param text\n         */\n        extractMCQFromText: function(text) {\n            if (!text || typeof text !== 'string') {\n                return null;\n            }\n\n            try {\n                // Try to parse as JSON array first (e.g., ```json [...] ```)\n                var jsonArrayMatch = text.match(/```json\\s*(\\[[\\s\\S]*?\\])\\s*```/);\n                if (jsonArrayMatch) {\n                    var parsedQuestions = JSON.parse(jsonArrayMatch[1]);\n                    if (Array.isArray(parsedQuestions) && parsedQuestions.length > 0 &&\n                        parsedQuestions[0].type === 'mcq') {\n                        return {questions: parsedQuestions, selectedAnswer: null};\n                    }\n                }\n\n                // Try to extract individual JSON objects (fallback for older format)\n                var jsonMatches = text.match(/\\{[\\s\\S]*?\\}/g) || [];\n                var questions = [];\n                jsonMatches.forEach(function(jsonStr) {\n                    try {\n                        var obj = JSON.parse(jsonStr);\n                        if (obj.type === 'mcq' && Array.isArray(obj.options)) {\n                            questions.push(obj);\n                        }\n                    } catch (parseErr) {\n                        // Skip invalid JSON\n                        void parseErr;\n                    }\n                });\n\n                if (questions.length > 0) {\n                    return {questions: questions, selectedAnswer: null};\n                }\n            } catch (err) {\n                void err;\n            }\n\n            return null;\n        },\n\n        /**\n         * Render MCQ history view (disabled, showing selected answer if available)\n         * @param {Array} questions - Array of MCQ questions\n         * @param {string} selectedAnswer - The selected answer if any\n         * @returns {string} HTML string\n         */\n        renderMCQHistory: function(questions, selectedAnswer) {\n            selectedAnswer = selectedAnswer || null;\n            var html = '<div class=\"adeptus-mcq-history-container\" ' +\n                'style=\"display:flex; flex-direction:column; gap:15px;\">';\n\n            questions.forEach(function(mcq, idx) {\n                html += '<div class=\"adeptus-mcq-history-item\" ' +\n                    'style=\"background:#f8f9fa; padding:15px; border-radius:8px; ' +\n                    'border:1px solid #dee2e6; box-shadow:0 1px 3px rgba(0,0,0,0.05);\">' +\n                    '<p style=\"font-weight:600; margin-bottom:12px; color:#333; font-size:14px;\">' +\n                    '<i class=\"fa fa-question-circle\" style=\"color:#007bff; margin-right:8px;\"></i>' +\n                    mcq.question + '</p>' +\n                    '<div class=\"adeptus-mcq-options\" style=\"margin-left:24px;\">';\n\n                mcq.options.forEach(function(option) {\n                    var optionText = typeof option === 'string' ? option : (option.label || option);\n                    var isSelected = selectedAnswer && (selectedAnswer === option ||\n                        selectedAnswer === optionText ||\n                        (selectedAnswer.indexOf && selectedAnswer.indexOf(optionText) !== -1));\n                    var selectedStyle = isSelected ?\n                        'background:#e3f0ff; border:2px solid #007bff; font-weight:600;' :\n                        'border:1px solid #ced4da;';\n                    var selectedIcon = isSelected ?\n                        '<i class=\"fa fa-check-circle\" style=\"color:#28a745; margin-right:5px;\"></i>' : '';\n                    var checkedAttr = isSelected ? 'checked' : '';\n\n                    html += '<div class=\"form-check\" style=\"padding:10px 14px; border-radius:6px; ' +\n                        'margin-bottom:8px; ' + selectedStyle + ' transition:all 0.2s;\">' +\n                        '<input class=\"form-check-input\" type=\"radio\" name=\"mcq-' + idx + '\" ' +\n                        'disabled ' + checkedAttr + ' style=\"margin-top:0.3em;\">' +\n                        '<label class=\"form-check-label\" style=\"color:#555; cursor:not-allowed; ' +\n                        'margin-left:5px;\">' + selectedIcon + optionText + '</label></div>';\n                });\n\n                html += '</div>' +\n                    '<p style=\"margin-top:12px; margin-bottom:0; font-size:11px; color:#6c757d; ' +\n                    'font-style:italic;\">' +\n                    '<i class=\"fa fa-info-circle\" style=\"margin-right:4px;\"></i>' +\n                    'Previous question from chat history</p></div>';\n            });\n\n            html += '</div>';\n            return html;\n        },\n\n        checkAuth: function() {\n            if (!AuthUtils.isAuthenticated()) {\n                this.showAuthenticationError();\n                return false;\n            } else {\n                this.loadChatHistory();\n                return true;\n            }\n        },\n\n        handleResponse: function(response) {\n            // Route responses based on type\n            if (response.error) {\n                // Handle token/credit limit errors specifically\n                if (response.error_type === 'credit_limit' || response.error_type === 'token_limit') {\n                    this.handleCreditLimitError(response.message);\n                    return;\n                }\n                // Handle report limit errors (cumulative, no monthly reset)\n                if (response.error_type === 'report_limit') {\n                    this.handleReportLimitError(response.message);\n                    return;\n                }\n                // Error bubble from backend\n                this.addMessage(response.message, 'error');\n                // Show resend icon on the last user message\n                this.showResendIconOnLastUserMessage();\n            } else if (response.type === 'mcq') {\n                // Add MCQ as AI message first\n                if (response.questions && response.questions.length > 0) {\n                    const firstQuestion = response.questions[0];\n                    const mcqText = `Question: ${firstQuestion.question}\\nOptions: ${firstQuestion.options.join(', ')}`;\n                    this.addMessage(mcqText, 'ai', false, null, null, null, response.credit_info);\n                }\n                // Show multiple-choice question\n                this.enqueueMCQs(response.questions);\n                return;\n            } else if (response.type === 'sql' || response.type === 'report') {\n                // Handle report generation with confirmation workflow\n                if (response.awaiting_confirmation && response.report) {\n                    // Get SQL from response - check multiple possible locations\n                    // New API: response.sql (top level) or response.report.sql_query\n                    // Legacy: response.report.sql\n                    const sqlQuery = response.sql || response.report.sql_query || response.report.sql;\n\n                    // Check if local execution is required (SaaS model - data stays on customer server)\n                    if ((response.execution_required || !response.report_data) && sqlQuery) {\n                        // Execute SQL locally before showing confirmation\n                        this.executeReportLocally(sqlQuery, response.report.params || {})\n                            .then((executionResult) => {\n                                // Show report confirmation with locally executed data\n                                this.showReportConfirmation(\n                                    response.report,\n                                    executionResult.data || null,\n                                    response.message,\n                                    response.credit_info,\n                                    executionResult.error || null\n                                );\n                            })\n                            .catch((error) => {\n                                // Show confirmation with execution error\n                                this.showReportConfirmation(\n                                    response.report,\n                                    null,\n                                    response.message,\n                                    response.credit_info,\n                                    error.message || 'Failed to execute report locally'\n                                );\n                            });\n                        return;\n                    }\n\n                    // Backend already executed (legacy) or no execution needed\n                    // Show report data first, then confirmation prompt\n                    this.showReportConfirmation(\n                        response.report,\n                        response.report_data || null,\n                        response.message,\n                        response.credit_info,\n                        response.execution_error || null\n                    );\n                    return;\n                }\n                // Legacy handling for direct report generation\n                const reportData = response.report || response;\n                this.addMessage(reportData.description || response.message, 'ai', true, reportData, null, null, response.credit_info);\n                this.updateChatHistoryBadge(this.currentChatId);\n                // Update cache and UI directly\n                this.cachedReports.unshift(reportData);\n                this.updateReportsHistory(this.cachedReports);\n                // Reinitialize DataTable for updated history\n                if (this.reportsDataTable) {\n                    this.reportsDataTable.destroy();\n                    this.reportsDataTable = null;\n                }\n\n                // Wait for DOM to be updated before reinitializing DataTable\n                setTimeout(() => {\n                    try {\n                        const tableElement = document.getElementById('reports-history-table');\n                        if (tableElement) {\n                            const thead = tableElement.querySelector('thead');\n                            const tbody = tableElement.querySelector('tbody');\n\n                            if (thead && tbody && thead.rows.length > 0 && thead.rows[0].cells.length > 0) {\n                                const headerCells = thead.rows[0].cells.length;\n                                const dataRows = tbody.rows;\n                                let dataCells = 0;\n\n                                if (dataRows.length > 0) {\n                                    dataCells = dataRows[0].cells.length;\n                                }\n\n                                if (headerCells === dataCells && headerCells > 0) {\n                                    // Only initialize DataTable if we have actual data rows (not just empty state)\n                                    if (dataRows.length > 0 && !dataRows[0].cells[0].textContent.includes('No reports')) {\n                this.reportsDataTable = new simpleDatatables.DataTable(\"#reports-history-table\", {\n                    searchable: true,\n                    fixedHeight: false,\n                    perPage: 10,\n                    loading: false // Disable loading indicator\n                });\n                                        // Remove the loading class from the wrapper\n                                        setTimeout(() => {\n                                            $('.datatable-wrapper').removeClass('datatable-loading');\n                                            $('#report-history-table-wrapper .datatable-wrapper').removeClass('datatable-loading');\n                                        }, 100);\n                                    }\n                                }\n                            }\n                        }\n                    } catch (error) {\n                        // DataTable reinitialization failed silently.\n                    }\n                }, 100);\n                // Show SweetAlert loader for report generation\n                Swal.fire({\n                    title: getString('generating_report', 'Generating Report'),\n                    html: `\n                        <div class=\"text-center\">\n                            <div class=\"spinner-border text-primary mb-3\" role=\"status\">\n                            </div>\n                            <p>${getString('please_wait', 'Please wait')}...</p>\n                        </div>\n                    `,\n                    showConfirmButton: false,\n                    allowOutsideClick: false,\n                    allowEscapeKey: false,\n                    timer: 2000,\n                    timerProgressBar: true\n                }).then(() => {\n                    this.switchToReportsTab();\n                    this.displayCurrentReport(response.report);\n                    // Automatically execute the report\n                    this.executeReport(response.report.slug);\n                });\n                return;\n            } else {\n                // Normal AI or SQL response\n                this.addMessage(response.message, 'ai', false, null, null, null, response.credit_info);\n            }\n\n            // Update report data if available\n            if (response.data) {\n                this.updateReportData(response.data);\n            }\n\n            // Update visualizations if available\n            if (response.visualizations) {\n                this.updateVisualizations(response.visualizations);\n            }\n\n            // Show immediate credit usage feedback if available\n            if (response.credit_info) {\n                this.showCreditUsageFeedback(response.credit_info);\n            }\n\n            this.scrollToBottom();\n        },\n\n        /**\n         * Show immediate credit usage feedback\n         * @param creditInfo\n         */\n        showCreditUsageFeedback: function(creditInfo) {\n            if (!creditInfo) {\n return;\n}\n\n            // Create a temporary notification for credit usage\n            const notification = $(`\n                <div class=\"adeptus-credit-usage-notification\" style=\"\n                    position: fixed;\n                    top: 20px;\n                    right: 20px;\n                    background: #28a745;\n                    color: white;\n                    padding: 12px 20px;\n                    border-radius: 6px;\n                    box-shadow: 0 4px 12px rgba(0,0,0,0.15);\n                    z-index: 9999;\n                    font-size: 14px;\n                    font-weight: 500;\n                    opacity: 0;\n                    transform: translateX(100%);\n                    transition: all 0.3s ease;\n                \">\n                    <i class=\"fa fa-coins me-2\"></i>\n                    <span class=\"adeptus-credit-text\">Credits used: ${creditInfo.credits_charged || 0} (${creditInfo.credit_type || 'basic'})</span>\n                </div>\n            `);\n\n            // Add to body\n            $('body').append(notification);\n\n            // Animate in\n            setTimeout(() => {\n                notification.css({\n                    'opacity': '1',\n                    'transform': 'translateX(0)'\n                });\n            }, 100);\n\n            // Animate out and remove after 3 seconds\n            setTimeout(() => {\n                notification.css({\n                    'opacity': '0',\n                    'transform': 'translateX(100%)'\n                });\n                setTimeout(() => {\n                    notification.remove();\n                }, 300);\n            }, 3000);\n\n            // Also update the subscription info immediately\n            this.updateSubscriptionInfoWithCreditUsage(creditInfo);\n        },\n\n        /**\n         * Update subscription info with immediate credit usage\n         * @param creditInfo\n         */\n        updateSubscriptionInfoWithCreditUsage: function(creditInfo) {\n            const authStatus = AuthUtils.getAuthStatus();\n            if (!authStatus || !authStatus.subscription) {\n return;\n}\n\n            const subscription = authStatus.subscription;\n            const creditsUsed = creditInfo.credits_charged || 0;\n\n            // Update the credit counters immediately\n            if (creditInfo.credit_type === 'premium') {\n                subscription.premium_credits_used_this_month = (subscription.premium_credits_used_this_month || 0) + creditsUsed;\n            } else {\n                subscription.basic_credits_used_this_month = (subscription.basic_credits_used_this_month || 0) + creditsUsed;\n            }\n\n            // Update total AI credits\n            subscription.ai_credits_used_this_month = (subscription.ai_credits_used_this_month || 0) + creditsUsed;\n\n            // Animate the counter updates\n            this.animateCreditCounterUpdate(creditInfo.credit_type, creditsUsed);\n\n            // Update the display\n            this.updateSubscriptionInfo();\n        },\n\n        /**\n         * Animate credit counter updates\n         * @param creditType\n         */\n        animateCreditCounterUpdate: function(creditType) {\n            const counterClass = creditType === 'premium' ? '.premium-credits-counter' : '.basic-credits-counter';\n            const $counter = $(counterClass);\n\n            if ($counter.length) {\n                // Add highlight animation\n                $counter.addClass('adeptus-credit-update-highlight');\n\n                // Remove highlight after animation\n                setTimeout(() => {\n                    $counter.removeClass('adeptus-credit-update-highlight');\n                }, 1000);\n            }\n\n            // Also animate total credits counter\n            const $totalCounter = $('.adeptus-total-credits-counter');\n            if ($totalCounter.length) {\n                $totalCounter.addClass('adeptus-credit-update-highlight');\n                setTimeout(() => {\n                    $totalCounter.removeClass('adeptus-credit-update-highlight');\n                }, 1000);\n            }\n        },\n\n        addMessage: function(text, type, isReportLink = false, reportData = null, messageId = null, timestamp = null, creditInfo = null) {\n            // Filter out \"Confidence: X%\" from AI messages as it's not useful for users\n            if (type === 'ai' && text) {\n                text = text.replace(/\\nConfidence:\\s*\\d+%\\n?/gi, '\\n').replace(/Confidence:\\s*\\d+%/gi, '').trim();\n            }\n\n            const template = document.getElementById('message-template');\n            const frag = template.content.cloneNode(true);\n            const messageEl = frag.querySelector('.adeptus-message');\n            messageEl.classList.add('adeptus-' + type + '-message');\n            if (messageId) {\n                messageEl.setAttribute('data-message-id', messageId);\n            }\n\n            // Check if message contains MCQ JSON\n            const mcqData = this.extractMCQFromText(text);\n\n            if (mcqData && mcqData.questions.length > 0) {\n                // Render as disabled MCQ view\n                const mcqHtml = this.renderMCQHistory(mcqData.questions, mcqData.selectedAnswer);\n                frag.querySelector('.adeptus-message-text').innerHTML = mcqHtml;\n            } else if (isReportLink && reportData) {\n                // Create a clickable report link\n                frag.querySelector('.adeptus-message-text').innerHTML = `\n                    <a href=\"javascript:void(0)\"\n                       class=\"adeptus-report-link\"\n                       data-report-slug=\"${reportData.slug}\"\n                       style=\"color: #007bff; text-decoration: none; cursor:pointer; padding:4px 8px; border:1px solid #dee2e6; border-radius:4px; background:#f8f9fa; display:inline-block; transition:all 0.2s;\">\n                        ðŸ“Š ${text}\n                    </a>\n                `;\n                const self = this;\n                setTimeout(() => {\n                    const link = messageEl.querySelector('.adeptus-report-link');\n                    link.onclick = function() {\n self.openReportFromLink(link.getAttribute('data-report-slug'));\n};\n                    link.onmouseenter = function() {\n $(this).css({'background-color': '#e9ecef', 'border-color': '#adb5bd', 'transform': 'translateY(-1px)'});\n};\n                    link.onmouseleave = function() {\n $(this).css({'background-color': '#f8f9fa', 'border-color': '#dee2e6', 'transform': 'translateY(0)'});\n};\n                }, 0);\n            } else if (type === 'report-preview' || type === 'system-action') {\n                // Render HTML content directly for report previews and system actions\n                frag.querySelector('.adeptus-message-text').innerHTML = text;\n                // Remove the message bubble styling for these types\n                messageEl.classList.add('adeptus-' + type + '-message');\n                if (type === 'report-preview') {\n                    messageEl.style.background = 'transparent';\n                    messageEl.style.padding = '0';\n                    messageEl.style.border = 'none';\n                    messageEl.style.maxWidth = '100%';\n                } else if (type === 'system-action') {\n                    messageEl.style.background = 'transparent';\n                    messageEl.style.padding = '0';\n                    messageEl.style.border = 'none';\n                    messageEl.style.maxWidth = '100%';\n                }\n            } else {\n                // Check if this is a multiple choice question from AI\n                if (type === 'ai' && this.isMultipleChoiceQuestion(text)) {\n                    const mcqHtml = this.renderMultipleChoiceOptions(text);\n                    frag.querySelector('.adeptus-message-text').innerHTML = mcqHtml;\n                } else {\n                    frag.querySelector('.adeptus-message-text').textContent = text;\n                }\n            }\n\n            // Add credit information for AI messages\n            if (type === 'ai' && creditInfo) {\n                this.addCreditInfoToMessage(frag, creditInfo);\n            }\n\n            const timeEl = frag.querySelector('.adeptus-message-time');\n            timeEl.textContent = this.formatTimestamp(timestamp || new Date().toISOString());\n            $('#adeptus-chat-container').append(frag);\n            this.scrollToBottom();\n            return $(messageEl);\n        },\n\n        addCreditInfoToMessage: function(frag, creditInfo) {\n            const messageEl = frag.querySelector('.adeptus-message');\n            const creditBadge = document.createElement('div');\n            creditBadge.className = 'adeptus-credit-info-badge';\n            creditBadge.style.cssText = `\n                display: inline-block;\n                margin-left: 8px;\n                padding: 2px 6px;\n                border-radius: 12px;\n                font-size: 11px;\n                font-weight: 500;\n                text-transform: uppercase;\n                letter-spacing: 0.5px;\n            `;\n\n            // Set badge color and text based on credit type\n            if (creditInfo.credit_type === 'premium') {\n                creditBadge.style.backgroundColor = '#6f42c1';\n                creditBadge.style.color = 'white';\n                creditBadge.textContent = 'Premium';\n            } else {\n                creditBadge.style.backgroundColor = '#28a745';\n                creditBadge.style.color = 'white';\n                creditBadge.textContent = 'Basic';\n            }\n\n            // Add tooltip with detailed information\n            creditBadge.title = `${creditInfo.credit_type.toUpperCase()} Response\\nTokens: ${creditInfo.tokens_used}\\nCredits: ${creditInfo.credits_charged}\\nProvider: ${creditInfo.provider}`;\n\n            // Insert after message text\n            const messageText = messageEl.querySelector('.adeptus-message-text');\n            messageText.appendChild(creditBadge);\n        },\n\n        /**\n         * Check if the message contains multiple choice options\n         * @param text\n         */\n        isMultipleChoiceQuestion: function(text) {\n            // Look for pattern like \"A. option\" or \"A) option\" or \"1. option\" with at least 2 options\n            const letterPattern = /^[A-Z][\\.\\)]\\s+.+$/gmi;\n            const numberPattern = /^[1-9][0-9]*[\\.\\)]\\s+.+$/gm;\n            const letterMatches = text.match(letterPattern);\n            const numberMatches = text.match(numberPattern);\n\n\n            // Check if we have consecutive letters or consecutive numbers\n            if (letterMatches && letterMatches.length >= 2) {\n                // Check if options are consecutive (A, B, C...)\n                const letters = letterMatches.map(m => m.match(/^([A-Z])/i)[1].toUpperCase());\n                const firstLetter = letters[0].charCodeAt(0);\n                let isConsecutive = true;\n                for (let i = 1; i < Math.min(letters.length, 4); i++) {\n                    if (letters[i].charCodeAt(0) !== firstLetter + i) {\n                        isConsecutive = false;\n                        break;\n                    }\n                }\n                return isConsecutive;\n            }\n\n            if (numberMatches && numberMatches.length >= 2) {\n                // Check if options are consecutive (1, 2, 3...)\n                const numbers = numberMatches.map(m => parseInt(m.match(/^([0-9]+)/)[1]));\n                let isConsecutive = true;\n                for (let i = 1; i < Math.min(numbers.length, 4); i++) {\n                    if (numbers[i] !== numbers[0] + i) {\n                        isConsecutive = false;\n                        break;\n                    }\n                }\n                return isConsecutive;\n            }\n\n            return false;\n        },\n\n        /**\n         * Render multiple choice options as clickable buttons\n         * @param text\n         */\n        renderMultipleChoiceOptions: function(text) {\n            const self = this;\n\n            // Split the text into question and options\n            const lines = text.split('\\n');\n            let questionText = [];\n            let options = [];\n\n            lines.forEach(line => {\n                const trimmedLine = line.trim();\n                // Check if line is an option (A., B., C., D. or A), B), C), D) or 1., 2., etc.)\n                const letterMatch = trimmedLine.match(/^([A-Z])[\\.\\)]\\s+(.+)$/i);\n                const numberMatch = trimmedLine.match(/^([1-9][0-9]*)[\\.\\)]\\s+(.+)$/);\n\n                if (letterMatch) {\n                    options.push({\n                        letter: letterMatch[1].toUpperCase(),\n                        text: letterMatch[2].trim(),\n                        isLetter: true\n                    });\n                } else if (numberMatch) {\n                    options.push({\n                        letter: numberMatch[1],\n                        text: numberMatch[2].trim(),\n                        isLetter: false\n                    });\n                } else if (trimmedLine) {\n                    questionText.push(trimmedLine);\n                }\n            });\n\n            // Build the HTML\n            let html = '<div class=\"adeptus-mcq-question-container\">';\n\n            // Add the question text\n            html += '<div class=\"adeptus-mcq-question-text\" style=\"margin-bottom: 15px; white-space: pre-wrap;\">';\n            html += this.escapeHtml(questionText.join('\\n'));\n            html += '</div>';\n\n            // Add the options as buttons\n            if (options.length > 0) {\n                html += '<div class=\"adeptus-mcq-options-grid\" style=\"display: grid; gap: 10px; grid-template-columns: 1fr;\">';\n\n                options.forEach(option => {\n                    const optionId = 'adeptus-mcq-option-' + Date.now() + '-' + option.letter;\n                    html += `\n                        <button class=\"adeptus-mcq-option-button\"\n                                data-option=\"${option.letter}\"\n                                id=\"${optionId}\"\n                                style=\"\n                                    padding: 12px 16px;\n                                    display: flex;\n                                    align-items: center;\n                                    gap: 12px;\n                                    font-size: 14px;\n                                    line-height: 1.5;\n                                    color: #333;\n                                    min-height: 50px;\n                                \">\n                            <span class=\"adeptus-mcq-option-letter\" style=\"\n                                background: linear-gradient(135deg, #0ea5e9 0%, #2563eb 100%);\n                                color: white;\n                                width: 32px;\n                                height: 32px;\n                                border-radius: 50%;\n                                display: flex;\n                                align-items: center;\n                                justify-content: center;\n                                font-weight: bold;\n                                flex-shrink: 0;\n                            \">${option.letter}</span>\n                            <span class=\"adeptus-mcq-option-text\" style=\"flex: 1;\">${this.escapeHtml(option.text)}</span>\n                        </button>\n                    `;\n                });\n\n                html += '</div>';\n            }\n\n            html += '</div>';\n\n            // Attach click handlers after DOM insertion\n            setTimeout(() => {\n                const container = document.querySelector('#adeptus-chat-container');\n                const latestButtons = container.querySelectorAll('.adeptus-mcq-option-button:not([data-handler-attached])');\n\n                latestButtons.forEach(button => {\n                    button.setAttribute('data-handler-attached', 'true');\n                    button.addEventListener('click', function() {\n                        // Prevent if already disabled\n                        if (this.disabled) {\n return;\n}\n\n                        const selectedOption = this.getAttribute('data-option');\n                        const selectedText = options.find(o => o.letter === selectedOption);\n\n                        // Disable all buttons in this question to prevent double-clicking\n                        const parentContainer = this.closest('.adeptus-mcq-question-container');\n                        const allButtons = parentContainer.querySelectorAll('.adeptus-mcq-option-button');\n\n                        allButtons.forEach(btn => {\n                            btn.disabled = true;\n                            btn.classList.add('disabled');\n                        });\n\n                        // Highlight selected option\n                        this.classList.add('selected');\n\n                        // Add checkmark to selected option\n                        const letterSpan = this.querySelector('.adeptus-mcq-option-letter');\n                        letterSpan.innerHTML = 'âœ“';\n\n                        // Format and send the answer\n                        let answer;\n                        if (selectedText.isLetter !== false) {\n                            // Letter option: send full text for clarity\n                            answer = `${selectedOption}. ${selectedText.text}`;\n                        } else {\n                            // Number option: send full text\n                            answer = `${selectedOption}. ${selectedText.text}`;\n                        }\n\n                        // Send the answer (this will show it as a user message)\n                        self.sendMessage(answer);\n                    });\n                });\n            }, 100);\n\n            return html;\n        },\n\n        /**\n         * Escape HTML to prevent XSS\n         * @param text\n         */\n        escapeHtml: function(text) {\n            const map = {\n                '&': '&amp;',\n                '<': '&lt;',\n                '>': '&gt;',\n                '\"': '&quot;',\n                \"'\": '&#039;'\n            };\n            return text.replace(/[&<>\"']/g, m => map[m]);\n        },\n\n        handleCreditLimitError: function(message, creditData = null) {\n            // Update subscription data with latest credit information from API response\n            if (creditData && creditData.summary) {\n                this.updateSubscriptionDataFromCreditResponse(creditData);\n            }\n\n            // Set credit limit exceeded flag to disable send button\n            this.isCreditLimitExceeded = true;\n            this.updateSendMessageandCreateNewChatButton();\n\n            // Show persistent credit limit message at the top\n            this.showPersistentCreditLimitMessage(message);\n\n            // Show user-friendly credit limit error in chat\n            this.addMessage(message, 'error');\n\n            // Show upgrade prompt\n            Swal.fire({\n                icon: 'warning',\n                title: getString('token_limit_reached', 'Token Limit Reached'),\n                html: `\n                    <div class=\"text-center\">\n                        <p>${message}</p>\n                        <p class=\"text-muted\">${getString('monthly_allowance_used', 'Your monthly token allowance has been used up.')}</p>\n                        <p class=\"text-muted\">${getString('tokens_reset_monthly', 'Tokens reset on the 1st of each month.')}</p>\n                    </div>\n                `,\n                showCancelButton: true,\n                confirmButtonText: getString('view_usage', 'View Usage'),\n                cancelButtonText: getString('close', 'Close'),\n                confirmButtonColor: '#007bff'\n            }).then((result) => {\n                if (result.isConfirmed) {\n                    this.showCreditUsageModal();\n                }\n            });\n        },\n\n        /**\n         * Check report creation eligibility with the backend\n         * Backend is the single source of truth for report limits\n         */\n        checkReportEligibility: async function() {\n            var self = this;\n            try {\n                var promises = Ajax.call([{\n                    methodname: 'report_adeptus_insights_check_report_eligibility',\n                    args: {}\n                }]);\n\n                var result = await promises[0];\n                var data = result.data ? result.data : result;\n\n                // Update internal state\n                self.reportsUsed = data.reports_used || 0;\n                self.reportsLimit = data.reports_limit || 0;\n                self.reportsRemaining = data.reports_remaining || 0;\n                self.isReportLimitReached = !data.eligible;\n                self.reportEligibilityChecked = true;\n\n                // Update UI to reflect current state\n                self.updateReportLimitUI();\n\n                return data;\n            } catch (error) {\n                // Fail closed - assume limit reached on error\n                self.isReportLimitReached = true;\n                self.reportEligibilityChecked = true;\n                self.updateReportLimitUI();\n                return {success: false, eligible: false, message: 'Unable to verify eligibility'};\n            }\n        },\n\n        /**\n         * Track AI-generated report creation with the backend\n         * @param reportName\n         */\n        trackReportCreated: async function(reportName) {\n            var self = this;\n            try {\n                var promises = Ajax.call([{\n                    methodname: 'report_adeptus_insights_track_report_created',\n                    args: {\n                        report_name: reportName,\n                        is_ai_generated: true\n                    }\n                }]);\n\n                var result = await promises[0];\n                var data = result.data ? result.data : result;\n\n                if (data.success && !data.tracking_error) {\n                    // Update internal state with new counts\n                    self.reportsUsed = data.reports_used || self.reportsUsed;\n                    self.reportsLimit = data.reports_limit || self.reportsLimit;\n                    self.reportsRemaining = data.reports_remaining || self.reportsRemaining;\n                    self.isReportLimitReached = self.reportsRemaining <= 0 && self.reportsLimit !== -1;\n                    self.updateReportLimitUI();\n                }\n\n                return data;\n            } catch (error) {\n                // Tracking failed but report was created.\n                return {success: true, tracking_error: true};\n            }\n        },\n\n        /**\n         * Handle report limit reached error\n         * @param message\n         */\n        handleReportLimitError: function(message) {\n            this.isReportLimitReached = true;\n            this.updateReportLimitUI();\n\n            // Show user-friendly report limit error in chat\n            this.addMessage(message || getString('report_limit_message', 'You have reached your report limit. Delete existing reports or upgrade your plan.'), 'error');\n\n            // Show upgrade prompt\n            Swal.fire({\n                icon: 'warning',\n                title: getString('report_limit_reached', 'Report Limit Reached'),\n                html: `\n                    <div class=\"text-center\">\n                        <p>${message || getString('report_limit_reached', 'You have reached your report limit.')}</p>\n                        <p class=\"text-muted\">${getString('used_of_reports', 'You have used ' + this.reportsUsed + ' of ' + this.reportsLimit + ' reports.').replace('{$a->used}', this.reportsUsed).replace('{$a->limit}', this.reportsLimit)}</p>\n                        <p class=\"text-muted\">${getString('delete_reports_or_upgrade', 'Delete existing reports to free up slots or upgrade your plan.')}</p>\n                    </div>\n                `,\n                showCancelButton: true,\n                confirmButtonText: getString('view_reports', 'View Reports'),\n                cancelButtonText: getString('close', 'Close'),\n                confirmButtonColor: '#007bff'\n            }).then((result) => {\n                if (result.isConfirmed) {\n                    // Switch to reports tab to manage reports\n                    this.switchTab('reports');\n                }\n            });\n        },\n\n        /**\n         * Update UI elements based on report limit state\n         */\n        updateReportLimitUI: function() {\n            const isUnlimited = this.reportsLimit === -1;\n\n            if (this.isReportLimitReached && !isUnlimited) {\n                // Disable send button and input\n                $('#send-button').prop('disabled', true).addClass('disabled');\n                $('#message-input').prop('disabled', true).attr('placeholder', getString('report_limit_placeholder', 'Report limit reached. Delete reports or upgrade to continue.'));\n\n                // Show persistent report limit message\n                if (!$('#report-limit-banner').length) {\n                    const banner = $(`\n                        <div id=\"report-limit-banner\" class=\"alert alert-warning mb-2\" style=\"margin: 10px; border-radius: 8px;\">\n                            <i class=\"fa-solid fa-exclamation-triangle\"></i>\n                            <strong>${getString('report_limit_reached_banner', 'Report limit reached!')}</strong> ${getString('used_of_reports', 'You have used ' + this.reportsUsed + ' of ' + this.reportsLimit + ' reports.').replace('{$a->used}', this.reportsUsed).replace('{$a->limit}', this.reportsLimit)}\n                            <a href=\"#\" class=\"alert-link\" onclick=\"window.assistant.switchTab('reports'); return false;\">${getString('manage_reports', 'Manage reports')}</a> or\n                            <a href=\"#\" class=\"alert-link\" onclick=\"window.assistant.showUpgradePrompt(); return false;\">${getString('upgrade_plan', 'upgrade your plan')}</a>.\n                        </div>\n                    `);\n                    $('.adeptus-chat-input-area').before(banner);\n                }\n            } else {\n                // Only enable if credit limit is also not exceeded\n                if (!this.isCreditLimitExceeded) {\n                    $('#send-button').prop('disabled', false).removeClass('disabled');\n                    $('#message-input').prop('disabled', false).attr('placeholder', getString('ask_moodle_data', 'Ask me anything about your Moodle data...'));\n                }\n\n                // Remove report limit banner\n                $('#report-limit-banner').remove();\n            }\n        },\n\n        /**\n         * Show upgrade prompt for report limits\n         */\n        showUpgradePrompt: function() {\n            const limitText = this.reportsLimit === -1 ? getString('unlimited', 'Unlimited') : this.reportsLimit;\n            Swal.fire({\n                icon: 'info',\n                title: getString('upgrade_your_plan', 'Upgrade Your Plan'),\n                html: `\n                    <div class=\"text-center\">\n                        <p>${getString('unlock_features', 'Unlock more reports and features by upgrading your plan.')}</p>\n                        <p class=\"text-muted\">${getString('current_usage', 'Current usage:')} ${this.reportsUsed} / ${limitText} ${getString('reports', 'reports')}</p>\n                    </div>\n                `,\n                confirmButtonText: getString('view_plans', 'View Plans'),\n                confirmButtonColor: '#007bff'\n            });\n        },\n\n        /**\n         * Update subscription data from token limit error response\n         * @param creditData\n         */\n        updateSubscriptionDataFromCreditResponse: function(creditData) {\n            const authStatus = AuthUtils.getAuthStatus();\n            if (!authStatus || !authStatus.subscription) {\n return;\n}\n\n            const subscription = authStatus.subscription;\n\n            // Update token usage with actual data from API\n            if (creditData.tokens_used !== undefined) {\n                subscription.tokens_used = creditData.tokens_used;\n            }\n            if (creditData.tokens_limit !== undefined) {\n                subscription.tokens_limit = creditData.tokens_limit;\n            }\n            if (creditData.tokens_remaining !== undefined) {\n                subscription.tokens_remaining = creditData.tokens_remaining;\n            }\n\n            // Force refresh of auth status to persist the changes\n            AuthUtils.setAuthStatus(authStatus);\n\n            // Update the display immediately\n            this.updateSubscriptionInfo();\n        },\n\n        handleTimeoutError: function(message) {\n            // Show user-friendly timeout error\n            this.addMessage(message, 'error');\n\n            // Show retry prompt\n            Swal.fire({\n                icon: 'info',\n                title: getString('ai_service_busy', 'AI Service Busy'),\n                html: `\n                    <div class=\"text-center\">\n                        <p>${message}</p>\n                        <p class=\"text-muted\">${getString('ai_service_busy_message', 'The AI service is experiencing high demand. Please try again in a moment.')}</p>\n                    </div>\n                `,\n                showCancelButton: true,\n                confirmButtonText: getString('try_again', 'Try Again'),\n                cancelButtonText: getString('cancel', 'Cancel'),\n                confirmButtonColor: '#007bff',\n                cancelButtonColor: '#6c757d'\n            }).then((result) => {\n                if (result.isConfirmed) {\n                    // Focus on the input field for retry\n                    $('#message-input').focus();\n                }\n            });\n        },\n\n        showPersistentCreditLimitMessage: function(message) {\n            // Remove any existing limit message\n            $('.adeptus-credit-limit-alert').remove();\n\n            // Create persistent token limit message\n            const alertHtml = `\n                <div class=\"alert alert-danger adeptus-credit-limit-alert\" role=\"alert\" style=\"margin: 10px 0; border-left: 4px solid #dc3545; background-color: #f8d7da; border-color: #f5c6cb;\">\n                    <div class=\"d-flex align-items-center\">\n\n                        <div class=\"flex-grow-1\">\n                            <strong class=\"text-danger\">${getString('token_limit_reached', 'Token Limit Reached')}</strong><br>\n                            <small class=\"text-muted\">${message}</small>\n                        </div>\n                        <div class=\"ms-3\">\n                            <button type=\"button\" class=\"btn btn-sm btn-outline-danger me-2\" onclick=\"window.assistant.showCreditUsageModal()\">\n                                <i class=\"fas fa-chart-bar me-1\"></i> ${getString('view_usage', 'View Usage')}\n                            </button>\n\n                        </div>\n                    </div>\n                </div>\n            `;\n\n            // Insert at the top of the subscription header area\n            // Insert before the second occurrence of class 'main-inner'\n            var $mainInners = $('.main-inner');\n            if ($mainInners.length >= 2) {\n                $mainInners.eq(1).before(alertHtml);\n            } else if ($mainInners.length === 1) {\n                $mainInners.eq(0).before(alertHtml);\n            } else {\n                // Fallback: append to body if .main-inner not found\n                $('body').prepend(alertHtml);\n            }\n\n        },\n\n        hidePersistentCreditLimitMessage: function() {\n            $('.adeptus-credit-limit-alert').fadeOut(300, function() {\n                $(this).remove();\n            });\n        },\n\n        showCreditUsageModal: function() {\n            // Show loading modal first\n            Swal.fire({\n                title: getString('loading_usage_data', 'Loading Usage Data...'),\n                text: getString('fetching_usage_info', 'Please wait while we fetch your usage information'),\n                allowOutsideClick: false,\n                showConfirmButton: false,\n                willOpen: () => {\n                    Swal.showLoading();\n                }\n            });\n\n            // Fetch detailed usage data\n            this.ajaxWithAuth({\n                url: this.backendUrl + '/chat/credits/detailed-usage',\n                method: 'GET',\n                success: (response) => {\n                    if (response.success) {\n                        this.displayDetailedUsageModal(response.data);\n                    } else {\n                        Swal.fire(getString('error', 'Error'), getString('failed_load_usage', 'Failed to load usage information'), 'error');\n                    }\n                },\n                error: () => {\n                    Swal.fire(getString('error', 'Error'), getString('failed_load_usage', 'Failed to load usage information'), 'error');\n                }\n            });\n        },\n\n        displayDetailedUsageModal: function(data) {\n            const summary = data.summary;\n            const usage = data.usage || [];\n            const pagination = data.pagination || {total: 0};\n\n            // Helper function to format tokens\n            const formatTokens = (tokens) => {\n                if (tokens >= 1000000) {\n return (tokens / 1000000).toFixed(1) + 'M';\n}\n                if (tokens >= 1000) {\n return (tokens / 1000).toFixed(1) + 'K';\n}\n                return tokens.toString();\n            };\n\n            // Calculate usage percentage\n            const usagePercent = summary.tokens_limit > 0 && summary.tokens_remaining !== -1\n                ? Math.min(100, Math.round((summary.total_tokens_used / summary.tokens_limit) * 100))\n                : 0;\n            const limitDisplay = summary.tokens_remaining === -1 ? 'Unlimited' : formatTokens(summary.tokens_limit);\n\n            // Create the comprehensive modal HTML with optimized styling\n            const modalHtml = `\n                <div class=\"adeptus-detailed-usage-modal\" style=\"font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;\">\n                    <!-- Header with close button -->\n                    <div class=\"adeptus-usage-modal-header mb-3\" style=\"background: linear-gradient(135deg, #0f6cbf 0%, #3a8dd4 100%); padding: 16px 20px; border-radius: 10px; color: white; box-shadow: 0 2px 8px rgba(0,0,0,0.1);\">\n                        <div class=\"d-flex justify-content-between align-items-center\">\n                            <h5 class=\"mb-0\" style=\"color: white; font-weight: 600;\">\n                                <i class=\"fas fa-chart-line me-2\"></i> Token Usage Dashboard\n                            </h5>\n                            <button type=\"button\" class=\"adeptus-usage-modal-close-btn\" onclick=\"Swal.close()\" style=\"background: rgba(255,255,255,0.2); border: none; color: white; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s ease;\">\n                                <i class=\"fas fa-times\" style=\"font-size: 14px;\"></i>\n                            </button>\n                        </div>\n                    </div>\n\n                    <!-- Summary Cards with proper spacing -->\n                    <div class=\"row mb-3 g-2\">\n                        <div class=\"col-md-3\">\n                            <div class=\"card border-0 h-100\" style=\"background: linear-gradient(135deg, #0ea5e9 0%, #2563eb 100%); color: white; border-radius: 12px; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);\">\n                                <div class=\"card-body text-center\" style=\"padding: 16px 12px;\">\n                                    <h6 class=\"card-title mb-2\" style=\"font-weight: 600; opacity: 0.9; font-size: 0.85rem;\">Monthly Usage</h6>\n                                    <div class=\"d-flex align-items-center justify-content-center mb-2\">\n                                        <i class=\"fas fa-chart-pie me-2\" style=\"opacity: 0.8; font-size: 1.2rem;\"></i>\n                                        <span style=\"font-weight: 700; font-size: 1.5rem;\">${usagePercent}%</span>\n                                    </div>\n                                    <small style=\"opacity: 0.8; font-size: 0.75rem;\">${formatTokens(summary.total_tokens_used)} / ${limitDisplay}</small>\n                                </div>\n                            </div>\n                        </div>\n                        <div class=\"col-md-3\">\n                            <div class=\"card border-0 h-100\" style=\"background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; border-radius: 12px; box-shadow: 0 4px 12px rgba(17, 153, 142, 0.2);\">\n                                <div class=\"card-body text-center\" style=\"padding: 16px 12px;\">\n                                    <h6 class=\"card-title mb-2\" style=\"font-weight: 600; opacity: 0.9; font-size: 0.85rem;\">Tokens Used</h6>\n                                    <div class=\"d-flex align-items-center justify-content-center mb-2\">\n                                        <i class=\"fas fa-code me-2\" style=\"opacity: 0.8; font-size: 1.2rem;\"></i>\n                                        <span style=\"font-weight: 700; font-size: 1.5rem;\">${formatTokens(summary.total_tokens_used)}</span>\n                                    </div>\n                                    <small style=\"opacity: 0.8; font-size: 0.75rem;\">This Billing Period</small>\n                                </div>\n                            </div>\n                        </div>\n                        <div class=\"col-md-3\">\n                            <div class=\"card border-0 h-100\" style=\"background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; border-radius: 12px; box-shadow: 0 4px 12px rgba(240, 147, 251, 0.2);\">\n                                <div class=\"card-body text-center\" style=\"padding: 16px 12px;\">\n                                    <h6 class=\"card-title mb-2\" style=\"font-weight: 600; opacity: 0.9; font-size: 0.85rem;\">Total Requests</h6>\n                                    <div class=\"d-flex align-items-center justify-content-center mb-2\">\n                                        <i class=\"fas fa-paper-plane me-2\" style=\"opacity: 0.8; font-size: 1.2rem;\"></i>\n                                        <span style=\"font-weight: 700; font-size: 1.5rem;\">${summary.total_requests}</span>\n                                    </div>\n                                    <small style=\"opacity: 0.8; font-size: 0.75rem;\">Messages Processed</small>\n                                </div>\n                            </div>\n                        </div>\n                        <div class=\"col-md-3\">\n                            <div class=\"card border-0 h-100\" style=\"background: linear-gradient(135deg, #ff6b6b 0%, #ffa500 100%); color: white; border-radius: 12px; box-shadow: 0 4px 12px rgba(255, 107, 107, 0.2);\">\n                                <div class=\"card-body text-center\" style=\"padding: 16px 12px;\">\n                                    <h6 class=\"card-title mb-2\" style=\"font-weight: 600; opacity: 0.9; font-size: 0.85rem;\">Today's Tokens</h6>\n                                    <div class=\"d-flex align-items-center justify-content-center mb-2\">\n                                        <i class=\"fas fa-calendar-day me-2\" style=\"opacity: 0.8; font-size: 1.2rem;\"></i>\n                                        <span style=\"font-weight: 700; font-size: 1.5rem;\">${formatTokens(summary.today_tokens_used || 0)}</span>\n                                    </div>\n                                    <small style=\"opacity: 0.8; font-size: 0.75rem;\">Tokens Used Today</small>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n\n                    <!-- Compact Data Table -->\n                    <div class=\"card border-0\" style=\"border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.06);\">\n                        <div class=\"card-header\" style=\"background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-radius: 12px 12px 0 0; border: none; padding: 12px 16px;\">\n                            <div class=\"d-flex justify-content-between align-items-center\">\n                                <h6 class=\"mb-0\" style=\"font-weight: 600; color: #333;\">\n                                    Detailed Usage History\n                                </h6>\n                                <span class=\"badge bg-primary\" style=\"font-size: 0.7rem; padding: 4px 8px; border-radius: 12px; color: white; background: linear-gradient(135deg, #0ea5e9 0%, #2563eb 100%);\">\n                                    ${usage.length} of ${pagination.total} records\n                                </span>\n                            </div>\n                        </div>\n                        <div class=\"card-body p-0\">\n                            <div class=\"table-responsive\">\n                                <table id=\"usage-datatable\" class=\"table table-hover mb-0\" style=\"font-size: 0.9rem;\">\n                                    <thead style=\"background: linear-gradient(135deg, #0ea5e9 0%, #2563eb 100%); color: white;\">\n                                        <tr>\n                                            <th style=\"border: none; padding: 15px 12px; font-weight: 600; text-align: center;\">Date</th>\n                                            <th style=\"border: none; padding: 15px 12px; font-weight: 600; text-align: center;\">Action</th>\n                                            <th style=\"border: none; padding: 15px 12px; font-weight: 600; text-align: center;\">Model</th>\n                                            <th style=\"border: none; padding: 15px 12px; font-weight: 600; text-align: center;\">Input</th>\n                                            <th style=\"border: none; padding: 15px 12px; font-weight: 600; text-align: center;\">Output</th>\n                                            <th style=\"border: none; padding: 15px 12px; font-weight: 600; text-align: center;\">Total Tokens</th>\n                                        </tr>\n                                    </thead>\n                                    <tbody>\n                                        ${usage.length > 0 ? usage.map(item => `\n                                            <tr style=\"border-bottom: 1px solid #f8f9fa;\">\n                                                <td style=\"padding: 12px; vertical-align: middle; font-weight: 500;\">\n                                                    ${(() => {\n                                                        const d = new Date(item.created_at);\n                                                        const day = d.getDate();\n                                                        const month = d.toLocaleString('en-US', {month: 'short'});\n                                                        const year = d.getFullYear();\n                                                        const hours = d.getHours().toString().padStart(2, '0');\n                                                        const minutes = d.getMinutes().toString().padStart(2, '0');\n                                                        return `${day} ${month} ${year} - ${hours}:${minutes}`;\n                                                    })()}\n                                                </td>\n                                                <td style=\"padding: 12px; vertical-align: middle;\">\n                                                    <span class=\"badge ${item.action_type === 'report_generation' ? 'bg-primary' : item.action_type === 'mcq_generation' ? 'bg-warning' : 'bg-success'}\" style=\"border-radius: 20px; padding: 6px 12px; font-weight: 500;\">\n                                                        <i class=\"fas ${item.action_type === 'report_generation' ? 'fa-file-alt' : item.action_type === 'mcq_generation' ? 'fa-question-circle' : 'fa-comment'} me-1\"></i>\n                                                        ${item.action_type.replace('_', ' ')}\n                                                    </span>\n                                                </td>\n                                                <td style=\"padding: 12px; vertical-align: middle;\">\n                                                    <span class=\"badge bg-light text-dark\" style=\"border-radius: 20px; padding: 4px 8px;\">\n                                                        ${item.model || 'N/A'}\n                                                    </span>\n                                                </td>\n                                                <td style=\"padding: 12px; vertical-align: middle; font-weight: 500; color: #11998e;\">${(item.prompt_tokens || 0).toLocaleString()}</td>\n                                                <td style=\"padding: 12px; vertical-align: middle; font-weight: 500; color: #f5576c;\">${(item.completion_tokens || 0).toLocaleString()}</td>\n                                                <td style=\"padding: 12px; vertical-align: middle; font-weight: 600; color: #667eea;\">${(item.tokens_used || 0).toLocaleString()}</td>\n                                            </tr>\n                                        `).join('') : `\n                                            <tr>\n                                                <td colspan=\"6\" style=\"padding: 40px; text-align: center;\">\n                                                    <div style=\"color: #6c757d;\">\n                                                        <i class=\"fas fa-inbox fa-3x mb-3\" style=\"opacity: 0.5;\"></i>\n                                                        <h5 style=\"font-weight: 600; margin-bottom: 10px;\">No Usage Data Yet</h5>\n                                                        <p style=\"margin: 0; font-size: 0.9rem;\">Start using the AI Assistant to generate reports and your usage history will appear here.</p>\n                                                    </div>\n                                                </td>\n                                            </tr>\n                                        `}\n                                    </tbody>\n                                </table>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n            `;\n\n            Swal.fire({\n                html: modalHtml,\n                width: '80%',\n                showConfirmButton: false,\n                showCancelButton: false,\n                showCloseButton: false,\n                allowOutsideClick: true,\n                customClass: {\n                    popup: 'usage-modal-popup',\n                    htmlContainer: 'usage-modal-container'\n                },\n                didOpen: () => {\n                    // Add hover effect to close button\n                    const closeBtn = document.querySelector('.usage-modal-close-btn');\n                    if (closeBtn) {\n                        closeBtn.addEventListener('mouseenter', () => {\n                            closeBtn.style.background = 'rgba(255,255,255,0.3)';\n                        });\n                        closeBtn.addEventListener('mouseleave', () => {\n                            closeBtn.style.background = 'rgba(255,255,255,0.2)';\n                        });\n                    }\n                    this.setupUsageModalEventListeners(data);\n                }\n            });\n        },\n\n        setupUsageModalEventListeners: function(data) {\n            const self = this;\n            let currentFilters = data.filters;\n            self.usageDataTable = null;\n\n            // Initialize Simple DataTable using the same library as reports table\n            setTimeout(() => {\n                // Check if simpleDatatables is available\n                if (typeof simpleDatatables === 'undefined' || !simpleDatatables.DataTable) {\n                    return;\n                }\n\n                // Check if table exists\n                if (!$('#usage-datatable').length) {\n                    return;\n                }\n\n                try {\n\n                    // Check if table has data before initializing\n                    const tableElement = document.getElementById('usage-datatable');\n                    if (tableElement) {\n                        const tbody = tableElement.querySelector('tbody');\n                        const hasData = tbody && tbody.rows.length > 0;\n\n                        if (hasData) {\n                            self.usageDataTable = new simpleDatatables.DataTable(\"#usage-datatable\", {\n                                searchable: true,\n                                fixedHeight: false,\n                                perPage: 25,\n                                perPageSelect: [10, 25, 50, 100],\n                                sortable: true,\n                                labels: {\n                                    placeholder: \"Search usage history...\",\n                                    noRows: \"No usage data found\",\n                                    info: \"Showing {start} to {end} of {rows} entries\"\n                                }\n                            });\n\n                        } else {\n                        }\n                    }\n                } catch (error) {\n                    // DataTable initialization failed silently.\n                }\n            }, 500);\n\n            // Apply filters button\n            $('#apply-filters').on('click', function() {\n                const userId = $('#user-filter').val();\n                const creditType = $('#credit-type-filter').val();\n                const startDate = $('#start-date-filter').val();\n                const endDate = $('#end-date-filter').val();\n\n                currentFilters = {\n                    user_id: userId,\n                    credit_type: creditType,\n                    start_date: startDate,\n                    end_date: endDate\n                };\n\n                self.loadUsageDataWithFilters(currentFilters, 1);\n            });\n\n            // Clear filters button\n            $('#clear-filters').on('click', function() {\n                $('#user-filter').val('');\n                $('#credit-type-filter').val('');\n                $('#start-date-filter').val('');\n                $('#end-date-filter').val('');\n\n                currentFilters = {};\n                self.loadUsageDataWithFilters({}, 1);\n            });\n\n            // Quick filter buttons\n            $('.adeptus-quick-filter').on('click', function() {\n                const period = $(this).data('period');\n                const today = new Date();\n                let startDate = '';\n                let endDate = today.toISOString().split('T')[0];\n\n                switch (period) {\n                    case 'today':\n                        startDate = endDate;\n                        break;\n                    case 'week': {\n                        const weekAgo = new Date(today);\n                        weekAgo.setDate(today.getDate() - 7);\n                        startDate = weekAgo.toISOString().split('T')[0];\n                        break;\n                    }\n                    case 'month': {\n                        const monthAgo = new Date(today);\n                        monthAgo.setMonth(today.getMonth() - 1);\n                        startDate = monthAgo.toISOString().split('T')[0];\n                        break;\n                    }\n                }\n\n                // Update date inputs\n                $('#start-date-filter').val(startDate);\n                $('#end-date-filter').val(endDate);\n\n                // Apply filters automatically\n                currentFilters = {\n                    user_id: $('#user-filter').val(),\n                    credit_type: $('#credit-type-filter').val(),\n                    start_date: startDate,\n                    end_date: endDate\n                };\n\n                self.loadUsageDataWithFilters(currentFilters, 1);\n            });\n        },\n\n        loadUsageDataWithFilters: function(filters, page = 1) {\n            // Show loading\n            Swal.fire({\n                title: getString('loading', 'Loading...'),\n                text: getString('applying_filters', 'Applying filters and loading data'),\n                allowOutsideClick: false,\n                showConfirmButton: false,\n                willOpen: () => {\n                    Swal.showLoading();\n                }\n            });\n\n            // Build query string\n            const params = new URLSearchParams();\n            if (filters.user_id) {\n params.append('user_id', filters.user_id);\n}\n            if (filters.credit_type) {\n params.append('credit_type', filters.credit_type);\n}\n            if (filters.start_date) {\n params.append('start_date', filters.start_date);\n}\n            if (filters.end_date) {\n params.append('end_date', filters.end_date);\n}\n            params.append('page', page);\n            params.append('per_page', 1000); // Get more data for DataTable\n\n            this.ajaxWithAuth({\n                url: `${this.backendUrl}/chat/credits/detailed-usage?${params.toString()}`,\n                method: 'GET',\n                success: (response) => {\n                    if (response.success) {\n                        this.updateUsageModalData(response.data);\n                    } else {\n                        Swal.fire(getString('error', 'Error'), getString('failed_load_filtered', 'Failed to load filtered data'), 'error');\n                    }\n                },\n                error: () => {\n                    Swal.fire(getString('error', 'Error'), getString('failed_load_filtered', 'Failed to load filtered data'), 'error');\n                }\n            });\n        },\n\n        updateUsageModalData: function(data) {\n            const summary = data.summary;\n            const usage = data.usage;\n\n            // Update summary cards\n            $('.detailed-usage-modal .card h2').eq(0).text(summary.total_credits_used);\n            $('.detailed-usage-modal .card h2').eq(1).text(summary.total_tokens_used.toLocaleString());\n            $('.detailed-usage-modal .card h2').eq(2).text(summary.total_requests);\n            $('.detailed-usage-modal .card h2').eq(3).text(summary.unique_users);\n            $('.detailed-usage-modal .card h3').eq(0).text(summary.premium_credits);\n            $('.detailed-usage-modal .card h3').eq(1).text(summary.basic_credits);\n\n            // Update record count badge\n            $('.detailed-usage-modal .badge.bg-primary').text(`${usage.length} of ${data.pagination.total} records`);\n\n            // Clear and rebuild table data\n            const tableBody = $('#usage-datatable tbody');\n            tableBody.empty();\n\n            usage.forEach(item => {\n                const row = `\n                    <tr style=\"border-bottom: 1px solid #f8f9fa;\">\n                        <td style=\"padding: 12px; vertical-align: middle; font-weight: 500;\">${new Date(item.created_at).toLocaleDateString()}</td>\n                        <td style=\"padding: 12px; vertical-align: middle;\">\n                            <span class=\"badge bg-light text-dark\" style=\"border-radius: 20px; padding: 4px 8px;\">\n                                ${item.user_id || 'N/A'}\n                            </span>\n                        </td>\n                        <td style=\"padding: 12px; vertical-align: middle;\">\n                            <span class=\"badge ${item.credit_type === 'premium' ? 'bg-primary' : 'bg-success'}\" style=\"border-radius: 20px; padding: 6px 12px; font-weight: 500;\">\n                                <i class=\"fas ${item.credit_type === 'premium' ? 'fa-crown' : 'fa-layer-group'} me-1\"></i>\n                                ${item.credit_type}\n                            </span>\n                        </td>\n                        <td style=\"padding: 12px; vertical-align: middle; font-weight: 600; color: #667eea;\">${item.credits_charged}</td>\n                        <td style=\"padding: 12px; vertical-align: middle; font-weight: 500;\">${item.tokens_used.toLocaleString()}</td>\n                        <td style=\"padding: 12px; vertical-align: middle;\">\n                            <span class=\"badge bg-info text-white\" style=\"border-radius: 20px; padding: 4px 8px;\">\n                                ${item.llm_provider}\n                            </span>\n                        </td>\n                        <td style=\"padding: 12px; vertical-align: middle; max-width: 200px;\">\n                            <div style=\"overflow: hidden; text-overflow: ellipsis; white-space: nowrap;\" title=\"${item.message_preview || 'No message'}\">\n                                ${item.message_preview ? item.message_preview.substring(0, 50) + '...' : 'N/A'}\n                            </div>\n                        </td>\n                    </tr>\n                `;\n                tableBody.append(row);\n            });\n\n        // Update Simple DataTable if it exists\n        if (this.usageDataTable && typeof this.usageDataTable.refresh === 'function') {\n            try {\n                this.usageDataTable.refresh();\n            } catch (error) {\n                // Refresh failed silently.\n            }\n        } else {\n            }\n        },\n\n        updateReportData: function(data) {\n            const table = $('#report-table');\n            table.empty();\n\n            // Add headers\n            const thead = $('<thead><tr></tr></thead>');\n            data.columns.forEach(column => {\n                thead.find('tr').append(`<th>${column}</th>`);\n            });\n            table.append(thead);\n\n            // Add rows\n            const tbody = $('<tbody></tbody>');\n            data.rows.forEach(row => {\n                const tr = $('<tr></tr>');\n                row.forEach(cell => {\n                    tr.append(`<td>${cell}</td>`);\n                });\n                tbody.append(tr);\n            });\n            table.append(tbody);\n        },\n\n        updateVisualizations: function(visualizations) {\n            const container = $('#adeptus-chart-container');\n            container.empty();\n\n            // Create canvas for chart\n            const canvas = $('<canvas></canvas>');\n            container.append(canvas);\n\n            // Get chart type\n            const type = $('#chart-type').val();\n\n            // Create chart\n            new Chart(canvas[0], {\n                type: type,\n                data: {\n                    labels: visualizations.labels,\n                    datasets: visualizations.datasets.map(dataset => ({\n                        label: dataset.label,\n                        data: dataset.data,\n                        backgroundColor: dataset.backgroundColor,\n                        borderColor: dataset.borderColor,\n                        borderWidth: 1\n                    }))\n                },\n                options: {\n                    responsive: true,\n                    maintainAspectRatio: false,\n                    plugins: {\n                        legend: {\n                            position: 'top'\n                        },\n                        title: {\n                            display: true,\n                            text: visualizations.title\n                        }\n                    }\n                }\n            });\n        },\n\n        /**\n         * Detect numeric columns in data\n         * @param data\n         * @param headers\n         */\n        detectNumericColumns: function(data, headers) {\n            if (!data || data.length === 0) {\n return [];\n}\n            return headers.filter(header => {\n                let numericCount = 0;\n                const sampleSize = Math.min(data.length, 20);\n                for (let i = 0; i < sampleSize; i++) {\n                    const val = data[i][header];\n                    if (val !== null && val !== undefined && val !== '') {\n                        const num = parseFloat(val);\n                        if (!isNaN(num) && isFinite(num)) {\n                            numericCount++;\n                        }\n                    }\n                }\n                return numericCount >= sampleSize * 0.5;\n            });\n        },\n\n        /**\n         * Generate chart colors\n         * @param count\n         */\n        generateChartColors: function(count) {\n            const baseColors = [\n                '#2563eb', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6',\n                '#06b6d4', '#ec4899', '#84cc16', '#f97316', '#6366f1',\n                '#14b8a6', '#a855f7', '#eab308', '#22c55e', '#3b82f6'\n            ];\n            const colors = [];\n            for (let i = 0; i < count; i++) {\n                colors.push(baseColors[i % baseColors.length]);\n            }\n            return colors;\n        },\n\n        /**\n         * Create chart configuration\n         * @param chartType\n         * @param labels\n         * @param values\n         * @param valueKey\n         * @param colors\n         * @param reportName\n         */\n        createReportChartConfig: function(chartType, labels, values, valueKey, colors, reportName) {\n            const baseConfig = {\n                responsive: true,\n                maintainAspectRatio: false,\n                plugins: {\n                    title: {\n                        display: true,\n                        text: reportName || 'Report Chart',\n                        font: {size: 16, weight: 'bold'},\n                        padding: {top: 10, bottom: 20}\n                    },\n                    legend: {\n                        display: chartType === 'pie' || chartType === 'doughnut',\n                        position: 'right'\n                    }\n                }\n            };\n\n            if (chartType === 'pie' || chartType === 'doughnut') {\n                return {\n                    type: chartType,\n                    data: {\n                        labels: labels,\n                        datasets: [{\n                            data: values,\n                            backgroundColor: colors,\n                            borderColor: '#fff',\n                            borderWidth: 2\n                        }]\n                    },\n                    options: baseConfig\n                };\n            } else if (chartType === 'line') {\n                return {\n                    type: 'line',\n                    data: {\n                        labels: labels,\n                        datasets: [{\n                            label: valueKey,\n                            data: values,\n                            borderColor: colors[0],\n                            backgroundColor: colors[0] + '40',\n                            borderWidth: 3,\n                            fill: true,\n                            tension: 0.4\n                        }]\n                    },\n                    options: {\n                        ...baseConfig,\n                        scales: {\n                            y: {beginAtZero: true},\n                            x: {ticks: {maxRotation: 45, minRotation: 45}}\n                        }\n                    }\n                };\n            } else {\n                // Bar chart (default)\n                return {\n                    type: 'bar',\n                    data: {\n                        labels: labels,\n                        datasets: [{\n                            label: valueKey,\n                            data: values,\n                            backgroundColor: colors,\n                            borderColor: colors,\n                            borderWidth: 1\n                        }]\n                    },\n                    options: {\n                        ...baseConfig,\n                        scales: {\n                            y: {beginAtZero: true},\n                            x: {ticks: {maxRotation: 45, minRotation: 45}}\n                        }\n                    }\n                };\n            }\n        },\n\n        /**\n         * Render report chart with current settings\n         * @param data\n         * @param reportName\n         */\n        renderReportChartFromSelectors: function(data, reportName) {\n            const self = this;\n            if (!data || data.length === 0) {\n return;\n}\n\n            const chartType = $('#report-chart-type').val() || 'bar';\n            const labelKey = $('#report-chart-x-axis').val();\n            const valueKey = $('#report-chart-y-axis').val();\n\n            if (!labelKey || !valueKey) {\n return;\n}\n\n            const valueKeyFormatted = valueKey.replace(/_/g, ' ').replace(/\\b\\w/g, l => l.toUpperCase());\n\n            // Limit data for chart (max 50 items for readability)\n            const chartData = data.slice(0, 50);\n            const labels = chartData.map(r => {\n                const label = r[labelKey];\n                if (label === null || label === undefined) {\n return 'Unknown';\n}\n                const labelStr = String(label);\n                return labelStr.length > 30 ? labelStr.substring(0, 30) + '...' : labelStr;\n            });\n            const values = chartData.map(r => parseFloat(r[valueKey]) || 0);\n            const colors = this.generateChartColors(values.length);\n\n            const chartConfig = this.createReportChartConfig(chartType, labels, values, valueKeyFormatted, colors, reportName);\n\n            const chartEl = document.getElementById('reportChart');\n            if (!chartEl) {\n return;\n}\n\n            if (self.reportChartInstance) {\n                self.reportChartInstance.destroy();\n            }\n\n            try {\n                self.reportChartInstance = new Chart(chartEl.getContext('2d'), chartConfig);\n            } catch (error) {\n                // Chart creation failed silently.\n            }\n        },\n\n        showLoading: function() {\n            // Remove any existing loader first (use wrapper class for complete cleanup)\n            $('.adeptus-ai-thinking-loader-wrapper').remove();\n\n            // Track when loader was shown for minimum display time\n            this.loaderShownAt = Date.now();\n            // Create the loader element with proper message wrapper structure\n            const loaderHtml = `\n                <div class=\"adeptus-message-wrapper adeptus-ai-message-wrapper adeptus-ai-thinking-loader-wrapper\" style=\"margin: 10px 0;\">\n                    <div class=\"adeptus-message adeptus-ai-message adeptus-ai-thinking-loader\" style=\"\n                        max-width: 70%;\n                        margin-left: 20px;\n                        padding: 15px 20px;\n                        background: linear-gradient(135deg, #f0f4f8 0%, #e9ecef 100%);\n                        border-radius: 18px 18px 18px 4px;\n                        box-shadow: 0 2px 8px rgba(0,0,0,0.08);\n                        display: flex;\n                        align-items: center;\n                        gap: 12px;\n                    \">\n                        <div class=\"adeptus-ai-avatar-loader\" style=\"\n                            padding: 8px 12px;\n                            background: linear-gradient(135deg, #0ea5e9 0%, #2563eb 100%);\n                            border-radius: 20px;\n                            display: flex;\n                            align-items: center;\n                            justify-content: center;\n                            color: white;\n                            font-weight: 600;\n                            font-size: 13px;\n                            flex-shrink: 0;\n                            animation: pulse-glow-loader 2s infinite;\n                            font-family: system-ui, -apple-system, sans-serif;\n                            letter-spacing: 0.5px;\n                        \">Adeptus AI</div>\n                        <div class=\"adeptus-thinking-dots\" style=\"\n                            display: flex;\n                            align-items: center;\n                            gap: 4px;\n                        \">\n                            <span class=\"adeptus-thinking-text\" style=\"\n                                color: #6c757d;\n                                font-size: 14px;\n                                margin-right: 8px;\n                                font-style: italic;\n                            \">Thinking</span>\n                            <span class=\"adeptus-dot adeptus-dot-1\" style=\"\n                                width: 8px;\n                                height: 8px;\n                                border-radius: 50%;\n                                background: #0ea5e9;\n                                display: inline-block;\n                                animation: bounce-loader 1.4s infinite ease-in-out both;\n                                animation-delay: -0.32s;\n                            \"></span>\n                            <span class=\"adeptus-dot adeptus-dot-2\" style=\"\n                                width: 8px;\n                                height: 8px;\n                                border-radius: 50%;\n                                background: #2563eb;\n                                display: inline-block;\n                                animation: bounce-loader 1.4s infinite ease-in-out both;\n                                animation-delay: -0.16s;\n                            \"></span>\n                            <span class=\"adeptus-dot adeptus-dot-3\" style=\"\n                                width: 8px;\n                                height: 8px;\n                                border-radius: 50%;\n                                background: #0ea5e9;\n                                display: inline-block;\n                                animation: bounce-loader 1.4s infinite ease-in-out both;\n                            \"></span>\n                        </div>\n                    </div>\n                </div>\n            `;\n\n            // Add the loader to chat container\n            const $chatContainer = $('#adeptus-chat-container');\n            if ($chatContainer.length > 0) {\n                $chatContainer.append(loaderHtml);\n\n                // Scroll to bottom immediately to show the loader\n                this.scrollToBottom();\n            }\n        },\n\n        hideLoading: function() {\n            // Calculate how long the loader has been shown\n            const loaderShownDuration = this.loaderShownAt ? Date.now() - this.loaderShownAt : 0;\n            const minimumDisplayTime = 800; // Minimum 800ms display time\n            const remainingTime = Math.max(0, minimumDisplayTime - loaderShownDuration);\n\n            // Delay removal to ensure minimum display time\n            setTimeout(() => {\n                // Remove the thinking loader wrapper with fade animation\n                $('.adeptus-ai-thinking-loader-wrapper').fadeOut(200, function() {\n                    $(this).remove();\n                });\n                // Also remove just the loader element if wrapper doesn't exist\n                $('.adeptus-ai-thinking-loader').fadeOut(200, function() {\n                    $(this).remove();\n                });\n                // Also hide the old loading indicator if it exists\n                $('#adeptus-loading-indicator').addClass('d-none');\n            }, remainingTime);\n        },\n\n        showError: function(message) {\n            const errorDiv = $('#adeptus-error-message');\n            $('#error-text').text(message);\n            errorDiv.removeClass('d-none');\n\n            // Auto-hide after 5 seconds\n            setTimeout(() => {\n                errorDiv.addClass('d-none');\n            }, 5000);\n        },\n\n        showSuccess: function(message) {\n            // Create success alert if it doesn't exist\n            if ($('#success-message').length === 0) {\n                const successHtml = `\n                    <div class=\"alert alert-success alert-dismissible fade show d-none\" role=\"alert\" id=\"success-message\" style=\"position:fixed; top:20px; right:20px; z-index:1050;\">\n                        <i class=\"fa fa-check-circle me-2\"></i>\n                        <span id=\"success-text\"></span>\n                        <button type=\"button\" class=\"btn-close\" data-bs-dismiss=\"alert\" aria-label=\"Close\"></button>\n                    </div>\n                `;\n                $('body').append(successHtml);\n            }\n\n            const successDiv = $('#success-message');\n            $('#success-text').text(message);\n            successDiv.removeClass('d-none');\n\n            // Auto-hide after 3 seconds\n            setTimeout(() => {\n                successDiv.addClass('d-none');\n            }, 3000);\n        },\n\n        scrollToBottom: function() {\n            const container = $('#adeptus-chat-container');\n            container.scrollTop(container[0].scrollHeight);\n        },\n\n        /**\n         * Fetch chat history, show spinner, then render list or \"No chats\"\n         */\n        loadChatHistory: function() {\n            const list = $('#chat-history-list');\n\n            // Show loading spinner\n            list.html(`\n                <li class=\"list-group-item d-flex justify-content-center\" id=\"chat-history-loading\">\n                    <div class=\"spinner-border text-secondary\" role=\"status\">\n                        <span class=\"sr-only\">Loading...</span>\n                    </div>\n                </li>\n            `);\n\n            this.ajaxWithAuth({\n                url: this.backendUrl + '/chat/history',\n                method: 'GET',\n                success: (response) => {\n                    list.empty();\n\n                    // Ensure response has chats array\n                    if (!response || !response.chats || !Array.isArray(response.chats)) {\n                        list.append(`\n                            <li class=\"list-group-item text-center\">\n                                <div class=\"text-muted\">\n                                    <i class=\"fa fa-comments fa-2x mb-2\"></i>\n                                    <p class=\"mb-1\">No chat history available</p>\n                                    <small>Start a conversation to see your chat history here</small>\n                                </div>\n                            </li>\n                        `);\n                        return;\n                    }\n\n                    if (!response.chats.length) {\n                        // Check if we also have no reports\n                        const authStatus = AuthUtils.getAuthStatus();\n                        const hasReports = authStatus && authStatus.subscription &&\n                            authStatus.subscription.reports_generated_this_month > 0;\n\n                        if (!hasReports) {\n                            list.append(`\n                                <li class=\"list-group-item text-center\">\n                                    <div class=\"text-muted\">\n                                        <i class=\"fa fa-comments fa-2x mb-2\"></i>\n                                        <p class=\"mb-1\">No chat history yet</p>\n                                        <small>Start a conversation to see your chat history here</small>\n                                    </div>\n                                </li>\n                            `);\n\n                            // Show welcome message in chat container when no history exists\n                            if ($('#adeptus-chat-container').children().length === 0) {\n                                this.showWelcomeMessage();\n                            }\n                        } else {\n                            list.append(`<li class=\"list-group-item text-center\">${getString('no_chats_yet', 'No chats yet')}</li>`);\n                        }\n                    } else {\n                        response.chats.forEach((chat) => {\n                            // Safely handle date with fallback\n                            const date = chat.created_at ? new Date(chat.created_at).toLocaleString() : 'Unknown date';\n\n                            // Map backend field names to frontend expected names\n                            // Backend returns: title, last_message, message_count\n                            // Frontend expects: snippet or first_message\n                            // Prefer last_message as it contains actual content, title is often \"New Chat\"\n                            const snippet = chat.last_message || chat.title || chat.snippet || chat.first_message || 'Chat session';\n\n                            // Safely handle report count\n                            const reportCount = chat.report_count || 0;\n                            const badgeHtml = reportCount > 0\n                                ? `<span class=\"badge bg-primary d-flex align-items-center adeptus-report-count\"><i class=\"fa fa-chart-bar me-1\"></i>${reportCount}</span>`\n                                : '';\n\n                            // Only create item if we have a valid chat ID\n                            if (chat.id) {\n                                const item = $(`\n                                    <li class=\"list-group-item d-flex justify-content-between align-items-start adeptus-chat-history-item\" data-chat-id=\"${chat.id}\">\n                                        <div>\n                                            <small class=\"text-muted\">${date}</small><br>\n                                            ${snippet}\n                                        </div>\n                                        ${badgeHtml}\n                                    </li>\n                                `);\n                                list.append(item); // Changed from prepend to append - backend already returns newest first\n                            }\n                        });\n\n                        // Set up click handlers\n                        $('.adeptus-chat-history-item').on('click', (e) => {\n                            const li = $(e.currentTarget);\n                            const chatId = li.data('chat-id');\n                            this.loadChatMessages(chatId, li);\n                        });\n\n                        // Don't auto-load any chat - show welcome message on initial page load\n                        // Only show welcome message if chat container is empty\n                        if (this.currentChatId === 0 && $('#adeptus-chat-container').children().length === 0) {\n                            this.showWelcomeMessage();\n                        }\n                    }\n                },\n                error: () => {\n                    list.html(`\n                        <li class=\"list-group-item text-center\">\n                            <div class=\"text-danger\">\n                                <i class=\"fa fa-exclamation-triangle fa-2x mb-2\"></i>\n                                <p class=\"mb-2\">Failed to load chat history</p>\n                                <button id=\"reload-chat-history\" class=\"btn btn-outline-primary btn-sm\">\n                                    <i class=\"fa fa-refresh\"></i> Try Again\n                                </button>\n                            </div>\n                        </li>\n                    `);\n                    $('#reload-chat-history').on('click', () => this.loadChatHistory());\n                }\n            });\n        },\n\n        /**\n         * Load a specific chat's messages, highlight the selected item\n         * @param chatId\n         * @param listItem\n         */\n        loadChatMessages: function(chatId, listItem) {\n            this.currentChatId = chatId;\n            $('#chat-history-list li').removeClass('active');\n            listItem.addClass('active');\n            $('#adeptus-chat-container').empty();\n            this.clearMCQ(); // Clear and hide MCQ container when loading different chat\n            this.showLoading();\n\n            const messageUrl = `${this.backendUrl}/chat/${chatId}/messages`;\n\n            this.ajaxWithAuth({\n                url: messageUrl,\n                method: 'GET',\n                success: (response) => {\n                    this.hideLoading();\n\n                    // Check for credit limit information in response and update button state\n                    if (response.credit_data && response.credit_data.summary) {\n                        this.updateSubscriptionDataFromCreditResponse(response.credit_data);\n                    }\n\n                    // Always check current subscription status and update button state\n                    const authStatus = AuthUtils.getAuthStatus();\n                    if (authStatus && authStatus.subscription) {\n                        this.checkAndShowCreditLimitWarning(authStatus.subscription);\n                    }\n\n                    // Render chat messages with message IDs, filtering out SQL-tagged messages and passing timestamp\n                    response.messages.forEach((msg, idx) => {\n                        // Map backend field names to frontend expected names\n                        msg.sender_type = msg.role || msg.sender_type; // Backend uses 'role', frontend expects 'sender_type'\n                        msg.body = msg.content || msg.body; // Backend uses 'content', frontend expects 'body'\n                        msg.timestamp = msg.created_at || msg.timestamp; // Backend uses 'created_at', frontend expects 'timestamp'\n\n                        // Convert 'ai' role to 'ai' sender_type if needed\n                        if (msg.sender_type === 'assistant') {\n                            msg.sender_type = 'ai';\n                        }\n\n                        if (msg.tag === 'sql') {\n                            return;\n                        }\n\n                        // Check if this is an MCQ message followed by a user answer\n                        if (msg.sender_type === 'ai' && msg.tag === 'mcq') {\n                            // Look for the next user message as the selected answer\n                            const nextMsg = response.messages[idx + 1];\n                            const selectedAnswer = (nextMsg && nextMsg.sender_type === 'user') ? nextMsg.body : null;\n\n                            // Extract MCQ data and render with selected answer\n                            const mcqData = this.extractMCQFromText(msg.body);\n                            if (mcqData && mcqData.questions.length > 0) {\n                                mcqData.selectedAnswer = selectedAnswer;\n                                const mcqHtml = this.renderMCQHistory(mcqData.questions, selectedAnswer);\n\n                                // Add as AI message with MCQ HTML\n                                const template = document.getElementById('message-template');\n                                const frag = template.content.cloneNode(true);\n                                const messageEl = frag.querySelector('.adeptus-message');\n                                messageEl.classList.add('adeptus-ai-message');\n                                messageEl.setAttribute('data-message-id', msg.id);\n                                frag.querySelector('.adeptus-message-text').innerHTML = mcqHtml;\n                                frag.querySelector('.adeptus-message-time').textContent = this.formatTimestamp(msg.timestamp);\n                                $('#adeptus-chat-container').append(frag);\n                                return; // Skip the normal addMessage call\n                            }\n                        }\n\n                        // Skip rendering the user's MCQ answer separately if it was already shown in the MCQ\n                        if (msg.sender_type === 'user' && idx > 0) {\n                            const prevMsg = response.messages[idx - 1];\n                            if (prevMsg && prevMsg.sender_type === 'ai' && prevMsg.tag === 'mcq') {\n                                // This is the MCQ answer, already rendered in the MCQ view above\n                                return;\n                            }\n                        }\n\n                        // Check if this is a report message with SQL to re-execute\n                        const hasReportMetadata = msg.metadata && msg.metadata.type === 'report' && msg.metadata.sql;\n                        // Backward compat: detect old \"Report Generated:\" messages and extract SQL\n                        const isLegacyReport = !hasReportMetadata && msg.body &&\n                            msg.body.startsWith('Report Generated:') && msg.body.includes('```sql');\n                        const isSavedReportLink = msg.body && msg.body.startsWith('ðŸ“Š Report saved:');\n\n                        if (hasReportMetadata || isLegacyReport) {\n                            // Extract SQL and report info\n                            let sql, reportName, reportDesc, category;\n                            if (hasReportMetadata) {\n                                sql = msg.metadata.sql;\n                                reportName = msg.metadata.name || 'Report';\n                                reportDesc = msg.metadata.description || reportName;\n                                category = msg.metadata.category || 'general';\n                            } else {\n                                // Parse from legacy text format\n                                const sqlMatch = msg.body.match(/```sql\\n([\\s\\S]*?)```/);\n                                sql = sqlMatch ? sqlMatch[1].trim() : null;\n                                const nameMatch = msg.body.match(/^Report Generated:\\s*(.+?)(?:\\n|$)/);\n                                reportName = nameMatch ? nameMatch[1].trim() : 'Report';\n                                reportDesc = reportName;\n                                const catMatch = msg.body.match(/Category:\\s*(\\w+)/);\n                                category = catMatch ? catMatch[1] : 'general';\n                            }\n\n                            if (sql) {\n                                // Execute the SQL locally and render results via showReportConfirmation\n                                // (which adds its own description message, so we don't addMessage here)\n                                const descText = `I've generated a report for you: ${reportDesc}`;\n\n                                this.executeReportLocally(sql, {})\n                                    .then((executionResult) => {\n                                        if (executionResult.data && executionResult.data.length > 0) {\n                                            const report = {\n                                                name: reportName,\n                                                description: reportDesc,\n                                                sql: sql,\n                                                category: category,\n                                            };\n                                            this.showReportConfirmation(\n                                                report,\n                                                executionResult.data,\n                                                descText,\n                                                null,\n                                                executionResult.error || null\n                                            );\n                                        } else if (executionResult.error) {\n                                            this.addMessage('âš ï¸ Could not re-execute report: ' + executionResult.error, 'ai');\n                                        }\n                                    })\n                                    .catch(() => {\n                                        // Silently fail â€” the description is already shown\n                                    });\n                            } else {\n                                this.addMessage(msg.body, msg.sender_type, false, null, msg.id, msg.timestamp);\n                            }\n                        } else if (isSavedReportLink) {\n                            // Extract report info from \"ðŸ“Š Report saved:\" message\n                            if (!msg.metadata) {\n                                const reportNameMatch = msg.body.match(/ðŸ“Š Report saved: (.+)/);\n                                const reportName = reportNameMatch ? reportNameMatch[1] : 'Report';\n                                const reportSlug = reportName.toLowerCase()\n                                    .replace(/\\s+/g, '-')\n                                    .replace(/[^a-z0-9-]/g, '');\n                                msg.metadata = {\n                                    type: 'report',\n                                    report_name: reportName,\n                                    report_slug: reportSlug\n                                };\n                            }\n                            this.displayReportLink(msg);\n                        } else {\n                            this.addMessage(msg.body, msg.sender_type, false, null, msg.id, msg.timestamp);\n                        }\n                    });\n                    this.scrollToBottom();\n                    // After messages, insert report links from response\n                    if (response.reports && response.reports.length) {\n                        response.reports.forEach(report => {\n                            this.insertReportLinkInChat(report);\n                        });\n                    }\n                    // If last message was an MCQ, enqueue and render MCQ view\n                    if (response.messages.length > 0) {\n                        const lastMsg = response.messages[response.messages.length - 1];\n                        if (lastMsg.tag === 'mcq') {\n                            // Extract JSON objects from the message body\n                            const jsonMatches = lastMsg.body.match(/\\{[\\s\\S]*?\\}/g) || [];\n                            const questions = [];\n                            jsonMatches.forEach(jsonStr => {\n                                try {\n                                    const obj = JSON.parse(jsonStr);\n                                    if (obj.type === 'mcq' && Array.isArray(obj.options)) {\n                                        questions.push(obj);\n                                    }\n                                } catch (e) {}\n                            });\n                            if (questions.length) {\n                                this.enqueueMCQs(questions);\n                            }\n                        }\n                    }\n                },\n                error: () => {\n                    this.hideLoading();\n                    this.showError('Could not load conversation.');\n                }\n            });\n        },\n\n        /**\n         * Insert a report link into the chat after the corresponding message\n         * @param report\n         */\n        insertReportLinkInChat: function(report) {\n            const $msg = $(`#adeptus-chat-container .adeptus-message[data-message-id=\"${report.message_after_id}\"]`);\n            if (!$msg.length) {\n return;\n}\n            // Build report link message\n            const linkHtml = `\n                <div class=\"adeptus-message adeptus-ai-message\">\n                  <div class=\"adeptus-message-content\">\n                    <div class=\"adeptus-message-text\">\n                      <a href=\"javascript:void(0)\" class=\"adeptus-report-link\" data-report-slug=\"${report.slug}\"\n                         style=\"color: #007bff; text-decoration: none; padding:4px 8px; border:1px solid #dee2e6; border-radius:4px; background:#f8f9fa; display:inline-block; transition:all 0.2s;\">\n                        ðŸ“Š ${report.description}\n                      </a>\n                    </div>\n                    <div class=\"adeptus-message-time small text-muted\">${new Date(report.created_at).toLocaleTimeString()}</div>\n                  </div>\n                </div>\n            `;\n            const $linkMsg = $(linkHtml);\n            // Bind click and hover\n            const self = this;\n            $linkMsg.find('.adeptus-report-link')\n                .on('click', function() {\n                    const slug = $(this).data('report-slug');\n                    self.openReportFromLink(slug);\n                })\n                .on('mouseenter', function() {\n                    $(this).css({'background-color': '#e9ecef', 'border-color': '#adb5bd', 'transform': 'translateY(-1px)'});\n                })\n                .on('mouseleave', function() {\n                    $(this).css({'background-color': '#f8f9fa', 'border-color': '#dee2e6', 'transform': 'translateY(0)'});\n                });\n            // Insert after message\n            $msg.after($linkMsg);\n        },\n\n        sendMessage: function(providedMessage) {\n            if (this.currentMCQ) {\n                // Ignore text input while MCQ active\n                return;\n            }\n\n            // Check if report limit is reached\n            if (this.isReportLimitReached && this.reportsLimit !== -1) {\n                this.handleReportLimitError('You have reached your report limit. Delete existing reports or upgrade your plan to continue using the AI assistant.');\n                return;\n            }\n\n            // Prevent double sending\n            if (this.isSending) {\n                return;\n            }\n\n            const input = $('#message-input');\n            // Use provided message if given, otherwise read from input field\n            const rawValue = providedMessage ? String(providedMessage).trim() : (input.val() || '').trim();\n            if (!rawValue) {\n                Swal.fire({icon: 'error', title: getString('oops', 'Oops...'), text: getString('please_enter_message', 'Please enter a message')});\n                return;\n            }\n            const message = rawValue.trim();\n            if (!message) {\n                return;\n            }\n\n            this.isSending = true;\n\n            // Clear welcome message if it exists\n            $('.adeptus-welcome-message').remove();\n\n            // Add user message first\n            const $userMsg = this.addMessage(message, 'user');\n            // Only clear input if we read from it (not for provided messages like inline MCQ answers)\n            if (!providedMessage) {\n                input.val('').trigger('input');\n            }\n\n            // Show the AI thinking loader immediately after the user message\n            this.showLoading();\n\n            // Get user information from auth status\n            const authStatus = AuthUtils.getAuthStatus();\n            const userInfo = authStatus?.user || {};\n\n            // If this is a provided message (MCQ selection), wrap with context for AI clarity\n            const messageToSend = providedMessage ? `I selected: ${message}` : message;\n\n            const requestData = {\n                message: messageToSend,\n                chat_id: this.currentChatId || 0,\n                user_id: userInfo.id || null,\n                user_name: userInfo.name || null\n            };\n\n            this.ajaxWithAuth({\n                url: this.backendUrl + '/chat/message',\n                method: 'POST',\n                contentType: 'application/json',\n                data: JSON.stringify(requestData),\n                success: (response) => {\n                    this.hideLoading();\n                    this.isSending = false;\n                    if (response.error) {\n                        // Handle specific error types\n                        if (response.error_type === 'credit_limit' || response.error_type === 'token_limit') {\n                            this.handleCreditLimitError(response.message, response.credit_data);\n                        } else if (response.error_type === 'report_limit') {\n                            this.handleReportLimitError(response.message);\n                        } else if (response.error_type === 'timeout') {\n                            this.handleTimeoutError(response.message);\n                        } else {\n                        // Display backend error as chat bubble\n                        this.addMessage(response.message, 'error');\n                        // Show resend icon on the specific user message that failed\n                        this.showResendIconOnMessage($userMsg, message);\n                        }\n                        return;\n                    }\n                    // Remove any existing resend icons on success (clean up from previous failures)\n                    $('.adeptus-failed-reload-icon').remove();\n                    // Update chat_id on first message\n                    if (!this.currentChatId && response.chat_id) {\n                        this.currentChatId = response.chat_id;\n                        this.addChatToChatHistory(response.chat_id, message);\n                    }\n\n                    // Handle response based on type\n                    this.handleResponse(response);\n\n                    // Refresh subscription info to update credit usage (reduced delay for faster updates)\n                    // setTimeout(() => {\n                        this.refreshSubscriptionInfo();\n                    // }, 500);\n                },\n                error: (err) => {\n                    this.hideLoading();\n                    this.isSending = false;\n                    if (err.status === 401) {\n                        AuthUtils.clearAuthData();\n                        this.showAuthenticationError();\n                    } else if (err.status === 429) {\n                        // Check error_type to distinguish between report limits and credit limits\n                        const errorType = err.responseJSON?.error_type || 'credit_limit';\n\n                        if (errorType === 'report_limit') {\n                            // Report limit (cumulative, no monthly reset)\n                            const errorMessage = err.responseJSON?.message || 'You have reached your report limit. Please upgrade your plan to generate more reports.';\n                            this.handleReportLimitError(errorMessage);\n                        } else {\n                            // Credit/token limit (has monthly reset)\n                            let errorMessage = 'You have reached your credit limit. Please upgrade your plan or wait until your credits refresh.';\n                            let creditData = null;\n\n                            // Try to extract error details from response\n                            if (err.responseJSON) {\n                                errorMessage = err.responseJSON.message || errorMessage;\n                                creditData = err.responseJSON.credit_data || null;\n                            }\n\n                            // Handle credit limit error with proper UI updates\n                            this.handleCreditLimitError(errorMessage, creditData);\n                        }\n\n                        // Don't show resend icon for limit errors\n                        $userMsg.remove(); // Remove the user message that couldn't be sent\n                    } else {\n                        // Show resend icon on the specific user message that failed\n                        this.showResendIconOnMessage($userMsg, message);\n                        this.addMessage('Network error occurred. Please try again.', 'error');\n                        return;\n                    }\n                }\n            });\n        },\n\n        updateSendMessageandCreateNewChatButton: function() {\n            if (this.isCreditLimitExceeded) {\n                $('#send-button')\n                    .prop('disabled', true)\n                    .attr('title', 'Credit limit reached. Your credits will reset on the 1st of next month.')\n                    .addClass('adeptus-credit-limit-disabled');\n                $('#create-new-chat')\n                    .prop('disabled', true)\n                    .attr('title', 'Credit limit reached. Your credits will reset on the 1st of next month.')\n                    .addClass('adeptus-credit-limit-disabled');\n                $('#message-input')\n                    .prop('disabled', true)\n                    .attr('placeholder', 'Credit limit reached. Your credits will reset on the 1st of next month.');\n            } else {\n                $('#send-button')\n                    .prop('disabled', false)\n                    .removeAttr('title')\n                    .removeClass('adeptus-credit-limit-disabled');\n                $('#create-new-chat')\n                    .prop('disabled', false)\n                    .removeAttr('title')\n                    .removeClass('adeptus-credit-limit-disabled');\n                $('#message-input')\n                    .prop('disabled', false)\n                    .attr('placeholder', 'Type your message...');\n            }\n        },\n\n        createNewChat: function() {\n            this.currentChatId = 0;\n            $('#chat-history-list li').removeClass('active');\n            $('#adeptus-chat-container').empty();\n            this.clearMCQ(); // Clear and hide MCQ container\n\n            // Show welcome message in the new empty chat\n            this.showWelcomeMessage();\n        },\n\n        showWelcomeMessage: function() {\n            const welcomeHtml = `\n                <div class=\"adeptus-welcome-message text-center p-5\">\n                    <div style=\"max-width: 600px; margin: 0 auto;\">\n                        <h3 class=\"mb-4\">Welcome to Adeptus AI Assistant</h3>\n                        <p class=\"text-muted mb-4\">\n                            I'm here to help you analyze your Moodle data and generate insightful reports.\n                        </p>\n                        <div class=\"row g-3\">\n                            <div class=\"col-md-6\">\n                                <div class=\"p-3 bg-light rounded\">\n                                    <i class=\"fa fa-chart-bar fa-2x mb-2 text-primary\"></i>\n                                    <h5>Generate Reports</h5>\n                                    <small class=\"text-muted\">Ask me to create custom reports about courses, users, grades, and more.</small>\n                                </div>\n                            </div>\n                            <div class=\"col-md-6\">\n                                <div class=\"p-3 bg-light rounded\">\n                                    <i class=\"fa fa-question-circle fa-2x mb-2 text-info\"></i>\n                                    <h5>Get Insights</h5>\n                                    <small class=\"text-muted\">I can help you understand your data and provide actionable insights.</small>\n                                </div>\n                            </div>\n                        </div>\n                        <hr class=\"my-4\">\n                        <p class=\"text-muted\">\n                            <i class=\"fa fa-lightbulb\"></i> Try asking: \"Show me all active courses with their enrollment counts\"\n                        </p>\n                    </div>\n                </div>\n            `;\n            $('#adeptus-chat-container').html(welcomeHtml);\n        },\n\n        addChatToChatHistory(chatId, firstMessage) {\n\n            const list = $('#chat-history-list');\n\n            // Remove any placeholders\n            list.find('li:contains(\"No chat history\")').remove();\n            list.find('li:contains(\"No chats yet\")').remove();\n            list.find('li:contains(\"Start a conversation\")').remove();\n\n            const date = new Date().toLocaleString();\n            // Truncate message if too long for display\n            const displayMessage = firstMessage && firstMessage.length > 100\n                ? firstMessage.substring(0, 97) + '...'\n                : firstMessage || 'New chat';\n\n            const item = $(\n                `<li class=\"list-group-item d-flex justify-content-between align-items-start adeptus-chat-history-item\" data-chat-id=\"${chatId}\">\n                    <div>\n                        <small class=\"text-muted\">${date}</small><br>\n                        ${displayMessage}\n                    </div>\n                </li>`\n            );\n            list.prepend(item);\n            item.on('click', (e) => {\n                const li = $(e.currentTarget);\n                const clickedChatId = li.data('chat-id');\n                this.loadChatMessages(clickedChatId, li);\n            });\n        },\n\n        initializeCharts: function() {\n            // Initialize with empty chart\n            const container = $('#adeptus-chart-container');\n            const canvas = $('<canvas></canvas>');\n            container.append(canvas);\n\n            new Chart(canvas[0], {\n                type: 'bar',\n                data: {\n                    labels: [],\n                    datasets: []\n                },\n                options: {\n                    responsive: true,\n                    maintainAspectRatio: false\n                }\n            });\n        },\n\n        setUserName: function(user) {\n            let userName = \"User\";\n            if (typeof user === 'string') {\n                userName = user;\n            } else if (user && user.name) {\n                userName = user.name;\n            } else if (user && user.admin_name) {\n                userName = user.admin_name;\n            }\n\n            // Update the card title with the user's name\n            $(\".card-title\").each(function() {\n                if ($(this).text().includes('AI Report Assistant')) {\n                    $(this).text(userName + ': AI Report Assistant');\n                }\n            });\n        },\n\n        /**\n         * Check if credit usage exceeds the limit\n         * @param used\n         * @param limit\n         */\n        isCreditExceeded: function(used, limit) {\n            if (limit === 0 || limit === 'âˆž' || limit === null || limit === undefined) {\n                return false;\n            }\n            return used >= limit;\n        },\n\n        /**\n         * Check if user has exceeded credit limits and show persistent warning\n         * @param subscription\n         */\n        checkAndShowCreditLimitWarning: function(subscription) {\n\n            // Check if any credit type is exceeded\n            const basicExceeded = this.isCreditExceeded(\n                subscription.basic_credits_used_this_month || 0,\n                subscription.plan_basic_credits_limit || 0\n            );\n            const premiumExceeded = this.isCreditExceeded(\n                subscription.premium_credits_used_this_month || 0,\n                subscription.plan_premium_credits_limit || 0\n            );\n            const totalExceeded = this.isCreditExceeded(\n                subscription.ai_credits_used_this_month || 0,\n                subscription.plan_ai_credits_limit || 0\n            );\n\n            if (basicExceeded || premiumExceeded || totalExceeded) {\n                const message = \"You've used all your AI credits for this month. Your credits will reset on the 1st of next month. Consider upgrading your plan for more credits.\";\n                this.showPersistentCreditLimitMessage(message);\n                // Set global variable to true\n                this.isCreditLimitExceeded = true;\n                this.updateSendMessageandCreateNewChatButton();\n            } else {\n                this.isCreditLimitExceeded = false;\n                this.updateSendMessageandCreateNewChatButton();\n            }\n        },\n\n        updateSubscriptionInfo: async function() {\n            // First, fetch latest subscription data from the server using external service\n            try {\n                var promises = Ajax.call([{\n                    methodname: 'report_adeptus_insights_check_subscription_status',\n                    args: {}\n                }]);\n\n                var result = await promises[0];\n                var data = {success: result.success, data: result.data ? result.data : result};\n\n                // Log exactly what fields we're receiving for debugging\n                if (data.success && data.data) {\n\n                    // Update AuthUtils with fresh data\n                    const authStatus = AuthUtils.getAuthStatus() || {};\n                    authStatus.subscription = data.data;\n                    // Store updated auth status\n                    if (typeof AuthUtils.updateSubscription === 'function') {\n                        AuthUtils.updateSubscription(data.data);\n                    }\n                }\n            } catch (error) {\n                // Subscription status fetch failed, continue with cached data.\n            }\n\n            // Get subscription info from auth status (now updated with fresh data)\n            const authStatus = AuthUtils.getAuthStatus();\n\n\n            if (authStatus && authStatus.subscription) {\n                const subscription = authStatus.subscription;\n\n                // Check if user has exceeded credit limits and show persistent message\n                this.checkAndShowCreditLimitWarning(subscription);\n\n                // Don't remove the template header - it's correctly positioned\n                // Just remove any dynamically added subscription info to prevent duplicates\n                $('.adeptus-subscription-status-bar').remove();\n\n                // Create subscription info display (separate from main header)\n                let subscriptionHtml = `\n                    <div class=\"adeptus-subscription-status-bar\">\n                        <div class=\"adeptus-subscription-bar-row\">\n                            <div class=\"adeptus-subscription-info-left\">\n                                <h6 class=\"adeptus-subscription-title\">\n                                    <i class=\"fa fa-chart-line adeptus-subscription-icon\"></i> Subscription Status\n                                    <button class=\"btn btn-outline-secondary btn-sm\" id=\"refresh-subscription-btn\" title=\"Refresh subscription data\">\n                                        <i class=\"fa fa-refresh\"></i>\n                                    </button>\n                                </h6>\n                                <div class=\"adeptus-subscription-details\">\n                                    <span><strong>Plan:</strong> ${subscription.plan_name || 'Unknown'}</span>\n                                    <span class=\"ms-3\"><strong>Status:</strong> <span class=\"badge bg-${subscription.status === 'active' ? 'success' : 'warning'}\">${subscription.status || 'Unknown'}</span></span>\n                                </div>\n                            </div>\n                            <div class=\"adeptus-subscription-actions-right\">\n                                <a href=\"javascript:void(0)\" onclick=\"window.assistant.showCreditUsageModal()\" class=\"btn adeptus-btn-view-usage\">\n                                    <i class=\"fa fa-chart-bar\"></i> View Usage\n                                </a>\n                            </div>\n                        </div>\n                    </div>\n                `;\n\n                // Template already has the header banner - no need to create assistantHtml\n                // Insert subscription status bar at the bottom of the page\n\n                // Insert subscription bar at the bottom of the AI Assistant container\n                // Use ID selector for reliability\n                const assistantContainer = $('#adeptus-assistant-container');\n                if (assistantContainer.length) {\n                    assistantContainer.append(subscriptionHtml);\n                } else {\n                    // Fallback: insert after the template header\n                    const templateHeader = $('.adeptus-assistant-header');\n                    if (templateHeader.length) {\n                        templateHeader.after(subscriptionHtml);\n                    }\n                }\n\n                // Bind refresh button event\n                const self = this;\n                $('#refresh-subscription-btn').off('click').on('click', function() {\n                    const $btn = $(this);\n                    const $icon = $btn.find('i');\n\n                    // Show loading state\n                    $icon.removeClass('fa-refresh').addClass('fa-spinner fa-spin');\n                    $btn.prop('disabled', true);\n\n                    // Refresh subscription info\n                    self.refreshSubscriptionInfo();\n\n                    // Reset button state after refresh\n                    setTimeout(() => {\n                        $icon.removeClass('fa-spinner fa-spin').addClass('fa-refresh');\n                        $btn.prop('disabled', false);\n                    }, 1000);\n                });\n            } else {\n                // Remove subscription info if no data available\n                $('.adeptus-subscription-status-bar').remove();\n            }\n        },\n\n        /**\n         * Transform backend auth data to match frontend expectations\n         * @param backendData\n         */\n        transformBackendAuthData: function(backendData) {\n            if (!backendData) {\n return null;\n}\n\n            // Get current auth data to preserve existing structure\n            const currentAuthData = window.adeptusAuthData || {};\n\n            // Transform the data to match the expected frontend structure\n            const transformedData = {\n                ...currentAuthData, // Preserve existing auth data\n                user_authorized: true,\n                has_api_key: true,\n                installation: backendData.installation,\n                subscription: backendData.subscription ? {\n                    ...backendData.subscription,\n                    // Map the usage data to the expected format\n                    premium_credits_used_this_month: backendData.usage ? (backendData.usage.premium_credits_used_this_month || 0) : 0,\n                    basic_credits_used_this_month: backendData.usage ? (backendData.usage.basic_credits_used_this_month || 0) : 0,\n                    ai_credits_used_this_month: backendData.usage ? (backendData.usage.ai_credits_used_this_month || 0) : 0,\n                    reports_generated_this_month: backendData.usage ? (backendData.usage.reports_generated_this_month || 0) : 0,\n                    // Map plan data\n                    plan_name: backendData.plan ? backendData.plan.name : 'Unknown',\n                    plan_premium_credits_limit: backendData.plan ? (backendData.plan.premium_credits_per_month || 0) : 0,\n                    plan_basic_credits_limit: backendData.plan ? (backendData.plan.basic_credits_per_month || 'âˆž') : 'âˆž',\n                    plan_ai_credits_limit: backendData.plan ? (backendData.plan.ai_credits || 0) : 0,\n                    plan_exports_limit: backendData.plan ? (backendData.plan.exports || 'âˆž') : 'âˆž'\n                } : null,\n                plan: backendData.plan,\n                usage: backendData.usage\n            };\n\n            return transformedData;\n        },\n\n        /**\n         * Refresh subscription info by getting fresh data from backend\n         */\n        refreshSubscriptionInfo: async function() {\n\n            // Show loading state on refresh button\n            const $refreshBtn = $('#refresh-subscription-btn');\n            const $refreshIcon = $refreshBtn.find('i');\n            if ($refreshBtn.length && $refreshIcon.length) {\n                $refreshIcon.removeClass('fa-refresh').addClass('fa-spinner fa-spin');\n                $refreshBtn.prop('disabled', true);\n            }\n\n            try {\n                // First, get fresh local subscription data using external service\n                var promises = Ajax.call([{\n                    methodname: 'report_adeptus_insights_check_subscription_status',\n                    args: {}\n                }]);\n\n                var result = await promises[0];\n                var localData = {success: result.success, data: result.data ? result.data : result};\n\n                if (localData.success && localData.data) {\n                    // Update AuthUtils with fresh data\n                    const authStatus = AuthUtils.getAuthStatus() || {};\n                    authStatus.subscription = localData.data;\n\n                    // Also update the global auth data\n                    if (window.adeptusAuthData) {\n                        window.adeptusAuthData.subscription = localData.data;\n                    }\n                }\n\n                // Then update the display with fresh data\n                await this.updateSubscriptionInfo();\n\n\n                // Show success feedback\n                this.showRefreshSuccessFeedback();\n\n            } catch (error) {\n                this.showRefreshErrorFeedback();\n            } finally {\n                // Reset button state\n                if ($refreshBtn.length && $refreshIcon.length) {\n                    $refreshIcon.removeClass('fa-spinner fa-spin').addClass('fa-refresh');\n                    $refreshBtn.prop('disabled', false);\n                }\n            }\n        },\n\n        /**\n         * Show success feedback for subscription refresh\n         */\n        showRefreshSuccessFeedback: function() {\n            const notification = $(`\n                <div class=\"adeptus-refresh-success-notification\" style=\"\n                    position: fixed;\n                    top: 20px;\n                    right: 20px;\n                    background: #28a745;\n                    color: white;\n                    padding: 8px 16px;\n                    border-radius: 4px;\n                    box-shadow: 0 2px 8px rgba(0,0,0,0.15);\n                    z-index: 9999;\n                    font-size: 12px;\n                    opacity: 0;\n                    transform: translateY(-20px);\n                    transition: all 0.3s ease;\n                \">\n                    <i class=\"fa fa-check me-1\"></i>\n                    Usage updated\n                </div>\n            `);\n\n            $('body').append(notification);\n\n            // Animate in\n            setTimeout(() => {\n                notification.css({\n                    'opacity': '1',\n                    'transform': 'translateY(0)'\n                });\n            }, 100);\n\n            // Remove after 2 seconds\n            setTimeout(() => {\n                notification.css({\n                    'opacity': '0',\n                    'transform': 'translateY(-20px)'\n                });\n                setTimeout(() => notification.remove(), 300);\n            }, 2000);\n        },\n\n        /**\n         * Show error feedback for subscription refresh\n         */\n        showRefreshErrorFeedback: function() {\n            const notification = $(`\n                <div class=\"adeptus-refresh-error-notification\" style=\"\n                    position: fixed;\n                    top: 20px;\n                    right: 20px;\n                    background: #dc3545;\n                    color: white;\n                    padding: 8px 16px;\n                    border-radius: 4px;\n                    box-shadow: 0 2px 8px rgba(0,0,0,0.15);\n                    z-index: 9999;\n                    font-size: 12px;\n                    opacity: 0;\n                    transform: translateY(-20px);\n                    transition: all 0.3s ease;\n                \">\n                    <i class=\"fa fa-exclamation-triangle me-1\"></i>\n                    Failed to update usage\n                </div>\n            `);\n\n            $('body').append(notification);\n\n            // Animate in\n            setTimeout(() => {\n                notification.css({\n                    'opacity': '1',\n                    'transform': 'translateY(0)'\n                });\n            }, 100);\n\n            // Remove after 3 seconds\n            setTimeout(() => {\n                notification.css({\n                    'opacity': '0',\n                    'transform': 'translateY(-20px)'\n                });\n                setTimeout(() => notification.remove(), 300);\n            }, 3000);\n        },\n\n        /**\n         * Calculate usage percentage for progress bar\n         * @param used\n         * @param limit\n         */\n        calculateUsagePercentage: function(used, limit) {\n            if (!limit || limit === 'âˆž' || limit === 0) {\n                return 0;\n            }\n            const percentage = (used / limit) * 100;\n            return Math.min(percentage, 100); // Cap at 100%\n        },\n\n\n        ajaxWithAuth: function(options) {\n            // Check authentication before making the request\n            if (!AuthUtils.isAuthenticated()) {\n                this.showAuthenticationError();\n                return Promise.reject(new Error('Authentication required'));\n            }\n\n            // Route through Moodle AJAX proxy to avoid CORS/Cloudflare Access issues.\n            // Extract the endpoint path from the full URL.\n            var endpoint = options.url;\n            if (endpoint.indexOf(this.backendUrl) === 0) {\n                endpoint = endpoint.substring(this.backendUrl.length);\n            }\n\n            var method = (options.method || options.type || 'GET').toUpperCase();\n            var body = '';\n            if (method === 'POST' && options.data) {\n                body = typeof options.data === 'string' ? options.data : JSON.stringify(options.data);\n            }\n\n            var deferred = $.Deferred();\n\n            Ajax.call([{\n                methodname: 'report_adeptus_insights_proxy_backend_request',\n                args: {\n                    endpoint: endpoint,\n                    method: method,\n                    body: body\n                }\n            }])[0].done(function(result) {\n                try {\n                    var parsed = JSON.parse(result.data || '{}');\n                    if (options.success) {\n                        options.success(parsed);\n                    }\n                    deferred.resolve([parsed, 'success', {status: result.httpcode}]);\n                } catch (e) {\n                    if (options.success) {\n                        options.success(result.data);\n                    }\n                    deferred.resolve([result.data, 'success', {status: result.httpcode}]);\n                }\n            }).fail(function(err) {\n                if (options.error) {\n                    options.error(err);\n                }\n                deferred.reject(err);\n            });\n\n            // Return a thenable that mimics jQuery ajax for .then()/.catch() chains.\n            return deferred.promise();\n        },\n\n        /**\n         * Load report categories from the backend API\n         * Caches the categories for use in save dialogs\n         */\n        loadCategories: function() {\n            const self = this;\n\n            this.ajaxWithAuth({\n                url: this.backendUrl + '/reports/categories',\n                method: 'GET',\n                contentType: 'application/json',\n                success: (response) => {\n                    if (response.success && response.data) {\n                        self.cachedCategories = response.data;\n                    }\n                },\n                error: () => {\n                    // Set default category as fallback\n                    self.cachedCategories = [\n                        {id: null, name: 'General', slug: 'general', color: '#6c757d', icon: 'fa-folder'}\n                    ];\n                }\n            });\n        },\n\n        /**\n         * Get category options HTML for the save dialog dropdown\n         * @param {string} suggestedCategory - The AI-suggested category name\n         * @returns {string} HTML options string\n         */\n        getCategoryOptionsHtml: function(suggestedCategory) {\n            if (!this.cachedCategories || this.cachedCategories.length === 0) {\n                return '<option value=\"\">General</option>';\n            }\n\n            // Normalize the suggested category for comparison\n            const normalizedSuggested = (suggestedCategory || 'general').toLowerCase().replace(/[^a-z0-9]/g, '');\n\n            return this.cachedCategories.map(cat => {\n                const normalizedCatName = cat.name.toLowerCase().replace(/[^a-z0-9]/g, '');\n                const normalizedCatSlug = (cat.slug || '').toLowerCase().replace(/[^a-z0-9]/g, '');\n                const isSelected = normalizedCatName === normalizedSuggested ||\n                                   normalizedCatSlug === normalizedSuggested;\n                return `<option value=\"${cat.id}\" ${isSelected ? 'selected' : ''}>${cat.name}</option>`;\n            }).join('');\n        },\n\n        validateToken: function() {\n            return AuthUtils.isAuthenticated();\n        },\n\n        resendMessage: function($msgElem, message) {\n            if (this.isSending) {\n                return;\n            }\n\n            this.isSending = true;\n\n            // Show the AI thinking loader after the user's choice\n            this.showLoading();\n\n            // Get user information from auth status\n            const authStatus = AuthUtils.getAuthStatus();\n            const userInfo = authStatus?.user || {};\n\n            this.ajaxWithAuth({\n                url: this.backendUrl + '/chat/message',\n                method: 'POST',\n                contentType: 'application/json',\n                data: JSON.stringify({\n                    message: message,\n                    chat_id: this.currentChatId || 0,\n                    user_id: userInfo.id || null,\n                    user_name: userInfo.name || null\n                }),\n                success: (response) => {\n                    this.hideLoading();\n                    this.isSending = false;\n                    if (response.error) {\n                        // Handle specific error types\n                        if (response.error_type === 'credit_limit' || response.error_type === 'token_limit') {\n                            this.handleCreditLimitError(response.message, response.credit_data);\n                        } else if (response.error_type === 'report_limit') {\n                            this.handleReportLimitError(response.message);\n                        } else {\n                        // Display backend error as chat bubble\n                        this.addMessage(response.message, 'error');\n                        // Show resend icon on the specific message that failed\n                        this.showResendIconOnMessage($msgElem, message);\n                        }\n                        return;\n                    }\n                    // Remove all resend icons on successful resend\n                    $('.adeptus-failed-reload-icon').remove();\n\n                    if (!this.currentChatId && response.chat_id) {\n                        this.currentChatId = response.chat_id;\n                        this.addChatToChatHistory(response.chat_id, message);\n                    }\n                    this.handleResponse(response);\n                },\n                error: (err) => {\n                    this.hideLoading();\n                    this.isSending = false;\n                    if (err.status === 401) {\n                        AuthUtils.clearAuthData();\n                        this.showAuthenticationError();\n                    } else {\n                        // Show resend icon on the specific message that failed\n                        this.showResendIconOnMessage($msgElem, message);\n                        this.addMessage('Network error occurred. Please try again.', 'error');\n                    }\n                }\n            });\n        },\n\n        /**\n         * Push an array of MCQs into our queue and display the first one.\n         * @param {Array} questions  Array of {question: string, options: []}\n         */\n        enqueueMCQs: function(questions) {\n            if (!Array.isArray(questions) || questions.length === 0) {\n                return;\n            }\n            this.mcqQueue = questions.slice(); // Copy\n            this.showNextMCQ();\n        },\n\n        /**\n         * Display the next MCQ in the queue, or end MCQ mode if none left.\n         */\n        showNextMCQ: function() {\n            if (this.mcqQueue.length === 0) {\n                return this.clearMCQ();\n            }\n            const next = this.mcqQueue.shift();\n            this.renderMCQ(next.question, next.options);\n        },\n\n        /**\n         * Render a single MCQ question with radio buttons.\n         * @param {string} question\n         * @param {string[]} options\n         */\n        renderMCQ: function(question, options) {\n            this.currentMCQ = true;\n            $('#message-input, #send-button').prop('disabled', true);\n            const c = $('#adeptus-mcq-container').empty().show();\n            c.append(`<p class=\"adeptus-mcq-question\"><strong>${question}</strong></p>`);\n            options.forEach((opt, idx) => {\n                const key = String.fromCharCode(65 + idx);\n                c.append(`\n                <div class=\"form-check\">\n                    <input class=\"form-check-input\" type=\"radio\"\n                        name=\"mcq-option\" id=\"mcq-${idx}\"\n                        value=\"${opt}\">\n                    <label class=\"form-check-label\" for=\"mcq-${idx}\">\n                    ${key}. ${opt}\n                    </label>\n                </div>`);\n            });\n            c.append(`<button type=\"button\" class=\"btn btn-link\" id=\"mcq-cancel\">Cancel</button>`);\n            // Bind selection\n            c.find('input[name=\"mcq-option\"]').on('change', () => {\n                $('#mcq-submit').remove();\n                c.append(`<button type=\"button\" id=\"mcq-submit\" class=\"btn btn-primary mt-2\">Submit</button>`);\n                $('#mcq-submit').off('click').on('click', (e) => {\n                    e.preventDefault();\n                    e.stopPropagation();\n                    const selected = c.find('input[name=\"mcq-option\"]:checked').val();\n                    if (selected) {\n                        this.sendMCQ(selected);\n                    }\n                });\n            });\n            // Cancel\n            c.find('#mcq-cancel').off('click').on('click', (e) => {\n                e.preventDefault();\n                this.mcqQueue = [];\n                this.clearMCQ();\n            });\n        },\n\n        /**\n         * Send the selected MCQ answer to the backend, then show next question if any.\n         * @param answer\n         */\n        sendMCQ: function(answer) {\n            if (this.isSending) {\n                return;\n            }\n\n            // Validate answer is not empty\n            if (!answer || typeof answer !== 'string' || !answer.trim()) {\n                return;\n            }\n\n            this.showLoading();\n            this.isSending = true;\n            this.clearMCQ(); // Clear current UI\n            const $userMsg = this.addMessage(answer, 'user'); // Echo user choice (clean display)\n            // Get user information from auth status\n            const authStatus = AuthUtils.getAuthStatus();\n            const userInfo = authStatus?.user || {};\n\n            // Wrap answer with context so AI understands this is a selection, not a new question\n            const messageToSend = `I selected: ${answer.trim()}`;\n\n            this.ajaxWithAuth({\n                url: this.backendUrl + '/chat/message',\n                method: 'POST',\n                contentType: 'application/json',\n                data: JSON.stringify({\n                    message: messageToSend,\n                    chat_id: this.currentChatId || 0,\n                    user_id: userInfo.id || null,\n                    user_name: userInfo.name || null\n                }),\n                success: (response) => {\n                    this.hideLoading();\n                    this.isSending = false;\n                    if (response.error) {\n                        // Handle specific error types\n                        if (response.error_type === 'credit_limit' || response.error_type === 'token_limit') {\n                            this.handleCreditLimitError(response.message);\n                        } else if (response.error_type === 'report_limit') {\n                            this.handleReportLimitError(response.message);\n                        } else {\n                        this.addMessage(response.message, 'error');\n                        this.showResendIconOnMessage($userMsg, answer);\n                        }\n                        return;\n                    }\n                    // Remove any existing resend icons on success\n                    $('.adeptus-failed-reload-icon').remove();\n                    // Handle response using the same logic as regular messages\n                    this.handleResponse(response);\n                },\n                error: () => {\n                    this.hideLoading();\n                    this.isSending = false;\n                    this.addMessage('Failed to send choice', 'error');\n                    this.showResendIconOnMessage($userMsg, answer);\n                }\n            });\n        },\n\n        /**\n         * Show report confirmation dialog\n         * @param report\n         * @param reportData\n         * @param message\n         * @param creditInfo\n         * @param executionError\n         */\n        showReportConfirmation: function(report, reportData, message, creditInfo, executionError) {\n            // First add the AI message to chat\n            this.addMessage(message || `I've generated a report: ${report.description}`, 'ai', false, null, null, null, creditInfo);\n\n            // Display the report data immediately\n            if (reportData && reportData.length > 0) {\n                // Create a report display in the chat\n                this.displayReportInChat(report, reportData);\n            } else if (executionError) {\n                // Show error message but still allow saving\n                this.addMessage(`âš ï¸ The report could not be executed: ${executionError}\\n\\nYou can still save it and try executing it later.`, 'system');\n            } else {\n                // No data returned\n                this.addMessage('â„¹ï¸ The report returned no data. You can still save it for later use.', 'system');\n            }\n\n            // Add save/decline buttons directly in the chat\n            this.addReportActionButtons(report);\n        },\n\n        /**\n         * Display report data in the chat\n         * @param report\n         * @param data\n         */\n        displayReportInChat: function(report, data) {\n            // Create a nice table display\n            let tableHtml = '<div class=\"adeptus-report-preview-container\" style=\"margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 8px; border: 1px solid #dee2e6;\">';\n            tableHtml += `<h5 style=\"margin-bottom: 10px; color: #495057;\">${report.name || report.description}</h5>`;\n\n            if (data && data.length > 0) {\n                const headers = Object.keys(data[0]);\n                // Show more rows for better preview (20 instead of 10)\n                const maxPreviewRows = 20;\n                const previewRows = data.slice(0, maxPreviewRows);\n\n                // Remove fixed height and scrolling - let table be its natural size\n                tableHtml += '<div class=\"table-responsive\">';\n                tableHtml += '<table class=\"table table-sm table-striped table-hover\" style=\"font-size: 0.9rem; margin-bottom: 0;\">';\n\n                // Simplified header without sticky positioning in chat preview\n                tableHtml += '<thead class=\"table-light\"><tr>';\n                headers.forEach(header => {\n                    tableHtml += `<th style=\"background: #e9ecef; white-space: nowrap;\">${header.replace(/_/g, ' ').replace(/\\b\\w/g, l => l.toUpperCase())}</th>`;\n                });\n                tableHtml += '</tr></thead><tbody>';\n\n                previewRows.forEach(row => {\n                    tableHtml += '<tr>';\n                    headers.forEach(header => {\n                        let value = row[header] || '';\n                        // Truncate long values\n                        if (value.toString().length > 50) {\n                            value = value.toString().substring(0, 47) + '...';\n                        }\n                        tableHtml += `<td>${value}</td>`;\n                    });\n                    tableHtml += '</tr>';\n                });\n                tableHtml += '</tbody></table></div>';\n\n                // Show remaining row count and add view full report hint\n                if (data.length > maxPreviewRows) {\n                    const remainingRows = data.length - maxPreviewRows;\n                    tableHtml += `<div class=\"text-center mt-3\">`;\n                    tableHtml += `<p class=\"text-muted mb-2\" style=\"font-size: 0.85rem;\">`;\n                    tableHtml += `<strong>Showing ${maxPreviewRows} of ${data.length} rows</strong>`;\n                    tableHtml += ` (${remainingRows} more rows available)`;\n                    tableHtml += `</p>`;\n                    tableHtml += `<small class=\"text-info\"><i class=\"fa fa-info-circle\"></i> Save the report to view all data in the Reports panel</small>`;\n                    tableHtml += `</div>`;\n                } else {\n                    tableHtml += `<p class=\"text-muted text-center mt-2\" style=\"font-size: 0.85rem;\">Showing all ${data.length} rows</p>`;\n                }\n\n                // Add report metadata (category only)\n                tableHtml += '<div class=\"mt-3 p-2 bg-light rounded\" style=\"font-size: 0.85rem;\">';\n                tableHtml += `<span class=\"badge badge-secondary\">${report.category}</span>`;\n                tableHtml += '</div>';\n            }\n\n            tableHtml += '</div>';\n\n            // Add the table as a special message in the chat\n            this.addMessage(tableHtml, 'report-preview', false);\n        },\n\n        /**\n         * Add report action buttons in the chat\n         * @param report\n         */\n        addReportActionButtons: function(report) {\n            const self = this;\n\n            // Check if action buttons for this report already exist\n            const existingActions = document.querySelectorAll('.adeptus-report-action-container');\n            if (existingActions.length > 0) {\n                // Remove any existing action containers to prevent duplicates\n                existingActions.forEach(container => {\n                    if (!container.querySelector('.fa-check-circle') &&\n                        !container.querySelector('.fa-info-circle') &&\n                        !container.querySelector('.fa-exclamation-triangle')) {\n                        // Only remove if it's still showing buttons (not completed/error state)\n                        container.remove();\n                    }\n                });\n            }\n\n            const buttonId = 'report-action-' + Date.now();\n\n            // Create the action buttons HTML\n            const buttonsHtml = `\n                <div class=\"adeptus-report-action-container\" id=\"${buttonId}\" style=\"margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 8px; border: 1px solid #dee2e6;\">\n                    <p style=\"margin-bottom: 15px; font-weight: 500;\">Would you like to save this report to your Reports list?</p>\n                    <div class=\"adeptus-report-actions\" style=\"display: flex; gap: 10px; flex-wrap: wrap;\">\n                        <button class=\"btn btn-primary adeptus-btn-save-report\" style=\"padding: 8px 20px;\">\n                            <i class=\"fa fa-check-circle\"></i> Save Report\n                        </button>\n                        <button class=\"btn btn-secondary adeptus-btn-decline-report\" style=\"padding: 8px 20px;\">\n                            <i class=\"fa fa-times-circle\"></i> Don't Save\n                        </button>\n                        <button class=\"btn btn-outline-secondary adeptus-btn-decline-feedback\" style=\"padding: 8px 20px;\">\n                            <i class=\"fa fa-comment\"></i> Decline & Give Feedback\n                        </button>\n                    </div>\n                </div>\n            `;\n\n            // Add the buttons as a system message\n            this.addMessage(buttonsHtml, 'system-action', false);\n\n            // Attach event handlers after DOM insertion\n            setTimeout(() => {\n                const container = document.getElementById(buttonId);\n                if (!container) {\n return;\n}\n\n                // Save button\n                const saveBtn = container.querySelector('.adeptus-btn-save-report');\n                if (saveBtn && !saveBtn.hasAttribute('data-handler-attached')) {\n                    // Mark that we've attached a handler to prevent duplicates\n                    saveBtn.setAttribute('data-handler-attached', 'true');\n                    saveBtn.addEventListener('click', function() {\n                        // Get category options HTML\n                        const categoryOptions = self.getCategoryOptionsHtml(report.category);\n                        const defaultName = report.name || report.description || 'SCORM Activities Report';\n\n                        // Prompt for report name and category using SweetAlert\n                        Swal.fire({\n                            title: getString('save_your_report', 'Save Your Report'),\n                            html: `\n                                <div style=\"text-align: left;\">\n                                    <div style=\"margin-bottom: 15px;\">\n                                        <label for=\"swal-report-name\" style=\"display: block; margin-bottom: 5px; font-weight: 500;\">\n                                            ${getString('report_name_label', 'Report Name')}\n                                        </label>\n                                        <input type=\"text\" id=\"swal-report-name\" class=\"swal2-input\"\n                                               placeholder=\"${getString('enter_report_name', 'Enter a name for your report')}\"\n                                               value=\"${defaultName.replace(/\"/g, '&quot;')}\"\n                                               style=\"margin: 0; width: 100%;\">\n                                    </div>\n                                    <div>\n                                        <label for=\"swal-report-category\" style=\"display: block; margin-bottom: 5px; font-weight: 500;\">\n                                            ${getString('category_label', 'Category')}\n                                        </label>\n                                        <select id=\"swal-report-category\" class=\"swal2-select\"\n                                                style=\"margin: 0; width: 100%; padding: 8px 12px; border: 1px solid #d9d9d9; border-radius: 4px;\">\n                                            ${categoryOptions}\n                                        </select>\n                                    </div>\n                                </div>\n                            `,\n                            showCancelButton: true,\n                            confirmButtonText: '<i class=\"fa fa-save\"></i> ' + getString('save_report', 'Save Report'),\n                            cancelButtonText: getString('cancel', 'Cancel'),\n                            confirmButtonColor: '#28a745',\n                            focusConfirm: false,\n                            preConfirm: () => {\n                                const name = document.getElementById('swal-report-name').value;\n                                const categoryId = document.getElementById('swal-report-category').value;\n\n                                if (!name || name.trim() === '') {\n                                    Swal.showValidationMessage('Please enter a name for the report');\n                                    return false;\n                                }\n                                if (name.length > 255) {\n                                    Swal.showValidationMessage('Report name is too long (max 255 characters)');\n                                    return false;\n                                }\n\n                                return {name: name.trim(), categoryId: categoryId};\n                            }\n                        }).then((result) => {\n                            if (result.isConfirmed) {\n                                // Update report with user input\n                                report.name = result.value.name;\n                                report.description = result.value.name;\n                                report.category_id = result.value.categoryId ? parseInt(result.value.categoryId) : null;\n\n                                // Disable all buttons\n                                container.querySelectorAll('button').forEach(btn => { btn.disabled = true; });\n\n                                // Update the container to show saving state\n                                container.innerHTML = `\n                                    <div style=\"text-align: center; color: #28a745;\">\n                                        <i class=\"fa fa-spinner fa-spin\"></i> Saving \"${report.name}\" to your Reports list...\n                                    </div>\n                                `;\n\n                                // Send confirmation to backend\n                                self.confirmReport('accept', report, null);\n                            }\n                        });\n                    });\n                }\n\n                // Don't save button\n                const declineBtn = container.querySelector('.adeptus-btn-decline-report');\n                if (declineBtn && !declineBtn.hasAttribute('data-handler-attached')) {\n                    declineBtn.setAttribute('data-handler-attached', 'true');\n                    declineBtn.addEventListener('click', function() {\n                        // Update container to show declined state\n                        container.innerHTML = `\n                            <div style=\"text-align: center; color: #6c757d;\">\n                                <i class=\"fa fa-info-circle\"></i> Report not saved. You can ask me to generate it again anytime.\n                            </div>\n                        `;\n\n                        // Also add a message in the chat\n                        self.addMessage(\"Report was not saved. Feel free to ask me to generate a different report or refine this one.\", 'system');\n                    });\n                }\n\n                // Decline with feedback button\n                const feedbackBtn = container.querySelector('.adeptus-btn-decline-feedback');\n                if (feedbackBtn && !feedbackBtn.hasAttribute('data-handler-attached')) {\n                    feedbackBtn.setAttribute('data-handler-attached', 'true');\n                    feedbackBtn.addEventListener('click', function() {\n                        // Replace buttons with feedback form\n                        container.innerHTML = `\n                            <div class=\"adeptus-feedback-form\">\n                                <p style=\"margin-bottom: 10px;\">What would you like to change about this report?</p>\n                                <textarea id=\"feedback-text-${buttonId}\" class=\"form-control\" rows=\"3\" placeholder=\"Please provide your feedback...\"></textarea>\n                                <div style=\"margin-top: 10px; display: flex; gap: 10px;\">\n                                    <button class=\"btn btn-primary adeptus-btn-send-feedback\">\n                                        <i class=\"fa fa-paper-plane\"></i> Send Feedback\n                                    </button>\n                                    <button class=\"btn btn-secondary adeptus-btn-cancel-feedback\">\n                                        Cancel\n                                    </button>\n                                </div>\n                            </div>\n                        `;\n\n                        // Attach feedback form handlers\n                        const sendFeedbackBtn = container.querySelector('.adeptus-btn-send-feedback');\n                        const cancelFeedbackBtn = container.querySelector('.adeptus-btn-cancel-feedback');\n                        const feedbackText = container.querySelector(`#feedback-text-${buttonId}`);\n\n                        if (sendFeedbackBtn) {\n                            sendFeedbackBtn.addEventListener('click', function() {\n                                const feedback = feedbackText ? feedbackText.value : '';\n                                if (feedback.trim()) {\n                                    container.innerHTML = `\n                                        <div style=\"text-align: center; color: #007bff;\">\n                                            <i class=\"fa fa-spinner fa-spin\"></i> Sending feedback...\n                                        </div>\n                                    `;\n                                    self.confirmReport('decline', report, feedback);\n                                } else {\n                                    feedbackText.style.borderColor = '#dc3545';\n                                    feedbackText.focus();\n                                }\n                            });\n                        }\n\n                        if (cancelFeedbackBtn) {\n                            cancelFeedbackBtn.addEventListener('click', function() {\n                                container.innerHTML = `\n                                    <div style=\"text-align: center; color: #6c757d;\">\n                                        <i class=\"fa fa-info-circle\"></i> Report not saved.\n                                    </div>\n                                `;\n                            });\n                        }\n                    });\n                }\n            }, 100);\n        },\n\n        /**\n         * Send report confirmation to backend\n         */\n        /**\n         * View a saved report by slug\n         * @param slug\n         */\n        viewSavedReport: function(slug) {\n            if (!slug) {\n                return;\n            }\n\n            // Switch to Reports tab\n            $('[href=\"#reports-history\"]').tab('show');\n\n            // Give the tab time to render\n            setTimeout(() => {\n                // Find the report row with the matching slug\n                const reportRow = $(`.adeptus-report-row[data-report-slug=\"${slug}\"]`);\n\n                if (reportRow.length) {\n                    // Trigger click on the report row\n                    reportRow.click();\n                } else {\n                    // If not found, try to refresh the reports list\n                    this.loadReportsHistory(() => {\n                        setTimeout(() => {\n                            const refreshedRow = $(`.adeptus-report-row[data-report-slug=\"${slug}\"]`);\n                            if (refreshedRow.length) {\n                                refreshedRow.click();\n                            } else {\n                                // Show error message to user\n                                Notification.addNotification({\n                                    message: getString('report_not_found', 'Report not found. Please check if it still exists in the Reports tab.'),\n                                    type: 'error'\n                                });\n                            }\n                        }, 500);\n                    });\n                }\n            }, 300);\n        },\n\n        /**\n         * Display a report link in the chat\n         * @param msg\n         */\n        displayReportLink: function(msg) {\n            const template = document.getElementById('message-template');\n            const frag = template.content.cloneNode(true);\n            const messageEl = frag.querySelector('.adeptus-message');\n            messageEl.classList.add('adeptus-ai-message');\n            messageEl.setAttribute('data-message-id', msg.id);\n\n            // Create report link HTML\n            const reportSlug = msg.metadata?.report_slug || '';\n            const reportName = msg.metadata?.report_name || 'Report';\n            const reportDescription = msg.metadata?.report_description || '';\n\n            const reportLinkHtml = `\n                <div class=\"adeptus-report-link-message\">\n                    <div style=\"padding: 15px; background: linear-gradient(135deg, #007bff 0%, #0056b3 100%); color: white; border-radius: 10px; margin: 10px 0;\">\n                        <div style=\"display: flex; align-items: center; justify-content: space-between; gap: 20px;\">\n                            <div style=\"flex: 1;\">\n                                <h5 style=\"margin: 0; color: white;\">\n                                    <i class=\"fa fa-chart-bar\"></i> ${reportName}\n                                </h5>\n                                ${reportDescription ? `<small style=\"opacity: 0.9;\">${reportDescription}</small>` : ''}\n                            </div>\n                            ${reportSlug ? `\n                                <button class=\"btn btn-light btn-sm adeptus-view-saved-report-btn\"\n                                        data-slug=\"${reportSlug}\"\n                                        style=\"cursor: pointer; border-radius: 5px; flex-shrink: 0;\">\n                                    <i class=\"fa fa-eye\"></i> View Report\n                                </button>\n                            ` : ''}\n                        </div>\n                    </div>\n                </div>\n            `;\n\n            frag.querySelector('.adeptus-message-text').innerHTML = reportLinkHtml;\n            frag.querySelector('.adeptus-message-time').textContent = this.formatTimestamp(msg.timestamp);\n            $('#adeptus-chat-container').append(frag);\n\n            // Add click handler using the same pattern as the working buttons\n            const self = this;\n            setTimeout(() => {\n                const viewBtn = $('#adeptus-chat-container').find('.adeptus-view-saved-report-btn[data-slug=\"' + reportSlug + '\"]').last();\n                if (viewBtn.length && !viewBtn.hasClass('adeptus-click-handler-attached')) {\n                    viewBtn.addClass('adeptus-click-handler-attached');\n                    viewBtn.on('click', function(e) {\n                        e.preventDefault();\n                        e.stopPropagation();\n\n                        // Use the same pattern as the working View Report button\n                        self.switchToReportsTab();\n\n                        // Find and click the report row\n                        const reportRow = $(`.adeptus-report-row[data-report-slug=\"${reportSlug}\"]`);\n                        if (reportRow.length > 0) {\n                            reportRow.trigger('click');\n                        } else {\n                            // If row doesn't exist, fetch and display directly\n                            self.fetchAndDisplayReport(reportSlug);\n                        }\n                    });\n                }\n            }, 100);\n        },\n\n        /**\n         * Display report link in chat after saving\n         * Note: We only display locally - no backend call to avoid triggering AI processing.\n         * The report is already persisted via the /chat/report-confirmation endpoint.\n         * @param report\n         */\n        sendReportMessage: function(report) {\n            // Create a message that includes report metadata\n            const reportMessage = `ðŸ“Š Report saved: ${report.description || report.name}`;\n\n            // Display the report link immediately in the current chat\n            const reportLinkMsg = {\n                id: Date.now(), // Temporary ID\n                sender_type: 'ai',\n                body: reportMessage,\n                timestamp: new Date().toISOString(),\n                metadata: {\n                    type: 'report',\n                    report_slug: report.slug,\n                    report_name: report.name || report.description,\n                    report_description: report.description\n                }\n            };\n\n            // Display the report link in the chat (local only - no AI call)\n            this.displayReportLink(reportLinkMsg);\n        },\n\n        confirmReport: function(action, report, feedback) {\n            const self = this;\n            this.showLoading();\n            const authStatus = AuthUtils.getAuthStatus();\n            const userInfo = authStatus?.user || {};\n\n            // Ensure all required fields are present\n            const reportData = {\n                name: report.name || report.description || 'Generated Report',\n                description: report.description || '',\n                sql: report.sql || '',\n                category: report.category || 'general',\n                category_id: report.category_id || null\n            };\n\n            // Ensure chat_id is a valid integer\n            const chatId = parseInt(this.currentChatId) || 0;\n\n            this.ajaxWithAuth({\n                url: this.backendUrl + '/chat/report-confirmation',\n                method: 'POST',\n                contentType: 'application/json',\n                timeout: 90000, // 90 seconds for feedback processing (AI can be slow)\n                data: JSON.stringify({\n                    chat_id: chatId,\n                    action: action,\n                    feedback: feedback || null,\n                    report: reportData,\n                    user_id: userInfo.id || null\n                }),\n                success: (response) => {\n                    this.hideLoading();\n                    if (action === 'accept' && response.report) {\n                        // Report accepted - add to list\n                        if (!Array.isArray(this.cachedReports)) {\n                            this.cachedReports = [];\n                        }\n                        this.cachedReports.unshift(response.report);\n                        this.updateReportsHistory(this.cachedReports);\n\n                        // Track AI-generated report creation with backend\n                        const reportName = response.report.name || report.name || report.description || 'AI Generated Report';\n                        this.trackReportCreated(reportName);\n\n                        // Send a message to persist the report link in chat history\n                        this.sendReportMessage(response.report);\n\n                        // Make sure the reports table is visible and loader is hidden\n                        $('#report-history-loader').addClass('d-none');\n                        $('#report-history-table-wrapper').removeClass('d-none');\n\n                        // Ensure the report history table is fully visible\n                        $('#reports-history-table').removeClass('d-none');\n\n                        // Update any active report action containers to show simple success\n                        // The blue gradient card (from sendReportMessage) will have the View Report button\n                        document.querySelectorAll('.adeptus-report-action-container').forEach(container => {\n                            container.innerHTML = `\n                                <div style=\"text-align: center; color: #28a745; padding: 10px;\">\n                                    <i class=\"fa fa-check-circle\"></i> Report saved successfully!\n                                </div>\n                            `;\n                        });\n                    } else {\n                        // Feedback sent - handle refined response\n                        if (response.chat_response) {\n                            // Check if the response indicates an AI service error\n                            const chatResponse = response.chat_response;\n                            const isServiceError = chatResponse.error ||\n                                (chatResponse.message && (\n                                    chatResponse.message.toLowerCase().includes('trouble connecting') ||\n                                    chatResponse.message.toLowerCase().includes('service') ||\n                                    chatResponse.message.toLowerCase().includes('try again')\n                                ));\n\n                            if (isServiceError) {\n                                // AI service had an issue - show error with retry option\n                                const errorMsg = chatResponse.message || 'The AI service is temporarily unavailable.';\n                                document.querySelectorAll('.adeptus-report-action-container').forEach(container => {\n                                    const retryBtnId = 'retry-feedback-' + Date.now();\n                                    container.innerHTML = `\n                                        <div style=\"text-align: center; padding: 10px;\">\n                                            <div style=\"color: #dc3545; margin-bottom: 10px;\">\n                                                <i class=\"fa fa-exclamation-circle\"></i> ${errorMsg}\n                                            </div>\n                                            <button id=\"${retryBtnId}\" class=\"btn btn-primary btn-sm\">\n                                                <i class=\"fa fa-refresh\"></i> Retry\n                                            </button>\n                                        </div>\n                                    `;\n                                    // Attach retry handler\n                                    const retryBtn = document.getElementById(retryBtnId);\n                                    if (retryBtn) {\n                                        retryBtn.addEventListener('click', function() {\n                                            self.confirmReport(action, report, feedback);\n                                        });\n                                    }\n                                });\n                                // Also show the error in the chat\n                                this.addMessage(errorMsg, 'error');\n                            } else {\n                                // Check if response has proper report structure\n                                const hasReportStructure = chatResponse.type &&\n                                    (chatResponse.type === 'sql' || chatResponse.type === 'report') &&\n                                    chatResponse.report &&\n                                    chatResponse.awaiting_confirmation;\n\n                                // Check if message indicates a report was generated\n                                const looksLikeReportGeneration = chatResponse.message &&\n                                    (chatResponse.message.toLowerCase().includes('report generated') ||\n                                     chatResponse.message.toLowerCase().includes('generated a report') ||\n                                     chatResponse.message.toLowerCase().includes('i\\'ve generated'));\n\n                                if (looksLikeReportGeneration && !hasReportStructure) {\n                                    // \"Ghost report\" - AI says report generated but no structure to display it\n                                    document.querySelectorAll('.adeptus-report-action-container').forEach(container => {\n                                        const retryBtnId = 'retry-ghost-' + Date.now();\n                                        container.innerHTML = `\n                                            <div style=\"text-align: center; padding: 10px;\">\n                                                <div style=\"color: #856404; background: #fff3cd; padding: 12px; border-radius: 6px; margin-bottom: 10px;\">\n                                                    <i class=\"fa fa-exclamation-triangle\"></i>\n                                                    The refined report was generated but could not be displayed properly.\n                                                </div>\n                                                <button id=\"${retryBtnId}\" class=\"btn btn-primary btn-sm\">\n                                                    <i class=\"fa fa-refresh\"></i> Try Again\n                                                </button>\n                                            </div>\n                                        `;\n                                        const retryBtn = document.getElementById(retryBtnId);\n                                        if (retryBtn) {\n                                            retryBtn.addEventListener('click', function() {\n                                                self.confirmReport(action, report, feedback);\n                                            });\n                                        }\n                                    });\n                                    // Add informative message in chat\n                                    this.addMessage('The report refinement encountered an issue. Please try again using the button above, or start a new request.', 'system');\n                                } else if (hasReportStructure) {\n                                    // Normal success with proper report structure\n                                    document.querySelectorAll('.adeptus-report-action-container').forEach(container => {\n                                        container.innerHTML = `\n                                            <div style=\"text-align: center; color: #007bff;\">\n                                                <i class=\"fa fa-info-circle\"></i> Feedback sent. I'll refine the report based on your input.\n                                            </div>\n                                        `;\n                                    });\n                                    this.handleResponse(response.chat_response);\n                                } else {\n                                    // Regular response (not a report) - just show the message\n                                    document.querySelectorAll('.adeptus-report-action-container').forEach(container => {\n                                        container.innerHTML = `\n                                            <div style=\"text-align: center; color: #007bff;\">\n                                                <i class=\"fa fa-info-circle\"></i> Feedback sent.\n                                            </div>\n                                        `;\n                                    });\n                                    this.handleResponse(response.chat_response);\n                                }\n                            }\n                        } else {\n                            // No chat_response - unexpected, show generic feedback sent\n                            document.querySelectorAll('.adeptus-report-action-container').forEach(container => {\n                                container.innerHTML = `\n                                    <div style=\"text-align: center; color: #007bff;\">\n                                        <i class=\"fa fa-info-circle\"></i> Feedback sent.\n                                    </div>\n                                `;\n                            });\n                        }\n                    }\n                },\n                error: (xhr, status) => {\n                    this.hideLoading();\n\n                    // Determine error type and message\n                    let errorMessage = 'Failed to process request. Please try again.';\n                    let showRetry = true;\n\n                    if (status === 'timeout') {\n                        errorMessage = 'Request timed out. The AI service may be busy. Please try again.';\n                    } else if (xhr.status === 0) {\n                        errorMessage = 'Network error. Please check your connection and try again.';\n                    } else if (xhr.status === 401) {\n                        errorMessage = 'Session expired. Please refresh the page and log in again.';\n                        showRetry = false;\n                    } else if (xhr.status === 429) {\n                        errorMessage = 'Too many requests. Please wait a moment and try again.';\n                    } else if (xhr.status >= 500) {\n                        errorMessage = 'Server error. Please try again in a moment.';\n                    } else if (xhr.responseJSON && xhr.responseJSON.errors) {\n                        const errors = xhr.responseJSON.errors;\n                        const errorDetails = Object.keys(errors).map(field => `${field}: ${errors[field].join(', ')}`).join('; ');\n                        errorMessage = `Validation failed: ${errorDetails}`;\n                        showRetry = false;\n                    } else if (xhr.responseJSON && xhr.responseJSON.message) {\n                        errorMessage = xhr.responseJSON.message;\n                    }\n\n                    // Update containers with error and optional retry button\n                    document.querySelectorAll('.adeptus-report-action-container').forEach(container => {\n                        const retryBtnId = 'retry-error-' + Date.now();\n                        let retryHtml = '';\n                        if (showRetry) {\n                            retryHtml = `\n                                <button id=\"${retryBtnId}\" class=\"btn btn-outline-primary btn-sm\" style=\"margin-top: 10px;\">\n                                    <i class=\"fa fa-refresh\"></i> Try Again\n                                </button>\n                            `;\n                        }\n                        container.innerHTML = `\n                            <div style=\"text-align: center; padding: 10px;\">\n                                <div style=\"color: #dc3545;\">\n                                    <i class=\"fa fa-exclamation-triangle\"></i> ${errorMessage}\n                                </div>\n                                ${retryHtml}\n                            </div>\n                        `;\n                        // Attach retry handler if button exists\n                        if (showRetry) {\n                            const retryBtn = document.getElementById(retryBtnId);\n                            if (retryBtn) {\n                                retryBtn.addEventListener('click', function() {\n                                    self.confirmReport(action, report, feedback);\n                                });\n                            }\n                        }\n                    });\n                }\n            });\n        },\n\n        /**\n         * Switch to the reports tab\n         */\n        switchToReportsTab: function() {\n            // Remove the datatable-loading class when switching to Reports tab\n            setTimeout(() => {\n                $('.datatable-wrapper').removeClass('datatable-loading');\n                $('#report-history-table-wrapper .datatable-wrapper').removeClass('datatable-loading');\n            }, 200);\n            $('#reports-tab').tab('show');\n            $('#assistant-tab').removeClass('active').attr('aria-selected', 'false');\n            $('#reports-tab').addClass('active').attr('aria-selected', 'true');\n            $('#assistant-panel').removeClass('show active');\n            $('#reports-panel').addClass('show active');\n\n            // Reset view placeholder\n            $('.adeptus-report-view-title').text('Select a Report');\n            $('.adeptus-report-view-body').html(\n                '<div class=\"text-center py-4\"><p class=\"text-muted\">Select a report from history to view details here.</p></div>'\n            );\n\n            // Check if reports have been loaded\n            if (!this.cachedReports || (Array.isArray(this.cachedReports) && this.cachedReports.length === 0 && !this.reportsLoaded)) {\n                // Reports not loaded yet, trigger loading\n                this.loadReportsHistory();\n            } else {\n                // Reports already loaded, just ensure table is visible\n                $('#report-history-loader').addClass('d-none');\n                $('#report-history-table-wrapper').removeClass('d-none');\n\n                // Update the table with cached reports\n                if (this.cachedReports) {\n                    this.updateReportsHistory(this.cachedReports);\n                }\n            }\n        },\n\n        /**\n         * Load reports history\n         * @param callback\n         */\n        loadReportsHistory: function(callback) {\n            // Initialize cachedReports if not already\n            if (!this.cachedReports) {\n                this.cachedReports = [];\n            }\n\n            $('#report-history-loader').removeClass('d-none');\n            $('#report-history-table-wrapper').addClass('d-none');\n\n            this.ajaxWithAuth({\n                url: this.backendUrl + '/ai-reports',\n                method: 'GET',\n                timeout: 10000, // 10 second timeout\n                success: (response) => {\n\n                    // Cache reports for reuse - handle different response formats\n                    const reports = response.reports || response.data || [];\n                    this.cachedReports = Array.isArray(reports) ? reports : [];\n\n                    // Mark that reports have been loaded\n                    this.reportsLoaded = true;\n\n\n                    this.updateReportsHistory(this.cachedReports);\n                    $('#report-history-loader').addClass('d-none');\n                    $('#report-history-table-wrapper').removeClass('d-none');\n\n                    // Destroy existing DataTable if it exists\n                    if (this.reportsDataTable) {\n                        this.reportsDataTable.destroy();\n                        this.reportsDataTable = null;\n                    }\n\n                    // Only initialize DataTable if we have data and table structure is ready\n                    setTimeout(() => {\n                        try {\n                            const tableElement = document.getElementById('reports-history-table');\n                            if (!tableElement) {\n                                return;\n                            }\n\n                            const tbody = tableElement.querySelector('tbody');\n                            const thead = tableElement.querySelector('thead');\n\n                            // Verify table structure before initializing DataTable\n                            if (thead && tbody && thead.rows.length > 0 && thead.rows[0].cells.length > 0) {\n                                // Check if DataTable is already initialized and destroy it first\n                                if (this.reportsDataTable) {\n                                    this.reportsDataTable.destroy();\n                                    this.reportsDataTable = null;\n                                }\n\n                                // Count header and data columns to ensure they match\n                                const headerCells = thead.rows[0].cells.length;\n                                const dataRows = tbody.rows;\n                                let dataCells = 0;\n\n                                if (dataRows.length > 0) {\n                                    dataCells = dataRows[0].cells.length;\n                                }\n\n\n                                if (headerCells === dataCells && headerCells > 0) {\n                                    // Only initialize DataTable if we have actual data rows (not just empty state)\n                                    if (dataRows.length > 0 && !dataRows[0].cells[0].textContent.includes('No reports')) {\n                    this.reportsDataTable = new simpleDatatables.DataTable(\"#reports-history-table\", {\n                        searchable: true,\n                        fixedHeight: false,\n                        perPage: 10,\n                        loading: false // Disable loading indicator\n                    });\n\n                                        // Remove the loading class from the wrapper\n                                        setTimeout(() => {\n                                            // Remove the datatable-loading class from the wrapper\n                                            $('.datatable-wrapper').removeClass('datatable-loading');\n                                            $('#report-history-table-wrapper .datatable-wrapper').removeClass('datatable-loading');\n                                            // Also remove any actual loading elements if they exist\n                                            $('.dataTable-loading').remove();\n                                        }, 100);\n                                    } else {\n                                    }\n                                }\n                            }\n                        } catch (error) {\n                            // Fallback: table will still be functional without DataTable features.\n                        }\n\n                    if (typeof callback === 'function') {\n                        callback();\n                    }\n                    }, 100); // Small delay to ensure DOM is ready\n                },\n                error: (xhr, status) => {\n                    // Always hide loader and show table\n                    $('#report-history-loader').addClass('d-none');\n                    $('#report-history-table-wrapper').removeClass('d-none');\n\n                    // Show appropriate error message\n                    const tbody = $('#reports-history-table tbody');\n                    tbody.empty();\n\n                    if (status === 'timeout') {\n                        tbody.append(\n                            `<tr><td colspan=\"3\" class=\"text-center text-warning\">Loading reports timed out. Please refresh the page.</td></tr>`\n                        );\n                    } else if (xhr.status === 401 || xhr.status === 403) {\n                        tbody.append(\n                            `<tr><td colspan=\"3\" class=\"text-center text-danger\">Authentication error. Please log in again.</td></tr>`\n                        );\n                    } else {\n                        // Use cached reports if available\n                        if (this.cachedReports && this.cachedReports.length > 0) {\n                            this.updateReportsHistory(this.cachedReports);\n                        } else {\n                            tbody.append(\n                                `<tr><td colspan=\"3\" class=\"text-center text-muted\">Unable to load reports. Please try again later.</td></tr>`\n                            );\n                        }\n                    }\n\n                    if (typeof callback === 'function') {\n                        callback();\n                    }\n                }\n            });\n        },\n\n        /**\n         * Update the reports history table\n         * @param reports\n         */\n        updateReportsHistory: function(reports) {\n            const tbody = $('#reports-history-table tbody');\n            const self = this; // Capture context\n            tbody.empty();\n            if (!reports || reports.length === 0) {\n                // Check if we also have no chat history\n                const authStatus = AuthUtils.getAuthStatus();\n                const hasChats = authStatus && authStatus.subscription &&\n                    authStatus.subscription.reports_generated_this_month > 0;\n\n                if (!hasChats) {\n                    tbody.append(`\n                        <tr>\n                            <td colspan=\"3\" class=\"text-center text-muted\">\n                                <div class=\"py-4\">\n                                    <i class=\"fa fa-chart-bar fa-2x mb-2\"></i>\n                                    <p class=\"mb-1\">${getString('no_reports_generated', 'No reports generated yet')}</p>\n                                    <small>${getString('ask_ai_create_reports', 'Ask the AI assistant to create reports for you')}</small>\n                                </div>\n                            </td>\n                        </tr>\n                    `);\n                } else {\n                tbody.append(\n                    `<tr><td colspan=\"3\" class=\"text-center text-muted\">${getString('no_reports', 'No reports yet')}</td></tr>`\n                );\n                }\n                return;\n            }\n            reports.forEach(report => {\n                const statusBadge = self.getStatusBadge(report.status);\n                const date = new Date(report.created_at).toLocaleDateString();\n                const row = $(`\n                    <tr class=\"adeptus-report-row\" data-report-slug=\"${report.slug}\">\n                        <td>${report.description}</td>\n                        <td>${date}</td>\n                        <td>${statusBadge}</td>\n                    </tr>`\n                );\n                // Don't attach click handler here - we'll use event delegation instead\n                tbody.append(row);\n            });\n\n            // Use event delegation for report row clicks to handle filtered/searched results\n            // Remove any existing delegated handlers first to avoid duplicates\n            $('#report-history-table-wrapper').off('click', '.adeptus-report-row');\n\n            // Attach delegated click handler that will work even after DataTable filtering\n            $('#report-history-table-wrapper').on('click', '.adeptus-report-row', function() {\n                const $row = $(this);\n                const reportSlug = $row.data('report-slug');\n\n                // Find the report from cached reports\n                const report = self.cachedReports.find(r => r.slug === reportSlug);\n                if (!report) {\n                    return;\n                }\n\n                // Hide the report history loader when clicking on a report\n                $('#report-history-loader').addClass('d-none');\n                $('#report-history-table-wrapper').removeClass('d-none');\n\n                // Always show loading spinner in carousel container\n                const reportsView = $('#reports-panel .col-md-8 .card-body');\n                reportsView.find('.adeptus-report-display-wrapper').html('<div class=\"w-100 d-flex justify-content-center align-items-center\" style=\"min-height:200px\"><div class=\"spinner-border text-primary\" role=\"status\"></div></div>');\n\n                // Check if cachedReports exists and has the report WITH DATA\n                if (Array.isArray(self.cachedReports) && self.cachedReports.length > 0) {\n                    const rep = self.cachedReports.find(r => r.slug === report.slug);\n                    if (rep) {\n\n                        // Check if cached report has data, if not fetch it\n                        if (rep.data && Array.isArray(rep.data) && rep.data.length > 0) {\n                            setTimeout(() => {\n self.updateReportsView(rep, rep.data);\n}, 300); // Simulate async for spinner UX\n                        } else {\n                            self.fetchAndDisplayReport(report.slug, $row);\n                        }\n                    } else {\n                        self.fetchAndDisplayReport(report.slug, $row);\n                    }\n                } else {\n                    self.fetchAndDisplayReport(report.slug, $row);\n                }\n                // Highlight the current report in the history\n                $('.adeptus-report-row').removeClass('table-primary');\n                $row.addClass('table-primary');\n            });\n        },\n\n        /**\n         * Fetch report from API and display.\n         * Supports local execution for SaaS model - executes SQL on customer's Moodle server.\n         * @param reportSlug\n         * @param rowElem\n         */\n        fetchAndDisplayReport: function(reportSlug, rowElem) {\n            const self = this;\n            const reportsView = $('#reports-panel .col-md-8 .card-body');\n\n            // Ensure report history loader is hidden since we're displaying a report\n            $('#report-history-loader').addClass('d-none');\n            $('#report-history-table-wrapper').removeClass('d-none');\n\n            // Ensure loading spinner is visible\n            reportsView.html('<div class=\"adeptus-report-display-wrapper w-100\"><div class=\"w-100 d-flex justify-content-center align-items-center\" style=\"min-height:200px\"><div class=\"spinner-border text-primary\" role=\"status\"></div></div></div>');\n\n            this.ajaxWithAuth({\n                url: `${this.backendUrl}/ai-reports/${reportSlug}`,\n                method: 'GET',\n                success: (response) => {\n                    const report = response.report;\n\n                    // Check if backend provided data (legacy mode)\n                    if (response.data && Array.isArray(response.data) && response.data.length > 0) {\n                        // Backend executed - use that data (legacy support)\n                        self.displayFetchedReport(report, response.data, rowElem);\n                        return;\n                    }\n\n                    // Get SQL from response - check multiple possible locations\n                    // New API: response.sql (top level) or response.report.sql_query\n                    // Legacy: report.sql\n                    const sqlQuery = response.sql || (report && report.sql_query) || (report && report.sql);\n\n                    // Check if we have SQL to execute locally (SaaS model)\n                    if (sqlQuery) {\n                        self.executeReportLocally(sqlQuery, report?.params || {})\n                            .then((executionResult) => {\n                                if (executionResult.error) {\n                                    reportsView.find('.adeptus-report-display-wrapper').html(\n                                        `<div class=\"w-100 text-center text-danger py-4\">\n                                            <i class=\"fa fa-exclamation-triangle\"></i>\n                                            Failed to execute report: ${executionResult.error}\n                                        </div>`\n                                    );\n                                    return;\n                                }\n\n                                if (!executionResult.data || executionResult.data.length === 0) {\n                                    reportsView.find('.adeptus-report-display-wrapper').html(\n                                        '<div class=\"w-100 text-center text-warning py-4\">' +\n                                        '<i class=\"fa fa-info-circle\"></i> ' +\n                                        'Report executed successfully but returned no data.' +\n                                        '</div>'\n                                    );\n                                    return;\n                                }\n\n                                self.displayFetchedReport(report, executionResult.data, rowElem);\n                            })\n                            .catch((error) => {\n                                reportsView.find('.adeptus-report-display-wrapper').html(\n                                    `<div class=\"w-100 text-center text-danger py-4\">\n                                        <i class=\"fa fa-exclamation-triangle\"></i>\n                                        Failed to execute report: ${error.message}\n                                    </div>`\n                                );\n                            });\n                        return;\n                    }\n\n                    // No data and no SQL - show warning\n                    reportsView.find('.adeptus-report-display-wrapper').html(\n                        '<div class=\"w-100 text-center text-warning py-4\">' +\n                        '<i class=\"fa fa-exclamation-triangle\"></i> ' +\n                        'Report has no data or SQL to execute.' +\n                        '</div>'\n                    );\n                },\n                error: () => {\n                    reportsView.find('.adeptus-report-display-wrapper').html('<div class=\"w-100 text-center text-danger py-4\">Failed to load report. Please try again.</div>');\n                }\n            });\n        },\n\n        /**\n         * Display fetched report data (helper for fetchAndDisplayReport)\n         * @param report\n         * @param data\n         * @param rowElem\n         */\n        displayFetchedReport: function(report, data, rowElem) {\n            // Add or update in cache\n            if (!Array.isArray(this.cachedReports)) {\n this.cachedReports = [];\n}\n            let idx = this.cachedReports.findIndex(r => r.slug === report.slug);\n            if (idx > -1) {\n                this.cachedReports[idx] = Object.assign({}, report, {data: data});\n            } else {\n                this.cachedReports.push(Object.assign({}, report, {data: data}));\n            }\n\n            // Store for export functionality\n            this.currentViewedReport = report;\n            this.currentViewedReportData = data;\n\n            // Update the view\n            this.updateReportsView(report, data);\n\n            // Highlight the current report in the history\n            $('.adeptus-report-row').removeClass('table-primary');\n            if (rowElem) {\n rowElem.addClass('table-primary');\n}\n        },\n\n        /**\n         * Display the current report in the reports view\n         * @param report\n         */\n        displayCurrentReport: function(report) {\n            // Update the reports view with the current report\n            this.updateReportsView(report);\n\n            // Highlight the current report in the history\n            $(`.adeptus-report-row[data-report-slug=\"${report.slug}\"]`).addClass('table-primary');\n        },\n\n        /**\n         * Display a specific report\n         * @param reportSlug\n         */\n        displayReport: function(reportSlug) {\n            const rep = this.cachedReports.find(r => r.slug === reportSlug);\n            if (rep) {\n                this.updateReportsView(rep, rep.data);\n                // Highlight the current report in the history\n                $('.adeptus-report-row').removeClass('table-primary');\n                $(`.adeptus-report-row[data-report-slug=\"${reportSlug}\"]`).addClass('table-primary');\n            }\n        },\n\n        /**\n         * Update the reports view with report data\n         * @param report\n         * @param data\n         */\n        updateReportsView: function(report, data = null) {\n            const self = this;\n\n            // Store current report and data for export functionality\n            self.currentViewedReport = report;\n            self.currentViewedReportData = data;\n\n            // Always destroy any existing chart/graph instances to prevent data mixup\n            if (self.reportChartInstance) {\n                self.reportChartInstance.destroy();\n                self.reportChartInstance = null;\n            }\n            if (self.reportGraphInstance) {\n                self.reportGraphInstance.destroy();\n                self.reportGraphInstance = null;\n            }\n            // Destroy any existing VTE instance\n            if (self._vteController && typeof self._vteController.destroy === 'function') {\n                try {\n                    self._vteController.destroy();\n                } catch (e) {\n                    // VTE destroy failed silently.\n                }\n                self._vteController = null;\n            }\n            const reportsView = $('#reports-panel .col-md-8 .card-body');\n            // Inject custom styles for view toggle and chart controls\n            if ($('#display-type-icon-style').length === 0) {\n                $('head').append(`\n                    <style id=\"display-type-icon-style\">\n                        /* View toggle buttons */\n                        .adeptus-view-toggle .adeptus-view-toggle-btn {\n                            background: #f8f9fa;\n                            border: 1px solid #dee2e6;\n                            color: #495057;\n                            padding: 0.35rem 0.75rem;\n                            font-size: 13px;\n                            transition: all 0.2s ease;\n                        }\n                        .adeptus-view-toggle .adeptus-view-toggle-btn:first-child {\n                            border-radius: 6px 0 0 6px;\n                        }\n                        .adeptus-view-toggle .adeptus-view-toggle-btn:last-child {\n                            border-radius: 0 6px 6px 0;\n                        }\n                        .adeptus-view-toggle .adeptus-view-toggle-btn:hover {\n                            background: #e9ecef;\n                        }\n                        .adeptus-view-toggle .adeptus-view-toggle-btn.active {\n                            background: #2563eb;\n                            border-color: #2563eb;\n                            color: white;\n                        }\n                        .adeptus-view-toggle .adeptus-view-toggle-btn i {\n                            margin-right: 5px;\n                        }\n\n                        /* Chart controls wrapper */\n                        .adeptus-chart-controls-wrapper {\n                            background: #f8f9fa;\n                            border-radius: 8px;\n                            padding: 1rem;\n                            border: 1px solid #e9ecef;\n                        }\n                        .adeptus-chart-controls {\n                            display: flex;\n                            align-items: flex-end;\n                            flex-wrap: wrap;\n                        }\n                        .adeptus-chart-controls .adeptus-control-group {\n                            display: flex;\n                            flex-direction: column;\n                            gap: 0.25rem;\n                        }\n                        .adeptus-chart-controls .form-label {\n                            font-size: 11px;\n                            font-weight: 600;\n                            color: #6c757d;\n                            margin-bottom: 0;\n                            text-transform: uppercase;\n                            letter-spacing: 0.5px;\n                        }\n                        .adeptus-chart-controls .form-select {\n                            font-size: 13px;\n                            padding: 0.4rem 2rem 0.4rem 0.75rem;\n                            border-radius: 6px;\n                            border: 1px solid #dee2e6;\n                            background-color: white;\n                            min-width: 140px;\n                        }\n                        .adeptus-chart-controls .form-select:focus {\n                            border-color: #2563eb;\n                            box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.15);\n                        }\n\n                        /* Legacy icon button styles */\n                        .btn-icon {\n                            transition: transform 0.15s cubic-bezier(.4,2,.6,1), background 0.2s, border 0.2s;\n                            background: #f8f9fa;\n                            border: 1.5px solid #e0e0e0;\n                            color: #333;\n                        }\n                        .btn-icon:hover {\n                            transform: scale(1.15);\n                            background: #e9ecef;\n                            border-color: #b3d7ff;\n                            color: #007bff;\n                            z-index: 2;\n                        }\n                        .btn-icon.active, .btn-icon:focus {\n                            background: #e3f0ff;\n                            border-color: #007bff;\n                            color: #007bff;\n                            box-shadow: 0 0 0 2px #b3d7ff33;\n                        }\n                    </style>\n                `);\n            }\n            // Set the report description as the title\n            $('.adeptus-report-view-title').text(report.description);\n            if (!Array.isArray(data) || data.length === 0) {\n                reportsView.find('.adeptus-report-display-wrapper').html('<div class=\"w-100 text-center text-muted py-4\">No data available for this report.</div>');\n                return;\n            }\n\n            // Get headers and detect numeric columns for chart axes\n            const headers = Object.keys(data[0] || {});\n            const numericCols = this.detectNumericColumns(data, headers);\n\n            // Build chart controls HTML\n            let chartControlsHtml = '<div class=\"adeptus-chart-controls-wrapper mb-3\">';\n            chartControlsHtml += '<div class=\"adeptus-chart-controls d-flex flex-wrap align-items-end gap-3\">';\n\n            // Chart type selector\n            chartControlsHtml += '<div class=\"adeptus-control-group\">';\n            chartControlsHtml += '<label for=\"report-chart-type\" class=\"form-label\">Chart Type</label>';\n            chartControlsHtml += '<select id=\"report-chart-type\" class=\"form-select form-select-sm\">';\n            chartControlsHtml += '<option value=\"bar\">Bar Chart</option>';\n            chartControlsHtml += '<option value=\"line\">Line Chart</option>';\n            chartControlsHtml += '<option value=\"pie\">Pie Chart</option>';\n            chartControlsHtml += '<option value=\"doughnut\">Doughnut Chart</option>';\n            chartControlsHtml += '</select></div>';\n\n            // X-Axis selector\n            chartControlsHtml += '<div class=\"adeptus-control-group\">';\n            chartControlsHtml += '<label for=\"report-chart-x-axis\" class=\"form-label\">X-Axis (Labels)</label>';\n            chartControlsHtml += '<select id=\"report-chart-x-axis\" class=\"form-select form-select-sm\">';\n            headers.forEach((header, idx) => {\n                const formattedHeader = header.replace(/_/g, ' ').replace(/\\b\\w/g, l => l.toUpperCase());\n                const selected = idx === 0 ? ' selected' : '';\n                chartControlsHtml += `<option value=\"${header}\"${selected}>${formattedHeader}</option>`;\n            });\n            chartControlsHtml += '</select></div>';\n\n            // Y-Axis selector (only numeric columns)\n            chartControlsHtml += '<div class=\"adeptus-control-group\">';\n            chartControlsHtml += '<label for=\"report-chart-y-axis\" class=\"form-label\">Y-Axis (Values)</label>';\n            chartControlsHtml += '<select id=\"report-chart-y-axis\" class=\"form-select form-select-sm\">';\n            if (numericCols.length > 0) {\n                numericCols.forEach((col, idx) => {\n                    const formattedHeader = col.replace(/_/g, ' ').replace(/\\b\\w/g, l => l.toUpperCase());\n                    const selected = idx === numericCols.length - 1 ? ' selected' : '';\n                    chartControlsHtml += `<option value=\"${col}\"${selected}>${formattedHeader}</option>`;\n                });\n            } else {\n                // Fallback to all columns if no numeric found\n                headers.forEach((header, idx) => {\n                    const formattedHeader = header.replace(/_/g, ' ').replace(/\\b\\w/g, l => l.toUpperCase());\n                    const selected = idx === headers.length - 1 ? ' selected' : '';\n                    chartControlsHtml += `<option value=\"${header}\"${selected}>${formattedHeader}</option>`;\n                });\n            }\n            chartControlsHtml += '</select></div>';\n            chartControlsHtml += '</div></div>'; // End chart-controls and wrapper\n\n            // Controls row: export buttons (left), view toggle (right)\n            // PDF available for all, CSV/JSON premium on free plan\n            const premiumClass = self.isFreePlan ? ' adeptus-export-premium' : '';\n            const premiumIcon = self.isFreePlan ? ' <i class=\"fa fa-crown text-warning\" style=\"font-size: 10px;\"></i>' : '';\n            let controlsHtml = `\n                <div class=\"d-flex justify-content-between align-items-center mb-3 flex-wrap\">\n                    <div class=\"adeptus-action-buttons d-flex gap-2\">\n                        <button class=\"btn btn-outline-danger btn-sm adeptus-export-pdf-btn\">\n                            <i class=\"fa fa-file-pdf-o me-1\"></i>Export PDF\n                        </button>\n                        <button class=\"btn btn-outline-secondary btn-sm adeptus-export-csv-btn${premiumClass} mr-10\">\n                            <i class=\"fa fa-download me-1\"></i>Export CSV${premiumIcon}\n                        </button>\n                        <button class=\"btn btn-outline-secondary btn-sm adeptus-export-json-btn${premiumClass}\">\n                            <i class=\"fa fa-code me-1\"></i>Export JSON${premiumIcon}\n                        </button>\n                    </div>\n                    <div class=\"adeptus-view-toggle btn-group\" role=\"group\">\n                        <button type=\"button\" class=\"btn btn-sm adeptus-view-toggle-btn${report.display_type !== 'chart' ? ' active' : ''}\" data-type=\"table\"><i class=\"fa fa-table\"></i> Table</button>\n                        <button type=\"button\" class=\"btn btn-sm adeptus-view-toggle-btn${report.display_type === 'chart' ? ' active' : ''}\" data-type=\"chart\"><i class=\"fa fa-bar-chart\"></i> Chart</button>\n                    </div>\n                </div>\n            `;\n\n            // Display containers\n            const isChartActive = report.display_type === 'chart';\n            let displayHtml = '<div class=\"adeptus-report-display-area w-100\">';\n\n            // Table view\n            displayHtml += `<div class=\"adeptus-report-view-panel${!isChartActive ? '' : ' d-none'}\" data-type=\"table\">`;\n            displayHtml += this.renderReportData(data);\n            displayHtml += '</div>';\n\n            // Chart view with controls\n            displayHtml += `<div class=\"adeptus-report-view-panel${isChartActive ? '' : ' d-none'}\" data-type=\"chart\">`;\n            displayHtml += chartControlsHtml;\n            displayHtml += '<div class=\"adeptus-chart-container\" style=\"position: relative; height: 400px; border: 1px solid #e9ecef; border-radius: 8px; padding: 1rem; background: #fff;\">';\n            displayHtml += '<canvas id=\"reportChart\"></canvas>';\n            displayHtml += '</div></div>';\n\n            displayHtml += '</div>';\n            reportsView.html(`\n                ${controlsHtml}\n                <div class=\"adeptus-report-display-wrapper w-100 position-relative\">\n                    ${displayHtml}\n                </div>\n            `);\n\n            // Store current report data for chart rendering\n            self._currentReportData = data;\n            self._currentReportName = report.description || report.name || 'Report';\n\n            // Set initial view state based on report display type\n            self._currentReportView = (report.display_type === 'chart') ? 'chart' : 'table';\n\n            // Initialize Vanilla Table Enhancer if table is active\n            if (this._pendingTableId && report.display_type !== 'chart') {\n                setTimeout(() => {\n                    const tableElement = document.getElementById(this._pendingTableId);\n                    if (tableElement && window.VTE) {\n                        try {\n                            this._vteController = window.VTE.enhance('#' + this._pendingTableId, {\n                                perPage: 10,\n                                perPageOptions: [10, 25, 50, 100],\n                                labels: {\n                                    search: 'Search',\n                                    rows: 'Rows per page',\n                                    info: (start, end, total) => `Showing ${start}â€“${end} of ${total} entries`,\n                                    noData: 'No matching records found'\n                                }\n                            })[0];\n                        } catch (e) {\n                            // VTE initialization failed silently.\n                        }\n                    }\n                    this._pendingTableId = null;\n                }, 100);\n            }\n\n            // Initialize chart if chart view is active\n            if (report.display_type === 'chart') {\n                setTimeout(() => {\n                    self.renderReportChartFromSelectors(data, self._currentReportName);\n                }, 100);\n            }\n\n            // View toggle button click handler\n            reportsView.find('.adeptus-view-toggle-btn').on('click', function() {\n                const type = $(this).data('type');\n                reportsView.find('.adeptus-view-toggle-btn').removeClass('active');\n                $(this).addClass('active');\n\n                // Track current view for export\n                self._currentReportView = type;\n\n                // Toggle view panels\n                reportsView.find('.adeptus-report-view-panel').addClass('d-none');\n                reportsView.find(`.adeptus-report-view-panel[data-type=\"${type}\"]`).removeClass('d-none');\n\n                // Initialize table enhancer if switching to table\n                if (type === 'table' && !self._vteController && self._pendingTableId) {\n                    setTimeout(() => {\n                        const tableElement = document.getElementById(self._pendingTableId);\n                        if (tableElement && window.VTE) {\n                            try {\n                                self._vteController = window.VTE.enhance('#' + self._pendingTableId, {\n                                    perPage: 10,\n                                    perPageOptions: [10, 25, 50, 100],\n                                    labels: {\n                                        search: 'Search',\n                                        rows: 'Rows per page',\n                                        info: (start, end, total) => `Showing ${start}â€“${end} of ${total} entries`,\n                                        noData: 'No matching records found'\n                                    }\n                                })[0];\n                            } catch (e) {\n                                // VTE initialization failed silently.\n                            }\n                        }\n                    }, 100);\n                }\n\n                // Render chart if switching to chart view\n                if (type === 'chart') {\n                    setTimeout(() => {\n                        self.renderReportChartFromSelectors(self._currentReportData, self._currentReportName);\n                    }, 100);\n                }\n\n                // Save display type if changed\n                if (type !== report.display_type) {\n                    if (reportsView.find('.adeptus-save-display-type-btn').length === 0) {\n                        reportsView.find('.adeptus-view-toggle').after('<button class=\"btn btn-sm btn-outline-primary adeptus-save-display-type-btn ms-2\"><i class=\"fa fa-save\"></i> Save View</button>');\n                        reportsView.find('.adeptus-save-display-type-btn').on('click', function() {\n self.saveDisplayType(report.slug, type);\n});\n                    }\n                } else {\n                    reportsView.find('.adeptus-save-display-type-btn').remove();\n                }\n            });\n\n            // Chart controls change handlers\n            reportsView.find('#report-chart-type, #report-chart-x-axis, #report-chart-y-axis').on('change', function() {\n                self.renderReportChartFromSelectors(self._currentReportData, self._currentReportName);\n            });\n\n            // Export buttons - with plan-based restrictions\n            reportsView.find('.adeptus-export-pdf-btn').on('click', () => self.exportReport(report.slug, 'pdf'));\n            reportsView.find('.adeptus-export-csv-btn').on('click', function() {\n                if ($(this).hasClass('adeptus-export-premium')) {\n                    self.showExportUpgradePrompt('csv');\n                    return;\n                }\n                self.exportReport(report.slug, 'csv');\n            });\n            reportsView.find('.adeptus-export-json-btn').on('click', function() {\n                if ($(this).hasClass('adeptus-export-premium')) {\n                    self.showExportUpgradePrompt('json');\n                    return;\n                }\n                self.exportReport(report.slug, 'json');\n            });\n        },\n\n        /**\n         * Linkify URLs in text - converts URLs to clickable links\n         * @param {string} text - The text that may contain URLs\n         * @returns {string} Text with URLs converted to anchor tags\n         */\n        linkifyUrls: function(text) {\n            if (!text || typeof text !== 'string') {\n                return text || '';\n            }\n\n            // URL regex pattern - matches http(s) URLs\n            const urlPattern = /(\\bhttps?:\\/\\/[^\\s<>\"']+)/gi;\n\n            // Escape HTML first to prevent XSS, then linkify\n            const escaped = String(text)\n                .replace(/&/g, '&amp;')\n                .replace(/</g, '&lt;')\n                .replace(/>/g, '&gt;')\n                .replace(/\"/g, '&quot;');\n\n            // Replace URLs with anchor tags\n            return escaped.replace(urlPattern, function(url) {\n                // Truncate display text if URL is too long\n                const displayUrl = url.length > 50 ? url.substring(0, 47) + '...' : url;\n                return `<a href=\"${url}\" target=\"_blank\" rel=\"noopener noreferrer\" class=\"adeptus-report-url-link\" title=\"${url}\">${displayUrl}</a>`;\n            });\n        },\n\n        /**\n         * Format cell value for display - handles URLs, nulls, and special formatting\n         * @param {*} value - The cell value\n         * @param {string} header - The column header (used for context-aware formatting)\n         * @returns {string} Formatted HTML for the cell\n         */\n        formatCellValue: function(value, header) {\n            if (value === null || value === undefined || value === '') {\n                return '';\n            }\n\n            const strValue = String(value);\n\n            // Check if this looks like a URL column or contains a URL\n            const headerLower = (header || '').toLowerCase();\n            const isUrlColumn = headerLower.includes('url') ||\n                                headerLower.includes('link') ||\n                                headerLower.includes('profile') ||\n                                headerLower.includes('href');\n\n            // If it's a URL column or contains http, linkify it\n            if (isUrlColumn || strValue.match(/^https?:\\/\\//i)) {\n                return this.linkifyUrls(strValue);\n            }\n\n            // For other values, just escape HTML\n            return String(strValue)\n                .replace(/&/g, '&amp;')\n                .replace(/</g, '&lt;')\n                .replace(/>/g, '&gt;')\n                .replace(/\"/g, '&quot;');\n        },\n\n        /**\n         * Render report data as a table\n         * @param data\n         */\n        renderReportData: function(data) {\n            if (!data || data.length === 0) {\n                return '<p class=\"text-muted\">No data available.</p>';\n            }\n\n            const self = this;\n            const headers = Object.keys(data[0]);\n            const tableId = 'enhanced-report-table-' + Date.now();\n            let tableHtml = `<div class=\"table-responsive\"><table id=\"${tableId}\" class=\"table table-striped table-hover\">`;\n\n            // Add headers with data type hints for proper sorting\n            tableHtml += '<thead><tr>';\n            headers.forEach(header => {\n                // Detect if column contains numeric data\n                const isNumeric = data.every(row => {\n                    const val = row[header];\n                    return val === null || val === undefined || val === '' || !isNaN(parseFloat(val));\n                });\n\n                // Detect if column contains date data\n                const isDate = !isNumeric && data.some(row => {\n                    const val = row[header];\n                    return val && !isNaN(Date.parse(val));\n                });\n\n                const dataType = isNumeric ? ' data-vte=\"number\"' : (isDate ? ' data-vte=\"date\"' : '');\n                tableHtml += `<th${dataType}>${header.replace(/_/g, ' ').replace(/\\b\\w/g, l => l.toUpperCase())}</th>`;\n            });\n            tableHtml += '</tr></thead>';\n\n            // Add data rows with formatted cell values (including URL linkification)\n            tableHtml += '<tbody>';\n            data.forEach(row => {\n                tableHtml += '<tr>';\n                headers.forEach(header => {\n                    const formattedValue = self.formatCellValue(row[header], header);\n                    tableHtml += `<td>${formattedValue}</td>`;\n                });\n                tableHtml += '</tr>';\n            });\n            tableHtml += '</tbody></table></div>';\n\n            // Store table ID for enhancement after DOM insertion\n            this._pendingTableId = tableId;\n\n            return tableHtml;\n        },\n\n        /**\n         * Get status badge HTML\n         * @param status\n         */\n        getStatusBadge: function(status) {\n            const badgeClass = this.getStatusBadgeClass(status);\n            return `<span class=\"badge ${badgeClass}\" style=\"color: white;\">${status}</span>`;\n        },\n\n        /**\n         * Get status badge CSS class\n         * @param status\n         */\n        getStatusBadgeClass: function(status) {\n            switch (status) {\n                case 'completed': return 'bg-success';\n                case 'ready': return 'bg-success'; // Ready reports are successfully ready to view\n                case 'processing': return 'bg-warning text-dark';\n                case 'pending': return 'bg-info';\n                case 'failed': return 'bg-danger';\n                case 'error': return 'bg-danger';\n                default: return 'bg-secondary';\n            }\n        },\n\n        /**\n         * Execute a pending report.\n         * Fetches report SQL from backend and executes locally (SaaS model).\n         * @param reportSlug\n         */\n        executeReport: function(reportSlug) {\n            const self = this;\n\n            // Show loading indicator\n            const reportRow = $(`.adeptus-report-row[data-report-slug=\"${reportSlug}\"]`);\n            const originalContent = reportRow.html();\n            reportRow.html('<td colspan=\"3\" class=\"text-center\"><div class=\"spinner-border spinner-border-sm text-primary\" role=\"status\"><span class=\"visually-hidden\">Executing...</span></div> Executing report...</td>');\n\n            // First, fetch the report details (including SQL) from backend\n            this.ajaxWithAuth({\n                url: `${this.backendUrl}/ai-reports/${reportSlug}`,\n                method: 'GET',\n                success: (response) => {\n                    const report = response.report;\n\n                    // Get SQL from response - check multiple possible locations\n                    // New API: response.sql (top level) or response.report.sql_query\n                    // Legacy: report.sql\n                    const sqlQuery = response.sql || (report && report.sql_query) || (report && report.sql);\n\n                    // Check if we have SQL to execute\n                    if (!sqlQuery) {\n                        reportRow.html(originalContent);\n                        this.showError('Report SQL not found. Please regenerate the report.');\n                        return;\n                    }\n\n                    // Check if backend already provided data (legacy mode)\n                    if (response.data && Array.isArray(response.data) && response.data.length > 0) {\n                        // Backend executed - use that data (legacy support)\n                        self.handleExecutionSuccess(reportSlug, report, response.data, reportRow);\n                        return;\n                    }\n\n                    // Execute SQL locally (SaaS model)\n                    self.executeReportLocally(sqlQuery, report?.params || {})\n                        .then((executionResult) => {\n                            if (executionResult.error) {\n                                reportRow.html(originalContent);\n                                self.showError('Failed to execute report: ' + executionResult.error);\n                                return;\n                            }\n\n                            self.handleExecutionSuccess(reportSlug, report, executionResult.data, reportRow);\n                        })\n                        .catch((error) => {\n                            reportRow.html(originalContent);\n                            self.showError('Failed to execute report: ' + error.message);\n                        });\n                },\n                error: (xhr, status, error) => {\n                    reportRow.html(originalContent);\n\n                    let errorMessage = 'Failed to fetch report';\n\n                    if (xhr.status === 404) {\n                        errorMessage = 'Report not found.';\n                    } else if (xhr.status === 403) {\n                        errorMessage = 'You do not have permission to view this report.';\n                    } else if (xhr.responseJSON && xhr.responseJSON.error) {\n                        errorMessage = xhr.responseJSON.error;\n                    } else {\n                        errorMessage += ': ' + error;\n                    }\n\n                    this.showError(errorMessage);\n                }\n            });\n        },\n\n        /**\n         * Handle successful report execution (shared between local and legacy modes)\n         * @param reportSlug\n         * @param report\n         * @param data\n         * @param reportRow\n         */\n        handleExecutionSuccess: function(reportSlug, report, data, reportRow) {\n            // Update the cached report with new data\n            if (Array.isArray(this.cachedReports)) {\n                const reportIndex = this.cachedReports.findIndex(r => r.slug === reportSlug);\n                if (reportIndex !== -1) {\n                    this.cachedReports[reportIndex] = Object.assign({}, this.cachedReports[reportIndex], report, {data: data});\n                } else {\n                    this.cachedReports.push(Object.assign({}, report, {data: data}));\n                }\n            }\n\n            // Store current report data for export functionality\n            this.currentViewedReport = report;\n            this.currentViewedReportData = data;\n\n            // Update the reports view with fresh data\n            this.updateReportsView(report, data);\n\n            // Highlight the current report\n            $('.adeptus-report-row').removeClass('table-primary');\n            if (reportRow) {\n reportRow.addClass('table-primary');\n}\n\n            this.showSuccess('Report executed successfully!');\n        },\n\n        /**\n         * Execute report SQL locally on the Moodle server.\n         * This supports the SaaS model where customer data stays on their server.\n         *\n         * @param {string} sql - The SQL query to execute\n         * @param {Object} params - Optional parameters for the query\n         * @returns {Promise<Object>} Promise resolving to {data: array, headers: array, error: string|null}\n         */\n        executeReportLocally: function(sql, params = {}) {\n            var self = this;\n\n            return new Promise((resolve, reject) => {\n                // Show loading indicator\n                self.showLoading();\n\n                var promises = Ajax.call([{\n                    methodname: 'report_adeptus_insights_execute_ai_report',\n                    args: {\n                        sql: sql,\n                        params: JSON.stringify(params)\n                    }\n                }]);\n\n                promises[0].done(function(result) {\n                    self.hideLoading();\n                    // Result is the webservice response directly - don't check result.data\n                    // as that's a field in the response (JSON string), not a wrapper.\n                    var response = result;\n\n                    if (response.success) {\n                        // Parse JSON strings if needed\n                        var data = response.data;\n                        var headers = response.headers;\n                        if (typeof data === 'string') {\n                            try {\n data = JSON.parse(data);\n} catch (e) {\n data = [];\n}\n                        }\n                        if (typeof headers === 'string') {\n                            try {\n headers = JSON.parse(headers);\n} catch (e) {\n headers = [];\n}\n                        }\n                        resolve({\n                            data: data || [],\n                            headers: headers || [],\n                            row_count: response.row_count || 0,\n                            error: null\n                        });\n                    } else {\n                        // SQL error or validation error\n                        resolve({\n                            data: null,\n                            headers: [],\n                            row_count: 0,\n                            error: response.message || 'Query execution failed'\n                        });\n                    }\n                }).fail(function(error) {\n                    self.hideLoading();\n                    var errorMessage = error.message || 'Failed to execute report locally';\n                    reject(new Error(errorMessage));\n                });\n            });\n        },\n\n        /**\n         * Show upgrade prompt for premium export formats\n         * @param format\n         */\n        showExportUpgradePrompt: function(format) {\n            const subscriptionUrl = `${M.cfg.wwwroot}/report/adeptus_insights/subscription.php`;\n            const formatNames = {\n                'csv': 'CSV',\n                'excel': 'Excel',\n                'json': 'JSON'\n            };\n            const formatName = formatNames[format] || format.toUpperCase();\n\n            Swal.fire({\n                title: getString('export_premium_feature', 'Premium Export Format'),\n                html: `<div style=\"text-align: center; padding: 20px;\">\n                    <div style=\"font-size: 48px; color: #f39c12; margin-bottom: 15px;\">\n                        <i class=\"fa fa-crown\"></i>\n                    </div>\n                    <h3 style=\"color: #2c3e50; margin-bottom: 15px;\">${getString('export_is_premium', formatName + ' Export is a Premium Feature').replace('{$a}', formatName)}</h3>\n                    <p style=\"color: #7f8c8d; font-size: 16px; line-height: 1.6; margin-bottom: 25px;\">\n                        ${getString('export_premium_desc', 'Export to ' + formatName + ' format is only available with a paid subscription plan. Upgrade now to unlock all export formats and advanced features.').replace('{$a}', formatName)}\n                    </p>\n                    <div style=\"background: #ecf0f1; padding: 15px; border-radius: 8px; margin-bottom: 20px;\">\n                        <p style=\"margin: 0; font-size: 14px; color: #34495e;\">\n                            <strong>${getString('free_plan_label', 'Free Plan:')}</strong> ${getString('free_plan_exports', 'PDF exports only')}<br>\n                            <strong>${getString('paid_plans_label', 'Paid Plans:')}</strong> ${getString('paid_plan_exports', 'CSV, Excel, JSON, and PDF exports')}\n                        </p>\n                    </div>\n                </div>`,\n                showCancelButton: true,\n                confirmButtonText: '<i class=\"fa fa-arrow-up\"></i> ' + getString('upgrade_now', 'Upgrade Now'),\n                cancelButtonText: '<i class=\"fa fa-times\"></i> ' + getString('cancel', 'Cancel'),\n                confirmButtonColor: '#3498db',\n                cancelButtonColor: '#95a5a6',\n                width: 500\n            }).then((result) => {\n                if (result.isConfirmed) {\n                    window.open(subscriptionUrl, '_blank');\n                }\n            });\n        },\n\n        /**\n         * Check export eligibility before exporting\n         * @param format\n         */\n        checkExportEligibility: async function(format) {\n            try {\n                var promises = Ajax.call([{\n                    methodname: 'report_adeptus_insights_check_export_eligibility',\n                    args: {format: format}\n                }]);\n                var result = await promises[0];\n                return result.data ? result.data : result;\n            } catch (error) {\n                return {success: false, eligible: false, message: 'Unable to verify export eligibility.'};\n            }\n        },\n\n        /**\n         * Capture chart as image for PDF export\n         * Uses native toDataURL with html2canvas fallback\n         */\n        captureChartImage: async function() {\n            const self = this;\n\n            // Wait for chart animation to complete\n            await new Promise(resolve => setTimeout(resolve, 300));\n\n            const chartCanvas = document.getElementById('reportChart');\n            if (!chartCanvas) {\n                return null;\n            }\n\n            // Method 1: Native canvas toDataURL (fastest, most reliable)\n            try {\n                const dataUrl = chartCanvas.toDataURL('image/png', 0.8);\n                if (dataUrl && dataUrl.length > 100 && dataUrl.length < 2000000) {\n                    return dataUrl;\n                }\n            } catch (e) {\n                // Native capture failed, try fallback.\n            }\n\n            // Method 2: html2canvas fallback (handles CORS/tainted canvas)\n            try {\n                if (!window.html2canvas) {\n                    await self.loadHtml2Canvas();\n                }\n\n                if (window.html2canvas) {\n                    const capturedCanvas = await window.html2canvas(chartCanvas, {\n                        backgroundColor: '#ffffff',\n                        scale: 1.5,\n                        useCORS: true,\n                        allowTaint: true,\n                        logging: false\n                    });\n                    const dataUrl = capturedCanvas.toDataURL('image/png', 0.8);\n                    if (dataUrl && dataUrl.length > 100 && dataUrl.length < 2000000) {\n                        return dataUrl;\n                    }\n                }\n            } catch (e) {\n                // Html2canvas capture failed silently.\n            }\n\n            return null;\n        },\n\n        /**\n         * Load html2canvas library bundled with the plugin\n         */\n        loadHtml2Canvas: function() {\n            return new Promise((resolve, reject) => {\n                if (window.html2canvas) {\n                    resolve();\n                    return;\n                }\n                const script = document.createElement('script');\n                script.src = M.cfg.wwwroot + '/report/adeptus_insights/lib/html2canvas/html2canvas.min.js';\n                script.onload = () => resolve();\n                script.onerror = () => reject(new Error('Failed to load html2canvas'));\n                document.head.appendChild(script);\n            });\n        },\n\n        /**\n         * Export report using local Moodle endpoint (same as Wizard)\n         * @param reportSlug\n         * @param format\n         */\n        exportReport: async function(reportSlug, format) {\n            const self = this;\n\n            // Show loader\n            Swal.fire({\n                title: `Exporting as ${format.toUpperCase()}...`,\n                allowOutsideClick: false,\n                didOpen: () => Swal.showLoading()\n            });\n\n            try {\n                // Check export eligibility first\n                const eligibility = await self.checkExportEligibility(format);\n                if (!eligibility.success || !eligibility.eligible) {\n                    Swal.close();\n                    if (self.isFreePlan && format !== 'pdf') {\n                        self.showExportUpgradePrompt(format);\n                    } else {\n                        Swal.fire({\n                            icon: 'error',\n                            title: getString('export_not_available', 'Export Not Available'),\n                            text: eligibility.message || getString('not_eligible_export', 'You are not eligible to export in this format.')\n                        });\n                    }\n                    return;\n                }\n\n                // Build the request body\n                let body = `reportid=${encodeURIComponent(reportSlug)}&format=${format}&sesskey=${M.cfg.sesskey}`;\n\n                // Add view type based on current view\n                body += `&view=${self._currentReportView}`;\n\n                // Include the report data if we have it stored\n                if (self.currentViewedReportData && Array.isArray(self.currentViewedReportData)) {\n                    // Get headers from the first row's keys\n                    const headers = self.currentViewedReportData.length > 0\n                        ? Object.keys(self.currentViewedReportData[0])\n                        : [];\n\n                    const reportDataPayload = {\n                        results: self.currentViewedReportData,\n                        headers: headers\n                    };\n                    body += `&report_data=${encodeURIComponent(JSON.stringify(reportDataPayload))}`;\n                }\n\n                // For PDF, capture chart image if in chart view\n                if (format === 'pdf' && self._currentReportView === 'chart') {\n                    try {\n                        // Use robust chart capture with timeout protection\n                        const chartImagePromise = self.captureChartImage();\n                        const timeoutPromise = new Promise((_, reject) => {\n                            setTimeout(() => reject(new Error('Chart capture timeout')), 10000);\n                        });\n\n                        const chartImage = await Promise.race([chartImagePromise, timeoutPromise]);\n\n                        if (chartImage && chartImage.length > 100) {\n                            body += `&chart_image=${encodeURIComponent(chartImage)}`;\n                        }\n                    } catch (e) {\n                        // Chart capture failed, continue without chart.\n                    }\n                }\n\n                // Make the request to the download endpoint (binary files cannot use external services)\n                const response = await fetch(`${M.cfg.wwwroot}/report/adeptus_insights/download.php`, {\n                    method: 'POST',\n                    headers: {\n                        'Content-Type': 'application/x-www-form-urlencoded',\n                    },\n                    body: body\n                });\n\n                // Check if response is an error (JSON without Content-Disposition is an error)\n                const contentType = response.headers.get('content-type');\n                const contentDisposition = response.headers.get('content-disposition');\n\n                // If it's JSON but has Content-Disposition: attachment, it's a valid JSON file download\n                // If it's JSON without Content-Disposition, it's an error response\n                if (contentType && contentType.includes('application/json') && !contentDisposition) {\n                    const errorData = await response.json();\n                    throw new Error(errorData.message || 'Export failed');\n                }\n\n                // Check if response is OK\n                if (!response.ok) {\n                    throw new Error(`Export failed with status: ${response.status}`);\n                }\n\n                // Generate meaningful filename\n                const reportName = self.currentViewedReport?.description || self.currentViewedReport?.name || 'report';\n                const sanitizedName = reportName.replace(/[^a-zA-Z0-9\\s-]/g, '').replace(/\\s+/g, '_').toLowerCase();\n                const dateSuffix = new Date().toISOString().split('T')[0]; // YYYY-MM-DD\n\n                // Download the file\n                const blob = await response.blob();\n                const url = window.URL.createObjectURL(blob);\n                const link = document.createElement('a');\n                link.href = url;\n                link.download = `${sanitizedName}_${dateSuffix}.${format}`;\n                document.body.appendChild(link);\n                link.click();\n                window.URL.revokeObjectURL(url);\n                document.body.removeChild(link);\n\n                Swal.close();\n                self.showSuccess(`${format.toUpperCase()} file downloaded successfully!`);\n\n                // Track export in backend after successful download\n                await self.trackExport(format, reportSlug);\n\n            } catch (error) {\n                Swal.close();\n                self.showError(error.message || 'Failed to export report.');\n            }\n        },\n\n        /**\n         * Track export usage in backend\n         * @param format\n         * @param reportName\n         */\n        trackExport: async function(format, reportName) {\n            try {\n                var promises = Ajax.call([{\n                    methodname: 'report_adeptus_insights_track_export',\n                    args: {\n                        format: format,\n                        report_name: reportName\n                    }\n                }]);\n\n                await promises[0];\n                // Silently handle tracking failures - not critical to user experience.\n            } catch (error) {\n                // Tracking failed silently.\n            }\n        },\n\n        /**\n         * Open report from chat link\n         * @param reportSlug\n         */\n        openReportFromLink: function(reportSlug) {\n\n            // Switch to reports tab\n            this.switchToReportsTab();\n\n            // Refresh history from cache\n            this.updateReportsHistory(this.cachedReports);\n\n            // Highlight the report row\n            $('.adeptus-report-row').removeClass('table-primary');\n            const reportRow = $(`.adeptus-report-row[data-report-slug=\"${reportSlug}\"]`);\n            reportRow.addClass('table-primary');\n\n            // Check if report has full data in cache\n            const cached = this.cachedReports.find(r => r.slug === reportSlug);\n\n            // If cached report has data, use it; otherwise fetch from API\n            if (cached && cached.data && Array.isArray(cached.data) && cached.data.length > 0) {\n                this.updateReportsView(cached, cached.data);\n            } else {\n                this.fetchAndDisplayReport(reportSlug, reportRow);\n            }\n        },\n\n        /**\n         * Format timestamps like WhatsApp (today: HH:mm, yesterday: Weekday - HH:mm, same year: D Month - HH:mm, previous years: D Month YYYY - HH:mm)\n         * @param ts\n         */\n        formatTimestamp: function(ts) {\n            const date = (ts instanceof Date) ? ts : new Date(ts);\n            const now = new Date();\n            const pad = (n) => n.toString().padStart(2, '0');\n            const time = `${pad(date.getHours())}:${pad(date.getMinutes())}`;\n            // Different years\n            if (date.getFullYear() !== now.getFullYear()) {\n                const month = date.toLocaleString('default', {month: 'long'});\n                return `${date.getDate()} ${month} ${date.getFullYear()} - ${time}`;\n            }\n            // Today\n            if (date.toDateString() === now.toDateString()) {\n                return time;\n            }\n            // Yesterday\n            const yesterday = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 1);\n            if (date.toDateString() === yesterday.toDateString()) {\n                const weekday = date.toLocaleString('default', {weekday: 'long'});\n                return `${weekday} - ${time}`;\n            }\n            // Earlier this year\n            const month = date.toLocaleString('default', {month: 'long'});\n            return `${date.getDate()} ${month} - ${time}`;\n        },\n\n        /**\n         * Increment or add report badge count in chat history list\n         * @param chatId\n         */\n        updateChatHistoryBadge: function(chatId) {\n            const $item = $(`#chat-history-list li.adeptus-chat-history-item[data-chat-id=\"${chatId}\"]`);\n            if (!$item.length) {\n return;\n}\n            let $badge = $item.find('.adeptus-report-count');\n            if ($badge.length) {\n                const current = parseInt($badge.text(), 10) || 0;\n                $badge.text(current + 1);\n            } else {\n                const $newBadge = $(`<span class=\"badge bg-primary d-flex align-items-center adeptus-report-count\" style=\"color: white;\"><i class=\"fa fa-chart-bar me-1\"></i>1</span>`);\n                $item.append($newBadge);\n            }\n        },\n\n        /**\n         * Persist display type to server\n         * @param reportSlug\n         * @param displayType\n         */\n        saveDisplayType: function(reportSlug, displayType) {\n            // Show SweetAlert loader\n            Swal.fire({\n                title: getString('saving_default_view', 'Saving default view...'),\n                allowOutsideClick: false,\n                didOpen: () => Swal.showLoading()\n            });\n            this.ajaxWithAuth({\n                url: `${this.backendUrl}/ai-reports/${reportSlug}/display-type`,\n                method: 'POST',\n                contentType: 'application/json',\n                data: JSON.stringify({display_type: displayType}),\n                success: () => {\n                    // Show success toast\n                    Swal.fire({icon: 'success', title: getString('default_view_saved', 'Default view saved'), showConfirmButton: false, timer: 1500});\n                    // Update cache and hide save button\n                    const rep = this.cachedReports.find(r => r.slug === reportSlug);\n                    if (rep) {\n rep.display_type = displayType;\n}\n                    $('.adeptus-save-display-type-btn').remove();\n                },\n                error: () => {\n                    // Show error toast\n                    Swal.fire({icon: 'error', title: getString('save_failed', 'Save failed'), text: getString('could_not_save_view', 'Could not save default view. Please try again.')});\n                }\n            });\n        },\n\n        // New method to show resend icon on a specific user message\n        showResendIconOnMessage: function($messageElement, messageText) {\n            if (!$messageElement || !$messageElement.length) {\n                return;\n            }\n\n            // Remove any existing resend icons on this message\n            $messageElement.siblings('.adeptus-failed-reload-icon').remove();\n\n                // Create retry icon\n                const $icon = $(`\n                    <i class=\"fa fa-refresh adeptus-failed-reload-icon text-danger\"\n                   title=\"Retry sending this message\"\n                       style=\"cursor:pointer; float:left; margin-right:0.5rem;\"></i>\n                `);\n\n                // Insert it to the left of the user-message bubble\n            $messageElement.after($icon);\n\n                // Bind click event to resend the message\n                $icon.on('click', () => {\n                    $icon.remove();\n                this.resendMessage($messageElement, messageText);\n            });\n        },\n\n        // Legacy method for backward compatibility - shows resend icon on last user message\n        showResendIconOnLastUserMessage: function() {\n            const $lastUserMessage = $('#adeptus-chat-container .adeptus-user-message:last');\n            if ($lastUserMessage.length) {\n                // Get the message text from the last user message\n                const messageText = $lastUserMessage.find('.adeptus-message-text').text();\n                this.showResendIconOnMessage($lastUserMessage, messageText);\n            }\n        },\n\n        /**\n         * Show the Compare Data modal for the current report\n         * @param report\n         */\n        showCompareDataModal: function(report) {\n            const self = this;\n            const reportSlug = report.slug;\n            let timeline = [];\n            let currentData = null;\n            let selectedA = null;\n            let selectedB = null;\n            let loadingA = false;\n            let loadingB = false;\n            let error = null;\n            let displayTypeA = 'table';\n            let displayTypeB = 'table';\n            let compareDataA = null;\n            let compareDataB = null;\n            let currentDataFetched = false;\n            let nextSection = 'a'; // Alternating selection\n\n            // Helper: fetch timeline\n            /**\n             *\n             * @param cb\n             */\n            function fetchTimeline(cb) {\n                self.ajaxWithAuth({\n                    url: `${this.backendUrl}/ai-reports/${reportSlug}/snapshots`,\n                    method: 'GET',\n                    success: function(res) {\n                        timeline = res.snapshots || [];\n                        if (cb) {\n cb();\n}\n                    },\n                    error: function() {\n                        error = 'Failed to load timeline.';\n                        if (cb) {\n cb();\n}\n                    }\n                });\n            }\n\n            // Helper: fetch current data for A or B\n            /**\n             *\n             * @param section\n             * @param cb\n             */\n            function fetchCurrent(section, cb) {\n                if (section === 'a') {\n loadingA = true;\n}\n                if (section === 'b') {\n loadingB = true;\n}\n                renderSections();\n                self.ajaxWithAuth({\n                    url: `${this.backendUrl}/ai-reports/${reportSlug}/data/current`,\n                    method: 'GET',\n                    success: function(res) {\n                        currentData = res.data || [];\n                        if (section === 'a') {\n                        compareDataA = currentData;\n                        selectedA = 'current';\n                            loadingA = false;\n                        } else {\n                            compareDataB = currentData;\n                            selectedB = 'current';\n                            loadingB = false;\n                        }\n                        currentDataFetched = true;\n                        renderSections();\n                        if (cb) {\n cb();\n}\n                    },\n                    error: function() {\n                        error = 'Failed to fetch current data.';\n                        if (section === 'a') {\n loadingA = false;\n}\n                        if (section === 'b') {\n loadingB = false;\n}\n                        renderSections();\n                        if (cb) {\n cb();\n}\n                    }\n                });\n            }\n\n            // Helper: fetch a single snapshot's data for A or B\n            /**\n             *\n             * @param snapId\n             * @param section\n             * @param cb\n             */\n            function fetchSnapshotData(snapId, section, cb) {\n                if (section === 'a') {\n loadingA = true;\n}\n                if (section === 'b') {\n loadingB = true;\n}\n                renderSections();\n                self.ajaxWithAuth({\n                    url: `${this.backendUrl}/ai-reports/${reportSlug}/snapshots/${snapId}`,\n                    method: 'GET',\n                    success: function(res) {\n                        if (section === 'a') {\n                            compareDataA = res.data;\n                            selectedA = snapId;\n                            loadingA = false;\n                        } else {\n                            compareDataB = res.data;\n                            selectedB = snapId;\n                            loadingB = false;\n                        }\n                        renderSections();\n                        if (cb) {\n cb();\n}\n                    },\n                    error: function() {\n                        error = 'Failed to fetch snapshot data.';\n                        if (section === 'a') {\n loadingA = false;\n}\n                        if (section === 'b') {\n loadingB = false;\n}\n                        renderSections();\n                        if (cb) {\n cb();\n}\n                    }\n                });\n            }\n\n            // Helper: compare two snapshots (for diff table)\n            /**\n             *\n             * @param aId\n             * @param bId\n             * @param cb\n             */\n            function fetchCompare(aId, bId, cb) {\n                loadingA = true;\n                loadingB = true;\n                renderSections();\n                self.ajaxWithAuth({\n                    url: `${this.backendUrl}/ai-reports/${reportSlug}/snapshots/${aId}/compare/${bId}`,\n                    method: 'GET',\n                    success: function(res) {\n                        compareDataA = res.a.data;\n                        compareDataB = res.b.data;\n                        loadingA = false;\n                        loadingB = false;\n                        renderSections();\n                        if (cb) {\n cb(res);\n}\n                    },\n                    error: function() {\n                        error = 'Failed to compare snapshots.';\n                        loadingA = false;\n                        loadingB = false;\n                        renderSections();\n                        if (cb) {\n cb();\n}\n                    }\n                });\n            }\n\n            // Helper: get color and note\n            /**\n             *\n             * @param snapId\n             */\n            function getSnapshotColor(snapId) {\n                if (!snapId) {\n return {bg: '#f8f9fa', border: '#dee2e6', text: '#6c757d'};\n}\n                const snapIndex = timeline.findIndex(s => s.id === snapId);\n                if (snapIndex === -1) {\n return {bg: '#f8f9fa', border: '#dee2e6', text: '#6c757d'};\n}\n                const colors = [\n                    {bg: '#e3f2fd', border: '#2196f3', text: '#1976d2'},\n                    {bg: '#f3e5f5', border: '#9c27b0', text: '#7b1fa2'},\n                    {bg: '#e8f5e8', border: '#4caf50', text: '#388e3c'},\n                    {bg: '#fff3e0', border: '#ff9800', text: '#f57c00'},\n                    {bg: '#fce4ec', border: '#e91e63', text: '#c2185b'},\n                    {bg: '#e0f2f1', border: '#009688', text: '#00695c'},\n                    {bg: '#f1f8e9', border: '#8bc34a', text: '#689f38'},\n                    {bg: '#fff8e1', border: '#ffc107', text: '#ffa000'}\n                ];\n                return colors[snapIndex % colors.length];\n            }\n            /**\n             *\n             * @param snapId\n             */\n            function getSnapshotNote(snapId) {\n                if (!snapId) {\n return '';\n}\n                if (typeof snapId === 'string' && snapId === 'current') {\n return 'Current Data';\n}\n                const snap = timeline.find(s => s.id === snapId);\n                return snap && snap.note ? snap.note : '';\n            }\n\n            // Render section A\n            /**\n             *\n             */\n            function renderSectionA() {\n                let html = '';\n                const colorA = getSnapshotColor(selectedA);\n                const noteA = getSnapshotNote(selectedA);\n                html += `<div class=\"w-100 adeptus-droppable-snapshot adeptus-compare-section\" id=\"adeptus-compare-section-a\" data-drop-target=\"a\" style=\"border: 2px solid ${colorA.border}; border-radius: 8px; padding: 12px; background-color: ${colorA.bg}; height: 100%; min-height: 300px; position:relative;\">\n                    <div class=\"d-flex justify-content-between align-items-center mb-2\">\n                        <span class=\"fw-bold\" style=\"color: ${colorA.text};\">Snapshot A${noteA ? ': ' + noteA : ''}</span>\n                        <div class=\"btn-group adeptus-display-type-switcher-a\" role=\"group\" aria-label=\"Display type switcher\">\n                            <button class=\"btn btn-icon btn-sm${displayTypeA === 'table' ? ' active' : ''}\" data-type=\"table\" data-side=\"a\" tabindex=\"0\" aria-label=\"Table view\" title=\"Table view\"><i class=\"fa fa-table\"></i></button>\n                            <button class=\"btn btn-icon btn-sm${displayTypeA === 'chart' ? ' active' : ''}\" data-type=\"chart\" data-side=\"a\" tabindex=\"0\" aria-label=\"Chart view\" title=\"Chart view\"><i class=\"fa fa-bar-chart\"></i></button>\n                            <button class=\"btn btn-icon btn-sm${displayTypeA === 'graph' ? ' active' : ''}\" data-type=\"graph\" data-side=\"a\" tabindex=\"0\" aria-label=\"Graph view\" title=\"Graph view\"><i class=\"fa fa-line-chart\"></i></button>\n                            </div>\n                        </div>`;\n                if (loadingA) {\n                    html += '<div class=\"w-100 d-flex justify-content-center align-items-center\" style=\"min-height:200px\"><div class=\"spinner-border text-primary\" role=\"status\"></div></div>';\n                } else if (compareDataA) {\n                    html += `<div class=\"adeptus-comparison-fade${displayTypeA ? ' adeptus-comparison-fade-in' : ''}\" style=\"animation:fadeIn .3s; overflow-x: auto; max-height: calc(100% - 50px);\">`;\n                    if (displayTypeA === 'table') {\n                        html += self.renderDiffTable(compareDataA, compareDataB);\n                    } else if (displayTypeA === 'chart') {\n                        html += `<div class=\"adeptus-chart-container\" style=\"min-height:260px;\" tabindex=\"0\" aria-label=\"Bar chart\" role=\"region\"><canvas id=\"compareChartA\"></canvas></div>`;\n                    } else if (displayTypeA === 'graph') {\n                        html += `<div class=\"adeptus-chart-container\" style=\"min-height:260px;\" tabindex=\"0\" aria-label=\"Line graph\" role=\"region\"><canvas id=\"compareGraphA\"></canvas></div>`;\n                    }\n                    html += '</div>';\n                } else {\n                    html += `<div class=\"text-muted small text-center\" style=\"min-height:200px;\">No snapshot selected for A</div>`;\n                }\n                html += '</div>';\n                return html;\n            }\n            // Render section B\n            /**\n             *\n             */\n            function renderSectionB() {\n                let html = '';\n                const colorB = getSnapshotColor(selectedB);\n                const noteB = getSnapshotNote(selectedB);\n                html += `<div class=\"w-100 adeptus-droppable-snapshot adeptus-compare-section\" id=\"adeptus-compare-section-b\" data-drop-target=\"b\" style=\"border: 2px solid ${colorB.border}; border-radius: 8px; padding: 12px; background-color: ${colorB.bg}; height: 100%; min-height: 300px; position:relative;\">\n                    <div class=\"d-flex justify-content-between align-items-center mb-2\">\n                        <span class=\"fw-bold\" style=\"color: ${colorB.text};\">Snapshot B${noteB ? ': ' + noteB : ''}</span>\n                        <div class=\"btn-group adeptus-display-type-switcher-b\" role=\"group\" aria-label=\"Display type switcher B\">\n                            <button class=\"btn btn-icon btn-sm${displayTypeB === 'table' ? ' active' : ''}\" data-type=\"table\" data-side=\"b\" tabindex=\"0\" aria-label=\"Table view for B\" title=\"Table view\"><i class=\"fa fa-table\"></i></button>\n                            <button class=\"btn btn-icon btn-sm${displayTypeB === 'chart' ? ' active' : ''}\" data-type=\"chart\" data-side=\"b\" tabindex=\"0\" aria-label=\"Chart view for B\" title=\"Chart view\"><i class=\"fa fa-bar-chart\"></i></button>\n                            <button class=\"btn btn-icon btn-sm${displayTypeB === 'graph' ? ' active' : ''}\" data-type=\"graph\" data-side=\"b\" tabindex=\"0\" aria-label=\"Graph view for B\" title=\"Graph view\"><i class=\"fa fa-line-chart\"></i></button>\n                        </div>\n                    </div>`;\n                if (loadingB) {\n                    html += '<div class=\"w-100 d-flex justify-content-center align-items-center\" style=\"min-height:200px\"><div class=\"spinner-border text-primary\" role=\"status\"></div></div>';\n                } else if (compareDataB) {\n                    html += `<div class=\"adeptus-comparison-fade${displayTypeB ? ' adeptus-comparison-fade-in' : ''}\" style=\"animation:fadeIn .3s; overflow-x: auto; max-height: calc(100% - 50px);\">`;\n                    if (displayTypeB === 'table') {\n                        html += self.renderDiffTable(compareDataB, compareDataA);\n                    } else if (displayTypeB === 'chart') {\n                        html += `<div class=\"adeptus-chart-container\" style=\"min-height:260px;\" tabindex=\"0\" aria-label=\"Bar chart for B\" role=\"region\"><canvas id=\"compareChartB\"></canvas></div>`;\n                    } else if (displayTypeB === 'graph') {\n                        html += `<div class=\"adeptus-chart-container\" style=\"min-height:260px;\" tabindex=\"0\" aria-label=\"Line graph for B\" role=\"region\"><canvas id=\"compareGraphB\"></canvas></div>`;\n                    }\n                    html += '</div>';\n                    } else {\n                    html += `<div class=\"text-muted small text-center\" style=\"min-height:200px;\">No snapshot selected for B</div>`;\n                }\n                html += '</div>';\n                return html;\n            }\n\n            // Render both sections\n            /**\n             *\n             */\n            function renderSections() {\n                $('#adeptus-compare-section-a').replaceWith(renderSectionA());\n                $('#adeptus-compare-section-b').replaceWith(renderSectionB());\n                // Chart.js rendering for A\n                if (displayTypeA === 'chart' && Array.isArray(compareDataA) && compareDataA.length > 0) {\n                    const ctxA = document.getElementById('compareChartA');\n                    if (ctxA) {\n                        const headers = Object.keys(compareDataA[0]);\n                        let labelKey = headers.find(h => typeof compareDataA[0][h] === 'string') || headers[0];\n                        let valueKey = headers.find(h => typeof compareDataA[0][h] === 'number') || headers[1];\n                        const labels = compareDataA.map(r => r[labelKey]);\n                        const values = compareDataA.map(r => r[valueKey]);\n                        if (window.compareChartAInstance) {\n window.compareChartAInstance.destroy();\n}\n                        window.compareChartAInstance = new Chart(ctxA.getContext('2d'), {\n                            type: 'bar',\n                            data: {labels: labels, datasets: [{label: valueKey, data: values, backgroundColor: 'rgba(0,123,255,0.5)', borderColor: 'rgba(0,123,255,1)', borderWidth: 1}]},\n                            options: {responsive: true, maintainAspectRatio: false, plugins: {legend: {display: false}}}\n                        });\n                    }\n                }\n                if (displayTypeA === 'graph' && Array.isArray(compareDataA) && compareDataA.length > 0) {\n                    const ctxA = document.getElementById('compareGraphA');\n                    if (ctxA) {\n                        const headers = Object.keys(compareDataA[0]);\n                        let labelKey = headers.find(h => typeof compareDataA[0][h] === 'string') || headers[0];\n                        let valueKey = headers.find(h => typeof compareDataA[0][h] === 'number') || headers[1];\n                        const labels = compareDataA.map((r, i) => r[labelKey] || i + 1);\n                        const values = compareDataA.map(r => r[valueKey]);\n                        if (window.compareGraphAInstance) {\n window.compareGraphAInstance.destroy();\n}\n                        window.compareGraphAInstance = new Chart(ctxA.getContext('2d'), {\n                            type: 'line',\n                            data: {labels: labels, datasets: [{label: valueKey, data: values, backgroundColor: 'rgba(40,167,69,0.5)', borderColor: 'rgba(40,167,69,1)', borderWidth: 2, fill: false}]},\n                            options: {responsive: true, maintainAspectRatio: false, plugins: {legend: {display: false}}}\n                        });\n                    }\n                }\n                // Chart.js rendering for B\n                if (displayTypeB === 'chart' && Array.isArray(compareDataB) && compareDataB.length > 0) {\n                    const ctxB = document.getElementById('compareChartB');\n                    if (ctxB) {\n                        const headers = Object.keys(compareDataB[0]);\n                        let labelKey = headers.find(h => typeof compareDataB[0][h] === 'string') || headers[0];\n                        let valueKey = headers.find(h => typeof compareDataB[0][h] === 'number') || headers[1];\n                        const labels = compareDataB.map(r => r[labelKey]);\n                        const values = compareDataB.map(r => r[valueKey]);\n                        if (window.compareChartBInstance) {\n window.compareChartBInstance.destroy();\n}\n                        window.compareChartBInstance = new Chart(ctxB.getContext('2d'), {\n                            type: 'bar',\n                            data: {labels: labels, datasets: [{label: valueKey, data: values, backgroundColor: 'rgba(0,123,255,0.5)', borderColor: 'rgba(0,123,255,1)', borderWidth: 1}]},\n                            options: {responsive: true, maintainAspectRatio: false, plugins: {legend: {display: false}}}\n                        });\n                    }\n                }\n                if (displayTypeB === 'graph' && Array.isArray(compareDataB) && compareDataB.length > 0) {\n                    const ctxB = document.getElementById('compareGraphB');\n                    if (ctxB) {\n                        const headers = Object.keys(compareDataB[0]);\n                        let labelKey = headers.find(h => typeof compareDataB[0][h] === 'string') || headers[0];\n                        let valueKey = headers.find(h => typeof compareDataB[0][h] === 'number') || headers[1];\n                        const labels = compareDataB.map((r, i) => r[labelKey] || i + 1);\n                        const values = compareDataB.map(r => r[valueKey]);\n                        if (window.compareGraphBInstance) {\n window.compareGraphBInstance.destroy();\n}\n                        window.compareGraphBInstance = new Chart(ctxB.getContext('2d'), {\n                            type: 'line',\n                            data: {labels: labels, datasets: [{label: valueKey, data: values, backgroundColor: 'rgba(40,167,69,0.5)', borderColor: 'rgba(40,167,69,1)', borderWidth: 2, fill: false}]},\n                            options: {responsive: true, maintainAspectRatio: false, plugins: {legend: {display: false}}}\n                        });\n                    }\n                }\n            }\n\n            // Helper: render timeline sidebar (unchanged)\n            /**\n             *\n             * @param selectedAId\n             * @param selectedBId\n             */\n            function renderTimeline(selectedAId, selectedBId) {\n                let html = '<div class=\"adeptus-timeline-sidebar\" style=\"width:220px;max-width:220px;overflow-y:auto;height:100%;background:#f8f9fa;border-right:1.5px solid #e0e0e0;padding:0.5rem 0.25rem;\">';\n                html += '<div class=\"d-flex flex-column gap-2 mb-3\">';\n                html += `<button class=\"btn btn-outline-primary btn-sm w-100 mb-1 adeptus-fetch-current-btn\" title=\"Fetch current data from database\" aria-label=\"Fetch current data\"><i class=\"fa fa-sync\"></i> Fetch Current Data</button>`;\n                const isCurrentDataInContext = currentDataFetched && selectedA === 'current';\n                if (isCurrentDataInContext) {\n                    html += `<div class=\"mb-2\">\n                        <input type=\"text\" id=\"add-timeline-note\" class=\"form-control form-control-sm mb-1\" placeholder=\"Enter snapshot name (required)\" required aria-label=\"Snapshot name\">\n                        <div class=\"invalid-feedback\" style=\"display:none;\">Snapshot name is required.</div>\n                        <button class=\"btn btn-outline-success btn-sm w-100 adeptus-add-timeline-btn\" ` +\n                        `id=\"adeptus-add-timeline-btn\" title=\"Create snapshot from current data\" ` +\n                        `aria-label=\"Create snapshot from current data\" disabled>` +\n                        `<span class=\"adeptus-btn-label\"><i class=\"fa fa-plus\"></i> ` +\n                        `Create Snapshot From Current Data</span>` +\n                        `<span class=\"spinner-border spinner-border-sm ms-2\" ` +\n                        `id=\"snapshot-loading\" style=\"display:none;\" role=\"status\" ` +\n                        `aria-hidden=\"true\"></span></button>\n                    </div>`;\n                }\n                html += '<div class=\"small text-muted text-center px-2 py-1 mb-2\" style=\"border: 1px dashed #dee2e6; border-radius: 4px;\">Click or <b>drag</b> snapshots to select for comparison. Each snapshot gets a unique color. You can also drag and drop from the side menu into the snapshot viewer.</div>';\n                html += '</div>';\n                html += '<div class=\"adeptus-timeline-list\">';\n                if (timeline.length === 0) {\n                    if (error) {\n                        html += `<div class=\"text-danger small text-center py-2\">Error: ${error}</div>`;\n                    } else {\n                        html += '<div class=\"text-muted small text-center py-2\">No timeline snapshots yet. [DEBUG: Timeline is empty]</div>';\n                    }\n                } else {\n                    timeline.forEach((snap, index) => {\n                        // Color coding system\n                        const colors = [\n                            {bg: '#e3f2fd', border: '#2196f3', text: '#1976d2'}, // Light blue\n                            {bg: '#f3e5f5', border: '#9c27b0', text: '#7b1fa2'}, // Light purple\n                            {bg: '#e8f5e8', border: '#4caf50', text: '#388e3c'}, // Light green\n                            {bg: '#fff3e0', border: '#ff9800', text: '#f57c00'}, // Light orange\n                            {bg: '#fce4ec', border: '#e91e63', text: '#c2185b'}, // Light pink\n                            {bg: '#e0f2f1', border: '#009688', text: '#00695c'}, // Light teal\n                            {bg: '#f1f8e9', border: '#8bc34a', text: '#689f38'}, // Light lime\n                            {bg: '#fff8e1', border: '#ffc107', text: '#ffa000'} // Light amber\n                        ];\n                        const colorIndex = index % colors.length;\n                        const color = colors[colorIndex];\n                        const isSelected = selectedAId === snap.id || selectedBId === snap.id;\n                        const selectedStyle = isSelected ?\n                            `background-color: ${color.bg}; border-color: ${color.border}; border-width: 2px;` :\n                            `background-color: #fff; border-color: #dee2e6; border-width: 1px;`;\n                        const isCurrent = snap.is_current_version ? '<span class=\"badge bg-primary ms-1\">Current</span>' : '';\n                        // Drag and drop attributes\n                        const dragDisabled = isSelected ? 'draggable=\"false\"' : 'draggable=\"true\"';\n                        const dragClass = isSelected ? 'adeptus-drag-disabled' : 'adeptus-draggable-snapshot';\n                        const dragTitle = isSelected ? 'This snapshot is currently selected' : 'Drag to assign to Snapshot A or B';\n                        const dragText = isSelected ? '<span class=\"text-muted small\">(Selected)</span>' : '';\n                        html += `<div class=\"adeptus-timeline-item p-2 mb-1 rounded border ${dragClass}\"\n                                      style=\"cursor:pointer; animation:fadeIn .3s; ${selectedStyle}\"\n                                      data-snap-id=\"${snap.id}\"\n                                      data-color-bg=\"${color.bg}\"\n                                      data-color-border=\"${color.border}\"\n                                      data-color-text=\"${color.text}\"\n                                      tabindex=\"0\"\n                                      aria-label=\"Snapshot from ${self.formatTimestamp(snap.created_at)}${snap.is_current_version ? ' (current)' : ''}\"\n                                      ${dragDisabled}\n                                      title=\"${dragTitle}\"\n                                      >\n                            <div class=\"d-flex justify-content-between align-items-center\">\n                                <span class=\"fw-bold small\">${self.formatTimestamp(snap.created_at)}</span>\n                                ${isCurrent}\n                            </div>\n                            <div class=\"small text-muted\">${snap.note ? snap.note : ''} ${dragText}</div>\n                            <div class=\"d-flex gap-1 mt-1\">\n                                <button class=\"btn btn-outline-secondary btn-xs btn-sm adeptus-set-current-btn\" data-snap-id=\"${snap.id}\" title=\"Set as current version\" aria-label=\"Set as current\"><i class=\"fa fa-check\"></i></button>\n                            </div>\n                        </div>`;\n                    });\n                }\n                html += '</div></div>';\n                return html;\n            }\n\n            // Helper: render modal\n            /**\n             *\n             */\n            function renderModal() {\n                Swal.update({\n                    html: `<div class='d-flex flex-row' style='height:70vh;min-height:500px;max-height:80vh;'>\n                        <div id='adeptus-timeline-sidebar-modal'></div>\n                        <div class='flex-fill px-3' style='overflow:auto;max-width:calc(100% - 220px);'>\n                            <div class='d-flex flex-row gap-3 w-100 h-100'>\n                                <div class='flex-fill' id='adeptus-compare-section-a'></div>\n                                <div class='flex-fill' id='adeptus-compare-section-b'></div>\n                            </div>\n                        </div>\n                    </div>`\n                });\n                $('#adeptus-timeline-sidebar-modal').html(renderTimeline(selectedA, selectedB));\n                renderSections();\n                // Bind timeline actions\n                $('.adeptus-fetch-current-btn').off('click').on('click', function() {\n                    fetchCurrent(nextSection);\n                });\n                // Timeline item click handler for alternating selection\n                $('.adeptus-timeline-item').off('click').on('click', function() {\n                    const snapId = $(this).data('snap-id');\n                    if (nextSection === 'a') {\n                        fetchSnapshotData(snapId, 'a', () => {\n                            nextSection = 'b';\n                        });\n                    } else {\n                        fetchSnapshotData(snapId, 'b', () => {\n                            nextSection = 'a';\n                        });\n                    }\n                });\n                // Display type switchers\n                $('.adeptus-display-type-switcher-a .btn-icon').off('click').on('click', function() {\n                    displayTypeA = $(this).data('type');\n                    renderSections();\n                });\n                $('.adeptus-display-type-switcher-b .btn-icon').off('click').on('click', function() {\n                    displayTypeB = $(this).data('type');\n                    renderSections();\n                });\n                // Drag and drop logic\n                $('.adeptus-draggable-snapshot').attr('draggable', true).off('dragstart').on('dragstart', function(e) {\n                    e.originalEvent.dataTransfer.setData('text/plain', $(this).data('snap-id'));\n                    $(this).addClass('adeptus-dragging');\n                });\n                $('.adeptus-draggable-snapshot').off('dragend').on('dragend', function() {\n                    $(this).removeClass('adeptus-dragging');\n                });\n                // Section highlight on drag over\n                $('.adeptus-compare-section').off('dragover').on('dragover', function(e) {\n                    e.preventDefault();\n                    $(this).addClass('adeptus-drag-over-section');\n                });\n                $('.adeptus-compare-section').off('dragleave').on('dragleave', function() {\n                    $(this).removeClass('adeptus-drag-over-section');\n                });\n                $('.adeptus-compare-section').off('drop').on('drop', function(e) {\n                    e.preventDefault();\n                    $(this).removeClass('adeptus-drag-over-section');\n                    const snapId = e.originalEvent.dataTransfer.getData('text/plain');\n                    const target = $(this).data('drop-target');\n                    fetchSnapshotData(snapId, target, () => {\n                        nextSection = target === 'a' ? 'b' : 'a';\n                    });\n                });\n                // Add highlight CSS if not present\n                if ($('#adeptus-compare-section-highlight-style').length === 0) {\n                    $('head').append('<style id=\"adeptus-compare-section-highlight-style\">.adeptus-drag-over-section { box-shadow: 0 0 0 4px #90caf9 !important; border-color: #1976d2 !important; }</style>');\n                }\n            }\n\n            // Show modal\n            Swal.fire({\n                title: `<span class='fw-bold'>${getString('compare_report_data', 'Compare Report Data')}</span>`,\n                html: `<div class='d-flex flex-row' style='height:60vh;min-height:400px;max-height:70vh;'>\n                    <div id='adeptus-timeline-sidebar-modal'></div>\n                    <div class='flex-fill px-3' style='overflow:auto;max-width:calc(100% - 220px);'>\n                        <div class='d-flex flex-row gap-3 w-100 h-100'>\n                            <div class='flex-fill' id='adeptus-compare-section-a'></div>\n                            <div class='flex-fill' id='adeptus-compare-section-b'></div>\n                        </div>\n                    </div>\n                </div>`,\n                width: '90vw',\n                heightAuto: false,\n                showCancelButton: true,\n                showConfirmButton: false,\n                customClass: {popup: 'swal2-modal-compare-data'},\n                didOpen: () => {\n                    fetchTimeline(() => {\n                        // Default: set A to current version, B to latest snapshot (if >1)\n                        if (timeline.length > 0) {\n                            selectedA = timeline.find(s => s.is_current_version)?.id || timeline[0].id;\n                            selectedB = timeline.length > 1 ? timeline[1].id : null;\n                            if (selectedA && selectedB) {\n                                fetchCompare(selectedA, selectedB, () => {\n                                    nextSection = 'a';\n                                    renderModal();\n                                });\n                            } else if (selectedA) {\n                                fetchSnapshotData(selectedA, 'a', () => {\n                                    nextSection = 'b';\n                                    renderModal();\n                                });\n                            } else {\n                                renderModal();\n                            }\n                        } else {\n                            renderModal();\n                        }\n                    });\n                }\n            });\n        },\n\n        /**\n         * Render a diff table (side-by-side, highlight differences)\n         * @param a\n         * @param b\n         */\n        renderDiffTable: function(a, b) {\n            // Lightweight diff: highlight cells in a that differ from b\n            if (!Array.isArray(a) || a.length === 0) {\n                return '<div class=\"text-muted small\">No data</div>';\n            }\n            const headers = Object.keys(a[0]);\n            let html = '<div class=\"table-responsive\"><table class=\"table table-striped table-hover table-sm\">';\n            html += '<thead><tr>';\n            headers.forEach(h => {\n html += `<th>${h}</th>`;\n});\n            html += '</tr></thead><tbody>';\n            a.forEach((row, i) => {\n                html += '<tr>';\n                headers.forEach(h => {\n                    let diff = false;\n                    // Only highlight differences if we have comparison data\n                    if (b && Array.isArray(b) && b[i] && b[i][h] !== row[h]) {\n                        diff = true;\n                    }\n                    html += `<td${diff ? ' style=\"background:#ffe5e5;\"' : ''}>${row[h] ?? ''}</td>`;\n                });\n                html += '</tr>';\n            });\n            html += '</tbody></table></div>';\n            return html;\n        },\n\n        /**\n         * Test method to simulate a multiple choice question\n         * Call this from browser console: require(['report_adeptus_insights/assistant'], function(a) { a.testMCQ(); });\n         */\n        testMCQ: function() {\n            const testMessage = `I found an existing wizard report that might meet your needs. However, it doesn't include all the fields you requested.\n\nWhat would you like to do?\n\nA. Use the existing wizard report as-is\nB. Generate a new custom SQL report with all fields\nC. Use the wizard report and create a separate supplementary report\nD. Cancel and try a different approach`;\n\n            // Add the test message as if it came from AI\n            this.addMessage(testMessage, 'ai');\n        },\n\n        /**\n         * Test with numbered options\n         */\n        testMCQNumbered: function() {\n            const testMessage = `Please select your preferred report format:\n\n1. PDF Export with charts and graphs\n2. Excel spreadsheet with raw data\n3. CSV file for data analysis\n4. Interactive web dashboard\n5. Email summary report`;\n\n            this.addMessage(testMessage, 'ai');\n        }\n    };\n\n    // Expose assistant to global scope for onclick handlers\n    window.assistant = assistant;\n\n    return assistant;\n});"],"names":["define","$","Ajax","Notification","Chart","Templates","Str","AuthUtils","Swal","window","strings","loadStrings","get_strings","key","component","then","results","generating_report","token_limit_reached","token_limit_message","view_usage","report_limit_reached","report_limit_message","view_reports","upgrade_your_plan","upgrade_plan_message","ai_service_busy","ai_service_busy_message","try_again","loading_usage_data","fetching_usage_info","applying_filters","report_chart","please_enter_message","oops","save_your_report","report_name_label","enter_report_name","category_label","select_category","save_report","report_not_found","export_not_available","not_eligible_export","saving_default_view","default_view_saved","save_failed","could_not_save_view","unable_verify_eligibility","unable_verify_export","authentication_required","auth_required_message","refresh_page","delete_chat","delete_chat_confirm","yes_delete","chat_deleted","error_deleting_chat","new_chat","no_chats_yet","start_conversation","error_loading_chats","report_saved","report_saved_message","error_saving_report","delete_report","delete_report_confirm","report_deleted","error_deleting_report","no_reports","generate_reports_message","error_loading_reports","no_data_available","export_success","export_error","processing","please_wait","success","error","warning","confirm","yes","no","deleted","saved","untitled_report","general_category","loading","close","cancel","export_premium_feature","export_premium_description","export_free_plan_info","export_paid_plan_info","upgrade_now","view_plans","monthly_allowance_used","tokens_reset_monthly","used_of_reports","delete_reports_or_upgrade","unlock_features","current_usage","unlimited","reports","report_limit_reached_banner","manage_reports","upgrade_plan","ask_moodle_data","report_limit_placeholder","export_is_premium","export_premium_desc","free_plan_exports","paid_plan_exports","free_plan_label","paid_plans_label","no_reports_generated","ask_ai_create_reports","compare_report_data","failed_load_usage","failed_load_filtered","getString","fallback","assistant","currentChatId","currentMCQ","isSending","mcqQueue","reportsDataTable","cachedReports","cachedCategories","_initCalled","isCreditLimitExceeded","backendUrl","isFreePlan","_currentReportView","_currentReportData","_currentReportName","currentViewedReport","currentViewedReportData","isReportLimitReached","reportsUsed","reportsLimit","reportsRemaining","reportEligibilityChecked","init","config","authenticated","self","this","Array","isArray","arguments","getAssistantContainer","hide","initializeLoaderStyles","_initAfterStrings","catch","isAuthenticated","authStatus","getAuthStatus","userName","user","name","setUserName","updateSubscriptionInfo","setupEventListeners","loadChatHistory","loadReportsHistory","loadCategories","checkReportEligibility","fadeIn","refreshAuthStatus","setTimeout","authStat","uName","showAuthenticationError","length","append","assistantContainer","authReqTitle","authReqMsg","refreshBtn","html","show","on","sendMessage","e","shiftKey","preventDefault","updateChart","style","height","scrollHeight","createNewChat","clearMCQ","empty","prop","extractMCQFromText","text","jsonArrayMatch","match","parsedQuestions","JSON","parse","type","questions","selectedAnswer","jsonMatches","forEach","jsonStr","obj","options","push","parseErr","err","renderMCQHistory","mcq","idx","question","option","optionText","label","isSelected","indexOf","checkAuth","handleResponse","response","error_type","handleCreditLimitError","message","handleReportLimitError","addMessage","showResendIconOnLastUserMessage","firstQuestion","mcqText","join","credit_info","enqueueMCQs","awaiting_confirmation","report","sqlQuery","sql","sql_query","execution_required","report_data","showReportConfirmation","execution_error","executeReportLocally","params","executionResult","data","reportData","description","updateChatHistoryBadge","unshift","updateReportsHistory","destroy","tableElement","document","getElementById","thead","querySelector","tbody","rows","cells","headerCells","dataRows","dataCells","textContent","includes","simpleDatatables","DataTable","searchable","fixedHeight","perPage","removeClass","fire","title","showConfirmButton","allowOutsideClick","allowEscapeKey","timer","timerProgressBar","switchToReportsTab","displayCurrentReport","executeReport","slug","updateReportData","visualizations","updateVisualizations","showCreditUsageFeedback","scrollToBottom","creditInfo","notification","credits_charged","credit_type","css","remove","updateSubscriptionInfoWithCreditUsage","subscription","creditsUsed","premium_credits_used_this_month","basic_credits_used_this_month","ai_credits_used_this_month","animateCreditCounterUpdate","creditType","$counter","addClass","$totalCounter","isReportLink","messageId","timestamp","replace","trim","template","frag","content","cloneNode","messageEl","classList","add","setAttribute","mcqData","mcqHtml","innerHTML","link","onclick","openReportFromLink","getAttribute","onmouseenter","onmouseleave","background","padding","border","maxWidth","isMultipleChoiceQuestion","renderMultipleChoiceOptions","addCreditInfoToMessage","timeEl","formatTimestamp","Date","toISOString","creditBadge","createElement","className","cssText","backgroundColor","color","toUpperCase","tokens_used","provider","appendChild","letterMatches","numberMatches","letters","map","m","firstLetter","charCodeAt","isConsecutive","i","Math","min","numbers","parseInt","lines","split","questionText","line","trimmedLine","letterMatch","numberMatch","letter","isLetter","escapeHtml","optionId","now","querySelectorAll","button","addEventListener","disabled","selectedOption","selectedText","find","o","closest","btn","answer","creditData","summary","updateSubscriptionDataFromCreditResponse","updateSendMessageandCreateNewChatButton","showPersistentCreditLimitMessage","icon","showCancelButton","confirmButtonText","cancelButtonText","confirmButtonColor","result","isConfirmed","showCreditUsageModal","async","promises","call","methodname","args","reports_used","reports_limit","reports_remaining","eligible","updateReportLimitUI","trackReportCreated","reportName","report_name","is_ai_generated","tracking_error","switchTab","isUnlimited","attr","banner","before","showUpgradePrompt","limitText","undefined","tokens_limit","tokens_remaining","setAuthStatus","handleTimeoutError","cancelButtonColor","focus","alertHtml","$mainInners","eq","prepend","hidePersistentCreditLimitMessage","fadeOut","willOpen","showLoading","ajaxWithAuth","url","method","displayDetailedUsageModal","usage","pagination","total","formatTokens","tokens","toFixed","toString","usagePercent","round","total_tokens_used","limitDisplay","modalHtml","total_requests","today_tokens_used","item","d","created_at","day","getDate","month","toLocaleString","year","getFullYear","hours","getHours","padStart","minutes","getMinutes","action_type","model","prompt_tokens","completion_tokens","width","showCloseButton","customClass","popup","htmlContainer","didOpen","closeBtn","setupUsageModalEventListeners","currentFilters","filters","usageDataTable","perPageSelect","sortable","labels","placeholder","noRows","info","userId","val","startDate","endDate","user_id","start_date","end_date","loadUsageDataWithFilters","period","today","weekAgo","setDate","monthAgo","setMonth","getMonth","page","URLSearchParams","updateUsageModalData","total_credits_used","unique_users","premium_credits","basic_credits","tableBody","row","toLocaleDateString","llm_provider","message_preview","substring","refresh","table","columns","column","tr","cell","container","canvas","datasets","dataset","borderColor","borderWidth","responsive","maintainAspectRatio","plugins","legend","position","display","detectNumericColumns","headers","filter","header","numericCount","sampleSize","num","parseFloat","isNaN","isFinite","generateChartColors","count","baseColors","colors","createReportChartConfig","chartType","values","valueKey","baseConfig","font","size","weight","top","bottom","fill","tension","scales","y","beginAtZero","x","ticks","maxRotation","minRotation","renderReportChartFromSelectors","labelKey","valueKeyFormatted","l","chartData","slice","r","labelStr","String","chartConfig","chartEl","reportChartInstance","getContext","loaderShownAt","$chatContainer","hideLoading","loaderShownDuration","remainingTime","max","showError","errorDiv","showSuccess","successHtml","successDiv","scrollTop","list","chats","chat","date","snippet","last_message","first_message","reportCount","report_count","badgeHtml","id","li","currentTarget","chatId","loadChatMessages","children","showWelcomeMessage","reports_generated_this_month","listItem","messageUrl","credit_data","checkAndShowCreditLimitWarning","messages","msg","sender_type","role","body","tag","nextMsg","prevMsg","hasReportMetadata","metadata","isLegacyReport","startsWith","isSavedReportLink","reportDesc","category","sqlMatch","nameMatch","catMatch","descText","reportNameMatch","reportSlug","toLowerCase","report_slug","displayReportLink","insertReportLinkInChat","lastMsg","$msg","message_after_id","linkHtml","toLocaleTimeString","$linkMsg","after","providedMessage","input","rawValue","$userMsg","trigger","userInfo","requestData","chat_id","user_name","contentType","stringify","showResendIconOnMessage","addChatToChatHistory","refreshSubscriptionInfo","status","clearAuthData","responseJSON","errorMessage","removeAttr","firstMessage","displayMessage","clickedChatId","initializeCharts","admin_name","each","isCreditExceeded","used","limit","basicExceeded","plan_basic_credits_limit","premiumExceeded","plan_premium_credits_limit","totalExceeded","plan_ai_credits_limit","updateSubscription","subscriptionHtml","plan_name","templateHeader","off","$btn","$icon","transformBackendAuthData","backendData","adeptusAuthData","user_authorized","has_api_key","installation","plan","premium_credits_per_month","basic_credits_per_month","ai_credits","plan_exports_limit","exports","$refreshBtn","$refreshIcon","localData","showRefreshSuccessFeedback","showRefreshErrorFeedback","calculateUsagePercentage","percentage","Promise","reject","Error","endpoint","deferred","Deferred","done","parsed","resolve","httpcode","fail","promise","getCategoryOptionsHtml","suggestedCategory","normalizedSuggested","cat","normalizedCatName","normalizedCatSlug","validateToken","resendMessage","$msgElem","showNextMCQ","next","shift","renderMCQ","c","opt","fromCharCode","stopPropagation","selected","sendMCQ","messageToSend","executionError","displayReportInChat","addReportActionButtons","tableHtml","Object","keys","maxPreviewRows","previewRows","value","remainingRows","existingActions","buttonId","buttonsHtml","saveBtn","hasAttribute","categoryOptions","defaultName","focusConfirm","preConfirm","categoryId","showValidationMessage","category_id","confirmReport","declineBtn","feedbackBtn","sendFeedbackBtn","cancelFeedbackBtn","feedbackText","feedback","viewSavedReport","tab","reportRow","click","refreshedRow","addNotification","reportDescription","report_description","reportLinkHtml","viewBtn","last","hasClass","fetchAndDisplayReport","sendReportMessage","reportMessage","reportLinkMsg","action","timeout","chat_response","chatResponse","errorMsg","retryBtnId","retryBtn","hasReportStructure","xhr","showRetry","errors","errorDetails","field","retryHtml","reportsLoaded","callback","statusBadge","getStatusBadge","$row","rep","updateReportsView","rowElem","reportsView","displayFetchedReport","findIndex","assign","displayReport","reportGraphInstance","_vteController","numericCols","chartControlsHtml","formattedHeader","col","premiumClass","premiumIcon","controlsHtml","display_type","isChartActive","displayHtml","renderReportData","_pendingTableId","VTE","enhance","perPageOptions","search","start","end","noData","saveDisplayType","exportReport","showExportUpgradePrompt","linkifyUrls","displayUrl","formatCellValue","strValue","headerLower","tableId","isNumeric","every","isDate","some","formattedValue","badgeClass","getStatusBadgeClass","originalContent","handleExecutionSuccess","reportIndex","row_count","format","subscriptionUrl","M","cfg","wwwroot","formatName","open","checkExportEligibility","captureChartImage","chartCanvas","dataUrl","toDataURL","html2canvas","loadHtml2Canvas","scale","useCORS","allowTaint","logging","script","src","onload","onerror","head","eligibility","encodeURIComponent","sesskey","reportDataPayload","chartImagePromise","timeoutPromise","_","chartImage","race","fetch","get","contentDisposition","errorData","json","ok","sanitizedName","_self$currentViewedRe2","dateSuffix","blob","URL","createObjectURL","href","download","revokeObjectURL","removeChild","trackExport","cached","ts","pad","n","time","toDateString","yesterday","weekday","$item","$badge","current","$newBadge","displayType","$messageElement","messageText","siblings","$lastUserMessage","showCompareDataModal","timeline","currentData","selectedA","selectedB","loadingA","loadingB","displayTypeA","displayTypeB","compareDataA","compareDataB","currentDataFetched","nextSection","fetchSnapshotData","snapId","section","cb","renderSections","res","getSnapshotColor","bg","snapIndex","s","getSnapshotNote","snap","note","replaceWith","colorA","noteA","renderDiffTable","renderSectionA","colorB","noteB","renderSectionB","ctxA","h","compareChartAInstance","compareGraphAInstance","ctxB","compareChartBInstance","compareGraphBInstance","renderModal","update","selectedAId","selectedBId","index","selectedStyle","isCurrent","is_current_version","dragDisabled","dragTitle","dragText","renderTimeline","fetchCurrent","originalEvent","dataTransfer","setData","getData","target","heightAuto","snapshots","fetchTimeline","aId","bId","a","b","fetchCompare","diff","testMCQ","testMCQNumbered"],"mappings":"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"}