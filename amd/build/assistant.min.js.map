{"version":3,"file":"assistant.min.js","sources":["../src/assistant.js"],"sourcesContent":["define(['jquery', 'core/ajax', 'core/notification', 'core/chartjs', 'core/templates', 'report_adeptus_insights/auth_utils'], function ($, Ajax, Notification, Chart, Templates, AuthUtils) {\n    var Swal = window.Swal;\n\n    var assistant = {\n        currentChatId: 0,\n        mcqQueue: [],\n        reportsDataTable: null,\n        cachedReports: [],\n        _initCalled: false,\n        isCreditLimitExceeded: false,\n        init: function (authenticated) {\n            if (this._initCalled) return;\n            this._initCalled = true;\n            console.log('[AI Assistant] init called, authenticated:', authenticated);\n            this.currentChatId = 0;\n            console.log('[AI Assistant] currentChatId set to', this.currentChatId);\n            $('.container-fluid').hide();\n            console.log('[AI Assistant] .container-fluid hidden');\n\n            // Initialize authentication system\n            try {\n                // Check if user is authenticated\n                if (AuthUtils.isAuthenticated()) {\n                    console.log('[AI Assistant] User authenticated, proceeding with initialization');\n                    this.setUserName(AuthUtils.getAuthStatus()?.user?.name || \"User\");\n                    this.updateSubscriptionInfo();\n                    this.setupEventListeners();\n                    this.loadChatHistory();\n                    this.loadReportsHistory();\n                    $('.container-fluid').fadeIn(200);\n                } else {\n                    console.log('[AI Assistant] User not authenticated, checking auth status');\n                    // Try to refresh authentication\n                    AuthUtils.refreshAuthStatus();\n                    \n                    // Check authentication status after refresh\n                    setTimeout(() => {\n                        if (AuthUtils.isAuthenticated()) {\n                            this.setUserName(AuthUtils.getAuthStatus()?.user?.name || \"User\");\n                            this.updateSubscriptionInfo();\n                            this.setupEventListeners();\n                            this.loadChatHistory();\n                            this.loadReportsHistory();\n                            $('.container-fluid').fadeIn(200);\n                        } else {\n                            // Show read-only mode or error message\n                            this.showAuthenticationError();\n                        }\n                    }, 500);\n                }\n            } catch (error) {\n                console.error('[AI Assistant] Failed to initialize authentication:', error);\n                // Fallback to basic initialization\n                this.setupEventListeners();\n                $('.container-fluid').fadeIn(200);\n            }\n        },\n\n        showAuthenticationError: function() {\n            // Show authentication error message\n            console.log('[AI Assistant] Showing authentication error');\n            $('.container-fluid').html(`\n                <div class=\"alert alert-danger\">\n                    <h4>Authentication Required</h4>\n                    <p>You need to be authenticated to use the AI Assistant. Please contact your administrator for assistance.</p>\n                    <button class=\"btn btn-primary\" onclick=\"location.reload()\">Refresh Page</button>\n                </div>\n            `);\n        },\n\n        setupEventListeners: function () {\n            const self = this;\n\n            // Send message\n            $('#send-button').on('click', () => this.sendMessage());\n            $('#message-input').on('keydown', (e) => {\n                if (e.key === 'Enter' && !e.shiftKey) {\n                    e.preventDefault();\n                    this.sendMessage();\n                }\n            });\n\n            // Chart type change\n            $('#chart-type').on('change', () => this.updateChart());\n\n            // Auto-resize textarea\n            $('#message-input').on('input', function () {\n                this.style.height = 'auto';\n                this.style.height = (this.scrollHeight) + 'px';\n            });\n\n            $('#create-new-chat').on('click', () => this.createNewChat());\n        },\n\n        // Flag to prevent double message sending\n        isSending: false,\n\n        renderMCQ: function(mcq) {\n            this.currentMCQ = mcq;\n            var c = $('#mcq-container').empty();\n            c.append(`<p><strong>${mcq.question}</strong></p>`);\n            mcq.options.forEach(opt => {\n                c.append(`\n                  <div class=\"form-check\">\n                    <input class=\"form-check-input\" type=\"radio\"\n                           name=\"mcq-option\" id=\"mcq-${opt.key}\"\n                           value=\"${opt.key}\">\n                    <label class=\"form-check-label\" for=\"mcq-${opt.key}\">\n                      ${opt.key}. ${opt.label}\n                    </label>\n                  </div>`);\n            });\n            c.append(`<button id=\"mcq-cancel\" class=\"btn btn-link\">Cancel</button>`);\n        },\n\n        clearMCQ: function() {\n            this.currentMCQ = null;\n            $('#mcq-container').empty().hide();\n            // re-enable text input and send button\n            $('#message-input').prop('disabled', false);\n            $('#send-button').prop('disabled', false);\n        },\n\n        /**\n         * Extract MCQ data from message text (handles both JSON array and individual JSON objects)\n         */\n        extractMCQFromText: function(text) {\n            if (!text || typeof text !== 'string') return null;\n            \n            try {\n                // Try to parse as JSON array first (e.g., ```json [...] ```)\n                const jsonArrayMatch = text.match(/```json\\s*(\\[[\\s\\S]*?\\])\\s*```/);\n                if (jsonArrayMatch) {\n                    const questions = JSON.parse(jsonArrayMatch[1]);\n                    if (Array.isArray(questions) && questions.length > 0 && questions[0].type === 'mcq') {\n                        // Check if there's a selected answer in the next message (if this is history)\n                        return { questions: questions, selectedAnswer: null };\n                    }\n                }\n                \n                // Try to extract individual JSON objects (fallback for older format)\n                const jsonMatches = text.match(/\\{[\\s\\S]*?\\}/g) || [];\n                const questions = [];\n                jsonMatches.forEach(jsonStr => {\n                    try {\n                        const obj = JSON.parse(jsonStr);\n                        if (obj.type === 'mcq' && Array.isArray(obj.options)) {\n                            questions.push(obj);\n                        }\n                    } catch (e) {\n                        // Skip invalid JSON\n                    }\n                });\n                \n                if (questions.length > 0) {\n                    return { questions: questions, selectedAnswer: null };\n                }\n            } catch (e) {\n                console.log('Error extracting MCQ from text:', e);\n            }\n            \n            return null;\n        },\n\n        /**\n         * Render MCQ history view (disabled, showing selected answer if available)\n         */\n        renderMCQHistory: function(questions, selectedAnswer = null) {\n            let html = '<div class=\"mcq-history-container\" style=\"display:flex; flex-direction:column; gap:15px;\">';\n            \n            questions.forEach((mcq, idx) => {\n                // Each MCQ gets its own separate container with border and background\n                html += `\n                    <div class=\"mcq-history-item\" style=\"background:#f8f9fa; padding:15px; border-radius:8px; border:1px solid #dee2e6; box-shadow:0 1px 3px rgba(0,0,0,0.05);\">\n                        <p style=\"font-weight:600; margin-bottom:12px; color:#333; font-size:14px;\">\n                            <i class=\"fa fa-question-circle\" style=\"color:#007bff; margin-right:8px;\"></i>${mcq.question}\n                        </p>\n                        <div class=\"mcq-options\" style=\"margin-left:24px;\">\n                `;\n                \n                mcq.options.forEach((option, optIdx) => {\n                    const optionText = typeof option === 'string' ? option : option.label || option;\n                    const isSelected = selectedAnswer && (selectedAnswer === option || selectedAnswer === optionText || selectedAnswer.includes(optionText));\n                    const selectedStyle = isSelected ? 'background:#e3f0ff; border:2px solid #007bff; font-weight:600;' : 'border:1px solid #ced4da;';\n                    const selectedIcon = isSelected ? '<i class=\"fa fa-check-circle\" style=\"color:#28a745; margin-right:5px;\"></i>' : '';\n                    \n                    html += `\n                        <div class=\"form-check\" style=\"padding:10px 14px; border-radius:6px; margin-bottom:8px; ${selectedStyle} transition:all 0.2s;\">\n                            <input class=\"form-check-input\" type=\"radio\" name=\"mcq-${idx}\" disabled ${isSelected ? 'checked' : ''} style=\"margin-top:0.3em;\">\n                            <label class=\"form-check-label\" style=\"color:#555; cursor:not-allowed; margin-left:5px;\">\n                                ${selectedIcon}${optionText}\n                            </label>\n                        </div>\n                    `;\n                });\n                \n                html += `\n                        </div>\n                        <p style=\"margin-top:12px; margin-bottom:0; font-size:11px; color:#6c757d; font-style:italic;\">\n                            <i class=\"fa fa-info-circle\" style=\"margin-right:4px;\"></i>Previous question from chat history\n                        </p>\n                    </div>\n                `;\n            });\n            \n            html += '</div>';\n            \n            return html;\n        },\n\n        checkAuth: function () {\n            if (!AuthUtils.isAuthenticated()) {\n                console.log('[AI Assistant] User not authenticated');\n                this.showAuthenticationError();\n                return false;\n            } else {\n                this.loadChatHistory();\n                return true;\n            }\n        },\n\n        handleResponse: function (response) {\n            // Route responses based on type\n            if (response.error) {\n                // Handle credit limit errors specifically\n                if (response.error_type === 'credit_limit') {\n                    this.handleCreditLimitError(response.message);\n                    return;\n                }\n                // error bubble from backend\n                this.addMessage(response.message, 'error');\n                // Show resend icon on the last user message\n                this.showResendIconOnLastUserMessage();\n            } else if (response.type === 'mcq') {\n                // Add MCQ as AI message first\n                if (response.questions && response.questions.length > 0) {\n                    const firstQuestion = response.questions[0];\n                    const mcqText = `Question: ${firstQuestion.question}\\nOptions: ${firstQuestion.options.join(', ')}`;\n                    this.addMessage(mcqText, 'ai', false, null, null, null, response.credit_info);\n                }\n                // show multiple-choice question\n                this.enqueueMCQs(response.questions);\n                return;\n            } else if (response.type === 'sql') {\n                // Add SQL as AI message first with report link\n                this.addMessage(response.report.description, 'ai', true, response.report, null, null, response.credit_info);\n                this.updateChatHistoryBadge(this.currentChatId);\n                // Update cache and UI directly\n                this.cachedReports.unshift(response.report);\n                this.updateReportsHistory(this.cachedReports);\n                // Reinitialize DataTable for updated history\n                if (this.reportsDataTable) {\n                    this.reportsDataTable.destroy();\n                    this.reportsDataTable = null;\n                }\n                \n                // Wait for DOM to be updated before reinitializing DataTable\n                setTimeout(() => {\n                    try {\n                        const tableElement = document.getElementById('reports-history-table');\n                        if (tableElement) {\n                            const thead = tableElement.querySelector('thead');\n                            const tbody = tableElement.querySelector('tbody');\n                            \n                            if (thead && tbody && thead.rows.length > 0 && thead.rows[0].cells.length > 0) {\n                                const headerCells = thead.rows[0].cells.length;\n                                const dataRows = tbody.rows;\n                                let dataCells = 0;\n                                \n                                if (dataRows.length > 0) {\n                                    dataCells = dataRows[0].cells.length;\n                                }\n                                \n                                if (headerCells === dataCells && headerCells > 0) {\n                                    // Only initialize DataTable if we have actual data rows (not just empty state)\n                                    if (dataRows.length > 0 && !dataRows[0].cells[0].textContent.includes('No reports')) {\n                this.reportsDataTable = new simpleDatatables.DataTable(\"#reports-history-table\", {\n                    searchable: true,\n                    fixedHeight: false,\n                    perPage: 10\n                });\n                                    }\n                                }\n                            }\n                        }\n                    } catch (error) {\n                        console.error('Error reinitializing DataTable:', error);\n                    }\n                }, 100);\n                // Show SweetAlert loader for report generation\n                Swal.fire({\n                    title: 'Generating Report',\n                    html: `\n                        <div class=\"text-center\">\n                            <div class=\"spinner-border text-primary mb-3\" role=\"status\">\n                            </div>\n                            <p>Please wait while we generate your report...</p>\n                        </div>\n                    `,\n                    showConfirmButton: false,\n                    allowOutsideClick: false,\n                    allowEscapeKey: false,\n                    timer: 2000,\n                    timerProgressBar: true\n                }).then(() => {\n                    this.switchToReportsTab();\n                    this.displayCurrentReport(response.report);\n                    // Automatically execute the report\n                    this.executeReport(response.report.slug);\n                });\n                return;\n            } else {\n                // normal AI or SQL response\n                this.addMessage(response.message, 'ai', false, null, null, null, response.credit_info);\n            }\n\n            // Update report data if available\n            if (response.data) {\n                this.updateReportData(response.data);\n            }\n\n            // Update visualizations if available\n            if (response.visualizations) {\n                this.updateVisualizations(response.visualizations);\n            }\n            \n            // Show immediate credit usage feedback if available\n            if (response.credit_info) {\n                this.showCreditUsageFeedback(response.credit_info);\n            }\n            \n            this.scrollToBottom();\n        },\n\n        /**\n         * Show immediate credit usage feedback\n         */\n        showCreditUsageFeedback: function(creditInfo) {\n            if (!creditInfo) return;\n            \n            // Create a temporary notification for credit usage\n            const notification = $(`\n                <div class=\"credit-usage-notification\" style=\"\n                    position: fixed;\n                    top: 20px;\n                    right: 20px;\n                    background: #28a745;\n                    color: white;\n                    padding: 12px 20px;\n                    border-radius: 6px;\n                    box-shadow: 0 4px 12px rgba(0,0,0,0.15);\n                    z-index: 9999;\n                    font-size: 14px;\n                    font-weight: 500;\n                    opacity: 0;\n                    transform: translateX(100%);\n                    transition: all 0.3s ease;\n                \">\n                    <i class=\"fa fa-coins me-2\"></i>\n                    <span class=\"credit-text\">Credits used: ${creditInfo.credits_charged || 0} (${creditInfo.credit_type || 'basic'})</span>\n                </div>\n            `);\n            \n            // Add to body\n            $('body').append(notification);\n            \n            // Animate in\n            setTimeout(() => {\n                notification.css({\n                    'opacity': '1',\n                    'transform': 'translateX(0)'\n                });\n            }, 100);\n            \n            // Animate out and remove after 3 seconds\n            setTimeout(() => {\n                notification.css({\n                    'opacity': '0',\n                    'transform': 'translateX(100%)'\n                });\n                setTimeout(() => {\n                    notification.remove();\n                }, 300);\n            }, 3000);\n            \n            // Also update the subscription info immediately\n            this.updateSubscriptionInfoWithCreditUsage(creditInfo);\n        },\n\n        /**\n         * Update subscription info with immediate credit usage\n         */\n        updateSubscriptionInfoWithCreditUsage: function(creditInfo) {\n            const authStatus = AuthUtils.getAuthStatus();\n            if (!authStatus || !authStatus.subscription) return;\n            \n            const subscription = authStatus.subscription;\n            const creditsUsed = creditInfo.credits_charged || 0;\n            \n            // Update the credit counters immediately\n            if (creditInfo.credit_type === 'premium') {\n                subscription.premium_credits_used_this_month = (subscription.premium_credits_used_this_month || 0) + creditsUsed;\n            } else {\n                subscription.basic_credits_used_this_month = (subscription.basic_credits_used_this_month || 0) + creditsUsed;\n            }\n            \n            // Update total AI credits\n            subscription.ai_credits_used_this_month = (subscription.ai_credits_used_this_month || 0) + creditsUsed;\n            \n            // Animate the counter updates\n            this.animateCreditCounterUpdate(creditInfo.credit_type, creditsUsed);\n            \n            // Update the display\n            this.updateSubscriptionInfo();\n        },\n\n        /**\n         * Animate credit counter updates\n         */\n        animateCreditCounterUpdate: function(creditType, creditsUsed) {\n            const counterClass = creditType === 'premium' ? '.premium-credits-counter' : '.basic-credits-counter';\n            const $counter = $(counterClass);\n            \n            if ($counter.length) {\n                // Add highlight animation\n                $counter.addClass('credit-update-highlight');\n                \n                // Remove highlight after animation\n                setTimeout(() => {\n                    $counter.removeClass('credit-update-highlight');\n                }, 1000);\n            }\n            \n            // Also animate total credits counter\n            const $totalCounter = $('.total-credits-counter');\n            if ($totalCounter.length) {\n                $totalCounter.addClass('credit-update-highlight');\n                setTimeout(() => {\n                    $totalCounter.removeClass('credit-update-highlight');\n                }, 1000);\n            }\n        },\n\n        addMessage: function (text, type, isReportLink = false, reportData = null, messageId = null, timestamp = null, creditInfo = null) {\n            const template = document.getElementById('message-template');\n            const frag = template.content.cloneNode(true);\n            const messageEl = frag.querySelector('.message');\n            messageEl.classList.add(type + '-message');\n            if (messageId) {\n                messageEl.setAttribute('data-message-id', messageId);\n            }\n            \n            // Check if message contains MCQ JSON\n            const mcqData = this.extractMCQFromText(text);\n            \n            if (mcqData && mcqData.questions.length > 0) {\n                // Render as disabled MCQ view\n                const mcqHtml = this.renderMCQHistory(mcqData.questions, mcqData.selectedAnswer);\n                frag.querySelector('.message-text').innerHTML = mcqHtml;\n            } else if (isReportLink && reportData) {\n                // Create a clickable report link\n                frag.querySelector('.message-text').innerHTML = `\n                    <a href=\"javascript:void(0)\" \n                       class=\"report-link\" \n                       data-report-slug=\"${reportData.slug}\"\n                       style=\"color: #007bff; text-decoration: none; cursor:pointer; padding:4px 8px; border:1px solid #dee2e6; border-radius:4px; background:#f8f9fa; display:inline-block; transition:all 0.2s;\">\n                        ðŸ“Š ${text}\n                    </a>\n                `;\n                const self = this;\n                setTimeout(() => {\n                    const link = messageEl.querySelector('.report-link');\n                    link.onclick = function() { self.openReportFromLink(link.getAttribute('data-report-slug')); };\n                    link.onmouseenter = function() { $(this).css({'background-color':'#e9ecef','border-color':'#adb5bd','transform':'translateY(-1px)'}); };\n                    link.onmouseleave = function() { $(this).css({'background-color':'#f8f9fa','border-color':'#dee2e6','transform':'translateY(0)'}); };\n                }, 0);\n            } else {\n            frag.querySelector('.message-text').textContent = text;\n            }\n            \n            // Add credit information for AI messages\n            if (type === 'ai' && creditInfo) {\n                this.addCreditInfoToMessage(frag, creditInfo);\n            }\n            \n            const timeEl = frag.querySelector('.message-time');\n            timeEl.textContent = this.formatTimestamp(timestamp || new Date().toISOString());\n            $('#chat-container').append(frag);\n            this.scrollToBottom();\n            return $(messageEl);\n        },\n\n        addCreditInfoToMessage: function (frag, creditInfo) {\n            const messageEl = frag.querySelector('.message');\n            const creditBadge = document.createElement('div');\n            creditBadge.className = 'credit-info-badge';\n            creditBadge.style.cssText = `\n                display: inline-block;\n                margin-left: 8px;\n                padding: 2px 6px;\n                border-radius: 12px;\n                font-size: 11px;\n                font-weight: 500;\n                text-transform: uppercase;\n                letter-spacing: 0.5px;\n            `;\n            \n            // Set badge color and text based on credit type\n            if (creditInfo.credit_type === 'premium') {\n                creditBadge.style.backgroundColor = '#6f42c1';\n                creditBadge.style.color = 'white';\n                creditBadge.textContent = 'Premium';\n            } else {\n                creditBadge.style.backgroundColor = '#28a745';\n                creditBadge.style.color = 'white';\n                creditBadge.textContent = 'Basic';\n            }\n            \n            // Add tooltip with detailed information\n            creditBadge.title = `${creditInfo.credit_type.toUpperCase()} Response\\nTokens: ${creditInfo.tokens_used}\\nCredits: ${creditInfo.credits_charged}\\nProvider: ${creditInfo.provider}`;\n            \n            // Insert after message text\n            const messageText = messageEl.querySelector('.message-text');\n            messageText.appendChild(creditBadge);\n        },\n\n        handleCreditLimitError: function (message, creditData = null) {\n            // Update subscription data with latest credit information from API response\n            if (creditData && creditData.summary) {\n                this.updateSubscriptionDataFromCreditResponse(creditData);\n            }\n            \n            // Show persistent credit limit message at the top\n            this.showPersistentCreditLimitMessage(message);\n            \n            // Show user-friendly credit limit error in chat\n            this.addMessage(message, 'error');\n            \n            // Show upgrade prompt\n            Swal.fire({\n                icon: 'warning',\n                title: 'Credit Limit Reached',\n                html: `\n                    <div class=\"text-center\">\n                        <p>${message}</p>\n                        <p class=\"text-muted\">Your monthly credit allowance has been used up.</p>\n                        <p class=\"text-muted\">Credits reset on the 1st of each month.</p>\n                    </div>\n                `,\n                showCancelButton: true,\n                confirmButtonText: 'View Usage',\n                cancelButtonText: 'Close',\n                confirmButtonColor: '#007bff'\n            }).then((result) => {\n                if (result.isConfirmed) {\n                    this.showCreditUsageModal();\n                }\n            });\n        },\n\n        /**\n         * Update subscription data from credit limit error response\n         */\n        updateSubscriptionDataFromCreditResponse: function(creditData) {\n            const authStatus = AuthUtils.getAuthStatus();\n            if (!authStatus || !authStatus.subscription) return;\n            \n            const subscription = authStatus.subscription;\n            const summary = creditData.summary;\n            \n            // Update credit usage with actual data from API\n            if (summary.basic) {\n                subscription.basic_credits_used_this_month = summary.basic.used;\n                subscription.plan_basic_credits_limit = summary.basic.available;\n            }\n            \n            if (summary.premium) {\n                subscription.premium_credits_used_this_month = summary.premium.used;\n                subscription.plan_premium_credits_limit = summary.premium.available;\n            }\n            \n            if (summary.total) {\n                subscription.ai_credits_used_this_month = summary.total.used;\n                subscription.plan_ai_credits_limit = summary.total.available;\n            }\n            \n            // Force refresh of auth status to persist the changes\n            AuthUtils.setAuthStatus(authStatus);\n            \n            // Update the display immediately\n            this.updateSubscriptionInfo();\n        },\n\n        handleTimeoutError: function (message) {\n            // Show user-friendly timeout error\n            this.addMessage(message, 'error');\n            \n            // Show retry prompt\n            Swal.fire({\n                icon: 'info',\n                title: 'AI Service Busy',\n                html: `\n                    <div class=\"text-center\">\n                        <p>${message}</p>\n                        <p class=\"text-muted\">The AI service is experiencing high demand. Please try again in a moment.</p>                                                                                       \n                    </div>\n                `,\n                showCancelButton: true,\n                confirmButtonText: 'Try Again',\n                cancelButtonText: 'Cancel',\n                confirmButtonColor: '#007bff',\n                cancelButtonColor: '#6c757d'\n            }).then((result) => {\n                if (result.isConfirmed) {\n                    // Focus on the input field for retry\n                    $('#message-input').focus();\n                }\n            });\n        },\n\n        showPersistentCreditLimitMessage: function (message) {\n            // Remove any existing credit limit message\n            $('.credit-limit-alert').remove();\n            \n            // Create persistent credit limit message\n            const alertHtml = `\n                <div class=\"alert alert-danger credit-limit-alert\" role=\"alert\" style=\"margin: 10px 0; border-left: 4px solid #dc3545; background-color: #f8d7da; border-color: #f5c6cb;\">\n                    <div class=\"d-flex align-items-center\">\n                        \n                        <div class=\"flex-grow-1\">\n                            <strong class=\"text-danger\">Credit Limit Reached</strong><br>\n                            <small class=\"text-muted\">${message}</small>\n                        </div>\n                        <div class=\"ms-3\">\n                            <button type=\"button\" class=\"btn btn-sm btn-outline-danger me-2\" onclick=\"window.assistant.showCreditUsageModal()\">\n                                <i class=\"fas fa-chart-bar me-1\"></i> View Usage\n                            </button>\n                           \n                        </div>\n                    </div>\n                </div>\n            `;\n            \n            // Insert at the top of the subscription header area\n            // Insert before the second occurrence of class 'main-inner'\n            var $mainInners = $('.main-inner');\n            if ($mainInners.length >= 2) {\n                $mainInners.eq(1).before(alertHtml);\n            } else if ($mainInners.length === 1) {\n                $mainInners.eq(0).before(alertHtml);\n            } else {\n                // Fallback: append to body if .main-inner not found\n                $('body').prepend(alertHtml);\n            }\n\n        },\n\n        hidePersistentCreditLimitMessage: function () {\n            $('.credit-limit-alert').fadeOut(300, function() {\n                $(this).remove();\n            });\n        },\n\n        showCreditUsageModal: function () {\n            // Show loading modal first\n            Swal.fire({\n                title: 'Loading Usage Data...',\n                text: 'Please wait while we fetch your usage information',\n                allowOutsideClick: false,\n                showConfirmButton: false,\n                willOpen: () => {\n                    Swal.showLoading();\n                }\n            });\n\n            // Fetch detailed usage data\n            this.ajaxWithAuth({\n                url: 'https://ai-backend.stagingwithswift.com/api/chat/credits/detailed-usage',\n                method: 'GET',\n                success: (response) => {\n                    if (response.success) {\n                        this.displayDetailedUsageModal(response.data);\n                    } else {\n                        Swal.fire('Error', 'Failed to load usage information', 'error');\n                    }\n                },\n                error: () => {\n                    Swal.fire('Error', 'Failed to load usage information', 'error');\n                }\n            });\n        },\n\n        displayDetailedUsageModal: function (data) {\n            const summary = data.summary;\n            const dailyUsage = data.daily_usage;\n            const userBreakdown = data.user_breakdown;\n            const usage = data.usage;\n            const pagination = data.pagination;\n            const filters = data.filters;\n\n            console.log('displayDetailedUsageModal', data);\n\n            // Create the comprehensive modal HTML with optimized styling\n            const modalHtml = `\n                <div class=\"detailed-usage-modal\" style=\"font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;\">\n                    <!-- Compact Header with improved filters -->\n                    <div class=\"usage-header mb-3 assistant-header\" style=\" padding: 16px; border-radius: 10px; color: white; box-shadow: 0 2px 8px rgba(0,0,0,0.1);\">\n                        <div class=\"d-flex justify-content-between align-items-center\">\n                            <h5 class=\"mb-0\" style=\"color: white; font-weight: 600;\">\n                            <i class=\"fas fa-chart-line me-2\"></i> Usage Analytics Dashboard\n                            </h5>\n                        </div>\n                        </div>\n                        \n                    <!-- Compact Summary Cards -->\n                    <div class=\"row mb-3 g-2\" style=\"height: 109px;\">\n                        <div class=\"col-md-3\" style=\"height: 109px;\">\n                            <div class=\"card border-0\" style=\"height: 109px;background:linear-gradient(135deg, #0ea5e9 0%, #2563eb 100%); color: white; border-radius: 12px; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);\">\n                                <div class=\"card-body text-center p-3\">\n                                \n                                    <div class=\"d-flex align-items-center justify-content-center mb-2\">\n                                        \n                                        <div>\n                                            <h6 class=\"card-title mb-0 small\" style=\"font-weight: 600; opacity: 0.9;\">Total Credits</h6>\n                                            <div class=\"row\" style=\"display: inline-flexalign-content: space-between;align-items: center;justify-content: center;\">\n                                                <i class=\"fas fa-coins fa-lg me-2\" style=\"opacity: 0.8;\"></i>&nbsp;<h4 class=\"mb-0\" style=\"font-weight: 700; font-size: 1.8rem;\">${summary.total_credits_used}</h4>\n                                        </div>\n                                            \n                                    </div>\n                                        \n                                </div>\n                                    <small style=\"opacity: 0.8; font-size: 0.75rem;\">Used This Period</small>\n                            </div>\n                                        </div>\n                                        </div>\n                        <div class=\"col-md-3\" style=\"height: 109px;\">\n                            <div class=\"card border-0\" style=\"height: 109px;background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; border-radius: 12px; box-shadow: 0 4px 12px rgba(17, 153, 142, 0.2);\">\n                                <div class=\"card-body text-center p-3\">\n                                    <div class=\"d-flex align-items-center justify-content-center mb-2\">\n                                        \n                                        <div>\n                                            <h6 class=\"card-title mb-0 small\" style=\"font-weight: 600; opacity: 0.9;\">Total Tokens</h6>\n                                            <div class=\"row\" style=\"display: inline-flexalign-content: space-between;align-items: center;justify-content: center;\">\n                                                <i class=\"fas fa-code fa-lg me-2\" style=\"opacity: 0.8;\"></i>&nbsp;<h4 class=\"mb-0\" style=\"font-weight: 700; font-size: 1.8rem;\">${summary.total_tokens_used.toLocaleString()}</h4>\n                                        </div>\n                                    </div>\n                                </div>\n                                    <small style=\"opacity: 0.8; font-size: 0.75rem;\">AI Tokens Processed</small>\n                            </div>\n                        </div>\n                        </div>\n                        <div class=\"col-md-3\" style=\"height: 109px;\">\n                            <div class=\"card border-0\" style=\"height: 109px;background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; border-radius: 12px; box-shadow: 0 4px 12px rgba(240, 147, 251, 0.2);\">\n                                <div class=\"card-body text-center p-3\">\n                                    <div class=\"d-flex align-items-center justify-content-center mb-2\">\n                                        \n                                        <div>\n                                             <h6 class=\"card-title mb-0 small\" style=\"font-weight: 600; opacity: 0.9;\">Total Requests</h6>\n                                            <div class=\"row\" style=\"display: inline-flexalign-content: space-between;align-items: center;justify-content: center;\">\n                                                <i class=\"fas fa-paper-plane fa-lg me-2\" style=\"opacity: 0.8;\"></i>&nbsp;<h4 class=\"mb-0\" style=\"font-weight: 700; font-size: 1.8rem;\">${summary.total_requests}</h4>\n                                        </div>\n                                    </div>\n                                    </div>\n                                    <small style=\"opacity: 0.8; font-size: 0.75rem;\">Messages Processed</small>\n                                </div>\n                            </div>\n                        </div>\n                        <div class=\"col-md-3\" style=\"height: 109px;\">\n                            <div class=\"card border-0\" style=\"height: 109px;background: linear-gradient(135deg, #ff6b6b 0%, #ffa500 100%); color: white; border-radius: 12px; box-shadow: 0 4px 12px rgba(255, 107, 107, 0.2);\">\n                                <div class=\"card-body text-center p-3\">\n                                    <div class=\"d-flex align-items-center justify-content-center mb-2\">\n\n                                        <div>\n                                            <h6 class=\"card-title mb-0 small\" style=\"font-weight: 600; opacity: 0.9;\">Today's Credits</h6>\n                                            <div class=\"row\" style=\"display: inline-flexalign-content: space-between;align-items: center;justify-content: center;\">\n                                                <i class=\"fas fa-calendar-day fa-lg me-2\" style=\"opacity: 0.8;\"></i>&nbsp;<h4 class=\"mb-0\" style=\"font-weight: 700; font-size: 1.8rem;\">${summary.today_credits_used || 0}</h4>\n                                        </div>\n                                        </div>\n                                    </div>\n                                    <small style=\"opacity: 0.8; font-size: 0.75rem;\">Credits Used Today</small>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n\n                    <!-- Compact Data Table -->\n                    <div class=\"card border-0\" style=\"border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.06);\">\n                        <div class=\"card-header\" style=\"background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-radius: 12px 12px 0 0; border: none; padding: 12px 16px;\">\n                            <div class=\"d-flex justify-content-between align-items-center\">\n                                <h6 class=\"mb-0\" style=\"font-weight: 600; color: linear-gradient(135deg, #0ea5e9 0%, #2563eb 100%);\">\n                                    Detailed Usage History\n                                </h6>\n                                <span class=\"badge bg-primary\" style=\"font-size: 0.7rem; padding: 4px 8px; border-radius: 12px;color: white; background:linear-gradient(135deg, #0ea5e9 0%, #2563eb 100%);\">\n                                    ${usage.length} of ${pagination.total} records\n                                </span>\n                        </div>\n                    </div>\n                        <div class=\"card-body p-0\">\n                            <div class=\"table-responsive\">\n                                <table id=\"usage-datatable\" class=\"table table-hover mb-0\" style=\"font-size: 0.9rem;\">\n                                    <thead style=\"background:linear-gradient(135deg, #0ea5e9 0%, #2563eb 100%); color: white;\">\n                                        <tr>\n                                            <th style=\"border: none; padding: 15px 12px; font-weight: 600; text-align: center;\">Date</th>\n                                            <th style=\"border: none; padding: 15px 12px; font-weight: 600; text-align: center;\">User</th>\n                                            <th style=\"border: none; padding: 15px 12px; font-weight: 600; text-align: center;\">Type</th>\n                                            <th style=\"border: none; padding: 15px 12px; font-weight: 600; text-align: center;\">Credits</th>\n                                            <th style=\"border: none; padding: 15px 12px; font-weight: 600; text-align: center;\">Tokens</th>\n                                            <th style=\"border: none; padding: 15px 12px; font-weight: 600; text-align: center;\">Message Preview</th>\n                                        </tr>\n                                    </thead>\n                                    <tbody>\n                                        ${usage.map(item => `\n                                            <tr style=\"border-bottom: 1px solid #f8f9fa;\">\n                                                <td style=\"padding: 12px; vertical-align: middle; font-weight: 500;\">\n                                                    ${(() => {\n                                                        const d = new Date(item.created_at);\n                                                        const day = d.getDate();\n                                                        const month = d.toLocaleString('en-US', { month: 'short' });\n                                                        const year = d.getFullYear();\n                                                        const hours = d.getHours().toString().padStart(2, '0');\n                                                        const minutes = d.getMinutes().toString().padStart(2, '0');\n                                                        return `${day} ${month} ${year} - ${hours}:${minutes}`;\n                                                    })()}\n                                                </td>\n                                                <td style=\"padding: 12px; vertical-align: middle;\">\n                                                    <span class=\"badge bg-light text-dark\" style=\"border-radius: 20px; padding: 4px 8px;\">\n                                                        ${item.username || 'N/A'}\n                                                    </span>\n                                                </td>\n                                                <td style=\"padding: 12px; vertical-align: middle;\">\n                                                    <span class=\"badge ${item.credit_type === 'premium' ? 'bg-primary' : 'bg-success'}\" style=\"border-radius: 20px; padding: 6px 12px; font-weight: 500;\">\n                                                        <i class=\"fas ${item.credit_type === 'premium' ? 'fa-crown' : 'fa-layer-group'} me-1\"></i>\n                                                        ${item.credit_type}\n                                                    </span>\n                                                </td>\n                                                <td style=\"padding: 12px; vertical-align: middle; font-weight: 600; color: #667eea;\">${item.credits_charged}</td>\n                                                <td style=\"padding: 12px; vertical-align: middle; font-weight: 500;\">${item.tokens_used.toLocaleString()}</td>\n                                                \n                                                <td style=\"padding: 12px; vertical-align: middle; max-width: 200px;\">\n                                                    <div style=\"overflow: hidden; text-overflow: ellipsis; white-space: nowrap;\" title=\"${item.message_preview || 'No message'}\">\n                                                        ${item.message_preview ? item.message_preview.substring(0, 80) + '...' : 'N/A'}\n                                                    </div>\n                                                </td>\n                                            </tr>\n                                        `).join('')}\n                                    </tbody>\n                                </table>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n            `;\n\n            Swal.fire({\n                title: 'Detailed Usage Report',\n                html: modalHtml,\n                width: '80%',\n                height: '80%',\n                showConfirmButton: false,\n                showCancelButton: true,\n                cancelButtonText: 'Close',\n                allowOutsideClick: true,\n                didOpen: () => {\n                    this.setupUsageModalEventListeners(data);\n                }\n            });\n        },\n\n        setupUsageModalEventListeners: function (data) {\n            const self = this;\n            let currentFilters = data.filters;\n            self.usageDataTable = null;\n\n            // Initialize Simple DataTable using the same library as reports table\n            setTimeout(() => {\n                // Check if simpleDatatables is available\n                if (typeof simpleDatatables === 'undefined' || !simpleDatatables.DataTable) {\n                    console.error('simpleDatatables library not available');\n                    return;\n                }\n                \n                // Check if table exists\n                if (!$('#usage-datatable').length) {\n                    console.error('Usage datatable element not found');\n                    return;\n                }\n                \n                try {\n                    console.log('Initializing Simple DataTable for usage analytics...');\n                    \n                    // Check if table has data before initializing\n                    const tableElement = document.getElementById('usage-datatable');\n                    if (tableElement) {\n                        const tbody = tableElement.querySelector('tbody');\n                        const hasData = tbody && tbody.rows.length > 0;\n                        \n                        if (hasData) {\n                            self.usageDataTable = new simpleDatatables.DataTable(\"#usage-datatable\", {\n                                searchable: true,\n                                fixedHeight: false,\n                                perPage: 25,\n                                perPageSelect: [10, 25, 50, 100],\n                                sortable: true,\n                                labels: {\n                                    placeholder: \"Search usage history...\",\n                                    noRows: \"No usage data found\",\n                                    info: \"Showing {start} to {end} of {rows} entries\"\n                                }\n                            });\n                            \n                            console.log('Simple DataTable initialized successfully:', self.usageDataTable);\n                        } else {\n                            console.log('No data in table, skipping DataTable initialization');\n                        }\n                    }\n                } catch (error) {\n                    console.error('Error initializing Simple DataTable:', error);\n                    console.error('Error details:', error.message, error.stack);\n                }\n            }, 500);\n\n            // Apply filters button\n            $('#apply-filters').on('click', function() {\n                const userId = $('#user-filter').val();\n                const creditType = $('#credit-type-filter').val();\n                const startDate = $('#start-date-filter').val();\n                const endDate = $('#end-date-filter').val();\n\n                currentFilters = {\n                    user_id: userId,\n                    credit_type: creditType,\n                    start_date: startDate,\n                    end_date: endDate\n                };\n\n                self.loadUsageDataWithFilters(currentFilters, 1);\n            });\n\n            // Clear filters button\n            $('#clear-filters').on('click', function() {\n                $('#user-filter').val('');\n                $('#credit-type-filter').val('');\n                $('#start-date-filter').val('');\n                $('#end-date-filter').val('');\n                \n                currentFilters = {};\n                self.loadUsageDataWithFilters({}, 1);\n            });\n\n            // Quick filter buttons\n            $('.quick-filter').on('click', function() {\n                const period = $(this).data('period');\n                const today = new Date();\n                let startDate = '';\n                let endDate = today.toISOString().split('T')[0];\n                \n                switch(period) {\n                    case 'today':\n                        startDate = endDate;\n                        break;\n                    case 'week':\n                        const weekAgo = new Date(today);\n                        weekAgo.setDate(today.getDate() - 7);\n                        startDate = weekAgo.toISOString().split('T')[0];\n                        break;\n                    case 'month':\n                        const monthAgo = new Date(today);\n                        monthAgo.setMonth(today.getMonth() - 1);\n                        startDate = monthAgo.toISOString().split('T')[0];\n                        break;\n                }\n                \n                // Update date inputs\n                $('#start-date-filter').val(startDate);\n                $('#end-date-filter').val(endDate);\n                \n                // Apply filters automatically\n                currentFilters = {\n                    user_id: $('#user-filter').val(),\n                    credit_type: $('#credit-type-filter').val(),\n                    start_date: startDate,\n                    end_date: endDate\n                };\n                \n                self.loadUsageDataWithFilters(currentFilters, 1);\n            });\n        },\n\n        loadUsageDataWithFilters: function(filters, page = 1) {\n            // Show loading\n            Swal.fire({\n                title: 'Loading...',\n                text: 'Applying filters and loading data',\n                allowOutsideClick: false,\n                showConfirmButton: false,\n                willOpen: () => {\n                    Swal.showLoading();\n                }\n            });\n\n            // Build query string\n            const params = new URLSearchParams();\n            if (filters.user_id) params.append('user_id', filters.user_id);\n            if (filters.credit_type) params.append('credit_type', filters.credit_type);\n            if (filters.start_date) params.append('start_date', filters.start_date);\n            if (filters.end_date) params.append('end_date', filters.end_date);\n            params.append('page', page);\n            params.append('per_page', 1000); // Get more data for DataTable\n\n            this.ajaxWithAuth({\n                url: `https://ai-backend.stagingwithswift.com/api/chat/credits/detailed-usage?${params.toString()}`,\n                method: 'GET',\n                success: (response) => {\n                    if (response.success) {\n                        console.log('usage data', response.data);\n                        this.updateUsageModalData(response.data);\n                    } else {\n                        Swal.fire('Error', 'Failed to load filtered data', 'error');\n                    }\n                },\n                error: () => {\n                    Swal.fire('Error', 'Failed to load filtered data', 'error');\n                }\n            });\n        },\n\n        updateUsageModalData: function(data) {\n            const summary = data.summary;\n            const usage = data.usage;\n\n            // Update summary cards\n            $('.detailed-usage-modal .card h2').eq(0).text(summary.total_credits_used);\n            $('.detailed-usage-modal .card h2').eq(1).text(summary.total_tokens_used.toLocaleString());\n            $('.detailed-usage-modal .card h2').eq(2).text(summary.total_requests);\n            $('.detailed-usage-modal .card h2').eq(3).text(summary.unique_users);\n            $('.detailed-usage-modal .card h3').eq(0).text(summary.premium_credits);\n            $('.detailed-usage-modal .card h3').eq(1).text(summary.basic_credits);\n\n            // Update record count badge\n            $('.detailed-usage-modal .badge.bg-primary').text(`${usage.length} of ${data.pagination.total} records`);\n\n            // Clear and rebuild table data\n            const tableBody = $('#usage-datatable tbody');\n            tableBody.empty();\n\n            usage.forEach(item => {\n                const row = `\n                    <tr style=\"border-bottom: 1px solid #f8f9fa;\">\n                        <td style=\"padding: 12px; vertical-align: middle; font-weight: 500;\">${new Date(item.created_at).toLocaleDateString()}</td>\n                        <td style=\"padding: 12px; vertical-align: middle;\">\n                            <span class=\"badge bg-light text-dark\" style=\"border-radius: 20px; padding: 4px 8px;\">\n                                ${item.user_id || 'N/A'}\n                            </span>\n                        </td>\n                        <td style=\"padding: 12px; vertical-align: middle;\">\n                            <span class=\"badge ${item.credit_type === 'premium' ? 'bg-primary' : 'bg-success'}\" style=\"border-radius: 20px; padding: 6px 12px; font-weight: 500;\">\n                                <i class=\"fas ${item.credit_type === 'premium' ? 'fa-crown' : 'fa-layer-group'} me-1\"></i>\n                                ${item.credit_type}\n                            </span>\n                        </td>\n                        <td style=\"padding: 12px; vertical-align: middle; font-weight: 600; color: #667eea;\">${item.credits_charged}</td>\n                        <td style=\"padding: 12px; vertical-align: middle; font-weight: 500;\">${item.tokens_used.toLocaleString()}</td>\n                        <td style=\"padding: 12px; vertical-align: middle;\">\n                            <span class=\"badge bg-info text-white\" style=\"border-radius: 20px; padding: 4px 8px;\">\n                                ${item.llm_provider}\n                            </span>\n                        </td>\n                        <td style=\"padding: 12px; vertical-align: middle; max-width: 200px;\">\n                            <div style=\"overflow: hidden; text-overflow: ellipsis; white-space: nowrap;\" title=\"${item.message_preview || 'No message'}\">\n                                ${item.message_preview ? item.message_preview.substring(0, 50) + '...' : 'N/A'}\n                            </div>\n                        </td>\n                    </tr>\n                `;\n                tableBody.append(row);\n            });\n\n        // Update Simple DataTable if it exists\n        if (this.usageDataTable && typeof this.usageDataTable.refresh === 'function') {\n            try {\n                this.usageDataTable.refresh();\n                console.log('Simple DataTable refreshed with new data');\n            } catch (error) {\n                console.error('Error refreshing Simple DataTable:', error);\n            }\n        } else {\n            console.log('Simple DataTable not found, skipping update');\n            }\n        },\n\n        updateReportData: function (data) {\n            const table = $('#report-table');\n            table.empty();\n\n            // Add headers\n            const thead = $('<thead><tr></tr></thead>');\n            data.columns.forEach(column => {\n                thead.find('tr').append(`<th>${column}</th>`);\n            });\n            table.append(thead);\n\n            // Add rows\n            const tbody = $('<tbody></tbody>');\n            data.rows.forEach(row => {\n                const tr = $('<tr></tr>');\n                row.forEach(cell => {\n                    tr.append(`<td>${cell}</td>`);\n                });\n                tbody.append(tr);\n            });\n            table.append(tbody);\n        },\n\n        updateVisualizations: function (visualizations) {\n            const container = $('#chart-container');\n            container.empty();\n\n            // Create canvas for chart\n            const canvas = $('<canvas></canvas>');\n            container.append(canvas);\n\n            // Get chart type\n            const type = $('#chart-type').val();\n\n            // Create chart\n            new Chart(canvas[0], {\n                type: type,\n                data: {\n                    labels: visualizations.labels,\n                    datasets: visualizations.datasets.map(dataset => ({\n                        label: dataset.label,\n                        data: dataset.data,\n                        backgroundColor: dataset.backgroundColor,\n                        borderColor: dataset.borderColor,\n                        borderWidth: 1\n                    }))\n                },\n                options: {\n                    responsive: true,\n                    maintainAspectRatio: false,\n                    plugins: {\n                        legend: {\n                            position: 'top'\n                        },\n                        title: {\n                            display: true,\n                            text: visualizations.title\n                        }\n                    }\n                }\n            });\n        },\n\n        showLoading: function () {\n            $('#loading-indicator').removeClass('d-none');\n        },\n\n        hideLoading: function () {\n            $('#loading-indicator').addClass('d-none');\n        },\n\n        showError: function (message) {\n            const errorDiv = $('#error-message');\n            $('#error-text').text(message);\n            errorDiv.removeClass('d-none');\n\n            // Auto-hide after 5 seconds\n            setTimeout(() => {\n                errorDiv.addClass('d-none');\n            }, 5000);\n        },\n\n        showSuccess: function (message) {\n            // Create success alert if it doesn't exist\n            if ($('#success-message').length === 0) {\n                const successHtml = `\n                    <div class=\"alert alert-success alert-dismissible fade show d-none\" role=\"alert\" id=\"success-message\" style=\"position:fixed; top:20px; right:20px; z-index:1050;\">\n                        <i class=\"fa fa-check-circle me-2\"></i>\n                        <span id=\"success-text\"></span>\n                        <button type=\"button\" class=\"btn-close\" data-bs-dismiss=\"alert\" aria-label=\"Close\"></button>\n                    </div>\n                `;\n                $('body').append(successHtml);\n            }\n            \n            const successDiv = $('#success-message');\n            $('#success-text').text(message);\n            successDiv.removeClass('d-none');\n\n            // Auto-hide after 3 seconds\n            setTimeout(() => {\n                successDiv.addClass('d-none');\n            }, 3000);\n        },\n\n        scrollToBottom: function () {\n            const container = $('#chat-container');\n            container.scrollTop(container[0].scrollHeight);\n        },\n\n        /**\n         * Fetch chat history, show spinner, then render list or \"No chats\"\n         */\n        loadChatHistory: function () {\n            const list = $('#chat-history-list');\n            list.html(`\n                <li class=\"list-group-item d-flex justify-content-center\" id=\"chat-history-loading\">\n                    <div class=\"spinner-border text-secondary\" role=\"status\">\n                    </div>\n                </li>\n                `);\n\n            this.ajaxWithAuth({\n                url: 'https://ai-backend.stagingwithswift.com/api/chat/history',\n                method: 'GET',\n                success: (response) => {\n                    list.empty();\n                    if (!response.chats.length) {\n                        // Check if we also have no reports\n                        const authStatus = AuthUtils.getAuthStatus();\n                        const hasReports = authStatus && authStatus.subscription && \n                            authStatus.subscription.reports_generated_this_month > 0;\n                        \n                        if (!hasReports) {\n                            list.append(`\n                                <li class=\"list-group-item text-center\">\n                                    <div class=\"text-muted\">\n                                        <i class=\"fa fa-comments fa-2x mb-2\"></i>\n                                        <p class=\"mb-1\">No chat history yet</p>\n                                        <small>Start a conversation to see your chat history here</small>\n                                    </div>\n                                </li>\n                            `);\n                        } else {\n                        list.append(`<li class=\"list-group-item text-center\">No chats yet</li>`);\n                        }\n                    } else {\n                        response.chats.forEach(chat => {\n                            const date = new Date(chat.created_at).toLocaleString();\n                            const snippet = chat.snippet;\n                            const reportCount = chat.report_count || 0;\n                            const badgeHtml = reportCount > 0\n                                ? `<span class=\"badge bg-primary d-flex align-items-center report-count\"><i class=\"fa fa-chart-bar me-1\"></i>${reportCount}</span>`\n                                : '';\n                            const item = $(`\n                                <li class=\"list-group-item d-flex justify-content-between align-items-start chat-history-item\" data-chat-id=\"${chat.id}\">\n                                    <div>\n                                        <small class=\"text-muted\">${date}</small><br>\n                                        ${snippet}\n                                    </div>\n                                    ${badgeHtml}\n                                </li>\n                            `);\n                            list.prepend(item);\n                        });\n                        $('.chat-history-item').on('click', (e) => {\n                            const li = $(e.currentTarget);\n                            const chatId = li.data('chat-id');\n                            this.loadChatMessages(chatId, li);\n                        });\n                    }\n                },\n                error: () => {\n                    list.html(`\n                        <li class=\"list-group-item text-danger d-flex flex-column align-items-center\">\n                            <span>Failed to load chats</span>\n                            <button id=\"reload-chat-history\" class=\"btn btn-outline-primary btn-sm mt-2\">Reload</button>\n                        </li>\n                    `);\n                    $('#reload-chat-history').on('click', () => this.loadChatHistory());\n                }\n            });\n        },\n\n        /**\n         * Load a specific chat's messages, highlight the selected item\n         */\n        loadChatMessages: function (chatId, listItem) {\n            console.log('loadChatMessages', chatId, listItem);\n            this.currentChatId = chatId;\n            $('#chat-history-list li').removeClass('active');\n            listItem.addClass('active');\n            $('#chat-container').empty();\n            this.clearMCQ(); // Clear and hide MCQ container when loading different chat\n            this.showLoading();\n\n            this.ajaxWithAuth({\n                url: `https://ai-backend.stagingwithswift.com/api/chat/${chatId}/messages`,\n                method: 'GET',\n                success: (response) => {\n                    this.hideLoading();\n                    console.log(response);\n                    \n                    // Check for credit limit information in response and update button state\n                    if (response.credit_data && response.credit_data.summary) {\n                        this.updateSubscriptionDataFromCreditResponse(response.credit_data);\n                    }\n                    \n                    // Always check current subscription status and update button state\n                    const authStatus = AuthUtils.getAuthStatus();\n                    console.log('[loadChatMessages] Checking credit limit status:', authStatus);\n                    if (authStatus && authStatus.subscription) {\n                        console.log('[loadChatMessages] Subscription data:', authStatus.subscription);\n                        this.checkAndShowCreditLimitWarning(authStatus.subscription);\n                    }\n                    \n                    // Render chat messages with message IDs, filtering out SQL-tagged messages and passing timestamp\n                    response.messages.forEach((msg, idx) => {\n                        if (msg.tag === 'sql') {\n                            return;\n                        }\n                        \n                        // Check if this is an MCQ message followed by a user answer\n                        if (msg.sender_type === 'ai' && msg.tag === 'mcq') {\n                            // Look for the next user message as the selected answer\n                            const nextMsg = response.messages[idx + 1];\n                            const selectedAnswer = (nextMsg && nextMsg.sender_type === 'user') ? nextMsg.body : null;\n                            \n                            // Extract MCQ data and render with selected answer\n                            const mcqData = this.extractMCQFromText(msg.body);\n                            if (mcqData && mcqData.questions.length > 0) {\n                                mcqData.selectedAnswer = selectedAnswer;\n                                const mcqHtml = this.renderMCQHistory(mcqData.questions, selectedAnswer);\n                                \n                                // Add as AI message with MCQ HTML\n                                const template = document.getElementById('message-template');\n                                const frag = template.content.cloneNode(true);\n                                const messageEl = frag.querySelector('.message');\n                                messageEl.classList.add('ai-message');\n                                messageEl.setAttribute('data-message-id', msg.id);\n                                frag.querySelector('.message-text').innerHTML = mcqHtml;\n                                frag.querySelector('.message-time').textContent = this.formatTimestamp(msg.timestamp);\n                                $('#chat-container').append(frag);\n                                return; // Skip the normal addMessage call\n                            }\n                        }\n                        \n                        // Skip rendering the user's MCQ answer separately if it was already shown in the MCQ\n                        if (msg.sender_type === 'user' && idx > 0) {\n                            const prevMsg = response.messages[idx - 1];\n                            if (prevMsg && prevMsg.sender_type === 'ai' && prevMsg.tag === 'mcq') {\n                                // This is the MCQ answer, already rendered in the MCQ view above\n                                return;\n                            }\n                        }\n                        \n                        this.addMessage(msg.body, msg.sender_type, false, null, msg.id, msg.timestamp);\n                    });\n                    this.scrollToBottom();\n                    // After messages, insert report links from response\n                    if (response.reports && response.reports.length) {\n                        response.reports.forEach(report => {\n                            this.insertReportLinkInChat(report);\n                        });\n                    }\n                    // If last message was an MCQ, enqueue and render MCQ view\n                    if (response.messages.length > 0) {\n                        const lastMsg = response.messages[response.messages.length - 1];\n                        if (lastMsg.tag === 'mcq') {\n                            // Extract JSON objects from the message body\n                            const jsonMatches = lastMsg.body.match(/\\{[\\s\\S]*?\\}/g) || [];\n                            const questions = [];\n                            jsonMatches.forEach(jsonStr => {\n                                try {\n                                    const obj = JSON.parse(jsonStr);\n                                    if (obj.type === 'mcq' && Array.isArray(obj.options)) {\n                                        questions.push(obj);\n                                    }\n                                } catch (e) {}\n                            });\n                            if (questions.length) {\n                                this.enqueueMCQs(questions);\n                            }\n                        }\n                    }\n                },\n                error: () => {\n                    this.hideLoading();\n                    this.showError('Could not load conversation.');\n                }\n            });\n        },\n\n        /**\n         * Insert a report link into the chat after the corresponding message\n         */\n        insertReportLinkInChat: function(report) {\n            const $msg = $(`#chat-container .message[data-message-id=\"${report.message_after_id}\"]`);\n            if (!$msg.length) return;\n            // Build report link message\n            const linkHtml = `\n                <div class=\"message ai-message\">\n                  <div class=\"message-content\">\n                    <div class=\"message-text\">\n                      <a href=\"javascript:void(0)\" class=\"report-link\" data-report-slug=\"${report.slug}\" \n                         style=\"color: #007bff; text-decoration: none; padding:4px 8px; border:1px solid #dee2e6; border-radius:4px; background:#f8f9fa; display:inline-block; transition:all 0.2s;\">\n                        ðŸ“Š ${report.description}\n                      </a>\n                    </div>\n                    <div class=\"message-time small text-muted\">${new Date(report.created_at).toLocaleTimeString()}</div>\n                  </div>\n                </div>\n            `;\n            const $linkMsg = $(linkHtml);\n            // Bind click and hover\n            const self = this;\n            $linkMsg.find('.report-link')\n                .on('click', function() {\n                    const slug = $(this).data('report-slug');\n                    self.openReportFromLink(slug);\n                })\n                .on('mouseenter', function() {\n                    $(this).css({ 'background-color':'#e9ecef', 'border-color':'#adb5bd', 'transform':'translateY(-1px)' });\n                })\n                .on('mouseleave', function() {\n                    $(this).css({ 'background-color':'#f8f9fa', 'border-color':'#dee2e6', 'transform':'translateY(0)' });\n                });\n            // Insert after message\n            $msg.after($linkMsg);\n        },\n\n        sendMessage: function () {\n            if (this.currentMCQ) {\n                // ignore text input while MCQ active\n                return;\n            }\n            \n            // Prevent double sending\n            if (this.isSending) {\n                return;\n            }\n            \n            const input = $('#message-input');\n            const rawValue = (input.val() || '').trim();\n            console.log('rawValue', rawValue);\n            if (!rawValue) {\n                Swal.fire({ icon: 'error', title: 'Oops...', text: 'Please enter a message' });\n                return;\n            }\n            const message = rawValue.trim();\n            if (!message) {\n                return;\n            }\n\n            this.isSending = true;\n            this.showLoading();\n            const $userMsg = this.addMessage(message, 'user');\n\n            input.val('').trigger('input');\n\n            // Get user information from auth status\n            const authStatus = AuthUtils.getAuthStatus();\n            const userInfo = authStatus?.user || {};\n\n            this.ajaxWithAuth({\n                url: 'https://ai-backend.stagingwithswift.com/api/chat/message',\n                method: 'POST',\n                contentType: 'application/json',\n                data: JSON.stringify({\n                    message: message,\n                    chat_id: this.currentChatId || 0,\n                    user_id: userInfo.id || null,\n                    user_name: userInfo.name || null\n                }),\n                success: (response) => {\n                    this.hideLoading();\n                    this.isSending = false;\n                    if (response.error) {\n                        // Handle specific error types\n                        if (response.error_type === 'credit_limit') {\n                            this.handleCreditLimitError(response.message, response.credit_data);\n                        } else if (response.error_type === 'timeout') {\n                            this.handleTimeoutError(response.message);\n                        } else {\n                        // Display backend error as chat bubble\n                        this.addMessage(response.message, 'error');\n                        // Show resend icon on the specific user message that failed\n                        this.showResendIconOnMessage($userMsg, message);\n                        }\n                        return;\n                    }\n                    // Remove any existing resend icons on success (clean up from previous failures)\n                    $('.failed-reload-icon').remove();\n                    // update chat_id on first message\n                    if (!this.currentChatId && response.chat_id) {\n                        this.currentChatId = response.chat_id;\n                        this.addChatToChatHistory(response.chat_id, message);\n                    }\n                    \n                    // Handle response based on type\n                    this.handleResponse(response);\n                    \n                    // Refresh subscription info to update credit usage (reduced delay for faster updates)\n                    // setTimeout(() => {\n                        this.refreshSubscriptionInfo();\n                    // }, 500);\n                },\n                error: (err) => {\n                    this.hideLoading();\n                    this.isSending = false;\n                    if (err.status === 401) {\n                        AuthUtils.clearAuthData();\n                        this.showAuthenticationError();\n                    } else {\n                        // Show resend icon on the specific user message that failed\n                        this.showResendIconOnMessage($userMsg, message);\n                        this.addMessage('Network error occurred. Please try again.', 'error');\n                        return;\n                    }\n                }\n            });\n        },\n\n        updateSendMessageandCreateNewChatButton: function() {\n            console.log('[updateSendMessageandCreateNewChatButton] isCreditLimitExceeded:', this.isCreditLimitExceeded);\n            if (this.isCreditLimitExceeded) {\n                console.log('[updateSendMessageandCreateNewChatButton] Disabling send button and create new chat button');\n                $('#send-button').prop('disabled', true);\n                $('#create-new-chat').prop('disabled', true);\n            } else {\n                console.log('[updateSendMessageandCreateNewChatButton] Enabling send button and create new chat button');\n                $('#send-button').prop('disabled', false);\n                $('#create-new-chat').prop('disabled', false);\n            }\n        },\n\n        createNewChat: function () {\n            // if (this.currentChatId == 0) {\n            //     Swal.fire({\n            //         icon: 'error',\n            //         title: 'Oops...',\n            //         text: 'No chat in progress, please start a new chat',\n            //     });\n            //     return;\n            // } else {\n            console.log('createNewChat', this.currentChatId);\n            this.currentChatId = 0;\n            $('#chat-history-list li').removeClass('active');\n            $('#chat-container').empty();\n            this.clearMCQ(); // Clear and hide MCQ container\n            // }\n        },\n\n        addChatToChatHistory(chatId, firstMessage) {\n            const list = $('#chat-history-list');\n            \n            // Remove \"No chat history yet\" placeholder if it exists\n            list.find('li:contains(\"No chat history yet\")').remove();\n            \n            const date = new Date().toLocaleString();\n            const item = $(\n                `<li class=\"list-group-item d-flex justify-content-between align-items-start chat-history-item\" data-chat-id=\"${chatId}\">\n                    <div>\n                        <small class=\"text-muted\">${date}</small><br>\n                        ${firstMessage}\n                    </div>\n                </li>`\n            );\n            list.prepend(item);\n            item.on('click', (e) => {\n                const li = $(e.currentTarget);\n                const chatId = li.data('chat-id');\n                this.loadChatMessages(chatId, li);\n            });\n        },\n\n        initializeCharts: function () {\n            // Initialize with empty chart\n            const container = $('#chart-container');\n            const canvas = $('<canvas></canvas>');\n            container.append(canvas);\n\n            new Chart(canvas[0], {\n                type: 'bar',\n                data: {\n                    labels: [],\n                    datasets: []\n                },\n                options: {\n                    responsive: true,\n                    maintainAspectRatio: false\n                }\n            });\n        },\n\n        setUserName: function (user) {\n            let userName = \"User\";\n            if (typeof user === 'string') {\n                userName = user;\n            } else if (user && user.name) {\n                userName = user.name;\n            } else if (user && user.admin_name) {\n                userName = user.admin_name;\n            }\n            \n            // Update the card title with the user's name\n            $(\".card-title\").each(function () {\n                if ($(this).text().includes('AI Report Assistant')) {\n                    $(this).text(userName + ': AI Report Assistant');\n                }\n            });\n        },\n\n        /**\n         * Check if credit usage exceeds the limit\n         */\n        isCreditExceeded: function(used, limit) {\n            if (limit === 0 || limit === 'âˆž' || limit === null || limit === undefined) {\n                return false;\n            }\n            return used >= limit;\n        },\n\n        /**\n         * Check if user has exceeded credit limits and show persistent warning\n         */\n        checkAndShowCreditLimitWarning: function(subscription) {\n            console.log('[checkAndShowCreditLimitWarning] Checking subscription:', subscription);\n            \n            // Check if any credit type is exceeded\n            const basicExceeded = this.isCreditExceeded(\n                subscription.basic_credits_used_this_month || 0, \n                subscription.plan_basic_credits_limit || 0\n            );\n            const premiumExceeded = this.isCreditExceeded(\n                subscription.premium_credits_used_this_month || 0, \n                subscription.plan_premium_credits_limit || 0\n            );\n            const totalExceeded = this.isCreditExceeded(\n                subscription.ai_credits_used_this_month || 0, \n                subscription.plan_ai_credits_limit || 0\n            );\n            \n            console.log('[checkAndShowCreditLimitWarning] Credit status:', {\n                basicExceeded,\n                premiumExceeded, \n                totalExceeded,\n                basicUsed: subscription.basic_credits_used_this_month || 0,\n                basicLimit: subscription.plan_basic_credits_limit || 0,\n                premiumUsed: subscription.premium_credits_used_this_month || 0,\n                premiumLimit: subscription.plan_premium_credits_limit || 0,\n                totalUsed: subscription.ai_credits_used_this_month || 0,\n                totalLimit: subscription.plan_ai_credits_limit || 0\n            });\n            \n            if (basicExceeded || premiumExceeded || totalExceeded) {\n                console.log('[checkAndShowCreditLimitWarning] Credit limit exceeded, disabling send button');\n                const message = \"You've used all your AI credits for this month. Your credits will reset on the 1st of next month. Consider upgrading your plan for more credits.\";\n                this.showPersistentCreditLimitMessage(message);\n                // set global variable to true\n                this.isCreditLimitExceeded = true;\n                this.updateSendMessageandCreateNewChatButton();\n            }else{\n                console.log('[checkAndShowCreditLimitWarning] Credit limit not exceeded, enabling send button');\n                this.isCreditLimitExceeded = false;\n                this.updateSendMessageandCreateNewChatButton();\n            }\n        },\n\n        updateSubscriptionInfo: async function() {\n            const self = this;\n            \n            // First, fetch latest subscription data from the server (like wizard does)\n            try {\n                console.log('[AI Assistant] Fetching latest subscription status...');\n                const response = await fetch(`${M.cfg.wwwroot}/report/adeptus_insights/ajax/check_subscription_status.php?t=${Date.now()}`, {\n                    method: 'GET',\n                    headers: {\n                        'Content-Type': 'application/json',\n                        'Cache-Control': 'no-cache'\n                    }\n                });\n\n                const data = await response.json();\n                console.log('[AI Assistant] Latest subscription status response:', data);\n                \n                // Log exactly what fields we're receiving for debugging\n                if (data.success && data.data) {\n                    console.log('[AI Assistant] ===== SUBSCRIPTION DATA BREAKDOWN =====');\n                    console.log('[AI Assistant] Plan Name:', data.data.plan_name);\n                    console.log('[AI Assistant] Status:', data.data.status);\n                    console.log('[AI Assistant] Credit Type:', data.data.credit_type);\n                    console.log('[AI Assistant] Reports Generated:', data.data.reports_generated_this_month);\n                    console.log('[AI Assistant] Reports Limit:', data.data.plan_exports_limit);\n                    console.log('[AI Assistant] AI Credits Used:', data.data.total_credits_used_this_month);\n                    console.log('[AI Assistant] AI Credits Limit:', data.data.plan_total_credits_limit);\n                    console.log('[AI Assistant] Exports Used:', data.data.exports_used);\n                    console.log('[AI Assistant] Exports Remaining:', data.data.exports_remaining);\n                    console.log('[AI Assistant] ========================================');\n                    \n                    // Update AuthUtils with fresh data\n                    const authStatus = AuthUtils.getAuthStatus() || {};\n                    authStatus.subscription = data.data;\n                    // Store updated auth status\n                    if (typeof AuthUtils.updateSubscription === 'function') {\n                        AuthUtils.updateSubscription(data.data);\n                    }\n                }\n            } catch (error) {\n                console.error('[AI Assistant] Error fetching latest subscription status:', error);\n            }\n            \n            // Get subscription info from auth status (now updated with fresh data)\n            const authStatus = AuthUtils.getAuthStatus();\n            \n            console.log('[AI Assistant] Updating subscription info with auth status:', authStatus);\n            \n            if (authStatus && authStatus.subscription) {\n                const subscription = authStatus.subscription;\n                \n                // Check if user has exceeded credit limits and show persistent message\n                this.checkAndShowCreditLimitWarning(subscription);\n                \n                // Remove existing assistant header to prevent duplicates\n                $('.assistant-header').remove();\n                \n                // Create or update subscription info display\n                let subscriptionHtml = `\n                    <div class=\"assistant-header\">\n                        <div class=\"subscription-header-content\">\n                            <h6 class=\"subscription-title\">\n                                <i class=\"fa fa-chart-line me-1 subscription-icon\"></i> Subscription Status <button class=\"btn btn-outline-secondary btn-sm\" id=\"refresh-subscription-btn\" title=\"Refresh subscription data\">\n                                <i class=\"fa fa-refresh\"></i></button>\n                            </h6>\n                            \n                            </button>\n                        <div class=\"row\">\n                            <div class=\"col-md-6\">\n                                <strong>Plan:</strong> ${subscription.plan_name || 'Unknown'}<br>\n                                <strong>Status:</strong> <span class=\"badge bg-${subscription.status === 'active' ? 'success' : 'warning'}\">${subscription.status || 'Unknown'}</span>\n                            </div>\n                            <div class=\"col-md-6\">\n                                <strong>Reports:</strong> ${subscription.reports_generated_this_month || 0}/${subscription.plan_exports_limit || 'âˆž'}<br>\n                                <strong>AI Credits (${subscription.credit_type || 'basic'}):</strong> <span class=\"total-credits-counter ${this.isCreditExceeded(subscription.total_credits_used_this_month || 0, subscription.plan_total_credits_limit || 0) ? 'text-danger' : ''}\">${subscription.total_credits_used_this_month || 0}</span>/${subscription.plan_total_credits_limit || 'âˆž'}\n                            </div>\n                        </div>\n                        </div>\n                        \n                        <div class=\"row mt-2\" style=\"display: none;\">\n                            <div class=\"col-md-6\">\n                                <div class=\"mb-2\">\n                                    <small class=\"text-muted\">Premium Credits</small>\n                                    <div class=\"progress mb-1\" style=\"height: 6px;\">\n                                        <div class=\"progress-bar bg-primary\" role=\"progressbar\" \n                                             style=\"width: ${this.calculateUsagePercentage(subscription.premium_credits_used_this_month || 0, subscription.plan_premium_credits_limit || 1)}%\">\n                            </div>\n                                    </div>\n                                </div>\n                            </div>\n                            <div class=\"col-md-6\">\n                                <div class=\"mb-2\">\n                                    <small class=\"text-muted\">Basic Credits</small>\n                                    <div class=\"progress mb-1\" style=\"height: 6px;\">\n                                        <div class=\"progress-bar bg-success\" role=\"progressbar\" \n                                             style=\"width: ${this.calculateUsagePercentage(subscription.basic_credits_used_this_month || 0, subscription.plan_basic_credits_limit || 1)}%\">\n                                        </div>\n                                    </div>\n                                </div>\n                            </div>\n                        </div>\n                        <div class=\"assistant-header-actions\">\n                            <a style=\"margin: 0 20px 17px 0\" href=\"javascript:void(0)\" onclick=\"window.assistant.showCreditUsageModal()\" class=\"btn btn-primary diagnostics-btn\">\n                                <i class=\"fa fa-stethoscope\"></i> View Usage\n                            </a>\n                        </div>\n                    </div>\n                `;\n                \n                let assistantHtml = `\n                     <div class=\"assistant-header\">\n                        <div class=\"assistant-header-content\">\n                            <h1 class=\"assistant-title\">\n                                <i class=\"fa fa-bolt wizard-icon\"></i>\n                                Adeptus Insights: AI Assistant\n                            </h1>\n                            <p class=\"wizard-subtitle\">Generate the reports you need by speaking to our AI assistant.</p>\n                        </div>\n                        <div class=\"wizard-header-section\">\n                            <a style=\"margin-bottom: 17px;\" href=\"/report/adeptus_insights/index.php\" class=\"btn btn-primary\">\n                                    <i class=\"fa fa-arrow-left\"></i> Back to Dashboard\n                                </a>\n                        </div>\n                    </div>\n                `;\n                \n\n                // Insert header info above the tabs (before the nav-tabs)\n                const tabNav = $('.tab-nav');\n                if (tabNav.length && !$('.subscription-info').length) {\n                    tabNav.before(assistantHtml);\n                } else if ($('.subscription-info').length) {\n                    $('.subscription-info').replaceWith(assistantHtml);\n                } else {\n                    // Fallback: insert after the main title if nav-tabs not found\n                    const mainTitle = $('h1, h2, .page-title').first();\n                    if (mainTitle.length) {\n                        mainTitle.after(assistantHtml);\n                    }\n                }\n\n\n                // Find the parent container that holds both tab panels\nconst tabContainer = $('#assistant-panel, #reports-panel').closest('.tab-content, .tab-pane').parent();\n// Or if they share a specific parent container:\n// const tabContainer = $('#assistant-panel').parent();\n\n// Remove existing subscription info\n$('.subscription-info').remove();\n\nif (tabContainer.length) {\n    // Insert after the entire tab container\n    tabContainer.after(subscriptionHtml);\n} else {\n    // Fallback\n    const mainTitle = $('h1, h2, .page-title').first();\n    if (mainTitle.length) {\n        mainTitle.after(subscriptionHtml);\n    }\n}\n                \n                // Bind refresh button event\n                const self = this;\n                $('#refresh-subscription-btn').off('click').on('click', function() {\n                    const $btn = $(this);\n                    const $icon = $btn.find('i');\n                    \n                    // Show loading state\n                    $icon.removeClass('fa-refresh').addClass('fa-spinner fa-spin');\n                    $btn.prop('disabled', true);\n                    \n                    // Refresh subscription info\n                    self.refreshSubscriptionInfo();\n                    \n                    // Reset button state after refresh\n                    setTimeout(() => {\n                        $icon.removeClass('fa-spinner fa-spin').addClass('fa-refresh');\n                        $btn.prop('disabled', false);\n                    }, 1000);\n                });\n            } else {\n                console.log('[AI Assistant] No subscription data available in auth status');\n                // Remove subscription info if no data available\n                $('.subscription-info').remove();\n            }\n        },\n\n        /**\n         * Transform backend auth data to match frontend expectations\n         */\n        transformBackendAuthData: function(backendData) {\n            if (!backendData) return null;\n            \n            // Get current auth data to preserve existing structure\n            const currentAuthData = window.adeptusAuthData || {};\n            \n            // Transform the data to match the expected frontend structure\n            const transformedData = {\n                ...currentAuthData, // Preserve existing auth data\n                user_authorized: true,\n                has_api_key: true,\n                installation: backendData.installation,\n                subscription: backendData.subscription ? {\n                    ...backendData.subscription,\n                    // Map the usage data to the expected format\n                    premium_credits_used_this_month: backendData.usage ? (backendData.usage.premium_credits_used_this_month || 0) : 0,\n                    basic_credits_used_this_month: backendData.usage ? (backendData.usage.basic_credits_used_this_month || 0) : 0,\n                    ai_credits_used_this_month: backendData.usage ? (backendData.usage.ai_credits_used_this_month || 0) : 0,\n                    reports_generated_this_month: backendData.usage ? (backendData.usage.reports_generated_this_month || 0) : 0,\n                    // Map plan data\n                    plan_name: backendData.plan ? backendData.plan.name : 'Unknown',\n                    plan_premium_credits_limit: backendData.plan ? (backendData.plan.premium_credits_per_month || 0) : 0,\n                    plan_basic_credits_limit: backendData.plan ? (backendData.plan.basic_credits_per_month || 'âˆž') : 'âˆž',\n                    plan_ai_credits_limit: backendData.plan ? (backendData.plan.ai_credits || 0) : 0,\n                    plan_exports_limit: backendData.plan ? (backendData.plan.exports || 'âˆž') : 'âˆž'\n                } : null,\n                plan: backendData.plan,\n                usage: backendData.usage\n            };\n            \n            return transformedData;\n        },\n\n        /**\n         * Refresh subscription info by getting fresh data from backend\n         */\n        refreshSubscriptionInfo: async function() {\n            console.log('[AI Assistant] Refreshing subscription info...');\n            \n            // Show loading state on refresh button\n            const $refreshBtn = $('#refresh-subscription-btn');\n            const $refreshIcon = $refreshBtn.find('i');\n            if ($refreshBtn.length && $refreshIcon.length) {\n                $refreshIcon.removeClass('fa-refresh').addClass('fa-spinner fa-spin');\n                $refreshBtn.prop('disabled', true);\n            }\n            \n            try {\n                // First, get fresh local subscription data (like wizard does)\n                const localResponse = await fetch(`${M.cfg.wwwroot}/report/adeptus_insights/ajax/check_subscription_status.php?t=${Date.now()}`, {\n                    method: 'GET',\n                    headers: {\n                        'Content-Type': 'application/json',\n                        'Cache-Control': 'no-cache'\n                    }\n                });\n\n                const localData = await localResponse.json();\n                console.log('[AI Assistant] Latest local subscription status:', localData);\n\n                if (localData.success && localData.data) {\n                    // Update AuthUtils with fresh data\n                    const authStatus = AuthUtils.getAuthStatus() || {};\n                    authStatus.subscription = localData.data;\n                    \n                    // Also update the global auth data\n                    if (window.adeptusAuthData) {\n                        window.adeptusAuthData.subscription = localData.data;\n                    }\n                }\n                \n                // Then update the display with fresh data\n                await this.updateSubscriptionInfo();\n                \n                console.log('[AI Assistant] Subscription info refreshed successfully');\n                \n                // Show success feedback\n                this.showRefreshSuccessFeedback();\n                \n            } catch (error) {\n                console.error('[AI Assistant] Failed to refresh subscription info:', error);\n                this.showRefreshErrorFeedback();\n            } finally {\n                // Reset button state\n                if ($refreshBtn.length && $refreshIcon.length) {\n                    $refreshIcon.removeClass('fa-spinner fa-spin').addClass('fa-refresh');\n                    $refreshBtn.prop('disabled', false);\n                }\n            }\n        },\n\n        /**\n         * Show success feedback for subscription refresh\n         */\n        showRefreshSuccessFeedback: function() {\n            const notification = $(`\n                <div class=\"refresh-success-notification\" style=\"\n                    position: fixed;\n                    top: 20px;\n                    right: 20px;\n                    background: #28a745;\n                    color: white;\n                    padding: 8px 16px;\n                    border-radius: 4px;\n                    box-shadow: 0 2px 8px rgba(0,0,0,0.15);\n                    z-index: 9999;\n                    font-size: 12px;\n                    opacity: 0;\n                    transform: translateY(-20px);\n                    transition: all 0.3s ease;\n                \">\n                    <i class=\"fa fa-check me-1\"></i>\n                    Usage updated\n                </div>\n            `);\n            \n            $('body').append(notification);\n            \n            // Animate in\n            setTimeout(() => {\n                notification.css({\n                    'opacity': '1',\n                    'transform': 'translateY(0)'\n                });\n            }, 100);\n            \n            // Remove after 2 seconds\n            setTimeout(() => {\n                notification.css({\n                    'opacity': '0',\n                    'transform': 'translateY(-20px)'\n                });\n                setTimeout(() => notification.remove(), 300);\n            }, 2000);\n        },\n\n        /**\n         * Show error feedback for subscription refresh\n         */\n        showRefreshErrorFeedback: function() {\n            const notification = $(`\n                <div class=\"refresh-error-notification\" style=\"\n                    position: fixed;\n                    top: 20px;\n                    right: 20px;\n                    background: #dc3545;\n                    color: white;\n                    padding: 8px 16px;\n                    border-radius: 4px;\n                    box-shadow: 0 2px 8px rgba(0,0,0,0.15);\n                    z-index: 9999;\n                    font-size: 12px;\n                    opacity: 0;\n                    transform: translateY(-20px);\n                    transition: all 0.3s ease;\n                \">\n                    <i class=\"fa fa-exclamation-triangle me-1\"></i>\n                    Failed to update usage\n                </div>\n            `);\n            \n            $('body').append(notification);\n            \n            // Animate in\n            setTimeout(() => {\n                notification.css({\n                    'opacity': '1',\n                    'transform': 'translateY(0)'\n                });\n            }, 100);\n            \n            // Remove after 3 seconds\n            setTimeout(() => {\n                notification.css({\n                    'opacity': '0',\n                    'transform': 'translateY(-20px)'\n                });\n                setTimeout(() => notification.remove(), 300);\n            }, 3000);\n        },\n\n        /**\n         * Calculate usage percentage for progress bar\n         */\n        calculateUsagePercentage: function(used, limit) {\n            if (!limit || limit === 'âˆž' || limit === 0) {\n                return 0;\n            }\n            const percentage = (used / limit) * 100;\n            return Math.min(percentage, 100); // Cap at 100%\n        },\n\n\n\n        ajaxWithAuth: function (options) {\n            // Check authentication before making the request\n            if (!AuthUtils.isAuthenticated()) {\n                this.showAuthenticationError();\n                return Promise.reject(new Error('Authentication required'));\n            }\n\n            // Add authentication headers to the request\n            const authHeaders = AuthUtils.getAuthHeaders();\n            options.headers = { ...options.headers, ...authHeaders };\n\n            // Make the authenticated request\n            return $.ajax(options);\n        },\n\n        validateToken: function () {\n            return AuthUtils.isAuthenticated();\n        },\n\n        resendMessage: function ($msgElem, message) {\n            if (this.isSending) {\n                return;\n            }\n            \n            this.isSending = true;\n            this.showLoading();\n            // Get user information from auth status\n            const authStatus = AuthUtils.getAuthStatus();\n            const userInfo = authStatus?.user || {};\n            \n            this.ajaxWithAuth({\n                url: 'https://ai-backend.stagingwithswift.com/api/chat/message',\n                method: 'POST',\n                contentType: 'application/json',\n                data: JSON.stringify({ \n                    message: message, \n                    chat_id: this.currentChatId || 0,\n                    user_id: userInfo.id || null,\n                    user_name: userInfo.name || null\n                }),\n                success: (response) => {\n                    this.hideLoading();\n                    this.isSending = false;\n                    if (response.error) {\n                        // Handle specific error types\n                        if (response.error_type === 'credit_limit') {\n                            this.handleCreditLimitError(response.message, response.credit_data);\n                        } else {\n                        // Display backend error as chat bubble\n                        this.addMessage(response.message, 'error');\n                        // Show resend icon on the specific message that failed\n                        this.showResendIconOnMessage($msgElem, message);\n                        }\n                        return;\n                    }\n                    // Remove all resend icons on successful resend\n                    $('.failed-reload-icon').remove();\n                    \n                    if (!this.currentChatId && response.chat_id) {\n                        this.currentChatId = response.chat_id;\n                        this.addChatToChatHistory(response.chat_id, message);\n                    }\n                    this.handleResponse(response);\n                },\n                error: (err) => {\n                    this.hideLoading();\n                    this.isSending = false;\n                    if (err.status === 401) {\n                        AuthUtils.clearAuthData();\n                        this.showAuthenticationError();\n                    } else {\n                        // Show resend icon on the specific message that failed\n                        this.showResendIconOnMessage($msgElem, message);\n                        this.addMessage('Network error occurred. Please try again.', 'error');\n                    }\n                }\n            });\n        },\n\n        /**\n         * Push an array of MCQs into our queue and display the first one.\n         * @param {Array} questions  Array of {question: string, options: []}\n         */\n        enqueueMCQs: function(questions) {\n            if (!Array.isArray(questions) || questions.length === 0) {\n                return;\n            }\n            this.mcqQueue = questions.slice(); // copy\n            this.showNextMCQ();\n        },\n\n        /**\n         * Display the next MCQ in the queue, or end MCQ mode if none left.\n         */\n        showNextMCQ: function() {\n            if (this.mcqQueue.length === 0) {\n                return this.clearMCQ();\n            }\n            const next = this.mcqQueue.shift();\n            this.renderMCQ(next.question, next.options);\n        },\n\n        /**\n         * Render a single MCQ question with radio buttons.\n         * @param {string} question\n         * @param {string[]} options\n         */\n        renderMCQ: function(question, options) {\n            this.currentMCQ = true;\n            $('#message-input, #send-button').prop('disabled', true);\n            const c = $('#mcq-container').empty().show();\n            c.append(`<p class=\"mcq-question\"><strong>${question}</strong></p>`);\n            options.forEach((opt, idx) => {\n                const key = String.fromCharCode(65 + idx);\n                c.append(`\n                <div class=\"form-check\">\n                    <input class=\"form-check-input\" type=\"radio\"\n                        name=\"mcq-option\" id=\"mcq-${idx}\"\n                        value=\"${opt}\">\n                    <label class=\"form-check-label\" for=\"mcq-${idx}\">\n                    ${key}. ${opt}\n                    </label>\n                </div>`);\n            });\n            c.append(`<button class=\"btn btn-link\" id=\"mcq-cancel\">Cancel</button>`);\n            // bind selection\n            c.find('input[name=\"mcq-option\"]').on('change', () => {\n                $('#mcq-submit').remove();\n                c.append(`<button id=\"mcq-submit\" class=\"btn btn-primary mt-2\">Submit</button>`);\n                $('#mcq-submit').off('click').on('click', () => {\n                    const selected = c.find('input[name=\"mcq-option\"]:checked').val();\n                    this.sendMCQ(selected);\n                });\n            });\n            // cancel\n            c.find('#mcq-cancel').off('click').on('click', () => {\n                this.mcqQueue = [];\n                this.clearMCQ();\n            });\n        },\n\n        /**\n         * Send the selected MCQ answer to the backend, then show next question if any.\n         */\n        sendMCQ: function(answer) {\n            if (this.isSending) {\n                return;\n            }\n\n            this.showLoading();\n            this.isSending = true;\n            this.clearMCQ();                       // clear current UI\n            const $userMsg = this.addMessage(answer, 'user');      // echo user choice\n            // Get user information from auth status\n            const authStatus = AuthUtils.getAuthStatus();\n            const userInfo = authStatus?.user || {};\n            \n            this.ajaxWithAuth({\n                url: 'https://ai-backend.stagingwithswift.com/api/chat/message',\n                method: 'POST',\n                contentType: 'application/json',\n                data: JSON.stringify({\n                    message: answer,\n                    chat_id: this.currentChatId || 0,\n                    user_id: userInfo.id || null,\n                    user_name: userInfo.name || null\n                }),\n                success: (response) => {\n                    this.hideLoading();\n                    this.isSending = false;\n                    if (response.error) {\n                        // Handle specific error types\n                        if (response.error_type === 'credit_limit') {\n                            this.handleCreditLimitError(response.message);\n                        } else {\n                        this.addMessage(response.message, 'error');\n                        this.showResendIconOnMessage($userMsg, answer);\n                        }\n                        return;\n                    }\n                    // Remove any existing resend icons on success\n                    $('.failed-reload-icon').remove();\n                    // Handle response using the same logic as regular messages\n                    this.handleResponse(response);\n                },\n                error: () => {\n                    this.hideLoading();\n                    this.isSending = false;\n                    this.addMessage('Failed to send choice', 'error');\n                    this.showResendIconOnMessage($userMsg, answer);\n                }\n            });\n        },\n\n        /**\n         * Switch to the reports tab\n         */\n        switchToReportsTab: function() {\n            $('#reports-tab').tab('show');\n            $('#assistant-tab').removeClass('active').attr('aria-selected', 'false');\n            $('#reports-tab').addClass('active').attr('aria-selected', 'true');\n            $('#assistant-panel').removeClass('show active');\n            $('#reports-panel').addClass('show active');\n\n            // Reset view placeholder\n            $('.report-view-title').text('Select a Report');\n            $('.report-view-body').html(\n                '<div class=\"text-center py-4\"><p class=\"text-muted\">Select a report from history to view details here.</p></div>'\n            );\n\n            // Ensure report history table is visible\n            $('#report-history-loader').addClass('d-none');\n            $('#report-history-table-wrapper').removeClass('d-none');\n            // No reload here; use cachedReports\n        },\n\n        /**\n         * Load reports history\n         */\n        loadReportsHistory: function(callback) {\n            $('#report-history-loader').removeClass('d-none');\n            $('#report-history-table-wrapper').addClass('d-none');\n            \n            this.ajaxWithAuth({\n                url: 'https://ai-backend.stagingwithswift.com/api/reports',\n                method: 'GET',\n                success: (response) => {\n                    // Cache reports for reuse\n                    this.cachedReports = response.reports;\n                    this.updateReportsHistory(response.reports);\n                    $('#report-history-loader').addClass('d-none');\n                    $('#report-history-table-wrapper').removeClass('d-none');\n\n                    // Destroy existing DataTable if it exists\n                    if (this.reportsDataTable) {\n                        this.reportsDataTable.destroy();\n                        this.reportsDataTable = null;\n                    }\n                    \n                    // Only initialize DataTable if we have data and table structure is ready\n                    setTimeout(() => {\n                        try {\n                            const tableElement = document.getElementById('reports-history-table');\n                            if (!tableElement) {\n                                console.warn('Table element not found');\n                                return;\n                            }\n                            \n                            const tbody = tableElement.querySelector('tbody');\n                            const thead = tableElement.querySelector('thead');\n                            \n                            // Verify table structure before initializing DataTable\n                            if (thead && tbody && thead.rows.length > 0 && thead.rows[0].cells.length > 0) {\n                                // Check if DataTable is already initialized and destroy it first\n                                if (this.reportsDataTable) {\n                                    this.reportsDataTable.destroy();\n                                    this.reportsDataTable = null;\n                                }\n                                \n                                // Count header and data columns to ensure they match\n                                const headerCells = thead.rows[0].cells.length;\n                                const dataRows = tbody.rows;\n                                let dataCells = 0;\n                                \n                                if (dataRows.length > 0) {\n                                    dataCells = dataRows[0].cells.length;\n                                }\n                                \n                                console.log(`Table structure check - Headers: ${headerCells}, Data: ${dataCells}`);\n                                \n                                if (headerCells === dataCells && headerCells > 0) {\n                                    // Only initialize DataTable if we have actual data rows (not just empty state)\n                                    if (dataRows.length > 0 && !dataRows[0].cells[0].textContent.includes('No reports')) {\n                    this.reportsDataTable = new simpleDatatables.DataTable(\"#reports-history-table\", {\n                        searchable: true,\n                        fixedHeight: false,\n                        perPage: 10\n                    });\n                                        console.log('DataTable initialized successfully');\n                                    } else {\n                                        console.log('Skipping DataTable initialization - no data rows or empty state');\n                                    }\n                                } else {\n                                    console.warn(`Column mismatch - Headers: ${headerCells}, Data: ${dataCells}`);\n                                }\n                            } else {\n                                console.warn('Table structure not ready for DataTable initialization');\n                            }\n                        } catch (error) {\n                            console.error('Error initializing DataTable:', error);\n                            // Fallback: table will still be functional without DataTable features\n                        }\n\n                    if (typeof callback === 'function') {\n                        callback();\n                    }\n                    }, 100); // Small delay to ensure DOM is ready\n                },\n                error: (xhr, status, error) => {\n                    console.error('Failed to load report history:', error);\n                    this.showError('Failed to load report history');\n                    $('#report-history-loader').addClass('d-none');\n                    \n                    // Show error message in table\n                    const tbody = $('#reports-history-table tbody');\n                    tbody.empty();\n                    tbody.append(\n                        `<tr><td colspan=\"3\" class=\"text-center text-danger\">Failed to load reports</td></tr>`\n                    );\n                    $('#report-history-table-wrapper').removeClass('d-none');\n                }\n            });\n        },\n\n        /**\n         * Update the reports history table\n         */\n        updateReportsHistory: function(reports) {\n            const tbody = $('#reports-history-table tbody');\n            const self = this; // capture context\n            tbody.empty();\n            if (!reports || reports.length === 0) {\n                // Check if we also have no chat history\n                const authStatus = AuthUtils.getAuthStatus();\n                const hasChats = authStatus && authStatus.subscription && \n                    authStatus.subscription.reports_generated_this_month > 0;\n                \n                if (!hasChats) {\n                    tbody.append(`\n                        <tr>\n                            <td colspan=\"3\" class=\"text-center text-muted\">\n                                <div class=\"py-4\">\n                                    <i class=\"fa fa-chart-bar fa-2x mb-2\"></i>\n                                    <p class=\"mb-1\">No reports generated yet</p>\n                                    <small>Ask the AI assistant to create reports for you</small>\n                                </div>\n                            </td>\n                        </tr>\n                    `);\n                } else {\n                tbody.append(\n                    `<tr><td colspan=\"3\" class=\"text-center text-muted\">No reports yet</td></tr>`\n                );\n                }\n                return;\n            }\n            reports.forEach(report => {\n                const statusBadge = self.getStatusBadge(report.status);\n                const date = new Date(report.created_at).toLocaleDateString();\n                const row = $(`\n                    <tr class=\"report-row\" data-report-slug=\"${report.slug}\">\n                        <td>${report.description}</td>\n                        <td>${date}</td>\n                        <td>${statusBadge}</td>\n                    </tr>`\n                );\n                row.on('click', function() { // use function() to get row as 'this', use 'self' for assistant\n                    // Always show loading spinner in carousel container\n                    const reportsView = $('#reports-panel .col-md-8 .card-body');\n                    reportsView.find('.report-display-wrapper').html('<div class=\"w-100 d-flex justify-content-center align-items-center\" style=\"min-height:200px\"><div class=\"spinner-border text-primary\" role=\"status\"></div></div>');\n                    // Check if cachedReports exists and has the report WITH DATA\n                    console.log('cachedReports', self.cachedReports);\n                    console.log('report', report);\n                    if (Array.isArray(self.cachedReports) && self.cachedReports.length > 0) {\n                        const rep = self.cachedReports.find(r => r.slug === report.slug);\n                        if (rep) {\n                            console.log('Found in cache - rep:', rep);\n                            console.log('Has data?', rep.data ? 'YES' : 'NO');\n                            console.log('Data length:', rep.data ? rep.data.length : 'N/A');\n                            \n                            // Check if cached report has data, if not fetch it\n                            if (rep.data && Array.isArray(rep.data) && rep.data.length > 0) {\n                                console.log('Using cached data');\n                                setTimeout(() => { self.updateReportsView(rep, rep.data); }, 300); // simulate async for spinner UX\n                            } else {\n                                console.log('Cached report has no data, fetching from API');\n                                self.fetchAndDisplayReport(report.slug, row);\n                            }\n                        } else {\n                            console.log('Report not in cache, fetching from API');\n                            self.fetchAndDisplayReport(report.slug, row);\n                        }\n                    } else {\n                        console.log('No cached reports, fetching from API');\n                        self.fetchAndDisplayReport(report.slug, row);\n                    }\n                    // Highlight the current report in the history\n                    $('.report-row').removeClass('table-primary');\n                    row.addClass('table-primary');\n                });\n                tbody.append(row);\n            });\n        },\n\n        // Helper to fetch report from API, update cache, and display\n        fetchAndDisplayReport: function(reportSlug, rowElem) {\n            console.log('fetchAndDisplayReport', reportSlug, rowElem);\n            const reportsView = $('#reports-panel .col-md-8 .card-body');\n            \n            // Ensure loading spinner is visible\n            reportsView.html('<div class=\"report-display-wrapper w-100\"><div class=\"w-100 d-flex justify-content-center align-items-center\" style=\"min-height:200px\"><div class=\"spinner-border text-primary\" role=\"status\"></div></div></div>');\n            \n            this.ajaxWithAuth({\n                url: `https://ai-backend.stagingwithswift.com/api/reports/${reportSlug}`,\n                method: 'GET',\n                success: (response) => {\n                    console.log('fetchAndDisplayReport success - full response:', response);\n                    console.log('fetchAndDisplayReport - report:', response.report);\n                    console.log('fetchAndDisplayReport - data:', response.data);\n                    console.log('fetchAndDisplayReport - data type:', typeof response.data);\n                    console.log('fetchAndDisplayReport - data is array:', Array.isArray(response.data));\n                    console.log('fetchAndDisplayReport - data length:', response.data ? response.data.length : 'null/undefined');\n                    \n                    // Add or update in cache\n                    if (!Array.isArray(this.cachedReports)) this.cachedReports = [];\n                    let idx = this.cachedReports.findIndex(r => r.slug === reportSlug);\n                    if (idx > -1) {\n                        this.cachedReports[idx] = Object.assign({}, response.report, { data: response.data });\n                    } else {\n                        this.cachedReports.push(Object.assign({}, response.report, { data: response.data }));\n                    }\n                    \n                    // Check if data exists before displaying\n                    if (!response.data || (Array.isArray(response.data) && response.data.length === 0)) {\n                        console.warn('No data returned from backend for report:', reportSlug);\n                        reportsView.find('.report-display-wrapper').html('<div class=\"w-100 text-center text-warning py-4\"><i class=\"fa fa-exclamation-triangle\"></i> Report completed but no data is available. The report may need to be re-executed.</div>');\n                        return;\n                    }\n                    \n                    console.log('Calling updateReportsView with:', response.report, response.data);\n                    this.updateReportsView(response.report, response.data);\n                    \n                    // Highlight the current report in the history\n                    $('.report-row').removeClass('table-primary');\n                    if (rowElem) rowElem.addClass('table-primary');\n                },\n                error: (xhr, status, error) => {\n                    console.error('fetchAndDisplayReport error:', reportSlug, status, error);\n                    console.error('XHR:', xhr);\n                    reportsView.find('.report-display-wrapper').html('<div class=\"w-100 text-center text-danger py-4\">Failed to load report. Please try again.</div>');\n                }\n            });\n        },\n\n        /**\n         * Display the current report in the reports view\n         */\n        displayCurrentReport: function(report) {\n            // Update the reports view with the current report\n            this.updateReportsView(report);\n            \n            // Highlight the current report in the history\n            $(`.report-row[data-report-slug=\"${report.slug}\"]`).addClass('table-primary');\n        },\n\n        /**\n         * Display a specific report\n         */\n        displayReport: function(reportSlug) {\n            const rep = this.cachedReports.find(r => r.slug === reportSlug);\n            if (rep) {\n                this.updateReportsView(rep, rep.data);\n                // Highlight the current report in the history\n                $('.report-row').removeClass('table-primary');\n                $(`.report-row[data-report-slug=\"${reportSlug}\"]`).addClass('table-primary');\n            }\n        },\n\n        /**\n         * Update the reports view with report data\n         */\n        updateReportsView: function(report, data = null) {\n            const self = this;\n            // Always destroy any existing chart/graph instances to prevent data mixup\n            if (self.reportChartInstance) {\n                self.reportChartInstance.destroy();\n                self.reportChartInstance = null;\n            }\n            if (self.reportGraphInstance) {\n                self.reportGraphInstance.destroy();\n                self.reportGraphInstance = null;\n            }\n            // Destroy any existing VTE instance\n            if (self._vteController && typeof self._vteController.destroy === 'function') {\n                try {\n                    self._vteController.destroy();\n                } catch (e) {\n                    console.error('Error destroying VTE controller:', e);\n                }\n                self._vteController = null;\n            }\n            const reportsView = $('#reports-panel .col-md-8 .card-body');\n            // Inject custom styles for icon button animation, highlight, and fade-in\n            if ($('#display-type-icon-style').length === 0) {\n                $('head').append(`\n                    <style id=\"display-type-icon-style\">\n                        .btn-icon {\n                            transition: transform 0.15s cubic-bezier(.4,2,.6,1), background 0.2s, border 0.2s;\n                            background: #f8f9fa;\n                            border: 1.5px solid #e0e0e0;\n                            color: #333;\n                        }\n                        .btn-icon:hover {\n                            transform: scale(1.15);\n                            background: #e9ecef;\n                            border-color: #b3d7ff;\n                            color: #007bff;\n                            z-index: 2;\n                        }\n                        .btn-icon.active, .btn-icon:focus {\n                            background: #e3f0ff;\n                            border-color: #007bff;\n                            color: #007bff;\n                            box-shadow: 0 0 0 2px #b3d7ff33;\n                        }\n                        .display-fade {\n                            opacity: 0;\n                            transition: opacity 0.25s;\n                        }\n                        .display-fade.display-fade-in {\n                            opacity: 1;\n                        }\n                    </style>\n                `);\n            }\n            // Set the report description as the title\n            $('.report-view-title').text(report.description);\n            if (!Array.isArray(data) || data.length === 0) {\n                reportsView.find('.report-display-wrapper').html('<div class=\"w-100 text-center text-muted py-4\">No data available for this report.</div>');\n                return;\n            }\n            const types = ['table', 'chart', 'graph'];\n            const typeLabels = { table: 'Table', chart: 'Chart', graph: 'Graph' };\n            const typeIcons = {\n                table: '<i class=\"fa fa-table\"></i>',\n                chart: '<i class=\"fa fa-bar-chart\"></i>',\n                graph: '<i class=\"fa fa-line-chart\"></i>'\n            };\n            // Controls row: export buttons (left), display icons (right)\n            let controlsHtml = `\n                <div class=\"d-flex justify-content-between align-items-center mb-3 flex-wrap\">\n                    <div class=\"action-buttons d-flex gap-2\">\n                        <button class=\"btn btn-outline-secondary btn-sm export-csv-btn mr-10\">\n                            <i class=\"fa fa-download me-1\"></i>Export CSV\n                        </button>\n                        <button class=\"btn btn-outline-secondary btn-sm export-json-btn\">\n                            <i class=\"fa fa-code me-1\"></i>Export JSON\n                        </button>\n                    </div>\n                    <div class=\"display-type-icons d-flex gap-2 align-items-center\">\n            `;\n            types.forEach(type => {\n                const active = report.display_type === type ? ' active' : '';\n                controlsHtml += `<button class=\"btn btn-icon mr-10 mb-0${active}\" data-type=\"${type}\" title=\"${typeLabels[type]} View\" style=\"font-size:1.5rem; width:40px; height:40px; border-radius:50%; display:flex; align-items:center; justify-content:center; padding:0;\">${typeIcons[type]}</button>`;\n            });\n            controlsHtml += '</div></div>';\n            // Display containers\n            let displayHtml = '<div class=\"report-display-area w-100 position-relative\" style=\"min-height:300px;\">';\n            types.forEach(type => {\n                const isActive = report.display_type === type;\n                let content = '';\n                if (type === 'table') {\n                    content = this.renderReportData(data);\n                } else if (type === 'chart') {\n                    content = '<div class=\"chart-container\"><canvas id=\"reportChart\"></canvas></div>';\n                } else if (type === 'graph') {\n                    content = '<div class=\"chart-container\"><canvas id=\"reportGraph\"></canvas></div>';\n                }\n                displayHtml += `<div class=\"display-fade${isActive ? ' display-fade-in' : ''}\" data-type=\"${type}\" style=\"position:absolute; top:0; left:0; width:100%;${isActive ? 'z-index:1;' : 'z-index:0; pointer-events:none;'}\">${content}</div>`;\n            });\n            displayHtml += '</div>';\n            reportsView.html(`\n                ${controlsHtml}\n                <div class=\"report-display-wrapper w-100 position-relative\">\n                    ${displayHtml}\n                </div>\n            `);\n            \n            // Initialize Vanilla Table Enhancer if table is active\n            if (this._pendingTableId && report.display_type === 'table') {\n                setTimeout(() => {\n                    const tableElement = document.getElementById(this._pendingTableId);\n                    if (tableElement && window.VTE) {\n                        console.log('Initializing Vanilla Table Enhancer on table:', this._pendingTableId);\n                        try {\n                            this._vteController = window.VTE.enhance('#' + this._pendingTableId, {\n                                perPage: 10,\n                                perPageOptions: [10, 25, 50, 100],\n                                labels: {\n                                    search: 'Search',\n                                    rows: 'Rows per page',\n                                    info: (start, end, total) => `Showing ${start}â€“${end} of ${total} entries`,\n                                    noData: 'No matching records found'\n                                }\n                            })[0];\n                        } catch (e) {\n                            console.error('Error initializing Vanilla Table Enhancer:', e);\n                        }\n                    }\n                    this._pendingTableId = null;\n                }, 100);\n            }\n            \n            // Immediately initialize chart/graph if default is not table\n            const initialType = report.display_type;\n            if (initialType === 'chart') {\n                setTimeout(() => {\n                    const chartEl = document.getElementById('reportChart');\n                    if (chartEl) {\n                        const headers = Object.keys(data[0] || {});\n                        // Find first string column for labels, first numeric for values (but skip id columns for values)\n                        let labelKey = headers.find(h => typeof data[0][h] === 'string') || headers[0];\n                        let valueKey = headers.find(h => typeof data[0][h] === 'number' && !/^([a-zA-Z0-9]*_)?id$/.test(h))\n                            || headers.find(h => typeof data[0][h] === 'number' && !h.endsWith('_id'))\n                            || headers.find(h => typeof data[0][h] === 'number')\n                            || headers[1];\n                        const labels = data.map(r => r[labelKey]);\n                        const values = data.map(r => r[valueKey]);\n                        if (self.reportChartInstance) { self.reportChartInstance.destroy(); }\n                        self.reportChartInstance = new Chart(chartEl.getContext('2d'), {\n                            type: 'bar',\n                            data: { labels: labels, datasets: [{ label: valueKey.replace(/_/g, ' ').replace(/\\b\\w/g, l => l.toUpperCase()), data: values, backgroundColor: 'rgba(0,123,255,0.5)', borderColor: 'rgba(0,123,255,1)', borderWidth: 1 }] },\n                            options: { responsive: true, maintainAspectRatio: false }\n                        });\n                    }\n                }, 100);\n            } else if (initialType === 'graph') {\n                setTimeout(() => {\n                    const graphEl = document.getElementById('reportGraph');\n                    if (graphEl) {\n                        const headers = Object.keys(data[0] || {});\n                        // Find first string column for labels, first numeric for values (but skip id columns for values)\n                        let labelKey = headers.find(h => typeof data[0][h] === 'string') || headers[0];\n                        let valueKey = headers.find(h => typeof data[0][h] === 'number' && !/^([a-zA-Z0-9]*_)?id$/.test(h))\n                            || headers.find(h => typeof data[0][h] === 'number' && !h.endsWith('_id'))\n                            || headers.find(h => typeof data[0][h] === 'number')\n                            || headers[1];\n                        const labels = data.map(r => r[labelKey]);\n                        const values = data.map(r => r[valueKey]);\n                        if (self.reportGraphInstance) { self.reportGraphInstance.destroy(); }\n                        self.reportGraphInstance = new Chart(graphEl.getContext('2d'), {\n                            type: 'line',\n                            data: { labels: labels, datasets: [{ label: valueKey.replace(/_/g, ' ').replace(/\\b\\w/g, l => l.toUpperCase()), data: values, backgroundColor: 'rgba(40,167,69,0.5)', borderColor: 'rgba(40,167,69,1)', borderWidth: 1 }] },\n                            options: { responsive: true, maintainAspectRatio: false }\n                        });\n                    }\n                }, 100);\n            }\n            // Animate display change on icon click\n            const iconButtons = reportsView.find('.display-type-icons .btn-icon');\n            iconButtons.on('click', function() {\n                const type = $(this).data('type');\n                iconButtons.removeClass('active');\n                $(this).addClass('active');\n                // Animate fade out/in\n                types.forEach(t => {\n                    const $el = reportsView.find(`.display-fade[data-type=\"${t}\"]`);\n                    if (t === type) {\n                        $el.addClass('display-fade-in').css({ 'z-index': 1, 'pointer-events': 'auto' });\n                    } else {\n                        $el.removeClass('display-fade-in').css({ 'z-index': 0, 'pointer-events': 'none' });\n                    }\n                });\n                \n                // If switching to table view and VTE not initialized, initialize it\n                if (type === 'table' && !self._vteController && self._pendingTableId) {\n                    setTimeout(() => {\n                        const tableElement = document.getElementById(self._pendingTableId);\n                        if (tableElement && window.VTE) {\n                            console.log('Initializing Vanilla Table Enhancer on table (view switch):', self._pendingTableId);\n                            try {\n                                self._vteController = window.VTE.enhance('#' + self._pendingTableId, {\n                                    perPage: 10,\n                                    perPageOptions: [10, 25, 50, 100],\n                                    labels: {\n                                        search: 'Search',\n                                        rows: 'Rows per page',\n                                        info: (start, end, total) => `Showing ${start}â€“${end} of ${total} entries`,\n                                        noData: 'No matching records found'\n                                    }\n                                })[0];\n                            } catch (e) {\n                                console.error('Error initializing Vanilla Table Enhancer on view switch:', e);\n                            }\n                        }\n                    }, 100);\n                }\n                \n                // If chart or graph, (re)initialize chart\n                if (type === 'chart') {\n                    setTimeout(() => {\n                        const chartEl = document.getElementById('reportChart');\n                        if (chartEl) {\n                            const headers = Object.keys(data[0] || {});\n                            // Find first string column for labels, first numeric for values (but skip id columns for values)\n                            let labelKey = headers.find(h => typeof data[0][h] === 'string') || headers[0];\n                            let valueKey = headers.find(h => typeof data[0][h] === 'number' && !/^([a-zA-Z0-9]*_)?id$/.test(h))\n                                || headers.find(h => typeof data[0][h] === 'number' && !h.endsWith('_id'))\n                                || headers.find(h => typeof data[0][h] === 'number')\n                                || headers[1];\n                            const labels = data.map(r => r[labelKey]);\n                            const values = data.map(r => r[valueKey]);\n                            if (self.reportChartInstance) { self.reportChartInstance.destroy(); }\n                            self.reportChartInstance = new Chart(chartEl.getContext('2d'), {\n                                type: 'bar',\n                                data: { labels: labels, datasets: [{ label: valueKey.replace(/_/g, ' ').replace(/\\b\\w/g, l => l.toUpperCase()), data: values, backgroundColor: 'rgba(0,123,255,0.5)', borderColor: 'rgba(0,123,255,1)', borderWidth: 1 }] },\n                                options: { responsive: true, maintainAspectRatio: false }\n                            });\n                        }\n                    }, 100);\n                } else if (type === 'graph') {\n                    setTimeout(() => {\n                        const graphEl = document.getElementById('reportGraph');\n                        if (graphEl) {\n                            const headers = Object.keys(data[0] || {});\n                            // Find first string column for labels, first numeric for values (but skip id columns for values)\n                            let labelKey = headers.find(h => typeof data[0][h] === 'string') || headers[0];\n                            let valueKey = headers.find(h => typeof data[0][h] === 'number' && !/^([a-zA-Z0-9]*_)?id$/.test(h))\n                                || headers.find(h => typeof data[0][h] === 'number' && !h.endsWith('_id'))\n                                || headers.find(h => typeof data[0][h] === 'number')\n                                || headers[1];\n                            const labels = data.map(r => r[labelKey]);\n                            const values = data.map(r => r[valueKey]);\n                            if (self.reportGraphInstance) { self.reportGraphInstance.destroy(); }\n                            self.reportGraphInstance = new Chart(graphEl.getContext('2d'), {\n                                type: 'line',\n                                data: { labels: labels, datasets: [{ label: valueKey.replace(/_/g, ' ').replace(/\\b\\w/g, l => l.toUpperCase()), data: values, backgroundColor: 'rgba(40,167,69,0.5)', borderColor: 'rgba(40,167,69,1)', borderWidth: 1 }] },\n                                options: { responsive: true, maintainAspectRatio: false }\n                            });\n                        }\n                    }, 100);\n                }\n                // Save display type if changed\n                if (type !== report.display_type) {\n                    if (reportsView.find('.save-display-type-btn').length === 0) {\n                        reportsView.find('.display-type-icons').append('<button class=\"btn btn-icon save-display-type-btn\" style=\"font-size:1.5rem; width:40px; height:40px; border-radius:50%;\"><i class=\"fa fa-save\"></i></button>');\n                        reportsView.find('.save-display-type-btn').on('click', function() { self.saveDisplayType(report.slug, type); });\n                    }\n                } else {\n                    reportsView.find('.save-display-type-btn').remove();\n                }\n            });\n            // Export buttons\n            reportsView.find('.export-csv-btn').on('click', () => self.exportReport(report.slug, 'csv'));\n            reportsView.find('.export-json-btn').on('click', () => self.exportReport(report.slug, 'json'));\n            \n            // Compare Data button - Disabled for v2\n            // setTimeout(function() {\n            //     if ($('.compare-data-btn').length === 0) {\n            //         $('.display-type-icons').after('<button class=\"btn btn-outline-info btn-sm compare-data-btn ms-2\"><i class=\"fa fa-balance-scale\"></i> Compare Data</button>');\n            //         $('.compare-data-btn').on('click', function() {\n            //             self.showCompareDataModal(report);\n            //         });\n            //     }\n            // }, 100);\n        },\n\n        /**\n         * Render report data as a table\n         */\n        renderReportData: function(data) {\n            if (!data || data.length === 0) {\n                return '<p class=\"text-muted\">No data available.</p>';\n            }\n            \n            const headers = Object.keys(data[0]);\n            const tableId = 'enhanced-report-table-' + Date.now();\n            let tableHtml = `<div class=\"table-responsive\"><table id=\"${tableId}\" class=\"table table-striped table-hover\">`;\n            \n            // Add headers with data type hints for proper sorting\n            tableHtml += '<thead><tr>';\n            headers.forEach(header => {\n                // Detect if column contains numeric data\n                const isNumeric = data.every(row => {\n                    const val = row[header];\n                    return val === null || val === undefined || val === '' || !isNaN(parseFloat(val));\n                });\n                \n                // Detect if column contains date data\n                const isDate = !isNumeric && data.some(row => {\n                    const val = row[header];\n                    return val && !isNaN(Date.parse(val));\n                });\n                \n                const dataType = isNumeric ? ' data-vte=\"number\"' : (isDate ? ' data-vte=\"date\"' : '');\n                tableHtml += `<th${dataType}>${header.replace(/_/g, ' ').replace(/\\b\\w/g, l => l.toUpperCase())}</th>`;\n            });\n            tableHtml += '</tr></thead>';\n            \n            // Add data rows\n            tableHtml += '<tbody>';\n            data.forEach(row => {\n                tableHtml += '<tr>';\n                headers.forEach(header => {\n                    tableHtml += `<td>${row[header] || ''}</td>`;\n                });\n                tableHtml += '</tr>';\n            });\n            tableHtml += '</tbody></table></div>';\n            \n            // Store table ID for enhancement after DOM insertion\n            this._pendingTableId = tableId;\n            \n            return tableHtml;\n        },\n\n        /**\n         * Get status badge HTML\n         */\n        getStatusBadge: function(status) {\n            const badgeClass = this.getStatusBadgeClass(status);\n            return `<span class=\"badge ${badgeClass}\" style=\"color: white;\">${status}</span>`;\n        },\n\n        /**\n         * Get status badge CSS class\n         */\n        getStatusBadgeClass: function(status) {\n            switch (status) {\n                case 'completed': return 'bg-success';\n                case 'processing': return 'bg-warning text-dark';\n                case 'pending': return 'bg-info';\n                case 'failed': return 'bg-danger';\n                default: return 'bg-secondary';\n            }\n        },\n\n        /**\n         * Execute a pending report\n         */\n        executeReport: function(reportSlug) {\n            // Show loading indicator\n            const reportRow = $(`.report-row[data-report-slug=\"${reportSlug}\"]`);\n            const originalContent = reportRow.html();\n            reportRow.html('<td colspan=\"3\" class=\"text-center\"><div class=\"spinner-border spinner-border-sm text-primary\" role=\"status\"><span class=\"visually-hidden\">Executing...</span></div> Executing report...</td>');\n            \n            this.ajaxWithAuth({\n                url: `https://ai-backend.stagingwithswift.com/api/reports/${reportSlug}/execute`,\n                method: 'POST',\n                success: (response) => {\n                    if (response.success) {\n                        // Update the cached report status\n                        if (Array.isArray(this.cachedReports)) {\n                            const reportIndex = this.cachedReports.findIndex(r => r.slug === reportSlug);\n                            if (reportIndex !== -1) {\n                                this.cachedReports[reportIndex] = Object.assign({}, this.cachedReports[reportIndex], response.report);\n                            }\n                        }\n                        \n                        // Refresh the report display\n                        setTimeout(() => {\n                            this.fetchAndDisplayReport(reportSlug, reportRow);\n                        }, 1000); // Small delay to show completion\n                        \n                        this.showSuccess('Report executed successfully!');\n                    } else {\n                        reportRow.html(originalContent);\n                        this.showError('Failed to execute report: ' + (response.error || 'Unknown error'));\n                    }\n                },\n                error: (xhr, status, error) => {\n                    reportRow.html(originalContent);\n                    \n                    let errorMessage = 'Failed to execute report';\n                    \n                    // Handle different error scenarios\n                    if (xhr.status === 500) {\n                        errorMessage = 'Server error occurred while executing the report. Please check the SQL query and try again.';\n                    } else if (xhr.status === 403) {\n                        errorMessage = 'You do not have permission to execute this report.';\n                    } else if (xhr.status === 404) {\n                        errorMessage = 'Report not found.';\n                    } else if (xhr.responseJSON && xhr.responseJSON.error) {\n                        errorMessage = xhr.responseJSON.error;\n                    } else {\n                        errorMessage += ': ' + error;\n                    }\n                    \n                    console.error('Report execution failed:', {\n                        status: xhr.status,\n                        error: error,\n                        response: xhr.responseText\n                    });\n                    \n                    this.showError(errorMessage);\n                }\n            });\n        },\n\n        /**\n         * Export report\n         */\n        exportReport: function(reportSlug, format) {\n            const url = `https://ai-backend.stagingwithswift.com/api/reports/${reportSlug}/export/${format}`;\n            const token = sessionStorage.getItem('ai_token');\n            if (!token) {\n                this.showError('You must be logged in to export reports.');\n                return;\n            }\n            // Show loader\n            Swal.fire({\n                title: 'Exporting report...',\n                allowOutsideClick: false,\n                didOpen: () => Swal.showLoading()\n            });\n            fetch(url, {\n                method: 'GET',\n                headers: {\n                    'Authorization': 'Bearer ' + token\n                }\n            })\n            .then(response => {\n                if (!response.ok) throw new Error('Export failed');\n                return response.blob();\n            })\n            .then(blob => {\n                Swal.close();\n                const link = document.createElement('a');\n                link.href = window.URL.createObjectURL(blob);\n                link.download = `report-${reportSlug}.${format}`;\n                document.body.appendChild(link);\n                link.click();\n                document.body.removeChild(link);\n            })\n            .catch(() => {\n                Swal.close();\n                this.showError('Failed to export report.');\n            });\n        },\n\n        /**\n         * Open report from chat link\n         */\n        openReportFromLink: function(reportSlug) {\n            console.log('openReportFromLink called with slug:', reportSlug);\n            \n            // Switch to reports tab\n            this.switchToReportsTab();\n            \n            // Refresh history from cache\n            this.updateReportsHistory(this.cachedReports);\n            \n            // Highlight the report row\n            $('.report-row').removeClass('table-primary');\n            const reportRow = $(`.report-row[data-report-slug=\"${reportSlug}\"]`);\n            reportRow.addClass('table-primary');\n            \n            // Check if report has full data in cache\n            const cached = this.cachedReports.find(r => r.slug === reportSlug);\n            console.log('Cached report found:', cached);\n            console.log('Has data?', cached && cached.data ? 'YES' : 'NO');\n            console.log('Data length:', cached && cached.data ? cached.data.length : 'N/A');\n            \n            // If cached report has data, use it; otherwise fetch from API\n            if (cached && cached.data && Array.isArray(cached.data) && cached.data.length > 0) {\n                console.log('Using cached data for report:', reportSlug);\n                this.updateReportsView(cached, cached.data);\n            } else {\n                console.log('Fetching report data from API:', reportSlug);\n                this.fetchAndDisplayReport(reportSlug, reportRow);\n            }\n        },\n\n        /**\n         * Format timestamps like WhatsApp (today: HH:mm, yesterday: Weekday - HH:mm, same year: D Month - HH:mm, previous years: D Month YYYY - HH:mm)\n         */\n        formatTimestamp: function(ts) {\n            const date = (ts instanceof Date) ? ts : new Date(ts);\n            const now = new Date();\n            const pad = (n) => n.toString().padStart(2, '0');\n            const time = `${pad(date.getHours())}:${pad(date.getMinutes())}`;\n            // Different years\n            if (date.getFullYear() !== now.getFullYear()) {\n                const month = date.toLocaleString('default', { month: 'long' });\n                return `${date.getDate()} ${month} ${date.getFullYear()} - ${time}`;\n            }\n            // Today\n            if (date.toDateString() === now.toDateString()) {\n                return time;\n            }\n            // Yesterday\n            const yesterday = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 1);\n            if (date.toDateString() === yesterday.toDateString()) {\n                const weekday = date.toLocaleString('default', { weekday: 'long' });\n                return `${weekday} - ${time}`;\n            }\n            // Earlier this year\n            const month = date.toLocaleString('default', { month: 'long' });\n            return `${date.getDate()} ${month} - ${time}`;\n        },\n\n        /**\n         * Increment or add report badge count in chat history list\n         */\n        updateChatHistoryBadge: function(chatId) {\n            const $item = $(`#chat-history-list li.chat-history-item[data-chat-id=\"${chatId}\"]`);\n            if (!$item.length) return;\n            let $badge = $item.find('.report-count');\n            if ($badge.length) {\n                const current = parseInt($badge.text(), 10) || 0;\n                $badge.text(current + 1);\n            } else {\n                const $newBadge = $(`<span class=\"badge bg-primary d-flex align-items-center report-count\" style=\"color: white;\"><i class=\"fa fa-chart-bar me-1\"></i>1</span>`);\n                $item.append($newBadge);\n            }\n        },\n\n        /**\n         * Persist display type to server\n         */\n        saveDisplayType: function(reportSlug, displayType) {\n            const self = this;\n            // Show SweetAlert loader\n            Swal.fire({\n                title: 'Saving default view...',\n                allowOutsideClick: false,\n                didOpen: () => Swal.showLoading()\n            });\n            this.ajaxWithAuth({\n                url: `https://ai-backend.stagingwithswift.com/api/reports/${reportSlug}/display-type`,\n                method: 'POST',\n                contentType: 'application/json',\n                data: JSON.stringify({ display_type: displayType }),\n                success: () => {\n                    // Show success toast\n                    Swal.fire({ icon: 'success', title: 'Default view saved', showConfirmButton: false, timer: 1500 });\n                    // Update cache and hide save button\n                    const rep = this.cachedReports.find(r => r.slug === reportSlug);\n                    if (rep) { rep.display_type = displayType; }\n                    $('.save-display-type-btn').remove();\n                },\n                error: () => {\n                    // Show error toast\n                    Swal.fire({ icon: 'error', title: 'Save failed', text: 'Could not save default view. Please try again.' });\n                }\n            });\n        },\n\n        // New method to show resend icon on a specific user message\n        showResendIconOnMessage: function($messageElement, messageText) {\n            if (!$messageElement || !$messageElement.length) {\n                return;\n            }\n            \n            // Remove any existing resend icons on this message\n            $messageElement.siblings('.failed-reload-icon').remove();\n                \n                // Create retry icon\n                const $icon = $(`\n                    <i class=\"fa fa-refresh failed-reload-icon text-danger\"\n                   title=\"Retry sending this message\"\n                       style=\"cursor:pointer; float:left; margin-right:0.5rem;\"></i>\n                `);\n                \n                // Insert it to the left of the user-message bubble\n            $messageElement.after($icon);\n                \n                // Bind click event to resend the message\n                $icon.on('click', () => {\n                    $icon.remove();\n                this.resendMessage($messageElement, messageText);\n            });\n        },\n\n        // Legacy method for backward compatibility - shows resend icon on last user message\n        showResendIconOnLastUserMessage: function() {\n            const $lastUserMessage = $('#chat-container .user-message:last');\n            if ($lastUserMessage.length) {\n                // Get the message text from the last user message\n                const messageText = $lastUserMessage.find('.message-text').text();\n                this.showResendIconOnMessage($lastUserMessage, messageText);\n            }\n        },\n\n        /**\n         * Show the Compare Data modal for the current report\n         */\n        showCompareDataModal: function(report) {\n            const self = this;\n            const reportSlug = report.slug;\n            let timeline = [];\n            let currentData = null;\n            let selectedA = null;\n            let selectedB = null;\n            let loadingA = false;\n            let loadingB = false;\n            let error = null;\n            let displayTypeA = 'table';\n            let displayTypeB = 'table';\n            let currentSnapshotId = null;\n            let compareDataA = null;\n            let compareDataB = null;\n            let currentDataFetched = false;\n            let nextSection = 'a'; // Alternating selection\n\n            // Helper: fetch timeline\n            function fetchTimeline(cb) {\n                self.ajaxWithAuth({\n                    url: `https://ai-backend.stagingwithswift.com/api/reports/${reportSlug}/snapshots`,\n                    method: 'GET',\n                    success: function(res) {\n                        timeline = res.snapshots || [];\n                        currentSnapshotId = (timeline.find(s => s.is_current_version) || {}).id || null;\n                        console.log('[DEBUG] Timeline fetched:', timeline);\n                        if (cb) cb();\n                    },\n                    error: function() {\n                        error = 'Failed to load timeline.';\n                        console.error('[DEBUG] Timeline fetch error:', error);\n                        if (cb) cb();\n                    }\n                });\n            }\n\n            // Helper: fetch current data for A or B\n            function fetchCurrent(section, cb) {\n                if (section === 'a') loadingA = true;\n                if (section === 'b') loadingB = true;\n                renderSections();\n                self.ajaxWithAuth({\n                    url: `https://ai-backend.stagingwithswift.com/api/reports/${reportSlug}/data/current`,\n                    method: 'GET',\n                    success: function(res) {\n                        currentData = res.data || [];\n                        if (section === 'a') {\n                        compareDataA = currentData;\n                        selectedA = 'current';\n                            loadingA = false;\n                        } else {\n                            compareDataB = currentData;\n                            selectedB = 'current';\n                            loadingB = false;\n                        }\n                        currentDataFetched = true;\n                        renderSections();\n                        if (cb) cb();\n                    },\n                    error: function() {\n                        error = 'Failed to fetch current data.';\n                        if (section === 'a') loadingA = false;\n                        if (section === 'b') loadingB = false;\n                        renderSections();\n                        if (cb) cb();\n                    }\n                });\n            }\n\n            // Helper: fetch a single snapshot's data for A or B\n            function fetchSnapshotData(snapId, section, cb) {\n                if (section === 'a') loadingA = true;\n                if (section === 'b') loadingB = true;\n                renderSections();\n                self.ajaxWithAuth({\n                    url: `https://ai-backend.stagingwithswift.com/api/reports/${reportSlug}/snapshots/${snapId}`,\n                    method: 'GET',\n                    success: function(res) {\n                        if (section === 'a') {\n                            compareDataA = res.data;\n                            selectedA = snapId;\n                            loadingA = false;\n                        } else {\n                            compareDataB = res.data;\n                            selectedB = snapId;\n                            loadingB = false;\n                        }\n                        renderSections();\n                        if (cb) cb();\n                    },\n                    error: function() {\n                        error = 'Failed to fetch snapshot data.';\n                        if (section === 'a') loadingA = false;\n                        if (section === 'b') loadingB = false;\n                        renderSections();\n                        if (cb) cb();\n                    }\n                });\n            }\n\n            // Helper: compare two snapshots (for diff table)\n            function fetchCompare(aId, bId, cb) {\n                loadingA = true;\n                loadingB = true;\n                renderSections();\n                self.ajaxWithAuth({\n                    url: `https://ai-backend.stagingwithswift.com/api/reports/${reportSlug}/snapshots/${aId}/compare/${bId}`,\n                    method: 'GET',\n                    success: function(res) {\n                        compareDataA = res.a.data;\n                        compareDataB = res.b.data;\n                        loadingA = false;\n                        loadingB = false;\n                        renderSections();\n                        if (cb) cb(res);\n                    },\n                    error: function() {\n                        error = 'Failed to compare snapshots.';\n                        loadingA = false;\n                        loadingB = false;\n                        renderSections();\n                        if (cb) cb();\n                    }\n                });\n            }\n\n            // Helper: get color and note\n            function getSnapshotColor(snapId) {\n                if (!snapId) return { bg: '#f8f9fa', border: '#dee2e6', text: '#6c757d' };\n                const snapIndex = timeline.findIndex(s => s.id === snapId);\n                if (snapIndex === -1) return { bg: '#f8f9fa', border: '#dee2e6', text: '#6c757d' };\n                const colors = [\n                    { bg: '#e3f2fd', border: '#2196f3', text: '#1976d2' },\n                    { bg: '#f3e5f5', border: '#9c27b0', text: '#7b1fa2' },\n                    { bg: '#e8f5e8', border: '#4caf50', text: '#388e3c' },\n                    { bg: '#fff3e0', border: '#ff9800', text: '#f57c00' },\n                    { bg: '#fce4ec', border: '#e91e63', text: '#c2185b' },\n                    { bg: '#e0f2f1', border: '#009688', text: '#00695c' },\n                    { bg: '#f1f8e9', border: '#8bc34a', text: '#689f38' },\n                    { bg: '#fff8e1', border: '#ffc107', text: '#ffa000' }\n                ];\n                return colors[snapIndex % colors.length];\n            }\n            function getSnapshotNote(snapId) {\n                if (!snapId) return '';\n                if (typeof snapId === 'string' && snapId === 'current') return 'Current Data';\n                const snap = timeline.find(s => s.id === snapId);\n                return snap && snap.note ? snap.note : '';\n            }\n\n            // Render section A\n            function renderSectionA() {\n                let html = '';\n                const colorA = getSnapshotColor(selectedA);\n                const noteA = getSnapshotNote(selectedA);\n                html += `<div class=\"w-100 droppable-snapshot compare-section\" id=\"compare-section-a\" data-drop-target=\"a\" style=\"border: 2px solid ${colorA.border}; border-radius: 8px; padding: 12px; background-color: ${colorA.bg}; height: 100%; min-height: 300px; position:relative;\">\n                    <div class=\"d-flex justify-content-between align-items-center mb-2\">\n                        <span class=\"fw-bold\" style=\"color: ${colorA.text};\">Snapshot A${noteA ? ': ' + noteA : ''}</span>\n                        <div class=\"btn-group display-type-switcher-a\" role=\"group\" aria-label=\"Display type switcher\">\n                            <button class=\"btn btn-icon btn-sm${displayTypeA === 'table' ? ' active' : ''}\" data-type=\"table\" data-side=\"a\" tabindex=\"0\" aria-label=\"Table view\" title=\"Table view\"><i class=\"fa fa-table\"></i></button>\n                            <button class=\"btn btn-icon btn-sm${displayTypeA === 'chart' ? ' active' : ''}\" data-type=\"chart\" data-side=\"a\" tabindex=\"0\" aria-label=\"Chart view\" title=\"Chart view\"><i class=\"fa fa-bar-chart\"></i></button>\n                            <button class=\"btn btn-icon btn-sm${displayTypeA === 'graph' ? ' active' : ''}\" data-type=\"graph\" data-side=\"a\" tabindex=\"0\" aria-label=\"Graph view\" title=\"Graph view\"><i class=\"fa fa-line-chart\"></i></button>\n                            </div>\n                        </div>`;\n                if (loadingA) {\n                    html += '<div class=\"w-100 d-flex justify-content-center align-items-center\" style=\"min-height:200px\"><div class=\"spinner-border text-primary\" role=\"status\"></div></div>';\n                } else if (compareDataA) {\n                    html += `<div class=\"comparison-fade${displayTypeA ? ' comparison-fade-in' : ''}\" style=\"animation:fadeIn .3s; overflow-x: auto; max-height: calc(100% - 50px);\">`;\n                    if (displayTypeA === 'table') {\n                        html += self.renderDiffTable(compareDataA, compareDataB);\n                    } else if (displayTypeA === 'chart') {\n                        html += `<div class=\"chart-container\" style=\"min-height:260px;\" tabindex=\"0\" aria-label=\"Bar chart\" role=\"region\"><canvas id=\"compareChartA\"></canvas></div>`;\n                    } else if (displayTypeA === 'graph') {\n                        html += `<div class=\"chart-container\" style=\"min-height:260px;\" tabindex=\"0\" aria-label=\"Line graph\" role=\"region\"><canvas id=\"compareGraphA\"></canvas></div>`;\n                    }\n                    html += '</div>';\n                } else {\n                    html += `<div class=\"text-muted small text-center\" style=\"min-height:200px;\">No snapshot selected for A</div>`;\n                }\n                html += '</div>';\n                return html;\n            }\n            // Render section B\n            function renderSectionB() {\n                let html = '';\n                const colorB = getSnapshotColor(selectedB);\n                const noteB = getSnapshotNote(selectedB);\n                html += `<div class=\"w-100 droppable-snapshot compare-section\" id=\"compare-section-b\" data-drop-target=\"b\" style=\"border: 2px solid ${colorB.border}; border-radius: 8px; padding: 12px; background-color: ${colorB.bg}; height: 100%; min-height: 300px; position:relative;\">\n                    <div class=\"d-flex justify-content-between align-items-center mb-2\">\n                        <span class=\"fw-bold\" style=\"color: ${colorB.text};\">Snapshot B${noteB ? ': ' + noteB : ''}</span>\n                        <div class=\"btn-group display-type-switcher-b\" role=\"group\" aria-label=\"Display type switcher B\">\n                            <button class=\"btn btn-icon btn-sm${displayTypeB === 'table' ? ' active' : ''}\" data-type=\"table\" data-side=\"b\" tabindex=\"0\" aria-label=\"Table view for B\" title=\"Table view\"><i class=\"fa fa-table\"></i></button>\n                            <button class=\"btn btn-icon btn-sm${displayTypeB === 'chart' ? ' active' : ''}\" data-type=\"chart\" data-side=\"b\" tabindex=\"0\" aria-label=\"Chart view for B\" title=\"Chart view\"><i class=\"fa fa-bar-chart\"></i></button>\n                            <button class=\"btn btn-icon btn-sm${displayTypeB === 'graph' ? ' active' : ''}\" data-type=\"graph\" data-side=\"b\" tabindex=\"0\" aria-label=\"Graph view for B\" title=\"Graph view\"><i class=\"fa fa-line-chart\"></i></button>\n                        </div>\n                    </div>`;\n                if (loadingB) {\n                    html += '<div class=\"w-100 d-flex justify-content-center align-items-center\" style=\"min-height:200px\"><div class=\"spinner-border text-primary\" role=\"status\"></div></div>';\n                } else if (compareDataB) {\n                    html += `<div class=\"comparison-fade${displayTypeB ? ' comparison-fade-in' : ''}\" style=\"animation:fadeIn .3s; overflow-x: auto; max-height: calc(100% - 50px);\">`;\n                    if (displayTypeB === 'table') {\n                        html += self.renderDiffTable(compareDataB, compareDataA);\n                    } else if (displayTypeB === 'chart') {\n                        html += `<div class=\"chart-container\" style=\"min-height:260px;\" tabindex=\"0\" aria-label=\"Bar chart for B\" role=\"region\"><canvas id=\"compareChartB\"></canvas></div>`;\n                    } else if (displayTypeB === 'graph') {\n                        html += `<div class=\"chart-container\" style=\"min-height:260px;\" tabindex=\"0\" aria-label=\"Line graph for B\" role=\"region\"><canvas id=\"compareGraphB\"></canvas></div>`;\n                    }\n                    html += '</div>';\n                    } else {\n                    html += `<div class=\"text-muted small text-center\" style=\"min-height:200px;\">No snapshot selected for B</div>`;\n                }\n                html += '</div>';\n                return html;\n            }\n\n            // Render both sections\n            function renderSections() {\n                $('#compare-section-a').replaceWith(renderSectionA());\n                $('#compare-section-b').replaceWith(renderSectionB());\n                // Chart.js rendering for A\n                if (displayTypeA === 'chart' && Array.isArray(compareDataA) && compareDataA.length > 0) {\n                    const ctxA = document.getElementById('compareChartA');\n                    if (ctxA) {\n                        const headers = Object.keys(compareDataA[0]);\n                        let labelKey = headers.find(h => typeof compareDataA[0][h] === 'string') || headers[0];\n                        let valueKey = headers.find(h => typeof compareDataA[0][h] === 'number') || headers[1];\n                        const labels = compareDataA.map(r => r[labelKey]);\n                        const values = compareDataA.map(r => r[valueKey]);\n                        if (window.compareChartAInstance) window.compareChartAInstance.destroy();\n                        window.compareChartAInstance = new Chart(ctxA.getContext('2d'), {\n                            type: 'bar',\n                            data: { labels: labels, datasets: [{ label: valueKey, data: values, backgroundColor: 'rgba(0,123,255,0.5)', borderColor: 'rgba(0,123,255,1)', borderWidth: 1 }] },\n                            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }\n                        });\n                    }\n                }\n                if (displayTypeA === 'graph' && Array.isArray(compareDataA) && compareDataA.length > 0) {\n                    const ctxA = document.getElementById('compareGraphA');\n                    if (ctxA) {\n                        const headers = Object.keys(compareDataA[0]);\n                        let labelKey = headers.find(h => typeof compareDataA[0][h] === 'string') || headers[0];\n                        let valueKey = headers.find(h => typeof compareDataA[0][h] === 'number') || headers[1];\n                        const labels = compareDataA.map((r, i) => r[labelKey] || i + 1);\n                        const values = compareDataA.map(r => r[valueKey]);\n                        if (window.compareGraphAInstance) window.compareGraphAInstance.destroy();\n                        window.compareGraphAInstance = new Chart(ctxA.getContext('2d'), {\n                            type: 'line',\n                            data: { labels: labels, datasets: [{ label: valueKey, data: values, backgroundColor: 'rgba(40,167,69,0.5)', borderColor: 'rgba(40,167,69,1)', borderWidth: 2, fill: false }] },\n                            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }\n                        });\n                    }\n                }\n                // Chart.js rendering for B\n                if (displayTypeB === 'chart' && Array.isArray(compareDataB) && compareDataB.length > 0) {\n                    const ctxB = document.getElementById('compareChartB');\n                    if (ctxB) {\n                        const headers = Object.keys(compareDataB[0]);\n                        let labelKey = headers.find(h => typeof compareDataB[0][h] === 'string') || headers[0];\n                        let valueKey = headers.find(h => typeof compareDataB[0][h] === 'number') || headers[1];\n                        const labels = compareDataB.map(r => r[labelKey]);\n                        const values = compareDataB.map(r => r[valueKey]);\n                        if (window.compareChartBInstance) window.compareChartBInstance.destroy();\n                        window.compareChartBInstance = new Chart(ctxB.getContext('2d'), {\n                            type: 'bar',\n                            data: { labels: labels, datasets: [{ label: valueKey, data: values, backgroundColor: 'rgba(0,123,255,0.5)', borderColor: 'rgba(0,123,255,1)', borderWidth: 1 }] },\n                            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }\n                        });\n                    }\n                }\n                if (displayTypeB === 'graph' && Array.isArray(compareDataB) && compareDataB.length > 0) {\n                    const ctxB = document.getElementById('compareGraphB');\n                    if (ctxB) {\n                        const headers = Object.keys(compareDataB[0]);\n                        let labelKey = headers.find(h => typeof compareDataB[0][h] === 'string') || headers[0];\n                        let valueKey = headers.find(h => typeof compareDataB[0][h] === 'number') || headers[1];\n                        const labels = compareDataB.map((r, i) => r[labelKey] || i + 1);\n                        const values = compareDataB.map(r => r[valueKey]);\n                        if (window.compareGraphBInstance) window.compareGraphBInstance.destroy();\n                        window.compareGraphBInstance = new Chart(ctxB.getContext('2d'), {\n                            type: 'line',\n                            data: { labels: labels, datasets: [{ label: valueKey, data: values, backgroundColor: 'rgba(40,167,69,0.5)', borderColor: 'rgba(40,167,69,1)', borderWidth: 2, fill: false }] },\n                            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }\n                        });\n                    }\n                }\n            }\n\n            // Helper: render timeline sidebar (unchanged)\n            function renderTimeline(selectedAId, selectedBId) {\n                console.log('[DEBUG] renderTimeline called. Timeline:', timeline);\n                let html = '<div class=\"timeline-sidebar\" style=\"width:220px;max-width:220px;overflow-y:auto;height:100%;background:#f8f9fa;border-right:1.5px solid #e0e0e0;padding:0.5rem 0.25rem;\">';\n                html += '<div class=\"d-flex flex-column gap-2 mb-3\">';\n                html += `<button class=\"btn btn-outline-primary btn-sm w-100 mb-1 fetch-current-btn\" title=\"Fetch current data from database\" aria-label=\"Fetch current data\"><i class=\"fa fa-sync\"></i> Fetch Current Data</button>`;\n                const isCurrentDataInContext = currentDataFetched && selectedA === 'current';\n                if (isCurrentDataInContext) {\n                    html += `<div class=\"mb-2\">\n                        <input type=\"text\" id=\"add-timeline-note\" class=\"form-control form-control-sm mb-1\" placeholder=\"Enter snapshot name (required)\" required aria-label=\"Snapshot name\">\n                        <div class=\"invalid-feedback\" style=\"display:none;\">Snapshot name is required.</div>\n                        <button class=\"btn btn-outline-success btn-sm w-100 add-timeline-btn\" id=\"add-timeline-btn\" title=\"Create snapshot from current data\" aria-label=\"Create snapshot from current data\" disabled><span class=\"btn-label\"><i class=\"fa fa-plus\"></i> Create Snapshot From Current Data</span><span class=\"spinner-border spinner-border-sm ms-2\" id=\"snapshot-loading\" style=\"display:none;\" role=\"status\" aria-hidden=\"true\"></span></button>\n                    </div>`;\n                }\n                html += '<div class=\"small text-muted text-center px-2 py-1 mb-2\" style=\"border: 1px dashed #dee2e6; border-radius: 4px;\">Click or <b>drag</b> snapshots to select for comparison. Each snapshot gets a unique color. You can also drag and drop from the side menu into the snapshot viewer.</div>';\n                html += '</div>';\n                html += '<div class=\"timeline-list\">';\n                if (timeline.length === 0) {\n                    if (error) {\n                        html += `<div class=\"text-danger small text-center py-2\">Error: ${error}</div>`;\n                    } else {\n                        html += '<div class=\"text-muted small text-center py-2\">No timeline snapshots yet. [DEBUG: Timeline is empty]</div>';\n                    }\n                } else {\n                    timeline.forEach((snap, index) => {\n                        // Color coding system\n                        const colors = [\n                            { bg: '#e3f2fd', border: '#2196f3', text: '#1976d2' }, // Light blue\n                            { bg: '#f3e5f5', border: '#9c27b0', text: '#7b1fa2' }, // Light purple\n                            { bg: '#e8f5e8', border: '#4caf50', text: '#388e3c' }, // Light green\n                            { bg: '#fff3e0', border: '#ff9800', text: '#f57c00' }, // Light orange\n                            { bg: '#fce4ec', border: '#e91e63', text: '#c2185b' }, // Light pink\n                            { bg: '#e0f2f1', border: '#009688', text: '#00695c' }, // Light teal\n                            { bg: '#f1f8e9', border: '#8bc34a', text: '#689f38' }, // Light lime\n                            { bg: '#fff8e1', border: '#ffc107', text: '#ffa000' }  // Light amber\n                        ];\n                        const colorIndex = index % colors.length;\n                        const color = colors[colorIndex];\n                        const isSelected = selectedAId === snap.id || selectedBId === snap.id;\n                        const selectedStyle = isSelected ? \n                            `background-color: ${color.bg}; border-color: ${color.border}; border-width: 2px;` : \n                            `background-color: #fff; border-color: #dee2e6; border-width: 1px;`;\n                        const isCurrent = snap.is_current_version ? '<span class=\"badge bg-primary ms-1\">Current</span>' : '';\n                        // Drag and drop attributes\n                        const dragDisabled = isSelected ? 'draggable=\"false\"' : 'draggable=\"true\"';\n                        const dragClass = isSelected ? 'drag-disabled' : 'draggable-snapshot';\n                        const dragTitle = isSelected ? 'This snapshot is currently selected' : 'Drag to assign to Snapshot A or B';\n                        const dragText = isSelected ? '<span class=\"text-muted small\">(Selected)</span>' : '';\n                        html += `<div class=\"timeline-item p-2 mb-1 rounded border ${dragClass}\" \n                                      style=\"cursor:pointer; animation:fadeIn .3s; ${selectedStyle}\" \n                                      data-snap-id=\"${snap.id}\" \n                                      data-color-bg=\"${color.bg}\" \n                                      data-color-border=\"${color.border}\" \n                                      data-color-text=\"${color.text}\"\n                                      tabindex=\"0\" \n                                      aria-label=\"Snapshot from ${self.formatTimestamp(snap.created_at)}${snap.is_current_version ? ' (current)' : ''}\"\n                                      ${dragDisabled}\n                                      title=\"${dragTitle}\"\n                                      >\n                            <div class=\"d-flex justify-content-between align-items-center\">\n                                <span class=\"fw-bold small\">${self.formatTimestamp(snap.created_at)}</span>\n                                ${isCurrent}\n                            </div>\n                            <div class=\"small text-muted\">${snap.note ? snap.note : ''} ${dragText}</div>\n                            <div class=\"d-flex gap-1 mt-1\">\n                                <button class=\"btn btn-outline-secondary btn-xs btn-sm set-current-btn\" data-snap-id=\"${snap.id}\" title=\"Set as current version\" aria-label=\"Set as current\"><i class=\"fa fa-check\"></i></button>\n                            </div>\n                        </div>`;\n                    });\n                }\n                html += '</div></div>';\n                return html;\n            }\n\n            // Helper: render modal\n            function renderModal() {\n                Swal.update({\n                    html: `<div class='d-flex flex-row' style='height:70vh;min-height:500px;max-height:80vh;'>\n                        <div id='timeline-sidebar-modal'></div>\n                        <div class='flex-fill px-3' style='overflow:auto;max-width:calc(100% - 220px);'>\n                            <div class='d-flex flex-row gap-3 w-100 h-100'>\n                                <div class='flex-fill' id='compare-section-a'></div>\n                                <div class='flex-fill' id='compare-section-b'></div>\n                            </div>\n                        </div>\n                    </div>`\n                });\n                $('#timeline-sidebar-modal').html(renderTimeline(selectedA, selectedB));\n                renderSections();\n                // Bind timeline actions\n                $('.fetch-current-btn').off('click').on('click', function() {\n                    fetchCurrent(nextSection);\n                });\n                // Timeline item click handler for alternating selection\n                $('.timeline-item').off('click').on('click', function(e) {\n                    const snapId = $(this).data('snap-id');\n                    if (nextSection === 'a') {\n                        fetchSnapshotData(snapId, 'a', () => {\n                            nextSection = 'b';\n                        });\n                    } else {\n                        fetchSnapshotData(snapId, 'b', () => {\n                            nextSection = 'a';\n                        });\n                    }\n                });\n                // Display type switchers\n                $('.display-type-switcher-a .btn-icon').off('click').on('click', function() {\n                    displayTypeA = $(this).data('type');\n                    renderSections();\n                });\n                $('.display-type-switcher-b .btn-icon').off('click').on('click', function() {\n                    displayTypeB = $(this).data('type');\n                    renderSections();\n                });\n                // Drag and drop logic\n                $('.draggable-snapshot').attr('draggable', true).off('dragstart').on('dragstart', function(e) {\n                    e.originalEvent.dataTransfer.setData('text/plain', $(this).data('snap-id'));\n                    $(this).addClass('dragging');\n                });\n                $('.draggable-snapshot').off('dragend').on('dragend', function(e) {\n                    $(this).removeClass('dragging');\n                });\n                // Section highlight on drag over\n                $('.compare-section').off('dragover').on('dragover', function(e) {\n                    e.preventDefault();\n                    $(this).addClass('drag-over-section');\n                });\n                $('.compare-section').off('dragleave').on('dragleave', function(e) {\n                    $(this).removeClass('drag-over-section');\n                });\n                $('.compare-section').off('drop').on('drop', function(e) {\n                    e.preventDefault();\n                    $(this).removeClass('drag-over-section');\n                    const snapId = e.originalEvent.dataTransfer.getData('text/plain');\n                    const target = $(this).data('drop-target');\n                    fetchSnapshotData(snapId, target, () => {\n                        nextSection = target === 'a' ? 'b' : 'a';\n                    });\n                });\n                // Add highlight CSS if not present\n                if ($('#compare-section-highlight-style').length === 0) {\n                    $('head').append('<style id=\"compare-section-highlight-style\">.drag-over-section { box-shadow: 0 0 0 4px #90caf9 !important; border-color: #1976d2 !important; }</style>');\n                }\n            }\n\n            // Show modal\n            Swal.fire({\n                title: `<span class='fw-bold'>Compare Report Data</span>`,\n                html: `<div class='d-flex flex-row' style='height:60vh;min-height:400px;max-height:70vh;'>\n                    <div id='timeline-sidebar-modal'></div>\n                    <div class='flex-fill px-3' style='overflow:auto;max-width:calc(100% - 220px);'>\n                        <div class='d-flex flex-row gap-3 w-100 h-100'>\n                            <div class='flex-fill' id='compare-section-a'></div>\n                            <div class='flex-fill' id='compare-section-b'></div>\n                        </div>\n                    </div>\n                </div>`,\n                width: '90vw',\n                heightAuto: false,\n                showCancelButton: true,\n                showConfirmButton: false,\n                customClass: { popup: 'swal2-modal-compare-data' },\n                didOpen: () => {\n                    fetchTimeline(() => {\n                        // Default: set A to current version, B to latest snapshot (if >1)\n                        if (timeline.length > 0) {\n                            selectedA = timeline.find(s => s.is_current_version)?.id || timeline[0].id;\n                            selectedB = timeline.length > 1 ? timeline[1].id : null;\n                            if (selectedA && selectedB) {\n                                fetchCompare(selectedA, selectedB, () => {\n                                    nextSection = 'a';\n                                    renderModal();\n                                });\n                            } else if (selectedA) {\n                                fetchSnapshotData(selectedA, 'a', () => {\n                                    nextSection = 'b';\n                                    renderModal();\n                                });\n                            } else {\n                                renderModal();\n                            }\n                        } else {\n                            renderModal();\n                        }\n                    });\n                }\n            });\n        },\n\n        /**\n         * Render a diff table (side-by-side, highlight differences)\n         */\n        renderDiffTable: function(a, b) {\n            // Lightweight diff: highlight cells in a that differ from b\n            if (!Array.isArray(a) || a.length === 0) {\n                return '<div class=\"text-muted small\">No data</div>';\n            }\n            const headers = Object.keys(a[0]);\n            let html = '<div class=\"table-responsive\"><table class=\"table table-striped table-hover table-sm\">';\n            html += '<thead><tr>';\n            headers.forEach(h => { html += `<th>${h}</th>`; });\n            html += '</tr></thead><tbody>';\n            a.forEach((row, i) => {\n                html += '<tr>';\n                headers.forEach(h => {\n                    let diff = false;\n                    // Only highlight differences if we have comparison data\n                    if (b && Array.isArray(b) && b[i] && b[i][h] !== row[h]) {\n                        diff = true;\n                    }\n                    html += `<td${diff ? ' style=\"background:#ffe5e5;\"' : ''}>${row[h] != null ? row[h] : ''}</td>`;\n                });\n                html += '</tr>';\n            });\n            html += '</tbody></table></div>';\n            return html;\n        },\n    };\n\n    // Expose assistant to global scope for onclick handlers\n    window.assistant = assistant;\n    \n    return assistant;\n});"],"names":["define","$","Ajax","Notification","Chart","Templates","AuthUtils","Swal","window","assistant","currentChatId","mcqQueue","reportsDataTable","cachedReports","_initCalled","isCreditLimitExceeded","init","authenticated","this","console","log","hide","isAuthenticated","setUserName","getAuthStatus","user","name","updateSubscriptionInfo","setupEventListeners","loadChatHistory","loadReportsHistory","fadeIn","refreshAuthStatus","setTimeout","showAuthenticationError","error","html","on","sendMessage","e","key","shiftKey","preventDefault","updateChart","style","height","scrollHeight","createNewChat","isSending","renderMCQ","mcq","currentMCQ","c","empty","append","question","options","forEach","opt","label","clearMCQ","prop","extractMCQFromText","text","jsonArrayMatch","match","questions","JSON","parse","Array","isArray","length","type","selectedAnswer","jsonMatches","jsonStr","obj","push","renderMCQHistory","idx","option","optIdx","optionText","isSelected","includes","selectedIcon","checkAuth","handleResponse","response","error_type","handleCreditLimitError","message","addMessage","showResendIconOnLastUserMessage","firstQuestion","mcqText","join","credit_info","enqueueMCQs","report","description","updateChatHistoryBadge","unshift","updateReportsHistory","destroy","tableElement","document","getElementById","thead","querySelector","tbody","rows","cells","headerCells","dataRows","dataCells","textContent","simpleDatatables","DataTable","searchable","fixedHeight","perPage","fire","title","showConfirmButton","allowOutsideClick","allowEscapeKey","timer","timerProgressBar","then","switchToReportsTab","displayCurrentReport","executeReport","slug","data","updateReportData","visualizations","updateVisualizations","showCreditUsageFeedback","scrollToBottom","creditInfo","notification","credits_charged","credit_type","css","remove","updateSubscriptionInfoWithCreditUsage","authStatus","subscription","creditsUsed","premium_credits_used_this_month","basic_credits_used_this_month","ai_credits_used_this_month","animateCreditCounterUpdate","creditType","$counter","addClass","removeClass","$totalCounter","isReportLink","reportData","messageId","timestamp","template","frag","content","cloneNode","messageEl","classList","add","setAttribute","mcqData","mcqHtml","innerHTML","self","link","onclick","openReportFromLink","getAttribute","onmouseenter","onmouseleave","addCreditInfoToMessage","timeEl","formatTimestamp","Date","toISOString","creditBadge","createElement","className","cssText","backgroundColor","color","toUpperCase","tokens_used","provider","appendChild","creditData","summary","updateSubscriptionDataFromCreditResponse","showPersistentCreditLimitMessage","icon","showCancelButton","confirmButtonText","cancelButtonText","confirmButtonColor","result","isConfirmed","showCreditUsageModal","basic","used","plan_basic_credits_limit","available","premium","plan_premium_credits_limit","total","plan_ai_credits_limit","setAuthStatus","handleTimeoutError","cancelButtonColor","focus","alertHtml","$mainInners","eq","before","prepend","hidePersistentCreditLimitMessage","fadeOut","willOpen","showLoading","ajaxWithAuth","url","method","success","displayDetailedUsageModal","usage","daily_usage","user_breakdown","pagination","filters","modalHtml","total_credits_used","total_tokens_used","toLocaleString","total_requests","today_credits_used","map","item","d","created_at","day","getDate","month","year","getFullYear","hours","getHours","toString","padStart","minutes","getMinutes","username","message_preview","substring","width","didOpen","setupUsageModalEventListeners","currentFilters","usageDataTable","perPageSelect","sortable","labels","placeholder","noRows","info","stack","userId","val","startDate","endDate","user_id","start_date","end_date","loadUsageDataWithFilters","period","today","split","weekAgo","setDate","monthAgo","setMonth","getMonth","page","params","URLSearchParams","updateUsageModalData","unique_users","premium_credits","basic_credits","tableBody","row","toLocaleDateString","llm_provider","refresh","table","columns","column","find","tr","cell","container","canvas","datasets","dataset","borderColor","borderWidth","responsive","maintainAspectRatio","plugins","legend","position","display","hideLoading","showError","errorDiv","showSuccess","successHtml","successDiv","scrollTop","list","chats","chat","date","snippet","reportCount","report_count","badgeHtml","id","li","currentTarget","chatId","loadChatMessages","reports_generated_this_month","listItem","credit_data","checkAndShowCreditLimitWarning","messages","msg","tag","sender_type","nextMsg","body","prevMsg","reports","insertReportLinkInChat","lastMsg","$msg","message_after_id","linkHtml","toLocaleTimeString","$linkMsg","after","input","rawValue","trim","$userMsg","trigger","userInfo","contentType","stringify","chat_id","user_name","showResendIconOnMessage","addChatToChatHistory","refreshSubscriptionInfo","err","status","clearAuthData","updateSendMessageandCreateNewChatButton","firstMessage","initializeCharts","userName","admin_name","each","isCreditExceeded","limit","basicExceeded","premiumExceeded","totalExceeded","basicUsed","basicLimit","premiumUsed","premiumLimit","totalUsed","totalLimit","async","fetch","M","cfg","wwwroot","now","headers","json","plan_name","plan_exports_limit","total_credits_used_this_month","plan_total_credits_limit","exports_used","exports_remaining","updateSubscription","subscriptionHtml","calculateUsagePercentage","assistantHtml","tabNav","replaceWith","mainTitle","first","tabContainer","closest","parent","off","$btn","$icon","transformBackendAuthData","backendData","adeptusAuthData","user_authorized","has_api_key","installation","plan","premium_credits_per_month","basic_credits_per_month","ai_credits","exports","$refreshBtn","$refreshIcon","localResponse","localData","showRefreshSuccessFeedback","showRefreshErrorFeedback","percentage","Math","min","Promise","reject","Error","authHeaders","getAuthHeaders","ajax","validateToken","resendMessage","$msgElem","slice","showNextMCQ","next","shift","show","String","fromCharCode","selected","sendMCQ","answer","tab","attr","callback","warn","xhr","statusBadge","getStatusBadge","rep","r","updateReportsView","fetchAndDisplayReport","reportSlug","rowElem","reportsView","findIndex","Object","assign","displayReport","reportChartInstance","reportGraphInstance","_vteController","types","typeLabels","chart","graph","typeIcons","controlsHtml","active","display_type","displayHtml","isActive","renderReportData","_pendingTableId","VTE","enhance","perPageOptions","search","start","end","noData","initialType","chartEl","keys","labelKey","h","valueKey","test","endsWith","values","getContext","replace","l","graphEl","iconButtons","t","$el","saveDisplayType","exportReport","tableId","tableHtml","header","isNumeric","every","isNaN","parseFloat","isDate","some","badgeClass","getStatusBadgeClass","reportRow","originalContent","reportIndex","errorMessage","responseJSON","responseText","format","token","sessionStorage","getItem","ok","blob","close","href","URL","createObjectURL","download","click","removeChild","catch","cached","ts","pad","n","time","toDateString","yesterday","weekday","$item","$badge","current","parseInt","$newBadge","displayType","$messageElement","messageText","siblings","$lastUserMessage","showCompareDataModal","timeline","currentData","selectedA","selectedB","loadingA","loadingB","displayTypeA","displayTypeB","currentSnapshotId","compareDataA","compareDataB","currentDataFetched","nextSection","fetchSnapshotData","snapId","section","cb","renderSections","res","getSnapshotColor","bg","border","snapIndex","s","colors","getSnapshotNote","snap","note","colorA","noteA","renderDiffTable","renderSectionA","colorB","noteB","renderSectionB","ctxA","compareChartAInstance","i","compareGraphAInstance","fill","ctxB","compareChartBInstance","compareGraphBInstance","renderModal","update","selectedAId","selectedBId","index","selectedStyle","isCurrent","is_current_version","dragDisabled","dragTitle","dragText","renderTimeline","originalEvent","dataTransfer","setData","getData","target","heightAuto","customClass","popup","aId","bId","a","b","snapshots","diff"],"mappings":"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"}