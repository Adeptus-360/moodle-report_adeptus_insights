define(["jquery","core/ajax","core/notification","core/chartjs","core/templates","report_adeptus_insights/auth_utils"],(function(e,t,a,n,s,r){var i=window.Swal,o={currentChatId:0,currentMCQ:null,isSending:!1,mcqQueue:[],reportsDataTable:null,cachedReports:[],cachedCategories:[],_initCalled:!1,isCreditLimitExceeded:!1,backendUrl:"https://backend.adeptus360.com/api/v1",isFreePlan:!0,_currentReportView:"table",_currentReportData:null,_currentReportName:"",currentViewedReport:null,currentViewedReportData:null,init:function(t,a){if(this.isFreePlan=!1!==a,this._initCalled)return;this._initCalled=!0,this.currentChatId=0;const n=()=>e(".assistant-header").siblings(".container-fluid").first();n().hide(),this.initializeLoaderStyles();try{r.isAuthenticated()?(this.setUserName(r.getAuthStatus()?.user?.name||"User"),this.updateSubscriptionInfo(),this.setupEventListeners(),this.loadChatHistory(),this.loadReportsHistory(),this.loadCategories(),n().fadeIn(200)):(r.refreshAuthStatus(),setTimeout((()=>{r.isAuthenticated()?(this.setUserName(r.getAuthStatus()?.user?.name||"User"),this.updateSubscriptionInfo(),this.setupEventListeners(),this.loadChatHistory(),this.loadReportsHistory(),this.loadCategories(),n().fadeIn(200)):this.showAuthenticationError()}),500))}catch(e){console.error("[AI Assistant] Failed to initialize authentication:",e),this.setupEventListeners(),n().fadeIn(200)}},initializeLoaderStyles:function(){0===e("#ai-loader-styles").length&&e("head").append('\n                    <style id="ai-loader-styles">\n                        .ai-thinking-loader-wrapper {\n                            animation: fadeInLoader 0.3s ease-out forwards;\n                        }\n\n                        .ai-thinking-loader {\n                            opacity: 1 !important;\n                        }\n\n                        @keyframes bounce-loader {\n                            0%, 80%, 100% {\n                                transform: scale(0.8);\n                                opacity: 0.5;\n                            }\n                            40% {\n                                transform: scale(1.2);\n                                opacity: 1;\n                            }\n                        }\n\n                        @keyframes fadeInLoader {\n                            from {\n                                opacity: 0;\n                                transform: translateY(10px);\n                            }\n                            to {\n                                opacity: 1;\n                                transform: translateY(0);\n                            }\n                        }\n\n                        @keyframes pulse-glow-loader {\n                            0% {\n                                box-shadow: 0 0 0 0 rgba(14, 165, 233, 0.4);\n                            }\n                            70% {\n                                box-shadow: 0 0 0 8px rgba(14, 165, 233, 0);\n                            }\n                            100% {\n                                box-shadow: 0 0 0 0 rgba(14, 165, 233, 0);\n                            }\n                        }\n                    </style>\n                ')},showAuthenticationError:function(){e(".assistant-header").siblings(".container-fluid").first().html('\n                <div class="alert alert-danger">\n                    <h4>Authentication Required</h4>\n                    <p>You need to be authenticated to use the AI Assistant. Please contact your administrator for assistance.</p>\n                    <button class="btn btn-primary" onclick="location.reload()">Refresh Page</button>\n                </div>\n            ').show()},setupEventListeners:function(){e("#send-button").on("click",(()=>this.sendMessage())),e("#message-input").on("keydown",(e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),this.sendMessage())})),e("#chart-type").on("change",(()=>this.updateChart())),e("#message-input").on("input",(function(){this.style.height="auto",this.style.height=this.scrollHeight+"px"})),e("#create-new-chat").on("click",(()=>this.createNewChat()))},isSending:!1,renderMCQ:function(t){this.currentMCQ=t;var a=e("#mcq-container").empty();a.append(`<p><strong>${t.question}</strong></p>`),t.options.forEach((e=>{a.append(`\n                  <div class="form-check">\n                    <input class="form-check-input" type="radio"\n                           name="mcq-option" id="mcq-${e.key}"\n                           value="${e.key}">\n                    <label class="form-check-label" for="mcq-${e.key}">\n                      ${e.key}. ${e.label}\n                    </label>\n                  </div>`)})),a.append('<button id="mcq-cancel" class="btn btn-link">Cancel</button>')},clearMCQ:function(){this.currentMCQ=null,e("#mcq-container").empty().hide(),e("#message-input").prop("disabled",!1),e("#send-button").prop("disabled",!1)},extractMCQFromText:function(e){if(!e||"string"!=typeof e)return null;try{const t=e.match(/```json\s*(\[[\s\S]*?\])\s*```/);if(t){const e=JSON.parse(t[1]);if(Array.isArray(e)&&e.length>0&&"mcq"===e[0].type)return{questions:e,selectedAnswer:null}}const a=e.match(/\{[\s\S]*?\}/g)||[],n=[];if(a.forEach((e=>{try{const t=JSON.parse(e);"mcq"===t.type&&Array.isArray(t.options)&&n.push(t)}catch(e){}})),n.length>0)return{questions:n,selectedAnswer:null}}catch(e){}return null},renderMCQHistory:function(e,t=null){let a='<div class="mcq-history-container" style="display:flex; flex-direction:column; gap:15px;">';return e.forEach(((e,n)=>{a+=`\n                    <div class="mcq-history-item" style="background:#f8f9fa; padding:15px; border-radius:8px; border:1px solid #dee2e6; box-shadow:0 1px 3px rgba(0,0,0,0.05);">\n                        <p style="font-weight:600; margin-bottom:12px; color:#333; font-size:14px;">\n                            <i class="fa fa-question-circle" style="color:#007bff; margin-right:8px;"></i>${e.question}\n                        </p>\n                        <div class="mcq-options" style="margin-left:24px;">\n                `,e.options.forEach(((e,s)=>{const r="string"==typeof e?e:e.label||e,i=t&&(t===e||t===r||t.includes(r));a+=`\n                        <div class="form-check" style="padding:10px 14px; border-radius:6px; margin-bottom:8px; ${i?"background:#e3f0ff; border:2px solid #007bff; font-weight:600;":"border:1px solid #ced4da;"} transition:all 0.2s;">\n                            <input class="form-check-input" type="radio" name="mcq-${n}" disabled ${i?"checked":""} style="margin-top:0.3em;">\n                            <label class="form-check-label" style="color:#555; cursor:not-allowed; margin-left:5px;">\n                                ${i?'<i class="fa fa-check-circle" style="color:#28a745; margin-right:5px;"></i>':""}${r}\n                            </label>\n                        </div>\n                    `})),a+='\n                        </div>\n                        <p style="margin-top:12px; margin-bottom:0; font-size:11px; color:#6c757d; font-style:italic;">\n                            <i class="fa fa-info-circle" style="margin-right:4px;"></i>Previous question from chat history\n                        </p>\n                    </div>\n                '})),a+="</div>",a},checkAuth:function(){return r.isAuthenticated()?(this.loadChatHistory(),!0):(this.showAuthenticationError(),!1)},handleResponse:function(t){if(t.error){if("credit_limit"===t.error_type||"token_limit"===t.error_type)return void this.handleCreditLimitError(t.message);this.addMessage(t.message,"error"),this.showResendIconOnLastUserMessage()}else{if("mcq"===t.type){if(t.questions&&t.questions.length>0){const e=t.questions[0],a=`Question: ${e.question}\nOptions: ${e.options.join(", ")}`;this.addMessage(a,"ai",!1,null,null,null,t.credit_info)}return void this.enqueueMCQs(t.questions)}if("sql"===t.type||"report"===t.type){if(t.awaiting_confirmation&&t.report){const e=t.sql||t.report.sql_query||t.report.sql;return!t.execution_required&&t.report_data||!e?void this.showReportConfirmation(t.report,t.report_data||null,t.message,t.credit_info,t.execution_error||null):void this.executeReportLocally(e,t.report.params||{}).then((e=>{this.showReportConfirmation(t.report,e.data||null,t.message,t.credit_info,e.error||null)})).catch((e=>{this.showReportConfirmation(t.report,null,t.message,t.credit_info,e.message||"Failed to execute report locally")}))}const a=t.report||t;return this.addMessage(a.description||t.message,"ai",!0,a,null,null,t.credit_info),this.updateChatHistoryBadge(this.currentChatId),this.cachedReports.unshift(a),this.updateReportsHistory(this.cachedReports),this.reportsDataTable&&(this.reportsDataTable.destroy(),this.reportsDataTable=null),setTimeout((()=>{try{const t=document.getElementById("reports-history-table");if(t){const a=t.querySelector("thead"),n=t.querySelector("tbody");if(a&&n&&a.rows.length>0&&a.rows[0].cells.length>0){const t=a.rows[0].cells.length,s=n.rows;let r=0;s.length>0&&(r=s[0].cells.length),t===r&&t>0&&s.length>0&&!s[0].cells[0].textContent.includes("No reports")&&(this.reportsDataTable=new simpleDatatables.DataTable("#reports-history-table",{searchable:!0,fixedHeight:!1,perPage:10,loading:!1}),setTimeout((()=>{e(".datatable-wrapper").removeClass("datatable-loading"),e("#report-history-table-wrapper .datatable-wrapper").removeClass("datatable-loading")}),100))}}}catch(e){console.error("Error reinitializing DataTable:",e)}}),100),void i.fire({title:"Generating Report",html:'\n                        <div class="text-center">\n                            <div class="spinner-border text-primary mb-3" role="status">\n                            </div>\n                            <p>Please wait while we generate your report...</p>\n                        </div>\n                    ',showConfirmButton:!1,allowOutsideClick:!1,allowEscapeKey:!1,timer:2e3,timerProgressBar:!0}).then((()=>{this.switchToReportsTab(),this.displayCurrentReport(t.report),this.executeReport(t.report.slug)}))}this.addMessage(t.message,"ai",!1,null,null,null,t.credit_info)}t.data&&this.updateReportData(t.data),t.visualizations&&this.updateVisualizations(t.visualizations),t.credit_info&&this.showCreditUsageFeedback(t.credit_info),this.scrollToBottom()},showCreditUsageFeedback:function(t){if(!t)return;const a=e(`\n                <div class="credit-usage-notification" style="\n                    position: fixed;\n                    top: 20px;\n                    right: 20px;\n                    background: #28a745;\n                    color: white;\n                    padding: 12px 20px;\n                    border-radius: 6px;\n                    box-shadow: 0 4px 12px rgba(0,0,0,0.15);\n                    z-index: 9999;\n                    font-size: 14px;\n                    font-weight: 500;\n                    opacity: 0;\n                    transform: translateX(100%);\n                    transition: all 0.3s ease;\n                ">\n                    <i class="fa fa-coins me-2"></i>\n                    <span class="credit-text">Credits used: ${t.credits_charged||0} (${t.credit_type||"basic"})</span>\n                </div>\n            `);e("body").append(a),setTimeout((()=>{a.css({opacity:"1",transform:"translateX(0)"})}),100),setTimeout((()=>{a.css({opacity:"0",transform:"translateX(100%)"}),setTimeout((()=>{a.remove()}),300)}),3e3),this.updateSubscriptionInfoWithCreditUsage(t)},updateSubscriptionInfoWithCreditUsage:function(e){const t=r.getAuthStatus();if(!t||!t.subscription)return;const a=t.subscription,n=e.credits_charged||0;"premium"===e.credit_type?a.premium_credits_used_this_month=(a.premium_credits_used_this_month||0)+n:a.basic_credits_used_this_month=(a.basic_credits_used_this_month||0)+n,a.ai_credits_used_this_month=(a.ai_credits_used_this_month||0)+n,this.animateCreditCounterUpdate(e.credit_type,n),this.updateSubscriptionInfo()},animateCreditCounterUpdate:function(t,a){const n=e("premium"===t?".premium-credits-counter":".basic-credits-counter");n.length&&(n.addClass("credit-update-highlight"),setTimeout((()=>{n.removeClass("credit-update-highlight")}),1e3));const s=e(".total-credits-counter");s.length&&(s.addClass("credit-update-highlight"),setTimeout((()=>{s.removeClass("credit-update-highlight")}),1e3))},addMessage:function(t,a,n=!1,s=null,r=null,i=null,o=null){"ai"===a&&t&&(t=t.replace(/\nConfidence:\s*\d+%\n?/gi,"\n").replace(/Confidence:\s*\d+%/gi,"").trim());const l=document.getElementById("message-template").content.cloneNode(!0),d=l.querySelector(".message");d.classList.add(a+"-message"),r&&d.setAttribute("data-message-id",r);const c=this.extractMCQFromText(t);if(c&&c.questions.length>0){const e=this.renderMCQHistory(c.questions,c.selectedAnswer);l.querySelector(".message-text").innerHTML=e}else if(n&&s){l.querySelector(".message-text").innerHTML=`\n                    <a href="javascript:void(0)"\n                       class="report-link"\n                       data-report-slug="${s.slug}"\n                       style="color: #007bff; text-decoration: none; cursor:pointer; padding:4px 8px; border:1px solid #dee2e6; border-radius:4px; background:#f8f9fa; display:inline-block; transition:all 0.2s;">\n                        ðŸ“Š ${t}\n                    </a>\n                `;const a=this;setTimeout((()=>{const t=d.querySelector(".report-link");t.onclick=function(){a.openReportFromLink(t.getAttribute("data-report-slug"))},t.onmouseenter=function(){e(this).css({"background-color":"#e9ecef","border-color":"#adb5bd",transform:"translateY(-1px)"})},t.onmouseleave=function(){e(this).css({"background-color":"#f8f9fa","border-color":"#dee2e6",transform:"translateY(0)"})}}),0)}else if("report-preview"===a||"system-action"===a)l.querySelector(".message-text").innerHTML=t,d.classList.add(a+"-message"),("report-preview"===a||"system-action"===a)&&(d.style.background="transparent",d.style.padding="0",d.style.border="none",d.style.maxWidth="100%");else if("ai"===a&&this.isMultipleChoiceQuestion(t)){const e=this.renderMultipleChoiceOptions(t);l.querySelector(".message-text").innerHTML=e}else l.querySelector(".message-text").textContent=t;"ai"===a&&o&&this.addCreditInfoToMessage(l,o);return l.querySelector(".message-time").textContent=this.formatTimestamp(i||(new Date).toISOString()),e("#chat-container").append(l),this.scrollToBottom(),e(d)},addCreditInfoToMessage:function(e,t){const a=e.querySelector(".message"),n=document.createElement("div");n.className="credit-info-badge",n.style.cssText="\n                display: inline-block;\n                margin-left: 8px;\n                padding: 2px 6px;\n                border-radius: 12px;\n                font-size: 11px;\n                font-weight: 500;\n                text-transform: uppercase;\n                letter-spacing: 0.5px;\n            ","premium"===t.credit_type?(n.style.backgroundColor="#6f42c1",n.style.color="white",n.textContent="Premium"):(n.style.backgroundColor="#28a745",n.style.color="white",n.textContent="Basic"),n.title=`${t.credit_type.toUpperCase()} Response\nTokens: ${t.tokens_used}\nCredits: ${t.credits_charged}\nProvider: ${t.provider}`;a.querySelector(".message-text").appendChild(n)},isMultipleChoiceQuestion:function(e){const t=e.match(/^[A-Z][\.\)]\s+.+$/gim),a=e.match(/^[1-9][0-9]*[\.\)]\s+.+$/gm);if(t&&t.length>=2){const e=t.map((e=>e.match(/^([A-Z])/i)[1].toUpperCase())),a=e[0].charCodeAt(0);let n=!0;for(let t=1;t<Math.min(e.length,4);t++)if(e[t].charCodeAt(0)!==a+t){n=!1;break}return n}if(a&&a.length>=2){const e=a.map((e=>parseInt(e.match(/^([0-9]+)/)[1])));let t=!0;for(let a=1;a<Math.min(e.length,4);a++)if(e[a]!==e[0]+a){t=!1;break}return t}return!1},renderMultipleChoiceOptions:function(e){const t=this,a=e.split("\n");let n=[],s=[];a.forEach((e=>{const t=e.trim(),a=t.match(/^([A-Z])[\.\)]\s+(.+)$/i),r=t.match(/^([1-9][0-9]*)[\.\)]\s+(.+)$/);a?s.push({letter:a[1].toUpperCase(),text:a[2].trim(),isLetter:!0}):r?s.push({letter:r[1],text:r[2].trim(),isLetter:!1}):t&&n.push(t)}));let r='<div class="mcq-question-container">';return r+='<div class="mcq-question-text" style="margin-bottom: 15px; white-space: pre-wrap;">',r+=this.escapeHtml(n.join("\n")),r+="</div>",s.length>0&&(r+='<div class="mcq-options-grid" style="display: grid; gap: 10px; grid-template-columns: 1fr;">',s.forEach((e=>{const t="mcq-option-"+Date.now()+"-"+e.letter;r+=`\n                        <button class="mcq-option-button"\n                                data-option="${e.letter}"\n                                id="${t}"\n                                style="\n                                    padding: 12px 16px;\n                                    display: flex;\n                                    align-items: center;\n                                    gap: 12px;\n                                    font-size: 14px;\n                                    line-height: 1.5;\n                                    color: #333;\n                                    min-height: 50px;\n                                ">\n                            <span class="mcq-option-letter" style="\n                                background: linear-gradient(135deg, #0ea5e9 0%, #2563eb 100%);\n                                color: white;\n                                width: 32px;\n                                height: 32px;\n                                border-radius: 50%;\n                                display: flex;\n                                align-items: center;\n                                justify-content: center;\n                                font-weight: bold;\n                                flex-shrink: 0;\n                            ">${e.letter}</span>\n                            <span class="mcq-option-text" style="flex: 1;">${this.escapeHtml(e.text)}</span>\n                        </button>\n                    `})),r+="</div>"),r+="</div>",setTimeout((()=>{document.querySelector("#chat-container").querySelectorAll(".mcq-option-button:not([data-handler-attached])").forEach((e=>{e.setAttribute("data-handler-attached","true"),e.addEventListener("click",(function(){if(this.disabled)return;const e=this.getAttribute("data-option"),a=s.find((t=>t.letter===e));this.closest(".mcq-question-container").querySelectorAll(".mcq-option-button").forEach((e=>{e.disabled=!0,e.classList.add("disabled")})),this.classList.add("selected");let n;this.querySelector(".mcq-option-letter").innerHTML="âœ“",n=(a.isLetter,`${e}. ${a.text}`),t.sendMessage(n)}))}))}),100),r},escapeHtml:function(e){const t={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"};return e.replace(/[&<>"']/g,(e=>t[e]))},handleCreditLimitError:function(e,t=null){t&&t.summary&&this.updateSubscriptionDataFromCreditResponse(t),this.isCreditLimitExceeded=!0,this.updateSendMessageandCreateNewChatButton(),this.showPersistentCreditLimitMessage(e),this.addMessage(e,"error"),i.fire({icon:"warning",title:"Token Limit Reached",html:`\n                    <div class="text-center">\n                        <p>${e}</p>\n                        <p class="text-muted">Your monthly token allowance has been used up.</p>\n                        <p class="text-muted">Tokens reset on the 1st of each month.</p>\n                    </div>\n                `,showCancelButton:!0,confirmButtonText:"View Usage",cancelButtonText:"Close",confirmButtonColor:"#007bff"}).then((e=>{e.isConfirmed&&this.showCreditUsageModal()}))},updateSubscriptionDataFromCreditResponse:function(e){const t=r.getAuthStatus();if(!t||!t.subscription)return;const a=t.subscription;void 0!==e.tokens_used&&(a.tokens_used=e.tokens_used),void 0!==e.tokens_limit&&(a.tokens_limit=e.tokens_limit),void 0!==e.tokens_remaining&&(a.tokens_remaining=e.tokens_remaining),r.setAuthStatus(t),this.updateSubscriptionInfo()},handleTimeoutError:function(t){this.addMessage(t,"error"),i.fire({icon:"info",title:"AI Service Busy",html:`\n                    <div class="text-center">\n                        <p>${t}</p>\n                        <p class="text-muted">The AI service is experiencing high demand. Please try again in a moment.</p>                                                                                       \n                    </div>\n                `,showCancelButton:!0,confirmButtonText:"Try Again",cancelButtonText:"Cancel",confirmButtonColor:"#007bff",cancelButtonColor:"#6c757d"}).then((t=>{t.isConfirmed&&e("#message-input").focus()}))},showPersistentCreditLimitMessage:function(t){e(".credit-limit-alert").remove();const a=`\n                <div class="alert alert-danger credit-limit-alert" role="alert" style="margin: 10px 0; border-left: 4px solid #dc3545; background-color: #f8d7da; border-color: #f5c6cb;">\n                    <div class="d-flex align-items-center">\n\n                        <div class="flex-grow-1">\n                            <strong class="text-danger">Token Limit Reached</strong><br>\n                            <small class="text-muted">${t}</small>\n                        </div>\n                        <div class="ms-3">\n                            <button type="button" class="btn btn-sm btn-outline-danger me-2" onclick="window.assistant.showCreditUsageModal()">\n                                <i class="fas fa-chart-bar me-1"></i> View Usage\n                            </button>\n\n                        </div>\n                    </div>\n                </div>\n            `;var n=e(".main-inner");n.length>=2?n.eq(1).before(a):1===n.length?n.eq(0).before(a):e("body").prepend(a)},hidePersistentCreditLimitMessage:function(){e(".credit-limit-alert").fadeOut(300,(function(){e(this).remove()}))},showCreditUsageModal:function(){i.fire({title:"Loading Usage Data...",text:"Please wait while we fetch your usage information",allowOutsideClick:!1,showConfirmButton:!1,willOpen:()=>{i.showLoading()}}),this.ajaxWithAuth({url:this.backendUrl+"/chat/credits/detailed-usage",method:"GET",success:e=>{e.success?this.displayDetailedUsageModal(e.data):i.fire("Error","Failed to load usage information","error")},error:()=>{i.fire("Error","Failed to load usage information","error")}})},displayDetailedUsageModal:function(e){const t=e.summary,a=e.usage||[],n=e.pagination||{total:0},s=e=>e>=1e6?(e/1e6).toFixed(1)+"M":e>=1e3?(e/1e3).toFixed(1)+"K":e.toString(),r=t.tokens_limit>0&&-1!==t.tokens_remaining?Math.min(100,Math.round(t.total_tokens_used/t.tokens_limit*100)):0,o=-1===t.tokens_remaining?"Unlimited":s(t.tokens_limit),l=`\n                <div class="detailed-usage-modal" style="font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">\n                    \x3c!-- Header with close button --\x3e\n                    <div class="usage-modal-header mb-3" style="background: linear-gradient(135deg, #0f6cbf 0%, #3a8dd4 100%); padding: 16px 20px; border-radius: 10px; color: white; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">\n                        <div class="d-flex justify-content-between align-items-center">\n                            <h5 class="mb-0" style="color: white; font-weight: 600;">\n                                <i class="fas fa-chart-line me-2"></i> Token Usage Dashboard\n                            </h5>\n                            <button type="button" class="usage-modal-close-btn" onclick="Swal.close()" style="background: rgba(255,255,255,0.2); border: none; color: white; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s ease;">\n                                <i class="fas fa-times" style="font-size: 14px;"></i>\n                            </button>\n                        </div>\n                    </div>\n\n                    \x3c!-- Summary Cards with proper spacing --\x3e\n                    <div class="row mb-3 g-2">\n                        <div class="col-md-3">\n                            <div class="card border-0 h-100" style="background: linear-gradient(135deg, #0ea5e9 0%, #2563eb 100%); color: white; border-radius: 12px; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);">\n                                <div class="card-body text-center" style="padding: 16px 12px;">\n                                    <h6 class="card-title mb-2" style="font-weight: 600; opacity: 0.9; font-size: 0.85rem;">Monthly Usage</h6>\n                                    <div class="d-flex align-items-center justify-content-center mb-2">\n                                        <i class="fas fa-chart-pie me-2" style="opacity: 0.8; font-size: 1.2rem;"></i>\n                                        <span style="font-weight: 700; font-size: 1.5rem;">${r}%</span>\n                                    </div>\n                                    <small style="opacity: 0.8; font-size: 0.75rem;">${s(t.total_tokens_used)} / ${o}</small>\n                                </div>\n                            </div>\n                        </div>\n                        <div class="col-md-3">\n                            <div class="card border-0 h-100" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; border-radius: 12px; box-shadow: 0 4px 12px rgba(17, 153, 142, 0.2);">\n                                <div class="card-body text-center" style="padding: 16px 12px;">\n                                    <h6 class="card-title mb-2" style="font-weight: 600; opacity: 0.9; font-size: 0.85rem;">Tokens Used</h6>\n                                    <div class="d-flex align-items-center justify-content-center mb-2">\n                                        <i class="fas fa-code me-2" style="opacity: 0.8; font-size: 1.2rem;"></i>\n                                        <span style="font-weight: 700; font-size: 1.5rem;">${s(t.total_tokens_used)}</span>\n                                    </div>\n                                    <small style="opacity: 0.8; font-size: 0.75rem;">This Billing Period</small>\n                                </div>\n                            </div>\n                        </div>\n                        <div class="col-md-3">\n                            <div class="card border-0 h-100" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; border-radius: 12px; box-shadow: 0 4px 12px rgba(240, 147, 251, 0.2);">\n                                <div class="card-body text-center" style="padding: 16px 12px;">\n                                    <h6 class="card-title mb-2" style="font-weight: 600; opacity: 0.9; font-size: 0.85rem;">Total Requests</h6>\n                                    <div class="d-flex align-items-center justify-content-center mb-2">\n                                        <i class="fas fa-paper-plane me-2" style="opacity: 0.8; font-size: 1.2rem;"></i>\n                                        <span style="font-weight: 700; font-size: 1.5rem;">${t.total_requests}</span>\n                                    </div>\n                                    <small style="opacity: 0.8; font-size: 0.75rem;">Messages Processed</small>\n                                </div>\n                            </div>\n                        </div>\n                        <div class="col-md-3">\n                            <div class="card border-0 h-100" style="background: linear-gradient(135deg, #ff6b6b 0%, #ffa500 100%); color: white; border-radius: 12px; box-shadow: 0 4px 12px rgba(255, 107, 107, 0.2);">\n                                <div class="card-body text-center" style="padding: 16px 12px;">\n                                    <h6 class="card-title mb-2" style="font-weight: 600; opacity: 0.9; font-size: 0.85rem;">Today's Tokens</h6>\n                                    <div class="d-flex align-items-center justify-content-center mb-2">\n                                        <i class="fas fa-calendar-day me-2" style="opacity: 0.8; font-size: 1.2rem;"></i>\n                                        <span style="font-weight: 700; font-size: 1.5rem;">${s(t.today_tokens_used||0)}</span>\n                                    </div>\n                                    <small style="opacity: 0.8; font-size: 0.75rem;">Tokens Used Today</small>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n\n                    \x3c!-- Compact Data Table --\x3e\n                    <div class="card border-0" style="border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.06);">\n                        <div class="card-header" style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-radius: 12px 12px 0 0; border: none; padding: 12px 16px;">\n                            <div class="d-flex justify-content-between align-items-center">\n                                <h6 class="mb-0" style="font-weight: 600; color: #333;">\n                                    Detailed Usage History\n                                </h6>\n                                <span class="badge bg-primary" style="font-size: 0.7rem; padding: 4px 8px; border-radius: 12px; color: white; background: linear-gradient(135deg, #0ea5e9 0%, #2563eb 100%);">\n                                    ${a.length} of ${n.total} records\n                                </span>\n                            </div>\n                        </div>\n                        <div class="card-body p-0">\n                            <div class="table-responsive">\n                                <table id="usage-datatable" class="table table-hover mb-0" style="font-size: 0.9rem;">\n                                    <thead style="background: linear-gradient(135deg, #0ea5e9 0%, #2563eb 100%); color: white;">\n                                        <tr>\n                                            <th style="border: none; padding: 15px 12px; font-weight: 600; text-align: center;">Date</th>\n                                            <th style="border: none; padding: 15px 12px; font-weight: 600; text-align: center;">Action</th>\n                                            <th style="border: none; padding: 15px 12px; font-weight: 600; text-align: center;">Model</th>\n                                            <th style="border: none; padding: 15px 12px; font-weight: 600; text-align: center;">Input</th>\n                                            <th style="border: none; padding: 15px 12px; font-weight: 600; text-align: center;">Output</th>\n                                            <th style="border: none; padding: 15px 12px; font-weight: 600; text-align: center;">Total Tokens</th>\n                                        </tr>\n                                    </thead>\n                                    <tbody>\n                                        ${a.length>0?a.map((e=>`\n                                            <tr style="border-bottom: 1px solid #f8f9fa;">\n                                                <td style="padding: 12px; vertical-align: middle; font-weight: 500;">\n                                                    ${(()=>{const t=new Date(e.created_at);return`${t.getDate()} ${t.toLocaleString("en-US",{month:"short"})} ${t.getFullYear()} - ${t.getHours().toString().padStart(2,"0")}:${t.getMinutes().toString().padStart(2,"0")}`})()}\n                                                </td>\n                                                <td style="padding: 12px; vertical-align: middle;">\n                                                    <span class="badge ${"report_generation"===e.action_type?"bg-primary":"mcq_generation"===e.action_type?"bg-warning":"bg-success"}" style="border-radius: 20px; padding: 6px 12px; font-weight: 500;">\n                                                        <i class="fas ${"report_generation"===e.action_type?"fa-file-alt":"mcq_generation"===e.action_type?"fa-question-circle":"fa-comment"} me-1"></i>\n                                                        ${e.action_type.replace("_"," ")}\n                                                    </span>\n                                                </td>\n                                                <td style="padding: 12px; vertical-align: middle;">\n                                                    <span class="badge bg-light text-dark" style="border-radius: 20px; padding: 4px 8px;">\n                                                        ${e.model||"N/A"}\n                                                    </span>\n                                                </td>\n                                                <td style="padding: 12px; vertical-align: middle; font-weight: 500; color: #11998e;">${(e.prompt_tokens||0).toLocaleString()}</td>\n                                                <td style="padding: 12px; vertical-align: middle; font-weight: 500; color: #f5576c;">${(e.completion_tokens||0).toLocaleString()}</td>\n                                                <td style="padding: 12px; vertical-align: middle; font-weight: 600; color: #667eea;">${(e.tokens_used||0).toLocaleString()}</td>\n                                            </tr>\n                                        `)).join(""):'\n                                            <tr>\n                                                <td colspan="6" style="padding: 40px; text-align: center;">\n                                                    <div style="color: #6c757d;">\n                                                        <i class="fas fa-inbox fa-3x mb-3" style="opacity: 0.5;"></i>\n                                                        <h5 style="font-weight: 600; margin-bottom: 10px;">No Usage Data Yet</h5>\n                                                        <p style="margin: 0; font-size: 0.9rem;">Start using the AI Assistant to generate reports and your usage history will appear here.</p>\n                                                    </div>\n                                                </td>\n                                            </tr>\n                                        '}\n                                    </tbody>\n                                </table>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n            `;i.fire({html:l,width:"80%",showConfirmButton:!1,showCancelButton:!1,showCloseButton:!1,allowOutsideClick:!0,customClass:{popup:"usage-modal-popup",htmlContainer:"usage-modal-container"},didOpen:()=>{const t=document.querySelector(".usage-modal-close-btn");t&&(t.addEventListener("mouseenter",(()=>{t.style.background="rgba(255,255,255,0.3)"})),t.addEventListener("mouseleave",(()=>{t.style.background="rgba(255,255,255,0.2)"}))),this.setupUsageModalEventListeners(e)}})},setupUsageModalEventListeners:function(t){const a=this;let n=t.filters;a.usageDataTable=null,setTimeout((()=>{if("undefined"!=typeof simpleDatatables&&simpleDatatables.DataTable)if(e("#usage-datatable").length)try{const e=document.getElementById("usage-datatable");if(e){const t=e.querySelector("tbody");t&&t.rows.length>0&&(a.usageDataTable=new simpleDatatables.DataTable("#usage-datatable",{searchable:!0,fixedHeight:!1,perPage:25,perPageSelect:[10,25,50,100],sortable:!0,labels:{placeholder:"Search usage history...",noRows:"No usage data found",info:"Showing {start} to {end} of {rows} entries"}}))}}catch(e){console.error("Error initializing Simple DataTable:",e),console.error("Error details:",e.message,e.stack)}else console.error("Usage datatable element not found");else console.error("simpleDatatables library not available")}),500),e("#apply-filters").on("click",(function(){const t=e("#user-filter").val(),s=e("#credit-type-filter").val(),r=e("#start-date-filter").val(),i=e("#end-date-filter").val();n={user_id:t,credit_type:s,start_date:r,end_date:i},a.loadUsageDataWithFilters(n,1)})),e("#clear-filters").on("click",(function(){e("#user-filter").val(""),e("#credit-type-filter").val(""),e("#start-date-filter").val(""),e("#end-date-filter").val(""),n={},a.loadUsageDataWithFilters({},1)})),e(".quick-filter").on("click",(function(){const t=e(this).data("period"),s=new Date;let r="",i=s.toISOString().split("T")[0];switch(t){case"today":r=i;break;case"week":const e=new Date(s);e.setDate(s.getDate()-7),r=e.toISOString().split("T")[0];break;case"month":const t=new Date(s);t.setMonth(s.getMonth()-1),r=t.toISOString().split("T")[0]}e("#start-date-filter").val(r),e("#end-date-filter").val(i),n={user_id:e("#user-filter").val(),credit_type:e("#credit-type-filter").val(),start_date:r,end_date:i},a.loadUsageDataWithFilters(n,1)}))},loadUsageDataWithFilters:function(e,t=1){i.fire({title:"Loading...",text:"Applying filters and loading data",allowOutsideClick:!1,showConfirmButton:!1,willOpen:()=>{i.showLoading()}});const a=new URLSearchParams;e.user_id&&a.append("user_id",e.user_id),e.credit_type&&a.append("credit_type",e.credit_type),e.start_date&&a.append("start_date",e.start_date),e.end_date&&a.append("end_date",e.end_date),a.append("page",t),a.append("per_page",1e3),this.ajaxWithAuth({url:`${this.backendUrl}/chat/credits/detailed-usage?${a.toString()}`,method:"GET",success:e=>{e.success?this.updateUsageModalData(e.data):i.fire("Error","Failed to load filtered data","error")},error:()=>{i.fire("Error","Failed to load filtered data","error")}})},updateUsageModalData:function(t){const a=t.summary,n=t.usage;e(".detailed-usage-modal .card h2").eq(0).text(a.total_credits_used),e(".detailed-usage-modal .card h2").eq(1).text(a.total_tokens_used.toLocaleString()),e(".detailed-usage-modal .card h2").eq(2).text(a.total_requests),e(".detailed-usage-modal .card h2").eq(3).text(a.unique_users),e(".detailed-usage-modal .card h3").eq(0).text(a.premium_credits),e(".detailed-usage-modal .card h3").eq(1).text(a.basic_credits),e(".detailed-usage-modal .badge.bg-primary").text(`${n.length} of ${t.pagination.total} records`);const s=e("#usage-datatable tbody");if(s.empty(),n.forEach((e=>{const t=`\n                    <tr style="border-bottom: 1px solid #f8f9fa;">\n                        <td style="padding: 12px; vertical-align: middle; font-weight: 500;">${new Date(e.created_at).toLocaleDateString()}</td>\n                        <td style="padding: 12px; vertical-align: middle;">\n                            <span class="badge bg-light text-dark" style="border-radius: 20px; padding: 4px 8px;">\n                                ${e.user_id||"N/A"}\n                            </span>\n                        </td>\n                        <td style="padding: 12px; vertical-align: middle;">\n                            <span class="badge ${"premium"===e.credit_type?"bg-primary":"bg-success"}" style="border-radius: 20px; padding: 6px 12px; font-weight: 500;">\n                                <i class="fas ${"premium"===e.credit_type?"fa-crown":"fa-layer-group"} me-1"></i>\n                                ${e.credit_type}\n                            </span>\n                        </td>\n                        <td style="padding: 12px; vertical-align: middle; font-weight: 600; color: #667eea;">${e.credits_charged}</td>\n                        <td style="padding: 12px; vertical-align: middle; font-weight: 500;">${e.tokens_used.toLocaleString()}</td>\n                        <td style="padding: 12px; vertical-align: middle;">\n                            <span class="badge bg-info text-white" style="border-radius: 20px; padding: 4px 8px;">\n                                ${e.llm_provider}\n                            </span>\n                        </td>\n                        <td style="padding: 12px; vertical-align: middle; max-width: 200px;">\n                            <div style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${e.message_preview||"No message"}">\n                                ${e.message_preview?e.message_preview.substring(0,50)+"...":"N/A"}\n                            </div>\n                        </td>\n                    </tr>\n                `;s.append(t)})),this.usageDataTable&&"function"==typeof this.usageDataTable.refresh)try{this.usageDataTable.refresh()}catch(e){console.error("Error refreshing Simple DataTable:",e)}},updateReportData:function(t){const a=e("#report-table");a.empty();const n=e("<thead><tr></tr></thead>");t.columns.forEach((e=>{n.find("tr").append(`<th>${e}</th>`)})),a.append(n);const s=e("<tbody></tbody>");t.rows.forEach((t=>{const a=e("<tr></tr>");t.forEach((e=>{a.append(`<td>${e}</td>`)})),s.append(a)})),a.append(s)},updateVisualizations:function(t){const a=e("#chart-container");a.empty();const s=e("<canvas></canvas>");a.append(s);const r=e("#chart-type").val();new n(s[0],{type:r,data:{labels:t.labels,datasets:t.datasets.map((e=>({label:e.label,data:e.data,backgroundColor:e.backgroundColor,borderColor:e.borderColor,borderWidth:1})))},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{position:"top"},title:{display:!0,text:t.title}}}})},detectNumericColumns:function(e,t){return e&&0!==e.length?t.filter((t=>{let a=0;const n=Math.min(e.length,20);for(let s=0;s<n;s++){const n=e[s][t];if(null!=n&&""!==n){const e=parseFloat(n);!isNaN(e)&&isFinite(e)&&a++}}return a>=.5*n})):[]},generateChartColors:function(e){const t=["#2563eb","#10b981","#f59e0b","#ef4444","#8b5cf6","#06b6d4","#ec4899","#84cc16","#f97316","#6366f1","#14b8a6","#a855f7","#eab308","#22c55e","#3b82f6"],a=[];for(let n=0;n<e;n++)a.push(t[n%t.length]);return a},createReportChartConfig:function(e,t,a,n,s,r){const i={responsive:!0,maintainAspectRatio:!1,plugins:{title:{display:!0,text:r||"Report Chart",font:{size:16,weight:"bold"},padding:{top:10,bottom:20}},legend:{display:"pie"===e||"doughnut"===e,position:"right"}}};return"pie"===e||"doughnut"===e?{type:e,data:{labels:t,datasets:[{data:a,backgroundColor:s,borderColor:"#fff",borderWidth:2}]},options:i}:"line"===e?{type:"line",data:{labels:t,datasets:[{label:n,data:a,borderColor:s[0],backgroundColor:s[0]+"40",borderWidth:3,fill:!0,tension:.4}]},options:{...i,scales:{y:{beginAtZero:!0},x:{ticks:{maxRotation:45,minRotation:45}}}}}:{type:"bar",data:{labels:t,datasets:[{label:n,data:a,backgroundColor:s,borderColor:s,borderWidth:1}]},options:{...i,scales:{y:{beginAtZero:!0},x:{ticks:{maxRotation:45,minRotation:45}}}}}},renderReportChartFromSelectors:function(t,a){const s=this;if(!t||0===t.length)return;const r=e("#report-chart-type").val()||"bar",i=e("#report-chart-x-axis").val(),o=e("#report-chart-y-axis").val();if(!i||!o)return;const l=o.replace(/_/g," ").replace(/\b\w/g,(e=>e.toUpperCase())),d=t.slice(0,50),c=d.map((e=>{const t=e[i];if(null==t)return"Unknown";const a=String(t);return a.length>30?a.substring(0,30)+"...":a})),p=d.map((e=>parseFloat(e[o])||0)),h=this.generateChartColors(p.length),u=this.createReportChartConfig(r,c,p,l,h,a),g=document.getElementById("reportChart");if(g){s.reportChartInstance&&s.reportChartInstance.destroy();try{s.reportChartInstance=new n(g.getContext("2d"),u)}catch(e){console.error("Error creating chart:",e)}}},showLoading:function(){e(".ai-thinking-loader-wrapper").remove(),this.loaderShownAt=Date.now();const t=e("#chat-container");t.length>0&&(t.append('\n                <div class="message-wrapper ai-message-wrapper ai-thinking-loader-wrapper" style="margin: 10px 0;">\n                    <div class="message ai-message ai-thinking-loader" style="\n                        max-width: 70%;\n                        margin-left: 20px;\n                        padding: 15px 20px;\n                        background: linear-gradient(135deg, #f0f4f8 0%, #e9ecef 100%);\n                        border-radius: 18px 18px 18px 4px;\n                        box-shadow: 0 2px 8px rgba(0,0,0,0.08);\n                        display: flex;\n                        align-items: center;\n                        gap: 12px;\n                    ">\n                        <div class="ai-avatar-loader" style="\n                            padding: 8px 12px;\n                            background: linear-gradient(135deg, #0ea5e9 0%, #2563eb 100%);\n                            border-radius: 20px;\n                            display: flex;\n                            align-items: center;\n                            justify-content: center;\n                            color: white;\n                            font-weight: 600;\n                            font-size: 13px;\n                            flex-shrink: 0;\n                            animation: pulse-glow-loader 2s infinite;\n                            font-family: system-ui, -apple-system, sans-serif;\n                            letter-spacing: 0.5px;\n                        ">Adeptus AI</div>\n                        <div class="thinking-dots" style="\n                            display: flex;\n                            align-items: center;\n                            gap: 4px;\n                        ">\n                            <span class="thinking-text" style="\n                                color: #6c757d;\n                                font-size: 14px;\n                                margin-right: 8px;\n                                font-style: italic;\n                            ">Thinking</span>\n                            <span class="dot dot-1" style="\n                                width: 8px;\n                                height: 8px;\n                                border-radius: 50%;\n                                background: #0ea5e9;\n                                display: inline-block;\n                                animation: bounce-loader 1.4s infinite ease-in-out both;\n                                animation-delay: -0.32s;\n                            "></span>\n                            <span class="dot dot-2" style="\n                                width: 8px;\n                                height: 8px;\n                                border-radius: 50%;\n                                background: #2563eb;\n                                display: inline-block;\n                                animation: bounce-loader 1.4s infinite ease-in-out both;\n                                animation-delay: -0.16s;\n                            "></span>\n                            <span class="dot dot-3" style="\n                                width: 8px;\n                                height: 8px;\n                                border-radius: 50%;\n                                background: #0ea5e9;\n                                display: inline-block;\n                                animation: bounce-loader 1.4s infinite ease-in-out both;\n                            "></span>\n                        </div>\n                    </div>\n                </div>\n            '),this.scrollToBottom())},hideLoading:function(){const t=this.loaderShownAt?Date.now()-this.loaderShownAt:0,a=Math.max(0,800-t);setTimeout((()=>{e(".ai-thinking-loader-wrapper").fadeOut(200,(function(){e(this).remove()})),e(".ai-thinking-loader").fadeOut(200,(function(){e(this).remove()})),e("#loading-indicator").addClass("d-none")}),a)},showError:function(t){const a=e("#error-message");e("#error-text").text(t),a.removeClass("d-none"),setTimeout((()=>{a.addClass("d-none")}),5e3)},showSuccess:function(t){if(0===e("#success-message").length){const t='\n                    <div class="alert alert-success alert-dismissible fade show d-none" role="alert" id="success-message" style="position:fixed; top:20px; right:20px; z-index:1050;">\n                        <i class="fa fa-check-circle me-2"></i>\n                        <span id="success-text"></span>\n                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>\n                    </div>\n                ';e("body").append(t)}const a=e("#success-message");e("#success-text").text(t),a.removeClass("d-none"),setTimeout((()=>{a.addClass("d-none")}),3e3)},scrollToBottom:function(){const t=e("#chat-container");t.scrollTop(t[0].scrollHeight)},loadChatHistory:function(){const t=e("#chat-history-list");t.html('\n                <li class="list-group-item d-flex justify-content-center" id="chat-history-loading">\n                    <div class="spinner-border text-secondary" role="status">\n                        <span class="sr-only">Loading...</span>\n                    </div>\n                </li>\n            '),this.ajaxWithAuth({url:this.backendUrl+"/chat/history",method:"GET",success:a=>{if(t.empty(),a&&a.chats&&Array.isArray(a.chats))if(a.chats.length)a.chats.forEach((a=>{const n=a.created_at?new Date(a.created_at).toLocaleString():"Unknown date",s=a.last_message||a.title||a.snippet||a.first_message||"Chat session",r=a.report_count||0,i=r>0?`<span class="badge bg-primary d-flex align-items-center report-count"><i class="fa fa-chart-bar me-1"></i>${r}</span>`:"";if(a.id){const r=e(`\n                                    <li class="list-group-item d-flex justify-content-between align-items-start chat-history-item" data-chat-id="${a.id}">\n                                        <div>\n                                            <small class="text-muted">${n}</small><br>\n                                            ${s}\n                                        </div>\n                                        ${i}\n                                    </li>\n                                `);t.append(r)}})),e(".chat-history-item").on("click",(t=>{const a=e(t.currentTarget),n=a.data("chat-id");this.loadChatMessages(n,a)})),0===this.currentChatId&&0===e("#chat-container").children().length&&this.showWelcomeMessage();else{const a=r.getAuthStatus();a&&a.subscription&&a.subscription.reports_generated_this_month>0?t.append('<li class="list-group-item text-center">No chats yet</li>'):(t.append('\n                                <li class="list-group-item text-center">\n                                    <div class="text-muted">\n                                        <i class="fa fa-comments fa-2x mb-2"></i>\n                                        <p class="mb-1">No chat history yet</p>\n                                        <small>Start a conversation to see your chat history here</small>\n                                    </div>\n                                </li>\n                            '),0===e("#chat-container").children().length&&this.showWelcomeMessage())}else t.append('\n                            <li class="list-group-item text-center">\n                                <div class="text-muted">\n                                    <i class="fa fa-comments fa-2x mb-2"></i>\n                                    <p class="mb-1">No chat history available</p>\n                                    <small>Start a conversation to see your chat history here</small>\n                                </div>\n                            </li>\n                        ')},error:(a,n,s)=>{console.error("[Chat History] Failed to load:",s),t.html('\n                        <li class="list-group-item text-center">\n                            <div class="text-danger">\n                                <i class="fa fa-exclamation-triangle fa-2x mb-2"></i>\n                                <p class="mb-2">Failed to load chat history</p>\n                                <button id="reload-chat-history" class="btn btn-outline-primary btn-sm">\n                                    <i class="fa fa-refresh"></i> Try Again\n                                </button>\n                            </div>\n                        </li>\n                    '),e("#reload-chat-history").on("click",(()=>this.loadChatHistory()))}})},loadChatMessages:function(t,a){this.currentChatId=t,e("#chat-history-list li").removeClass("active"),a.addClass("active"),e("#chat-container").empty(),this.clearMCQ(),this.showLoading();const n=`${this.backendUrl}/chat/${t}/messages`;this.ajaxWithAuth({url:n,method:"GET",success:t=>{this.hideLoading(),t.credit_data&&t.credit_data.summary&&this.updateSubscriptionDataFromCreditResponse(t.credit_data);const a=r.getAuthStatus();if(a&&a.subscription&&this.checkAndShowCreditLimitWarning(a.subscription),t.messages.forEach(((a,n)=>{if(a.sender_type=a.role||a.sender_type,a.body=a.content||a.body,a.timestamp=a.created_at||a.timestamp,"assistant"===a.sender_type&&(a.sender_type="ai"),"sql"===a.tag)return;if("ai"===a.sender_type&&"mcq"===a.tag){const s=t.messages[n+1],r=s&&"user"===s.sender_type?s.body:null,i=this.extractMCQFromText(a.body);if(i&&i.questions.length>0){i.selectedAnswer=r;const t=this.renderMCQHistory(i.questions,r),n=document.getElementById("message-template").content.cloneNode(!0),s=n.querySelector(".message");return s.classList.add("ai-message"),s.setAttribute("data-message-id",a.id),n.querySelector(".message-text").innerHTML=t,n.querySelector(".message-time").textContent=this.formatTimestamp(a.timestamp),void e("#chat-container").append(n)}}if("user"===a.sender_type&&n>0){const e=t.messages[n-1];if(e&&"ai"===e.sender_type&&"mcq"===e.tag)return}if(a.metadata&&"report"===a.metadata.type||a.body&&a.body.startsWith("ðŸ“Š Report saved:")){if(!a.metadata&&a.body){const e=a.body.match(/ðŸ“Š Report saved: (.+)/),t=e?e[1]:"Report",n=t.toLowerCase().replace(/\s+/g,"-").replace(/[^a-z0-9-]/g,"");a.metadata={type:"report",report_name:t,report_slug:n}}this.displayReportLink(a)}else this.addMessage(a.body,a.sender_type,!1,null,a.id,a.timestamp)})),this.scrollToBottom(),t.reports&&t.reports.length&&t.reports.forEach((e=>{this.insertReportLinkInChat(e)})),t.messages.length>0){const e=t.messages[t.messages.length-1];if("mcq"===e.tag){const t=e.body.match(/\{[\s\S]*?\}/g)||[],a=[];t.forEach((e=>{try{const t=JSON.parse(e);"mcq"===t.type&&Array.isArray(t.options)&&a.push(t)}catch(e){}})),a.length&&this.enqueueMCQs(a)}}},error:()=>{this.hideLoading(),this.showError("Could not load conversation.")}})},insertReportLinkInChat:function(t){const a=e(`#chat-container .message[data-message-id="${t.message_after_id}"]`);if(!a.length)return;const n=`\n                <div class="message ai-message">\n                  <div class="message-content">\n                    <div class="message-text">\n                      <a href="javascript:void(0)" class="report-link" data-report-slug="${t.slug}" \n                         style="color: #007bff; text-decoration: none; padding:4px 8px; border:1px solid #dee2e6; border-radius:4px; background:#f8f9fa; display:inline-block; transition:all 0.2s;">\n                        ðŸ“Š ${t.description}\n                      </a>\n                    </div>\n                    <div class="message-time small text-muted">${new Date(t.created_at).toLocaleTimeString()}</div>\n                  </div>\n                </div>\n            `,s=e(n),r=this;s.find(".report-link").on("click",(function(){const t=e(this).data("report-slug");r.openReportFromLink(t)})).on("mouseenter",(function(){e(this).css({"background-color":"#e9ecef","border-color":"#adb5bd",transform:"translateY(-1px)"})})).on("mouseleave",(function(){e(this).css({"background-color":"#f8f9fa","border-color":"#dee2e6",transform:"translateY(0)"})})),a.after(s)},sendMessage:function(t){if(this.currentMCQ)return;if(this.isSending)return;const a=e("#message-input"),n=t?String(t).trim():(a.val()||"").trim();if(!n)return void i.fire({icon:"error",title:"Oops...",text:"Please enter a message"});const s=n.trim();if(!s)return;this.isSending=!0,e(".welcome-message").remove();const o=this.addMessage(s,"user");t||a.val("").trigger("input"),this.showLoading();const l=r.getAuthStatus()?.user||{},d={message:t?`I selected: ${s}`:s,chat_id:this.currentChatId||0,user_id:l.id||null,user_name:l.name||null};this.ajaxWithAuth({url:this.backendUrl+"/chat/message",method:"POST",contentType:"application/json",data:JSON.stringify(d),success:t=>{this.hideLoading(),this.isSending=!1,t.error?"credit_limit"===t.error_type||"token_limit"===t.error_type?this.handleCreditLimitError(t.message,t.credit_data):"timeout"===t.error_type?this.handleTimeoutError(t.message):(this.addMessage(t.message,"error"),this.showResendIconOnMessage(o,s)):(e(".failed-reload-icon").remove(),!this.currentChatId&&t.chat_id&&(this.currentChatId=t.chat_id,this.addChatToChatHistory(t.chat_id,s)),this.handleResponse(t),this.refreshSubscriptionInfo())},error:e=>{if(this.hideLoading(),this.isSending=!1,401===e.status)r.clearAuthData(),this.showAuthenticationError();else{if(429!==e.status)return this.showResendIconOnMessage(o,s),void this.addMessage("Network error occurred. Please try again.","error");{let t="You have reached your credit limit. Please upgrade your plan or wait until your credits refresh.",a=null;e.responseJSON&&(t=e.responseJSON.message||t,a=e.responseJSON.credit_data||null),this.handleCreditLimitError(t,a),o.remove()}}}})},updateSendMessageandCreateNewChatButton:function(){this.isCreditLimitExceeded?(e("#send-button").prop("disabled",!0).attr("title","Credit limit reached. Your credits will reset on the 1st of next month.").addClass("credit-limit-disabled"),e("#create-new-chat").prop("disabled",!0).attr("title","Credit limit reached. Your credits will reset on the 1st of next month.").addClass("credit-limit-disabled"),e("#message-input").prop("disabled",!0).attr("placeholder","Credit limit reached. Your credits will reset on the 1st of next month.")):(e("#send-button").prop("disabled",!1).removeAttr("title").removeClass("credit-limit-disabled"),e("#create-new-chat").prop("disabled",!1).removeAttr("title").removeClass("credit-limit-disabled"),e("#message-input").prop("disabled",!1).attr("placeholder","Type your message..."))},createNewChat:function(){this.currentChatId=0,e("#chat-history-list li").removeClass("active"),e("#chat-container").empty(),this.clearMCQ(),this.showWelcomeMessage()},showWelcomeMessage:function(){e("#chat-container").html('\n                <div class="welcome-message text-center p-5">\n                    <div style="max-width: 600px; margin: 0 auto;">\n                        <h3 class="mb-4">Welcome to Adeptus AI Assistant</h3>\n                        <p class="text-muted mb-4">\n                            I\'m here to help you analyze your Moodle data and generate insightful reports.\n                        </p>\n                        <div class="row g-3">\n                            <div class="col-md-6">\n                                <div class="p-3 bg-light rounded">\n                                    <i class="fa fa-chart-bar fa-2x mb-2 text-primary"></i>\n                                    <h5>Generate Reports</h5>\n                                    <small class="text-muted">Ask me to create custom reports about courses, users, grades, and more.</small>\n                                </div>\n                            </div>\n                            <div class="col-md-6">\n                                <div class="p-3 bg-light rounded">\n                                    <i class="fa fa-question-circle fa-2x mb-2 text-info"></i>\n                                    <h5>Get Insights</h5>\n                                    <small class="text-muted">I can help you understand your data and provide actionable insights.</small>\n                                </div>\n                            </div>\n                        </div>\n                        <hr class="my-4">\n                        <p class="text-muted">\n                            <i class="fa fa-lightbulb"></i> Try asking: "Show me all active courses with their enrollment counts"\n                        </p>\n                    </div>\n                </div>\n            ')},addChatToChatHistory(t,a){const n=e("#chat-history-list");n.find('li:contains("No chat history")').remove(),n.find('li:contains("No chats yet")').remove(),n.find('li:contains("Start a conversation")').remove();const s=(new Date).toLocaleString(),r=a&&a.length>100?a.substring(0,97)+"...":a||"New chat",i=e(`<li class="list-group-item d-flex justify-content-between align-items-start chat-history-item" data-chat-id="${t}">\n                    <div>\n                        <small class="text-muted">${s}</small><br>\n                        ${r}\n                    </div>\n                </li>`);n.prepend(i),i.on("click",(t=>{const a=e(t.currentTarget),n=a.data("chat-id");this.loadChatMessages(n,a)}))},initializeCharts:function(){const t=e("#chart-container"),a=e("<canvas></canvas>");t.append(a),new n(a[0],{type:"bar",data:{labels:[],datasets:[]},options:{responsive:!0,maintainAspectRatio:!1}})},setUserName:function(t){let a="User";"string"==typeof t?a=t:t&&t.name?a=t.name:t&&t.admin_name&&(a=t.admin_name),e(".card-title").each((function(){e(this).text().includes("AI Report Assistant")&&e(this).text(a+": AI Report Assistant")}))},isCreditExceeded:function(e,t){return 0!==t&&"âˆž"!==t&&null!=t&&e>=t},checkAndShowCreditLimitWarning:function(e){const t=this.isCreditExceeded(e.basic_credits_used_this_month||0,e.plan_basic_credits_limit||0),a=this.isCreditExceeded(e.premium_credits_used_this_month||0,e.plan_premium_credits_limit||0),n=this.isCreditExceeded(e.ai_credits_used_this_month||0,e.plan_ai_credits_limit||0);if(t||a||n){const e="You've used all your AI credits for this month. Your credits will reset on the 1st of next month. Consider upgrading your plan for more credits.";this.showPersistentCreditLimitMessage(e),this.isCreditLimitExceeded=!0,this.updateSendMessageandCreateNewChatButton()}else this.isCreditLimitExceeded=!1,this.updateSendMessageandCreateNewChatButton()},updateSubscriptionInfo:async function(){try{const e=await fetch(`${M.cfg.wwwroot}/report/adeptus_insights/ajax/check_subscription_status.php?t=${Date.now()}`,{method:"GET",headers:{"Content-Type":"application/json","Cache-Control":"no-cache"}}),t=await e.json();if(t.success&&t.data){(r.getAuthStatus()||{}).subscription=t.data,"function"==typeof r.updateSubscription&&r.updateSubscription(t.data)}}catch(e){console.error("[AI Assistant] Error fetching latest subscription status:",e)}const t=r.getAuthStatus();if(t&&t.subscription){const a=t.subscription;this.checkAndShowCreditLimitWarning(a),e(".subscription-status-bar").remove();let n=`\n                    <div class="subscription-status-bar">\n                        <div class="subscription-bar-row">\n                            <div class="subscription-info-left">\n                                <h6 class="subscription-title">\n                                    <i class="fa fa-chart-line subscription-icon"></i> Subscription Status\n                                    <button class="btn btn-outline-secondary btn-sm" id="refresh-subscription-btn" title="Refresh subscription data">\n                                        <i class="fa fa-refresh"></i>\n                                    </button>\n                                </h6>\n                                <div class="subscription-details">\n                                    <span><strong>Plan:</strong> ${a.plan_name||"Unknown"}</span>\n                                    <span class="ms-3"><strong>Status:</strong> <span class="badge bg-${"active"===a.status?"success":"warning"}">${a.status||"Unknown"}</span></span>\n                                </div>\n                            </div>\n                            <div class="subscription-actions-right">\n                                <a href="javascript:void(0)" onclick="window.assistant.showCreditUsageModal()" class="btn btn-view-usage">\n                                    <i class="fa fa-chart-bar"></i> View Usage\n                                </a>\n                            </div>\n                        </div>\n                    </div>\n                `;const s=e(".assistant-header").siblings(".container-fluid").first();if(s.length)s.append(n);else{const t=e(".assistant-header");t.length&&t.after(n)}const r=this;e("#refresh-subscription-btn").off("click").on("click",(function(){const t=e(this),a=t.find("i");a.removeClass("fa-refresh").addClass("fa-spinner fa-spin"),t.prop("disabled",!0),r.refreshSubscriptionInfo(),setTimeout((()=>{a.removeClass("fa-spinner fa-spin").addClass("fa-refresh"),t.prop("disabled",!1)}),1e3)}))}else e(".subscription-info").remove()},transformBackendAuthData:function(e){if(!e)return null;return{...window.adeptusAuthData||{},user_authorized:!0,has_api_key:!0,installation:e.installation,subscription:e.subscription?{...e.subscription,premium_credits_used_this_month:e.usage&&e.usage.premium_credits_used_this_month||0,basic_credits_used_this_month:e.usage&&e.usage.basic_credits_used_this_month||0,ai_credits_used_this_month:e.usage&&e.usage.ai_credits_used_this_month||0,reports_generated_this_month:e.usage&&e.usage.reports_generated_this_month||0,plan_name:e.plan?e.plan.name:"Unknown",plan_premium_credits_limit:e.plan&&e.plan.premium_credits_per_month||0,plan_basic_credits_limit:e.plan&&e.plan.basic_credits_per_month||"âˆž",plan_ai_credits_limit:e.plan&&e.plan.ai_credits||0,plan_exports_limit:e.plan&&e.plan.exports||"âˆž"}:null,plan:e.plan,usage:e.usage}},refreshSubscriptionInfo:async function(){const t=e("#refresh-subscription-btn"),a=t.find("i");t.length&&a.length&&(a.removeClass("fa-refresh").addClass("fa-spinner fa-spin"),t.prop("disabled",!0));try{const e=await fetch(`${M.cfg.wwwroot}/report/adeptus_insights/ajax/check_subscription_status.php?t=${Date.now()}`,{method:"GET",headers:{"Content-Type":"application/json","Cache-Control":"no-cache"}}),n=await e.json();if(n.success&&n.data){(r.getAuthStatus()||{}).subscription=n.data,window.adeptusAuthData&&(window.adeptusAuthData.subscription=n.data)}await this.updateSubscriptionInfo(),this.showRefreshSuccessFeedback()}catch(e){console.error("[AI Assistant] Failed to refresh subscription info:",e),this.showRefreshErrorFeedback()}finally{t.length&&a.length&&(a.removeClass("fa-spinner fa-spin").addClass("fa-refresh"),t.prop("disabled",!1))}},showRefreshSuccessFeedback:function(){const t=e('\n                <div class="refresh-success-notification" style="\n                    position: fixed;\n                    top: 20px;\n                    right: 20px;\n                    background: #28a745;\n                    color: white;\n                    padding: 8px 16px;\n                    border-radius: 4px;\n                    box-shadow: 0 2px 8px rgba(0,0,0,0.15);\n                    z-index: 9999;\n                    font-size: 12px;\n                    opacity: 0;\n                    transform: translateY(-20px);\n                    transition: all 0.3s ease;\n                ">\n                    <i class="fa fa-check me-1"></i>\n                    Usage updated\n                </div>\n            ');e("body").append(t),setTimeout((()=>{t.css({opacity:"1",transform:"translateY(0)"})}),100),setTimeout((()=>{t.css({opacity:"0",transform:"translateY(-20px)"}),setTimeout((()=>t.remove()),300)}),2e3)},showRefreshErrorFeedback:function(){const t=e('\n                <div class="refresh-error-notification" style="\n                    position: fixed;\n                    top: 20px;\n                    right: 20px;\n                    background: #dc3545;\n                    color: white;\n                    padding: 8px 16px;\n                    border-radius: 4px;\n                    box-shadow: 0 2px 8px rgba(0,0,0,0.15);\n                    z-index: 9999;\n                    font-size: 12px;\n                    opacity: 0;\n                    transform: translateY(-20px);\n                    transition: all 0.3s ease;\n                ">\n                    <i class="fa fa-exclamation-triangle me-1"></i>\n                    Failed to update usage\n                </div>\n            ');e("body").append(t),setTimeout((()=>{t.css({opacity:"1",transform:"translateY(0)"})}),100),setTimeout((()=>{t.css({opacity:"0",transform:"translateY(-20px)"}),setTimeout((()=>t.remove()),300)}),3e3)},calculateUsagePercentage:function(e,t){if(!t||"âˆž"===t||0===t)return 0;const a=e/t*100;return Math.min(a,100)},ajaxWithAuth:function(t){if(!r.isAuthenticated())return this.showAuthenticationError(),Promise.reject(new Error("Authentication required"));const a=r.getAuthHeaders();return t.headers={...t.headers,...a},t.timeout||(t.timeout=6e4),e.ajax(t)},loadCategories:function(){const e=this;this.ajaxWithAuth({url:this.backendUrl+"/reports/categories",method:"GET",contentType:"application/json",success:t=>{t.success&&t.data&&(e.cachedCategories=t.data)},error:t=>{console.error("[AI Assistant] Failed to load categories:",t),e.cachedCategories=[{id:null,name:"General",slug:"general",color:"#6c757d",icon:"fa-folder"}]}})},getCategoryOptionsHtml:function(e){if(!this.cachedCategories||0===this.cachedCategories.length)return'<option value="">General</option>';const t=(e||"general").toLowerCase().replace(/[^a-z0-9]/g,"");return this.cachedCategories.map((e=>{const a=e.name.toLowerCase().replace(/[^a-z0-9]/g,""),n=(e.slug||"").toLowerCase().replace(/[^a-z0-9]/g,""),s=a===t||n===t;return`<option value="${e.id}" ${s?"selected":""}>${e.name}</option>`})).join("")},validateToken:function(){return r.isAuthenticated()},resendMessage:function(t,a){if(this.isSending)return;this.isSending=!0,this.showLoading();const n=r.getAuthStatus()?.user||{};this.ajaxWithAuth({url:this.backendUrl+"/chat/message",method:"POST",contentType:"application/json",data:JSON.stringify({message:a,chat_id:this.currentChatId||0,user_id:n.id||null,user_name:n.name||null}),success:n=>{this.hideLoading(),this.isSending=!1,n.error?"credit_limit"===n.error_type||"token_limit"===n.error_type?this.handleCreditLimitError(n.message,n.credit_data):(this.addMessage(n.message,"error"),this.showResendIconOnMessage(t,a)):(e(".failed-reload-icon").remove(),!this.currentChatId&&n.chat_id&&(this.currentChatId=n.chat_id,this.addChatToChatHistory(n.chat_id,a)),this.handleResponse(n))},error:e=>{this.hideLoading(),this.isSending=!1,401===e.status?(r.clearAuthData(),this.showAuthenticationError()):(this.showResendIconOnMessage(t,a),this.addMessage("Network error occurred. Please try again.","error"))}})},enqueueMCQs:function(e){Array.isArray(e)&&0!==e.length&&(this.mcqQueue=e.slice(),this.showNextMCQ())},showNextMCQ:function(){if(0===this.mcqQueue.length)return this.clearMCQ();const e=this.mcqQueue.shift();this.renderMCQ(e.question,e.options)},renderMCQ:function(t,a){this.currentMCQ=!0,e("#message-input, #send-button").prop("disabled",!0);const n=e("#mcq-container").empty().show();n.append(`<p class="mcq-question"><strong>${t}</strong></p>`),a.forEach(((e,t)=>{const a=String.fromCharCode(65+t);n.append(`\n                <div class="form-check">\n                    <input class="form-check-input" type="radio"\n                        name="mcq-option" id="mcq-${t}"\n                        value="${e}">\n                    <label class="form-check-label" for="mcq-${t}">\n                    ${a}. ${e}\n                    </label>\n                </div>`)})),n.append('<button type="button" class="btn btn-link" id="mcq-cancel">Cancel</button>'),n.find('input[name="mcq-option"]').on("change",(()=>{e("#mcq-submit").remove(),n.append('<button type="button" id="mcq-submit" class="btn btn-primary mt-2">Submit</button>'),e("#mcq-submit").off("click").on("click",(e=>{e.preventDefault(),e.stopPropagation();const t=n.find('input[name="mcq-option"]:checked').val();t&&this.sendMCQ(t)}))})),n.find("#mcq-cancel").off("click").on("click",(e=>{e.preventDefault(),this.mcqQueue=[],this.clearMCQ()}))},sendMCQ:function(t){if(this.isSending)return;if(!t||"string"!=typeof t||!t.trim())return;this.showLoading(),this.isSending=!0,this.clearMCQ();const a=this.addMessage(t,"user"),n=r.getAuthStatus()?.user||{},s=`I selected: ${t.trim()}`;this.ajaxWithAuth({url:this.backendUrl+"/chat/message",method:"POST",contentType:"application/json",data:JSON.stringify({message:s,chat_id:this.currentChatId||0,user_id:n.id||null,user_name:n.name||null}),success:n=>{this.hideLoading(),this.isSending=!1,n.error?"credit_limit"===n.error_type||"token_limit"===n.error_type?this.handleCreditLimitError(n.message):(this.addMessage(n.message,"error"),this.showResendIconOnMessage(a,t)):(e(".failed-reload-icon").remove(),this.handleResponse(n))},error:()=>{this.hideLoading(),this.isSending=!1,this.addMessage("Failed to send choice","error"),this.showResendIconOnMessage(a,t)}})},showReportConfirmation:function(e,t,a,n,s){this.addMessage(a||`I've generated a report: ${e.description}`,"ai",!1,null,null,null,n),t&&t.length>0?this.displayReportInChat(e,t):s?this.addMessage(`âš ï¸ The report could not be executed: ${s}\n\nYou can still save it and try executing it later.`,"system"):this.addMessage("â„¹ï¸ The report returned no data. You can still save it for later use.","system"),this.addReportActionButtons(e)},displayReportInChat:function(e,t){let a='<div class="report-preview-container" style="margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 8px; border: 1px solid #dee2e6;">';if(a+=`<h5 style="margin-bottom: 10px; color: #495057;">${e.name||e.description}</h5>`,t&&t.length>0){const n=Object.keys(t[0]),s=20,r=t.slice(0,s);if(a+='<div class="table-responsive">',a+='<table class="table table-sm table-striped table-hover" style="font-size: 0.9rem; margin-bottom: 0;">',a+='<thead class="table-light"><tr>',n.forEach((e=>{a+=`<th style="background: #e9ecef; white-space: nowrap;">${e.replace(/_/g," ").replace(/\b\w/g,(e=>e.toUpperCase()))}</th>`})),a+="</tr></thead><tbody>",r.forEach((e=>{a+="<tr>",n.forEach((t=>{let n=e[t]||"";n.toString().length>50&&(n=n.toString().substring(0,47)+"..."),a+=`<td>${n}</td>`})),a+="</tr>"})),a+="</tbody></table></div>",t.length>s){const e=t.length-s;a+='<div class="text-center mt-3">',a+='<p class="text-muted mb-2" style="font-size: 0.85rem;">',a+=`<strong>Showing ${s} of ${t.length} rows</strong>`,a+=` (${e} more rows available)`,a+="</p>",a+='<small class="text-info"><i class="fa fa-info-circle"></i> Save the report to view all data in the Reports panel</small>',a+="</div>"}else a+=`<p class="text-muted text-center mt-2" style="font-size: 0.85rem;">Showing all ${t.length} rows</p>`;a+='<div class="mt-3 p-2 bg-light rounded" style="font-size: 0.85rem;">',a+=`<span class="badge badge-secondary">${e.category}</span>`,a+="</div>"}a+="</div>",this.addMessage(a,"report-preview",!1)},addReportActionButtons:function(e){const t=this,a=document.querySelectorAll(".report-action-container");a.length>0&&a.forEach((e=>{e.querySelector(".fa-check-circle")||e.querySelector(".fa-info-circle")||e.querySelector(".fa-exclamation-triangle")||e.remove()}));const n="report-action-"+Date.now(),s=`\n                <div class="report-action-container" id="${n}" style="margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 8px; border: 1px solid #dee2e6;">\n                    <p style="margin-bottom: 15px; font-weight: 500;">Would you like to save this report to your Reports list?</p>\n                    <div class="report-actions" style="display: flex; gap: 10px; flex-wrap: wrap;">\n                        <button class="btn btn-primary btn-save-report" style="padding: 8px 20px;">\n                            <i class="fa fa-check-circle"></i> Save Report\n                        </button>\n                        <button class="btn btn-secondary btn-decline-report" style="padding: 8px 20px;">\n                            <i class="fa fa-times-circle"></i> Don't Save\n                        </button>\n                        <button class="btn btn-outline-secondary btn-decline-feedback" style="padding: 8px 20px;">\n                            <i class="fa fa-comment"></i> Decline & Give Feedback\n                        </button>\n                    </div>\n                </div>\n            `;this.addMessage(s,"system-action",!1),setTimeout((()=>{const a=document.getElementById(n);if(!a)return;const s=a.querySelector(".btn-save-report");s&&!s.hasAttribute("data-handler-attached")&&(s.setAttribute("data-handler-attached","true"),s.addEventListener("click",(function(){const n=t.getCategoryOptionsHtml(e.category),s=e.name||e.description||"SCORM Activities Report";i.fire({title:"Save Your Report",html:`\n                                <div style="text-align: left;">\n                                    <div style="margin-bottom: 15px;">\n                                        <label for="swal-report-name" style="display: block; margin-bottom: 5px; font-weight: 500;">\n                                            Report Name\n                                        </label>\n                                        <input type="text" id="swal-report-name" class="swal2-input"\n                                               placeholder="e.g., Monthly Student Progress Report"\n                                               value="${s.replace(/"/g,"&quot;")}"\n                                               style="margin: 0; width: 100%;">\n                                    </div>\n                                    <div>\n                                        <label for="swal-report-category" style="display: block; margin-bottom: 5px; font-weight: 500;">\n                                            Category\n                                        </label>\n                                        <select id="swal-report-category" class="swal2-select"\n                                                style="margin: 0; width: 100%; padding: 8px 12px; border: 1px solid #d9d9d9; border-radius: 4px;">\n                                            ${n}\n                                        </select>\n                                    </div>\n                                </div>\n                            `,showCancelButton:!0,confirmButtonText:'<i class="fa fa-save"></i> Save Report',cancelButtonText:"Cancel",confirmButtonColor:"#28a745",focusConfirm:!1,preConfirm:()=>{const e=document.getElementById("swal-report-name").value,t=document.getElementById("swal-report-category").value;return e&&""!==e.trim()?e.length>255?(i.showValidationMessage("Report name is too long (max 255 characters)"),!1):{name:e.trim(),categoryId:t}:(i.showValidationMessage("Please enter a name for the report"),!1)}}).then((n=>{n.isConfirmed&&(e.name=n.value.name,e.description=n.value.name,e.category_id=n.value.categoryId?parseInt(n.value.categoryId):null,a.querySelectorAll("button").forEach((e=>e.disabled=!0)),a.innerHTML=`\n                                    <div style="text-align: center; color: #28a745;">\n                                        <i class="fa fa-spinner fa-spin"></i> Saving "${e.name}" to your Reports list...\n                                    </div>\n                                `,t.confirmReport("accept",e,null))}))})));const r=a.querySelector(".btn-decline-report");r&&!r.hasAttribute("data-handler-attached")&&(r.setAttribute("data-handler-attached","true"),r.addEventListener("click",(function(){a.innerHTML='\n                            <div style="text-align: center; color: #6c757d;">\n                                <i class="fa fa-info-circle"></i> Report not saved. You can ask me to generate it again anytime.\n                            </div>\n                        ',t.addMessage("Report was not saved. Feel free to ask me to generate a different report or refine this one.","system")})));const o=a.querySelector(".btn-decline-feedback");o&&!o.hasAttribute("data-handler-attached")&&(o.setAttribute("data-handler-attached","true"),o.addEventListener("click",(function(){a.innerHTML=`\n                            <div class="feedback-form">\n                                <p style="margin-bottom: 10px;">What would you like to change about this report?</p>\n                                <textarea id="feedback-text-${n}" class="form-control" rows="3" placeholder="Please provide your feedback..."></textarea>\n                                <div style="margin-top: 10px; display: flex; gap: 10px;">\n                                    <button class="btn btn-primary btn-send-feedback">\n                                        <i class="fa fa-paper-plane"></i> Send Feedback\n                                    </button>\n                                    <button class="btn btn-secondary btn-cancel-feedback">\n                                        Cancel\n                                    </button>\n                                </div>\n                            </div>\n                        `;const s=a.querySelector(".btn-send-feedback"),r=a.querySelector(".btn-cancel-feedback"),i=a.querySelector(`#feedback-text-${n}`);s&&s.addEventListener("click",(function(){const n=i?i.value:"";n.trim()?(a.innerHTML='\n                                        <div style="text-align: center; color: #007bff;">\n                                            <i class="fa fa-spinner fa-spin"></i> Sending feedback...\n                                        </div>\n                                    ',t.confirmReport("decline",e,n)):(i.style.borderColor="#dc3545",i.focus())})),r&&r.addEventListener("click",(function(){a.innerHTML='\n                                    <div style="text-align: center; color: #6c757d;">\n                                        <i class="fa fa-info-circle"></i> Report not saved.\n                                    </div>\n                                '}))})))}),100)},viewSavedReport:function(t){t&&(e('[href="#reports-history"]').tab("show"),setTimeout((()=>{const n=e(`.report-row[data-report-slug="${t}"]`);n.length?n.click():this.loadReportsHistory((()=>{setTimeout((()=>{const n=e(`.report-row[data-report-slug="${t}"]`);n.length?n.click():a.addNotification({message:"Report not found. Please check if it still exists in the Reports tab.",type:"error"})}),500)}))}),300))},displayReportLink:function(t){const a=document.getElementById("message-template").content.cloneNode(!0),n=a.querySelector(".message");n.classList.add("ai-message"),n.setAttribute("data-message-id",t.id);const s=t.metadata?.report_slug||"",r=t.metadata?.report_name||"Report",i=t.metadata?.report_description||"",o=`\n                <div class="report-link-message">\n                    <div style="padding: 15px; background: linear-gradient(135deg, #007bff 0%, #0056b3 100%); color: white; border-radius: 10px; margin: 10px 0;">\n                        <div style="display: flex; align-items: center; justify-content: space-between; gap: 20px;">\n                            <div style="flex: 1;">\n                                <h5 style="margin: 0; color: white;">\n                                    <i class="fa fa-chart-bar"></i> ${r}\n                                </h5>\n                                ${i?`<small style="opacity: 0.9;">${i}</small>`:""}\n                            </div>\n                            ${s?`\n                                <button class="btn btn-light btn-sm view-saved-report-btn"\n                                        data-slug="${s}"\n                                        style="cursor: pointer; border-radius: 5px; flex-shrink: 0;">\n                                    <i class="fa fa-eye"></i> View Report\n                                </button>\n                            `:""}\n                        </div>\n                    </div>\n                </div>\n            `;a.querySelector(".message-text").innerHTML=o,a.querySelector(".message-time").textContent=this.formatTimestamp(t.timestamp),e("#chat-container").append(a);const l=this;setTimeout((()=>{const t=e("#chat-container").find('.view-saved-report-btn[data-slug="'+s+'"]').last();t.length&&!t.hasClass("click-handler-attached")&&(t.addClass("click-handler-attached"),t.on("click",(function(t){t.preventDefault(),t.stopPropagation(),l.switchToReportsTab();const a=e(`.report-row[data-report-slug="${s}"]`);a.length>0?a.trigger("click"):l.fetchAndDisplayReport(s)})))}),100)},sendReportMessage:function(e){const t=`ðŸ“Š Report saved: ${e.description||e.name}`,a={id:Date.now(),sender_type:"ai",body:t,timestamp:(new Date).toISOString(),metadata:{type:"report",report_slug:e.slug,report_name:e.name||e.description,report_description:e.description}};this.displayReportLink(a)},confirmReport:function(t,a,n){const s=this;this.showLoading();const i=r.getAuthStatus()?.user||{},o={name:a.name||a.description||"Generated Report",description:a.description||"",sql:a.sql||"",category:a.category||"general",category_id:a.category_id||null},l=parseInt(this.currentChatId)||0;this.ajaxWithAuth({url:this.backendUrl+"/chat/report-confirmation",method:"POST",contentType:"application/json",timeout:9e4,data:JSON.stringify({chat_id:l,action:t,feedback:n||null,report:o,user_id:i.id||null}),success:r=>{if(this.hideLoading(),"accept"===t&&r.report)Array.isArray(this.cachedReports)||(this.cachedReports=[]),this.cachedReports.unshift(r.report),this.updateReportsHistory(this.cachedReports),this.sendReportMessage(r.report),e("#report-history-loader").addClass("d-none"),e("#report-history-table-wrapper").removeClass("d-none"),e("#reports-history-table").removeClass("d-none"),document.querySelectorAll(".report-action-container").forEach((e=>{e.innerHTML='\n                                <div style="text-align: center; color: #28a745; padding: 10px;">\n                                    <i class="fa fa-check-circle"></i> Report saved successfully!\n                                </div>\n                            '}));else if(r.chat_response){const e=r.chat_response;if(e.error||e.message&&(e.message.toLowerCase().includes("trouble connecting")||e.message.toLowerCase().includes("service")||e.message.toLowerCase().includes("try again"))){const r=e.message||"The AI service is temporarily unavailable.";document.querySelectorAll(".report-action-container").forEach((e=>{const i="retry-feedback-"+Date.now();e.innerHTML=`\n                                        <div style="text-align: center; padding: 10px;">\n                                            <div style="color: #dc3545; margin-bottom: 10px;">\n                                                <i class="fa fa-exclamation-circle"></i> ${r}\n                                            </div>\n                                            <button id="${i}" class="btn btn-primary btn-sm">\n                                                <i class="fa fa-refresh"></i> Retry\n                                            </button>\n                                        </div>\n                                    `;const o=document.getElementById(i);o&&o.addEventListener("click",(function(){s.confirmReport(t,a,n)}))})),this.addMessage(r,"error")}else{const i=e.type&&("sql"===e.type||"report"===e.type)&&e.report&&e.awaiting_confirmation;e.message&&(e.message.toLowerCase().includes("report generated")||e.message.toLowerCase().includes("generated a report")||e.message.toLowerCase().includes("i've generated"))&&!i?(document.querySelectorAll(".report-action-container").forEach((e=>{const r="retry-ghost-"+Date.now();e.innerHTML=`\n                                            <div style="text-align: center; padding: 10px;">\n                                                <div style="color: #856404; background: #fff3cd; padding: 12px; border-radius: 6px; margin-bottom: 10px;">\n                                                    <i class="fa fa-exclamation-triangle"></i>\n                                                    The refined report was generated but could not be displayed properly.\n                                                </div>\n                                                <button id="${r}" class="btn btn-primary btn-sm">\n                                                    <i class="fa fa-refresh"></i> Try Again\n                                                </button>\n                                            </div>\n                                        `;const i=document.getElementById(r);i&&i.addEventListener("click",(function(){s.confirmReport(t,a,n)}))})),this.addMessage("The report refinement encountered an issue. Please try again using the button above, or start a new request.","system")):i?(document.querySelectorAll(".report-action-container").forEach((e=>{e.innerHTML='\n                                            <div style="text-align: center; color: #007bff;">\n                                                <i class="fa fa-info-circle"></i> Feedback sent. I\'ll refine the report based on your input.\n                                            </div>\n                                        '})),this.handleResponse(r.chat_response)):(document.querySelectorAll(".report-action-container").forEach((e=>{e.innerHTML='\n                                            <div style="text-align: center; color: #007bff;">\n                                                <i class="fa fa-info-circle"></i> Feedback sent.\n                                            </div>\n                                        '})),this.handleResponse(r.chat_response))}}else document.querySelectorAll(".report-action-container").forEach((e=>{e.innerHTML='\n                                    <div style="text-align: center; color: #007bff;">\n                                        <i class="fa fa-info-circle"></i> Feedback sent.\n                                    </div>\n                                '}))},error:(e,r,i)=>{this.hideLoading(),console.error("[AI Assistant] Report confirmation failed:",{status:e.status,statusText:r,error:i,responseText:e.responseText,responseJSON:e.responseJSON});let o="Failed to process request. Please try again.",l=!0;if("timeout"===r)o="Request timed out. The AI service may be busy. Please try again.";else if(0===e.status)o="Network error. Please check your connection and try again.";else if(401===e.status)o="Session expired. Please refresh the page and log in again.",l=!1;else if(429===e.status)o="Too many requests. Please wait a moment and try again.";else if(e.status>=500)o="Server error. Please try again in a moment.";else if(e.responseJSON&&e.responseJSON.errors){console.error("[AI Assistant] Validation errors:",e.responseJSON.errors);const t=e.responseJSON.errors,a=Object.keys(t).map((e=>`${e}: ${t[e].join(", ")}`)).join("; ");o=`Validation failed: ${a}`,l=!1}else e.responseJSON&&e.responseJSON.message&&(o=e.responseJSON.message);document.querySelectorAll(".report-action-container").forEach((e=>{const r="retry-error-"+Date.now();let i="";if(l&&(i=`\n                                <button id="${r}" class="btn btn-outline-primary btn-sm" style="margin-top: 10px;">\n                                    <i class="fa fa-refresh"></i> Try Again\n                                </button>\n                            `),e.innerHTML=`\n                            <div style="text-align: center; padding: 10px;">\n                                <div style="color: #dc3545;">\n                                    <i class="fa fa-exclamation-triangle"></i> ${o}\n                                </div>\n                                ${i}\n                            </div>\n                        `,l){const e=document.getElementById(r);e&&e.addEventListener("click",(function(){s.confirmReport(t,a,n)}))}}))}})},switchToReportsTab:function(){setTimeout((()=>{e(".datatable-wrapper").removeClass("datatable-loading"),e("#report-history-table-wrapper .datatable-wrapper").removeClass("datatable-loading")}),200),e("#reports-tab").tab("show"),e("#assistant-tab").removeClass("active").attr("aria-selected","false"),e("#reports-tab").addClass("active").attr("aria-selected","true"),e("#assistant-panel").removeClass("show active"),e("#reports-panel").addClass("show active"),e(".report-view-title").text("Select a Report"),e(".report-view-body").html('<div class="text-center py-4"><p class="text-muted">Select a report from history to view details here.</p></div>'),!this.cachedReports||Array.isArray(this.cachedReports)&&0===this.cachedReports.length&&!this.reportsLoaded?this.loadReportsHistory():(e("#report-history-loader").addClass("d-none"),e("#report-history-table-wrapper").removeClass("d-none"),this.cachedReports&&this.updateReportsHistory(this.cachedReports))},loadReportsHistory:function(t){this.cachedReports||(this.cachedReports=[]),e("#report-history-loader").removeClass("d-none"),e("#report-history-table-wrapper").addClass("d-none"),this.ajaxWithAuth({url:this.backendUrl+"/ai-reports",method:"GET",timeout:1e4,success:a=>{const n=a.reports||a.data||[];this.cachedReports=Array.isArray(n)?n:[],this.reportsLoaded=!0,this.updateReportsHistory(this.cachedReports),e("#report-history-loader").addClass("d-none"),e("#report-history-table-wrapper").removeClass("d-none"),this.reportsDataTable&&(this.reportsDataTable.destroy(),this.reportsDataTable=null),setTimeout((()=>{try{const t=document.getElementById("reports-history-table");if(!t)return;const a=t.querySelector("tbody"),n=t.querySelector("thead");if(n&&a&&n.rows.length>0&&n.rows[0].cells.length>0){this.reportsDataTable&&(this.reportsDataTable.destroy(),this.reportsDataTable=null);const t=n.rows[0].cells.length,s=a.rows;let r=0;s.length>0&&(r=s[0].cells.length),t===r&&t>0&&s.length>0&&!s[0].cells[0].textContent.includes("No reports")&&(this.reportsDataTable=new simpleDatatables.DataTable("#reports-history-table",{searchable:!0,fixedHeight:!1,perPage:10,loading:!1}),setTimeout((()=>{e(".datatable-wrapper").removeClass("datatable-loading"),e("#report-history-table-wrapper .datatable-wrapper").removeClass("datatable-loading"),e(".dataTable-loading").remove()}),100))}}catch(e){console.error("Error initializing DataTable:",e)}"function"==typeof t&&t()}),100)},error:(a,n,s)=>{console.error("[AI Assistant] Failed to load report history:",{status:a.status,statusText:a.statusText,error:s,responseText:a.responseText}),e("#report-history-loader").addClass("d-none"),e("#report-history-table-wrapper").removeClass("d-none");const r=e("#reports-history-table tbody");r.empty(),"timeout"===n?r.append('<tr><td colspan="3" class="text-center text-warning">Loading reports timed out. Please refresh the page.</td></tr>'):401===a.status||403===a.status?r.append('<tr><td colspan="3" class="text-center text-danger">Authentication error. Please log in again.</td></tr>'):this.cachedReports&&this.cachedReports.length>0?this.updateReportsHistory(this.cachedReports):r.append('<tr><td colspan="3" class="text-center text-muted">Unable to load reports. Please try again later.</td></tr>'),"function"==typeof t&&t()}})},updateReportsHistory:function(t){const a=e("#reports-history-table tbody"),n=this;if(a.empty(),t&&0!==t.length)t.forEach((t=>{const s=n.getStatusBadge(t.status),r=new Date(t.created_at).toLocaleDateString(),i=e(`\n                    <tr class="report-row" data-report-slug="${t.slug}">\n                        <td>${t.description}</td>\n                        <td>${r}</td>\n                        <td>${s}</td>\n                    </tr>`);a.append(i)})),e("#report-history-table-wrapper").off("click",".report-row"),e("#report-history-table-wrapper").on("click",".report-row",(function(){const t=e(this),a=t.data("report-slug"),s=n.cachedReports.find((e=>e.slug===a));if(!s)return void console.error("Report not found in cache:",a);e("#report-history-loader").addClass("d-none"),e("#report-history-table-wrapper").removeClass("d-none");if(e("#reports-panel .col-md-8 .card-body").find(".report-display-wrapper").html('<div class="w-100 d-flex justify-content-center align-items-center" style="min-height:200px"><div class="spinner-border text-primary" role="status"></div></div>'),Array.isArray(n.cachedReports)&&n.cachedReports.length>0){const e=n.cachedReports.find((e=>e.slug===s.slug));e&&e.data&&Array.isArray(e.data)&&e.data.length>0?setTimeout((()=>{n.updateReportsView(e,e.data)}),300):n.fetchAndDisplayReport(s.slug,t)}else n.fetchAndDisplayReport(s.slug,t);e(".report-row").removeClass("table-primary"),t.addClass("table-primary")}));else{const e=r.getAuthStatus();e&&e.subscription&&e.subscription.reports_generated_this_month>0?a.append('<tr><td colspan="3" class="text-center text-muted">No reports yet</td></tr>'):a.append('\n                        <tr>\n                            <td colspan="3" class="text-center text-muted">\n                                <div class="py-4">\n                                    <i class="fa fa-chart-bar fa-2x mb-2"></i>\n                                    <p class="mb-1">No reports generated yet</p>\n                                    <small>Ask the AI assistant to create reports for you</small>\n                                </div>\n                            </td>\n                        </tr>\n                    ')}},fetchAndDisplayReport:function(t,a){const n=this,s=e("#reports-panel .col-md-8 .card-body");e("#report-history-loader").addClass("d-none"),e("#report-history-table-wrapper").removeClass("d-none"),s.html('<div class="report-display-wrapper w-100"><div class="w-100 d-flex justify-content-center align-items-center" style="min-height:200px"><div class="spinner-border text-primary" role="status"></div></div></div>'),this.ajaxWithAuth({url:`${this.backendUrl}/ai-reports/${t}`,method:"GET",success:e=>{const t=e.report;if(e.data&&Array.isArray(e.data)&&e.data.length>0)return void n.displayFetchedReport(t,e.data,a);const r=e.sql||t&&t.sql_query||t&&t.sql;r?n.executeReportLocally(r,t?.params||{}).then((e=>{e.error?s.find(".report-display-wrapper").html(`<div class="w-100 text-center text-danger py-4">\n                                            <i class="fa fa-exclamation-triangle"></i>\n                                            Failed to execute report: ${e.error}\n                                        </div>`):e.data&&0!==e.data.length?n.displayFetchedReport(t,e.data,a):s.find(".report-display-wrapper").html('<div class="w-100 text-center text-warning py-4"><i class="fa fa-info-circle"></i> Report executed successfully but returned no data.</div>')})).catch((e=>{s.find(".report-display-wrapper").html(`<div class="w-100 text-center text-danger py-4">\n                                        <i class="fa fa-exclamation-triangle"></i>\n                                        Failed to execute report: ${e.message}\n                                    </div>`)})):s.find(".report-display-wrapper").html('<div class="w-100 text-center text-warning py-4"><i class="fa fa-exclamation-triangle"></i> Report has no data or SQL to execute.</div>')},error:(e,a,n)=>{console.error("fetchAndDisplayReport error:",t,a,n),console.error("XHR:",e),s.find(".report-display-wrapper").html('<div class="w-100 text-center text-danger py-4">Failed to load report. Please try again.</div>')}})},displayFetchedReport:function(t,a,n){Array.isArray(this.cachedReports)||(this.cachedReports=[]);let s=this.cachedReports.findIndex((e=>e.slug===t.slug));s>-1?this.cachedReports[s]=Object.assign({},t,{data:a}):this.cachedReports.push(Object.assign({},t,{data:a})),this.currentViewedReport=t,this.currentViewedReportData=a,this.updateReportsView(t,a),e(".report-row").removeClass("table-primary"),n&&n.addClass("table-primary")},displayCurrentReport:function(t){this.updateReportsView(t),e(`.report-row[data-report-slug="${t.slug}"]`).addClass("table-primary")},displayReport:function(t){const a=this.cachedReports.find((e=>e.slug===t));a&&(this.updateReportsView(a,a.data),e(".report-row").removeClass("table-primary"),e(`.report-row[data-report-slug="${t}"]`).addClass("table-primary"))},updateReportsView:function(t,a=null){const n=this;if(n.currentViewedReport=t,n.currentViewedReportData=a,n.reportChartInstance&&(n.reportChartInstance.destroy(),n.reportChartInstance=null),n.reportGraphInstance&&(n.reportGraphInstance.destroy(),n.reportGraphInstance=null),n._vteController&&"function"==typeof n._vteController.destroy){try{n._vteController.destroy()}catch(e){console.error("Error destroying VTE controller:",e)}n._vteController=null}const s=e("#reports-panel .col-md-8 .card-body");if(0===e("#display-type-icon-style").length&&e("head").append('\n                    <style id="display-type-icon-style">\n                        /* View toggle buttons */\n                        .view-toggle .view-toggle-btn {\n                            background: #f8f9fa;\n                            border: 1px solid #dee2e6;\n                            color: #495057;\n                            padding: 0.35rem 0.75rem;\n                            font-size: 13px;\n                            transition: all 0.2s ease;\n                        }\n                        .view-toggle .view-toggle-btn:first-child {\n                            border-radius: 6px 0 0 6px;\n                        }\n                        .view-toggle .view-toggle-btn:last-child {\n                            border-radius: 0 6px 6px 0;\n                        }\n                        .view-toggle .view-toggle-btn:hover {\n                            background: #e9ecef;\n                        }\n                        .view-toggle .view-toggle-btn.active {\n                            background: #2563eb;\n                            border-color: #2563eb;\n                            color: white;\n                        }\n                        .view-toggle .view-toggle-btn i {\n                            margin-right: 5px;\n                        }\n\n                        /* Chart controls wrapper */\n                        .chart-controls-wrapper {\n                            background: #f8f9fa;\n                            border-radius: 8px;\n                            padding: 1rem;\n                            border: 1px solid #e9ecef;\n                        }\n                        .chart-controls {\n                            display: flex;\n                            align-items: flex-end;\n                            flex-wrap: wrap;\n                        }\n                        .chart-controls .control-group {\n                            display: flex;\n                            flex-direction: column;\n                            gap: 0.25rem;\n                        }\n                        .chart-controls .form-label {\n                            font-size: 11px;\n                            font-weight: 600;\n                            color: #6c757d;\n                            margin-bottom: 0;\n                            text-transform: uppercase;\n                            letter-spacing: 0.5px;\n                        }\n                        .chart-controls .form-select {\n                            font-size: 13px;\n                            padding: 0.4rem 2rem 0.4rem 0.75rem;\n                            border-radius: 6px;\n                            border: 1px solid #dee2e6;\n                            background-color: white;\n                            min-width: 140px;\n                        }\n                        .chart-controls .form-select:focus {\n                            border-color: #2563eb;\n                            box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.15);\n                        }\n\n                        /* Legacy icon button styles */\n                        .btn-icon {\n                            transition: transform 0.15s cubic-bezier(.4,2,.6,1), background 0.2s, border 0.2s;\n                            background: #f8f9fa;\n                            border: 1.5px solid #e0e0e0;\n                            color: #333;\n                        }\n                        .btn-icon:hover {\n                            transform: scale(1.15);\n                            background: #e9ecef;\n                            border-color: #b3d7ff;\n                            color: #007bff;\n                            z-index: 2;\n                        }\n                        .btn-icon.active, .btn-icon:focus {\n                            background: #e3f0ff;\n                            border-color: #007bff;\n                            color: #007bff;\n                            box-shadow: 0 0 0 2px #b3d7ff33;\n                        }\n                    </style>\n                '),e(".report-view-title").text(t.description),!Array.isArray(a)||0===a.length)return void s.find(".report-display-wrapper").html('<div class="w-100 text-center text-muted py-4">No data available for this report.</div>');const r=Object.keys(a[0]||{}),i=this.detectNumericColumns(a,r);let o='<div class="chart-controls-wrapper mb-3">';o+='<div class="chart-controls d-flex flex-wrap align-items-end gap-3">',o+='<div class="control-group">',o+='<label for="report-chart-type" class="form-label">Chart Type</label>',o+='<select id="report-chart-type" class="form-select form-select-sm">',o+='<option value="bar">Bar Chart</option>',o+='<option value="line">Line Chart</option>',o+='<option value="pie">Pie Chart</option>',o+='<option value="doughnut">Doughnut Chart</option>',o+="</select></div>",o+='<div class="control-group">',o+='<label for="report-chart-x-axis" class="form-label">X-Axis (Labels)</label>',o+='<select id="report-chart-x-axis" class="form-select form-select-sm">',r.forEach(((e,t)=>{const a=e.replace(/_/g," ").replace(/\b\w/g,(e=>e.toUpperCase()));o+=`<option value="${e}"${0===t?" selected":""}>${a}</option>`})),o+="</select></div>",o+='<div class="control-group">',o+='<label for="report-chart-y-axis" class="form-label">Y-Axis (Values)</label>',o+='<select id="report-chart-y-axis" class="form-select form-select-sm">',i.length>0?i.forEach(((e,t)=>{const a=e.replace(/_/g," ").replace(/\b\w/g,(e=>e.toUpperCase())),n=t===i.length-1?" selected":"";o+=`<option value="${e}"${n}>${a}</option>`})):r.forEach(((e,t)=>{const a=e.replace(/_/g," ").replace(/\b\w/g,(e=>e.toUpperCase())),n=t===r.length-1?" selected":"";o+=`<option value="${e}"${n}>${a}</option>`})),o+="</select></div>",o+="</div></div>";const l=n.isFreePlan?" export-premium":"",d=n.isFreePlan?' <i class="fa fa-crown text-warning" style="font-size: 10px;"></i>':"";let c=`\n                <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap">\n                    <div class="action-buttons d-flex gap-2">\n                        <button class="btn btn-outline-danger btn-sm export-pdf-btn">\n                            <i class="fa fa-file-pdf-o me-1"></i>Export PDF\n                        </button>\n                        <button class="btn btn-outline-secondary btn-sm export-csv-btn${l} mr-10">\n                            <i class="fa fa-download me-1"></i>Export CSV${d}\n                        </button>\n                        <button class="btn btn-outline-secondary btn-sm export-json-btn${l}">\n                            <i class="fa fa-code me-1"></i>Export JSON${d}\n                        </button>\n                    </div>\n                    <div class="view-toggle btn-group" role="group">\n                        <button type="button" class="btn btn-sm view-toggle-btn${"chart"!==t.display_type?" active":""}" data-type="table"><i class="fa fa-table"></i> Table</button>\n                        <button type="button" class="btn btn-sm view-toggle-btn${"chart"===t.display_type?" active":""}" data-type="chart"><i class="fa fa-bar-chart"></i> Chart</button>\n                    </div>\n                </div>\n            `;const p="chart"===t.display_type;let h='<div class="report-display-area w-100">';h+=`<div class="report-view-panel${p?" d-none":""}" data-type="table">`,h+=this.renderReportData(a),h+="</div>",h+=`<div class="report-view-panel${p?"":" d-none"}" data-type="chart">`,h+=o,h+='<div class="chart-container" style="position: relative; height: 400px; border: 1px solid #e9ecef; border-radius: 8px; padding: 1rem; background: #fff;">',h+='<canvas id="reportChart"></canvas>',h+="</div></div>",h+="</div>",s.html(`\n                ${c}\n                <div class="report-display-wrapper w-100 position-relative">\n                    ${h}\n                </div>\n            `),n._currentReportData=a,n._currentReportName=t.description||t.name||"Report",n._currentReportView="chart"===t.display_type?"chart":"table",this._pendingTableId&&"chart"!==t.display_type&&setTimeout((()=>{if(document.getElementById(this._pendingTableId)&&window.VTE)try{this._vteController=window.VTE.enhance("#"+this._pendingTableId,{perPage:10,perPageOptions:[10,25,50,100],labels:{search:"Search",rows:"Rows per page",info:(e,t,a)=>`Showing ${e}â€“${t} of ${a} entries`,noData:"No matching records found"}})[0]}catch(e){console.error("Error initializing Vanilla Table Enhancer:",e)}this._pendingTableId=null}),100),"chart"===t.display_type&&setTimeout((()=>{n.renderReportChartFromSelectors(a,n._currentReportName)}),100),s.find(".view-toggle-btn").on("click",(function(){const a=e(this).data("type");s.find(".view-toggle-btn").removeClass("active"),e(this).addClass("active"),n._currentReportView=a,s.find(".report-view-panel").addClass("d-none"),s.find(`.report-view-panel[data-type="${a}"]`).removeClass("d-none"),"table"===a&&!n._vteController&&n._pendingTableId&&setTimeout((()=>{if(document.getElementById(n._pendingTableId)&&window.VTE)try{n._vteController=window.VTE.enhance("#"+n._pendingTableId,{perPage:10,perPageOptions:[10,25,50,100],labels:{search:"Search",rows:"Rows per page",info:(e,t,a)=>`Showing ${e}â€“${t} of ${a} entries`,noData:"No matching records found"}})[0]}catch(e){console.error("Error initializing Vanilla Table Enhancer on view switch:",e)}}),100),"chart"===a&&setTimeout((()=>{n.renderReportChartFromSelectors(n._currentReportData,n._currentReportName)}),100),a!==t.display_type?0===s.find(".save-display-type-btn").length&&(s.find(".view-toggle").after('<button class="btn btn-sm btn-outline-primary save-display-type-btn ms-2"><i class="fa fa-save"></i> Save View</button>'),s.find(".save-display-type-btn").on("click",(function(){n.saveDisplayType(t.slug,a)}))):s.find(".save-display-type-btn").remove()})),s.find("#report-chart-type, #report-chart-x-axis, #report-chart-y-axis").on("change",(function(){n.renderReportChartFromSelectors(n._currentReportData,n._currentReportName)})),s.find(".export-pdf-btn").on("click",(()=>n.exportReport(t.slug,"pdf"))),s.find(".export-csv-btn").on("click",(function(){e(this).hasClass("export-premium")?n.showExportUpgradePrompt("csv"):n.exportReport(t.slug,"csv")})),s.find(".export-json-btn").on("click",(function(){e(this).hasClass("export-premium")?n.showExportUpgradePrompt("json"):n.exportReport(t.slug,"json")}))},linkifyUrls:function(e){if(!e||"string"!=typeof e)return e||"";return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/(\bhttps?:\/\/[^\s<>"']+)/gi,(function(e){const t=e.length>50?e.substring(0,47)+"...":e;return`<a href="${e}" target="_blank" rel="noopener noreferrer" class="report-url-link" title="${e}">${t}</a>`}))},formatCellValue:function(e,t){if(null==e||""===e)return"";const a=String(e),n=(t||"").toLowerCase();return n.includes("url")||n.includes("link")||n.includes("profile")||n.includes("href")||a.match(/^https?:\/\//i)?this.linkifyUrls(a):String(a).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")},renderReportData:function(e){if(!e||0===e.length)return'<p class="text-muted">No data available.</p>';const t=this,a=Object.keys(e[0]),n="enhanced-report-table-"+Date.now();let s=`<div class="table-responsive"><table id="${n}" class="table table-striped table-hover">`;return s+="<thead><tr>",a.forEach((t=>{const a=e.every((e=>{const a=e[t];return null==a||""===a||!isNaN(parseFloat(a))})),n=!a&&e.some((e=>{const a=e[t];return a&&!isNaN(Date.parse(a))}));s+=`<th${a?' data-vte="number"':n?' data-vte="date"':""}>${t.replace(/_/g," ").replace(/\b\w/g,(e=>e.toUpperCase()))}</th>`})),s+="</tr></thead>",s+="<tbody>",e.forEach((e=>{s+="<tr>",a.forEach((a=>{const n=t.formatCellValue(e[a],a);s+=`<td>${n}</td>`})),s+="</tr>"})),s+="</tbody></table></div>",this._pendingTableId=n,s},getStatusBadge:function(e){return`<span class="badge ${this.getStatusBadgeClass(e)}" style="color: white;">${e}</span>`},getStatusBadgeClass:function(e){switch(e){case"completed":case"ready":return"bg-success";case"processing":return"bg-warning text-dark";case"pending":return"bg-info";case"failed":case"error":return"bg-danger";default:return"bg-secondary"}},executeReport:function(t){const a=this,n=e(`.report-row[data-report-slug="${t}"]`),s=n.html();n.html('<td colspan="3" class="text-center"><div class="spinner-border spinner-border-sm text-primary" role="status"><span class="visually-hidden">Executing...</span></div> Executing report...</td>'),this.ajaxWithAuth({url:`${this.backendUrl}/ai-reports/${t}`,method:"GET",success:e=>{const r=e.report,i=e.sql||r&&r.sql_query||r&&r.sql;if(!i)return n.html(s),void this.showError("Report SQL not found. Please regenerate the report.");e.data&&Array.isArray(e.data)&&e.data.length>0?a.handleExecutionSuccess(t,r,e.data,n):a.executeReportLocally(i,r?.params||{}).then((e=>{if(e.error)return n.html(s),void a.showError("Failed to execute report: "+e.error);a.handleExecutionSuccess(t,r,e.data,n)})).catch((e=>{n.html(s),a.showError("Failed to execute report: "+e.message)}))},error:(e,t,a)=>{n.html(s);let r="Failed to fetch report";404===e.status?r="Report not found.":403===e.status?r="You do not have permission to view this report.":e.responseJSON&&e.responseJSON.error?r=e.responseJSON.error:r+=": "+a,console.error("Report fetch failed:",{status:e.status,error:a,response:e.responseText}),this.showError(r)}})},handleExecutionSuccess:function(t,a,n,s){if(Array.isArray(this.cachedReports)){const e=this.cachedReports.findIndex((e=>e.slug===t));-1!==e?this.cachedReports[e]=Object.assign({},this.cachedReports[e],a,{data:n}):this.cachedReports.push(Object.assign({},a,{data:n}))}this.currentViewedReport=a,this.currentViewedReportData=n,this.updateReportsView(a,n),e(".report-row").removeClass("table-primary"),s&&s.addClass("table-primary"),this.showSuccess("Report executed successfully!")},executeReportLocally:function(t,a={}){const n=this;return new Promise(((s,r)=>{n.showLoading(),e.ajax({url:`${M.cfg.wwwroot}/report/adeptus_insights/ajax/execute_ai_report.php`,method:"POST",contentType:"application/json",data:JSON.stringify({sql:t,params:a,sesskey:M.cfg.sesskey}),timeout:6e4,success:function(e){n.hideLoading(),e.success?s({data:e.data||[],headers:e.headers||[],row_count:e.row_count||0,error:null}):s({data:null,headers:[],row_count:0,error:e.message||e.details||"Query execution failed"})},error:function(e,t,a){n.hideLoading();let s="Failed to execute report locally";if(400===e.status){const t=e.responseJSON;s=t?.message||t?.details||"Invalid SQL query"}else 403===e.status?s="Session expired. Please refresh the page.":0===e.status?s="Network error. Please check your connection.":"timeout"===t&&(s="Query timed out. Try simplifying your request.");console.error("Local report execution failed:",{status:e.status,error:a,response:e.responseText}),r(new Error(s))}})}))},showExportUpgradePrompt:function(e){const t=`${M.cfg.wwwroot}/report/adeptus_insights/subscription.php`,a={csv:"CSV",excel:"Excel",json:"JSON"}[e]||e.toUpperCase();i.fire({title:"Premium Export Format",html:`<div style="text-align: center; padding: 20px;">\n                    <div style="font-size: 48px; color: #f39c12; margin-bottom: 15px;">\n                        <i class="fa fa-crown"></i>\n                    </div>\n                    <h3 style="color: #2c3e50; margin-bottom: 15px;">${a} Export is a Premium Feature</h3>\n                    <p style="color: #7f8c8d; font-size: 16px; line-height: 1.6; margin-bottom: 25px;">\n                        Export to ${a} format is only available with a paid subscription plan.\n                        Upgrade now to unlock all export formats and advanced features.\n                    </p>\n                    <div style="background: #ecf0f1; padding: 15px; border-radius: 8px; margin-bottom: 20px;">\n                        <p style="margin: 0; font-size: 14px; color: #34495e;">\n                            <strong>Free Plan:</strong> PDF exports only<br>\n                            <strong>Paid Plans:</strong> CSV, Excel, JSON, and PDF exports\n                        </p>\n                    </div>\n                </div>`,showCancelButton:!0,confirmButtonText:'<i class="fa fa-arrow-up"></i> Upgrade Now',cancelButtonText:'<i class="fa fa-times"></i> Cancel',confirmButtonColor:"#3498db",cancelButtonColor:"#95a5a6",width:500}).then((e=>{e.isConfirmed&&window.open(t,"_blank")}))},checkExportEligibility:async function(e){try{const t=await fetch(`${M.cfg.wwwroot}/report/adeptus_insights/ajax/check_export_eligibility.php`,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:`format=${encodeURIComponent(e)}&sesskey=${M.cfg.sesskey}`});return await t.json()}catch(e){return console.error("Error checking export eligibility:",e),{success:!1,eligible:!1,message:"Unable to verify export eligibility."}}},captureChartImage:async function(){const e=this;await new Promise((e=>setTimeout(e,300)));const t=document.getElementById("reportChart");if(!t)return console.warn("[Assistant] Chart canvas not found"),null;try{const e=t.toDataURL("image/png",.8);if(e&&e.length>100&&e.length<2e6)return console.log("[Assistant] Chart captured via toDataURL, size:",e.length),e}catch(e){console.warn("[Assistant] Native canvas capture failed:",e)}try{if(window.html2canvas||await e.loadHtml2Canvas(),window.html2canvas){const e=(await window.html2canvas(t,{backgroundColor:"#ffffff",scale:1.5,useCORS:!0,allowTaint:!0,logging:!1})).toDataURL("image/png",.8);if(e&&e.length>100&&e.length<2e6)return console.log("[Assistant] Chart captured via html2canvas, size:",e.length),e}}catch(e){console.warn("[Assistant] html2canvas capture failed:",e)}return null},loadHtml2Canvas:function(){return new Promise(((e,t)=>{if(window.html2canvas)return void e();const a=document.createElement("script");a.src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js",a.onload=()=>e(),a.onerror=()=>t(new Error("Failed to load html2canvas")),document.head.appendChild(a)}))},exportReport:async function(e,t){const a=this;i.fire({title:`Exporting as ${t.toUpperCase()}...`,allowOutsideClick:!1,didOpen:()=>i.showLoading()});try{const n=await a.checkExportEligibility(t);if(!n.success||!n.eligible)return i.close(),void(a.isFreePlan&&"pdf"!==t?a.showExportUpgradePrompt(t):i.fire({icon:"error",title:"Export Not Available",text:n.message||"You are not eligible to export in this format."}));let s=`reportid=${encodeURIComponent(e)}&format=${t}&sesskey=${M.cfg.sesskey}`;if(s+=`&view=${a._currentReportView}`,a.currentViewedReportData&&Array.isArray(a.currentViewedReportData)){const e=a.currentViewedReportData.length>0?Object.keys(a.currentViewedReportData[0]):[],t={results:a.currentViewedReportData,headers:e};s+=`&report_data=${encodeURIComponent(JSON.stringify(t))}`}if("pdf"===t&&"chart"===a._currentReportView)try{const e=a.captureChartImage(),t=new Promise(((e,t)=>{setTimeout((()=>t(new Error("Chart capture timeout"))),1e4)})),n=await Promise.race([e,t]);n&&n.length>100?(s+=`&chart_image=${encodeURIComponent(n)}`,console.log("[Assistant] Chart image included in export")):console.warn("[Assistant] Chart capture returned empty or invalid data")}catch(e){console.warn("[Assistant] Chart capture failed, continuing without chart:",e.message)}const r=await fetch(`${M.cfg.wwwroot}/report/adeptus_insights/ajax/export_report.php`,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:s}),o=r.headers.get("content-type"),l=r.headers.get("content-disposition");if(o&&o.includes("application/json")&&!l){const e=await r.json();throw new Error(e.message||"Export failed")}if(!r.ok)throw new Error(`Export failed with status: ${r.status}`);const d=(a.currentViewedReport?.description||a.currentViewedReport?.name||"report").replace(/[^a-zA-Z0-9\s-]/g,"").replace(/\s+/g,"_").toLowerCase(),c=(new Date).toISOString().split("T")[0],p=await r.blob(),h=window.URL.createObjectURL(p),u=document.createElement("a");u.href=h,u.download=`${d}_${c}.${t}`,document.body.appendChild(u),u.click(),window.URL.revokeObjectURL(h),document.body.removeChild(u),i.close(),a.showSuccess(`${t.toUpperCase()} file downloaded successfully!`),await a.trackExport(t,e)}catch(e){i.close(),a.showError(e.message||"Failed to export report.")}},trackExport:async function(e,t){try{const a=await fetch(`${M.cfg.wwwroot}/report/adeptus_insights/ajax/track_export.php`,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:`format=${encodeURIComponent(e)}&report_name=${encodeURIComponent(t)}&sesskey=${M.cfg.sesskey}`});await a.json()}catch(e){console.error("Error tracking export:",e)}},openReportFromLink:function(t){this.switchToReportsTab(),this.updateReportsHistory(this.cachedReports),e(".report-row").removeClass("table-primary");const a=e(`.report-row[data-report-slug="${t}"]`);a.addClass("table-primary");const n=this.cachedReports.find((e=>e.slug===t));n&&n.data&&Array.isArray(n.data)&&n.data.length>0?this.updateReportsView(n,n.data):this.fetchAndDisplayReport(t,a)},formatTimestamp:function(e){const t=e instanceof Date?e:new Date(e),a=new Date,n=e=>e.toString().padStart(2,"0"),s=`${n(t.getHours())}:${n(t.getMinutes())}`;if(t.getFullYear()!==a.getFullYear()){const e=t.toLocaleString("default",{month:"long"});return`${t.getDate()} ${e} ${t.getFullYear()} - ${s}`}if(t.toDateString()===a.toDateString())return s;const r=new Date(a.getFullYear(),a.getMonth(),a.getDate()-1);if(t.toDateString()===r.toDateString()){return`${t.toLocaleString("default",{weekday:"long"})} - ${s}`}const i=t.toLocaleString("default",{month:"long"});return`${t.getDate()} ${i} - ${s}`},updateChatHistoryBadge:function(t){const a=e(`#chat-history-list li.chat-history-item[data-chat-id="${t}"]`);if(!a.length)return;let n=a.find(".report-count");if(n.length){const e=parseInt(n.text(),10)||0;n.text(e+1)}else{const t=e('<span class="badge bg-primary d-flex align-items-center report-count" style="color: white;"><i class="fa fa-chart-bar me-1"></i>1</span>');a.append(t)}},saveDisplayType:function(t,a){i.fire({title:"Saving default view...",allowOutsideClick:!1,didOpen:()=>i.showLoading()}),this.ajaxWithAuth({url:`${this.backendUrl}/ai-reports/${t}/display-type`,method:"POST",contentType:"application/json",data:JSON.stringify({display_type:a}),success:()=>{i.fire({icon:"success",title:"Default view saved",showConfirmButton:!1,timer:1500});const n=this.cachedReports.find((e=>e.slug===t));n&&(n.display_type=a),e(".save-display-type-btn").remove()},error:()=>{i.fire({icon:"error",title:"Save failed",text:"Could not save default view. Please try again."})}})},showResendIconOnMessage:function(t,a){if(!t||!t.length)return;t.siblings(".failed-reload-icon").remove();const n=e('\n                    <i class="fa fa-refresh failed-reload-icon text-danger"\n                   title="Retry sending this message"\n                       style="cursor:pointer; float:left; margin-right:0.5rem;"></i>\n                ');t.after(n),n.on("click",(()=>{n.remove(),this.resendMessage(t,a)}))},showResendIconOnLastUserMessage:function(){const t=e("#chat-container .user-message:last");if(t.length){const e=t.find(".message-text").text();this.showResendIconOnMessage(t,e)}},showCompareDataModal:function(t){const a=this,s=t.slug;let r=[],o=null,l=null,d=null,c=!1,p=!1,h=null,u="table",g="table",m=null,f=null,b=null,y=!1,x="a";function v(e,t,n){"a"===t&&(c=!0),"b"===t&&(p=!0),_(),a.ajaxWithAuth({url:`${this.backendUrl}/ai-reports/${s}/snapshots/${e}`,method:"GET",success:function(a){"a"===t?(f=a.data,l=e,c=!1):(b=a.data,d=e,p=!1),_(),n&&n()},error:function(){h="Failed to fetch snapshot data.","a"===t&&(c=!1),"b"===t&&(p=!1),_(),n&&n()}})}function w(e){if(!e)return{bg:"#f8f9fa",border:"#dee2e6",text:"#6c757d"};const t=r.findIndex((t=>t.id===e));if(-1===t)return{bg:"#f8f9fa",border:"#dee2e6",text:"#6c757d"};const a=[{bg:"#e3f2fd",border:"#2196f3",text:"#1976d2"},{bg:"#f3e5f5",border:"#9c27b0",text:"#7b1fa2"},{bg:"#e8f5e8",border:"#4caf50",text:"#388e3c"},{bg:"#fff3e0",border:"#ff9800",text:"#f57c00"},{bg:"#fce4ec",border:"#e91e63",text:"#c2185b"},{bg:"#e0f2f1",border:"#009688",text:"#00695c"},{bg:"#f1f8e9",border:"#8bc34a",text:"#689f38"},{bg:"#fff8e1",border:"#ffc107",text:"#ffa000"}];return a[t%a.length]}function C(e){if(!e)return"";if("string"==typeof e&&"current"===e)return"Current Data";const t=r.find((t=>t.id===e));return t&&t.note?t.note:""}function _(){if(e("#compare-section-a").replaceWith(function(){let e="";const t=w(l),n=C(l);return e+=`<div class="w-100 droppable-snapshot compare-section" id="compare-section-a" data-drop-target="a" style="border: 2px solid ${t.border}; border-radius: 8px; padding: 12px; background-color: ${t.bg}; height: 100%; min-height: 300px; position:relative;">\n                    <div class="d-flex justify-content-between align-items-center mb-2">\n                        <span class="fw-bold" style="color: ${t.text};">Snapshot A${n?": "+n:""}</span>\n                        <div class="btn-group display-type-switcher-a" role="group" aria-label="Display type switcher">\n                            <button class="btn btn-icon btn-sm${"table"===u?" active":""}" data-type="table" data-side="a" tabindex="0" aria-label="Table view" title="Table view"><i class="fa fa-table"></i></button>\n                            <button class="btn btn-icon btn-sm${"chart"===u?" active":""}" data-type="chart" data-side="a" tabindex="0" aria-label="Chart view" title="Chart view"><i class="fa fa-bar-chart"></i></button>\n                            <button class="btn btn-icon btn-sm${"graph"===u?" active":""}" data-type="graph" data-side="a" tabindex="0" aria-label="Graph view" title="Graph view"><i class="fa fa-line-chart"></i></button>\n                            </div>\n                        </div>`,c?e+='<div class="w-100 d-flex justify-content-center align-items-center" style="min-height:200px"><div class="spinner-border text-primary" role="status"></div></div>':f?(e+=`<div class="comparison-fade${u?" comparison-fade-in":""}" style="animation:fadeIn .3s; overflow-x: auto; max-height: calc(100% - 50px);">`,"table"===u?e+=a.renderDiffTable(f,b):"chart"===u?e+='<div class="chart-container" style="min-height:260px;" tabindex="0" aria-label="Bar chart" role="region"><canvas id="compareChartA"></canvas></div>':"graph"===u&&(e+='<div class="chart-container" style="min-height:260px;" tabindex="0" aria-label="Line graph" role="region"><canvas id="compareGraphA"></canvas></div>'),e+="</div>"):e+='<div class="text-muted small text-center" style="min-height:200px;">No snapshot selected for A</div>',e+="</div>",e}()),e("#compare-section-b").replaceWith(function(){let e="";const t=w(d),n=C(d);return e+=`<div class="w-100 droppable-snapshot compare-section" id="compare-section-b" data-drop-target="b" style="border: 2px solid ${t.border}; border-radius: 8px; padding: 12px; background-color: ${t.bg}; height: 100%; min-height: 300px; position:relative;">\n                    <div class="d-flex justify-content-between align-items-center mb-2">\n                        <span class="fw-bold" style="color: ${t.text};">Snapshot B${n?": "+n:""}</span>\n                        <div class="btn-group display-type-switcher-b" role="group" aria-label="Display type switcher B">\n                            <button class="btn btn-icon btn-sm${"table"===g?" active":""}" data-type="table" data-side="b" tabindex="0" aria-label="Table view for B" title="Table view"><i class="fa fa-table"></i></button>\n                            <button class="btn btn-icon btn-sm${"chart"===g?" active":""}" data-type="chart" data-side="b" tabindex="0" aria-label="Chart view for B" title="Chart view"><i class="fa fa-bar-chart"></i></button>\n                            <button class="btn btn-icon btn-sm${"graph"===g?" active":""}" data-type="graph" data-side="b" tabindex="0" aria-label="Graph view for B" title="Graph view"><i class="fa fa-line-chart"></i></button>\n                        </div>\n                    </div>`,p?e+='<div class="w-100 d-flex justify-content-center align-items-center" style="min-height:200px"><div class="spinner-border text-primary" role="status"></div></div>':b?(e+=`<div class="comparison-fade${g?" comparison-fade-in":""}" style="animation:fadeIn .3s; overflow-x: auto; max-height: calc(100% - 50px);">`,"table"===g?e+=a.renderDiffTable(b,f):"chart"===g?e+='<div class="chart-container" style="min-height:260px;" tabindex="0" aria-label="Bar chart for B" role="region"><canvas id="compareChartB"></canvas></div>':"graph"===g&&(e+='<div class="chart-container" style="min-height:260px;" tabindex="0" aria-label="Line graph for B" role="region"><canvas id="compareGraphB"></canvas></div>'),e+="</div>"):e+='<div class="text-muted small text-center" style="min-height:200px;">No snapshot selected for B</div>',e+="</div>",e}()),"chart"===u&&Array.isArray(f)&&f.length>0){const e=document.getElementById("compareChartA");if(e){const t=Object.keys(f[0]);let a=t.find((e=>"string"==typeof f[0][e]))||t[0],s=t.find((e=>"number"==typeof f[0][e]))||t[1];const r=f.map((e=>e[a])),i=f.map((e=>e[s]));window.compareChartAInstance&&window.compareChartAInstance.destroy(),window.compareChartAInstance=new n(e.getContext("2d"),{type:"bar",data:{labels:r,datasets:[{label:s,data:i,backgroundColor:"rgba(0,123,255,0.5)",borderColor:"rgba(0,123,255,1)",borderWidth:1}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1}}}})}}if("graph"===u&&Array.isArray(f)&&f.length>0){const e=document.getElementById("compareGraphA");if(e){const t=Object.keys(f[0]);let a=t.find((e=>"string"==typeof f[0][e]))||t[0],s=t.find((e=>"number"==typeof f[0][e]))||t[1];const r=f.map(((e,t)=>e[a]||t+1)),i=f.map((e=>e[s]));window.compareGraphAInstance&&window.compareGraphAInstance.destroy(),window.compareGraphAInstance=new n(e.getContext("2d"),{type:"line",data:{labels:r,datasets:[{label:s,data:i,backgroundColor:"rgba(40,167,69,0.5)",borderColor:"rgba(40,167,69,1)",borderWidth:2,fill:!1}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1}}}})}}if("chart"===g&&Array.isArray(b)&&b.length>0){const e=document.getElementById("compareChartB");if(e){const t=Object.keys(b[0]);let a=t.find((e=>"string"==typeof b[0][e]))||t[0],s=t.find((e=>"number"==typeof b[0][e]))||t[1];const r=b.map((e=>e[a])),i=b.map((e=>e[s]));window.compareChartBInstance&&window.compareChartBInstance.destroy(),window.compareChartBInstance=new n(e.getContext("2d"),{type:"bar",data:{labels:r,datasets:[{label:s,data:i,backgroundColor:"rgba(0,123,255,0.5)",borderColor:"rgba(0,123,255,1)",borderWidth:1}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1}}}})}}if("graph"===g&&Array.isArray(b)&&b.length>0){const e=document.getElementById("compareGraphB");if(e){const t=Object.keys(b[0]);let a=t.find((e=>"string"==typeof b[0][e]))||t[0],s=t.find((e=>"number"==typeof b[0][e]))||t[1];const r=b.map(((e,t)=>e[a]||t+1)),i=b.map((e=>e[s]));window.compareGraphBInstance&&window.compareGraphBInstance.destroy(),window.compareGraphBInstance=new n(e.getContext("2d"),{type:"line",data:{labels:r,datasets:[{label:s,data:i,backgroundColor:"rgba(40,167,69,0.5)",borderColor:"rgba(40,167,69,1)",borderWidth:2,fill:!1}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1}}}})}}}function k(){i.update({html:"<div class='d-flex flex-row' style='height:70vh;min-height:500px;max-height:80vh;'>\n                        <div id='timeline-sidebar-modal'></div>\n                        <div class='flex-fill px-3' style='overflow:auto;max-width:calc(100% - 220px);'>\n                            <div class='d-flex flex-row gap-3 w-100 h-100'>\n                                <div class='flex-fill' id='compare-section-a'></div>\n                                <div class='flex-fill' id='compare-section-b'></div>\n                            </div>\n                        </div>\n                    </div>"}),e("#timeline-sidebar-modal").html(function(e,t){let n='<div class="timeline-sidebar" style="width:220px;max-width:220px;overflow-y:auto;height:100%;background:#f8f9fa;border-right:1.5px solid #e0e0e0;padding:0.5rem 0.25rem;">';return n+='<div class="d-flex flex-column gap-2 mb-3">',n+='<button class="btn btn-outline-primary btn-sm w-100 mb-1 fetch-current-btn" title="Fetch current data from database" aria-label="Fetch current data"><i class="fa fa-sync"></i> Fetch Current Data</button>',y&&"current"===l&&(n+='<div class="mb-2">\n                        <input type="text" id="add-timeline-note" class="form-control form-control-sm mb-1" placeholder="Enter snapshot name (required)" required aria-label="Snapshot name">\n                        <div class="invalid-feedback" style="display:none;">Snapshot name is required.</div>\n                        <button class="btn btn-outline-success btn-sm w-100 add-timeline-btn" id="add-timeline-btn" title="Create snapshot from current data" aria-label="Create snapshot from current data" disabled><span class="btn-label"><i class="fa fa-plus"></i> Create Snapshot From Current Data</span><span class="spinner-border spinner-border-sm ms-2" id="snapshot-loading" style="display:none;" role="status" aria-hidden="true"></span></button>\n                    </div>'),n+='<div class="small text-muted text-center px-2 py-1 mb-2" style="border: 1px dashed #dee2e6; border-radius: 4px;">Click or <b>drag</b> snapshots to select for comparison. Each snapshot gets a unique color. You can also drag and drop from the side menu into the snapshot viewer.</div>',n+="</div>",n+='<div class="timeline-list">',0===r.length?n+=h?`<div class="text-danger small text-center py-2">Error: ${h}</div>`:'<div class="text-muted small text-center py-2">No timeline snapshots yet. [DEBUG: Timeline is empty]</div>':r.forEach(((s,r)=>{const i=[{bg:"#e3f2fd",border:"#2196f3",text:"#1976d2"},{bg:"#f3e5f5",border:"#9c27b0",text:"#7b1fa2"},{bg:"#e8f5e8",border:"#4caf50",text:"#388e3c"},{bg:"#fff3e0",border:"#ff9800",text:"#f57c00"},{bg:"#fce4ec",border:"#e91e63",text:"#c2185b"},{bg:"#e0f2f1",border:"#009688",text:"#00695c"},{bg:"#f1f8e9",border:"#8bc34a",text:"#689f38"},{bg:"#fff8e1",border:"#ffc107",text:"#ffa000"}],o=i[r%i.length],l=e===s.id||t===s.id,d=l?`background-color: ${o.bg}; border-color: ${o.border}; border-width: 2px;`:"background-color: #fff; border-color: #dee2e6; border-width: 1px;",c=s.is_current_version?'<span class="badge bg-primary ms-1">Current</span>':"",p=l?'draggable="false"':'draggable="true"',h=l?"This snapshot is currently selected":"Drag to assign to Snapshot A or B",u=l?'<span class="text-muted small">(Selected)</span>':"";n+=`<div class="timeline-item p-2 mb-1 rounded border ${l?"drag-disabled":"draggable-snapshot"}" \n                                      style="cursor:pointer; animation:fadeIn .3s; ${d}" \n                                      data-snap-id="${s.id}" \n                                      data-color-bg="${o.bg}" \n                                      data-color-border="${o.border}" \n                                      data-color-text="${o.text}"\n                                      tabindex="0" \n                                      aria-label="Snapshot from ${a.formatTimestamp(s.created_at)}${s.is_current_version?" (current)":""}"\n                                      ${p}\n                                      title="${h}"\n                                      >\n                            <div class="d-flex justify-content-between align-items-center">\n                                <span class="fw-bold small">${a.formatTimestamp(s.created_at)}</span>\n                                ${c}\n                            </div>\n                            <div class="small text-muted">${s.note?s.note:""} ${u}</div>\n                            <div class="d-flex gap-1 mt-1">\n                                <button class="btn btn-outline-secondary btn-xs btn-sm set-current-btn" data-snap-id="${s.id}" title="Set as current version" aria-label="Set as current"><i class="fa fa-check"></i></button>\n                            </div>\n                        </div>`})),n+="</div></div>",n}(l,d)),_(),e(".fetch-current-btn").off("click").on("click",(function(){!function(e,t){"a"===e&&(c=!0),"b"===e&&(p=!0),_(),a.ajaxWithAuth({url:`${this.backendUrl}/ai-reports/${s}/data/current`,method:"GET",success:function(a){o=a.data||[],"a"===e?(f=o,l="current",c=!1):(b=o,d="current",p=!1),y=!0,_(),t&&t()},error:function(){h="Failed to fetch current data.","a"===e&&(c=!1),"b"===e&&(p=!1),_(),t&&t()}})}(x)})),e(".timeline-item").off("click").on("click",(function(t){const a=e(this).data("snap-id");"a"===x?v(a,"a",(()=>{x="b"})):v(a,"b",(()=>{x="a"}))})),e(".display-type-switcher-a .btn-icon").off("click").on("click",(function(){u=e(this).data("type"),_()})),e(".display-type-switcher-b .btn-icon").off("click").on("click",(function(){g=e(this).data("type"),_()})),e(".draggable-snapshot").attr("draggable",!0).off("dragstart").on("dragstart",(function(t){t.originalEvent.dataTransfer.setData("text/plain",e(this).data("snap-id")),e(this).addClass("dragging")})),e(".draggable-snapshot").off("dragend").on("dragend",(function(t){e(this).removeClass("dragging")})),e(".compare-section").off("dragover").on("dragover",(function(t){t.preventDefault(),e(this).addClass("drag-over-section")})),e(".compare-section").off("dragleave").on("dragleave",(function(t){e(this).removeClass("drag-over-section")})),e(".compare-section").off("drop").on("drop",(function(t){t.preventDefault(),e(this).removeClass("drag-over-section");const a=t.originalEvent.dataTransfer.getData("text/plain"),n=e(this).data("drop-target");v(a,n,(()=>{x="a"===n?"b":"a"}))})),0===e("#compare-section-highlight-style").length&&e("head").append('<style id="compare-section-highlight-style">.drag-over-section { box-shadow: 0 0 0 4px #90caf9 !important; border-color: #1976d2 !important; }</style>')}i.fire({title:"<span class='fw-bold'>Compare Report Data</span>",html:"<div class='d-flex flex-row' style='height:60vh;min-height:400px;max-height:70vh;'>\n                    <div id='timeline-sidebar-modal'></div>\n                    <div class='flex-fill px-3' style='overflow:auto;max-width:calc(100% - 220px);'>\n                        <div class='d-flex flex-row gap-3 w-100 h-100'>\n                            <div class='flex-fill' id='compare-section-a'></div>\n                            <div class='flex-fill' id='compare-section-b'></div>\n                        </div>\n                    </div>\n                </div>",width:"90vw",heightAuto:!1,showCancelButton:!0,showConfirmButton:!1,customClass:{popup:"swal2-modal-compare-data"},didOpen:()=>{!function(e){a.ajaxWithAuth({url:`${this.backendUrl}/ai-reports/${s}/snapshots`,method:"GET",success:function(t){r=t.snapshots||[],m=(r.find((e=>e.is_current_version))||{}).id||null,e&&e()},error:function(){h="Failed to load timeline.",e&&e()}})}((()=>{r.length>0?(l=r.find((e=>e.is_current_version))?.id||r[0].id,d=r.length>1?r[1].id:null,l&&d?function(e,t,n){c=!0,p=!0,_(),a.ajaxWithAuth({url:`${this.backendUrl}/ai-reports/${s}/snapshots/${e}/compare/${t}`,method:"GET",success:function(e){f=e.a.data,b=e.b.data,c=!1,p=!1,_(),n&&n(e)},error:function(){h="Failed to compare snapshots.",c=!1,p=!1,_(),n&&n()}})}(l,d,(()=>{x="a",k()})):l?v(l,"a",(()=>{x="b",k()})):k()):k()}))}})},renderDiffTable:function(e,t){if(!Array.isArray(e)||0===e.length)return'<div class="text-muted small">No data</div>';const a=Object.keys(e[0]);let n='<div class="table-responsive"><table class="table table-striped table-hover table-sm">';return n+="<thead><tr>",a.forEach((e=>{n+=`<th>${e}</th>`})),n+="</tr></thead><tbody>",e.forEach(((e,s)=>{n+="<tr>",a.forEach((a=>{let r=!1;t&&Array.isArray(t)&&t[s]&&t[s][a]!==e[a]&&(r=!0),n+=`<td${r?' style="background:#ffe5e5;"':""}>${null!=e[a]?e[a]:""}</td>`})),n+="</tr>"})),n+="</tbody></table></div>",n},testMCQ:function(){this.addMessage("I found an existing wizard report that might meet your needs. However, it doesn't include all the fields you requested.\n\nWhat would you like to do?\n\nA. Use the existing wizard report as-is\nB. Generate a new custom SQL report with all fields\nC. Use the wizard report and create a separate supplementary report\nD. Cancel and try a different approach","ai")},testMCQNumbered:function(){this.addMessage("Please select your preferred report format:\n\n1. PDF Export with charts and graphs\n2. Excel spreadsheet with raw data\n3. CSV file for data analysis\n4. Interactive web dashboard\n5. Email summary report","ai")}};return window.assistant=o,o}));