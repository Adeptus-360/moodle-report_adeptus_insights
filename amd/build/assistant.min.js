/**
 * AI Assistant interface for Adeptus Insights plugin.
 *
 * Handles the AI chat interface, message sending/receiving, report generation,
 * chart rendering, and conversation management for the insights assistant.
 *
 * @module     report_adeptus_insights/assistant
 * @copyright  2026 Adeptus 360 <info@adeptus360.com>
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("report_adeptus_insights/assistant",["jquery","core/ajax","core/notification","core/chartjs","core/templates","core/str","report_adeptus_insights/auth_utils"],(function($,Ajax,Notification,Chart,Templates,Str,AuthUtils){var Swal=window.Swal,strings={},loadStrings=function(){return Str.get_strings([{key:"js_generating_report",component:"report_adeptus_insights"},{key:"js_token_limit_reached",component:"report_adeptus_insights"},{key:"js_token_limit_message",component:"report_adeptus_insights"},{key:"js_view_usage",component:"report_adeptus_insights"},{key:"js_report_limit_reached",component:"report_adeptus_insights"},{key:"js_report_limit_message",component:"report_adeptus_insights"},{key:"js_view_reports",component:"report_adeptus_insights"},{key:"js_upgrade_your_plan",component:"report_adeptus_insights"},{key:"js_upgrade_plan_message",component:"report_adeptus_insights"},{key:"js_ai_service_busy",component:"report_adeptus_insights"},{key:"js_ai_service_busy_message",component:"report_adeptus_insights"},{key:"js_try_again",component:"report_adeptus_insights"},{key:"js_loading_usage_data",component:"report_adeptus_insights"},{key:"js_fetching_usage_info",component:"report_adeptus_insights"},{key:"js_applying_filters",component:"report_adeptus_insights"},{key:"js_report_chart",component:"report_adeptus_insights"},{key:"js_please_enter_message",component:"report_adeptus_insights"},{key:"js_oops",component:"report_adeptus_insights"},{key:"js_save_your_report",component:"report_adeptus_insights"},{key:"js_report_name_label",component:"report_adeptus_insights"},{key:"js_enter_report_name",component:"report_adeptus_insights"},{key:"js_category_label",component:"report_adeptus_insights"},{key:"js_select_category",component:"report_adeptus_insights"},{key:"js_save_report",component:"report_adeptus_insights"},{key:"js_report_not_found",component:"report_adeptus_insights"},{key:"js_export_not_available",component:"report_adeptus_insights"},{key:"js_not_eligible_export",component:"report_adeptus_insights"},{key:"js_saving_default_view",component:"report_adeptus_insights"},{key:"js_default_view_saved",component:"report_adeptus_insights"},{key:"js_save_failed",component:"report_adeptus_insights"},{key:"js_could_not_save_view",component:"report_adeptus_insights"},{key:"js_unable_verify_eligibility",component:"report_adeptus_insights"},{key:"js_unable_verify_export",component:"report_adeptus_insights"},{key:"js_authentication_required",component:"report_adeptus_insights"},{key:"js_auth_required_message",component:"report_adeptus_insights"},{key:"js_refresh_page",component:"report_adeptus_insights"},{key:"js_delete_chat",component:"report_adeptus_insights"},{key:"js_delete_chat_confirm",component:"report_adeptus_insights"},{key:"js_yes_delete",component:"report_adeptus_insights"},{key:"js_chat_deleted",component:"report_adeptus_insights"},{key:"js_error_deleting_chat",component:"report_adeptus_insights"},{key:"js_new_chat",component:"report_adeptus_insights"},{key:"js_no_chats_yet",component:"report_adeptus_insights"},{key:"js_start_conversation",component:"report_adeptus_insights"},{key:"js_error_loading_chats",component:"report_adeptus_insights"},{key:"js_report_saved",component:"report_adeptus_insights"},{key:"js_report_saved_message",component:"report_adeptus_insights"},{key:"js_error_saving_report",component:"report_adeptus_insights"},{key:"js_delete_report",component:"report_adeptus_insights"},{key:"js_delete_report_confirm",component:"report_adeptus_insights"},{key:"js_report_deleted",component:"report_adeptus_insights"},{key:"js_error_deleting_report",component:"report_adeptus_insights"},{key:"js_no_reports",component:"report_adeptus_insights"},{key:"js_generate_reports_message",component:"report_adeptus_insights"},{key:"js_error_loading_reports",component:"report_adeptus_insights"},{key:"js_no_data_available",component:"report_adeptus_insights"},{key:"js_export_success",component:"report_adeptus_insights"},{key:"js_export_error",component:"report_adeptus_insights"},{key:"js_processing",component:"report_adeptus_insights"},{key:"js_please_wait",component:"report_adeptus_insights"},{key:"js_success",component:"report_adeptus_insights"},{key:"js_error",component:"report_adeptus_insights"},{key:"js_warning",component:"report_adeptus_insights"},{key:"js_confirm",component:"report_adeptus_insights"},{key:"js_yes",component:"report_adeptus_insights"},{key:"js_no",component:"report_adeptus_insights"},{key:"js_deleted",component:"report_adeptus_insights"},{key:"js_saved",component:"report_adeptus_insights"},{key:"js_untitled_report",component:"report_adeptus_insights"},{key:"js_general_category",component:"report_adeptus_insights"},{key:"loading",component:"report_adeptus_insights"},{key:"close",component:"report_adeptus_insights"},{key:"cancel",component:"report_adeptus_insights"},{key:"export_premium_feature",component:"report_adeptus_insights"},{key:"export_premium_description",component:"report_adeptus_insights"},{key:"export_free_plan_info",component:"report_adeptus_insights"},{key:"export_paid_plan_info",component:"report_adeptus_insights"},{key:"upgrade_now",component:"report_adeptus_insights"},{key:"js_view_plans",component:"report_adeptus_insights"},{key:"js_monthly_allowance_used",component:"report_adeptus_insights"},{key:"js_tokens_reset_monthly",component:"report_adeptus_insights"},{key:"js_used_of_reports",component:"report_adeptus_insights"},{key:"js_delete_reports_or_upgrade",component:"report_adeptus_insights"},{key:"js_unlock_features",component:"report_adeptus_insights"},{key:"js_current_usage",component:"report_adeptus_insights"},{key:"js_unlimited",component:"report_adeptus_insights"},{key:"js_reports",component:"report_adeptus_insights"},{key:"js_report_limit_reached_banner",component:"report_adeptus_insights"},{key:"js_manage_reports",component:"report_adeptus_insights"},{key:"js_upgrade_plan",component:"report_adeptus_insights"},{key:"js_ask_moodle_data",component:"report_adeptus_insights"},{key:"js_report_limit_placeholder",component:"report_adeptus_insights"},{key:"js_export_premium_feature",component:"report_adeptus_insights"},{key:"js_export_premium_description",component:"report_adeptus_insights"},{key:"js_free_plan_exports",component:"report_adeptus_insights"},{key:"js_paid_plan_exports",component:"report_adeptus_insights"},{key:"js_free_plan_label",component:"report_adeptus_insights"},{key:"js_paid_plans_label",component:"report_adeptus_insights"},{key:"js_no_reports_generated",component:"report_adeptus_insights"},{key:"js_ask_ai_create_reports",component:"report_adeptus_insights"},{key:"js_compare_report_data",component:"report_adeptus_insights"},{key:"js_failed_load_usage",component:"report_adeptus_insights"},{key:"js_failed_load_filtered",component:"report_adeptus_insights"}]).then((function(results){return strings={generating_report:results[0],token_limit_reached:results[1],token_limit_message:results[2],view_usage:results[3],report_limit_reached:results[4],report_limit_message:results[5],view_reports:results[6],upgrade_your_plan:results[7],upgrade_plan_message:results[8],ai_service_busy:results[9],ai_service_busy_message:results[10],try_again:results[11],loading_usage_data:results[12],fetching_usage_info:results[13],applying_filters:results[14],report_chart:results[15],please_enter_message:results[16],oops:results[17],save_your_report:results[18],report_name_label:results[19],enter_report_name:results[20],category_label:results[21],select_category:results[22],save_report:results[23],report_not_found:results[24],export_not_available:results[25],not_eligible_export:results[26],saving_default_view:results[27],default_view_saved:results[28],save_failed:results[29],could_not_save_view:results[30],unable_verify_eligibility:results[31],unable_verify_export:results[32],authentication_required:results[33],auth_required_message:results[34],refresh_page:results[35],delete_chat:results[36],delete_chat_confirm:results[37],yes_delete:results[38],chat_deleted:results[39],error_deleting_chat:results[40],new_chat:results[41],no_chats_yet:results[42],start_conversation:results[43],error_loading_chats:results[44],report_saved:results[45],report_saved_message:results[46],error_saving_report:results[47],delete_report:results[48],delete_report_confirm:results[49],report_deleted:results[50],error_deleting_report:results[51],no_reports:results[52],generate_reports_message:results[53],error_loading_reports:results[54],no_data_available:results[55],export_success:results[56],export_error:results[57],processing:results[58],please_wait:results[59],success:results[60],error:results[61],warning:results[62],confirm:results[63],yes:results[64],no:results[65],deleted:results[66],saved:results[67],untitled_report:results[68],general_category:results[69],loading:results[70],close:results[71],cancel:results[72],export_premium_feature:results[73],export_premium_description:results[74],export_free_plan_info:results[75],export_paid_plan_info:results[76],upgrade_now:results[77],view_plans:results[78],monthly_allowance_used:results[79],tokens_reset_monthly:results[80],used_of_reports:results[81],delete_reports_or_upgrade:results[82],unlock_features:results[83],current_usage:results[84],unlimited:results[85],reports:results[86],report_limit_reached_banner:results[87],manage_reports:results[88],upgrade_plan:results[89],ask_moodle_data:results[90],report_limit_placeholder:results[91],export_is_premium:results[92],export_premium_desc:results[93],free_plan_exports:results[94],paid_plan_exports:results[95],free_plan_label:results[96],paid_plans_label:results[97],no_reports_generated:results[98],ask_ai_create_reports:results[99],compare_report_data:results[100],failed_load_usage:results[101],failed_load_filtered:results[102]}}))},getString=function(key,fallback){return strings[key]||fallback||key},assistant={currentChatId:0,currentMCQ:null,isSending:!1,mcqQueue:[],reportsDataTable:null,cachedReports:[],cachedCategories:[],_initCalled:!1,isCreditLimitExceeded:!1,backendUrl:"https://backend.adeptus360.com/api/v1",isFreePlan:!0,_currentReportView:"table",_currentReportData:null,_currentReportName:"",currentViewedReport:null,currentViewedReportData:null,isReportLimitReached:!1,reportsUsed:0,reportsLimit:0,reportsRemaining:0,reportEligibilityChecked:!1,init:function(config){var authenticated,isFreePlan,backendUrl,self=this;if(config&&"object"==typeof config&&!Array.isArray(config)?(authenticated=!1!==config.authenticated,isFreePlan=!1!==config.isFreePlan,backendUrl=config.backendUrl||this.backendUrl):(authenticated=!1!==config,isFreePlan=!1!==arguments[1],backendUrl=this.backendUrl),this.isFreePlan=isFreePlan,this.authenticated=authenticated,backendUrl&&(this.backendUrl=backendUrl),!this._initCalled){this._initCalled=!0,this.currentChatId=0;var getAssistantContainer=function(){return $("#adeptus-assistant-container")};getAssistantContainer().hide(),this.initializeLoaderStyles(),loadStrings().then((function(){self._initAfterStrings(getAssistantContainer)})).catch((function(){self._initAfterStrings(getAssistantContainer)}))}},_initAfterStrings:function(getAssistantContainer){var self=this;try{if(AuthUtils.isAuthenticated()){var authStatus=AuthUtils.getAuthStatus(),userName=authStatus&&authStatus.user&&authStatus.user.name||"User";this.setUserName(userName),this.updateSubscriptionInfo(),this.setupEventListeners(),this.loadChatHistory(),this.loadReportsHistory(),this.loadCategories(),this.checkReportEligibility(),getAssistantContainer().fadeIn(200)}else AuthUtils.refreshAuthStatus(),setTimeout((function(){if(AuthUtils.isAuthenticated()){var authStat=AuthUtils.getAuthStatus(),uName=authStat&&authStat.user&&authStat.user.name||"User";self.setUserName(uName),self.updateSubscriptionInfo(),self.setupEventListeners(),self.loadChatHistory(),self.loadReportsHistory(),self.loadCategories(),self.checkReportEligibility(),getAssistantContainer().fadeIn(200)}else self.showAuthenticationError()}),500)}catch(error){this.setupEventListeners(),this.checkReportEligibility(),getAssistantContainer().fadeIn(200)}},initializeLoaderStyles:function(){if(0===$("#ai-loader-styles").length){$("head").append('<style id="ai-loader-styles">.adeptus-ai-thinking-loader-wrapper {animation: fadeInLoader 0.3s ease-out forwards;}.adeptus-ai-thinking-loader {opacity: 1 !important;}@keyframes bounce-loader {0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }40% { transform: scale(1.2); opacity: 1; }}@keyframes fadeInLoader {from { opacity: 0; transform: translateY(10px); }to { opacity: 1; transform: translateY(0); }}@keyframes pulse-glow-loader {0% { box-shadow: 0 0 0 0 rgba(14, 165, 233, 0.4); }70% { box-shadow: 0 0 0 8px rgba(14, 165, 233, 0); }100% { box-shadow: 0 0 0 0 rgba(14, 165, 233, 0); }}</style>')}},showAuthenticationError:function(){var assistantContainer=$("#adeptus-assistant-container"),authReqTitle=getString("authentication_required","Authentication Required"),authReqMsg=getString("auth_required_message","You need to be authenticated to use the AI Assistant. Please contact your administrator."),refreshBtn=getString("refresh_page","Refresh Page");assistantContainer.html('<div class="alert alert-danger"><h4>'+authReqTitle+"</h4><p>"+authReqMsg+'</p><button class="btn btn-primary" onclick="location.reload()">'+refreshBtn+"</button></div>").show()},setupEventListeners:function(){var self=this;$("#send-button").on("click",(function(){self.sendMessage()})),$("#message-input").on("keydown",(function(e){"Enter"!==e.key||e.shiftKey||(e.preventDefault(),self.sendMessage())})),$("#chart-type").on("change",(function(){self.updateChart()})),$("#message-input").on("input",(function(){this.style.height="auto",this.style.height=this.scrollHeight+"px"})),$("#create-new-chat").on("click",(function(){self.createNewChat()}))},clearMCQ:function(){this.currentMCQ=null,$("#adeptus-mcq-container").empty().hide(),$("#message-input").prop("disabled",!1),$("#send-button").prop("disabled",!1)},extractMCQFromText:function(text){if(!text||"string"!=typeof text)return null;try{var jsonArrayMatch=text.match(/```json\s*(\[[\s\S]*?\])\s*```/);if(jsonArrayMatch){var parsedQuestions=JSON.parse(jsonArrayMatch[1]);if(Array.isArray(parsedQuestions)&&parsedQuestions.length>0&&"mcq"===parsedQuestions[0].type)return{questions:parsedQuestions,selectedAnswer:null}}var jsonMatches=text.match(/\{[\s\S]*?\}/g)||[],questions=[];if(jsonMatches.forEach((function(jsonStr){try{var obj=JSON.parse(jsonStr);"mcq"===obj.type&&Array.isArray(obj.options)&&questions.push(obj)}catch(parseErr){}})),questions.length>0)return{questions:questions,selectedAnswer:null}}catch(err){}return null},renderMCQHistory:function(questions,selectedAnswer){selectedAnswer=selectedAnswer||null;var html='<div class="adeptus-mcq-history-container" style="display:flex; flex-direction:column; gap:15px;">';return questions.forEach((function(mcq,idx){html+='<div class="adeptus-mcq-history-item" style="background:#f8f9fa; padding:15px; border-radius:8px; border:1px solid #dee2e6; box-shadow:0 1px 3px rgba(0,0,0,0.05);"><p style="font-weight:600; margin-bottom:12px; color:#333; font-size:14px;"><i class="fa fa-question-circle" style="color:#007bff; margin-right:8px;"></i>'+mcq.question+'</p><div class="adeptus-mcq-options" style="margin-left:24px;">',mcq.options.forEach((function(option){var optionText="string"==typeof option?option:option.label||option,isSelected=selectedAnswer&&(selectedAnswer===option||selectedAnswer===optionText||selectedAnswer.indexOf&&-1!==selectedAnswer.indexOf(optionText));html+='<div class="form-check" style="padding:10px 14px; border-radius:6px; margin-bottom:8px; '+(isSelected?"background:#e3f0ff; border:2px solid #007bff; font-weight:600;":"border:1px solid #ced4da;")+' transition:all 0.2s;"><input class="form-check-input" type="radio" name="mcq-'+idx+'" disabled '+(isSelected?"checked":"")+' style="margin-top:0.3em;"><label class="form-check-label" style="color:#555; cursor:not-allowed; margin-left:5px;">'+(isSelected?'<i class="fa fa-check-circle" style="color:#28a745; margin-right:5px;"></i>':"")+optionText+"</label></div>"})),html+='</div><p style="margin-top:12px; margin-bottom:0; font-size:11px; color:#6c757d; font-style:italic;"><i class="fa fa-info-circle" style="margin-right:4px;"></i>Previous question from chat history</p></div>'})),html+="</div>"},checkAuth:function(){return AuthUtils.isAuthenticated()?(this.loadChatHistory(),!0):(this.showAuthenticationError(),!1)},handleResponse:function(response){if(response.error){if("credit_limit"===response.error_type||"token_limit"===response.error_type)return void this.handleCreditLimitError(response.message);if("report_limit"===response.error_type)return void this.handleReportLimitError(response.message);this.addMessage(response.message,"error"),this.showResendIconOnLastUserMessage()}else{if("mcq"===response.type){if(response.questions&&response.questions.length>0){const firstQuestion=response.questions[0],mcqText="Question: ".concat(firstQuestion.question,"\nOptions: ").concat(firstQuestion.options.join(", "));this.addMessage(mcqText,"ai",!1,null,null,null,response.credit_info)}return void this.enqueueMCQs(response.questions)}if("sql"===response.type||"report"===response.type){if(response.awaiting_confirmation&&response.report){const sqlQuery=response.sql||response.report.sql_query||response.report.sql;return!response.execution_required&&response.report_data||!sqlQuery?void this.showReportConfirmation(response.report,response.report_data||null,response.message,response.credit_info,response.execution_error||null):void this.executeReportLocally(sqlQuery,response.report.params||{}).then((executionResult=>{this.showReportConfirmation(response.report,executionResult.data||null,response.message,response.credit_info,executionResult.error||null)})).catch((error=>{this.showReportConfirmation(response.report,null,response.message,response.credit_info,error.message||"Failed to execute report locally")}))}const reportData=response.report||response;return this.addMessage(reportData.description||response.message,"ai",!0,reportData,null,null,response.credit_info),this.updateChatHistoryBadge(this.currentChatId),this.cachedReports.unshift(reportData),this.updateReportsHistory(this.cachedReports),this.reportsDataTable&&(this.reportsDataTable.destroy(),this.reportsDataTable=null),setTimeout((()=>{try{const tableElement=document.getElementById("reports-history-table");if(tableElement){const thead=tableElement.querySelector("thead"),tbody=tableElement.querySelector("tbody");if(thead&&tbody&&thead.rows.length>0&&thead.rows[0].cells.length>0){const headerCells=thead.rows[0].cells.length,dataRows=tbody.rows;let dataCells=0;dataRows.length>0&&(dataCells=dataRows[0].cells.length),headerCells===dataCells&&headerCells>0&&dataRows.length>0&&!dataRows[0].cells[0].textContent.includes("No reports")&&(this.reportsDataTable=new simpleDatatables.DataTable("#reports-history-table",{searchable:!0,fixedHeight:!1,perPage:10,loading:!1}),setTimeout((()=>{$(".datatable-wrapper").removeClass("datatable-loading"),$("#report-history-table-wrapper .datatable-wrapper").removeClass("datatable-loading")}),100))}}}catch(error){}}),100),void Swal.fire({title:getString("generating_report","Generating Report"),html:'\n                        <div class="text-center">\n                            <div class="spinner-border text-primary mb-3" role="status">\n                            </div>\n                            <p>'.concat(getString("please_wait","Please wait"),"...</p>\n                        </div>\n                    "),showConfirmButton:!1,allowOutsideClick:!1,allowEscapeKey:!1,timer:2e3,timerProgressBar:!0}).then((()=>{this.switchToReportsTab(),this.displayCurrentReport(response.report),this.executeReport(response.report.slug)}))}this.addMessage(response.message,"ai",!1,null,null,null,response.credit_info)}response.data&&this.updateReportData(response.data),response.visualizations&&this.updateVisualizations(response.visualizations),response.credit_info&&this.showCreditUsageFeedback(response.credit_info),this.scrollToBottom()},showCreditUsageFeedback:function(creditInfo){if(!creditInfo)return;const notification=$('\n                <div class="adeptus-credit-usage-notification" style="\n                    position: fixed;\n                    top: 20px;\n                    right: 20px;\n                    background: #28a745;\n                    color: white;\n                    padding: 12px 20px;\n                    border-radius: 6px;\n                    box-shadow: 0 4px 12px rgba(0,0,0,0.15);\n                    z-index: 9999;\n                    font-size: 14px;\n                    font-weight: 500;\n                    opacity: 0;\n                    transform: translateX(100%);\n                    transition: all 0.3s ease;\n                ">\n                    <i class="fa fa-coins me-2"></i>\n                    <span class="adeptus-credit-text">Credits used: '.concat(creditInfo.credits_charged||0," (").concat(creditInfo.credit_type||"basic",")</span>\n                </div>\n            "));$("body").append(notification),setTimeout((()=>{notification.css({opacity:"1",transform:"translateX(0)"})}),100),setTimeout((()=>{notification.css({opacity:"0",transform:"translateX(100%)"}),setTimeout((()=>{notification.remove()}),300)}),3e3),this.updateSubscriptionInfoWithCreditUsage(creditInfo)},updateSubscriptionInfoWithCreditUsage:function(creditInfo){const authStatus=AuthUtils.getAuthStatus();if(!authStatus||!authStatus.subscription)return;const subscription=authStatus.subscription,creditsUsed=creditInfo.credits_charged||0;"premium"===creditInfo.credit_type?subscription.premium_credits_used_this_month=(subscription.premium_credits_used_this_month||0)+creditsUsed:subscription.basic_credits_used_this_month=(subscription.basic_credits_used_this_month||0)+creditsUsed,subscription.ai_credits_used_this_month=(subscription.ai_credits_used_this_month||0)+creditsUsed,this.animateCreditCounterUpdate(creditInfo.credit_type,creditsUsed),this.updateSubscriptionInfo()},animateCreditCounterUpdate:function(creditType){const $counter=$("premium"===creditType?".premium-credits-counter":".basic-credits-counter");$counter.length&&($counter.addClass("adeptus-credit-update-highlight"),setTimeout((()=>{$counter.removeClass("adeptus-credit-update-highlight")}),1e3));const $totalCounter=$(".adeptus-total-credits-counter");$totalCounter.length&&($totalCounter.addClass("adeptus-credit-update-highlight"),setTimeout((()=>{$totalCounter.removeClass("adeptus-credit-update-highlight")}),1e3))},addMessage:function(text,type){let isReportLink=arguments.length>2&&void 0!==arguments[2]&&arguments[2],reportData=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,messageId=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,timestamp=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null,creditInfo=arguments.length>6&&void 0!==arguments[6]?arguments[6]:null;"ai"===type&&text&&(text=text.replace(/\nConfidence:\s*\d+%\n?/gi,"\n").replace(/Confidence:\s*\d+%/gi,"").trim());const template=document.getElementById("message-template"),frag=template.content.cloneNode(!0),messageEl=frag.querySelector(".adeptus-message");messageEl.classList.add("adeptus-"+type+"-message"),messageId&&messageEl.setAttribute("data-message-id",messageId);const mcqData=this.extractMCQFromText(text);if(mcqData&&mcqData.questions.length>0){const mcqHtml=this.renderMCQHistory(mcqData.questions,mcqData.selectedAnswer);frag.querySelector(".adeptus-message-text").innerHTML=mcqHtml}else if(isReportLink&&reportData){frag.querySelector(".adeptus-message-text").innerHTML='\n                    <a href="javascript:void(0)"\n                       class="adeptus-report-link"\n                       data-report-slug="'.concat(reportData.slug,'"\n                       style="color: #007bff; text-decoration: none; cursor:pointer; padding:4px 8px; border:1px solid #dee2e6; border-radius:4px; background:#f8f9fa; display:inline-block; transition:all 0.2s;">\n                        ðŸ“Š ').concat(text,"\n                    </a>\n                ");const self=this;setTimeout((()=>{const link=messageEl.querySelector(".adeptus-report-link");link.onclick=function(){self.openReportFromLink(link.getAttribute("data-report-slug"))},link.onmouseenter=function(){$(this).css({"background-color":"#e9ecef","border-color":"#adb5bd",transform:"translateY(-1px)"})},link.onmouseleave=function(){$(this).css({"background-color":"#f8f9fa","border-color":"#dee2e6",transform:"translateY(0)"})}}),0)}else if("report-preview"===type||"system-action"===type)frag.querySelector(".adeptus-message-text").innerHTML=text,messageEl.classList.add("adeptus-"+type+"-message"),("report-preview"===type||"system-action"===type)&&(messageEl.style.background="transparent",messageEl.style.padding="0",messageEl.style.border="none",messageEl.style.maxWidth="100%");else if("ai"===type&&this.isMultipleChoiceQuestion(text)){const mcqHtml=this.renderMultipleChoiceOptions(text);frag.querySelector(".adeptus-message-text").innerHTML=mcqHtml}else frag.querySelector(".adeptus-message-text").textContent=text;"ai"===type&&creditInfo&&this.addCreditInfoToMessage(frag,creditInfo);const timeEl=frag.querySelector(".adeptus-message-time");return timeEl.textContent=this.formatTimestamp(timestamp||(new Date).toISOString()),$("#adeptus-chat-container").append(frag),this.scrollToBottom(),$(messageEl)},addCreditInfoToMessage:function(frag,creditInfo){const messageEl=frag.querySelector(".adeptus-message"),creditBadge=document.createElement("div");creditBadge.className="adeptus-credit-info-badge",creditBadge.style.cssText="\n                display: inline-block;\n                margin-left: 8px;\n                padding: 2px 6px;\n                border-radius: 12px;\n                font-size: 11px;\n                font-weight: 500;\n                text-transform: uppercase;\n                letter-spacing: 0.5px;\n            ","premium"===creditInfo.credit_type?(creditBadge.style.backgroundColor="#6f42c1",creditBadge.style.color="white",creditBadge.textContent="Premium"):(creditBadge.style.backgroundColor="#28a745",creditBadge.style.color="white",creditBadge.textContent="Basic"),creditBadge.title="".concat(creditInfo.credit_type.toUpperCase()," Response\nTokens: ").concat(creditInfo.tokens_used,"\nCredits: ").concat(creditInfo.credits_charged,"\nProvider: ").concat(creditInfo.provider);messageEl.querySelector(".adeptus-message-text").appendChild(creditBadge)},isMultipleChoiceQuestion:function(text){const letterMatches=text.match(/^[A-Z][\.\)]\s+.+$/gim),numberMatches=text.match(/^[1-9][0-9]*[\.\)]\s+.+$/gm);if(letterMatches&&letterMatches.length>=2){const letters=letterMatches.map((m=>m.match(/^([A-Z])/i)[1].toUpperCase())),firstLetter=letters[0].charCodeAt(0);let isConsecutive=!0;for(let i=1;i<Math.min(letters.length,4);i++)if(letters[i].charCodeAt(0)!==firstLetter+i){isConsecutive=!1;break}return isConsecutive}if(numberMatches&&numberMatches.length>=2){const numbers=numberMatches.map((m=>parseInt(m.match(/^([0-9]+)/)[1])));let isConsecutive=!0;for(let i=1;i<Math.min(numbers.length,4);i++)if(numbers[i]!==numbers[0]+i){isConsecutive=!1;break}return isConsecutive}return!1},renderMultipleChoiceOptions:function(text){const self=this,lines=text.split("\n");let questionText=[],options=[];lines.forEach((line=>{const trimmedLine=line.trim(),letterMatch=trimmedLine.match(/^([A-Z])[\.\)]\s+(.+)$/i),numberMatch=trimmedLine.match(/^([1-9][0-9]*)[\.\)]\s+(.+)$/);letterMatch?options.push({letter:letterMatch[1].toUpperCase(),text:letterMatch[2].trim(),isLetter:!0}):numberMatch?options.push({letter:numberMatch[1],text:numberMatch[2].trim(),isLetter:!1}):trimmedLine&&questionText.push(trimmedLine)}));let html='<div class="adeptus-mcq-question-container">';return html+='<div class="adeptus-mcq-question-text" style="margin-bottom: 15px; white-space: pre-wrap;">',html+=this.escapeHtml(questionText.join("\n")),html+="</div>",options.length>0&&(html+='<div class="adeptus-mcq-options-grid" style="display: grid; gap: 10px; grid-template-columns: 1fr;">',options.forEach((option=>{const optionId="adeptus-mcq-option-"+Date.now()+"-"+option.letter;html+='\n                        <button class="adeptus-mcq-option-button"\n                                data-option="'.concat(option.letter,'"\n                                id="').concat(optionId,'"\n                                style="\n                                    padding: 12px 16px;\n                                    display: flex;\n                                    align-items: center;\n                                    gap: 12px;\n                                    font-size: 14px;\n                                    line-height: 1.5;\n                                    color: #333;\n                                    min-height: 50px;\n                                ">\n                            <span class="adeptus-mcq-option-letter" style="\n                                background: linear-gradient(135deg, #0ea5e9 0%, #2563eb 100%);\n                                color: white;\n                                width: 32px;\n                                height: 32px;\n                                border-radius: 50%;\n                                display: flex;\n                                align-items: center;\n                                justify-content: center;\n                                font-weight: bold;\n                                flex-shrink: 0;\n                            ">').concat(option.letter,'</span>\n                            <span class="adeptus-mcq-option-text" style="flex: 1;">').concat(this.escapeHtml(option.text),"</span>\n                        </button>\n                    ")})),html+="</div>"),html+="</div>",setTimeout((()=>{document.querySelector("#adeptus-chat-container").querySelectorAll(".adeptus-mcq-option-button:not([data-handler-attached])").forEach((button=>{button.setAttribute("data-handler-attached","true"),button.addEventListener("click",(function(){if(this.disabled)return;const selectedOption=this.getAttribute("data-option"),selectedText=options.find((o=>o.letter===selectedOption));this.closest(".adeptus-mcq-question-container").querySelectorAll(".adeptus-mcq-option-button").forEach((btn=>{btn.disabled=!0,btn.classList.add("disabled")})),this.classList.add("selected");let answer;this.querySelector(".adeptus-mcq-option-letter").innerHTML="âœ“",answer=(selectedText.isLetter,"".concat(selectedOption,". ").concat(selectedText.text)),self.sendMessage(answer)}))}))}),100),html},escapeHtml:function(text){const map={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"};return text.replace(/[&<>"']/g,(m=>map[m]))},handleCreditLimitError:function(message){let creditData=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;creditData&&creditData.summary&&this.updateSubscriptionDataFromCreditResponse(creditData),this.isCreditLimitExceeded=!0,this.updateSendMessageandCreateNewChatButton(),this.showPersistentCreditLimitMessage(message),this.addMessage(message,"error"),Swal.fire({icon:"warning",title:getString("token_limit_reached","Token Limit Reached"),html:'\n                    <div class="text-center">\n                        <p>'.concat(message,'</p>\n                        <p class="text-muted">').concat(getString("monthly_allowance_used","Your monthly token allowance has been used up."),'</p>\n                        <p class="text-muted">').concat(getString("tokens_reset_monthly","Tokens reset on the 1st of each month."),"</p>\n                    </div>\n                "),showCancelButton:!0,confirmButtonText:getString("view_usage","View Usage"),cancelButtonText:getString("close","Close"),confirmButtonColor:"#007bff"}).then((result=>{result.isConfirmed&&this.showCreditUsageModal()}))},checkReportEligibility:async function(){try{var promises=Ajax.call([{methodname:"report_adeptus_insights_check_report_eligibility",args:{}}]),result=await promises[0],data=result.data?result.data:result;return this.reportsUsed=data.reports_used||0,this.reportsLimit=data.reports_limit||0,this.reportsRemaining=data.reports_remaining||0,this.isReportLimitReached=!data.eligible,this.reportEligibilityChecked=!0,this.updateReportLimitUI(),data}catch(error){return this.isReportLimitReached=!0,this.reportEligibilityChecked=!0,this.updateReportLimitUI(),{success:!1,eligible:!1,message:"Unable to verify eligibility"}}},trackReportCreated:async function(reportName){try{var promises=Ajax.call([{methodname:"report_adeptus_insights_track_report_created",args:{report_name:reportName,is_ai_generated:!0}}]),result=await promises[0],data=result.data?result.data:result;return data.success&&!data.tracking_error&&(this.reportsUsed=data.reports_used||this.reportsUsed,this.reportsLimit=data.reports_limit||this.reportsLimit,this.reportsRemaining=data.reports_remaining||this.reportsRemaining,this.isReportLimitReached=this.reportsRemaining<=0&&-1!==this.reportsLimit,this.updateReportLimitUI()),data}catch(error){return{success:!0,tracking_error:!0}}},handleReportLimitError:function(message){this.isReportLimitReached=!0,this.updateReportLimitUI(),this.addMessage(message||getString("report_limit_message","You have reached your report limit. Delete existing reports or upgrade your plan."),"error"),Swal.fire({icon:"warning",title:getString("report_limit_reached","Report Limit Reached"),html:'\n                    <div class="text-center">\n                        <p>'.concat(message||getString("report_limit_reached","You have reached your report limit."),'</p>\n                        <p class="text-muted">').concat(getString("used_of_reports","You have used "+this.reportsUsed+" of "+this.reportsLimit+" reports.").replace("{$a->used}",this.reportsUsed).replace("{$a->limit}",this.reportsLimit),'</p>\n                        <p class="text-muted">').concat(getString("delete_reports_or_upgrade","Delete existing reports to free up slots or upgrade your plan."),"</p>\n                    </div>\n                "),showCancelButton:!0,confirmButtonText:getString("view_reports","View Reports"),cancelButtonText:getString("close","Close"),confirmButtonColor:"#007bff"}).then((result=>{result.isConfirmed&&this.switchTab("reports")}))},updateReportLimitUI:function(){const isUnlimited=-1===this.reportsLimit;if(this.isReportLimitReached&&!isUnlimited){if($("#send-button").prop("disabled",!0).addClass("disabled"),$("#message-input").prop("disabled",!0).attr("placeholder",getString("report_limit_placeholder","Report limit reached. Delete reports or upgrade to continue.")),!$("#report-limit-banner").length){const banner=$('\n                        <div id="report-limit-banner" class="alert alert-warning mb-2" style="margin: 10px; border-radius: 8px;">\n                            <i class="fa-solid fa-exclamation-triangle"></i>\n                            <strong>'.concat(getString("report_limit_reached_banner","Report limit reached!"),"</strong> ").concat(getString("used_of_reports","You have used "+this.reportsUsed+" of "+this.reportsLimit+" reports.").replace("{$a->used}",this.reportsUsed).replace("{$a->limit}",this.reportsLimit),'\n                            <a href="#" class="alert-link" onclick="window.assistant.switchTab(\'reports\'); return false;">').concat(getString("manage_reports","Manage reports"),'</a> or\n                            <a href="#" class="alert-link" onclick="window.assistant.showUpgradePrompt(); return false;">').concat(getString("upgrade_plan","upgrade your plan"),"</a>.\n                        </div>\n                    "));$(".adeptus-chat-input-area").before(banner)}}else this.isCreditLimitExceeded||($("#send-button").prop("disabled",!1).removeClass("disabled"),$("#message-input").prop("disabled",!1).attr("placeholder",getString("ask_moodle_data","Ask me anything about your Moodle data..."))),$("#report-limit-banner").remove()},showUpgradePrompt:function(){const limitText=-1===this.reportsLimit?getString("unlimited","Unlimited"):this.reportsLimit;Swal.fire({icon:"info",title:getString("upgrade_your_plan","Upgrade Your Plan"),html:'\n                    <div class="text-center">\n                        <p>'.concat(getString("unlock_features","Unlock more reports and features by upgrading your plan."),'</p>\n                        <p class="text-muted">').concat(getString("current_usage","Current usage:")," ").concat(this.reportsUsed," / ").concat(limitText," ").concat(getString("reports","reports"),"</p>\n                    </div>\n                "),confirmButtonText:getString("view_plans","View Plans"),confirmButtonColor:"#007bff"})},updateSubscriptionDataFromCreditResponse:function(creditData){const authStatus=AuthUtils.getAuthStatus();if(!authStatus||!authStatus.subscription)return;const subscription=authStatus.subscription;void 0!==creditData.tokens_used&&(subscription.tokens_used=creditData.tokens_used),void 0!==creditData.tokens_limit&&(subscription.tokens_limit=creditData.tokens_limit),void 0!==creditData.tokens_remaining&&(subscription.tokens_remaining=creditData.tokens_remaining),AuthUtils.setAuthStatus(authStatus),this.updateSubscriptionInfo()},handleTimeoutError:function(message){this.addMessage(message,"error"),Swal.fire({icon:"info",title:getString("ai_service_busy","AI Service Busy"),html:'\n                    <div class="text-center">\n                        <p>'.concat(message,'</p>\n                        <p class="text-muted">').concat(getString("ai_service_busy_message","The AI service is experiencing high demand. Please try again in a moment."),"</p>\n                    </div>\n                "),showCancelButton:!0,confirmButtonText:getString("try_again","Try Again"),cancelButtonText:getString("cancel","Cancel"),confirmButtonColor:"#007bff",cancelButtonColor:"#6c757d"}).then((result=>{result.isConfirmed&&$("#message-input").focus()}))},showPersistentCreditLimitMessage:function(message){$(".adeptus-credit-limit-alert").remove();const alertHtml='\n                <div class="alert alert-danger adeptus-credit-limit-alert" role="alert" style="margin: 10px 0; border-left: 4px solid #dc3545; background-color: #f8d7da; border-color: #f5c6cb;">\n                    <div class="d-flex align-items-center">\n\n                        <div class="flex-grow-1">\n                            <strong class="text-danger">'.concat(getString("token_limit_reached","Token Limit Reached"),'</strong><br>\n                            <small class="text-muted">').concat(message,'</small>\n                        </div>\n                        <div class="ms-3">\n                            <button type="button" class="btn btn-sm btn-outline-danger me-2" onclick="window.assistant.showCreditUsageModal()">\n                                <i class="fas fa-chart-bar me-1"></i> ').concat(getString("view_usage","View Usage"),"\n                            </button>\n\n                        </div>\n                    </div>\n                </div>\n            ");var $mainInners=$(".main-inner");$mainInners.length>=2?$mainInners.eq(1).before(alertHtml):1===$mainInners.length?$mainInners.eq(0).before(alertHtml):$("body").prepend(alertHtml)},hidePersistentCreditLimitMessage:function(){$(".adeptus-credit-limit-alert").fadeOut(300,(function(){$(this).remove()}))},showCreditUsageModal:function(){Swal.fire({title:getString("loading_usage_data","Loading Usage Data..."),text:getString("fetching_usage_info","Please wait while we fetch your usage information"),allowOutsideClick:!1,showConfirmButton:!1,willOpen:()=>{Swal.showLoading()}}),this.ajaxWithAuth({url:this.backendUrl+"/chat/credits/detailed-usage",method:"GET",success:response=>{response.success?this.displayDetailedUsageModal(response.data):Swal.fire(getString("error","Error"),getString("failed_load_usage","Failed to load usage information"),"error")},error:()=>{Swal.fire(getString("error","Error"),getString("failed_load_usage","Failed to load usage information"),"error")}})},displayDetailedUsageModal:function(data){const summary=data.summary,usage=data.usage||[],pagination=data.pagination||{total:0},formatTokens=tokens=>tokens>=1e6?(tokens/1e6).toFixed(1)+"M":tokens>=1e3?(tokens/1e3).toFixed(1)+"K":tokens.toString(),usagePercent=summary.tokens_limit>0&&-1!==summary.tokens_remaining?Math.min(100,Math.round(summary.total_tokens_used/summary.tokens_limit*100)):0,limitDisplay=-1===summary.tokens_remaining?"Unlimited":formatTokens(summary.tokens_limit),modalHtml='\n                <div class="adeptus-detailed-usage-modal" style="font-family: \'Segoe UI\', Tahoma, Geneva, Verdana, sans-serif;">\n                    \x3c!-- Header with close button --\x3e\n                    <div class="adeptus-usage-modal-header mb-3" style="background: linear-gradient(135deg, #0f6cbf 0%, #3a8dd4 100%); padding: 16px 20px; border-radius: 10px; color: white; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">\n                        <div class="d-flex justify-content-between align-items-center">\n                            <h5 class="mb-0" style="color: white; font-weight: 600;">\n                                <i class="fas fa-chart-line me-2"></i> Token Usage Dashboard\n                            </h5>\n                            <button type="button" class="adeptus-usage-modal-close-btn" onclick="Swal.close()" style="background: rgba(255,255,255,0.2); border: none; color: white; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s ease;">\n                                <i class="fas fa-times" style="font-size: 14px;"></i>\n                            </button>\n                        </div>\n                    </div>\n\n                    \x3c!-- Summary Cards with proper spacing --\x3e\n                    <div class="row mb-3 g-2">\n                        <div class="col-md-3">\n                            <div class="card border-0 h-100" style="background: linear-gradient(135deg, #0ea5e9 0%, #2563eb 100%); color: white; border-radius: 12px; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);">\n                                <div class="card-body text-center" style="padding: 16px 12px;">\n                                    <h6 class="card-title mb-2" style="font-weight: 600; opacity: 0.9; font-size: 0.85rem;">Monthly Usage</h6>\n                                    <div class="d-flex align-items-center justify-content-center mb-2">\n                                        <i class="fas fa-chart-pie me-2" style="opacity: 0.8; font-size: 1.2rem;"></i>\n                                        <span style="font-weight: 700; font-size: 1.5rem;">'.concat(usagePercent,'%</span>\n                                    </div>\n                                    <small style="opacity: 0.8; font-size: 0.75rem;">').concat(formatTokens(summary.total_tokens_used)," / ").concat(limitDisplay,'</small>\n                                </div>\n                            </div>\n                        </div>\n                        <div class="col-md-3">\n                            <div class="card border-0 h-100" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; border-radius: 12px; box-shadow: 0 4px 12px rgba(17, 153, 142, 0.2);">\n                                <div class="card-body text-center" style="padding: 16px 12px;">\n                                    <h6 class="card-title mb-2" style="font-weight: 600; opacity: 0.9; font-size: 0.85rem;">Tokens Used</h6>\n                                    <div class="d-flex align-items-center justify-content-center mb-2">\n                                        <i class="fas fa-code me-2" style="opacity: 0.8; font-size: 1.2rem;"></i>\n                                        <span style="font-weight: 700; font-size: 1.5rem;">').concat(formatTokens(summary.total_tokens_used),'</span>\n                                    </div>\n                                    <small style="opacity: 0.8; font-size: 0.75rem;">This Billing Period</small>\n                                </div>\n                            </div>\n                        </div>\n                        <div class="col-md-3">\n                            <div class="card border-0 h-100" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; border-radius: 12px; box-shadow: 0 4px 12px rgba(240, 147, 251, 0.2);">\n                                <div class="card-body text-center" style="padding: 16px 12px;">\n                                    <h6 class="card-title mb-2" style="font-weight: 600; opacity: 0.9; font-size: 0.85rem;">Total Requests</h6>\n                                    <div class="d-flex align-items-center justify-content-center mb-2">\n                                        <i class="fas fa-paper-plane me-2" style="opacity: 0.8; font-size: 1.2rem;"></i>\n                                        <span style="font-weight: 700; font-size: 1.5rem;">').concat(summary.total_requests,'</span>\n                                    </div>\n                                    <small style="opacity: 0.8; font-size: 0.75rem;">Messages Processed</small>\n                                </div>\n                            </div>\n                        </div>\n                        <div class="col-md-3">\n                            <div class="card border-0 h-100" style="background: linear-gradient(135deg, #ff6b6b 0%, #ffa500 100%); color: white; border-radius: 12px; box-shadow: 0 4px 12px rgba(255, 107, 107, 0.2);">\n                                <div class="card-body text-center" style="padding: 16px 12px;">\n                                    <h6 class="card-title mb-2" style="font-weight: 600; opacity: 0.9; font-size: 0.85rem;">Today\'s Tokens</h6>\n                                    <div class="d-flex align-items-center justify-content-center mb-2">\n                                        <i class="fas fa-calendar-day me-2" style="opacity: 0.8; font-size: 1.2rem;"></i>\n                                        <span style="font-weight: 700; font-size: 1.5rem;">').concat(formatTokens(summary.today_tokens_used||0),'</span>\n                                    </div>\n                                    <small style="opacity: 0.8; font-size: 0.75rem;">Tokens Used Today</small>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n\n                    \x3c!-- Compact Data Table --\x3e\n                    <div class="card border-0" style="border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.06);">\n                        <div class="card-header" style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-radius: 12px 12px 0 0; border: none; padding: 12px 16px;">\n                            <div class="d-flex justify-content-between align-items-center">\n                                <h6 class="mb-0" style="font-weight: 600; color: #333;">\n                                    Detailed Usage History\n                                </h6>\n                                <span class="badge bg-primary" style="font-size: 0.7rem; padding: 4px 8px; border-radius: 12px; color: white; background: linear-gradient(135deg, #0ea5e9 0%, #2563eb 100%);">\n                                    ').concat(usage.length," of ").concat(pagination.total,' records\n                                </span>\n                            </div>\n                        </div>\n                        <div class="card-body p-0">\n                            <div class="table-responsive">\n                                <table id="usage-datatable" class="table table-hover mb-0" style="font-size: 0.9rem;">\n                                    <thead style="background: linear-gradient(135deg, #0ea5e9 0%, #2563eb 100%); color: white;">\n                                        <tr>\n                                            <th style="border: none; padding: 15px 12px; font-weight: 600; text-align: center;">Date</th>\n                                            <th style="border: none; padding: 15px 12px; font-weight: 600; text-align: center;">Action</th>\n                                            <th style="border: none; padding: 15px 12px; font-weight: 600; text-align: center;">Model</th>\n                                            <th style="border: none; padding: 15px 12px; font-weight: 600; text-align: center;">Input</th>\n                                            <th style="border: none; padding: 15px 12px; font-weight: 600; text-align: center;">Output</th>\n                                            <th style="border: none; padding: 15px 12px; font-weight: 600; text-align: center;">Total Tokens</th>\n                                        </tr>\n                                    </thead>\n                                    <tbody>\n                                        ').concat(usage.length>0?usage.map((item=>'\n                                            <tr style="border-bottom: 1px solid #f8f9fa;">\n                                                <td style="padding: 12px; vertical-align: middle; font-weight: 500;">\n                                                    '.concat((()=>{const d=new Date(item.created_at),day=d.getDate(),month=d.toLocaleString("en-US",{month:"short"}),year=d.getFullYear(),hours=d.getHours().toString().padStart(2,"0"),minutes=d.getMinutes().toString().padStart(2,"0");return"".concat(day," ").concat(month," ").concat(year," - ").concat(hours,":").concat(minutes)})(),'\n                                                </td>\n                                                <td style="padding: 12px; vertical-align: middle;">\n                                                    <span class="badge ').concat("report_generation"===item.action_type?"bg-primary":"mcq_generation"===item.action_type?"bg-warning":"bg-success",'" style="border-radius: 20px; padding: 6px 12px; font-weight: 500;">\n                                                        <i class="fas ').concat("report_generation"===item.action_type?"fa-file-alt":"mcq_generation"===item.action_type?"fa-question-circle":"fa-comment",' me-1"></i>\n                                                        ').concat(item.action_type.replace("_"," "),'\n                                                    </span>\n                                                </td>\n                                                <td style="padding: 12px; vertical-align: middle;">\n                                                    <span class="badge bg-light text-dark" style="border-radius: 20px; padding: 4px 8px;">\n                                                        ').concat(item.model||"N/A",'\n                                                    </span>\n                                                </td>\n                                                <td style="padding: 12px; vertical-align: middle; font-weight: 500; color: #11998e;">').concat((item.prompt_tokens||0).toLocaleString(),'</td>\n                                                <td style="padding: 12px; vertical-align: middle; font-weight: 500; color: #f5576c;">').concat((item.completion_tokens||0).toLocaleString(),'</td>\n                                                <td style="padding: 12px; vertical-align: middle; font-weight: 600; color: #667eea;">').concat((item.tokens_used||0).toLocaleString(),"</td>\n                                            </tr>\n                                        "))).join(""):'\n                                            <tr>\n                                                <td colspan="6" style="padding: 40px; text-align: center;">\n                                                    <div style="color: #6c757d;">\n                                                        <i class="fas fa-inbox fa-3x mb-3" style="opacity: 0.5;"></i>\n                                                        <h5 style="font-weight: 600; margin-bottom: 10px;">No Usage Data Yet</h5>\n                                                        <p style="margin: 0; font-size: 0.9rem;">Start using the AI Assistant to generate reports and your usage history will appear here.</p>\n                                                    </div>\n                                                </td>\n                                            </tr>\n                                        ',"\n                                    </tbody>\n                                </table>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n            ");Swal.fire({html:modalHtml,width:"80%",showConfirmButton:!1,showCancelButton:!1,showCloseButton:!1,allowOutsideClick:!0,customClass:{popup:"usage-modal-popup",htmlContainer:"usage-modal-container"},didOpen:()=>{const closeBtn=document.querySelector(".usage-modal-close-btn");closeBtn&&(closeBtn.addEventListener("mouseenter",(()=>{closeBtn.style.background="rgba(255,255,255,0.3)"})),closeBtn.addEventListener("mouseleave",(()=>{closeBtn.style.background="rgba(255,255,255,0.2)"}))),this.setupUsageModalEventListeners(data)}})},setupUsageModalEventListeners:function(data){const self=this;let currentFilters=data.filters;self.usageDataTable=null,setTimeout((()=>{if("undefined"!=typeof simpleDatatables&&simpleDatatables.DataTable&&$("#usage-datatable").length)try{const tableElement=document.getElementById("usage-datatable");if(tableElement){const tbody=tableElement.querySelector("tbody");tbody&&tbody.rows.length>0&&(self.usageDataTable=new simpleDatatables.DataTable("#usage-datatable",{searchable:!0,fixedHeight:!1,perPage:25,perPageSelect:[10,25,50,100],sortable:!0,labels:{placeholder:"Search usage history...",noRows:"No usage data found",info:"Showing {start} to {end} of {rows} entries"}}))}}catch(error){}}),500),$("#apply-filters").on("click",(function(){const userId=$("#user-filter").val(),creditType=$("#credit-type-filter").val(),startDate=$("#start-date-filter").val(),endDate=$("#end-date-filter").val();currentFilters={user_id:userId,credit_type:creditType,start_date:startDate,end_date:endDate},self.loadUsageDataWithFilters(currentFilters,1)})),$("#clear-filters").on("click",(function(){$("#user-filter").val(""),$("#credit-type-filter").val(""),$("#start-date-filter").val(""),$("#end-date-filter").val(""),currentFilters={},self.loadUsageDataWithFilters({},1)})),$(".adeptus-quick-filter").on("click",(function(){const period=$(this).data("period"),today=new Date;let startDate="",endDate=today.toISOString().split("T")[0];switch(period){case"today":startDate=endDate;break;case"week":const weekAgo=new Date(today);weekAgo.setDate(today.getDate()-7),startDate=weekAgo.toISOString().split("T")[0];break;case"month":const monthAgo=new Date(today);monthAgo.setMonth(today.getMonth()-1),startDate=monthAgo.toISOString().split("T")[0]}$("#start-date-filter").val(startDate),$("#end-date-filter").val(endDate),currentFilters={user_id:$("#user-filter").val(),credit_type:$("#credit-type-filter").val(),start_date:startDate,end_date:endDate},self.loadUsageDataWithFilters(currentFilters,1)}))},loadUsageDataWithFilters:function(filters){let page=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;Swal.fire({title:getString("loading","Loading..."),text:getString("applying_filters","Applying filters and loading data"),allowOutsideClick:!1,showConfirmButton:!1,willOpen:()=>{Swal.showLoading()}});const params=new URLSearchParams;filters.user_id&&params.append("user_id",filters.user_id),filters.credit_type&&params.append("credit_type",filters.credit_type),filters.start_date&&params.append("start_date",filters.start_date),filters.end_date&&params.append("end_date",filters.end_date),params.append("page",page),params.append("per_page",1e3),this.ajaxWithAuth({url:"".concat(this.backendUrl,"/chat/credits/detailed-usage?").concat(params.toString()),method:"GET",success:response=>{response.success?this.updateUsageModalData(response.data):Swal.fire(getString("error","Error"),getString("failed_load_filtered","Failed to load filtered data"),"error")},error:()=>{Swal.fire(getString("error","Error"),getString("failed_load_filtered","Failed to load filtered data"),"error")}})},updateUsageModalData:function(data){const summary=data.summary,usage=data.usage;$(".detailed-usage-modal .card h2").eq(0).text(summary.total_credits_used),$(".detailed-usage-modal .card h2").eq(1).text(summary.total_tokens_used.toLocaleString()),$(".detailed-usage-modal .card h2").eq(2).text(summary.total_requests),$(".detailed-usage-modal .card h2").eq(3).text(summary.unique_users),$(".detailed-usage-modal .card h3").eq(0).text(summary.premium_credits),$(".detailed-usage-modal .card h3").eq(1).text(summary.basic_credits),$(".detailed-usage-modal .badge.bg-primary").text("".concat(usage.length," of ").concat(data.pagination.total," records"));const tableBody=$("#usage-datatable tbody");if(tableBody.empty(),usage.forEach((item=>{const row='\n                    <tr style="border-bottom: 1px solid #f8f9fa;">\n                        <td style="padding: 12px; vertical-align: middle; font-weight: 500;">'.concat(new Date(item.created_at).toLocaleDateString(),'</td>\n                        <td style="padding: 12px; vertical-align: middle;">\n                            <span class="badge bg-light text-dark" style="border-radius: 20px; padding: 4px 8px;">\n                                ').concat(item.user_id||"N/A",'\n                            </span>\n                        </td>\n                        <td style="padding: 12px; vertical-align: middle;">\n                            <span class="badge ').concat("premium"===item.credit_type?"bg-primary":"bg-success",'" style="border-radius: 20px; padding: 6px 12px; font-weight: 500;">\n                                <i class="fas ').concat("premium"===item.credit_type?"fa-crown":"fa-layer-group",' me-1"></i>\n                                ').concat(item.credit_type,'\n                            </span>\n                        </td>\n                        <td style="padding: 12px; vertical-align: middle; font-weight: 600; color: #667eea;">').concat(item.credits_charged,'</td>\n                        <td style="padding: 12px; vertical-align: middle; font-weight: 500;">').concat(item.tokens_used.toLocaleString(),'</td>\n                        <td style="padding: 12px; vertical-align: middle;">\n                            <span class="badge bg-info text-white" style="border-radius: 20px; padding: 4px 8px;">\n                                ').concat(item.llm_provider,'\n                            </span>\n                        </td>\n                        <td style="padding: 12px; vertical-align: middle; max-width: 200px;">\n                            <div style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="').concat(item.message_preview||"No message",'">\n                                ').concat(item.message_preview?item.message_preview.substring(0,50)+"...":"N/A","\n                            </div>\n                        </td>\n                    </tr>\n                ");tableBody.append(row)})),this.usageDataTable&&"function"==typeof this.usageDataTable.refresh)try{this.usageDataTable.refresh()}catch(error){}},updateReportData:function(data){const table=$("#report-table");table.empty();const thead=$("<thead><tr></tr></thead>");data.columns.forEach((column=>{thead.find("tr").append("<th>".concat(column,"</th>"))})),table.append(thead);const tbody=$("<tbody></tbody>");data.rows.forEach((row=>{const tr=$("<tr></tr>");row.forEach((cell=>{tr.append("<td>".concat(cell,"</td>"))})),tbody.append(tr)})),table.append(tbody)},updateVisualizations:function(visualizations){const container=$("#adeptus-chart-container");container.empty();const canvas=$("<canvas></canvas>");container.append(canvas);const type=$("#chart-type").val();new Chart(canvas[0],{type:type,data:{labels:visualizations.labels,datasets:visualizations.datasets.map((dataset=>({label:dataset.label,data:dataset.data,backgroundColor:dataset.backgroundColor,borderColor:dataset.borderColor,borderWidth:1})))},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{position:"top"},title:{display:!0,text:visualizations.title}}}})},detectNumericColumns:function(data,headers){return data&&0!==data.length?headers.filter((header=>{let numericCount=0;const sampleSize=Math.min(data.length,20);for(let i=0;i<sampleSize;i++){const val=data[i][header];if(null!=val&&""!==val){const num=parseFloat(val);!isNaN(num)&&isFinite(num)&&numericCount++}}return numericCount>=.5*sampleSize})):[]},generateChartColors:function(count){const baseColors=["#2563eb","#10b981","#f59e0b","#ef4444","#8b5cf6","#06b6d4","#ec4899","#84cc16","#f97316","#6366f1","#14b8a6","#a855f7","#eab308","#22c55e","#3b82f6"],colors=[];for(let i=0;i<count;i++)colors.push(baseColors[i%baseColors.length]);return colors},createReportChartConfig:function(chartType,labels,values,valueKey,colors,reportName){const baseConfig={responsive:!0,maintainAspectRatio:!1,plugins:{title:{display:!0,text:reportName||"Report Chart",font:{size:16,weight:"bold"},padding:{top:10,bottom:20}},legend:{display:"pie"===chartType||"doughnut"===chartType,position:"right"}}};return"pie"===chartType||"doughnut"===chartType?{type:chartType,data:{labels:labels,datasets:[{data:values,backgroundColor:colors,borderColor:"#fff",borderWidth:2}]},options:baseConfig}:"line"===chartType?{type:"line",data:{labels:labels,datasets:[{label:valueKey,data:values,borderColor:colors[0],backgroundColor:colors[0]+"40",borderWidth:3,fill:!0,tension:.4}]},options:{...baseConfig,scales:{y:{beginAtZero:!0},x:{ticks:{maxRotation:45,minRotation:45}}}}}:{type:"bar",data:{labels:labels,datasets:[{label:valueKey,data:values,backgroundColor:colors,borderColor:colors,borderWidth:1}]},options:{...baseConfig,scales:{y:{beginAtZero:!0},x:{ticks:{maxRotation:45,minRotation:45}}}}}},renderReportChartFromSelectors:function(data,reportName){const self=this;if(!data||0===data.length)return;const chartType=$("#report-chart-type").val()||"bar",labelKey=$("#report-chart-x-axis").val(),valueKey=$("#report-chart-y-axis").val();if(!labelKey||!valueKey)return;const valueKeyFormatted=valueKey.replace(/_/g," ").replace(/\b\w/g,(l=>l.toUpperCase())),chartData=data.slice(0,50),labels=chartData.map((r=>{const label=r[labelKey];if(null==label)return"Unknown";const labelStr=String(label);return labelStr.length>30?labelStr.substring(0,30)+"...":labelStr})),values=chartData.map((r=>parseFloat(r[valueKey])||0)),colors=this.generateChartColors(values.length),chartConfig=this.createReportChartConfig(chartType,labels,values,valueKeyFormatted,colors,reportName),chartEl=document.getElementById("reportChart");if(chartEl){self.reportChartInstance&&self.reportChartInstance.destroy();try{self.reportChartInstance=new Chart(chartEl.getContext("2d"),chartConfig)}catch(error){}}},showLoading:function(){$(".adeptus-ai-thinking-loader-wrapper").remove(),this.loaderShownAt=Date.now();const $chatContainer=$("#adeptus-chat-container");$chatContainer.length>0&&($chatContainer.append('\n                <div class="adeptus-message-wrapper adeptus-ai-message-wrapper adeptus-ai-thinking-loader-wrapper" style="margin: 10px 0;">\n                    <div class="adeptus-message adeptus-ai-message adeptus-ai-thinking-loader" style="\n                        max-width: 70%;\n                        margin-left: 20px;\n                        padding: 15px 20px;\n                        background: linear-gradient(135deg, #f0f4f8 0%, #e9ecef 100%);\n                        border-radius: 18px 18px 18px 4px;\n                        box-shadow: 0 2px 8px rgba(0,0,0,0.08);\n                        display: flex;\n                        align-items: center;\n                        gap: 12px;\n                    ">\n                        <div class="adeptus-ai-avatar-loader" style="\n                            padding: 8px 12px;\n                            background: linear-gradient(135deg, #0ea5e9 0%, #2563eb 100%);\n                            border-radius: 20px;\n                            display: flex;\n                            align-items: center;\n                            justify-content: center;\n                            color: white;\n                            font-weight: 600;\n                            font-size: 13px;\n                            flex-shrink: 0;\n                            animation: pulse-glow-loader 2s infinite;\n                            font-family: system-ui, -apple-system, sans-serif;\n                            letter-spacing: 0.5px;\n                        ">Adeptus AI</div>\n                        <div class="adeptus-thinking-dots" style="\n                            display: flex;\n                            align-items: center;\n                            gap: 4px;\n                        ">\n                            <span class="adeptus-thinking-text" style="\n                                color: #6c757d;\n                                font-size: 14px;\n                                margin-right: 8px;\n                                font-style: italic;\n                            ">Thinking</span>\n                            <span class="adeptus-dot adeptus-dot-1" style="\n                                width: 8px;\n                                height: 8px;\n                                border-radius: 50%;\n                                background: #0ea5e9;\n                                display: inline-block;\n                                animation: bounce-loader 1.4s infinite ease-in-out both;\n                                animation-delay: -0.32s;\n                            "></span>\n                            <span class="adeptus-dot adeptus-dot-2" style="\n                                width: 8px;\n                                height: 8px;\n                                border-radius: 50%;\n                                background: #2563eb;\n                                display: inline-block;\n                                animation: bounce-loader 1.4s infinite ease-in-out both;\n                                animation-delay: -0.16s;\n                            "></span>\n                            <span class="adeptus-dot adeptus-dot-3" style="\n                                width: 8px;\n                                height: 8px;\n                                border-radius: 50%;\n                                background: #0ea5e9;\n                                display: inline-block;\n                                animation: bounce-loader 1.4s infinite ease-in-out both;\n                            "></span>\n                        </div>\n                    </div>\n                </div>\n            '),this.scrollToBottom())},hideLoading:function(){const loaderShownDuration=this.loaderShownAt?Date.now()-this.loaderShownAt:0,remainingTime=Math.max(0,800-loaderShownDuration);setTimeout((()=>{$(".adeptus-ai-thinking-loader-wrapper").fadeOut(200,(function(){$(this).remove()})),$(".adeptus-ai-thinking-loader").fadeOut(200,(function(){$(this).remove()})),$("#adeptus-loading-indicator").addClass("d-none")}),remainingTime)},showError:function(message){const errorDiv=$("#adeptus-error-message");$("#error-text").text(message),errorDiv.removeClass("d-none"),setTimeout((()=>{errorDiv.addClass("d-none")}),5e3)},showSuccess:function(message){if(0===$("#success-message").length){const successHtml='\n                    <div class="alert alert-success alert-dismissible fade show d-none" role="alert" id="success-message" style="position:fixed; top:20px; right:20px; z-index:1050;">\n                        <i class="fa fa-check-circle me-2"></i>\n                        <span id="success-text"></span>\n                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>\n                    </div>\n                ';$("body").append(successHtml)}const successDiv=$("#success-message");$("#success-text").text(message),successDiv.removeClass("d-none"),setTimeout((()=>{successDiv.addClass("d-none")}),3e3)},scrollToBottom:function(){const container=$("#adeptus-chat-container");container.scrollTop(container[0].scrollHeight)},loadChatHistory:function(){const list=$("#chat-history-list");list.html('\n                <li class="list-group-item d-flex justify-content-center" id="chat-history-loading">\n                    <div class="spinner-border text-secondary" role="status">\n                        <span class="sr-only">Loading...</span>\n                    </div>\n                </li>\n            '),this.ajaxWithAuth({url:this.backendUrl+"/chat/history",method:"GET",success:response=>{if(list.empty(),response&&response.chats&&Array.isArray(response.chats))if(response.chats.length)response.chats.forEach((chat=>{const date=chat.created_at?new Date(chat.created_at).toLocaleString():"Unknown date",snippet=chat.last_message||chat.title||chat.snippet||chat.first_message||"Chat session",reportCount=chat.report_count||0,badgeHtml=reportCount>0?'<span class="badge bg-primary d-flex align-items-center adeptus-report-count"><i class="fa fa-chart-bar me-1"></i>'.concat(reportCount,"</span>"):"";if(chat.id){const item=$('\n                                    <li class="list-group-item d-flex justify-content-between align-items-start adeptus-chat-history-item" data-chat-id="'.concat(chat.id,'">\n                                        <div>\n                                            <small class="text-muted">').concat(date,"</small><br>\n                                            ").concat(snippet,"\n                                        </div>\n                                        ").concat(badgeHtml,"\n                                    </li>\n                                "));list.append(item)}})),$(".adeptus-chat-history-item").on("click",(e=>{const li=$(e.currentTarget),chatId=li.data("chat-id");this.loadChatMessages(chatId,li)})),0===this.currentChatId&&0===$("#adeptus-chat-container").children().length&&this.showWelcomeMessage();else{const authStatus=AuthUtils.getAuthStatus();authStatus&&authStatus.subscription&&authStatus.subscription.reports_generated_this_month>0?list.append('<li class="list-group-item text-center">'.concat(getString("no_chats_yet","No chats yet"),"</li>")):(list.append('\n                                <li class="list-group-item text-center">\n                                    <div class="text-muted">\n                                        <i class="fa fa-comments fa-2x mb-2"></i>\n                                        <p class="mb-1">No chat history yet</p>\n                                        <small>Start a conversation to see your chat history here</small>\n                                    </div>\n                                </li>\n                            '),0===$("#adeptus-chat-container").children().length&&this.showWelcomeMessage())}else list.append('\n                            <li class="list-group-item text-center">\n                                <div class="text-muted">\n                                    <i class="fa fa-comments fa-2x mb-2"></i>\n                                    <p class="mb-1">No chat history available</p>\n                                    <small>Start a conversation to see your chat history here</small>\n                                </div>\n                            </li>\n                        ')},error:()=>{list.html('\n                        <li class="list-group-item text-center">\n                            <div class="text-danger">\n                                <i class="fa fa-exclamation-triangle fa-2x mb-2"></i>\n                                <p class="mb-2">Failed to load chat history</p>\n                                <button id="reload-chat-history" class="btn btn-outline-primary btn-sm">\n                                    <i class="fa fa-refresh"></i> Try Again\n                                </button>\n                            </div>\n                        </li>\n                    '),$("#reload-chat-history").on("click",(()=>this.loadChatHistory()))}})},loadChatMessages:function(chatId,listItem){this.currentChatId=chatId,$("#chat-history-list li").removeClass("active"),listItem.addClass("active"),$("#adeptus-chat-container").empty(),this.clearMCQ(),this.showLoading();const messageUrl="".concat(this.backendUrl,"/chat/").concat(chatId,"/messages");this.ajaxWithAuth({url:messageUrl,method:"GET",success:response=>{this.hideLoading(),response.credit_data&&response.credit_data.summary&&this.updateSubscriptionDataFromCreditResponse(response.credit_data);const authStatus=AuthUtils.getAuthStatus();if(authStatus&&authStatus.subscription&&this.checkAndShowCreditLimitWarning(authStatus.subscription),response.messages.forEach(((msg,idx)=>{if(msg.sender_type=msg.role||msg.sender_type,msg.body=msg.content||msg.body,msg.timestamp=msg.created_at||msg.timestamp,"assistant"===msg.sender_type&&(msg.sender_type="ai"),"sql"===msg.tag)return;if("ai"===msg.sender_type&&"mcq"===msg.tag){const nextMsg=response.messages[idx+1],selectedAnswer=nextMsg&&"user"===nextMsg.sender_type?nextMsg.body:null,mcqData=this.extractMCQFromText(msg.body);if(mcqData&&mcqData.questions.length>0){mcqData.selectedAnswer=selectedAnswer;const mcqHtml=this.renderMCQHistory(mcqData.questions,selectedAnswer),frag=document.getElementById("message-template").content.cloneNode(!0),messageEl=frag.querySelector(".adeptus-message");return messageEl.classList.add("adeptus-ai-message"),messageEl.setAttribute("data-message-id",msg.id),frag.querySelector(".adeptus-message-text").innerHTML=mcqHtml,frag.querySelector(".adeptus-message-time").textContent=this.formatTimestamp(msg.timestamp),void $("#adeptus-chat-container").append(frag)}}if("user"===msg.sender_type&&idx>0){const prevMsg=response.messages[idx-1];if(prevMsg&&"ai"===prevMsg.sender_type&&"mcq"===prevMsg.tag)return}if(msg.metadata&&"report"===msg.metadata.type||msg.body&&msg.body.startsWith("ðŸ“Š Report saved:")){if(!msg.metadata&&msg.body){const reportNameMatch=msg.body.match(/ðŸ“Š Report saved: (.+)/),reportName=reportNameMatch?reportNameMatch[1]:"Report",reportSlug=reportName.toLowerCase().replace(/\s+/g,"-").replace(/[^a-z0-9-]/g,"");msg.metadata={type:"report",report_name:reportName,report_slug:reportSlug}}this.displayReportLink(msg)}else this.addMessage(msg.body,msg.sender_type,!1,null,msg.id,msg.timestamp)})),this.scrollToBottom(),response.reports&&response.reports.length&&response.reports.forEach((report=>{this.insertReportLinkInChat(report)})),response.messages.length>0){const lastMsg=response.messages[response.messages.length-1];if("mcq"===lastMsg.tag){const jsonMatches=lastMsg.body.match(/\{[\s\S]*?\}/g)||[],questions=[];jsonMatches.forEach((jsonStr=>{try{const obj=JSON.parse(jsonStr);"mcq"===obj.type&&Array.isArray(obj.options)&&questions.push(obj)}catch(e){}})),questions.length&&this.enqueueMCQs(questions)}}},error:()=>{this.hideLoading(),this.showError("Could not load conversation.")}})},insertReportLinkInChat:function(report){const $msg=$('#adeptus-chat-container .adeptus-message[data-message-id="'.concat(report.message_after_id,'"]'));if(!$msg.length)return;const linkHtml='\n                <div class="adeptus-message adeptus-ai-message">\n                  <div class="adeptus-message-content">\n                    <div class="adeptus-message-text">\n                      <a href="javascript:void(0)" class="adeptus-report-link" data-report-slug="'.concat(report.slug,'"\n                         style="color: #007bff; text-decoration: none; padding:4px 8px; border:1px solid #dee2e6; border-radius:4px; background:#f8f9fa; display:inline-block; transition:all 0.2s;">\n                        ðŸ“Š ').concat(report.description,'\n                      </a>\n                    </div>\n                    <div class="adeptus-message-time small text-muted">').concat(new Date(report.created_at).toLocaleTimeString(),"</div>\n                  </div>\n                </div>\n            "),$linkMsg=$(linkHtml),self=this;$linkMsg.find(".adeptus-report-link").on("click",(function(){const slug=$(this).data("report-slug");self.openReportFromLink(slug)})).on("mouseenter",(function(){$(this).css({"background-color":"#e9ecef","border-color":"#adb5bd",transform:"translateY(-1px)"})})).on("mouseleave",(function(){$(this).css({"background-color":"#f8f9fa","border-color":"#dee2e6",transform:"translateY(0)"})})),$msg.after($linkMsg)},sendMessage:function(providedMessage){if(this.currentMCQ)return;if(this.isReportLimitReached&&-1!==this.reportsLimit)return void this.handleReportLimitError("You have reached your report limit. Delete existing reports or upgrade your plan to continue using the AI assistant.");if(this.isSending)return;const input=$("#message-input"),rawValue=providedMessage?String(providedMessage).trim():(input.val()||"").trim();if(!rawValue)return void Swal.fire({icon:"error",title:getString("oops","Oops..."),text:getString("please_enter_message","Please enter a message")});const message=rawValue.trim();if(!message)return;this.isSending=!0,$(".adeptus-welcome-message").remove();const $userMsg=this.addMessage(message,"user");providedMessage||input.val("").trigger("input"),this.showLoading();const authStatus=AuthUtils.getAuthStatus(),userInfo=(null==authStatus?void 0:authStatus.user)||{},requestData={message:providedMessage?"I selected: ".concat(message):message,chat_id:this.currentChatId||0,user_id:userInfo.id||null,user_name:userInfo.name||null};this.ajaxWithAuth({url:this.backendUrl+"/chat/message",method:"POST",contentType:"application/json",data:JSON.stringify(requestData),success:response=>{this.hideLoading(),this.isSending=!1,response.error?"credit_limit"===response.error_type||"token_limit"===response.error_type?this.handleCreditLimitError(response.message,response.credit_data):"report_limit"===response.error_type?this.handleReportLimitError(response.message):"timeout"===response.error_type?this.handleTimeoutError(response.message):(this.addMessage(response.message,"error"),this.showResendIconOnMessage($userMsg,message)):($(".adeptus-failed-reload-icon").remove(),!this.currentChatId&&response.chat_id&&(this.currentChatId=response.chat_id,this.addChatToChatHistory(response.chat_id,message)),this.handleResponse(response),this.refreshSubscriptionInfo())},error:err=>{if(this.hideLoading(),this.isSending=!1,401===err.status)AuthUtils.clearAuthData(),this.showAuthenticationError();else{if(429!==err.status)return this.showResendIconOnMessage($userMsg,message),void this.addMessage("Network error occurred. Please try again.","error");var _err$responseJSON;if("report_limit"===((null===(_err$responseJSON=err.responseJSON)||void 0===_err$responseJSON?void 0:_err$responseJSON.error_type)||"credit_limit")){var _err$responseJSON2;const errorMessage=(null===(_err$responseJSON2=err.responseJSON)||void 0===_err$responseJSON2?void 0:_err$responseJSON2.message)||"You have reached your report limit. Please upgrade your plan to generate more reports.";this.handleReportLimitError(errorMessage)}else{let errorMessage="You have reached your credit limit. Please upgrade your plan or wait until your credits refresh.",creditData=null;err.responseJSON&&(errorMessage=err.responseJSON.message||errorMessage,creditData=err.responseJSON.credit_data||null),this.handleCreditLimitError(errorMessage,creditData)}$userMsg.remove()}}})},updateSendMessageandCreateNewChatButton:function(){this.isCreditLimitExceeded?($("#send-button").prop("disabled",!0).attr("title","Credit limit reached. Your credits will reset on the 1st of next month.").addClass("adeptus-credit-limit-disabled"),$("#create-new-chat").prop("disabled",!0).attr("title","Credit limit reached. Your credits will reset on the 1st of next month.").addClass("adeptus-credit-limit-disabled"),$("#message-input").prop("disabled",!0).attr("placeholder","Credit limit reached. Your credits will reset on the 1st of next month.")):($("#send-button").prop("disabled",!1).removeAttr("title").removeClass("adeptus-credit-limit-disabled"),$("#create-new-chat").prop("disabled",!1).removeAttr("title").removeClass("adeptus-credit-limit-disabled"),$("#message-input").prop("disabled",!1).attr("placeholder","Type your message..."))},createNewChat:function(){this.currentChatId=0,$("#chat-history-list li").removeClass("active"),$("#adeptus-chat-container").empty(),this.clearMCQ(),this.showWelcomeMessage()},showWelcomeMessage:function(){$("#adeptus-chat-container").html('\n                <div class="adeptus-welcome-message text-center p-5">\n                    <div style="max-width: 600px; margin: 0 auto;">\n                        <h3 class="mb-4">Welcome to Adeptus AI Assistant</h3>\n                        <p class="text-muted mb-4">\n                            I\'m here to help you analyze your Moodle data and generate insightful reports.\n                        </p>\n                        <div class="row g-3">\n                            <div class="col-md-6">\n                                <div class="p-3 bg-light rounded">\n                                    <i class="fa fa-chart-bar fa-2x mb-2 text-primary"></i>\n                                    <h5>Generate Reports</h5>\n                                    <small class="text-muted">Ask me to create custom reports about courses, users, grades, and more.</small>\n                                </div>\n                            </div>\n                            <div class="col-md-6">\n                                <div class="p-3 bg-light rounded">\n                                    <i class="fa fa-question-circle fa-2x mb-2 text-info"></i>\n                                    <h5>Get Insights</h5>\n                                    <small class="text-muted">I can help you understand your data and provide actionable insights.</small>\n                                </div>\n                            </div>\n                        </div>\n                        <hr class="my-4">\n                        <p class="text-muted">\n                            <i class="fa fa-lightbulb"></i> Try asking: "Show me all active courses with their enrollment counts"\n                        </p>\n                    </div>\n                </div>\n            ')},addChatToChatHistory(chatId,firstMessage){const list=$("#chat-history-list");list.find('li:contains("No chat history")').remove(),list.find('li:contains("No chats yet")').remove(),list.find('li:contains("Start a conversation")').remove();const date=(new Date).toLocaleString(),displayMessage=firstMessage&&firstMessage.length>100?firstMessage.substring(0,97)+"...":firstMessage||"New chat",item=$('<li class="list-group-item d-flex justify-content-between align-items-start adeptus-chat-history-item" data-chat-id="'.concat(chatId,'">\n                    <div>\n                        <small class="text-muted">').concat(date,"</small><br>\n                        ").concat(displayMessage,"\n                    </div>\n                </li>"));list.prepend(item),item.on("click",(e=>{const li=$(e.currentTarget),clickedChatId=li.data("chat-id");this.loadChatMessages(clickedChatId,li)}))},initializeCharts:function(){const container=$("#adeptus-chart-container"),canvas=$("<canvas></canvas>");container.append(canvas),new Chart(canvas[0],{type:"bar",data:{labels:[],datasets:[]},options:{responsive:!0,maintainAspectRatio:!1}})},setUserName:function(user){let userName="User";"string"==typeof user?userName=user:user&&user.name?userName=user.name:user&&user.admin_name&&(userName=user.admin_name),$(".card-title").each((function(){$(this).text().includes("AI Report Assistant")&&$(this).text(userName+": AI Report Assistant")}))},isCreditExceeded:function(used,limit){return 0!==limit&&"âˆž"!==limit&&null!=limit&&used>=limit},checkAndShowCreditLimitWarning:function(subscription){const basicExceeded=this.isCreditExceeded(subscription.basic_credits_used_this_month||0,subscription.plan_basic_credits_limit||0),premiumExceeded=this.isCreditExceeded(subscription.premium_credits_used_this_month||0,subscription.plan_premium_credits_limit||0),totalExceeded=this.isCreditExceeded(subscription.ai_credits_used_this_month||0,subscription.plan_ai_credits_limit||0);if(basicExceeded||premiumExceeded||totalExceeded){const message="You've used all your AI credits for this month. Your credits will reset on the 1st of next month. Consider upgrading your plan for more credits.";this.showPersistentCreditLimitMessage(message),this.isCreditLimitExceeded=!0,this.updateSendMessageandCreateNewChatButton()}else this.isCreditLimitExceeded=!1,this.updateSendMessageandCreateNewChatButton()},updateSubscriptionInfo:async function(){try{var promises=Ajax.call([{methodname:"report_adeptus_insights_check_subscription_status",args:{}}]),result=await promises[0],data={success:result.success,data:result.data?result.data:result};if(data.success&&data.data){(AuthUtils.getAuthStatus()||{}).subscription=data.data,"function"==typeof AuthUtils.updateSubscription&&AuthUtils.updateSubscription(data.data)}}catch(error){}const authStatus=AuthUtils.getAuthStatus();if(authStatus&&authStatus.subscription){const subscription=authStatus.subscription;this.checkAndShowCreditLimitWarning(subscription),$(".adeptus-subscription-status-bar").remove();let subscriptionHtml='\n                    <div class="adeptus-subscription-status-bar">\n                        <div class="adeptus-subscription-bar-row">\n                            <div class="adeptus-subscription-info-left">\n                                <h6 class="adeptus-subscription-title">\n                                    <i class="fa fa-chart-line adeptus-subscription-icon"></i> Subscription Status\n                                    <button class="btn btn-outline-secondary btn-sm" id="refresh-subscription-btn" title="Refresh subscription data">\n                                        <i class="fa fa-refresh"></i>\n                                    </button>\n                                </h6>\n                                <div class="adeptus-subscription-details">\n                                    <span><strong>Plan:</strong> '.concat(subscription.plan_name||"Unknown",'</span>\n                                    <span class="ms-3"><strong>Status:</strong> <span class="badge bg-').concat("active"===subscription.status?"success":"warning",'">').concat(subscription.status||"Unknown",'</span></span>\n                                </div>\n                            </div>\n                            <div class="adeptus-subscription-actions-right">\n                                <a href="javascript:void(0)" onclick="window.assistant.showCreditUsageModal()" class="btn adeptus-btn-view-usage">\n                                    <i class="fa fa-chart-bar"></i> View Usage\n                                </a>\n                            </div>\n                        </div>\n                    </div>\n                ');const assistantContainer=$("#adeptus-assistant-container");if(assistantContainer.length)assistantContainer.append(subscriptionHtml);else{const templateHeader=$(".adeptus-assistant-header");templateHeader.length&&templateHeader.after(subscriptionHtml)}const self=this;$("#refresh-subscription-btn").off("click").on("click",(function(){const $btn=$(this),$icon=$btn.find("i");$icon.removeClass("fa-refresh").addClass("fa-spinner fa-spin"),$btn.prop("disabled",!0),self.refreshSubscriptionInfo(),setTimeout((()=>{$icon.removeClass("fa-spinner fa-spin").addClass("fa-refresh"),$btn.prop("disabled",!1)}),1e3)}))}else $(".adeptus-subscription-status-bar").remove()},transformBackendAuthData:function(backendData){if(!backendData)return null;return{...window.adeptusAuthData||{},user_authorized:!0,has_api_key:!0,installation:backendData.installation,subscription:backendData.subscription?{...backendData.subscription,premium_credits_used_this_month:backendData.usage&&backendData.usage.premium_credits_used_this_month||0,basic_credits_used_this_month:backendData.usage&&backendData.usage.basic_credits_used_this_month||0,ai_credits_used_this_month:backendData.usage&&backendData.usage.ai_credits_used_this_month||0,reports_generated_this_month:backendData.usage&&backendData.usage.reports_generated_this_month||0,plan_name:backendData.plan?backendData.plan.name:"Unknown",plan_premium_credits_limit:backendData.plan&&backendData.plan.premium_credits_per_month||0,plan_basic_credits_limit:backendData.plan&&backendData.plan.basic_credits_per_month||"âˆž",plan_ai_credits_limit:backendData.plan&&backendData.plan.ai_credits||0,plan_exports_limit:backendData.plan&&backendData.plan.exports||"âˆž"}:null,plan:backendData.plan,usage:backendData.usage}},refreshSubscriptionInfo:async function(){const $refreshBtn=$("#refresh-subscription-btn"),$refreshIcon=$refreshBtn.find("i");$refreshBtn.length&&$refreshIcon.length&&($refreshIcon.removeClass("fa-refresh").addClass("fa-spinner fa-spin"),$refreshBtn.prop("disabled",!0));try{var promises=Ajax.call([{methodname:"report_adeptus_insights_check_subscription_status",args:{}}]),result=await promises[0],localData={success:result.success,data:result.data?result.data:result};if(localData.success&&localData.data){(AuthUtils.getAuthStatus()||{}).subscription=localData.data,window.adeptusAuthData&&(window.adeptusAuthData.subscription=localData.data)}await this.updateSubscriptionInfo(),this.showRefreshSuccessFeedback()}catch(error){this.showRefreshErrorFeedback()}finally{$refreshBtn.length&&$refreshIcon.length&&($refreshIcon.removeClass("fa-spinner fa-spin").addClass("fa-refresh"),$refreshBtn.prop("disabled",!1))}},showRefreshSuccessFeedback:function(){const notification=$('\n                <div class="adeptus-refresh-success-notification" style="\n                    position: fixed;\n                    top: 20px;\n                    right: 20px;\n                    background: #28a745;\n                    color: white;\n                    padding: 8px 16px;\n                    border-radius: 4px;\n                    box-shadow: 0 2px 8px rgba(0,0,0,0.15);\n                    z-index: 9999;\n                    font-size: 12px;\n                    opacity: 0;\n                    transform: translateY(-20px);\n                    transition: all 0.3s ease;\n                ">\n                    <i class="fa fa-check me-1"></i>\n                    Usage updated\n                </div>\n            ');$("body").append(notification),setTimeout((()=>{notification.css({opacity:"1",transform:"translateY(0)"})}),100),setTimeout((()=>{notification.css({opacity:"0",transform:"translateY(-20px)"}),setTimeout((()=>notification.remove()),300)}),2e3)},showRefreshErrorFeedback:function(){const notification=$('\n                <div class="adeptus-refresh-error-notification" style="\n                    position: fixed;\n                    top: 20px;\n                    right: 20px;\n                    background: #dc3545;\n                    color: white;\n                    padding: 8px 16px;\n                    border-radius: 4px;\n                    box-shadow: 0 2px 8px rgba(0,0,0,0.15);\n                    z-index: 9999;\n                    font-size: 12px;\n                    opacity: 0;\n                    transform: translateY(-20px);\n                    transition: all 0.3s ease;\n                ">\n                    <i class="fa fa-exclamation-triangle me-1"></i>\n                    Failed to update usage\n                </div>\n            ');$("body").append(notification),setTimeout((()=>{notification.css({opacity:"1",transform:"translateY(0)"})}),100),setTimeout((()=>{notification.css({opacity:"0",transform:"translateY(-20px)"}),setTimeout((()=>notification.remove()),300)}),3e3)},calculateUsagePercentage:function(used,limit){if(!limit||"âˆž"===limit||0===limit)return 0;const percentage=used/limit*100;return Math.min(percentage,100)},ajaxWithAuth:function(options){if(!AuthUtils.isAuthenticated())return this.showAuthenticationError(),Promise.reject(new Error("Authentication required"));const authHeaders=AuthUtils.getAuthHeaders();return options.headers={...options.headers,...authHeaders},options.timeout||(options.timeout=6e4),$.ajax(options)},loadCategories:function(){const self=this;this.ajaxWithAuth({url:this.backendUrl+"/reports/categories",method:"GET",contentType:"application/json",success:response=>{response.success&&response.data&&(self.cachedCategories=response.data)},error:()=>{self.cachedCategories=[{id:null,name:"General",slug:"general",color:"#6c757d",icon:"fa-folder"}]}})},getCategoryOptionsHtml:function(suggestedCategory){if(!this.cachedCategories||0===this.cachedCategories.length)return'<option value="">General</option>';const normalizedSuggested=(suggestedCategory||"general").toLowerCase().replace(/[^a-z0-9]/g,"");return this.cachedCategories.map((cat=>{const normalizedCatName=cat.name.toLowerCase().replace(/[^a-z0-9]/g,""),normalizedCatSlug=(cat.slug||"").toLowerCase().replace(/[^a-z0-9]/g,""),isSelected=normalizedCatName===normalizedSuggested||normalizedCatSlug===normalizedSuggested;return'<option value="'.concat(cat.id,'" ').concat(isSelected?"selected":"",">").concat(cat.name,"</option>")})).join("")},validateToken:function(){return AuthUtils.isAuthenticated()},resendMessage:function($msgElem,message){if(this.isSending)return;this.isSending=!0,this.showLoading();const authStatus=AuthUtils.getAuthStatus(),userInfo=(null==authStatus?void 0:authStatus.user)||{};this.ajaxWithAuth({url:this.backendUrl+"/chat/message",method:"POST",contentType:"application/json",data:JSON.stringify({message:message,chat_id:this.currentChatId||0,user_id:userInfo.id||null,user_name:userInfo.name||null}),success:response=>{this.hideLoading(),this.isSending=!1,response.error?"credit_limit"===response.error_type||"token_limit"===response.error_type?this.handleCreditLimitError(response.message,response.credit_data):"report_limit"===response.error_type?this.handleReportLimitError(response.message):(this.addMessage(response.message,"error"),this.showResendIconOnMessage($msgElem,message)):($(".adeptus-failed-reload-icon").remove(),!this.currentChatId&&response.chat_id&&(this.currentChatId=response.chat_id,this.addChatToChatHistory(response.chat_id,message)),this.handleResponse(response))},error:err=>{this.hideLoading(),this.isSending=!1,401===err.status?(AuthUtils.clearAuthData(),this.showAuthenticationError()):(this.showResendIconOnMessage($msgElem,message),this.addMessage("Network error occurred. Please try again.","error"))}})},enqueueMCQs:function(questions){Array.isArray(questions)&&0!==questions.length&&(this.mcqQueue=questions.slice(),this.showNextMCQ())},showNextMCQ:function(){if(0===this.mcqQueue.length)return this.clearMCQ();const next=this.mcqQueue.shift();this.renderMCQ(next.question,next.options)},renderMCQ:function(question,options){this.currentMCQ=!0,$("#message-input, #send-button").prop("disabled",!0);const c=$("#adeptus-mcq-container").empty().show();c.append('<p class="adeptus-mcq-question"><strong>'.concat(question,"</strong></p>")),options.forEach(((opt,idx)=>{const key=String.fromCharCode(65+idx);c.append('\n                <div class="form-check">\n                    <input class="form-check-input" type="radio"\n                        name="mcq-option" id="mcq-'.concat(idx,'"\n                        value="').concat(opt,'">\n                    <label class="form-check-label" for="mcq-').concat(idx,'">\n                    ').concat(key,". ").concat(opt,"\n                    </label>\n                </div>"))})),c.append('<button type="button" class="btn btn-link" id="mcq-cancel">Cancel</button>'),c.find('input[name="mcq-option"]').on("change",(()=>{$("#mcq-submit").remove(),c.append('<button type="button" id="mcq-submit" class="btn btn-primary mt-2">Submit</button>'),$("#mcq-submit").off("click").on("click",(e=>{e.preventDefault(),e.stopPropagation();const selected=c.find('input[name="mcq-option"]:checked').val();selected&&this.sendMCQ(selected)}))})),c.find("#mcq-cancel").off("click").on("click",(e=>{e.preventDefault(),this.mcqQueue=[],this.clearMCQ()}))},sendMCQ:function(answer){if(this.isSending)return;if(!answer||"string"!=typeof answer||!answer.trim())return;this.showLoading(),this.isSending=!0,this.clearMCQ();const $userMsg=this.addMessage(answer,"user"),authStatus=AuthUtils.getAuthStatus(),userInfo=(null==authStatus?void 0:authStatus.user)||{},messageToSend="I selected: ".concat(answer.trim());this.ajaxWithAuth({url:this.backendUrl+"/chat/message",method:"POST",contentType:"application/json",data:JSON.stringify({message:messageToSend,chat_id:this.currentChatId||0,user_id:userInfo.id||null,user_name:userInfo.name||null}),success:response=>{this.hideLoading(),this.isSending=!1,response.error?"credit_limit"===response.error_type||"token_limit"===response.error_type?this.handleCreditLimitError(response.message):"report_limit"===response.error_type?this.handleReportLimitError(response.message):(this.addMessage(response.message,"error"),this.showResendIconOnMessage($userMsg,answer)):($(".adeptus-failed-reload-icon").remove(),this.handleResponse(response))},error:()=>{this.hideLoading(),this.isSending=!1,this.addMessage("Failed to send choice","error"),this.showResendIconOnMessage($userMsg,answer)}})},showReportConfirmation:function(report,reportData,message,creditInfo,executionError){this.addMessage(message||"I've generated a report: ".concat(report.description),"ai",!1,null,null,null,creditInfo),reportData&&reportData.length>0?this.displayReportInChat(report,reportData):executionError?this.addMessage("âš ï¸ The report could not be executed: ".concat(executionError,"\n\nYou can still save it and try executing it later."),"system"):this.addMessage("â„¹ï¸ The report returned no data. You can still save it for later use.","system"),this.addReportActionButtons(report)},displayReportInChat:function(report,data){let tableHtml='<div class="adeptus-report-preview-container" style="margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 8px; border: 1px solid #dee2e6;">';if(tableHtml+='<h5 style="margin-bottom: 10px; color: #495057;">'.concat(report.name||report.description,"</h5>"),data&&data.length>0){const headers=Object.keys(data[0]),maxPreviewRows=20,previewRows=data.slice(0,maxPreviewRows);if(tableHtml+='<div class="table-responsive">',tableHtml+='<table class="table table-sm table-striped table-hover" style="font-size: 0.9rem; margin-bottom: 0;">',tableHtml+='<thead class="table-light"><tr>',headers.forEach((header=>{tableHtml+='<th style="background: #e9ecef; white-space: nowrap;">'.concat(header.replace(/_/g," ").replace(/\b\w/g,(l=>l.toUpperCase())),"</th>")})),tableHtml+="</tr></thead><tbody>",previewRows.forEach((row=>{tableHtml+="<tr>",headers.forEach((header=>{let value=row[header]||"";value.toString().length>50&&(value=value.toString().substring(0,47)+"..."),tableHtml+="<td>".concat(value,"</td>")})),tableHtml+="</tr>"})),tableHtml+="</tbody></table></div>",data.length>maxPreviewRows){const remainingRows=data.length-maxPreviewRows;tableHtml+='<div class="text-center mt-3">',tableHtml+='<p class="text-muted mb-2" style="font-size: 0.85rem;">',tableHtml+="<strong>Showing ".concat(maxPreviewRows," of ").concat(data.length," rows</strong>"),tableHtml+=" (".concat(remainingRows," more rows available)"),tableHtml+="</p>",tableHtml+='<small class="text-info"><i class="fa fa-info-circle"></i> Save the report to view all data in the Reports panel</small>',tableHtml+="</div>"}else tableHtml+='<p class="text-muted text-center mt-2" style="font-size: 0.85rem;">Showing all '.concat(data.length," rows</p>");tableHtml+='<div class="mt-3 p-2 bg-light rounded" style="font-size: 0.85rem;">',tableHtml+='<span class="badge badge-secondary">'.concat(report.category,"</span>"),tableHtml+="</div>"}tableHtml+="</div>",this.addMessage(tableHtml,"report-preview",!1)},addReportActionButtons:function(report){const self=this,existingActions=document.querySelectorAll(".adeptus-report-action-container");existingActions.length>0&&existingActions.forEach((container=>{container.querySelector(".fa-check-circle")||container.querySelector(".fa-info-circle")||container.querySelector(".fa-exclamation-triangle")||container.remove()}));const buttonId="report-action-"+Date.now(),buttonsHtml='\n                <div class="adeptus-report-action-container" id="'.concat(buttonId,'" style="margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 8px; border: 1px solid #dee2e6;">\n                    <p style="margin-bottom: 15px; font-weight: 500;">Would you like to save this report to your Reports list?</p>\n                    <div class="adeptus-report-actions" style="display: flex; gap: 10px; flex-wrap: wrap;">\n                        <button class="btn btn-primary adeptus-btn-save-report" style="padding: 8px 20px;">\n                            <i class="fa fa-check-circle"></i> Save Report\n                        </button>\n                        <button class="btn btn-secondary adeptus-btn-decline-report" style="padding: 8px 20px;">\n                            <i class="fa fa-times-circle"></i> Don\'t Save\n                        </button>\n                        <button class="btn btn-outline-secondary adeptus-btn-decline-feedback" style="padding: 8px 20px;">\n                            <i class="fa fa-comment"></i> Decline & Give Feedback\n                        </button>\n                    </div>\n                </div>\n            ');this.addMessage(buttonsHtml,"system-action",!1),setTimeout((()=>{const container=document.getElementById(buttonId);if(!container)return;const saveBtn=container.querySelector(".adeptus-btn-save-report");saveBtn&&!saveBtn.hasAttribute("data-handler-attached")&&(saveBtn.setAttribute("data-handler-attached","true"),saveBtn.addEventListener("click",(function(){const categoryOptions=self.getCategoryOptionsHtml(report.category),defaultName=report.name||report.description||"SCORM Activities Report";Swal.fire({title:getString("save_your_report","Save Your Report"),html:'\n                                <div style="text-align: left;">\n                                    <div style="margin-bottom: 15px;">\n                                        <label for="swal-report-name" style="display: block; margin-bottom: 5px; font-weight: 500;">\n                                            '.concat(getString("report_name_label","Report Name"),'\n                                        </label>\n                                        <input type="text" id="swal-report-name" class="swal2-input"\n                                               placeholder="').concat(getString("enter_report_name","Enter a name for your report"),'"\n                                               value="').concat(defaultName.replace(/"/g,"&quot;"),'"\n                                               style="margin: 0; width: 100%;">\n                                    </div>\n                                    <div>\n                                        <label for="swal-report-category" style="display: block; margin-bottom: 5px; font-weight: 500;">\n                                            ').concat(getString("category_label","Category"),'\n                                        </label>\n                                        <select id="swal-report-category" class="swal2-select"\n                                                style="margin: 0; width: 100%; padding: 8px 12px; border: 1px solid #d9d9d9; border-radius: 4px;">\n                                            ').concat(categoryOptions,"\n                                        </select>\n                                    </div>\n                                </div>\n                            "),showCancelButton:!0,confirmButtonText:'<i class="fa fa-save"></i> '+getString("save_report","Save Report"),cancelButtonText:getString("cancel","Cancel"),confirmButtonColor:"#28a745",focusConfirm:!1,preConfirm:()=>{const name=document.getElementById("swal-report-name").value,categoryId=document.getElementById("swal-report-category").value;return name&&""!==name.trim()?name.length>255?(Swal.showValidationMessage("Report name is too long (max 255 characters)"),!1):{name:name.trim(),categoryId:categoryId}:(Swal.showValidationMessage("Please enter a name for the report"),!1)}}).then((result=>{result.isConfirmed&&(report.name=result.value.name,report.description=result.value.name,report.category_id=result.value.categoryId?parseInt(result.value.categoryId):null,container.querySelectorAll("button").forEach((btn=>btn.disabled=!0)),container.innerHTML='\n                                    <div style="text-align: center; color: #28a745;">\n                                        <i class="fa fa-spinner fa-spin"></i> Saving "'.concat(report.name,'" to your Reports list...\n                                    </div>\n                                '),self.confirmReport("accept",report,null))}))})));const declineBtn=container.querySelector(".adeptus-btn-decline-report");declineBtn&&!declineBtn.hasAttribute("data-handler-attached")&&(declineBtn.setAttribute("data-handler-attached","true"),declineBtn.addEventListener("click",(function(){container.innerHTML='\n                            <div style="text-align: center; color: #6c757d;">\n                                <i class="fa fa-info-circle"></i> Report not saved. You can ask me to generate it again anytime.\n                            </div>\n                        ',self.addMessage("Report was not saved. Feel free to ask me to generate a different report or refine this one.","system")})));const feedbackBtn=container.querySelector(".adeptus-btn-decline-feedback");feedbackBtn&&!feedbackBtn.hasAttribute("data-handler-attached")&&(feedbackBtn.setAttribute("data-handler-attached","true"),feedbackBtn.addEventListener("click",(function(){container.innerHTML='\n                            <div class="adeptus-feedback-form">\n                                <p style="margin-bottom: 10px;">What would you like to change about this report?</p>\n                                <textarea id="feedback-text-'.concat(buttonId,'" class="form-control" rows="3" placeholder="Please provide your feedback..."></textarea>\n                                <div style="margin-top: 10px; display: flex; gap: 10px;">\n                                    <button class="btn btn-primary adeptus-btn-send-feedback">\n                                        <i class="fa fa-paper-plane"></i> Send Feedback\n                                    </button>\n                                    <button class="btn btn-secondary adeptus-btn-cancel-feedback">\n                                        Cancel\n                                    </button>\n                                </div>\n                            </div>\n                        ');const sendFeedbackBtn=container.querySelector(".adeptus-btn-send-feedback"),cancelFeedbackBtn=container.querySelector(".adeptus-btn-cancel-feedback"),feedbackText=container.querySelector("#feedback-text-".concat(buttonId));sendFeedbackBtn&&sendFeedbackBtn.addEventListener("click",(function(){const feedback=feedbackText?feedbackText.value:"";feedback.trim()?(container.innerHTML='\n                                        <div style="text-align: center; color: #007bff;">\n                                            <i class="fa fa-spinner fa-spin"></i> Sending feedback...\n                                        </div>\n                                    ',self.confirmReport("decline",report,feedback)):(feedbackText.style.borderColor="#dc3545",feedbackText.focus())})),cancelFeedbackBtn&&cancelFeedbackBtn.addEventListener("click",(function(){container.innerHTML='\n                                    <div style="text-align: center; color: #6c757d;">\n                                        <i class="fa fa-info-circle"></i> Report not saved.\n                                    </div>\n                                '}))})))}),100)},viewSavedReport:function(slug){slug&&($('[href="#reports-history"]').tab("show"),setTimeout((()=>{const reportRow=$('.adeptus-report-row[data-report-slug="'.concat(slug,'"]'));reportRow.length?reportRow.click():this.loadReportsHistory((()=>{setTimeout((()=>{const refreshedRow=$('.adeptus-report-row[data-report-slug="'.concat(slug,'"]'));refreshedRow.length?refreshedRow.click():Notification.addNotification({message:getString("report_not_found","Report not found. Please check if it still exists in the Reports tab."),type:"error"})}),500)}))}),300))},displayReportLink:function(msg){var _msg$metadata,_msg$metadata2,_msg$metadata3;const frag=document.getElementById("message-template").content.cloneNode(!0),messageEl=frag.querySelector(".adeptus-message");messageEl.classList.add("adeptus-ai-message"),messageEl.setAttribute("data-message-id",msg.id);const reportSlug=(null===(_msg$metadata=msg.metadata)||void 0===_msg$metadata?void 0:_msg$metadata.report_slug)||"",reportName=(null===(_msg$metadata2=msg.metadata)||void 0===_msg$metadata2?void 0:_msg$metadata2.report_name)||"Report",reportDescription=(null===(_msg$metadata3=msg.metadata)||void 0===_msg$metadata3?void 0:_msg$metadata3.report_description)||"",reportLinkHtml='\n                <div class="adeptus-report-link-message">\n                    <div style="padding: 15px; background: linear-gradient(135deg, #007bff 0%, #0056b3 100%); color: white; border-radius: 10px; margin: 10px 0;">\n                        <div style="display: flex; align-items: center; justify-content: space-between; gap: 20px;">\n                            <div style="flex: 1;">\n                                <h5 style="margin: 0; color: white;">\n                                    <i class="fa fa-chart-bar"></i> '.concat(reportName,"\n                                </h5>\n                                ").concat(reportDescription?'<small style="opacity: 0.9;">'.concat(reportDescription,"</small>"):"","\n                            </div>\n                            ").concat(reportSlug?'\n                                <button class="btn btn-light btn-sm adeptus-view-saved-report-btn"\n                                        data-slug="'.concat(reportSlug,'"\n                                        style="cursor: pointer; border-radius: 5px; flex-shrink: 0;">\n                                    <i class="fa fa-eye"></i> View Report\n                                </button>\n                            '):"","\n                        </div>\n                    </div>\n                </div>\n            ");frag.querySelector(".adeptus-message-text").innerHTML=reportLinkHtml,frag.querySelector(".adeptus-message-time").textContent=this.formatTimestamp(msg.timestamp),$("#adeptus-chat-container").append(frag);const self=this;setTimeout((()=>{const viewBtn=$("#adeptus-chat-container").find('.adeptus-view-saved-report-btn[data-slug="'+reportSlug+'"]').last();viewBtn.length&&!viewBtn.hasClass("adeptus-click-handler-attached")&&(viewBtn.addClass("adeptus-click-handler-attached"),viewBtn.on("click",(function(e){e.preventDefault(),e.stopPropagation(),self.switchToReportsTab();const reportRow=$('.adeptus-report-row[data-report-slug="'.concat(reportSlug,'"]'));reportRow.length>0?reportRow.trigger("click"):self.fetchAndDisplayReport(reportSlug)})))}),100)},sendReportMessage:function(report){const reportMessage="ðŸ“Š Report saved: ".concat(report.description||report.name),reportLinkMsg={id:Date.now(),sender_type:"ai",body:reportMessage,timestamp:(new Date).toISOString(),metadata:{type:"report",report_slug:report.slug,report_name:report.name||report.description,report_description:report.description}};this.displayReportLink(reportLinkMsg)},confirmReport:function(action,report,feedback){const self=this;this.showLoading();const authStatus=AuthUtils.getAuthStatus(),userInfo=(null==authStatus?void 0:authStatus.user)||{},reportData={name:report.name||report.description||"Generated Report",description:report.description||"",sql:report.sql||"",category:report.category||"general",category_id:report.category_id||null},chatId=parseInt(this.currentChatId)||0;this.ajaxWithAuth({url:this.backendUrl+"/chat/report-confirmation",method:"POST",contentType:"application/json",timeout:9e4,data:JSON.stringify({chat_id:chatId,action:action,feedback:feedback||null,report:reportData,user_id:userInfo.id||null}),success:response=>{if(this.hideLoading(),"accept"===action&&response.report){Array.isArray(this.cachedReports)||(this.cachedReports=[]),this.cachedReports.unshift(response.report),this.updateReportsHistory(this.cachedReports);const reportName=response.report.name||report.name||report.description||"AI Generated Report";this.trackReportCreated(reportName),this.sendReportMessage(response.report),$("#report-history-loader").addClass("d-none"),$("#report-history-table-wrapper").removeClass("d-none"),$("#reports-history-table").removeClass("d-none"),document.querySelectorAll(".adeptus-report-action-container").forEach((container=>{container.innerHTML='\n                                <div style="text-align: center; color: #28a745; padding: 10px;">\n                                    <i class="fa fa-check-circle"></i> Report saved successfully!\n                                </div>\n                            '}))}else if(response.chat_response){const chatResponse=response.chat_response;if(chatResponse.error||chatResponse.message&&(chatResponse.message.toLowerCase().includes("trouble connecting")||chatResponse.message.toLowerCase().includes("service")||chatResponse.message.toLowerCase().includes("try again"))){const errorMsg=chatResponse.message||"The AI service is temporarily unavailable.";document.querySelectorAll(".adeptus-report-action-container").forEach((container=>{const retryBtnId="retry-feedback-"+Date.now();container.innerHTML='\n                                        <div style="text-align: center; padding: 10px;">\n                                            <div style="color: #dc3545; margin-bottom: 10px;">\n                                                <i class="fa fa-exclamation-circle"></i> '.concat(errorMsg,'\n                                            </div>\n                                            <button id="').concat(retryBtnId,'" class="btn btn-primary btn-sm">\n                                                <i class="fa fa-refresh"></i> Retry\n                                            </button>\n                                        </div>\n                                    ');const retryBtn=document.getElementById(retryBtnId);retryBtn&&retryBtn.addEventListener("click",(function(){self.confirmReport(action,report,feedback)}))})),this.addMessage(errorMsg,"error")}else{const hasReportStructure=chatResponse.type&&("sql"===chatResponse.type||"report"===chatResponse.type)&&chatResponse.report&&chatResponse.awaiting_confirmation;chatResponse.message&&(chatResponse.message.toLowerCase().includes("report generated")||chatResponse.message.toLowerCase().includes("generated a report")||chatResponse.message.toLowerCase().includes("i've generated"))&&!hasReportStructure?(document.querySelectorAll(".adeptus-report-action-container").forEach((container=>{const retryBtnId="retry-ghost-"+Date.now();container.innerHTML='\n                                            <div style="text-align: center; padding: 10px;">\n                                                <div style="color: #856404; background: #fff3cd; padding: 12px; border-radius: 6px; margin-bottom: 10px;">\n                                                    <i class="fa fa-exclamation-triangle"></i>\n                                                    The refined report was generated but could not be displayed properly.\n                                                </div>\n                                                <button id="'.concat(retryBtnId,'" class="btn btn-primary btn-sm">\n                                                    <i class="fa fa-refresh"></i> Try Again\n                                                </button>\n                                            </div>\n                                        ');const retryBtn=document.getElementById(retryBtnId);retryBtn&&retryBtn.addEventListener("click",(function(){self.confirmReport(action,report,feedback)}))})),this.addMessage("The report refinement encountered an issue. Please try again using the button above, or start a new request.","system")):hasReportStructure?(document.querySelectorAll(".adeptus-report-action-container").forEach((container=>{container.innerHTML='\n                                            <div style="text-align: center; color: #007bff;">\n                                                <i class="fa fa-info-circle"></i> Feedback sent. I\'ll refine the report based on your input.\n                                            </div>\n                                        '})),this.handleResponse(response.chat_response)):(document.querySelectorAll(".adeptus-report-action-container").forEach((container=>{container.innerHTML='\n                                            <div style="text-align: center; color: #007bff;">\n                                                <i class="fa fa-info-circle"></i> Feedback sent.\n                                            </div>\n                                        '})),this.handleResponse(response.chat_response))}}else document.querySelectorAll(".adeptus-report-action-container").forEach((container=>{container.innerHTML='\n                                    <div style="text-align: center; color: #007bff;">\n                                        <i class="fa fa-info-circle"></i> Feedback sent.\n                                    </div>\n                                '}))},error:(xhr,status)=>{this.hideLoading();let errorMessage="Failed to process request. Please try again.",showRetry=!0;if("timeout"===status)errorMessage="Request timed out. The AI service may be busy. Please try again.";else if(0===xhr.status)errorMessage="Network error. Please check your connection and try again.";else if(401===xhr.status)errorMessage="Session expired. Please refresh the page and log in again.",showRetry=!1;else if(429===xhr.status)errorMessage="Too many requests. Please wait a moment and try again.";else if(xhr.status>=500)errorMessage="Server error. Please try again in a moment.";else if(xhr.responseJSON&&xhr.responseJSON.errors){const errors=xhr.responseJSON.errors,errorDetails=Object.keys(errors).map((field=>"".concat(field,": ").concat(errors[field].join(", ")))).join("; ");errorMessage="Validation failed: ".concat(errorDetails),showRetry=!1}else xhr.responseJSON&&xhr.responseJSON.message&&(errorMessage=xhr.responseJSON.message);document.querySelectorAll(".adeptus-report-action-container").forEach((container=>{const retryBtnId="retry-error-"+Date.now();let retryHtml="";if(showRetry&&(retryHtml='\n                                <button id="'.concat(retryBtnId,'" class="btn btn-outline-primary btn-sm" style="margin-top: 10px;">\n                                    <i class="fa fa-refresh"></i> Try Again\n                                </button>\n                            ')),container.innerHTML='\n                            <div style="text-align: center; padding: 10px;">\n                                <div style="color: #dc3545;">\n                                    <i class="fa fa-exclamation-triangle"></i> '.concat(errorMessage,"\n                                </div>\n                                ").concat(retryHtml,"\n                            </div>\n                        "),showRetry){const retryBtn=document.getElementById(retryBtnId);retryBtn&&retryBtn.addEventListener("click",(function(){self.confirmReport(action,report,feedback)}))}}))}})},switchToReportsTab:function(){setTimeout((()=>{$(".datatable-wrapper").removeClass("datatable-loading"),$("#report-history-table-wrapper .datatable-wrapper").removeClass("datatable-loading")}),200),$("#reports-tab").tab("show"),$("#assistant-tab").removeClass("active").attr("aria-selected","false"),$("#reports-tab").addClass("active").attr("aria-selected","true"),$("#assistant-panel").removeClass("show active"),$("#reports-panel").addClass("show active"),$(".adeptus-report-view-title").text("Select a Report"),$(".adeptus-report-view-body").html('<div class="text-center py-4"><p class="text-muted">Select a report from history to view details here.</p></div>'),!this.cachedReports||Array.isArray(this.cachedReports)&&0===this.cachedReports.length&&!this.reportsLoaded?this.loadReportsHistory():($("#report-history-loader").addClass("d-none"),$("#report-history-table-wrapper").removeClass("d-none"),this.cachedReports&&this.updateReportsHistory(this.cachedReports))},loadReportsHistory:function(callback){this.cachedReports||(this.cachedReports=[]),$("#report-history-loader").removeClass("d-none"),$("#report-history-table-wrapper").addClass("d-none"),this.ajaxWithAuth({url:this.backendUrl+"/ai-reports",method:"GET",timeout:1e4,success:response=>{const reports=response.reports||response.data||[];this.cachedReports=Array.isArray(reports)?reports:[],this.reportsLoaded=!0,this.updateReportsHistory(this.cachedReports),$("#report-history-loader").addClass("d-none"),$("#report-history-table-wrapper").removeClass("d-none"),this.reportsDataTable&&(this.reportsDataTable.destroy(),this.reportsDataTable=null),setTimeout((()=>{try{const tableElement=document.getElementById("reports-history-table");if(!tableElement)return;const tbody=tableElement.querySelector("tbody"),thead=tableElement.querySelector("thead");if(thead&&tbody&&thead.rows.length>0&&thead.rows[0].cells.length>0){this.reportsDataTable&&(this.reportsDataTable.destroy(),this.reportsDataTable=null);const headerCells=thead.rows[0].cells.length,dataRows=tbody.rows;let dataCells=0;dataRows.length>0&&(dataCells=dataRows[0].cells.length),headerCells===dataCells&&headerCells>0&&dataRows.length>0&&!dataRows[0].cells[0].textContent.includes("No reports")&&(this.reportsDataTable=new simpleDatatables.DataTable("#reports-history-table",{searchable:!0,fixedHeight:!1,perPage:10,loading:!1}),setTimeout((()=>{$(".datatable-wrapper").removeClass("datatable-loading"),$("#report-history-table-wrapper .datatable-wrapper").removeClass("datatable-loading"),$(".dataTable-loading").remove()}),100))}}catch(error){}"function"==typeof callback&&callback()}),100)},error:(xhr,status)=>{$("#report-history-loader").addClass("d-none"),$("#report-history-table-wrapper").removeClass("d-none");const tbody=$("#reports-history-table tbody");tbody.empty(),"timeout"===status?tbody.append('<tr><td colspan="3" class="text-center text-warning">Loading reports timed out. Please refresh the page.</td></tr>'):401===xhr.status||403===xhr.status?tbody.append('<tr><td colspan="3" class="text-center text-danger">Authentication error. Please log in again.</td></tr>'):this.cachedReports&&this.cachedReports.length>0?this.updateReportsHistory(this.cachedReports):tbody.append('<tr><td colspan="3" class="text-center text-muted">Unable to load reports. Please try again later.</td></tr>'),"function"==typeof callback&&callback()}})},updateReportsHistory:function(reports){const tbody=$("#reports-history-table tbody"),self=this;if(tbody.empty(),reports&&0!==reports.length)reports.forEach((report=>{const statusBadge=self.getStatusBadge(report.status),date=new Date(report.created_at).toLocaleDateString(),row=$('\n                    <tr class="adeptus-report-row" data-report-slug="'.concat(report.slug,'">\n                        <td>').concat(report.description,"</td>\n                        <td>").concat(date,"</td>\n                        <td>").concat(statusBadge,"</td>\n                    </tr>"));tbody.append(row)})),$("#report-history-table-wrapper").off("click",".adeptus-report-row"),$("#report-history-table-wrapper").on("click",".adeptus-report-row",(function(){const $row=$(this),reportSlug=$row.data("report-slug"),report=self.cachedReports.find((r=>r.slug===reportSlug));if(!report)return;$("#report-history-loader").addClass("d-none"),$("#report-history-table-wrapper").removeClass("d-none");if($("#reports-panel .col-md-8 .card-body").find(".adeptus-report-display-wrapper").html('<div class="w-100 d-flex justify-content-center align-items-center" style="min-height:200px"><div class="spinner-border text-primary" role="status"></div></div>'),Array.isArray(self.cachedReports)&&self.cachedReports.length>0){const rep=self.cachedReports.find((r=>r.slug===report.slug));rep&&rep.data&&Array.isArray(rep.data)&&rep.data.length>0?setTimeout((()=>{self.updateReportsView(rep,rep.data)}),300):self.fetchAndDisplayReport(report.slug,$row)}else self.fetchAndDisplayReport(report.slug,$row);$(".adeptus-report-row").removeClass("table-primary"),$row.addClass("table-primary")}));else{const authStatus=AuthUtils.getAuthStatus();authStatus&&authStatus.subscription&&authStatus.subscription.reports_generated_this_month>0?tbody.append('<tr><td colspan="3" class="text-center text-muted">'.concat(getString("no_reports","No reports yet"),"</td></tr>")):tbody.append('\n                        <tr>\n                            <td colspan="3" class="text-center text-muted">\n                                <div class="py-4">\n                                    <i class="fa fa-chart-bar fa-2x mb-2"></i>\n                                    <p class="mb-1">'.concat(getString("no_reports_generated","No reports generated yet"),"</p>\n                                    <small>").concat(getString("ask_ai_create_reports","Ask the AI assistant to create reports for you"),"</small>\n                                </div>\n                            </td>\n                        </tr>\n                    "))}},fetchAndDisplayReport:function(reportSlug,rowElem){const self=this,reportsView=$("#reports-panel .col-md-8 .card-body");$("#report-history-loader").addClass("d-none"),$("#report-history-table-wrapper").removeClass("d-none"),reportsView.html('<div class="adeptus-report-display-wrapper w-100"><div class="w-100 d-flex justify-content-center align-items-center" style="min-height:200px"><div class="spinner-border text-primary" role="status"></div></div></div>'),this.ajaxWithAuth({url:"".concat(this.backendUrl,"/ai-reports/").concat(reportSlug),method:"GET",success:response=>{const report=response.report;if(response.data&&Array.isArray(response.data)&&response.data.length>0)return void self.displayFetchedReport(report,response.data,rowElem);const sqlQuery=response.sql||report&&report.sql_query||report&&report.sql;sqlQuery?self.executeReportLocally(sqlQuery,(null==report?void 0:report.params)||{}).then((executionResult=>{executionResult.error?reportsView.find(".adeptus-report-display-wrapper").html('<div class="w-100 text-center text-danger py-4">\n                                            <i class="fa fa-exclamation-triangle"></i>\n                                            Failed to execute report: '.concat(executionResult.error,"\n                                        </div>")):executionResult.data&&0!==executionResult.data.length?self.displayFetchedReport(report,executionResult.data,rowElem):reportsView.find(".adeptus-report-display-wrapper").html('<div class="w-100 text-center text-warning py-4"><i class="fa fa-info-circle"></i> Report executed successfully but returned no data.</div>')})).catch((error=>{reportsView.find(".adeptus-report-display-wrapper").html('<div class="w-100 text-center text-danger py-4">\n                                        <i class="fa fa-exclamation-triangle"></i>\n                                        Failed to execute report: '.concat(error.message,"\n                                    </div>"))})):reportsView.find(".adeptus-report-display-wrapper").html('<div class="w-100 text-center text-warning py-4"><i class="fa fa-exclamation-triangle"></i> Report has no data or SQL to execute.</div>')},error:()=>{reportsView.find(".adeptus-report-display-wrapper").html('<div class="w-100 text-center text-danger py-4">Failed to load report. Please try again.</div>')}})},displayFetchedReport:function(report,data,rowElem){Array.isArray(this.cachedReports)||(this.cachedReports=[]);let idx=this.cachedReports.findIndex((r=>r.slug===report.slug));idx>-1?this.cachedReports[idx]=Object.assign({},report,{data:data}):this.cachedReports.push(Object.assign({},report,{data:data})),this.currentViewedReport=report,this.currentViewedReportData=data,this.updateReportsView(report,data),$(".adeptus-report-row").removeClass("table-primary"),rowElem&&rowElem.addClass("table-primary")},displayCurrentReport:function(report){this.updateReportsView(report),$('.adeptus-report-row[data-report-slug="'.concat(report.slug,'"]')).addClass("table-primary")},displayReport:function(reportSlug){const rep=this.cachedReports.find((r=>r.slug===reportSlug));rep&&(this.updateReportsView(rep,rep.data),$(".adeptus-report-row").removeClass("table-primary"),$('.adeptus-report-row[data-report-slug="'.concat(reportSlug,'"]')).addClass("table-primary"))},updateReportsView:function(report){let data=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;const self=this;if(self.currentViewedReport=report,self.currentViewedReportData=data,self.reportChartInstance&&(self.reportChartInstance.destroy(),self.reportChartInstance=null),self.reportGraphInstance&&(self.reportGraphInstance.destroy(),self.reportGraphInstance=null),self._vteController&&"function"==typeof self._vteController.destroy){try{self._vteController.destroy()}catch(e){}self._vteController=null}const reportsView=$("#reports-panel .col-md-8 .card-body");if(0===$("#display-type-icon-style").length&&$("head").append('\n                    <style id="display-type-icon-style">\n                        /* View toggle buttons */\n                        .adeptus-view-toggle .adeptus-view-toggle-btn {\n                            background: #f8f9fa;\n                            border: 1px solid #dee2e6;\n                            color: #495057;\n                            padding: 0.35rem 0.75rem;\n                            font-size: 13px;\n                            transition: all 0.2s ease;\n                        }\n                        .adeptus-view-toggle .adeptus-view-toggle-btn:first-child {\n                            border-radius: 6px 0 0 6px;\n                        }\n                        .adeptus-view-toggle .adeptus-view-toggle-btn:last-child {\n                            border-radius: 0 6px 6px 0;\n                        }\n                        .adeptus-view-toggle .adeptus-view-toggle-btn:hover {\n                            background: #e9ecef;\n                        }\n                        .adeptus-view-toggle .adeptus-view-toggle-btn.active {\n                            background: #2563eb;\n                            border-color: #2563eb;\n                            color: white;\n                        }\n                        .adeptus-view-toggle .adeptus-view-toggle-btn i {\n                            margin-right: 5px;\n                        }\n\n                        /* Chart controls wrapper */\n                        .adeptus-chart-controls-wrapper {\n                            background: #f8f9fa;\n                            border-radius: 8px;\n                            padding: 1rem;\n                            border: 1px solid #e9ecef;\n                        }\n                        .adeptus-chart-controls {\n                            display: flex;\n                            align-items: flex-end;\n                            flex-wrap: wrap;\n                        }\n                        .adeptus-chart-controls .adeptus-control-group {\n                            display: flex;\n                            flex-direction: column;\n                            gap: 0.25rem;\n                        }\n                        .adeptus-chart-controls .form-label {\n                            font-size: 11px;\n                            font-weight: 600;\n                            color: #6c757d;\n                            margin-bottom: 0;\n                            text-transform: uppercase;\n                            letter-spacing: 0.5px;\n                        }\n                        .adeptus-chart-controls .form-select {\n                            font-size: 13px;\n                            padding: 0.4rem 2rem 0.4rem 0.75rem;\n                            border-radius: 6px;\n                            border: 1px solid #dee2e6;\n                            background-color: white;\n                            min-width: 140px;\n                        }\n                        .adeptus-chart-controls .form-select:focus {\n                            border-color: #2563eb;\n                            box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.15);\n                        }\n\n                        /* Legacy icon button styles */\n                        .btn-icon {\n                            transition: transform 0.15s cubic-bezier(.4,2,.6,1), background 0.2s, border 0.2s;\n                            background: #f8f9fa;\n                            border: 1.5px solid #e0e0e0;\n                            color: #333;\n                        }\n                        .btn-icon:hover {\n                            transform: scale(1.15);\n                            background: #e9ecef;\n                            border-color: #b3d7ff;\n                            color: #007bff;\n                            z-index: 2;\n                        }\n                        .btn-icon.active, .btn-icon:focus {\n                            background: #e3f0ff;\n                            border-color: #007bff;\n                            color: #007bff;\n                            box-shadow: 0 0 0 2px #b3d7ff33;\n                        }\n                    </style>\n                '),$(".adeptus-report-view-title").text(report.description),!Array.isArray(data)||0===data.length)return void reportsView.find(".adeptus-report-display-wrapper").html('<div class="w-100 text-center text-muted py-4">No data available for this report.</div>');const headers=Object.keys(data[0]||{}),numericCols=this.detectNumericColumns(data,headers);let chartControlsHtml='<div class="adeptus-chart-controls-wrapper mb-3">';chartControlsHtml+='<div class="adeptus-chart-controls d-flex flex-wrap align-items-end gap-3">',chartControlsHtml+='<div class="adeptus-control-group">',chartControlsHtml+='<label for="report-chart-type" class="form-label">Chart Type</label>',chartControlsHtml+='<select id="report-chart-type" class="form-select form-select-sm">',chartControlsHtml+='<option value="bar">Bar Chart</option>',chartControlsHtml+='<option value="line">Line Chart</option>',chartControlsHtml+='<option value="pie">Pie Chart</option>',chartControlsHtml+='<option value="doughnut">Doughnut Chart</option>',chartControlsHtml+="</select></div>",chartControlsHtml+='<div class="adeptus-control-group">',chartControlsHtml+='<label for="report-chart-x-axis" class="form-label">X-Axis (Labels)</label>',chartControlsHtml+='<select id="report-chart-x-axis" class="form-select form-select-sm">',headers.forEach(((header,idx)=>{const formattedHeader=header.replace(/_/g," ").replace(/\b\w/g,(l=>l.toUpperCase())),selected=0===idx?" selected":"";chartControlsHtml+='<option value="'.concat(header,'"').concat(selected,">").concat(formattedHeader,"</option>")})),chartControlsHtml+="</select></div>",chartControlsHtml+='<div class="adeptus-control-group">',chartControlsHtml+='<label for="report-chart-y-axis" class="form-label">Y-Axis (Values)</label>',chartControlsHtml+='<select id="report-chart-y-axis" class="form-select form-select-sm">',numericCols.length>0?numericCols.forEach(((col,idx)=>{const formattedHeader=col.replace(/_/g," ").replace(/\b\w/g,(l=>l.toUpperCase())),selected=idx===numericCols.length-1?" selected":"";chartControlsHtml+='<option value="'.concat(col,'"').concat(selected,">").concat(formattedHeader,"</option>")})):headers.forEach(((header,idx)=>{const formattedHeader=header.replace(/_/g," ").replace(/\b\w/g,(l=>l.toUpperCase())),selected=idx===headers.length-1?" selected":"";chartControlsHtml+='<option value="'.concat(header,'"').concat(selected,">").concat(formattedHeader,"</option>")})),chartControlsHtml+="</select></div>",chartControlsHtml+="</div></div>";const premiumClass=self.isFreePlan?" adeptus-export-premium":"",premiumIcon=self.isFreePlan?' <i class="fa fa-crown text-warning" style="font-size: 10px;"></i>':"";let controlsHtml='\n                <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap">\n                    <div class="adeptus-action-buttons d-flex gap-2">\n                        <button class="btn btn-outline-danger btn-sm adeptus-export-pdf-btn">\n                            <i class="fa fa-file-pdf-o me-1"></i>Export PDF\n                        </button>\n                        <button class="btn btn-outline-secondary btn-sm adeptus-export-csv-btn'.concat(premiumClass,' mr-10">\n                            <i class="fa fa-download me-1"></i>Export CSV').concat(premiumIcon,'\n                        </button>\n                        <button class="btn btn-outline-secondary btn-sm adeptus-export-json-btn').concat(premiumClass,'">\n                            <i class="fa fa-code me-1"></i>Export JSON').concat(premiumIcon,'\n                        </button>\n                    </div>\n                    <div class="adeptus-view-toggle btn-group" role="group">\n                        <button type="button" class="btn btn-sm adeptus-view-toggle-btn').concat("chart"!==report.display_type?" active":"",'" data-type="table"><i class="fa fa-table"></i> Table</button>\n                        <button type="button" class="btn btn-sm adeptus-view-toggle-btn').concat("chart"===report.display_type?" active":"",'" data-type="chart"><i class="fa fa-bar-chart"></i> Chart</button>\n                    </div>\n                </div>\n            ');const isChartActive="chart"===report.display_type;let displayHtml='<div class="adeptus-report-display-area w-100">';displayHtml+='<div class="adeptus-report-view-panel'.concat(isChartActive?" d-none":"",'" data-type="table">'),displayHtml+=this.renderReportData(data),displayHtml+="</div>",displayHtml+='<div class="adeptus-report-view-panel'.concat(isChartActive?"":" d-none",'" data-type="chart">'),displayHtml+=chartControlsHtml,displayHtml+='<div class="adeptus-chart-container" style="position: relative; height: 400px; border: 1px solid #e9ecef; border-radius: 8px; padding: 1rem; background: #fff;">',displayHtml+='<canvas id="reportChart"></canvas>',displayHtml+="</div></div>",displayHtml+="</div>",reportsView.html("\n                ".concat(controlsHtml,'\n                <div class="adeptus-report-display-wrapper w-100 position-relative">\n                    ').concat(displayHtml,"\n                </div>\n            ")),self._currentReportData=data,self._currentReportName=report.description||report.name||"Report",self._currentReportView="chart"===report.display_type?"chart":"table",this._pendingTableId&&"chart"!==report.display_type&&setTimeout((()=>{if(document.getElementById(this._pendingTableId)&&window.VTE)try{this._vteController=window.VTE.enhance("#"+this._pendingTableId,{perPage:10,perPageOptions:[10,25,50,100],labels:{search:"Search",rows:"Rows per page",info:(start,end,total)=>"Showing ".concat(start,"â€“").concat(end," of ").concat(total," entries"),noData:"No matching records found"}})[0]}catch(e){}this._pendingTableId=null}),100),"chart"===report.display_type&&setTimeout((()=>{self.renderReportChartFromSelectors(data,self._currentReportName)}),100),reportsView.find(".adeptus-view-toggle-btn").on("click",(function(){const type=$(this).data("type");reportsView.find(".adeptus-view-toggle-btn").removeClass("active"),$(this).addClass("active"),self._currentReportView=type,reportsView.find(".adeptus-report-view-panel").addClass("d-none"),reportsView.find('.adeptus-report-view-panel[data-type="'.concat(type,'"]')).removeClass("d-none"),"table"===type&&!self._vteController&&self._pendingTableId&&setTimeout((()=>{if(document.getElementById(self._pendingTableId)&&window.VTE)try{self._vteController=window.VTE.enhance("#"+self._pendingTableId,{perPage:10,perPageOptions:[10,25,50,100],labels:{search:"Search",rows:"Rows per page",info:(start,end,total)=>"Showing ".concat(start,"â€“").concat(end," of ").concat(total," entries"),noData:"No matching records found"}})[0]}catch(e){}}),100),"chart"===type&&setTimeout((()=>{self.renderReportChartFromSelectors(self._currentReportData,self._currentReportName)}),100),type!==report.display_type?0===reportsView.find(".adeptus-save-display-type-btn").length&&(reportsView.find(".adeptus-view-toggle").after('<button class="btn btn-sm btn-outline-primary adeptus-save-display-type-btn ms-2"><i class="fa fa-save"></i> Save View</button>'),reportsView.find(".adeptus-save-display-type-btn").on("click",(function(){self.saveDisplayType(report.slug,type)}))):reportsView.find(".adeptus-save-display-type-btn").remove()})),reportsView.find("#report-chart-type, #report-chart-x-axis, #report-chart-y-axis").on("change",(function(){self.renderReportChartFromSelectors(self._currentReportData,self._currentReportName)})),reportsView.find(".adeptus-export-pdf-btn").on("click",(()=>self.exportReport(report.slug,"pdf"))),reportsView.find(".adeptus-export-csv-btn").on("click",(function(){$(this).hasClass("adeptus-export-premium")?self.showExportUpgradePrompt("csv"):self.exportReport(report.slug,"csv")})),reportsView.find(".adeptus-export-json-btn").on("click",(function(){$(this).hasClass("adeptus-export-premium")?self.showExportUpgradePrompt("json"):self.exportReport(report.slug,"json")}))},linkifyUrls:function(text){if(!text||"string"!=typeof text)return text||"";return String(text).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/(\bhttps?:\/\/[^\s<>"']+)/gi,(function(url){const displayUrl=url.length>50?url.substring(0,47)+"...":url;return'<a href="'.concat(url,'" target="_blank" rel="noopener noreferrer" class="adeptus-report-url-link" title="').concat(url,'">').concat(displayUrl,"</a>")}))},formatCellValue:function(value,header){if(null==value||""===value)return"";const strValue=String(value),headerLower=(header||"").toLowerCase();return headerLower.includes("url")||headerLower.includes("link")||headerLower.includes("profile")||headerLower.includes("href")||strValue.match(/^https?:\/\//i)?this.linkifyUrls(strValue):String(strValue).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")},renderReportData:function(data){if(!data||0===data.length)return'<p class="text-muted">No data available.</p>';const self=this,headers=Object.keys(data[0]),tableId="enhanced-report-table-"+Date.now();let tableHtml='<div class="table-responsive"><table id="'.concat(tableId,'" class="table table-striped table-hover">');return tableHtml+="<thead><tr>",headers.forEach((header=>{const isNumeric=data.every((row=>{const val=row[header];return null==val||""===val||!isNaN(parseFloat(val))})),isDate=!isNumeric&&data.some((row=>{const val=row[header];return val&&!isNaN(Date.parse(val))}));tableHtml+="<th".concat(isNumeric?' data-vte="number"':isDate?' data-vte="date"':"",">").concat(header.replace(/_/g," ").replace(/\b\w/g,(l=>l.toUpperCase())),"</th>")})),tableHtml+="</tr></thead>",tableHtml+="<tbody>",data.forEach((row=>{tableHtml+="<tr>",headers.forEach((header=>{const formattedValue=self.formatCellValue(row[header],header);tableHtml+="<td>".concat(formattedValue,"</td>")})),tableHtml+="</tr>"})),tableHtml+="</tbody></table></div>",this._pendingTableId=tableId,tableHtml},getStatusBadge:function(status){const badgeClass=this.getStatusBadgeClass(status);return'<span class="badge '.concat(badgeClass,'" style="color: white;">').concat(status,"</span>")},getStatusBadgeClass:function(status){switch(status){case"completed":case"ready":return"bg-success";case"processing":return"bg-warning text-dark";case"pending":return"bg-info";case"failed":case"error":return"bg-danger";default:return"bg-secondary"}},executeReport:function(reportSlug){const self=this,reportRow=$('.adeptus-report-row[data-report-slug="'.concat(reportSlug,'"]')),originalContent=reportRow.html();reportRow.html('<td colspan="3" class="text-center"><div class="spinner-border spinner-border-sm text-primary" role="status"><span class="visually-hidden">Executing...</span></div> Executing report...</td>'),this.ajaxWithAuth({url:"".concat(this.backendUrl,"/ai-reports/").concat(reportSlug),method:"GET",success:response=>{const report=response.report,sqlQuery=response.sql||report&&report.sql_query||report&&report.sql;if(!sqlQuery)return reportRow.html(originalContent),void this.showError("Report SQL not found. Please regenerate the report.");response.data&&Array.isArray(response.data)&&response.data.length>0?self.handleExecutionSuccess(reportSlug,report,response.data,reportRow):self.executeReportLocally(sqlQuery,(null==report?void 0:report.params)||{}).then((executionResult=>{if(executionResult.error)return reportRow.html(originalContent),void self.showError("Failed to execute report: "+executionResult.error);self.handleExecutionSuccess(reportSlug,report,executionResult.data,reportRow)})).catch((error=>{reportRow.html(originalContent),self.showError("Failed to execute report: "+error.message)}))},error:(xhr,status,error)=>{reportRow.html(originalContent);let errorMessage="Failed to fetch report";404===xhr.status?errorMessage="Report not found.":403===xhr.status?errorMessage="You do not have permission to view this report.":xhr.responseJSON&&xhr.responseJSON.error?errorMessage=xhr.responseJSON.error:errorMessage+=": "+error,this.showError(errorMessage)}})},handleExecutionSuccess:function(reportSlug,report,data,reportRow){if(Array.isArray(this.cachedReports)){const reportIndex=this.cachedReports.findIndex((r=>r.slug===reportSlug));-1!==reportIndex?this.cachedReports[reportIndex]=Object.assign({},this.cachedReports[reportIndex],report,{data:data}):this.cachedReports.push(Object.assign({},report,{data:data}))}this.currentViewedReport=report,this.currentViewedReportData=data,this.updateReportsView(report,data),$(".adeptus-report-row").removeClass("table-primary"),reportRow&&reportRow.addClass("table-primary"),this.showSuccess("Report executed successfully!")},executeReportLocally:function(sql){let params=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};var self=this;return new Promise(((resolve,reject)=>{self.showLoading(),Ajax.call([{methodname:"report_adeptus_insights_execute_ai_report",args:{sql:sql,params:JSON.stringify(params)}}])[0].done((function(result){self.hideLoading();var response=result;if(response.success){var data=response.data,headers=response.headers;if("string"==typeof data)try{data=JSON.parse(data)}catch(e){data=[]}if("string"==typeof headers)try{headers=JSON.parse(headers)}catch(e){headers=[]}resolve({data:data||[],headers:headers||[],row_count:response.row_count||0,error:null})}else resolve({data:null,headers:[],row_count:0,error:response.message||"Query execution failed"})})).fail((function(error){self.hideLoading();var errorMessage=error.message||"Failed to execute report locally";reject(new Error(errorMessage))}))}))},showExportUpgradePrompt:function(format){const subscriptionUrl="".concat(M.cfg.wwwroot,"/report/adeptus_insights/subscription.php"),formatName={csv:"CSV",excel:"Excel",json:"JSON"}[format]||format.toUpperCase();Swal.fire({title:getString("export_premium_feature","Premium Export Format"),html:'<div style="text-align: center; padding: 20px;">\n                    <div style="font-size: 48px; color: #f39c12; margin-bottom: 15px;">\n                        <i class="fa fa-crown"></i>\n                    </div>\n                    <h3 style="color: #2c3e50; margin-bottom: 15px;">'.concat(getString("export_is_premium",formatName+" Export is a Premium Feature").replace("{$a}",formatName),'</h3>\n                    <p style="color: #7f8c8d; font-size: 16px; line-height: 1.6; margin-bottom: 25px;">\n                        ').concat(getString("export_premium_desc","Export to "+formatName+" format is only available with a paid subscription plan. Upgrade now to unlock all export formats and advanced features.").replace("{$a}",formatName),'\n                    </p>\n                    <div style="background: #ecf0f1; padding: 15px; border-radius: 8px; margin-bottom: 20px;">\n                        <p style="margin: 0; font-size: 14px; color: #34495e;">\n                            <strong>').concat(getString("free_plan_label","Free Plan:"),"</strong> ").concat(getString("free_plan_exports","PDF exports only"),"<br>\n                            <strong>").concat(getString("paid_plans_label","Paid Plans:"),"</strong> ").concat(getString("paid_plan_exports","CSV, Excel, JSON, and PDF exports"),"\n                        </p>\n                    </div>\n                </div>"),showCancelButton:!0,confirmButtonText:'<i class="fa fa-arrow-up"></i> '+getString("upgrade_now","Upgrade Now"),cancelButtonText:'<i class="fa fa-times"></i> '+getString("cancel","Cancel"),confirmButtonColor:"#3498db",cancelButtonColor:"#95a5a6",width:500}).then((result=>{result.isConfirmed&&window.open(subscriptionUrl,"_blank")}))},checkExportEligibility:async function(format){try{var promises=Ajax.call([{methodname:"report_adeptus_insights_check_export_eligibility",args:{format:format}}]),result=await promises[0];return result.data?result.data:result}catch(error){return{success:!1,eligible:!1,message:"Unable to verify export eligibility."}}},captureChartImage:async function(){const self=this;await new Promise((resolve=>setTimeout(resolve,300)));const chartCanvas=document.getElementById("reportChart");if(!chartCanvas)return null;try{const dataUrl=chartCanvas.toDataURL("image/png",.8);if(dataUrl&&dataUrl.length>100&&dataUrl.length<2e6)return dataUrl}catch(e){}try{if(window.html2canvas||await self.loadHtml2Canvas(),window.html2canvas){const dataUrl=(await window.html2canvas(chartCanvas,{backgroundColor:"#ffffff",scale:1.5,useCORS:!0,allowTaint:!0,logging:!1})).toDataURL("image/png",.8);if(dataUrl&&dataUrl.length>100&&dataUrl.length<2e6)return dataUrl}}catch(e){}return null},loadHtml2Canvas:function(){return new Promise(((resolve,reject)=>{if(window.html2canvas)return void resolve();const script=document.createElement("script");script.src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js",script.onload=()=>resolve(),script.onerror=()=>reject(new Error("Failed to load html2canvas")),document.head.appendChild(script)}))},exportReport:async function(reportSlug,format){const self=this;Swal.fire({title:"Exporting as ".concat(format.toUpperCase(),"..."),allowOutsideClick:!1,didOpen:()=>Swal.showLoading()});try{var _self$currentViewedRe,_self$currentViewedRe2;const eligibility=await self.checkExportEligibility(format);if(!eligibility.success||!eligibility.eligible)return Swal.close(),void(self.isFreePlan&&"pdf"!==format?self.showExportUpgradePrompt(format):Swal.fire({icon:"error",title:getString("export_not_available","Export Not Available"),text:eligibility.message||getString("not_eligible_export","You are not eligible to export in this format.")}));let body="reportid=".concat(encodeURIComponent(reportSlug),"&format=").concat(format,"&sesskey=").concat(M.cfg.sesskey);if(body+="&view=".concat(self._currentReportView),self.currentViewedReportData&&Array.isArray(self.currentViewedReportData)){const headers=self.currentViewedReportData.length>0?Object.keys(self.currentViewedReportData[0]):[],reportDataPayload={results:self.currentViewedReportData,headers:headers};body+="&report_data=".concat(encodeURIComponent(JSON.stringify(reportDataPayload)))}if("pdf"===format&&"chart"===self._currentReportView)try{const chartImagePromise=self.captureChartImage(),timeoutPromise=new Promise(((_,reject)=>{setTimeout((()=>reject(new Error("Chart capture timeout"))),1e4)})),chartImage=await Promise.race([chartImagePromise,timeoutPromise]);chartImage&&chartImage.length>100&&(body+="&chart_image=".concat(encodeURIComponent(chartImage)))}catch(e){}const response=await fetch("".concat(M.cfg.wwwroot,"/report/adeptus_insights/download.php"),{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:body}),contentType=response.headers.get("content-type"),contentDisposition=response.headers.get("content-disposition");if(contentType&&contentType.includes("application/json")&&!contentDisposition){const errorData=await response.json();throw new Error(errorData.message||"Export failed")}if(!response.ok)throw new Error("Export failed with status: ".concat(response.status));const sanitizedName=((null===(_self$currentViewedRe=self.currentViewedReport)||void 0===_self$currentViewedRe?void 0:_self$currentViewedRe.description)||(null===(_self$currentViewedRe2=self.currentViewedReport)||void 0===_self$currentViewedRe2?void 0:_self$currentViewedRe2.name)||"report").replace(/[^a-zA-Z0-9\s-]/g,"").replace(/\s+/g,"_").toLowerCase(),dateSuffix=(new Date).toISOString().split("T")[0],blob=await response.blob(),url=window.URL.createObjectURL(blob),link=document.createElement("a");link.href=url,link.download="".concat(sanitizedName,"_").concat(dateSuffix,".").concat(format),document.body.appendChild(link),link.click(),window.URL.revokeObjectURL(url),document.body.removeChild(link),Swal.close(),self.showSuccess("".concat(format.toUpperCase()," file downloaded successfully!")),await self.trackExport(format,reportSlug)}catch(error){Swal.close(),self.showError(error.message||"Failed to export report.")}},trackExport:async function(format,reportName){try{var promises=Ajax.call([{methodname:"report_adeptus_insights_track_export",args:{format:format,report_name:reportName}}]);await promises[0]}catch(error){}},openReportFromLink:function(reportSlug){this.switchToReportsTab(),this.updateReportsHistory(this.cachedReports),$(".adeptus-report-row").removeClass("table-primary");const reportRow=$('.adeptus-report-row[data-report-slug="'.concat(reportSlug,'"]'));reportRow.addClass("table-primary");const cached=this.cachedReports.find((r=>r.slug===reportSlug));cached&&cached.data&&Array.isArray(cached.data)&&cached.data.length>0?this.updateReportsView(cached,cached.data):this.fetchAndDisplayReport(reportSlug,reportRow)},formatTimestamp:function(ts){const date=ts instanceof Date?ts:new Date(ts),now=new Date,pad=n=>n.toString().padStart(2,"0"),time="".concat(pad(date.getHours()),":").concat(pad(date.getMinutes()));if(date.getFullYear()!==now.getFullYear()){const month=date.toLocaleString("default",{month:"long"});return"".concat(date.getDate()," ").concat(month," ").concat(date.getFullYear()," - ").concat(time)}if(date.toDateString()===now.toDateString())return time;const yesterday=new Date(now.getFullYear(),now.getMonth(),now.getDate()-1);if(date.toDateString()===yesterday.toDateString()){const weekday=date.toLocaleString("default",{weekday:"long"});return"".concat(weekday," - ").concat(time)}const month=date.toLocaleString("default",{month:"long"});return"".concat(date.getDate()," ").concat(month," - ").concat(time)},updateChatHistoryBadge:function(chatId){const $item=$('#chat-history-list li.adeptus-chat-history-item[data-chat-id="'.concat(chatId,'"]'));if(!$item.length)return;let $badge=$item.find(".adeptus-report-count");if($badge.length){const current=parseInt($badge.text(),10)||0;$badge.text(current+1)}else{const $newBadge=$('<span class="badge bg-primary d-flex align-items-center adeptus-report-count" style="color: white;"><i class="fa fa-chart-bar me-1"></i>1</span>');$item.append($newBadge)}},saveDisplayType:function(reportSlug,displayType){Swal.fire({title:getString("saving_default_view","Saving default view..."),allowOutsideClick:!1,didOpen:()=>Swal.showLoading()}),this.ajaxWithAuth({url:"".concat(this.backendUrl,"/ai-reports/").concat(reportSlug,"/display-type"),method:"POST",contentType:"application/json",data:JSON.stringify({display_type:displayType}),success:()=>{Swal.fire({icon:"success",title:getString("default_view_saved","Default view saved"),showConfirmButton:!1,timer:1500});const rep=this.cachedReports.find((r=>r.slug===reportSlug));rep&&(rep.display_type=displayType),$(".adeptus-save-display-type-btn").remove()},error:()=>{Swal.fire({icon:"error",title:getString("save_failed","Save failed"),text:getString("could_not_save_view","Could not save default view. Please try again.")})}})},showResendIconOnMessage:function($messageElement,messageText){if(!$messageElement||!$messageElement.length)return;$messageElement.siblings(".adeptus-failed-reload-icon").remove();const $icon=$('\n                    <i class="fa fa-refresh adeptus-failed-reload-icon text-danger"\n                   title="Retry sending this message"\n                       style="cursor:pointer; float:left; margin-right:0.5rem;"></i>\n                ');$messageElement.after($icon),$icon.on("click",(()=>{$icon.remove(),this.resendMessage($messageElement,messageText)}))},showResendIconOnLastUserMessage:function(){const $lastUserMessage=$("#adeptus-chat-container .adeptus-user-message:last");if($lastUserMessage.length){const messageText=$lastUserMessage.find(".adeptus-message-text").text();this.showResendIconOnMessage($lastUserMessage,messageText)}},showCompareDataModal:function(report){const self=this,reportSlug=report.slug;let timeline=[],currentData=null,selectedA=null,selectedB=null,loadingA=!1,loadingB=!1,error=null,displayTypeA="table",displayTypeB="table",compareDataA=null,compareDataB=null,currentDataFetched=!1,nextSection="a";function fetchSnapshotData(snapId,section,cb){"a"===section&&(loadingA=!0),"b"===section&&(loadingB=!0),renderSections(),self.ajaxWithAuth({url:"".concat(this.backendUrl,"/ai-reports/").concat(reportSlug,"/snapshots/").concat(snapId),method:"GET",success:function(res){"a"===section?(compareDataA=res.data,selectedA=snapId,loadingA=!1):(compareDataB=res.data,selectedB=snapId,loadingB=!1),renderSections(),cb&&cb()},error:function(){error="Failed to fetch snapshot data.","a"===section&&(loadingA=!1),"b"===section&&(loadingB=!1),renderSections(),cb&&cb()}})}function getSnapshotColor(snapId){if(!snapId)return{bg:"#f8f9fa",border:"#dee2e6",text:"#6c757d"};const snapIndex=timeline.findIndex((s=>s.id===snapId));if(-1===snapIndex)return{bg:"#f8f9fa",border:"#dee2e6",text:"#6c757d"};const colors=[{bg:"#e3f2fd",border:"#2196f3",text:"#1976d2"},{bg:"#f3e5f5",border:"#9c27b0",text:"#7b1fa2"},{bg:"#e8f5e8",border:"#4caf50",text:"#388e3c"},{bg:"#fff3e0",border:"#ff9800",text:"#f57c00"},{bg:"#fce4ec",border:"#e91e63",text:"#c2185b"},{bg:"#e0f2f1",border:"#009688",text:"#00695c"},{bg:"#f1f8e9",border:"#8bc34a",text:"#689f38"},{bg:"#fff8e1",border:"#ffc107",text:"#ffa000"}];return colors[snapIndex%colors.length]}function getSnapshotNote(snapId){if(!snapId)return"";if("string"==typeof snapId&&"current"===snapId)return"Current Data";const snap=timeline.find((s=>s.id===snapId));return snap&&snap.note?snap.note:""}function renderSections(){if($("#adeptus-compare-section-a").replaceWith(function(){let html="";const colorA=getSnapshotColor(selectedA),noteA=getSnapshotNote(selectedA);return html+='<div class="w-100 adeptus-droppable-snapshot adeptus-compare-section" id="adeptus-compare-section-a" data-drop-target="a" style="border: 2px solid '.concat(colorA.border,"; border-radius: 8px; padding: 12px; background-color: ").concat(colorA.bg,'; height: 100%; min-height: 300px; position:relative;">\n                    <div class="d-flex justify-content-between align-items-center mb-2">\n                        <span class="fw-bold" style="color: ').concat(colorA.text,';">Snapshot A').concat(noteA?": "+noteA:"",'</span>\n                        <div class="btn-group adeptus-display-type-switcher-a" role="group" aria-label="Display type switcher">\n                            <button class="btn btn-icon btn-sm').concat("table"===displayTypeA?" active":"",'" data-type="table" data-side="a" tabindex="0" aria-label="Table view" title="Table view"><i class="fa fa-table"></i></button>\n                            <button class="btn btn-icon btn-sm').concat("chart"===displayTypeA?" active":"",'" data-type="chart" data-side="a" tabindex="0" aria-label="Chart view" title="Chart view"><i class="fa fa-bar-chart"></i></button>\n                            <button class="btn btn-icon btn-sm').concat("graph"===displayTypeA?" active":"",'" data-type="graph" data-side="a" tabindex="0" aria-label="Graph view" title="Graph view"><i class="fa fa-line-chart"></i></button>\n                            </div>\n                        </div>'),loadingA?html+='<div class="w-100 d-flex justify-content-center align-items-center" style="min-height:200px"><div class="spinner-border text-primary" role="status"></div></div>':compareDataA?(html+='<div class="adeptus-comparison-fade'.concat(displayTypeA?" adeptus-comparison-fade-in":"",'" style="animation:fadeIn .3s; overflow-x: auto; max-height: calc(100% - 50px);">'),"table"===displayTypeA?html+=self.renderDiffTable(compareDataA,compareDataB):"chart"===displayTypeA?html+='<div class="adeptus-chart-container" style="min-height:260px;" tabindex="0" aria-label="Bar chart" role="region"><canvas id="compareChartA"></canvas></div>':"graph"===displayTypeA&&(html+='<div class="adeptus-chart-container" style="min-height:260px;" tabindex="0" aria-label="Line graph" role="region"><canvas id="compareGraphA"></canvas></div>'),html+="</div>"):html+='<div class="text-muted small text-center" style="min-height:200px;">No snapshot selected for A</div>',html+="</div>",html}()),$("#adeptus-compare-section-b").replaceWith(function(){let html="";const colorB=getSnapshotColor(selectedB),noteB=getSnapshotNote(selectedB);return html+='<div class="w-100 adeptus-droppable-snapshot adeptus-compare-section" id="adeptus-compare-section-b" data-drop-target="b" style="border: 2px solid '.concat(colorB.border,"; border-radius: 8px; padding: 12px; background-color: ").concat(colorB.bg,'; height: 100%; min-height: 300px; position:relative;">\n                    <div class="d-flex justify-content-between align-items-center mb-2">\n                        <span class="fw-bold" style="color: ').concat(colorB.text,';">Snapshot B').concat(noteB?": "+noteB:"",'</span>\n                        <div class="btn-group adeptus-display-type-switcher-b" role="group" aria-label="Display type switcher B">\n                            <button class="btn btn-icon btn-sm').concat("table"===displayTypeB?" active":"",'" data-type="table" data-side="b" tabindex="0" aria-label="Table view for B" title="Table view"><i class="fa fa-table"></i></button>\n                            <button class="btn btn-icon btn-sm').concat("chart"===displayTypeB?" active":"",'" data-type="chart" data-side="b" tabindex="0" aria-label="Chart view for B" title="Chart view"><i class="fa fa-bar-chart"></i></button>\n                            <button class="btn btn-icon btn-sm').concat("graph"===displayTypeB?" active":"",'" data-type="graph" data-side="b" tabindex="0" aria-label="Graph view for B" title="Graph view"><i class="fa fa-line-chart"></i></button>\n                        </div>\n                    </div>'),loadingB?html+='<div class="w-100 d-flex justify-content-center align-items-center" style="min-height:200px"><div class="spinner-border text-primary" role="status"></div></div>':compareDataB?(html+='<div class="adeptus-comparison-fade'.concat(displayTypeB?" adeptus-comparison-fade-in":"",'" style="animation:fadeIn .3s; overflow-x: auto; max-height: calc(100% - 50px);">'),"table"===displayTypeB?html+=self.renderDiffTable(compareDataB,compareDataA):"chart"===displayTypeB?html+='<div class="adeptus-chart-container" style="min-height:260px;" tabindex="0" aria-label="Bar chart for B" role="region"><canvas id="compareChartB"></canvas></div>':"graph"===displayTypeB&&(html+='<div class="adeptus-chart-container" style="min-height:260px;" tabindex="0" aria-label="Line graph for B" role="region"><canvas id="compareGraphB"></canvas></div>'),html+="</div>"):html+='<div class="text-muted small text-center" style="min-height:200px;">No snapshot selected for B</div>',html+="</div>",html}()),"chart"===displayTypeA&&Array.isArray(compareDataA)&&compareDataA.length>0){const ctxA=document.getElementById("compareChartA");if(ctxA){const headers=Object.keys(compareDataA[0]);let labelKey=headers.find((h=>"string"==typeof compareDataA[0][h]))||headers[0],valueKey=headers.find((h=>"number"==typeof compareDataA[0][h]))||headers[1];const labels=compareDataA.map((r=>r[labelKey])),values=compareDataA.map((r=>r[valueKey]));window.compareChartAInstance&&window.compareChartAInstance.destroy(),window.compareChartAInstance=new Chart(ctxA.getContext("2d"),{type:"bar",data:{labels:labels,datasets:[{label:valueKey,data:values,backgroundColor:"rgba(0,123,255,0.5)",borderColor:"rgba(0,123,255,1)",borderWidth:1}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1}}}})}}if("graph"===displayTypeA&&Array.isArray(compareDataA)&&compareDataA.length>0){const ctxA=document.getElementById("compareGraphA");if(ctxA){const headers=Object.keys(compareDataA[0]);let labelKey=headers.find((h=>"string"==typeof compareDataA[0][h]))||headers[0],valueKey=headers.find((h=>"number"==typeof compareDataA[0][h]))||headers[1];const labels=compareDataA.map(((r,i)=>r[labelKey]||i+1)),values=compareDataA.map((r=>r[valueKey]));window.compareGraphAInstance&&window.compareGraphAInstance.destroy(),window.compareGraphAInstance=new Chart(ctxA.getContext("2d"),{type:"line",data:{labels:labels,datasets:[{label:valueKey,data:values,backgroundColor:"rgba(40,167,69,0.5)",borderColor:"rgba(40,167,69,1)",borderWidth:2,fill:!1}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1}}}})}}if("chart"===displayTypeB&&Array.isArray(compareDataB)&&compareDataB.length>0){const ctxB=document.getElementById("compareChartB");if(ctxB){const headers=Object.keys(compareDataB[0]);let labelKey=headers.find((h=>"string"==typeof compareDataB[0][h]))||headers[0],valueKey=headers.find((h=>"number"==typeof compareDataB[0][h]))||headers[1];const labels=compareDataB.map((r=>r[labelKey])),values=compareDataB.map((r=>r[valueKey]));window.compareChartBInstance&&window.compareChartBInstance.destroy(),window.compareChartBInstance=new Chart(ctxB.getContext("2d"),{type:"bar",data:{labels:labels,datasets:[{label:valueKey,data:values,backgroundColor:"rgba(0,123,255,0.5)",borderColor:"rgba(0,123,255,1)",borderWidth:1}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1}}}})}}if("graph"===displayTypeB&&Array.isArray(compareDataB)&&compareDataB.length>0){const ctxB=document.getElementById("compareGraphB");if(ctxB){const headers=Object.keys(compareDataB[0]);let labelKey=headers.find((h=>"string"==typeof compareDataB[0][h]))||headers[0],valueKey=headers.find((h=>"number"==typeof compareDataB[0][h]))||headers[1];const labels=compareDataB.map(((r,i)=>r[labelKey]||i+1)),values=compareDataB.map((r=>r[valueKey]));window.compareGraphBInstance&&window.compareGraphBInstance.destroy(),window.compareGraphBInstance=new Chart(ctxB.getContext("2d"),{type:"line",data:{labels:labels,datasets:[{label:valueKey,data:values,backgroundColor:"rgba(40,167,69,0.5)",borderColor:"rgba(40,167,69,1)",borderWidth:2,fill:!1}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1}}}})}}}function renderModal(){Swal.update({html:"<div class='d-flex flex-row' style='height:70vh;min-height:500px;max-height:80vh;'>\n                        <div id='adeptus-timeline-sidebar-modal'></div>\n                        <div class='flex-fill px-3' style='overflow:auto;max-width:calc(100% - 220px);'>\n                            <div class='d-flex flex-row gap-3 w-100 h-100'>\n                                <div class='flex-fill' id='adeptus-compare-section-a'></div>\n                                <div class='flex-fill' id='adeptus-compare-section-b'></div>\n                            </div>\n                        </div>\n                    </div>"}),$("#adeptus-timeline-sidebar-modal").html(function(selectedAId,selectedBId){let html='<div class="adeptus-timeline-sidebar" style="width:220px;max-width:220px;overflow-y:auto;height:100%;background:#f8f9fa;border-right:1.5px solid #e0e0e0;padding:0.5rem 0.25rem;">';return html+='<div class="d-flex flex-column gap-2 mb-3">',html+='<button class="btn btn-outline-primary btn-sm w-100 mb-1 adeptus-fetch-current-btn" title="Fetch current data from database" aria-label="Fetch current data"><i class="fa fa-sync"></i> Fetch Current Data</button>',currentDataFetched&&"current"===selectedA&&(html+='<div class="mb-2">\n                        <input type="text" id="add-timeline-note" class="form-control form-control-sm mb-1" placeholder="Enter snapshot name (required)" required aria-label="Snapshot name">\n                        <div class="invalid-feedback" style="display:none;">Snapshot name is required.</div>\n                        <button class="btn btn-outline-success btn-sm w-100 adeptus-add-timeline-btn" id="adeptus-add-timeline-btn" title="Create snapshot from current data" aria-label="Create snapshot from current data" disabled><span class="adeptus-btn-label"><i class="fa fa-plus"></i> Create Snapshot From Current Data</span><span class="spinner-border spinner-border-sm ms-2" id="snapshot-loading" style="display:none;" role="status" aria-hidden="true"></span></button>\n                    </div>'),html+='<div class="small text-muted text-center px-2 py-1 mb-2" style="border: 1px dashed #dee2e6; border-radius: 4px;">Click or <b>drag</b> snapshots to select for comparison. Each snapshot gets a unique color. You can also drag and drop from the side menu into the snapshot viewer.</div>',html+="</div>",html+='<div class="adeptus-timeline-list">',0===timeline.length?html+=error?'<div class="text-danger small text-center py-2">Error: '.concat(error,"</div>"):'<div class="text-muted small text-center py-2">No timeline snapshots yet. [DEBUG: Timeline is empty]</div>':timeline.forEach(((snap,index)=>{const colors=[{bg:"#e3f2fd",border:"#2196f3",text:"#1976d2"},{bg:"#f3e5f5",border:"#9c27b0",text:"#7b1fa2"},{bg:"#e8f5e8",border:"#4caf50",text:"#388e3c"},{bg:"#fff3e0",border:"#ff9800",text:"#f57c00"},{bg:"#fce4ec",border:"#e91e63",text:"#c2185b"},{bg:"#e0f2f1",border:"#009688",text:"#00695c"},{bg:"#f1f8e9",border:"#8bc34a",text:"#689f38"},{bg:"#fff8e1",border:"#ffc107",text:"#ffa000"}],color=colors[index%colors.length],isSelected=selectedAId===snap.id||selectedBId===snap.id,selectedStyle=isSelected?"background-color: ".concat(color.bg,"; border-color: ").concat(color.border,"; border-width: 2px;"):"background-color: #fff; border-color: #dee2e6; border-width: 1px;",isCurrent=snap.is_current_version?'<span class="badge bg-primary ms-1">Current</span>':"",dragDisabled=isSelected?'draggable="false"':'draggable="true"',dragTitle=isSelected?"This snapshot is currently selected":"Drag to assign to Snapshot A or B",dragText=isSelected?'<span class="text-muted small">(Selected)</span>':"";html+='<div class="adeptus-timeline-item p-2 mb-1 rounded border '.concat(isSelected?"adeptus-drag-disabled":"adeptus-draggable-snapshot",'"\n                                      style="cursor:pointer; animation:fadeIn .3s; ').concat(selectedStyle,'"\n                                      data-snap-id="').concat(snap.id,'"\n                                      data-color-bg="').concat(color.bg,'"\n                                      data-color-border="').concat(color.border,'"\n                                      data-color-text="').concat(color.text,'"\n                                      tabindex="0"\n                                      aria-label="Snapshot from ').concat(self.formatTimestamp(snap.created_at)).concat(snap.is_current_version?" (current)":"",'"\n                                      ').concat(dragDisabled,'\n                                      title="').concat(dragTitle,'"\n                                      >\n                            <div class="d-flex justify-content-between align-items-center">\n                                <span class="fw-bold small">').concat(self.formatTimestamp(snap.created_at),"</span>\n                                ").concat(isCurrent,'\n                            </div>\n                            <div class="small text-muted">').concat(snap.note?snap.note:""," ").concat(dragText,'</div>\n                            <div class="d-flex gap-1 mt-1">\n                                <button class="btn btn-outline-secondary btn-xs btn-sm adeptus-set-current-btn" data-snap-id="').concat(snap.id,'" title="Set as current version" aria-label="Set as current"><i class="fa fa-check"></i></button>\n                            </div>\n                        </div>')})),html+="</div></div>",html}(selectedA,selectedB)),renderSections(),$(".adeptus-fetch-current-btn").off("click").on("click",(function(){!function(section,cb){"a"===section&&(loadingA=!0),"b"===section&&(loadingB=!0),renderSections(),self.ajaxWithAuth({url:"".concat(this.backendUrl,"/ai-reports/").concat(reportSlug,"/data/current"),method:"GET",success:function(res){currentData=res.data||[],"a"===section?(compareDataA=currentData,selectedA="current",loadingA=!1):(compareDataB=currentData,selectedB="current",loadingB=!1),currentDataFetched=!0,renderSections(),cb&&cb()},error:function(){error="Failed to fetch current data.","a"===section&&(loadingA=!1),"b"===section&&(loadingB=!1),renderSections(),cb&&cb()}})}(nextSection)})),$(".adeptus-timeline-item").off("click").on("click",(function(){const snapId=$(this).data("snap-id");"a"===nextSection?fetchSnapshotData(snapId,"a",(()=>{nextSection="b"})):fetchSnapshotData(snapId,"b",(()=>{nextSection="a"}))})),$(".adeptus-display-type-switcher-a .btn-icon").off("click").on("click",(function(){displayTypeA=$(this).data("type"),renderSections()})),$(".adeptus-display-type-switcher-b .btn-icon").off("click").on("click",(function(){displayTypeB=$(this).data("type"),renderSections()})),$(".adeptus-draggable-snapshot").attr("draggable",!0).off("dragstart").on("dragstart",(function(e){e.originalEvent.dataTransfer.setData("text/plain",$(this).data("snap-id")),$(this).addClass("adeptus-dragging")})),$(".adeptus-draggable-snapshot").off("dragend").on("dragend",(function(){$(this).removeClass("adeptus-dragging")})),$(".adeptus-compare-section").off("dragover").on("dragover",(function(e){e.preventDefault(),$(this).addClass("adeptus-drag-over-section")})),$(".adeptus-compare-section").off("dragleave").on("dragleave",(function(){$(this).removeClass("adeptus-drag-over-section")})),$(".adeptus-compare-section").off("drop").on("drop",(function(e){e.preventDefault(),$(this).removeClass("adeptus-drag-over-section");const snapId=e.originalEvent.dataTransfer.getData("text/plain"),target=$(this).data("drop-target");fetchSnapshotData(snapId,target,(()=>{nextSection="a"===target?"b":"a"}))})),0===$("#adeptus-compare-section-highlight-style").length&&$("head").append('<style id="adeptus-compare-section-highlight-style">.adeptus-drag-over-section { box-shadow: 0 0 0 4px #90caf9 !important; border-color: #1976d2 !important; }</style>')}Swal.fire({title:"<span class='fw-bold'>".concat(getString("compare_report_data","Compare Report Data"),"</span>"),html:"<div class='d-flex flex-row' style='height:60vh;min-height:400px;max-height:70vh;'>\n                    <div id='adeptus-timeline-sidebar-modal'></div>\n                    <div class='flex-fill px-3' style='overflow:auto;max-width:calc(100% - 220px);'>\n                        <div class='d-flex flex-row gap-3 w-100 h-100'>\n                            <div class='flex-fill' id='adeptus-compare-section-a'></div>\n                            <div class='flex-fill' id='adeptus-compare-section-b'></div>\n                        </div>\n                    </div>\n                </div>",width:"90vw",heightAuto:!1,showCancelButton:!0,showConfirmButton:!1,customClass:{popup:"swal2-modal-compare-data"},didOpen:()=>{!function(cb){self.ajaxWithAuth({url:"".concat(this.backendUrl,"/ai-reports/").concat(reportSlug,"/snapshots"),method:"GET",success:function(res){timeline=res.snapshots||[],cb&&cb()},error:function(){error="Failed to load timeline.",cb&&cb()}})}((()=>{var _timeline$find;timeline.length>0?(selectedA=(null===(_timeline$find=timeline.find((s=>s.is_current_version)))||void 0===_timeline$find?void 0:_timeline$find.id)||timeline[0].id,selectedB=timeline.length>1?timeline[1].id:null,selectedA&&selectedB?function(aId,bId,cb){loadingA=!0,loadingB=!0,renderSections(),self.ajaxWithAuth({url:"".concat(this.backendUrl,"/ai-reports/").concat(reportSlug,"/snapshots/").concat(aId,"/compare/").concat(bId),method:"GET",success:function(res){compareDataA=res.a.data,compareDataB=res.b.data,loadingA=!1,loadingB=!1,renderSections(),cb&&cb(res)},error:function(){error="Failed to compare snapshots.",loadingA=!1,loadingB=!1,renderSections(),cb&&cb()}})}(selectedA,selectedB,(()=>{nextSection="a",renderModal()})):selectedA?fetchSnapshotData(selectedA,"a",(()=>{nextSection="b",renderModal()})):renderModal()):renderModal()}))}})},renderDiffTable:function(a,b){if(!Array.isArray(a)||0===a.length)return'<div class="text-muted small">No data</div>';const headers=Object.keys(a[0]);let html='<div class="table-responsive"><table class="table table-striped table-hover table-sm">';return html+="<thead><tr>",headers.forEach((h=>{html+="<th>".concat(h,"</th>")})),html+="</tr></thead><tbody>",a.forEach(((row,i)=>{html+="<tr>",headers.forEach((h=>{var _row$h;let diff=!1;b&&Array.isArray(b)&&b[i]&&b[i][h]!==row[h]&&(diff=!0),html+="<td".concat(diff?' style="background:#ffe5e5;"':"",">").concat(null!==(_row$h=row[h])&&void 0!==_row$h?_row$h:"","</td>")})),html+="</tr>"})),html+="</tbody></table></div>",html},testMCQ:function(){this.addMessage("I found an existing wizard report that might meet your needs. However, it doesn't include all the fields you requested.\n\nWhat would you like to do?\n\nA. Use the existing wizard report as-is\nB. Generate a new custom SQL report with all fields\nC. Use the wizard report and create a separate supplementary report\nD. Cancel and try a different approach","ai")},testMCQNumbered:function(){this.addMessage("Please select your preferred report format:\n\n1. PDF Export with charts and graphs\n2. Excel spreadsheet with raw data\n3. CSV file for data analysis\n4. Interactive web dashboard\n5. Email summary report","ai")}};return window.assistant=assistant,assistant}));

//# sourceMappingURL=assistant.min.js.map