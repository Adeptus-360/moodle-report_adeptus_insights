/**
 * AI Assistant interface for Adeptus Insights plugin.
 *
 * Handles the AI chat interface, message sending/receiving, report generation,
 * chart rendering, and conversation management for the insights assistant.
 *
 * @module     report_adeptus_insights/assistant
 * @copyright  2026 Adeptus 360 <info@adeptus360.com>
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define(["jquery","core/ajax","core/notification","core/chartjs","core/templates","core/str","report_adeptus_insights/auth_utils"],function(e,t,a,s,r,n,i){var o=window.Swal,d={},l=function(e,t){return d[e]||t||e},c={currentChatId:0,currentMCQ:null,isSending:!1,mcqQueue:[],reportsDataTable:null,cachedReports:[],cachedCategories:[],_initCalled:!1,isCreditLimitExceeded:!1,backendUrl:"https://backend.adeptus360.com/api/v1",isFreePlan:!0,_currentReportView:"table",_currentReportData:null,_currentReportName:"",currentViewedReport:null,currentViewedReportData:null,isReportLimitReached:!1,reportsUsed:0,reportsLimit:0,reportsRemaining:0,reportEligibilityChecked:!1,init:function(t){var a,s,r,i=this;if(t&&"object"==typeof t&&!Array.isArray(t)?(a=!1!==t.authenticated,s=!1!==t.isFreePlan,r=t.backendUrl||this.backendUrl):(a=!1!==t,s=!1!==arguments[1],r=this.backendUrl),this.isFreePlan=s,this.authenticated=a,r&&(this.backendUrl=r),!this._initCalled){this._initCalled=!0,this.currentChatId=0;var o=function(){return e("#adeptus-assistant-container")};o().hide(),this.initializeLoaderStyles(),n.get_strings([{key:"js_generating_report",component:"report_adeptus_insights"},{key:"js_token_limit_reached",component:"report_adeptus_insights"},{key:"js_token_limit_message",component:"report_adeptus_insights"},{key:"js_view_usage",component:"report_adeptus_insights"},{key:"js_report_limit_reached",component:"report_adeptus_insights"},{key:"js_report_limit_message",component:"report_adeptus_insights"},{key:"js_view_reports",component:"report_adeptus_insights"},{key:"js_upgrade_your_plan",component:"report_adeptus_insights"},{key:"js_upgrade_plan_message",component:"report_adeptus_insights"},{key:"js_ai_service_busy",component:"report_adeptus_insights"},{key:"js_ai_service_busy_message",component:"report_adeptus_insights"},{key:"js_try_again",component:"report_adeptus_insights"},{key:"js_loading_usage_data",component:"report_adeptus_insights"},{key:"js_fetching_usage_info",component:"report_adeptus_insights"},{key:"js_applying_filters",component:"report_adeptus_insights"},{key:"js_report_chart",component:"report_adeptus_insights"},{key:"js_please_enter_message",component:"report_adeptus_insights"},{key:"js_oops",component:"report_adeptus_insights"},{key:"js_save_your_report",component:"report_adeptus_insights"},{key:"js_report_name_label",component:"report_adeptus_insights"},{key:"js_enter_report_name",component:"report_adeptus_insights"},{key:"js_category_label",component:"report_adeptus_insights"},{key:"js_select_category",component:"report_adeptus_insights"},{key:"js_save_report",component:"report_adeptus_insights"},{key:"js_report_not_found",component:"report_adeptus_insights"},{key:"js_export_not_available",component:"report_adeptus_insights"},{key:"js_not_eligible_export",component:"report_adeptus_insights"},{key:"js_saving_default_view",component:"report_adeptus_insights"},{key:"js_default_view_saved",component:"report_adeptus_insights"},{key:"js_save_failed",component:"report_adeptus_insights"},{key:"js_could_not_save_view",component:"report_adeptus_insights"},{key:"js_unable_verify_eligibility",component:"report_adeptus_insights"},{key:"js_unable_verify_export",component:"report_adeptus_insights"},{key:"js_authentication_required",component:"report_adeptus_insights"},{key:"js_auth_required_message",component:"report_adeptus_insights"},{key:"js_refresh_page",component:"report_adeptus_insights"},{key:"js_delete_chat",component:"report_adeptus_insights"},{key:"js_delete_chat_confirm",component:"report_adeptus_insights"},{key:"js_yes_delete",component:"report_adeptus_insights"},{key:"js_chat_deleted",component:"report_adeptus_insights"},{key:"js_error_deleting_chat",component:"report_adeptus_insights"},{key:"js_new_chat",component:"report_adeptus_insights"},{key:"js_no_chats_yet",component:"report_adeptus_insights"},{key:"js_start_conversation",component:"report_adeptus_insights"},{key:"js_error_loading_chats",component:"report_adeptus_insights"},{key:"js_report_saved",component:"report_adeptus_insights"},{key:"js_report_saved_message",component:"report_adeptus_insights"},{key:"js_error_saving_report",component:"report_adeptus_insights"},{key:"js_delete_report",component:"report_adeptus_insights"},{key:"js_delete_report_confirm",component:"report_adeptus_insights"},{key:"js_report_deleted",component:"report_adeptus_insights"},{key:"js_error_deleting_report",component:"report_adeptus_insights"},{key:"js_no_reports",component:"report_adeptus_insights"},{key:"js_generate_reports_message",component:"report_adeptus_insights"},{key:"js_error_loading_reports",component:"report_adeptus_insights"},{key:"js_no_data_available",component:"report_adeptus_insights"},{key:"js_export_success",component:"report_adeptus_insights"},{key:"js_export_error",component:"report_adeptus_insights"},{key:"js_processing",component:"report_adeptus_insights"},{key:"js_please_wait",component:"report_adeptus_insights"},{key:"js_success",component:"report_adeptus_insights"},{key:"js_error",component:"report_adeptus_insights"},{key:"js_warning",component:"report_adeptus_insights"},{key:"js_confirm",component:"report_adeptus_insights"},{key:"js_yes",component:"report_adeptus_insights"},{key:"js_no",component:"report_adeptus_insights"},{key:"js_deleted",component:"report_adeptus_insights"},{key:"js_saved",component:"report_adeptus_insights"},{key:"js_untitled_report",component:"report_adeptus_insights"},{key:"js_general_category",component:"report_adeptus_insights"},{key:"loading",component:"report_adeptus_insights"},{key:"close",component:"report_adeptus_insights"},{key:"cancel",component:"report_adeptus_insights"},{key:"export_premium_feature",component:"report_adeptus_insights"},{key:"export_premium_description",component:"report_adeptus_insights"},{key:"export_free_plan_info",component:"report_adeptus_insights"},{key:"export_paid_plan_info",component:"report_adeptus_insights"},{key:"upgrade_now",component:"report_adeptus_insights"},{key:"js_view_plans",component:"report_adeptus_insights"},{key:"js_monthly_allowance_used",component:"report_adeptus_insights"},{key:"js_tokens_reset_monthly",component:"report_adeptus_insights"},{key:"js_used_of_reports",component:"report_adeptus_insights"},{key:"js_delete_reports_or_upgrade",component:"report_adeptus_insights"},{key:"js_unlock_features",component:"report_adeptus_insights"},{key:"js_current_usage",component:"report_adeptus_insights"},{key:"js_unlimited",component:"report_adeptus_insights"},{key:"js_reports",component:"report_adeptus_insights"},{key:"js_report_limit_reached_banner",component:"report_adeptus_insights"},{key:"js_manage_reports",component:"report_adeptus_insights"},{key:"js_upgrade_plan",component:"report_adeptus_insights"},{key:"js_ask_moodle_data",component:"report_adeptus_insights"},{key:"js_report_limit_placeholder",component:"report_adeptus_insights"},{key:"js_export_premium_feature",component:"report_adeptus_insights"},{key:"js_export_premium_description",component:"report_adeptus_insights"},{key:"js_free_plan_exports",component:"report_adeptus_insights"},{key:"js_paid_plan_exports",component:"report_adeptus_insights"},{key:"js_free_plan_label",component:"report_adeptus_insights"},{key:"js_paid_plans_label",component:"report_adeptus_insights"},{key:"js_no_reports_generated",component:"report_adeptus_insights"},{key:"js_ask_ai_create_reports",component:"report_adeptus_insights"},{key:"js_compare_report_data",component:"report_adeptus_insights"},{key:"js_failed_load_usage",component:"report_adeptus_insights"},{key:"js_failed_load_filtered",component:"report_adeptus_insights"}]).then(function(e){return d={generating_report:e[0],token_limit_reached:e[1],token_limit_message:e[2],view_usage:e[3],report_limit_reached:e[4],report_limit_message:e[5],view_reports:e[6],upgrade_your_plan:e[7],upgrade_plan_message:e[8],ai_service_busy:e[9],ai_service_busy_message:e[10],try_again:e[11],loading_usage_data:e[12],fetching_usage_info:e[13],applying_filters:e[14],report_chart:e[15],please_enter_message:e[16],oops:e[17],save_your_report:e[18],report_name_label:e[19],enter_report_name:e[20],category_label:e[21],select_category:e[22],save_report:e[23],report_not_found:e[24],export_not_available:e[25],not_eligible_export:e[26],saving_default_view:e[27],default_view_saved:e[28],save_failed:e[29],could_not_save_view:e[30],unable_verify_eligibility:e[31],unable_verify_export:e[32],authentication_required:e[33],auth_required_message:e[34],refresh_page:e[35],delete_chat:e[36],delete_chat_confirm:e[37],yes_delete:e[38],chat_deleted:e[39],error_deleting_chat:e[40],new_chat:e[41],no_chats_yet:e[42],start_conversation:e[43],error_loading_chats:e[44],report_saved:e[45],report_saved_message:e[46],error_saving_report:e[47],delete_report:e[48],delete_report_confirm:e[49],report_deleted:e[50],error_deleting_report:e[51],no_reports:e[52],generate_reports_message:e[53],error_loading_reports:e[54],no_data_available:e[55],export_success:e[56],export_error:e[57],processing:e[58],please_wait:e[59],success:e[60],error:e[61],warning:e[62],confirm:e[63],yes:e[64],no:e[65],deleted:e[66],saved:e[67],untitled_report:e[68],general_category:e[69],loading:e[70],close:e[71],cancel:e[72],export_premium_feature:e[73],export_premium_description:e[74],export_free_plan_info:e[75],export_paid_plan_info:e[76],upgrade_now:e[77],view_plans:e[78],monthly_allowance_used:e[79],tokens_reset_monthly:e[80],used_of_reports:e[81],delete_reports_or_upgrade:e[82],unlock_features:e[83],current_usage:e[84],unlimited:e[85],reports:e[86],report_limit_reached_banner:e[87],manage_reports:e[88],upgrade_plan:e[89],ask_moodle_data:e[90],report_limit_placeholder:e[91],export_is_premium:e[92],export_premium_desc:e[93],free_plan_exports:e[94],paid_plan_exports:e[95],free_plan_label:e[96],paid_plans_label:e[97],no_reports_generated:e[98],ask_ai_create_reports:e[99],compare_report_data:e[100],failed_load_usage:e[101],failed_load_filtered:e[102]}}).then(function(){i._initAfterStrings(o)}).catch(function(){i._initAfterStrings(o)})}},_initAfterStrings:function(e){var t=this;try{if(i.isAuthenticated()){var a=i.getAuthStatus(),s=a&&a.user&&a.user.name||"User";this.setUserName(s),this.updateSubscriptionInfo(),this.setupEventListeners(),this.loadChatHistory(),this.loadReportsHistory(),this.loadCategories(),this.checkReportEligibility(),e().fadeIn(200)}else i.refreshAuthStatus(),setTimeout(function(){if(i.isAuthenticated()){var a=i.getAuthStatus(),s=a&&a.user&&a.user.name||"User";t.setUserName(s),t.updateSubscriptionInfo(),t.setupEventListeners(),t.loadChatHistory(),t.loadReportsHistory(),t.loadCategories(),t.checkReportEligibility(),e().fadeIn(200)}else t.showAuthenticationError()},500)}catch(t){this.setupEventListeners(),this.checkReportEligibility(),e().fadeIn(200)}},initializeLoaderStyles:function(){if(0===e("#ai-loader-styles").length){e("head").append('<style id="ai-loader-styles">.adeptus-ai-thinking-loader-wrapper {animation: fadeInLoader 0.3s ease-out forwards;}.adeptus-ai-thinking-loader {opacity: 1 !important;}@keyframes bounce-loader {0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }40% { transform: scale(1.2); opacity: 1; }}@keyframes fadeInLoader {from { opacity: 0; transform: translateY(10px); }to { opacity: 1; transform: translateY(0); }}@keyframes pulse-glow-loader {0% { box-shadow: 0 0 0 0 rgba(14, 165, 233, 0.4); }70% { box-shadow: 0 0 0 8px rgba(14, 165, 233, 0); }100% { box-shadow: 0 0 0 0 rgba(14, 165, 233, 0); }}</style>')}},showAuthenticationError:function(){var t=e("#adeptus-assistant-container"),a=l("authentication_required","Authentication Required"),s=l("auth_required_message","You need to be authenticated to use the AI Assistant. Please contact your administrator."),r=l("refresh_page","Refresh Page");t.html('<div class="alert alert-danger"><h4>'+a+"</h4><p>"+s+'</p><button class="btn btn-primary" onclick="location.reload()">'+r+"</button></div>").show()},setupEventListeners:function(){var t=this;e("#send-button").on("click",function(){t.sendMessage()}),e("#message-input").on("keydown",function(e){"Enter"!==e.key||e.shiftKey||(e.preventDefault(),t.sendMessage())}),e("#chart-type").on("change",function(){t.updateChart()}),e("#message-input").on("input",function(){this.style.height="auto",this.style.height=this.scrollHeight+"px"}),e("#create-new-chat").on("click",function(){t.createNewChat()})},clearMCQ:function(){this.currentMCQ=null,e("#adeptus-mcq-container").empty().hide(),e("#message-input").prop("disabled",!1),e("#send-button").prop("disabled",!1)},extractMCQFromText:function(e){if(!e||"string"!=typeof e)return null;try{var t=e.match(/```json\s*(\[[\s\S]*?\])\s*```/);if(t){var a=JSON.parse(t[1]);if(Array.isArray(a)&&a.length>0&&"mcq"===a[0].type)return{questions:a,selectedAnswer:null}}var s=e.match(/\{[\s\S]*?\}/g)||[],r=[];if(s.forEach(function(e){try{var t=JSON.parse(e);"mcq"===t.type&&Array.isArray(t.options)&&r.push(t)}catch(e){}}),r.length>0)return{questions:r,selectedAnswer:null}}catch(e){}return null},renderMCQHistory:function(e,t){t=t||null;var a='<div class="adeptus-mcq-history-container" style="display:flex; flex-direction:column; gap:15px;">';return e.forEach(function(e,s){a+='<div class="adeptus-mcq-history-item" style="background:#f8f9fa; padding:15px; border-radius:8px; border:1px solid #dee2e6; box-shadow:0 1px 3px rgba(0,0,0,0.05);"><p style="font-weight:600; margin-bottom:12px; color:#333; font-size:14px;"><i class="fa fa-question-circle" style="color:#007bff; margin-right:8px;"></i>'+e.question+'</p><div class="adeptus-mcq-options" style="margin-left:24px;">',e.options.forEach(function(e){var r="string"==typeof e?e:e.label||e,n=t&&(t===e||t===r||t.indexOf&&-1!==t.indexOf(r));a+='<div class="form-check" style="padding:10px 14px; border-radius:6px; margin-bottom:8px; '+(n?"background:#e3f0ff; border:2px solid #007bff; font-weight:600;":"border:1px solid #ced4da;")+' transition:all 0.2s;"><input class="form-check-input" type="radio" name="mcq-'+s+'" disabled '+(n?"checked":"")+' style="margin-top:0.3em;"><label class="form-check-label" style="color:#555; cursor:not-allowed; margin-left:5px;">'+(n?'<i class="fa fa-check-circle" style="color:#28a745; margin-right:5px;"></i>':"")+r+"</label></div>"}),a+='</div><p style="margin-top:12px; margin-bottom:0; font-size:11px; color:#6c757d; font-style:italic;"><i class="fa fa-info-circle" style="margin-right:4px;"></i>Previous question from chat history</p></div>'}),a+="</div>"},checkAuth:function(){return i.isAuthenticated()?(this.loadChatHistory(),!0):(this.showAuthenticationError(),!1)},handleResponse:function(t){if(t.error){if("credit_limit"===t.error_type||"token_limit"===t.error_type)return void this.handleCreditLimitError(t.message);if("report_limit"===t.error_type)return void this.handleReportLimitError(t.message);this.addMessage(t.message,"error"),this.showResendIconOnLastUserMessage()}else{if("mcq"===t.type){if(t.questions&&t.questions.length>0){const e=t.questions[0],a=`Question: ${e.question}\nOptions: ${e.options.join(", ")}`;this.addMessage(a,"ai",!1,null,null,null,t.credit_info)}return void this.enqueueMCQs(t.questions)}if("sql"===t.type||"report"===t.type){if(t.awaiting_confirmation&&t.report){const e=t.sql||t.report.sql_query||t.report.sql;return!t.execution_required&&t.report_data||!e?void this.showReportConfirmation(t.report,t.report_data||null,t.message,t.credit_info,t.execution_error||null):void this.executeReportLocally(e,t.report.params||{}).then(e=>{this.showReportConfirmation(t.report,e.data||null,t.message,t.credit_info,e.error||null)}).catch(e=>{this.showReportConfirmation(t.report,null,t.message,t.credit_info,e.message||"Failed to execute report locally")})}const a=t.report||t;return this.addMessage(a.description||t.message,"ai",!0,a,null,null,t.credit_info),this.updateChatHistoryBadge(this.currentChatId),this.cachedReports.unshift(a),this.updateReportsHistory(this.cachedReports),this.reportsDataTable&&(this.reportsDataTable.destroy(),this.reportsDataTable=null),setTimeout(()=>{try{const t=document.getElementById("reports-history-table");if(t){const a=t.querySelector("thead"),s=t.querySelector("tbody");if(a&&s&&a.rows.length>0&&a.rows[0].cells.length>0){const t=a.rows[0].cells.length,r=s.rows;let n=0;r.length>0&&(n=r[0].cells.length),t===n&&t>0&&r.length>0&&!r[0].cells[0].textContent.includes("No reports")&&(this.reportsDataTable=new simpleDatatables.DataTable("#reports-history-table",{searchable:!0,fixedHeight:!1,perPage:10,loading:!1}),setTimeout(()=>{e(".datatable-wrapper").removeClass("datatable-loading"),e("#report-history-table-wrapper .datatable-wrapper").removeClass("datatable-loading")},100))}}}catch(e){}},100),void o.fire({title:l("generating_report","Generating Report"),html:`\n                        <div class="text-center">\n                            <div class="spinner-border text-primary mb-3" role="status">\n                            </div>\n                            <p>${l("please_wait","Please wait")}...</p>\n                        </div>\n                    `,showConfirmButton:!1,allowOutsideClick:!1,allowEscapeKey:!1,timer:2e3,timerProgressBar:!0}).then(()=>{this.switchToReportsTab(),this.displayCurrentReport(t.report),this.executeReport(t.report.slug)})}this.addMessage(t.message,"ai",!1,null,null,null,t.credit_info)}t.data&&this.updateReportData(t.data),t.visualizations&&this.updateVisualizations(t.visualizations),t.credit_info&&this.showCreditUsageFeedback(t.credit_info),this.scrollToBottom()},showCreditUsageFeedback:function(t){if(!t)return;const a=e(`\n                <div class="adeptus-credit-usage-notification" style="\n                    position: fixed;\n                    top: 20px;\n                    right: 20px;\n                    background: #28a745;\n                    color: white;\n                    padding: 12px 20px;\n                    border-radius: 6px;\n                    box-shadow: 0 4px 12px rgba(0,0,0,0.15);\n                    z-index: 9999;\n                    font-size: 14px;\n                    font-weight: 500;\n                    opacity: 0;\n                    transform: translateX(100%);\n                    transition: all 0.3s ease;\n                ">\n                    <i class="fa fa-coins me-2"></i>\n                    <span class="adeptus-credit-text">Credits used: ${t.credits_charged||0} (${t.credit_type||"basic"})</span>\n                </div>\n            `);e("body").append(a),setTimeout(()=>{a.css({opacity:"1",transform:"translateX(0)"})},100),setTimeout(()=>{a.css({opacity:"0",transform:"translateX(100%)"}),setTimeout(()=>{a.remove()},300)},3e3),this.updateSubscriptionInfoWithCreditUsage(t)},updateSubscriptionInfoWithCreditUsage:function(e){const t=i.getAuthStatus();if(!t||!t.subscription)return;const a=t.subscription,s=e.credits_charged||0;"premium"===e.credit_type?a.premium_credits_used_this_month=(a.premium_credits_used_this_month||0)+s:a.basic_credits_used_this_month=(a.basic_credits_used_this_month||0)+s,a.ai_credits_used_this_month=(a.ai_credits_used_this_month||0)+s,this.animateCreditCounterUpdate(e.credit_type,s),this.updateSubscriptionInfo()},animateCreditCounterUpdate:function(t){const a=e("premium"===t?".premium-credits-counter":".basic-credits-counter");a.length&&(a.addClass("adeptus-credit-update-highlight"),setTimeout(()=>{a.removeClass("adeptus-credit-update-highlight")},1e3));const s=e(".adeptus-total-credits-counter");s.length&&(s.addClass("adeptus-credit-update-highlight"),setTimeout(()=>{s.removeClass("adeptus-credit-update-highlight")},1e3))},addMessage:function(t,a,s=!1,r=null,n=null,i=null,o=null){"ai"===a&&t&&(t=t.replace(/\nConfidence:\s*\d+%\n?/gi,"\n").replace(/Confidence:\s*\d+%/gi,"").trim());const d=document.getElementById("message-template").content.cloneNode(!0),l=d.querySelector(".adeptus-message");l.classList.add("adeptus-"+a+"-message"),n&&l.setAttribute("data-message-id",n);const c=this.extractMCQFromText(t);if(c&&c.questions.length>0){const e=this.renderMCQHistory(c.questions,c.selectedAnswer);d.querySelector(".adeptus-message-text").innerHTML=e}else if(s&&r){d.querySelector(".adeptus-message-text").innerHTML=`\n                    <a href="javascript:void(0)"\n                       class="adeptus-report-link"\n                       data-report-slug="${r.slug}"\n                       style="color: #007bff; text-decoration: none; cursor:pointer; padding:4px 8px; border:1px solid #dee2e6; border-radius:4px; background:#f8f9fa; display:inline-block; transition:all 0.2s;">\n                        ðŸ“Š ${t}\n                    </a>\n                `;const a=this;setTimeout(()=>{const t=l.querySelector(".adeptus-report-link");t.onclick=function(){a.openReportFromLink(t.getAttribute("data-report-slug"))},t.onmouseenter=function(){e(this).css({"background-color":"#e9ecef","border-color":"#adb5bd",transform:"translateY(-1px)"})},t.onmouseleave=function(){e(this).css({"background-color":"#f8f9fa","border-color":"#dee2e6",transform:"translateY(0)"})}},0)}else if("report-preview"===a||"system-action"===a)d.querySelector(".adeptus-message-text").innerHTML=t,l.classList.add("adeptus-"+a+"-message"),("report-preview"===a||"system-action"===a)&&(l.style.background="transparent",l.style.padding="0",l.style.border="none",l.style.maxWidth="100%");else if("ai"===a&&this.isMultipleChoiceQuestion(t)){const e=this.renderMultipleChoiceOptions(t);d.querySelector(".adeptus-message-text").innerHTML=e}else d.querySelector(".adeptus-message-text").textContent=t;"ai"===a&&o&&this.addCreditInfoToMessage(d,o);return d.querySelector(".adeptus-message-time").textContent=this.formatTimestamp(i||(new Date).toISOString()),e("#adeptus-chat-container").append(d),this.scrollToBottom(),e(l)},addCreditInfoToMessage:function(e,t){const a=e.querySelector(".adeptus-message"),s=document.createElement("div");s.className="adeptus-credit-info-badge",s.style.cssText="\n                display: inline-block;\n                margin-left: 8px;\n                padding: 2px 6px;\n                border-radius: 12px;\n                font-size: 11px;\n                font-weight: 500;\n                text-transform: uppercase;\n                letter-spacing: 0.5px;\n            ","premium"===t.credit_type?(s.style.backgroundColor="#6f42c1",s.style.color="white",s.textContent="Premium"):(s.style.backgroundColor="#28a745",s.style.color="white",s.textContent="Basic"),s.title=`${t.credit_type.toUpperCase()} Response\nTokens: ${t.tokens_used}\nCredits: ${t.credits_charged}\nProvider: ${t.provider}`;a.querySelector(".adeptus-message-text").appendChild(s)},isMultipleChoiceQuestion:function(e){const t=e.match(/^[A-Z][\.\)]\s+.+$/gim),a=e.match(/^[1-9][0-9]*[\.\)]\s+.+$/gm);if(t&&t.length>=2){const e=t.map(e=>e.match(/^([A-Z])/i)[1].toUpperCase()),a=e[0].charCodeAt(0);let s=!0;for(let t=1;t<Math.min(e.length,4);t++)if(e[t].charCodeAt(0)!==a+t){s=!1;break}return s}if(a&&a.length>=2){const e=a.map(e=>parseInt(e.match(/^([0-9]+)/)[1]));let t=!0;for(let a=1;a<Math.min(e.length,4);a++)if(e[a]!==e[0]+a){t=!1;break}return t}return!1},renderMultipleChoiceOptions:function(e){const t=this,a=e.split("\n");let s=[],r=[];a.forEach(e=>{const t=e.trim(),a=t.match(/^([A-Z])[\.\)]\s+(.+)$/i),n=t.match(/^([1-9][0-9]*)[\.\)]\s+(.+)$/);a?r.push({letter:a[1].toUpperCase(),text:a[2].trim(),isLetter:!0}):n?r.push({letter:n[1],text:n[2].trim(),isLetter:!1}):t&&s.push(t)});let n='<div class="adeptus-mcq-question-container">';return n+='<div class="adeptus-mcq-question-text" style="margin-bottom: 15px; white-space: pre-wrap;">',n+=this.escapeHtml(s.join("\n")),n+="</div>",r.length>0&&(n+='<div class="adeptus-mcq-options-grid" style="display: grid; gap: 10px; grid-template-columns: 1fr;">',r.forEach(e=>{const t="adeptus-mcq-option-"+Date.now()+"-"+e.letter;n+=`\n                        <button class="adeptus-mcq-option-button"\n                                data-option="${e.letter}"\n                                id="${t}"\n                                style="\n                                    padding: 12px 16px;\n                                    display: flex;\n                                    align-items: center;\n                                    gap: 12px;\n                                    font-size: 14px;\n                                    line-height: 1.5;\n                                    color: #333;\n                                    min-height: 50px;\n                                ">\n                            <span class="adeptus-mcq-option-letter" style="\n                                background: linear-gradient(135deg, #0ea5e9 0%, #2563eb 100%);\n                                color: white;\n                                width: 32px;\n                                height: 32px;\n                                border-radius: 50%;\n                                display: flex;\n                                align-items: center;\n                                justify-content: center;\n                                font-weight: bold;\n                                flex-shrink: 0;\n                            ">${e.letter}</span>\n                            <span class="adeptus-mcq-option-text" style="flex: 1;">${this.escapeHtml(e.text)}</span>\n                        </button>\n                    `}),n+="</div>"),n+="</div>",setTimeout(()=>{document.querySelector("#adeptus-chat-container").querySelectorAll(".adeptus-mcq-option-button:not([data-handler-attached])").forEach(e=>{e.setAttribute("data-handler-attached","true"),e.addEventListener("click",function(){if(this.disabled)return;const e=this.getAttribute("data-option"),a=r.find(t=>t.letter===e);this.closest(".adeptus-mcq-question-container").querySelectorAll(".adeptus-mcq-option-button").forEach(e=>{e.disabled=!0,e.classList.add("disabled")}),this.classList.add("selected");let s;this.querySelector(".adeptus-mcq-option-letter").innerHTML="âœ“",s=(a.isLetter,`${e}. ${a.text}`),t.sendMessage(s)})})},100),n},escapeHtml:function(e){const t={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"};return e.replace(/[&<>"']/g,e=>t[e])},handleCreditLimitError:function(e,t=null){t&&t.summary&&this.updateSubscriptionDataFromCreditResponse(t),this.isCreditLimitExceeded=!0,this.updateSendMessageandCreateNewChatButton(),this.showPersistentCreditLimitMessage(e),this.addMessage(e,"error"),o.fire({icon:"warning",title:l("token_limit_reached","Token Limit Reached"),html:`\n                    <div class="text-center">\n                        <p>${e}</p>\n                        <p class="text-muted">${l("monthly_allowance_used","Your monthly token allowance has been used up.")}</p>\n                        <p class="text-muted">${l("tokens_reset_monthly","Tokens reset on the 1st of each month.")}</p>\n                    </div>\n                `,showCancelButton:!0,confirmButtonText:l("view_usage","View Usage"),cancelButtonText:l("close","Close"),confirmButtonColor:"#007bff"}).then(e=>{e.isConfirmed&&this.showCreditUsageModal()})},checkReportEligibility:async function(){var e=this;try{var a=t.call([{methodname:"report_adeptus_insights_check_report_eligibility",args:{}}]),s=await a[0],r=s.data?s.data:s;return e.reportsUsed=r.reports_used||0,e.reportsLimit=r.reports_limit||0,e.reportsRemaining=r.reports_remaining||0,e.isReportLimitReached=!r.eligible,e.reportEligibilityChecked=!0,e.updateReportLimitUI(),r}catch(t){return e.isReportLimitReached=!0,e.reportEligibilityChecked=!0,e.updateReportLimitUI(),{success:!1,eligible:!1,message:"Unable to verify eligibility"}}},trackReportCreated:async function(e){var a=this;try{var s=t.call([{methodname:"report_adeptus_insights_track_report_created",args:{report_name:e,is_ai_generated:!0}}]),r=await s[0],n=r.data?r.data:r;return n.success&&!n.tracking_error&&(a.reportsUsed=n.reports_used||a.reportsUsed,a.reportsLimit=n.reports_limit||a.reportsLimit,a.reportsRemaining=n.reports_remaining||a.reportsRemaining,a.isReportLimitReached=a.reportsRemaining<=0&&-1!==a.reportsLimit,a.updateReportLimitUI()),n}catch(e){return{success:!0,tracking_error:!0}}},handleReportLimitError:function(e){this.isReportLimitReached=!0,this.updateReportLimitUI(),this.addMessage(e||l("report_limit_message","You have reached your report limit. Delete existing reports or upgrade your plan."),"error"),o.fire({icon:"warning",title:l("report_limit_reached","Report Limit Reached"),html:`\n                    <div class="text-center">\n                        <p>${e||l("report_limit_reached","You have reached your report limit.")}</p>\n                        <p class="text-muted">${l("used_of_reports","You have used "+this.reportsUsed+" of "+this.reportsLimit+" reports.").replace("{$a->used}",this.reportsUsed).replace("{$a->limit}",this.reportsLimit)}</p>\n                        <p class="text-muted">${l("delete_reports_or_upgrade","Delete existing reports to free up slots or upgrade your plan.")}</p>\n                    </div>\n                `,showCancelButton:!0,confirmButtonText:l("view_reports","View Reports"),cancelButtonText:l("close","Close"),confirmButtonColor:"#007bff"}).then(e=>{e.isConfirmed&&this.switchTab("reports")})},updateReportLimitUI:function(){const t=-1===this.reportsLimit;if(this.isReportLimitReached&&!t){if(e("#send-button").prop("disabled",!0).addClass("disabled"),e("#message-input").prop("disabled",!0).attr("placeholder",l("report_limit_placeholder","Report limit reached. Delete reports or upgrade to continue.")),!e("#report-limit-banner").length){const t=e(`\n                        <div id="report-limit-banner" class="alert alert-warning mb-2" style="margin: 10px; border-radius: 8px;">\n                            <i class="fa-solid fa-exclamation-triangle"></i>\n                            <strong>${l("report_limit_reached_banner","Report limit reached!")}</strong> ${l("used_of_reports","You have used "+this.reportsUsed+" of "+this.reportsLimit+" reports.").replace("{$a->used}",this.reportsUsed).replace("{$a->limit}",this.reportsLimit)}\n                            <a href="#" class="alert-link" onclick="window.assistant.switchTab('reports'); return false;">${l("manage_reports","Manage reports")}</a> or\n                            <a href="#" class="alert-link" onclick="window.assistant.showUpgradePrompt(); return false;">${l("upgrade_plan","upgrade your plan")}</a>.\n                        </div>\n                    `);e(".adeptus-chat-input-area").before(t)}}else this.isCreditLimitExceeded||(e("#send-button").prop("disabled",!1).removeClass("disabled"),e("#message-input").prop("disabled",!1).attr("placeholder",l("ask_moodle_data","Ask me anything about your Moodle data..."))),e("#report-limit-banner").remove()},showUpgradePrompt:function(){const e=-1===this.reportsLimit?l("unlimited","Unlimited"):this.reportsLimit;o.fire({icon:"info",title:l("upgrade_your_plan","Upgrade Your Plan"),html:`\n                    <div class="text-center">\n                        <p>${l("unlock_features","Unlock more reports and features by upgrading your plan.")}</p>\n                        <p class="text-muted">${l("current_usage","Current usage:")} ${this.reportsUsed} / ${e} ${l("reports","reports")}</p>\n                    </div>\n                `,confirmButtonText:l("view_plans","View Plans"),confirmButtonColor:"#007bff"})},updateSubscriptionDataFromCreditResponse:function(e){const t=i.getAuthStatus();if(!t||!t.subscription)return;const a=t.subscription;void 0!==e.tokens_used&&(a.tokens_used=e.tokens_used),void 0!==e.tokens_limit&&(a.tokens_limit=e.tokens_limit),void 0!==e.tokens_remaining&&(a.tokens_remaining=e.tokens_remaining),i.setAuthStatus(t),this.updateSubscriptionInfo()},handleTimeoutError:function(t){this.addMessage(t,"error"),o.fire({icon:"info",title:l("ai_service_busy","AI Service Busy"),html:`\n                    <div class="text-center">\n                        <p>${t}</p>\n                        <p class="text-muted">${l("ai_service_busy_message","The AI service is experiencing high demand. Please try again in a moment.")}</p>\n                    </div>\n                `,showCancelButton:!0,confirmButtonText:l("try_again","Try Again"),cancelButtonText:l("cancel","Cancel"),confirmButtonColor:"#007bff",cancelButtonColor:"#6c757d"}).then(t=>{t.isConfirmed&&e("#message-input").focus()})},showPersistentCreditLimitMessage:function(t){e(".adeptus-credit-limit-alert").remove();const a=`\n                <div class="alert alert-danger adeptus-credit-limit-alert" role="alert" style="margin: 10px 0; border-left: 4px solid #dc3545; background-color: #f8d7da; border-color: #f5c6cb;">\n                    <div class="d-flex align-items-center">\n\n                        <div class="flex-grow-1">\n                            <strong class="text-danger">${l("token_limit_reached","Token Limit Reached")}</strong><br>\n                            <small class="text-muted">${t}</small>\n                        </div>\n                        <div class="ms-3">\n                            <button type="button" class="btn btn-sm btn-outline-danger me-2" onclick="window.assistant.showCreditUsageModal()">\n                                <i class="fas fa-chart-bar me-1"></i> ${l("view_usage","View Usage")}\n                            </button>\n\n                        </div>\n                    </div>\n                </div>\n            `;var s=e(".main-inner");s.length>=2?s.eq(1).before(a):1===s.length?s.eq(0).before(a):e("body").prepend(a)},hidePersistentCreditLimitMessage:function(){e(".adeptus-credit-limit-alert").fadeOut(300,function(){e(this).remove()})},showCreditUsageModal:function(){o.fire({title:l("loading_usage_data","Loading Usage Data..."),text:l("fetching_usage_info","Please wait while we fetch your usage information"),allowOutsideClick:!1,showConfirmButton:!1,willOpen:()=>{o.showLoading()}}),this.ajaxWithAuth({url:this.backendUrl+"/chat/credits/detailed-usage",method:"GET",success:e=>{e.success?this.displayDetailedUsageModal(e.data):o.fire(l("error","Error"),l("failed_load_usage","Failed to load usage information"),"error")},error:()=>{o.fire(l("error","Error"),l("failed_load_usage","Failed to load usage information"),"error")}})},displayDetailedUsageModal:function(e){const t=e.summary,a=e.usage||[],s=e.pagination||{total:0},r=e=>e>=1e6?(e/1e6).toFixed(1)+"M":e>=1e3?(e/1e3).toFixed(1)+"K":e.toString(),n=t.tokens_limit>0&&-1!==t.tokens_remaining?Math.min(100,Math.round(t.total_tokens_used/t.tokens_limit*100)):0,i=-1===t.tokens_remaining?"Unlimited":r(t.tokens_limit),d=`\n                <div class="adeptus-detailed-usage-modal" style="font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">\n                    \x3c!-- Header with close button --\x3e\n                    <div class="adeptus-usage-modal-header mb-3" style="background: linear-gradient(135deg, #0f6cbf 0%, #3a8dd4 100%); padding: 16px 20px; border-radius: 10px; color: white; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">\n                        <div class="d-flex justify-content-between align-items-center">\n                            <h5 class="mb-0" style="color: white; font-weight: 600;">\n                                <i class="fas fa-chart-line me-2"></i> Token Usage Dashboard\n                            </h5>\n                            <button type="button" class="adeptus-usage-modal-close-btn" onclick="Swal.close()" style="background: rgba(255,255,255,0.2); border: none; color: white; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s ease;">\n                                <i class="fas fa-times" style="font-size: 14px;"></i>\n                            </button>\n                        </div>\n                    </div>\n\n                    \x3c!-- Summary Cards with proper spacing --\x3e\n                    <div class="row mb-3 g-2">\n                        <div class="col-md-3">\n                            <div class="card border-0 h-100" style="background: linear-gradient(135deg, #0ea5e9 0%, #2563eb 100%); color: white; border-radius: 12px; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);">\n                                <div class="card-body text-center" style="padding: 16px 12px;">\n                                    <h6 class="card-title mb-2" style="font-weight: 600; opacity: 0.9; font-size: 0.85rem;">Monthly Usage</h6>\n                                    <div class="d-flex align-items-center justify-content-center mb-2">\n                                        <i class="fas fa-chart-pie me-2" style="opacity: 0.8; font-size: 1.2rem;"></i>\n                                        <span style="font-weight: 700; font-size: 1.5rem;">${n}%</span>\n                                    </div>\n                                    <small style="opacity: 0.8; font-size: 0.75rem;">${r(t.total_tokens_used)} / ${i}</small>\n                                </div>\n                            </div>\n                        </div>\n                        <div class="col-md-3">\n                            <div class="card border-0 h-100" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; border-radius: 12px; box-shadow: 0 4px 12px rgba(17, 153, 142, 0.2);">\n                                <div class="card-body text-center" style="padding: 16px 12px;">\n                                    <h6 class="card-title mb-2" style="font-weight: 600; opacity: 0.9; font-size: 0.85rem;">Tokens Used</h6>\n                                    <div class="d-flex align-items-center justify-content-center mb-2">\n                                        <i class="fas fa-code me-2" style="opacity: 0.8; font-size: 1.2rem;"></i>\n                                        <span style="font-weight: 700; font-size: 1.5rem;">${r(t.total_tokens_used)}</span>\n                                    </div>\n                                    <small style="opacity: 0.8; font-size: 0.75rem;">This Billing Period</small>\n                                </div>\n                            </div>\n                        </div>\n                        <div class="col-md-3">\n                            <div class="card border-0 h-100" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; border-radius: 12px; box-shadow: 0 4px 12px rgba(240, 147, 251, 0.2);">\n                                <div class="card-body text-center" style="padding: 16px 12px;">\n                                    <h6 class="card-title mb-2" style="font-weight: 600; opacity: 0.9; font-size: 0.85rem;">Total Requests</h6>\n                                    <div class="d-flex align-items-center justify-content-center mb-2">\n                                        <i class="fas fa-paper-plane me-2" style="opacity: 0.8; font-size: 1.2rem;"></i>\n                                        <span style="font-weight: 700; font-size: 1.5rem;">${t.total_requests}</span>\n                                    </div>\n                                    <small style="opacity: 0.8; font-size: 0.75rem;">Messages Processed</small>\n                                </div>\n                            </div>\n                        </div>\n                        <div class="col-md-3">\n                            <div class="card border-0 h-100" style="background: linear-gradient(135deg, #ff6b6b 0%, #ffa500 100%); color: white; border-radius: 12px; box-shadow: 0 4px 12px rgba(255, 107, 107, 0.2);">\n                                <div class="card-body text-center" style="padding: 16px 12px;">\n                                    <h6 class="card-title mb-2" style="font-weight: 600; opacity: 0.9; font-size: 0.85rem;">Today's Tokens</h6>\n                                    <div class="d-flex align-items-center justify-content-center mb-2">\n                                        <i class="fas fa-calendar-day me-2" style="opacity: 0.8; font-size: 1.2rem;"></i>\n                                        <span style="font-weight: 700; font-size: 1.5rem;">${r(t.today_tokens_used||0)}</span>\n                                    </div>\n                                    <small style="opacity: 0.8; font-size: 0.75rem;">Tokens Used Today</small>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n\n                    \x3c!-- Compact Data Table --\x3e\n                    <div class="card border-0" style="border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.06);">\n                        <div class="card-header" style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-radius: 12px 12px 0 0; border: none; padding: 12px 16px;">\n                            <div class="d-flex justify-content-between align-items-center">\n                                <h6 class="mb-0" style="font-weight: 600; color: #333;">\n                                    Detailed Usage History\n                                </h6>\n                                <span class="badge bg-primary" style="font-size: 0.7rem; padding: 4px 8px; border-radius: 12px; color: white; background: linear-gradient(135deg, #0ea5e9 0%, #2563eb 100%);">\n                                    ${a.length} of ${s.total} records\n                                </span>\n                            </div>\n                        </div>\n                        <div class="card-body p-0">\n                            <div class="table-responsive">\n                                <table id="usage-datatable" class="table table-hover mb-0" style="font-size: 0.9rem;">\n                                    <thead style="background: linear-gradient(135deg, #0ea5e9 0%, #2563eb 100%); color: white;">\n                                        <tr>\n                                            <th style="border: none; padding: 15px 12px; font-weight: 600; text-align: center;">Date</th>\n                                            <th style="border: none; padding: 15px 12px; font-weight: 600; text-align: center;">Action</th>\n                                            <th style="border: none; padding: 15px 12px; font-weight: 600; text-align: center;">Model</th>\n                                            <th style="border: none; padding: 15px 12px; font-weight: 600; text-align: center;">Input</th>\n                                            <th style="border: none; padding: 15px 12px; font-weight: 600; text-align: center;">Output</th>\n                                            <th style="border: none; padding: 15px 12px; font-weight: 600; text-align: center;">Total Tokens</th>\n                                        </tr>\n                                    </thead>\n                                    <tbody>\n                                        ${a.length>0?a.map(e=>`\n                                            <tr style="border-bottom: 1px solid #f8f9fa;">\n                                                <td style="padding: 12px; vertical-align: middle; font-weight: 500;">\n                                                    ${(()=>{const t=new Date(e.created_at);return`${t.getDate()} ${t.toLocaleString("en-US",{month:"short"})} ${t.getFullYear()} - ${t.getHours().toString().padStart(2,"0")}:${t.getMinutes().toString().padStart(2,"0")}`})()}\n                                                </td>\n                                                <td style="padding: 12px; vertical-align: middle;">\n                                                    <span class="badge ${"report_generation"===e.action_type?"bg-primary":"mcq_generation"===e.action_type?"bg-warning":"bg-success"}" style="border-radius: 20px; padding: 6px 12px; font-weight: 500;">\n                                                        <i class="fas ${"report_generation"===e.action_type?"fa-file-alt":"mcq_generation"===e.action_type?"fa-question-circle":"fa-comment"} me-1"></i>\n                                                        ${e.action_type.replace("_"," ")}\n                                                    </span>\n                                                </td>\n                                                <td style="padding: 12px; vertical-align: middle;">\n                                                    <span class="badge bg-light text-dark" style="border-radius: 20px; padding: 4px 8px;">\n                                                        ${e.model||"N/A"}\n                                                    </span>\n                                                </td>\n                                                <td style="padding: 12px; vertical-align: middle; font-weight: 500; color: #11998e;">${(e.prompt_tokens||0).toLocaleString()}</td>\n                                                <td style="padding: 12px; vertical-align: middle; font-weight: 500; color: #f5576c;">${(e.completion_tokens||0).toLocaleString()}</td>\n                                                <td style="padding: 12px; vertical-align: middle; font-weight: 600; color: #667eea;">${(e.tokens_used||0).toLocaleString()}</td>\n                                            </tr>\n                                        `).join(""):'\n                                            <tr>\n                                                <td colspan="6" style="padding: 40px; text-align: center;">\n                                                    <div style="color: #6c757d;">\n                                                        <i class="fas fa-inbox fa-3x mb-3" style="opacity: 0.5;"></i>\n                                                        <h5 style="font-weight: 600; margin-bottom: 10px;">No Usage Data Yet</h5>\n                                                        <p style="margin: 0; font-size: 0.9rem;">Start using the AI Assistant to generate reports and your usage history will appear here.</p>\n                                                    </div>\n                                                </td>\n                                            </tr>\n                                        '}\n                                    </tbody>\n                                </table>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n            `;o.fire({html:d,width:"80%",showConfirmButton:!1,showCancelButton:!1,showCloseButton:!1,allowOutsideClick:!0,customClass:{popup:"usage-modal-popup",htmlContainer:"usage-modal-container"},didOpen:()=>{const t=document.querySelector(".usage-modal-close-btn");t&&(t.addEventListener("mouseenter",()=>{t.style.background="rgba(255,255,255,0.3)"}),t.addEventListener("mouseleave",()=>{t.style.background="rgba(255,255,255,0.2)"})),this.setupUsageModalEventListeners(e)}})},setupUsageModalEventListeners:function(t){const a=this;let s=t.filters;a.usageDataTable=null,setTimeout(()=>{if("undefined"!=typeof simpleDatatables&&simpleDatatables.DataTable&&e("#usage-datatable").length)try{const e=document.getElementById("usage-datatable");if(e){const t=e.querySelector("tbody");t&&t.rows.length>0&&(a.usageDataTable=new simpleDatatables.DataTable("#usage-datatable",{searchable:!0,fixedHeight:!1,perPage:25,perPageSelect:[10,25,50,100],sortable:!0,labels:{placeholder:"Search usage history...",noRows:"No usage data found",info:"Showing {start} to {end} of {rows} entries"}}))}}catch(e){}},500),e("#apply-filters").on("click",function(){const t=e("#user-filter").val(),r=e("#credit-type-filter").val(),n=e("#start-date-filter").val(),i=e("#end-date-filter").val();s={user_id:t,credit_type:r,start_date:n,end_date:i},a.loadUsageDataWithFilters(s,1)}),e("#clear-filters").on("click",function(){e("#user-filter").val(""),e("#credit-type-filter").val(""),e("#start-date-filter").val(""),e("#end-date-filter").val(""),s={},a.loadUsageDataWithFilters({},1)}),e(".adeptus-quick-filter").on("click",function(){const t=e(this).data("period"),r=new Date;let n="",i=r.toISOString().split("T")[0];switch(t){case"today":n=i;break;case"week":{const e=new Date(r);e.setDate(r.getDate()-7),n=e.toISOString().split("T")[0];break}case"month":{const e=new Date(r);e.setMonth(r.getMonth()-1),n=e.toISOString().split("T")[0];break}}e("#start-date-filter").val(n),e("#end-date-filter").val(i),s={user_id:e("#user-filter").val(),credit_type:e("#credit-type-filter").val(),start_date:n,end_date:i},a.loadUsageDataWithFilters(s,1)})},loadUsageDataWithFilters:function(e,t=1){o.fire({title:l("loading","Loading..."),text:l("applying_filters","Applying filters and loading data"),allowOutsideClick:!1,showConfirmButton:!1,willOpen:()=>{o.showLoading()}});const a=new URLSearchParams;e.user_id&&a.append("user_id",e.user_id),e.credit_type&&a.append("credit_type",e.credit_type),e.start_date&&a.append("start_date",e.start_date),e.end_date&&a.append("end_date",e.end_date),a.append("page",t),a.append("per_page",1e3),this.ajaxWithAuth({url:`${this.backendUrl}/chat/credits/detailed-usage?${a.toString()}`,method:"GET",success:e=>{e.success?this.updateUsageModalData(e.data):o.fire(l("error","Error"),l("failed_load_filtered","Failed to load filtered data"),"error")},error:()=>{o.fire(l("error","Error"),l("failed_load_filtered","Failed to load filtered data"),"error")}})},updateUsageModalData:function(t){const a=t.summary,s=t.usage;e(".detailed-usage-modal .card h2").eq(0).text(a.total_credits_used),e(".detailed-usage-modal .card h2").eq(1).text(a.total_tokens_used.toLocaleString()),e(".detailed-usage-modal .card h2").eq(2).text(a.total_requests),e(".detailed-usage-modal .card h2").eq(3).text(a.unique_users),e(".detailed-usage-modal .card h3").eq(0).text(a.premium_credits),e(".detailed-usage-modal .card h3").eq(1).text(a.basic_credits),e(".detailed-usage-modal .badge.bg-primary").text(`${s.length} of ${t.pagination.total} records`);const r=e("#usage-datatable tbody");if(r.empty(),s.forEach(e=>{const t=`\n                    <tr style="border-bottom: 1px solid #f8f9fa;">\n                        <td style="padding: 12px; vertical-align: middle; font-weight: 500;">${new Date(e.created_at).toLocaleDateString()}</td>\n                        <td style="padding: 12px; vertical-align: middle;">\n                            <span class="badge bg-light text-dark" style="border-radius: 20px; padding: 4px 8px;">\n                                ${e.user_id||"N/A"}\n                            </span>\n                        </td>\n                        <td style="padding: 12px; vertical-align: middle;">\n                            <span class="badge ${"premium"===e.credit_type?"bg-primary":"bg-success"}" style="border-radius: 20px; padding: 6px 12px; font-weight: 500;">\n                                <i class="fas ${"premium"===e.credit_type?"fa-crown":"fa-layer-group"} me-1"></i>\n                                ${e.credit_type}\n                            </span>\n                        </td>\n                        <td style="padding: 12px; vertical-align: middle; font-weight: 600; color: #667eea;">${e.credits_charged}</td>\n                        <td style="padding: 12px; vertical-align: middle; font-weight: 500;">${e.tokens_used.toLocaleString()}</td>\n                        <td style="padding: 12px; vertical-align: middle;">\n                            <span class="badge bg-info text-white" style="border-radius: 20px; padding: 4px 8px;">\n                                ${e.llm_provider}\n                            </span>\n                        </td>\n                        <td style="padding: 12px; vertical-align: middle; max-width: 200px;">\n                            <div style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${e.message_preview||"No message"}">\n                                ${e.message_preview?e.message_preview.substring(0,50)+"...":"N/A"}\n                            </div>\n                        </td>\n                    </tr>\n                `;r.append(t)}),this.usageDataTable&&"function"==typeof this.usageDataTable.refresh)try{this.usageDataTable.refresh()}catch(e){}},updateReportData:function(t){const a=e("#report-table");a.empty();const s=e("<thead><tr></tr></thead>");t.columns.forEach(e=>{s.find("tr").append(`<th>${e}</th>`)}),a.append(s);const r=e("<tbody></tbody>");t.rows.forEach(t=>{const a=e("<tr></tr>");t.forEach(e=>{a.append(`<td>${e}</td>`)}),r.append(a)}),a.append(r)},updateVisualizations:function(t){const a=e("#adeptus-chart-container");a.empty();const r=e("<canvas></canvas>");a.append(r);const n=e("#chart-type").val();new s(r[0],{type:n,data:{labels:t.labels,datasets:t.datasets.map(e=>({label:e.label,data:e.data,backgroundColor:e.backgroundColor,borderColor:e.borderColor,borderWidth:1}))},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{position:"top"},title:{display:!0,text:t.title}}}})},detectNumericColumns:function(e,t){return e&&0!==e.length?t.filter(t=>{let a=0;const s=Math.min(e.length,20);for(let r=0;r<s;r++){const s=e[r][t];if(null!=s&&""!==s){const e=parseFloat(s);!isNaN(e)&&isFinite(e)&&a++}}return a>=.5*s}):[]},generateChartColors:function(e){const t=["#2563eb","#10b981","#f59e0b","#ef4444","#8b5cf6","#06b6d4","#ec4899","#84cc16","#f97316","#6366f1","#14b8a6","#a855f7","#eab308","#22c55e","#3b82f6"],a=[];for(let s=0;s<e;s++)a.push(t[s%t.length]);return a},createReportChartConfig:function(e,t,a,s,r,n){const i={responsive:!0,maintainAspectRatio:!1,plugins:{title:{display:!0,text:n||"Report Chart",font:{size:16,weight:"bold"},padding:{top:10,bottom:20}},legend:{display:"pie"===e||"doughnut"===e,position:"right"}}};return"pie"===e||"doughnut"===e?{type:e,data:{labels:t,datasets:[{data:a,backgroundColor:r,borderColor:"#fff",borderWidth:2}]},options:i}:"line"===e?{type:"line",data:{labels:t,datasets:[{label:s,data:a,borderColor:r[0],backgroundColor:r[0]+"40",borderWidth:3,fill:!0,tension:.4}]},options:{...i,scales:{y:{beginAtZero:!0},x:{ticks:{maxRotation:45,minRotation:45}}}}}:{type:"bar",data:{labels:t,datasets:[{label:s,data:a,backgroundColor:r,borderColor:r,borderWidth:1}]},options:{...i,scales:{y:{beginAtZero:!0},x:{ticks:{maxRotation:45,minRotation:45}}}}}},renderReportChartFromSelectors:function(t,a){const r=this;if(!t||0===t.length)return;const n=e("#report-chart-type").val()||"bar",i=e("#report-chart-x-axis").val(),o=e("#report-chart-y-axis").val();if(!i||!o)return;const d=o.replace(/_/g," ").replace(/\b\w/g,e=>e.toUpperCase()),l=t.slice(0,50),c=l.map(e=>{const t=e[i];if(null==t)return"Unknown";const a=String(t);return a.length>30?a.substring(0,30)+"...":a}),p=l.map(e=>parseFloat(e[o])||0),u=this.generateChartColors(p.length),h=this.createReportChartConfig(n,c,p,d,u,a),g=document.getElementById("reportChart");if(g){r.reportChartInstance&&r.reportChartInstance.destroy();try{r.reportChartInstance=new s(g.getContext("2d"),h)}catch(e){}}},showLoading:function(){e(".adeptus-ai-thinking-loader-wrapper").remove(),this.loaderShownAt=Date.now();const t=e("#adeptus-chat-container");t.length>0&&(t.append('\n                <div class="adeptus-message-wrapper adeptus-ai-message-wrapper adeptus-ai-thinking-loader-wrapper" style="margin: 10px 0;">\n                    <div class="adeptus-message adeptus-ai-message adeptus-ai-thinking-loader" style="\n                        max-width: 70%;\n                        margin-left: 20px;\n                        padding: 15px 20px;\n                        background: linear-gradient(135deg, #f0f4f8 0%, #e9ecef 100%);\n                        border-radius: 18px 18px 18px 4px;\n                        box-shadow: 0 2px 8px rgba(0,0,0,0.08);\n                        display: flex;\n                        align-items: center;\n                        gap: 12px;\n                    ">\n                        <div class="adeptus-ai-avatar-loader" style="\n                            padding: 8px 12px;\n                            background: linear-gradient(135deg, #0ea5e9 0%, #2563eb 100%);\n                            border-radius: 20px;\n                            display: flex;\n                            align-items: center;\n                            justify-content: center;\n                            color: white;\n                            font-weight: 600;\n                            font-size: 13px;\n                            flex-shrink: 0;\n                            animation: pulse-glow-loader 2s infinite;\n                            font-family: system-ui, -apple-system, sans-serif;\n                            letter-spacing: 0.5px;\n                        ">Adeptus AI</div>\n                        <div class="adeptus-thinking-dots" style="\n                            display: flex;\n                            align-items: center;\n                            gap: 4px;\n                        ">\n                            <span class="adeptus-thinking-text" style="\n                                color: #6c757d;\n                                font-size: 14px;\n                                margin-right: 8px;\n                                font-style: italic;\n                            ">Thinking</span>\n                            <span class="adeptus-dot adeptus-dot-1" style="\n                                width: 8px;\n                                height: 8px;\n                                border-radius: 50%;\n                                background: #0ea5e9;\n                                display: inline-block;\n                                animation: bounce-loader 1.4s infinite ease-in-out both;\n                                animation-delay: -0.32s;\n                            "></span>\n                            <span class="adeptus-dot adeptus-dot-2" style="\n                                width: 8px;\n                                height: 8px;\n                                border-radius: 50%;\n                                background: #2563eb;\n                                display: inline-block;\n                                animation: bounce-loader 1.4s infinite ease-in-out both;\n                                animation-delay: -0.16s;\n                            "></span>\n                            <span class="adeptus-dot adeptus-dot-3" style="\n                                width: 8px;\n                                height: 8px;\n                                border-radius: 50%;\n                                background: #0ea5e9;\n                                display: inline-block;\n                                animation: bounce-loader 1.4s infinite ease-in-out both;\n                            "></span>\n                        </div>\n                    </div>\n                </div>\n            '),this.scrollToBottom())},hideLoading:function(){const t=this.loaderShownAt?Date.now()-this.loaderShownAt:0,a=Math.max(0,800-t);setTimeout(()=>{e(".adeptus-ai-thinking-loader-wrapper").fadeOut(200,function(){e(this).remove()}),e(".adeptus-ai-thinking-loader").fadeOut(200,function(){e(this).remove()}),e("#adeptus-loading-indicator").addClass("d-none")},a)},showError:function(t){const a=e("#adeptus-error-message");e("#error-text").text(t),a.removeClass("d-none"),setTimeout(()=>{a.addClass("d-none")},5e3)},showSuccess:function(t){if(0===e("#success-message").length){const t='\n                    <div class="alert alert-success alert-dismissible fade show d-none" role="alert" id="success-message" style="position:fixed; top:20px; right:20px; z-index:1050;">\n                        <i class="fa fa-check-circle me-2"></i>\n                        <span id="success-text"></span>\n                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>\n                    </div>\n                ';e("body").append(t)}const a=e("#success-message");e("#success-text").text(t),a.removeClass("d-none"),setTimeout(()=>{a.addClass("d-none")},3e3)},scrollToBottom:function(){const t=e("#adeptus-chat-container");t.scrollTop(t[0].scrollHeight)},loadChatHistory:function(){const t=e("#chat-history-list");t.html('\n                <li class="list-group-item d-flex justify-content-center" id="chat-history-loading">\n                    <div class="spinner-border text-secondary" role="status">\n                        <span class="sr-only">Loading...</span>\n                    </div>\n                </li>\n            '),this.ajaxWithAuth({url:this.backendUrl+"/chat/history",method:"GET",success:a=>{if(t.empty(),a&&a.chats&&Array.isArray(a.chats))if(a.chats.length)a.chats.forEach(a=>{const s=a.created_at?new Date(a.created_at).toLocaleString():"Unknown date",r=a.last_message||a.title||a.snippet||a.first_message||"Chat session",n=a.report_count||0,i=n>0?`<span class="badge bg-primary d-flex align-items-center adeptus-report-count"><i class="fa fa-chart-bar me-1"></i>${n}</span>`:"";if(a.id){const n=e(`\n                                    <li class="list-group-item d-flex justify-content-between align-items-start adeptus-chat-history-item" data-chat-id="${a.id}">\n                                        <div>\n                                            <small class="text-muted">${s}</small><br>\n                                            ${r}\n                                        </div>\n                                        ${i}\n                                    </li>\n                                `);t.append(n)}}),e(".adeptus-chat-history-item").on("click",t=>{const a=e(t.currentTarget),s=a.data("chat-id");this.loadChatMessages(s,a)}),0===this.currentChatId&&0===e("#adeptus-chat-container").children().length&&this.showWelcomeMessage();else{const a=i.getAuthStatus();a&&a.subscription&&a.subscription.reports_generated_this_month>0?t.append(`<li class="list-group-item text-center">${l("no_chats_yet","No chats yet")}</li>`):(t.append('\n                                <li class="list-group-item text-center">\n                                    <div class="text-muted">\n                                        <i class="fa fa-comments fa-2x mb-2"></i>\n                                        <p class="mb-1">No chat history yet</p>\n                                        <small>Start a conversation to see your chat history here</small>\n                                    </div>\n                                </li>\n                            '),0===e("#adeptus-chat-container").children().length&&this.showWelcomeMessage())}else t.append('\n                            <li class="list-group-item text-center">\n                                <div class="text-muted">\n                                    <i class="fa fa-comments fa-2x mb-2"></i>\n                                    <p class="mb-1">No chat history available</p>\n                                    <small>Start a conversation to see your chat history here</small>\n                                </div>\n                            </li>\n                        ')},error:()=>{t.html('\n                        <li class="list-group-item text-center">\n                            <div class="text-danger">\n                                <i class="fa fa-exclamation-triangle fa-2x mb-2"></i>\n                                <p class="mb-2">Failed to load chat history</p>\n                                <button id="reload-chat-history" class="btn btn-outline-primary btn-sm">\n                                    <i class="fa fa-refresh"></i> Try Again\n                                </button>\n                            </div>\n                        </li>\n                    '),e("#reload-chat-history").on("click",()=>this.loadChatHistory())}})},loadChatMessages:function(t,a){this.currentChatId=t,e("#chat-history-list li").removeClass("active"),a.addClass("active"),e("#adeptus-chat-container").empty(),this.clearMCQ(),this.showLoading();const s=`${this.backendUrl}/chat/${t}/messages`;this.ajaxWithAuth({url:s,method:"GET",success:t=>{this.hideLoading(),t.credit_data&&t.credit_data.summary&&this.updateSubscriptionDataFromCreditResponse(t.credit_data);const a=i.getAuthStatus();if(a&&a.subscription&&this.checkAndShowCreditLimitWarning(a.subscription),t.messages.forEach((a,s)=>{if(a.sender_type=a.role||a.sender_type,a.body=a.content||a.body,a.timestamp=a.created_at||a.timestamp,"assistant"===a.sender_type&&(a.sender_type="ai"),"sql"===a.tag)return;if("ai"===a.sender_type&&"mcq"===a.tag){const r=t.messages[s+1],n=r&&"user"===r.sender_type?r.body:null,i=this.extractMCQFromText(a.body);if(i&&i.questions.length>0){i.selectedAnswer=n;const t=this.renderMCQHistory(i.questions,n),s=document.getElementById("message-template").content.cloneNode(!0),r=s.querySelector(".adeptus-message");return r.classList.add("adeptus-ai-message"),r.setAttribute("data-message-id",a.id),s.querySelector(".adeptus-message-text").innerHTML=t,s.querySelector(".adeptus-message-time").textContent=this.formatTimestamp(a.timestamp),void e("#adeptus-chat-container").append(s)}}if("user"===a.sender_type&&s>0){const e=t.messages[s-1];if(e&&"ai"===e.sender_type&&"mcq"===e.tag)return}const r=a.metadata&&"report"===a.metadata.type&&a.metadata.sql,n=!r&&a.body&&a.body.startsWith("Report Generated:")&&a.body.includes("```sql"),i=a.body&&a.body.startsWith("ðŸ“Š Report saved:");if(r||n){let e,t,s,n;if(r)e=a.metadata.sql,t=a.metadata.name||"Report",s=a.metadata.description||t,n=a.metadata.category||"general";else{const r=a.body.match(/```sql\n([\s\S]*?)```/);e=r?r[1].trim():null;const i=a.body.match(/^Report Generated:\s*(.+?)(?:\n|$)/);t=i?i[1].trim():"Report",s=t;const o=a.body.match(/Category:\s*(\w+)/);n=o?o[1]:"general"}if(e){const a=`I've generated a report for you: ${s}`;this.executeReportLocally(e,{}).then(r=>{if(r.data&&r.data.length>0){const i={name:t,description:s,sql:e,category:n};this.showReportConfirmation(i,r.data,a,null,r.error||null)}else r.error&&this.addMessage("âš ï¸ Could not re-execute report: "+r.error,"ai")}).catch(()=>{})}else this.addMessage(a.body,a.sender_type,!1,null,a.id,a.timestamp)}else if(i){if(!a.metadata){const e=a.body.match(/ðŸ“Š Report saved: (.+)/),t=e?e[1]:"Report",s=t.toLowerCase().replace(/\s+/g,"-").replace(/[^a-z0-9-]/g,"");a.metadata={type:"report",report_name:t,report_slug:s}}this.displayReportLink(a)}else this.addMessage(a.body,a.sender_type,!1,null,a.id,a.timestamp)}),this.scrollToBottom(),t.reports&&t.reports.length&&t.reports.forEach(e=>{this.insertReportLinkInChat(e)}),t.messages.length>0){const e=t.messages[t.messages.length-1];if("mcq"===e.tag){const t=e.body.match(/\{[\s\S]*?\}/g)||[],a=[];t.forEach(e=>{try{const t=JSON.parse(e);"mcq"===t.type&&Array.isArray(t.options)&&a.push(t)}catch(e){}}),a.length&&this.enqueueMCQs(a)}}},error:()=>{this.hideLoading(),this.showError("Could not load conversation.")}})},insertReportLinkInChat:function(t){const a=e(`#adeptus-chat-container .adeptus-message[data-message-id="${t.message_after_id}"]`);if(!a.length)return;const s=`\n                <div class="adeptus-message adeptus-ai-message">\n                  <div class="adeptus-message-content">\n                    <div class="adeptus-message-text">\n                      <a href="javascript:void(0)" class="adeptus-report-link" data-report-slug="${t.slug}"\n                         style="color: #007bff; text-decoration: none; padding:4px 8px; border:1px solid #dee2e6; border-radius:4px; background:#f8f9fa; display:inline-block; transition:all 0.2s;">\n                        ðŸ“Š ${t.description}\n                      </a>\n                    </div>\n                    <div class="adeptus-message-time small text-muted">${new Date(t.created_at).toLocaleTimeString()}</div>\n                  </div>\n                </div>\n            `,r=e(s),n=this;r.find(".adeptus-report-link").on("click",function(){const t=e(this).data("report-slug");n.openReportFromLink(t)}).on("mouseenter",function(){e(this).css({"background-color":"#e9ecef","border-color":"#adb5bd",transform:"translateY(-1px)"})}).on("mouseleave",function(){e(this).css({"background-color":"#f8f9fa","border-color":"#dee2e6",transform:"translateY(0)"})}),a.after(r)},sendMessage:function(t){if(this.currentMCQ)return;if(this.isReportLimitReached&&-1!==this.reportsLimit)return void this.handleReportLimitError("You have reached your report limit. Delete existing reports or upgrade your plan to continue using the AI assistant.");if(this.isSending)return;const a=e("#message-input"),s=t?String(t).trim():(a.val()||"").trim();if(!s)return void o.fire({icon:"error",title:l("oops","Oops..."),text:l("please_enter_message","Please enter a message")});const r=s.trim();if(!r)return;this.isSending=!0,e(".adeptus-welcome-message").remove();const n=this.addMessage(r,"user");t||a.val("").trigger("input"),this.showLoading();const d=i.getAuthStatus(),c=d?.user||{},p={message:t?`I selected: ${r}`:r,chat_id:this.currentChatId||0,user_id:c.id||null,user_name:c.name||null};this.ajaxWithAuth({url:this.backendUrl+"/chat/message",method:"POST",contentType:"application/json",data:JSON.stringify(p),success:t=>{this.hideLoading(),this.isSending=!1,t.error?"credit_limit"===t.error_type||"token_limit"===t.error_type?this.handleCreditLimitError(t.message,t.credit_data):"report_limit"===t.error_type?this.handleReportLimitError(t.message):"timeout"===t.error_type?this.handleTimeoutError(t.message):(this.addMessage(t.message,"error"),this.showResendIconOnMessage(n,r)):(e(".adeptus-failed-reload-icon").remove(),!this.currentChatId&&t.chat_id&&(this.currentChatId=t.chat_id,this.addChatToChatHistory(t.chat_id,r)),this.handleResponse(t),this.refreshSubscriptionInfo())},error:e=>{if(this.hideLoading(),this.isSending=!1,401===e.status)i.clearAuthData(),this.showAuthenticationError();else{if(429!==e.status)return this.showResendIconOnMessage(n,r),void this.addMessage("Network error occurred. Please try again.","error");if("report_limit"===(e.responseJSON?.error_type||"credit_limit")){const t=e.responseJSON?.message||"You have reached your report limit. Please upgrade your plan to generate more reports.";this.handleReportLimitError(t)}else{let t="You have reached your credit limit. Please upgrade your plan or wait until your credits refresh.",a=null;e.responseJSON&&(t=e.responseJSON.message||t,a=e.responseJSON.credit_data||null),this.handleCreditLimitError(t,a)}n.remove()}}})},updateSendMessageandCreateNewChatButton:function(){this.isCreditLimitExceeded?(e("#send-button").prop("disabled",!0).attr("title","Credit limit reached. Your credits will reset on the 1st of next month.").addClass("adeptus-credit-limit-disabled"),e("#create-new-chat").prop("disabled",!0).attr("title","Credit limit reached. Your credits will reset on the 1st of next month.").addClass("adeptus-credit-limit-disabled"),e("#message-input").prop("disabled",!0).attr("placeholder","Credit limit reached. Your credits will reset on the 1st of next month.")):(e("#send-button").prop("disabled",!1).removeAttr("title").removeClass("adeptus-credit-limit-disabled"),e("#create-new-chat").prop("disabled",!1).removeAttr("title").removeClass("adeptus-credit-limit-disabled"),e("#message-input").prop("disabled",!1).attr("placeholder","Type your message..."))},createNewChat:function(){this.currentChatId=0,e("#chat-history-list li").removeClass("active"),e("#adeptus-chat-container").empty(),this.clearMCQ(),this.showWelcomeMessage()},showWelcomeMessage:function(){e("#adeptus-chat-container").html('\n                <div class="adeptus-welcome-message text-center p-5">\n                    <div style="max-width: 600px; margin: 0 auto;">\n                        <h3 class="mb-4">Welcome to Adeptus AI Assistant</h3>\n                        <p class="text-muted mb-4">\n                            I\'m here to help you analyze your Moodle data and generate insightful reports.\n                        </p>\n                        <div class="row g-3">\n                            <div class="col-md-6">\n                                <div class="p-3 bg-light rounded">\n                                    <i class="fa fa-chart-bar fa-2x mb-2 text-primary"></i>\n                                    <h5>Generate Reports</h5>\n                                    <small class="text-muted">Ask me to create custom reports about courses, users, grades, and more.</small>\n                                </div>\n                            </div>\n                            <div class="col-md-6">\n                                <div class="p-3 bg-light rounded">\n                                    <i class="fa fa-question-circle fa-2x mb-2 text-info"></i>\n                                    <h5>Get Insights</h5>\n                                    <small class="text-muted">I can help you understand your data and provide actionable insights.</small>\n                                </div>\n                            </div>\n                        </div>\n                        <hr class="my-4">\n                        <p class="text-muted">\n                            <i class="fa fa-lightbulb"></i> Try asking: "Show me all active courses with their enrollment counts"\n                        </p>\n                    </div>\n                </div>\n            ')},addChatToChatHistory(t,a){const s=e("#chat-history-list");s.find('li:contains("No chat history")').remove(),s.find('li:contains("No chats yet")').remove(),s.find('li:contains("Start a conversation")').remove();const r=(new Date).toLocaleString(),n=a&&a.length>100?a.substring(0,97)+"...":a||"New chat",i=e(`<li class="list-group-item d-flex justify-content-between align-items-start adeptus-chat-history-item" data-chat-id="${t}">\n                    <div>\n                        <small class="text-muted">${r}</small><br>\n                        ${n}\n                    </div>\n                </li>`);s.prepend(i),i.on("click",t=>{const a=e(t.currentTarget),s=a.data("chat-id");this.loadChatMessages(s,a)})},initializeCharts:function(){const t=e("#adeptus-chart-container"),a=e("<canvas></canvas>");t.append(a),new s(a[0],{type:"bar",data:{labels:[],datasets:[]},options:{responsive:!0,maintainAspectRatio:!1}})},setUserName:function(t){let a="User";"string"==typeof t?a=t:t&&t.name?a=t.name:t&&t.admin_name&&(a=t.admin_name),e(".card-title").each(function(){e(this).text().includes("AI Report Assistant")&&e(this).text(a+": AI Report Assistant")})},isCreditExceeded:function(e,t){return 0!==t&&"âˆž"!==t&&null!=t&&e>=t},checkAndShowCreditLimitWarning:function(e){const t=this.isCreditExceeded(e.basic_credits_used_this_month||0,e.plan_basic_credits_limit||0),a=this.isCreditExceeded(e.premium_credits_used_this_month||0,e.plan_premium_credits_limit||0),s=this.isCreditExceeded(e.ai_credits_used_this_month||0,e.plan_ai_credits_limit||0);if(t||a||s){const e="You've used all your AI credits for this month. Your credits will reset on the 1st of next month. Consider upgrading your plan for more credits.";this.showPersistentCreditLimitMessage(e),this.isCreditLimitExceeded=!0,this.updateSendMessageandCreateNewChatButton()}else this.isCreditLimitExceeded=!1,this.updateSendMessageandCreateNewChatButton()},updateSubscriptionInfo:async function(){try{var a=t.call([{methodname:"report_adeptus_insights_check_subscription_status",args:{}}]),s=await a[0],r={success:s.success,data:s.data?s.data:s};if(r.success&&r.data){(i.getAuthStatus()||{}).subscription=r.data,"function"==typeof i.updateSubscription&&i.updateSubscription(r.data)}}catch(e){}const n=i.getAuthStatus();if(n&&n.subscription){const t=n.subscription;this.checkAndShowCreditLimitWarning(t),e(".adeptus-subscription-status-bar").remove();let a=`\n                    <div class="adeptus-subscription-status-bar">\n                        <div class="adeptus-subscription-bar-row">\n                            <div class="adeptus-subscription-info-left">\n                                <h6 class="adeptus-subscription-title">\n                                    <i class="fa fa-chart-line adeptus-subscription-icon"></i> Subscription Status\n                                    <button class="btn btn-outline-secondary btn-sm" id="refresh-subscription-btn" title="Refresh subscription data">\n                                        <i class="fa fa-refresh"></i>\n                                    </button>\n                                </h6>\n                                <div class="adeptus-subscription-details">\n                                    <span><strong>Plan:</strong> ${t.plan_name||"Unknown"}</span>\n                                    <span class="ms-3"><strong>Status:</strong> <span class="badge bg-${"active"===t.status?"success":"warning"}">${t.status||"Unknown"}</span></span>\n                                </div>\n                            </div>\n                            <div class="adeptus-subscription-actions-right">\n                                <a href="javascript:void(0)" onclick="window.assistant.showCreditUsageModal()" class="btn adeptus-btn-view-usage">\n                                    <i class="fa fa-chart-bar"></i> View Usage\n                                </a>\n                            </div>\n                        </div>\n                    </div>\n                `;const s=e("#adeptus-assistant-container");if(s.length)s.append(a);else{const t=e(".adeptus-assistant-header");t.length&&t.after(a)}const r=this;e("#refresh-subscription-btn").off("click").on("click",function(){const t=e(this),a=t.find("i");a.removeClass("fa-refresh").addClass("fa-spinner fa-spin"),t.prop("disabled",!0),r.refreshSubscriptionInfo(),setTimeout(()=>{a.removeClass("fa-spinner fa-spin").addClass("fa-refresh"),t.prop("disabled",!1)},1e3)})}else e(".adeptus-subscription-status-bar").remove()},transformBackendAuthData:function(e){if(!e)return null;return{...window.adeptusAuthData||{},user_authorized:!0,has_api_key:!0,installation:e.installation,subscription:e.subscription?{...e.subscription,premium_credits_used_this_month:e.usage&&e.usage.premium_credits_used_this_month||0,basic_credits_used_this_month:e.usage&&e.usage.basic_credits_used_this_month||0,ai_credits_used_this_month:e.usage&&e.usage.ai_credits_used_this_month||0,reports_generated_this_month:e.usage&&e.usage.reports_generated_this_month||0,plan_name:e.plan?e.plan.name:"Unknown",plan_premium_credits_limit:e.plan&&e.plan.premium_credits_per_month||0,plan_basic_credits_limit:e.plan&&e.plan.basic_credits_per_month||"âˆž",plan_ai_credits_limit:e.plan&&e.plan.ai_credits||0,plan_exports_limit:e.plan&&e.plan.exports||"âˆž"}:null,plan:e.plan,usage:e.usage}},refreshSubscriptionInfo:async function(){const a=e("#refresh-subscription-btn"),s=a.find("i");a.length&&s.length&&(s.removeClass("fa-refresh").addClass("fa-spinner fa-spin"),a.prop("disabled",!0));try{var r=t.call([{methodname:"report_adeptus_insights_check_subscription_status",args:{}}]),n=await r[0],o={success:n.success,data:n.data?n.data:n};if(o.success&&o.data){(i.getAuthStatus()||{}).subscription=o.data,window.adeptusAuthData&&(window.adeptusAuthData.subscription=o.data)}await this.updateSubscriptionInfo(),this.showRefreshSuccessFeedback()}catch(e){this.showRefreshErrorFeedback()}finally{a.length&&s.length&&(s.removeClass("fa-spinner fa-spin").addClass("fa-refresh"),a.prop("disabled",!1))}},showRefreshSuccessFeedback:function(){const t=e('\n                <div class="adeptus-refresh-success-notification" style="\n                    position: fixed;\n                    top: 20px;\n                    right: 20px;\n                    background: #28a745;\n                    color: white;\n                    padding: 8px 16px;\n                    border-radius: 4px;\n                    box-shadow: 0 2px 8px rgba(0,0,0,0.15);\n                    z-index: 9999;\n                    font-size: 12px;\n                    opacity: 0;\n                    transform: translateY(-20px);\n                    transition: all 0.3s ease;\n                ">\n                    <i class="fa fa-check me-1"></i>\n                    Usage updated\n                </div>\n            ');e("body").append(t),setTimeout(()=>{t.css({opacity:"1",transform:"translateY(0)"})},100),setTimeout(()=>{t.css({opacity:"0",transform:"translateY(-20px)"}),setTimeout(()=>t.remove(),300)},2e3)},showRefreshErrorFeedback:function(){const t=e('\n                <div class="adeptus-refresh-error-notification" style="\n                    position: fixed;\n                    top: 20px;\n                    right: 20px;\n                    background: #dc3545;\n                    color: white;\n                    padding: 8px 16px;\n                    border-radius: 4px;\n                    box-shadow: 0 2px 8px rgba(0,0,0,0.15);\n                    z-index: 9999;\n                    font-size: 12px;\n                    opacity: 0;\n                    transform: translateY(-20px);\n                    transition: all 0.3s ease;\n                ">\n                    <i class="fa fa-exclamation-triangle me-1"></i>\n                    Failed to update usage\n                </div>\n            ');e("body").append(t),setTimeout(()=>{t.css({opacity:"1",transform:"translateY(0)"})},100),setTimeout(()=>{t.css({opacity:"0",transform:"translateY(-20px)"}),setTimeout(()=>t.remove(),300)},3e3)},calculateUsagePercentage:function(e,t){if(!t||"âˆž"===t||0===t)return 0;const a=e/t*100;return Math.min(a,100)},ajaxWithAuth:function(a){if(!i.isAuthenticated())return this.showAuthenticationError(),Promise.reject(new Error("Authentication required"));var s=a.url;0===s.indexOf(this.backendUrl)&&(s=s.substring(this.backendUrl.length));var r=(a.method||a.type||"GET").toUpperCase(),n="";"POST"===r&&a.data&&(n="string"==typeof a.data?a.data:JSON.stringify(a.data));var o=e.Deferred();return t.call([{methodname:"report_adeptus_insights_proxy_backend_request",args:{endpoint:s,method:r,body:n}}])[0].done(function(e){try{var t=JSON.parse(e.data||"{}");a.success&&a.success(t),o.resolve([t,"success",{status:e.httpcode}])}catch(t){a.success&&a.success(e.data),o.resolve([e.data,"success",{status:e.httpcode}])}}).fail(function(e){a.error&&a.error(e),o.reject(e)}),o.promise()},loadCategories:function(){const e=this;this.ajaxWithAuth({url:this.backendUrl+"/reports/categories",method:"GET",contentType:"application/json",success:t=>{t.success&&t.data&&(e.cachedCategories=t.data)},error:()=>{e.cachedCategories=[{id:null,name:"General",slug:"general",color:"#6c757d",icon:"fa-folder"}]}})},getCategoryOptionsHtml:function(e){if(!this.cachedCategories||0===this.cachedCategories.length)return'<option value="">General</option>';const t=(e||"general").toLowerCase().replace(/[^a-z0-9]/g,"");return this.cachedCategories.map(e=>{const a=e.name.toLowerCase().replace(/[^a-z0-9]/g,""),s=(e.slug||"").toLowerCase().replace(/[^a-z0-9]/g,""),r=a===t||s===t;return`<option value="${e.id}" ${r?"selected":""}>${e.name}</option>`}).join("")},validateToken:function(){return i.isAuthenticated()},resendMessage:function(t,a){if(this.isSending)return;this.isSending=!0,this.showLoading();const s=i.getAuthStatus(),r=s?.user||{};this.ajaxWithAuth({url:this.backendUrl+"/chat/message",method:"POST",contentType:"application/json",data:JSON.stringify({message:a,chat_id:this.currentChatId||0,user_id:r.id||null,user_name:r.name||null}),success:s=>{this.hideLoading(),this.isSending=!1,s.error?"credit_limit"===s.error_type||"token_limit"===s.error_type?this.handleCreditLimitError(s.message,s.credit_data):"report_limit"===s.error_type?this.handleReportLimitError(s.message):(this.addMessage(s.message,"error"),this.showResendIconOnMessage(t,a)):(e(".adeptus-failed-reload-icon").remove(),!this.currentChatId&&s.chat_id&&(this.currentChatId=s.chat_id,this.addChatToChatHistory(s.chat_id,a)),this.handleResponse(s))},error:e=>{this.hideLoading(),this.isSending=!1,401===e.status?(i.clearAuthData(),this.showAuthenticationError()):(this.showResendIconOnMessage(t,a),this.addMessage("Network error occurred. Please try again.","error"))}})},enqueueMCQs:function(e){Array.isArray(e)&&0!==e.length&&(this.mcqQueue=e.slice(),this.showNextMCQ())},showNextMCQ:function(){if(0===this.mcqQueue.length)return this.clearMCQ();const e=this.mcqQueue.shift();this.renderMCQ(e.question,e.options)},renderMCQ:function(t,a){this.currentMCQ=!0,e("#message-input, #send-button").prop("disabled",!0);const s=e("#adeptus-mcq-container").empty().show();s.append(`<p class="adeptus-mcq-question"><strong>${t}</strong></p>`),a.forEach((e,t)=>{const a=String.fromCharCode(65+t);s.append(`\n                <div class="form-check">\n                    <input class="form-check-input" type="radio"\n                        name="mcq-option" id="mcq-${t}"\n                        value="${e}">\n                    <label class="form-check-label" for="mcq-${t}">\n                    ${a}. ${e}\n                    </label>\n                </div>`)}),s.append('<button type="button" class="btn btn-link" id="mcq-cancel">Cancel</button>'),s.find('input[name="mcq-option"]').on("change",()=>{e("#mcq-submit").remove(),s.append('<button type="button" id="mcq-submit" class="btn btn-primary mt-2">Submit</button>'),e("#mcq-submit").off("click").on("click",e=>{e.preventDefault(),e.stopPropagation();const t=s.find('input[name="mcq-option"]:checked').val();t&&this.sendMCQ(t)})}),s.find("#mcq-cancel").off("click").on("click",e=>{e.preventDefault(),this.mcqQueue=[],this.clearMCQ()})},sendMCQ:function(t){if(this.isSending)return;if(!t||"string"!=typeof t||!t.trim())return;this.showLoading(),this.isSending=!0,this.clearMCQ();const a=this.addMessage(t,"user"),s=i.getAuthStatus(),r=s?.user||{},n=`I selected: ${t.trim()}`;this.ajaxWithAuth({url:this.backendUrl+"/chat/message",method:"POST",contentType:"application/json",data:JSON.stringify({message:n,chat_id:this.currentChatId||0,user_id:r.id||null,user_name:r.name||null}),success:s=>{this.hideLoading(),this.isSending=!1,s.error?"credit_limit"===s.error_type||"token_limit"===s.error_type?this.handleCreditLimitError(s.message):"report_limit"===s.error_type?this.handleReportLimitError(s.message):(this.addMessage(s.message,"error"),this.showResendIconOnMessage(a,t)):(e(".adeptus-failed-reload-icon").remove(),this.handleResponse(s))},error:()=>{this.hideLoading(),this.isSending=!1,this.addMessage("Failed to send choice","error"),this.showResendIconOnMessage(a,t)}})},showReportConfirmation:function(e,t,a,s,r){this.addMessage(a||`I've generated a report: ${e.description}`,"ai",!1,null,null,null,s),t&&t.length>0?this.displayReportInChat(e,t):r?this.addMessage(`âš ï¸ The report could not be executed: ${r}\n\nYou can still save it and try executing it later.`,"system"):this.addMessage("â„¹ï¸ The report returned no data. You can still save it for later use.","system"),this.addReportActionButtons(e)},displayReportInChat:function(e,t){let a='<div class="adeptus-report-preview-container" style="margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 8px; border: 1px solid #dee2e6;">';if(a+=`<h5 style="margin-bottom: 10px; color: #495057;">${e.name||e.description}</h5>`,t&&t.length>0){const s=Object.keys(t[0]),r=20,n=t.slice(0,r);if(a+='<div class="table-responsive">',a+='<table class="table table-sm table-striped table-hover" style="font-size: 0.9rem; margin-bottom: 0;">',a+='<thead class="table-light"><tr>',s.forEach(e=>{a+=`<th style="background: #e9ecef; white-space: nowrap;">${e.replace(/_/g," ").replace(/\b\w/g,e=>e.toUpperCase())}</th>`}),a+="</tr></thead><tbody>",n.forEach(e=>{a+="<tr>",s.forEach(t=>{let s=e[t]||"";s.toString().length>50&&(s=s.toString().substring(0,47)+"..."),a+=`<td>${s}</td>`}),a+="</tr>"}),a+="</tbody></table></div>",t.length>r){const e=t.length-r;a+='<div class="text-center mt-3">',a+='<p class="text-muted mb-2" style="font-size: 0.85rem;">',a+=`<strong>Showing ${r} of ${t.length} rows</strong>`,a+=` (${e} more rows available)`,a+="</p>",a+='<small class="text-info"><i class="fa fa-info-circle"></i> Save the report to view all data in the Reports panel</small>',a+="</div>"}else a+=`<p class="text-muted text-center mt-2" style="font-size: 0.85rem;">Showing all ${t.length} rows</p>`;a+='<div class="mt-3 p-2 bg-light rounded" style="font-size: 0.85rem;">',a+=`<span class="badge badge-secondary">${e.category}</span>`,a+="</div>"}a+="</div>",this.addMessage(a,"report-preview",!1)},addReportActionButtons:function(e){const t=this,a=document.querySelectorAll(".adeptus-report-action-container");a.length>0&&a.forEach(e=>{e.querySelector(".fa-check-circle")||e.querySelector(".fa-info-circle")||e.querySelector(".fa-exclamation-triangle")||e.remove()});const s="report-action-"+Date.now(),r=`\n                <div class="adeptus-report-action-container" id="${s}" style="margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 8px; border: 1px solid #dee2e6;">\n                    <p style="margin-bottom: 15px; font-weight: 500;">Would you like to save this report to your Reports list?</p>\n                    <div class="adeptus-report-actions" style="display: flex; gap: 10px; flex-wrap: wrap;">\n                        <button class="btn btn-primary adeptus-btn-save-report" style="padding: 8px 20px;">\n                            <i class="fa fa-check-circle"></i> Save Report\n                        </button>\n                        <button class="btn btn-secondary adeptus-btn-decline-report" style="padding: 8px 20px;">\n                            <i class="fa fa-times-circle"></i> Don't Save\n                        </button>\n                        <button class="btn btn-outline-secondary adeptus-btn-decline-feedback" style="padding: 8px 20px;">\n                            <i class="fa fa-comment"></i> Decline & Give Feedback\n                        </button>\n                    </div>\n                </div>\n            `;this.addMessage(r,"system-action",!1),setTimeout(()=>{const a=document.getElementById(s);if(!a)return;const r=a.querySelector(".adeptus-btn-save-report");r&&!r.hasAttribute("data-handler-attached")&&(r.setAttribute("data-handler-attached","true"),r.addEventListener("click",function(){const s=t.getCategoryOptionsHtml(e.category),r=e.name||e.description||"SCORM Activities Report";o.fire({title:l("save_your_report","Save Your Report"),html:`\n                                <div style="text-align: left;">\n                                    <div style="margin-bottom: 15px;">\n                                        <label for="swal-report-name" style="display: block; margin-bottom: 5px; font-weight: 500;">\n                                            ${l("report_name_label","Report Name")}\n                                        </label>\n                                        <input type="text" id="swal-report-name" class="swal2-input"\n                                               placeholder="${l("enter_report_name","Enter a name for your report")}"\n                                               value="${r.replace(/"/g,"&quot;")}"\n                                               style="margin: 0; width: 100%;">\n                                    </div>\n                                    <div>\n                                        <label for="swal-report-category" style="display: block; margin-bottom: 5px; font-weight: 500;">\n                                            ${l("category_label","Category")}\n                                        </label>\n                                        <select id="swal-report-category" class="swal2-select"\n                                                style="margin: 0; width: 100%; padding: 8px 12px; border: 1px solid #d9d9d9; border-radius: 4px;">\n                                            ${s}\n                                        </select>\n                                    </div>\n                                </div>\n                            `,showCancelButton:!0,confirmButtonText:'<i class="fa fa-save"></i> '+l("save_report","Save Report"),cancelButtonText:l("cancel","Cancel"),confirmButtonColor:"#28a745",focusConfirm:!1,preConfirm:()=>{const e=document.getElementById("swal-report-name").value,t=document.getElementById("swal-report-category").value;return e&&""!==e.trim()?e.length>255?(o.showValidationMessage("Report name is too long (max 255 characters)"),!1):{name:e.trim(),categoryId:t}:(o.showValidationMessage("Please enter a name for the report"),!1)}}).then(s=>{s.isConfirmed&&(e.name=s.value.name,e.description=s.value.name,e.category_id=s.value.categoryId?parseInt(s.value.categoryId):null,a.querySelectorAll("button").forEach(e=>{e.disabled=!0}),a.innerHTML=`\n                                    <div style="text-align: center; color: #28a745;">\n                                        <i class="fa fa-spinner fa-spin"></i> Saving "${e.name}" to your Reports list...\n                                    </div>\n                                `,t.confirmReport("accept",e,null))})}));const n=a.querySelector(".adeptus-btn-decline-report");n&&!n.hasAttribute("data-handler-attached")&&(n.setAttribute("data-handler-attached","true"),n.addEventListener("click",function(){a.innerHTML='\n                            <div style="text-align: center; color: #6c757d;">\n                                <i class="fa fa-info-circle"></i> Report not saved. You can ask me to generate it again anytime.\n                            </div>\n                        ',t.addMessage("Report was not saved. Feel free to ask me to generate a different report or refine this one.","system")}));const i=a.querySelector(".adeptus-btn-decline-feedback");i&&!i.hasAttribute("data-handler-attached")&&(i.setAttribute("data-handler-attached","true"),i.addEventListener("click",function(){a.innerHTML=`\n                            <div class="adeptus-feedback-form">\n                                <p style="margin-bottom: 10px;">What would you like to change about this report?</p>\n                                <textarea id="feedback-text-${s}" class="form-control" rows="3" placeholder="Please provide your feedback..."></textarea>\n                                <div style="margin-top: 10px; display: flex; gap: 10px;">\n                                    <button class="btn btn-primary adeptus-btn-send-feedback">\n                                        <i class="fa fa-paper-plane"></i> Send Feedback\n                                    </button>\n                                    <button class="btn btn-secondary adeptus-btn-cancel-feedback">\n                                        Cancel\n                                    </button>\n                                </div>\n                            </div>\n                        `;const r=a.querySelector(".adeptus-btn-send-feedback"),n=a.querySelector(".adeptus-btn-cancel-feedback"),i=a.querySelector(`#feedback-text-${s}`);r&&r.addEventListener("click",function(){const s=i?i.value:"";s.trim()?(a.innerHTML='\n                                        <div style="text-align: center; color: #007bff;">\n                                            <i class="fa fa-spinner fa-spin"></i> Sending feedback...\n                                        </div>\n                                    ',t.confirmReport("decline",e,s)):(i.style.borderColor="#dc3545",i.focus())}),n&&n.addEventListener("click",function(){a.innerHTML='\n                                    <div style="text-align: center; color: #6c757d;">\n                                        <i class="fa fa-info-circle"></i> Report not saved.\n                                    </div>\n                                '})}))},100)},viewSavedReport:function(t){t&&(e('[href="#reports-history"]').tab("show"),setTimeout(()=>{const s=e(`.adeptus-report-row[data-report-slug="${t}"]`);s.length?s.click():this.loadReportsHistory(()=>{setTimeout(()=>{const s=e(`.adeptus-report-row[data-report-slug="${t}"]`);s.length?s.click():a.addNotification({message:l("report_not_found","Report not found. Please check if it still exists in the Reports tab."),type:"error"})},500)})},300))},displayReportLink:function(t){const a=document.getElementById("message-template").content.cloneNode(!0),s=a.querySelector(".adeptus-message");s.classList.add("adeptus-ai-message"),s.setAttribute("data-message-id",t.id);const r=t.metadata?.report_slug||"",n=t.metadata?.report_name||"Report",i=t.metadata?.report_description||"",o=`\n                <div class="adeptus-report-link-message">\n                    <div style="padding: 15px; background: linear-gradient(135deg, #007bff 0%, #0056b3 100%); color: white; border-radius: 10px; margin: 10px 0;">\n                        <div style="display: flex; align-items: center; justify-content: space-between; gap: 20px;">\n                            <div style="flex: 1;">\n                                <h5 style="margin: 0; color: white;">\n                                    <i class="fa fa-chart-bar"></i> ${n}\n                                </h5>\n                                ${i?`<small style="opacity: 0.9;">${i}</small>`:""}\n                            </div>\n                            ${r?`\n                                <button class="btn btn-light btn-sm adeptus-view-saved-report-btn"\n                                        data-slug="${r}"\n                                        style="cursor: pointer; border-radius: 5px; flex-shrink: 0;">\n                                    <i class="fa fa-eye"></i> View Report\n                                </button>\n                            `:""}\n                        </div>\n                    </div>\n                </div>\n            `;a.querySelector(".adeptus-message-text").innerHTML=o,a.querySelector(".adeptus-message-time").textContent=this.formatTimestamp(t.timestamp),e("#adeptus-chat-container").append(a);const d=this;setTimeout(()=>{const t=e("#adeptus-chat-container").find('.adeptus-view-saved-report-btn[data-slug="'+r+'"]').last();t.length&&!t.hasClass("adeptus-click-handler-attached")&&(t.addClass("adeptus-click-handler-attached"),t.on("click",function(t){t.preventDefault(),t.stopPropagation(),d.switchToReportsTab();const a=e(`.adeptus-report-row[data-report-slug="${r}"]`);a.length>0?a.trigger("click"):d.fetchAndDisplayReport(r)}))},100)},sendReportMessage:function(e){const t=`ðŸ“Š Report saved: ${e.description||e.name}`,a={id:Date.now(),sender_type:"ai",body:t,timestamp:(new Date).toISOString(),metadata:{type:"report",report_slug:e.slug,report_name:e.name||e.description,report_description:e.description}};this.displayReportLink(a)},confirmReport:function(t,a,s){const r=this;this.showLoading();const n=i.getAuthStatus(),o=n?.user||{},d={name:a.name||a.description||"Generated Report",description:a.description||"",sql:a.sql||"",category:a.category||"general",category_id:a.category_id||null},l=parseInt(this.currentChatId)||0;this.ajaxWithAuth({url:this.backendUrl+"/chat/report-confirmation",method:"POST",contentType:"application/json",timeout:9e4,data:JSON.stringify({chat_id:l,action:t,feedback:s||null,report:d,user_id:o.id||null}),success:n=>{if(this.hideLoading(),"accept"===t&&n.report){Array.isArray(this.cachedReports)||(this.cachedReports=[]),this.cachedReports.unshift(n.report),this.updateReportsHistory(this.cachedReports);const t=n.report.name||a.name||a.description||"AI Generated Report";this.trackReportCreated(t),this.sendReportMessage(n.report),e("#report-history-loader").addClass("d-none"),e("#report-history-table-wrapper").removeClass("d-none"),e("#reports-history-table").removeClass("d-none"),document.querySelectorAll(".adeptus-report-action-container").forEach(e=>{e.innerHTML='\n                                <div style="text-align: center; color: #28a745; padding: 10px;">\n                                    <i class="fa fa-check-circle"></i> Report saved successfully!\n                                </div>\n                            '})}else if(n.chat_response){const e=n.chat_response;if(e.error||e.message&&(e.message.toLowerCase().includes("trouble connecting")||e.message.toLowerCase().includes("service")||e.message.toLowerCase().includes("try again"))){const n=e.message||"The AI service is temporarily unavailable.";document.querySelectorAll(".adeptus-report-action-container").forEach(e=>{const i="retry-feedback-"+Date.now();e.innerHTML=`\n                                        <div style="text-align: center; padding: 10px;">\n                                            <div style="color: #dc3545; margin-bottom: 10px;">\n                                                <i class="fa fa-exclamation-circle"></i> ${n}\n                                            </div>\n                                            <button id="${i}" class="btn btn-primary btn-sm">\n                                                <i class="fa fa-refresh"></i> Retry\n                                            </button>\n                                        </div>\n                                    `;const o=document.getElementById(i);o&&o.addEventListener("click",function(){r.confirmReport(t,a,s)})}),this.addMessage(n,"error")}else{const i=e.type&&("sql"===e.type||"report"===e.type)&&e.report&&e.awaiting_confirmation;e.message&&(e.message.toLowerCase().includes("report generated")||e.message.toLowerCase().includes("generated a report")||e.message.toLowerCase().includes("i've generated"))&&!i?(document.querySelectorAll(".adeptus-report-action-container").forEach(e=>{const n="retry-ghost-"+Date.now();e.innerHTML=`\n                                            <div style="text-align: center; padding: 10px;">\n                                                <div style="color: #856404; background: #fff3cd; padding: 12px; border-radius: 6px; margin-bottom: 10px;">\n                                                    <i class="fa fa-exclamation-triangle"></i>\n                                                    The refined report was generated but could not be displayed properly.\n                                                </div>\n                                                <button id="${n}" class="btn btn-primary btn-sm">\n                                                    <i class="fa fa-refresh"></i> Try Again\n                                                </button>\n                                            </div>\n                                        `;const i=document.getElementById(n);i&&i.addEventListener("click",function(){r.confirmReport(t,a,s)})}),this.addMessage("The report refinement encountered an issue. Please try again using the button above, or start a new request.","system")):i?(document.querySelectorAll(".adeptus-report-action-container").forEach(e=>{e.innerHTML='\n                                            <div style="text-align: center; color: #007bff;">\n                                                <i class="fa fa-info-circle"></i> Feedback sent. I\'ll refine the report based on your input.\n                                            </div>\n                                        '}),this.handleResponse(n.chat_response)):(document.querySelectorAll(".adeptus-report-action-container").forEach(e=>{e.innerHTML='\n                                            <div style="text-align: center; color: #007bff;">\n                                                <i class="fa fa-info-circle"></i> Feedback sent.\n                                            </div>\n                                        '}),this.handleResponse(n.chat_response))}}else document.querySelectorAll(".adeptus-report-action-container").forEach(e=>{e.innerHTML='\n                                    <div style="text-align: center; color: #007bff;">\n                                        <i class="fa fa-info-circle"></i> Feedback sent.\n                                    </div>\n                                '})},error:(e,n)=>{this.hideLoading();let i="Failed to process request. Please try again.",o=!0;if("timeout"===n)i="Request timed out. The AI service may be busy. Please try again.";else if(0===e.status)i="Network error. Please check your connection and try again.";else if(401===e.status)i="Session expired. Please refresh the page and log in again.",o=!1;else if(429===e.status)i="Too many requests. Please wait a moment and try again.";else if(e.status>=500)i="Server error. Please try again in a moment.";else if(e.responseJSON&&e.responseJSON.errors){const t=e.responseJSON.errors,a=Object.keys(t).map(e=>`${e}: ${t[e].join(", ")}`).join("; ");i=`Validation failed: ${a}`,o=!1}else e.responseJSON&&e.responseJSON.message&&(i=e.responseJSON.message);document.querySelectorAll(".adeptus-report-action-container").forEach(e=>{const n="retry-error-"+Date.now();let d="";if(o&&(d=`\n                                <button id="${n}" class="btn btn-outline-primary btn-sm" style="margin-top: 10px;">\n                                    <i class="fa fa-refresh"></i> Try Again\n                                </button>\n                            `),e.innerHTML=`\n                            <div style="text-align: center; padding: 10px;">\n                                <div style="color: #dc3545;">\n                                    <i class="fa fa-exclamation-triangle"></i> ${i}\n                                </div>\n                                ${d}\n                            </div>\n                        `,o){const e=document.getElementById(n);e&&e.addEventListener("click",function(){r.confirmReport(t,a,s)})}})}})},switchToReportsTab:function(){setTimeout(()=>{e(".datatable-wrapper").removeClass("datatable-loading"),e("#report-history-table-wrapper .datatable-wrapper").removeClass("datatable-loading")},200),e("#reports-tab").tab("show"),e("#assistant-tab").removeClass("active").attr("aria-selected","false"),e("#reports-tab").addClass("active").attr("aria-selected","true"),e("#assistant-panel").removeClass("show active"),e("#reports-panel").addClass("show active"),e(".adeptus-report-view-title").text("Select a Report"),e(".adeptus-report-view-body").html('<div class="text-center py-4"><p class="text-muted">Select a report from history to view details here.</p></div>'),!this.cachedReports||Array.isArray(this.cachedReports)&&0===this.cachedReports.length&&!this.reportsLoaded?this.loadReportsHistory():(e("#report-history-loader").addClass("d-none"),e("#report-history-table-wrapper").removeClass("d-none"),this.cachedReports&&this.updateReportsHistory(this.cachedReports))},loadReportsHistory:function(t){this.cachedReports||(this.cachedReports=[]),e("#report-history-loader").removeClass("d-none"),e("#report-history-table-wrapper").addClass("d-none"),this.ajaxWithAuth({url:this.backendUrl+"/ai-reports",method:"GET",timeout:1e4,success:a=>{const s=a.reports||a.data||[];this.cachedReports=Array.isArray(s)?s:[],this.reportsLoaded=!0,this.updateReportsHistory(this.cachedReports),e("#report-history-loader").addClass("d-none"),e("#report-history-table-wrapper").removeClass("d-none"),this.reportsDataTable&&(this.reportsDataTable.destroy(),this.reportsDataTable=null),setTimeout(()=>{try{const t=document.getElementById("reports-history-table");if(!t)return;const a=t.querySelector("tbody"),s=t.querySelector("thead");if(s&&a&&s.rows.length>0&&s.rows[0].cells.length>0){this.reportsDataTable&&(this.reportsDataTable.destroy(),this.reportsDataTable=null);const t=s.rows[0].cells.length,r=a.rows;let n=0;r.length>0&&(n=r[0].cells.length),t===n&&t>0&&r.length>0&&!r[0].cells[0].textContent.includes("No reports")&&(this.reportsDataTable=new simpleDatatables.DataTable("#reports-history-table",{searchable:!0,fixedHeight:!1,perPage:10,loading:!1}),setTimeout(()=>{e(".datatable-wrapper").removeClass("datatable-loading"),e("#report-history-table-wrapper .datatable-wrapper").removeClass("datatable-loading"),e(".dataTable-loading").remove()},100))}}catch(e){}"function"==typeof t&&t()},100)},error:(a,s)=>{e("#report-history-loader").addClass("d-none"),e("#report-history-table-wrapper").removeClass("d-none");const r=e("#reports-history-table tbody");r.empty(),"timeout"===s?r.append('<tr><td colspan="3" class="text-center text-warning">Loading reports timed out. Please refresh the page.</td></tr>'):401===a.status||403===a.status?r.append('<tr><td colspan="3" class="text-center text-danger">Authentication error. Please log in again.</td></tr>'):this.cachedReports&&this.cachedReports.length>0?this.updateReportsHistory(this.cachedReports):r.append('<tr><td colspan="3" class="text-center text-muted">Unable to load reports. Please try again later.</td></tr>'),"function"==typeof t&&t()}})},updateReportsHistory:function(t){const a=e("#reports-history-table tbody"),s=this;if(a.empty(),!t||0===t.length){const e=i.getAuthStatus();return void(e&&e.subscription&&e.subscription.reports_generated_this_month>0?a.append(`<tr><td colspan="3" class="text-center text-muted">${l("no_reports","No reports yet")}</td></tr>`):a.append(`\n                        <tr>\n                            <td colspan="3" class="text-center text-muted">\n                                <div class="py-4">\n                                    <i class="fa fa-chart-bar fa-2x mb-2"></i>\n                                    <p class="mb-1">${l("no_reports_generated","No reports generated yet")}</p>\n                                    <small>${l("ask_ai_create_reports","Ask the AI assistant to create reports for you")}</small>\n                                </div>\n                            </td>\n                        </tr>\n                    `))}t.forEach(t=>{const r=s.getStatusBadge(t.status),n=new Date(t.created_at).toLocaleDateString(),i=e(`\n                    <tr class="adeptus-report-row" data-report-slug="${t.slug}">\n                        <td>${t.description}</td>\n                        <td>${n}</td>\n                        <td>${r}</td>\n                    </tr>`);a.append(i)}),e("#report-history-table-wrapper").off("click",".adeptus-report-row"),e("#report-history-table-wrapper").on("click",".adeptus-report-row",function(){const t=e(this),a=t.data("report-slug"),r=s.cachedReports.find(e=>e.slug===a);if(!r)return;e("#report-history-loader").addClass("d-none"),e("#report-history-table-wrapper").removeClass("d-none");if(e("#reports-panel .col-md-8 .card-body").find(".adeptus-report-display-wrapper").html('<div class="w-100 d-flex justify-content-center align-items-center" style="min-height:200px"><div class="spinner-border text-primary" role="status"></div></div>'),Array.isArray(s.cachedReports)&&s.cachedReports.length>0){const e=s.cachedReports.find(e=>e.slug===r.slug);e&&e.data&&Array.isArray(e.data)&&e.data.length>0?setTimeout(()=>{s.updateReportsView(e,e.data)},300):s.fetchAndDisplayReport(r.slug,t)}else s.fetchAndDisplayReport(r.slug,t);e(".adeptus-report-row").removeClass("table-primary"),t.addClass("table-primary")})},fetchAndDisplayReport:function(t,a){const s=this,r=e("#reports-panel .col-md-8 .card-body");e("#report-history-loader").addClass("d-none"),e("#report-history-table-wrapper").removeClass("d-none"),r.html('<div class="adeptus-report-display-wrapper w-100"><div class="w-100 d-flex justify-content-center align-items-center" style="min-height:200px"><div class="spinner-border text-primary" role="status"></div></div></div>'),this.ajaxWithAuth({url:`${this.backendUrl}/ai-reports/${t}`,method:"GET",success:e=>{const t=e.report;if(e.data&&Array.isArray(e.data)&&e.data.length>0)return void s.displayFetchedReport(t,e.data,a);const n=e.sql||t&&t.sql_query||t&&t.sql;n?s.executeReportLocally(n,t?.params||{}).then(e=>{e.error?r.find(".adeptus-report-display-wrapper").html(`<div class="w-100 text-center text-danger py-4">\n                                            <i class="fa fa-exclamation-triangle"></i>\n                                            Failed to execute report: ${e.error}\n                                        </div>`):e.data&&0!==e.data.length?s.displayFetchedReport(t,e.data,a):r.find(".adeptus-report-display-wrapper").html('<div class="w-100 text-center text-warning py-4"><i class="fa fa-info-circle"></i> Report executed successfully but returned no data.</div>')}).catch(e=>{r.find(".adeptus-report-display-wrapper").html(`<div class="w-100 text-center text-danger py-4">\n                                        <i class="fa fa-exclamation-triangle"></i>\n                                        Failed to execute report: ${e.message}\n                                    </div>`)}):r.find(".adeptus-report-display-wrapper").html('<div class="w-100 text-center text-warning py-4"><i class="fa fa-exclamation-triangle"></i> Report has no data or SQL to execute.</div>')},error:()=>{r.find(".adeptus-report-display-wrapper").html('<div class="w-100 text-center text-danger py-4">Failed to load report. Please try again.</div>')}})},displayFetchedReport:function(t,a,s){Array.isArray(this.cachedReports)||(this.cachedReports=[]);let r=this.cachedReports.findIndex(e=>e.slug===t.slug);r>-1?this.cachedReports[r]=Object.assign({},t,{data:a}):this.cachedReports.push(Object.assign({},t,{data:a})),this.currentViewedReport=t,this.currentViewedReportData=a,this.updateReportsView(t,a),e(".adeptus-report-row").removeClass("table-primary"),s&&s.addClass("table-primary")},displayCurrentReport:function(t){this.updateReportsView(t),e(`.adeptus-report-row[data-report-slug="${t.slug}"]`).addClass("table-primary")},displayReport:function(t){const a=this.cachedReports.find(e=>e.slug===t);a&&(this.updateReportsView(a,a.data),e(".adeptus-report-row").removeClass("table-primary"),e(`.adeptus-report-row[data-report-slug="${t}"]`).addClass("table-primary"))},updateReportsView:function(t,a=null){const s=this;if(s.currentViewedReport=t,s.currentViewedReportData=a,s.reportChartInstance&&(s.reportChartInstance.destroy(),s.reportChartInstance=null),s.reportGraphInstance&&(s.reportGraphInstance.destroy(),s.reportGraphInstance=null),s._vteController&&"function"==typeof s._vteController.destroy){try{s._vteController.destroy()}catch(e){}s._vteController=null}const r=e("#reports-panel .col-md-8 .card-body");if(0===e("#display-type-icon-style").length&&e("head").append('\n                    <style id="display-type-icon-style">\n                        /* View toggle buttons */\n                        .adeptus-view-toggle .adeptus-view-toggle-btn {\n                            background: #f8f9fa;\n                            border: 1px solid #dee2e6;\n                            color: #495057;\n                            padding: 0.35rem 0.75rem;\n                            font-size: 13px;\n                            transition: all 0.2s ease;\n                        }\n                        .adeptus-view-toggle .adeptus-view-toggle-btn:first-child {\n                            border-radius: 6px 0 0 6px;\n                        }\n                        .adeptus-view-toggle .adeptus-view-toggle-btn:last-child {\n                            border-radius: 0 6px 6px 0;\n                        }\n                        .adeptus-view-toggle .adeptus-view-toggle-btn:hover {\n                            background: #e9ecef;\n                        }\n                        .adeptus-view-toggle .adeptus-view-toggle-btn.active {\n                            background: #2563eb;\n                            border-color: #2563eb;\n                            color: white;\n                        }\n                        .adeptus-view-toggle .adeptus-view-toggle-btn i {\n                            margin-right: 5px;\n                        }\n\n                        /* Chart controls wrapper */\n                        .adeptus-chart-controls-wrapper {\n                            background: #f8f9fa;\n                            border-radius: 8px;\n                            padding: 1rem;\n                            border: 1px solid #e9ecef;\n                        }\n                        .adeptus-chart-controls {\n                            display: flex;\n                            align-items: flex-end;\n                            flex-wrap: wrap;\n                        }\n                        .adeptus-chart-controls .adeptus-control-group {\n                            display: flex;\n                            flex-direction: column;\n                            gap: 0.25rem;\n                        }\n                        .adeptus-chart-controls .form-label {\n                            font-size: 11px;\n                            font-weight: 600;\n                            color: #6c757d;\n                            margin-bottom: 0;\n                            text-transform: uppercase;\n                            letter-spacing: 0.5px;\n                        }\n                        .adeptus-chart-controls .form-select {\n                            font-size: 13px;\n                            padding: 0.4rem 2rem 0.4rem 0.75rem;\n                            border-radius: 6px;\n                            border: 1px solid #dee2e6;\n                            background-color: white;\n                            min-width: 140px;\n                        }\n                        .adeptus-chart-controls .form-select:focus {\n                            border-color: #2563eb;\n                            box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.15);\n                        }\n\n                        /* Legacy icon button styles */\n                        .btn-icon {\n                            transition: transform 0.15s cubic-bezier(.4,2,.6,1), background 0.2s, border 0.2s;\n                            background: #f8f9fa;\n                            border: 1.5px solid #e0e0e0;\n                            color: #333;\n                        }\n                        .btn-icon:hover {\n                            transform: scale(1.15);\n                            background: #e9ecef;\n                            border-color: #b3d7ff;\n                            color: #007bff;\n                            z-index: 2;\n                        }\n                        .btn-icon.active, .btn-icon:focus {\n                            background: #e3f0ff;\n                            border-color: #007bff;\n                            color: #007bff;\n                            box-shadow: 0 0 0 2px #b3d7ff33;\n                        }\n                    </style>\n                '),e(".adeptus-report-view-title").text(t.description),!Array.isArray(a)||0===a.length)return void r.find(".adeptus-report-display-wrapper").html('<div class="w-100 text-center text-muted py-4">No data available for this report.</div>');const n=Object.keys(a[0]||{}),i=this.detectNumericColumns(a,n);let o='<div class="adeptus-chart-controls-wrapper mb-3">';o+='<div class="adeptus-chart-controls d-flex flex-wrap align-items-end gap-3">',o+='<div class="adeptus-control-group">',o+='<label for="report-chart-type" class="form-label">Chart Type</label>',o+='<select id="report-chart-type" class="form-select form-select-sm">',o+='<option value="bar">Bar Chart</option>',o+='<option value="line">Line Chart</option>',o+='<option value="pie">Pie Chart</option>',o+='<option value="doughnut">Doughnut Chart</option>',o+="</select></div>",o+='<div class="adeptus-control-group">',o+='<label for="report-chart-x-axis" class="form-label">X-Axis (Labels)</label>',o+='<select id="report-chart-x-axis" class="form-select form-select-sm">',n.forEach((e,t)=>{const a=e.replace(/_/g," ").replace(/\b\w/g,e=>e.toUpperCase());o+=`<option value="${e}"${0===t?" selected":""}>${a}</option>`}),o+="</select></div>",o+='<div class="adeptus-control-group">',o+='<label for="report-chart-y-axis" class="form-label">Y-Axis (Values)</label>',o+='<select id="report-chart-y-axis" class="form-select form-select-sm">',i.length>0?i.forEach((e,t)=>{const a=e.replace(/_/g," ").replace(/\b\w/g,e=>e.toUpperCase()),s=t===i.length-1?" selected":"";o+=`<option value="${e}"${s}>${a}</option>`}):n.forEach((e,t)=>{const a=e.replace(/_/g," ").replace(/\b\w/g,e=>e.toUpperCase()),s=t===n.length-1?" selected":"";o+=`<option value="${e}"${s}>${a}</option>`}),o+="</select></div>",o+="</div></div>";const d=s.isFreePlan?" adeptus-export-premium":"",l=s.isFreePlan?' <i class="fa fa-crown text-warning" style="font-size: 10px;"></i>':"";let c=`\n                <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap">\n                    <div class="adeptus-action-buttons d-flex gap-2">\n                        <button class="btn btn-outline-danger btn-sm adeptus-export-pdf-btn">\n                            <i class="fa fa-file-pdf-o me-1"></i>Export PDF\n                        </button>\n                        <button class="btn btn-outline-secondary btn-sm adeptus-export-csv-btn${d} mr-10">\n                            <i class="fa fa-download me-1"></i>Export CSV${l}\n                        </button>\n                        <button class="btn btn-outline-secondary btn-sm adeptus-export-json-btn${d}">\n                            <i class="fa fa-code me-1"></i>Export JSON${l}\n                        </button>\n                    </div>\n                    <div class="adeptus-view-toggle btn-group" role="group">\n                        <button type="button" class="btn btn-sm adeptus-view-toggle-btn${"chart"!==t.display_type?" active":""}" data-type="table"><i class="fa fa-table"></i> Table</button>\n                        <button type="button" class="btn btn-sm adeptus-view-toggle-btn${"chart"===t.display_type?" active":""}" data-type="chart"><i class="fa fa-bar-chart"></i> Chart</button>\n                    </div>\n                </div>\n            `;const p="chart"===t.display_type;let u='<div class="adeptus-report-display-area w-100">';u+=`<div class="adeptus-report-view-panel${p?" d-none":""}" data-type="table">`,u+=this.renderReportData(a),u+="</div>",u+=`<div class="adeptus-report-view-panel${p?"":" d-none"}" data-type="chart">`,u+=o,u+='<div class="adeptus-chart-container" style="position: relative; height: 400px; border: 1px solid #e9ecef; border-radius: 8px; padding: 1rem; background: #fff;">',u+='<canvas id="reportChart"></canvas>',u+="</div></div>",u+="</div>",r.html(`\n                ${c}\n                <div class="adeptus-report-display-wrapper w-100 position-relative">\n                    ${u}\n                </div>\n            `),s._currentReportData=a,s._currentReportName=t.description||t.name||"Report",s._currentReportView="chart"===t.display_type?"chart":"table",this._pendingTableId&&"chart"!==t.display_type&&setTimeout(()=>{if(document.getElementById(this._pendingTableId)&&window.VTE)try{this._vteController=window.VTE.enhance("#"+this._pendingTableId,{perPage:10,perPageOptions:[10,25,50,100],labels:{search:"Search",rows:"Rows per page",info:(e,t,a)=>`Showing ${e}â€“${t} of ${a} entries`,noData:"No matching records found"}})[0]}catch(e){}this._pendingTableId=null},100),"chart"===t.display_type&&setTimeout(()=>{s.renderReportChartFromSelectors(a,s._currentReportName)},100),r.find(".adeptus-view-toggle-btn").on("click",function(){const a=e(this).data("type");r.find(".adeptus-view-toggle-btn").removeClass("active"),e(this).addClass("active"),s._currentReportView=a,r.find(".adeptus-report-view-panel").addClass("d-none"),r.find(`.adeptus-report-view-panel[data-type="${a}"]`).removeClass("d-none"),"table"===a&&!s._vteController&&s._pendingTableId&&setTimeout(()=>{if(document.getElementById(s._pendingTableId)&&window.VTE)try{s._vteController=window.VTE.enhance("#"+s._pendingTableId,{perPage:10,perPageOptions:[10,25,50,100],labels:{search:"Search",rows:"Rows per page",info:(e,t,a)=>`Showing ${e}â€“${t} of ${a} entries`,noData:"No matching records found"}})[0]}catch(e){}},100),"chart"===a&&setTimeout(()=>{s.renderReportChartFromSelectors(s._currentReportData,s._currentReportName)},100),a!==t.display_type?0===r.find(".adeptus-save-display-type-btn").length&&(r.find(".adeptus-view-toggle").after('<button class="btn btn-sm btn-outline-primary adeptus-save-display-type-btn ms-2"><i class="fa fa-save"></i> Save View</button>'),r.find(".adeptus-save-display-type-btn").on("click",function(){s.saveDisplayType(t.slug,a)})):r.find(".adeptus-save-display-type-btn").remove()}),r.find("#report-chart-type, #report-chart-x-axis, #report-chart-y-axis").on("change",function(){s.renderReportChartFromSelectors(s._currentReportData,s._currentReportName)}),r.find(".adeptus-export-pdf-btn").on("click",()=>s.exportReport(t.slug,"pdf")),r.find(".adeptus-export-csv-btn").on("click",function(){e(this).hasClass("adeptus-export-premium")?s.showExportUpgradePrompt("csv"):s.exportReport(t.slug,"csv")}),r.find(".adeptus-export-json-btn").on("click",function(){e(this).hasClass("adeptus-export-premium")?s.showExportUpgradePrompt("json"):s.exportReport(t.slug,"json")})},linkifyUrls:function(e){if(!e||"string"!=typeof e)return e||"";return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/(\bhttps?:\/\/[^\s<>"']+)/gi,function(e){const t=e.length>50?e.substring(0,47)+"...":e;return`<a href="${e}" target="_blank" rel="noopener noreferrer" class="adeptus-report-url-link" title="${e}">${t}</a>`})},formatCellValue:function(e,t){if(null==e||""===e)return"";const a=String(e),s=(t||"").toLowerCase();return s.includes("url")||s.includes("link")||s.includes("profile")||s.includes("href")||a.match(/^https?:\/\//i)?this.linkifyUrls(a):String(a).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")},renderReportData:function(e){if(!e||0===e.length)return'<p class="text-muted">No data available.</p>';const t=this,a=Object.keys(e[0]),s="enhanced-report-table-"+Date.now();let r=`<div class="table-responsive"><table id="${s}" class="table table-striped table-hover">`;return r+="<thead><tr>",a.forEach(t=>{const a=e.every(e=>{const a=e[t];return null==a||""===a||!isNaN(parseFloat(a))}),s=!a&&e.some(e=>{const a=e[t];return a&&!isNaN(Date.parse(a))});r+=`<th${a?' data-vte="number"':s?' data-vte="date"':""}>${t.replace(/_/g," ").replace(/\b\w/g,e=>e.toUpperCase())}</th>`}),r+="</tr></thead>",r+="<tbody>",e.forEach(e=>{r+="<tr>",a.forEach(a=>{const s=t.formatCellValue(e[a],a);r+=`<td>${s}</td>`}),r+="</tr>"}),r+="</tbody></table></div>",this._pendingTableId=s,r},getStatusBadge:function(e){return`<span class="badge ${this.getStatusBadgeClass(e)}" style="color: white;">${e}</span>`},getStatusBadgeClass:function(e){switch(e){case"completed":case"ready":return"bg-success";case"processing":return"bg-warning text-dark";case"pending":return"bg-info";case"failed":case"error":return"bg-danger";default:return"bg-secondary"}},executeReport:function(t){const a=this,s=e(`.adeptus-report-row[data-report-slug="${t}"]`),r=s.html();s.html('<td colspan="3" class="text-center"><div class="spinner-border spinner-border-sm text-primary" role="status"><span class="visually-hidden">Executing...</span></div> Executing report...</td>'),this.ajaxWithAuth({url:`${this.backendUrl}/ai-reports/${t}`,method:"GET",success:e=>{const n=e.report,i=e.sql||n&&n.sql_query||n&&n.sql;if(!i)return s.html(r),void this.showError("Report SQL not found. Please regenerate the report.");e.data&&Array.isArray(e.data)&&e.data.length>0?a.handleExecutionSuccess(t,n,e.data,s):a.executeReportLocally(i,n?.params||{}).then(e=>{if(e.error)return s.html(r),void a.showError("Failed to execute report: "+e.error);a.handleExecutionSuccess(t,n,e.data,s)}).catch(e=>{s.html(r),a.showError("Failed to execute report: "+e.message)})},error:(e,t,a)=>{s.html(r);let n="Failed to fetch report";404===e.status?n="Report not found.":403===e.status?n="You do not have permission to view this report.":e.responseJSON&&e.responseJSON.error?n=e.responseJSON.error:n+=": "+a,this.showError(n)}})},handleExecutionSuccess:function(t,a,s,r){if(Array.isArray(this.cachedReports)){const e=this.cachedReports.findIndex(e=>e.slug===t);-1!==e?this.cachedReports[e]=Object.assign({},this.cachedReports[e],a,{data:s}):this.cachedReports.push(Object.assign({},a,{data:s}))}this.currentViewedReport=a,this.currentViewedReportData=s,this.updateReportsView(a,s),e(".adeptus-report-row").removeClass("table-primary"),r&&r.addClass("table-primary"),this.showSuccess("Report executed successfully!")},executeReportLocally:function(e,a={}){var s=this;return new Promise((r,n)=>{s.showLoading(),t.call([{methodname:"report_adeptus_insights_execute_ai_report",args:{sql:e,params:JSON.stringify(a)}}])[0].done(function(e){s.hideLoading();var t=e;if(t.success){var a=t.data,n=t.headers;if("string"==typeof a)try{a=JSON.parse(a)}catch(e){a=[]}if("string"==typeof n)try{n=JSON.parse(n)}catch(e){n=[]}r({data:a||[],headers:n||[],row_count:t.row_count||0,error:null})}else r({data:null,headers:[],row_count:0,error:t.message||"Query execution failed"})}).fail(function(e){s.hideLoading();var t=e.message||"Failed to execute report locally";n(new Error(t))})})},showExportUpgradePrompt:function(e){const t=`${M.cfg.wwwroot}/report/adeptus_insights/subscription.php`,a={csv:"CSV",excel:"Excel",json:"JSON"}[e]||e.toUpperCase();o.fire({title:l("export_premium_feature","Premium Export Format"),html:`<div style="text-align: center; padding: 20px;">\n                    <div style="font-size: 48px; color: #f39c12; margin-bottom: 15px;">\n                        <i class="fa fa-crown"></i>\n                    </div>\n                    <h3 style="color: #2c3e50; margin-bottom: 15px;">${l("export_is_premium",a+" Export is a Premium Feature").replace("{$a}",a)}</h3>\n                    <p style="color: #7f8c8d; font-size: 16px; line-height: 1.6; margin-bottom: 25px;">\n                        ${l("export_premium_desc","Export to "+a+" format is only available with a paid subscription plan. Upgrade now to unlock all export formats and advanced features.").replace("{$a}",a)}\n                    </p>\n                    <div style="background: #ecf0f1; padding: 15px; border-radius: 8px; margin-bottom: 20px;">\n                        <p style="margin: 0; font-size: 14px; color: #34495e;">\n                            <strong>${l("free_plan_label","Free Plan:")}</strong> ${l("free_plan_exports","PDF exports only")}<br>\n                            <strong>${l("paid_plans_label","Paid Plans:")}</strong> ${l("paid_plan_exports","CSV, Excel, JSON, and PDF exports")}\n                        </p>\n                    </div>\n                </div>`,showCancelButton:!0,confirmButtonText:'<i class="fa fa-arrow-up"></i> '+l("upgrade_now","Upgrade Now"),cancelButtonText:'<i class="fa fa-times"></i> '+l("cancel","Cancel"),confirmButtonColor:"#3498db",cancelButtonColor:"#95a5a6",width:500}).then(e=>{e.isConfirmed&&window.open(t,"_blank")})},checkExportEligibility:async function(e){try{var a=t.call([{methodname:"report_adeptus_insights_check_export_eligibility",args:{format:e}}]),s=await a[0];return s.data?s.data:s}catch(e){return{success:!1,eligible:!1,message:"Unable to verify export eligibility."}}},captureChartImage:async function(){const e=this;await new Promise(e=>setTimeout(e,300));const t=document.getElementById("reportChart");if(!t)return null;try{const e=t.toDataURL("image/png",.8);if(e&&e.length>100&&e.length<2e6)return e}catch(e){}try{if(window.html2canvas||await e.loadHtml2Canvas(),window.html2canvas){const e=(await window.html2canvas(t,{backgroundColor:"#ffffff",scale:1.5,useCORS:!0,allowTaint:!0,logging:!1})).toDataURL("image/png",.8);if(e&&e.length>100&&e.length<2e6)return e}}catch(e){}return null},loadHtml2Canvas:function(){return new Promise((e,t)=>{if(window.html2canvas)return void e();const a=document.createElement("script");a.src=M.cfg.wwwroot+"/report/adeptus_insights/lib/html2canvas/html2canvas.min.js",a.onload=()=>e(),a.onerror=()=>t(new Error("Failed to load html2canvas")),document.head.appendChild(a)})},exportReport:async function(e,t){const a=this;o.fire({title:`Exporting as ${t.toUpperCase()}...`,allowOutsideClick:!1,didOpen:()=>o.showLoading()});try{const s=await a.checkExportEligibility(t);if(!s.success||!s.eligible)return o.close(),void(a.isFreePlan&&"pdf"!==t?a.showExportUpgradePrompt(t):o.fire({icon:"error",title:l("export_not_available","Export Not Available"),text:s.message||l("not_eligible_export","You are not eligible to export in this format.")}));let r=`reportid=${encodeURIComponent(e)}&format=${t}&sesskey=${M.cfg.sesskey}`;if(r+=`&view=${a._currentReportView}`,a.currentViewedReportData&&Array.isArray(a.currentViewedReportData)){const e=a.currentViewedReportData.length>0?Object.keys(a.currentViewedReportData[0]):[],t={results:a.currentViewedReportData,headers:e};r+=`&report_data=${encodeURIComponent(JSON.stringify(t))}`}if("pdf"===t&&"chart"===a._currentReportView)try{const e=a.captureChartImage(),t=new Promise((e,t)=>{setTimeout(()=>t(new Error("Chart capture timeout")),1e4)}),s=await Promise.race([e,t]);s&&s.length>100&&(r+=`&chart_image=${encodeURIComponent(s)}`)}catch(e){}const n=await fetch(`${M.cfg.wwwroot}/report/adeptus_insights/download.php`,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:r}),i=n.headers.get("content-type"),d=n.headers.get("content-disposition");if(i&&i.includes("application/json")&&!d){const e=await n.json();throw new Error(e.message||"Export failed")}if(!n.ok)throw new Error(`Export failed with status: ${n.status}`);const c=(a.currentViewedReport?.description||a.currentViewedReport?.name||"report").replace(/[^a-zA-Z0-9\s-]/g,"").replace(/\s+/g,"_").toLowerCase(),p=(new Date).toISOString().split("T")[0],u=await n.blob(),h=window.URL.createObjectURL(u),g=document.createElement("a");g.href=h,g.download=`${c}_${p}.${t}`,document.body.appendChild(g),g.click(),window.URL.revokeObjectURL(h),document.body.removeChild(g),o.close(),a.showSuccess(`${t.toUpperCase()} file downloaded successfully!`),await a.trackExport(t,e)}catch(e){o.close(),a.showError(e.message||"Failed to export report.")}},trackExport:async function(e,a){try{var s=t.call([{methodname:"report_adeptus_insights_track_export",args:{format:e,report_name:a}}]);await s[0]}catch(e){}},openReportFromLink:function(t){this.switchToReportsTab(),this.updateReportsHistory(this.cachedReports),e(".adeptus-report-row").removeClass("table-primary");const a=e(`.adeptus-report-row[data-report-slug="${t}"]`);a.addClass("table-primary");const s=this.cachedReports.find(e=>e.slug===t);s&&s.data&&Array.isArray(s.data)&&s.data.length>0?this.updateReportsView(s,s.data):this.fetchAndDisplayReport(t,a)},formatTimestamp:function(e){const t=e instanceof Date?e:new Date(e),a=new Date,s=e=>e.toString().padStart(2,"0"),r=`${s(t.getHours())}:${s(t.getMinutes())}`;if(t.getFullYear()!==a.getFullYear()){const e=t.toLocaleString("default",{month:"long"});return`${t.getDate()} ${e} ${t.getFullYear()} - ${r}`}if(t.toDateString()===a.toDateString())return r;const n=new Date(a.getFullYear(),a.getMonth(),a.getDate()-1);if(t.toDateString()===n.toDateString()){return`${t.toLocaleString("default",{weekday:"long"})} - ${r}`}const i=t.toLocaleString("default",{month:"long"});return`${t.getDate()} ${i} - ${r}`},updateChatHistoryBadge:function(t){const a=e(`#chat-history-list li.adeptus-chat-history-item[data-chat-id="${t}"]`);if(!a.length)return;let s=a.find(".adeptus-report-count");if(s.length){const e=parseInt(s.text(),10)||0;s.text(e+1)}else{const t=e('<span class="badge bg-primary d-flex align-items-center adeptus-report-count" style="color: white;"><i class="fa fa-chart-bar me-1"></i>1</span>');a.append(t)}},saveDisplayType:function(t,a){o.fire({title:l("saving_default_view","Saving default view..."),allowOutsideClick:!1,didOpen:()=>o.showLoading()}),this.ajaxWithAuth({url:`${this.backendUrl}/ai-reports/${t}/display-type`,method:"POST",contentType:"application/json",data:JSON.stringify({display_type:a}),success:()=>{o.fire({icon:"success",title:l("default_view_saved","Default view saved"),showConfirmButton:!1,timer:1500});const s=this.cachedReports.find(e=>e.slug===t);s&&(s.display_type=a),e(".adeptus-save-display-type-btn").remove()},error:()=>{o.fire({icon:"error",title:l("save_failed","Save failed"),text:l("could_not_save_view","Could not save default view. Please try again.")})}})},showResendIconOnMessage:function(t,a){if(!t||!t.length)return;t.siblings(".adeptus-failed-reload-icon").remove();const s=e('\n                    <i class="fa fa-refresh adeptus-failed-reload-icon text-danger"\n                   title="Retry sending this message"\n                       style="cursor:pointer; float:left; margin-right:0.5rem;"></i>\n                ');t.after(s),s.on("click",()=>{s.remove(),this.resendMessage(t,a)})},showResendIconOnLastUserMessage:function(){const t=e("#adeptus-chat-container .adeptus-user-message:last");if(t.length){const e=t.find(".adeptus-message-text").text();this.showResendIconOnMessage(t,e)}},showCompareDataModal:function(t){const a=this,r=t.slug;let n=[],i=null,d=null,c=null,p=!1,u=!1,h=null,g="table",m="table",f=null,b=null,y=!1,_="a";function v(e,t,s){"a"===t&&(p=!0),"b"===t&&(u=!0),k(),a.ajaxWithAuth({url:`${this.backendUrl}/ai-reports/${r}/snapshots/${e}`,method:"GET",success:function(a){"a"===t?(f=a.data,d=e,p=!1):(b=a.data,c=e,u=!1),k(),s&&s()},error:function(){h="Failed to fetch snapshot data.","a"===t&&(p=!1),"b"===t&&(u=!1),k(),s&&s()}})}function x(e){if(!e)return{bg:"#f8f9fa",border:"#dee2e6",text:"#6c757d"};const t=n.findIndex(t=>t.id===e);if(-1===t)return{bg:"#f8f9fa",border:"#dee2e6",text:"#6c757d"};const a=[{bg:"#e3f2fd",border:"#2196f3",text:"#1976d2"},{bg:"#f3e5f5",border:"#9c27b0",text:"#7b1fa2"},{bg:"#e8f5e8",border:"#4caf50",text:"#388e3c"},{bg:"#fff3e0",border:"#ff9800",text:"#f57c00"},{bg:"#fce4ec",border:"#e91e63",text:"#c2185b"},{bg:"#e0f2f1",border:"#009688",text:"#00695c"},{bg:"#f1f8e9",border:"#8bc34a",text:"#689f38"},{bg:"#fff8e1",border:"#ffc107",text:"#ffa000"}];return a[t%a.length]}function w(e){if(!e)return"";if("string"==typeof e&&"current"===e)return"Current Data";const t=n.find(t=>t.id===e);return t&&t.note?t.note:""}function k(){if(e("#adeptus-compare-section-a").replaceWith(function(){let e="";const t=x(d),s=w(d);return e+=`<div class="w-100 adeptus-droppable-snapshot adeptus-compare-section" id="adeptus-compare-section-a" data-drop-target="a" style="border: 2px solid ${t.border}; border-radius: 8px; padding: 12px; background-color: ${t.bg}; height: 100%; min-height: 300px; position:relative;">\n                    <div class="d-flex justify-content-between align-items-center mb-2">\n                        <span class="fw-bold" style="color: ${t.text};">Snapshot A${s?": "+s:""}</span>\n                        <div class="btn-group adeptus-display-type-switcher-a" role="group" aria-label="Display type switcher">\n                            <button class="btn btn-icon btn-sm${"table"===g?" active":""}" data-type="table" data-side="a" tabindex="0" aria-label="Table view" title="Table view"><i class="fa fa-table"></i></button>\n                            <button class="btn btn-icon btn-sm${"chart"===g?" active":""}" data-type="chart" data-side="a" tabindex="0" aria-label="Chart view" title="Chart view"><i class="fa fa-bar-chart"></i></button>\n                            <button class="btn btn-icon btn-sm${"graph"===g?" active":""}" data-type="graph" data-side="a" tabindex="0" aria-label="Graph view" title="Graph view"><i class="fa fa-line-chart"></i></button>\n                            </div>\n                        </div>`,p?e+='<div class="w-100 d-flex justify-content-center align-items-center" style="min-height:200px"><div class="spinner-border text-primary" role="status"></div></div>':f?(e+=`<div class="adeptus-comparison-fade${g?" adeptus-comparison-fade-in":""}" style="animation:fadeIn .3s; overflow-x: auto; max-height: calc(100% - 50px);">`,"table"===g?e+=a.renderDiffTable(f,b):"chart"===g?e+='<div class="adeptus-chart-container" style="min-height:260px;" tabindex="0" aria-label="Bar chart" role="region"><canvas id="compareChartA"></canvas></div>':"graph"===g&&(e+='<div class="adeptus-chart-container" style="min-height:260px;" tabindex="0" aria-label="Line graph" role="region"><canvas id="compareGraphA"></canvas></div>'),e+="</div>"):e+='<div class="text-muted small text-center" style="min-height:200px;">No snapshot selected for A</div>',e+="</div>",e}()),e("#adeptus-compare-section-b").replaceWith(function(){let e="";const t=x(c),s=w(c);return e+=`<div class="w-100 adeptus-droppable-snapshot adeptus-compare-section" id="adeptus-compare-section-b" data-drop-target="b" style="border: 2px solid ${t.border}; border-radius: 8px; padding: 12px; background-color: ${t.bg}; height: 100%; min-height: 300px; position:relative;">\n                    <div class="d-flex justify-content-between align-items-center mb-2">\n                        <span class="fw-bold" style="color: ${t.text};">Snapshot B${s?": "+s:""}</span>\n                        <div class="btn-group adeptus-display-type-switcher-b" role="group" aria-label="Display type switcher B">\n                            <button class="btn btn-icon btn-sm${"table"===m?" active":""}" data-type="table" data-side="b" tabindex="0" aria-label="Table view for B" title="Table view"><i class="fa fa-table"></i></button>\n                            <button class="btn btn-icon btn-sm${"chart"===m?" active":""}" data-type="chart" data-side="b" tabindex="0" aria-label="Chart view for B" title="Chart view"><i class="fa fa-bar-chart"></i></button>\n                            <button class="btn btn-icon btn-sm${"graph"===m?" active":""}" data-type="graph" data-side="b" tabindex="0" aria-label="Graph view for B" title="Graph view"><i class="fa fa-line-chart"></i></button>\n                        </div>\n                    </div>`,u?e+='<div class="w-100 d-flex justify-content-center align-items-center" style="min-height:200px"><div class="spinner-border text-primary" role="status"></div></div>':b?(e+=`<div class="adeptus-comparison-fade${m?" adeptus-comparison-fade-in":""}" style="animation:fadeIn .3s; overflow-x: auto; max-height: calc(100% - 50px);">`,"table"===m?e+=a.renderDiffTable(b,f):"chart"===m?e+='<div class="adeptus-chart-container" style="min-height:260px;" tabindex="0" aria-label="Bar chart for B" role="region"><canvas id="compareChartB"></canvas></div>':"graph"===m&&(e+='<div class="adeptus-chart-container" style="min-height:260px;" tabindex="0" aria-label="Line graph for B" role="region"><canvas id="compareGraphB"></canvas></div>'),e+="</div>"):e+='<div class="text-muted small text-center" style="min-height:200px;">No snapshot selected for B</div>',e+="</div>",e}()),"chart"===g&&Array.isArray(f)&&f.length>0){const e=document.getElementById("compareChartA");if(e){const t=Object.keys(f[0]);let a=t.find(e=>"string"==typeof f[0][e])||t[0],r=t.find(e=>"number"==typeof f[0][e])||t[1];const n=f.map(e=>e[a]),i=f.map(e=>e[r]);window.compareChartAInstance&&window.compareChartAInstance.destroy(),window.compareChartAInstance=new s(e.getContext("2d"),{type:"bar",data:{labels:n,datasets:[{label:r,data:i,backgroundColor:"rgba(0,123,255,0.5)",borderColor:"rgba(0,123,255,1)",borderWidth:1}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1}}}})}}if("graph"===g&&Array.isArray(f)&&f.length>0){const e=document.getElementById("compareGraphA");if(e){const t=Object.keys(f[0]);let a=t.find(e=>"string"==typeof f[0][e])||t[0],r=t.find(e=>"number"==typeof f[0][e])||t[1];const n=f.map((e,t)=>e[a]||t+1),i=f.map(e=>e[r]);window.compareGraphAInstance&&window.compareGraphAInstance.destroy(),window.compareGraphAInstance=new s(e.getContext("2d"),{type:"line",data:{labels:n,datasets:[{label:r,data:i,backgroundColor:"rgba(40,167,69,0.5)",borderColor:"rgba(40,167,69,1)",borderWidth:2,fill:!1}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1}}}})}}if("chart"===m&&Array.isArray(b)&&b.length>0){const e=document.getElementById("compareChartB");if(e){const t=Object.keys(b[0]);let a=t.find(e=>"string"==typeof b[0][e])||t[0],r=t.find(e=>"number"==typeof b[0][e])||t[1];const n=b.map(e=>e[a]),i=b.map(e=>e[r]);window.compareChartBInstance&&window.compareChartBInstance.destroy(),window.compareChartBInstance=new s(e.getContext("2d"),{type:"bar",data:{labels:n,datasets:[{label:r,data:i,backgroundColor:"rgba(0,123,255,0.5)",borderColor:"rgba(0,123,255,1)",borderWidth:1}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1}}}})}}if("graph"===m&&Array.isArray(b)&&b.length>0){const e=document.getElementById("compareGraphB");if(e){const t=Object.keys(b[0]);let a=t.find(e=>"string"==typeof b[0][e])||t[0],r=t.find(e=>"number"==typeof b[0][e])||t[1];const n=b.map((e,t)=>e[a]||t+1),i=b.map(e=>e[r]);window.compareGraphBInstance&&window.compareGraphBInstance.destroy(),window.compareGraphBInstance=new s(e.getContext("2d"),{type:"line",data:{labels:n,datasets:[{label:r,data:i,backgroundColor:"rgba(40,167,69,0.5)",borderColor:"rgba(40,167,69,1)",borderWidth:2,fill:!1}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1}}}})}}}function C(){o.update({html:"<div class='d-flex flex-row' style='height:70vh;min-height:500px;max-height:80vh;'>\n                        <div id='adeptus-timeline-sidebar-modal'></div>\n                        <div class='flex-fill px-3' style='overflow:auto;max-width:calc(100% - 220px);'>\n                            <div class='d-flex flex-row gap-3 w-100 h-100'>\n                                <div class='flex-fill' id='adeptus-compare-section-a'></div>\n                                <div class='flex-fill' id='adeptus-compare-section-b'></div>\n                            </div>\n                        </div>\n                    </div>"}),e("#adeptus-timeline-sidebar-modal").html(function(e,t){let s='<div class="adeptus-timeline-sidebar" style="width:220px;max-width:220px;overflow-y:auto;height:100%;background:#f8f9fa;border-right:1.5px solid #e0e0e0;padding:0.5rem 0.25rem;">';return s+='<div class="d-flex flex-column gap-2 mb-3">',s+='<button class="btn btn-outline-primary btn-sm w-100 mb-1 adeptus-fetch-current-btn" title="Fetch current data from database" aria-label="Fetch current data"><i class="fa fa-sync"></i> Fetch Current Data</button>',y&&"current"===d&&(s+='<div class="mb-2">\n                        <input type="text" id="add-timeline-note" class="form-control form-control-sm mb-1" placeholder="Enter snapshot name (required)" required aria-label="Snapshot name">\n                        <div class="invalid-feedback" style="display:none;">Snapshot name is required.</div>\n                        <button class="btn btn-outline-success btn-sm w-100 adeptus-add-timeline-btn" id="adeptus-add-timeline-btn" title="Create snapshot from current data" aria-label="Create snapshot from current data" disabled><span class="adeptus-btn-label"><i class="fa fa-plus"></i> Create Snapshot From Current Data</span><span class="spinner-border spinner-border-sm ms-2" id="snapshot-loading" style="display:none;" role="status" aria-hidden="true"></span></button>\n                    </div>'),s+='<div class="small text-muted text-center px-2 py-1 mb-2" style="border: 1px dashed #dee2e6; border-radius: 4px;">Click or <b>drag</b> snapshots to select for comparison. Each snapshot gets a unique color. You can also drag and drop from the side menu into the snapshot viewer.</div>',s+="</div>",s+='<div class="adeptus-timeline-list">',0===n.length?s+=h?`<div class="text-danger small text-center py-2">Error: ${h}</div>`:'<div class="text-muted small text-center py-2">No timeline snapshots yet. [DEBUG: Timeline is empty]</div>':n.forEach((r,n)=>{const i=[{bg:"#e3f2fd",border:"#2196f3",text:"#1976d2"},{bg:"#f3e5f5",border:"#9c27b0",text:"#7b1fa2"},{bg:"#e8f5e8",border:"#4caf50",text:"#388e3c"},{bg:"#fff3e0",border:"#ff9800",text:"#f57c00"},{bg:"#fce4ec",border:"#e91e63",text:"#c2185b"},{bg:"#e0f2f1",border:"#009688",text:"#00695c"},{bg:"#f1f8e9",border:"#8bc34a",text:"#689f38"},{bg:"#fff8e1",border:"#ffc107",text:"#ffa000"}],o=i[n%i.length],d=e===r.id||t===r.id,l=d?`background-color: ${o.bg}; border-color: ${o.border}; border-width: 2px;`:"background-color: #fff; border-color: #dee2e6; border-width: 1px;",c=r.is_current_version?'<span class="badge bg-primary ms-1">Current</span>':"",p=d?'draggable="false"':'draggable="true"',u=d?"This snapshot is currently selected":"Drag to assign to Snapshot A or B",h=d?'<span class="text-muted small">(Selected)</span>':"";s+=`<div class="adeptus-timeline-item p-2 mb-1 rounded border ${d?"adeptus-drag-disabled":"adeptus-draggable-snapshot"}"\n                                      style="cursor:pointer; animation:fadeIn .3s; ${l}"\n                                      data-snap-id="${r.id}"\n                                      data-color-bg="${o.bg}"\n                                      data-color-border="${o.border}"\n                                      data-color-text="${o.text}"\n                                      tabindex="0"\n                                      aria-label="Snapshot from ${a.formatTimestamp(r.created_at)}${r.is_current_version?" (current)":""}"\n                                      ${p}\n                                      title="${u}"\n                                      >\n                            <div class="d-flex justify-content-between align-items-center">\n                                <span class="fw-bold small">${a.formatTimestamp(r.created_at)}</span>\n                                ${c}\n                            </div>\n                            <div class="small text-muted">${r.note?r.note:""} ${h}</div>\n                            <div class="d-flex gap-1 mt-1">\n                                <button class="btn btn-outline-secondary btn-xs btn-sm adeptus-set-current-btn" data-snap-id="${r.id}" title="Set as current version" aria-label="Set as current"><i class="fa fa-check"></i></button>\n                            </div>\n                        </div>`}),s+="</div></div>",s}(d,c)),k(),e(".adeptus-fetch-current-btn").off("click").on("click",function(){!function(e,t){"a"===e&&(p=!0),"b"===e&&(u=!0),k(),a.ajaxWithAuth({url:`${this.backendUrl}/ai-reports/${r}/data/current`,method:"GET",success:function(a){i=a.data||[],"a"===e?(f=i,d="current",p=!1):(b=i,c="current",u=!1),y=!0,k(),t&&t()},error:function(){h="Failed to fetch current data.","a"===e&&(p=!1),"b"===e&&(u=!1),k(),t&&t()}})}(_)}),e(".adeptus-timeline-item").off("click").on("click",function(){const t=e(this).data("snap-id");"a"===_?v(t,"a",()=>{_="b"}):v(t,"b",()=>{_="a"})}),e(".adeptus-display-type-switcher-a .btn-icon").off("click").on("click",function(){g=e(this).data("type"),k()}),e(".adeptus-display-type-switcher-b .btn-icon").off("click").on("click",function(){m=e(this).data("type"),k()}),e(".adeptus-draggable-snapshot").attr("draggable",!0).off("dragstart").on("dragstart",function(t){t.originalEvent.dataTransfer.setData("text/plain",e(this).data("snap-id")),e(this).addClass("adeptus-dragging")}),e(".adeptus-draggable-snapshot").off("dragend").on("dragend",function(){e(this).removeClass("adeptus-dragging")}),e(".adeptus-compare-section").off("dragover").on("dragover",function(t){t.preventDefault(),e(this).addClass("adeptus-drag-over-section")}),e(".adeptus-compare-section").off("dragleave").on("dragleave",function(){e(this).removeClass("adeptus-drag-over-section")}),e(".adeptus-compare-section").off("drop").on("drop",function(t){t.preventDefault(),e(this).removeClass("adeptus-drag-over-section");const a=t.originalEvent.dataTransfer.getData("text/plain"),s=e(this).data("drop-target");v(a,s,()=>{_="a"===s?"b":"a"})}),0===e("#adeptus-compare-section-highlight-style").length&&e("head").append('<style id="adeptus-compare-section-highlight-style">.adeptus-drag-over-section { box-shadow: 0 0 0 4px #90caf9 !important; border-color: #1976d2 !important; }</style>')}o.fire({title:`<span class='fw-bold'>${l("compare_report_data","Compare Report Data")}</span>`,html:"<div class='d-flex flex-row' style='height:60vh;min-height:400px;max-height:70vh;'>\n                    <div id='adeptus-timeline-sidebar-modal'></div>\n                    <div class='flex-fill px-3' style='overflow:auto;max-width:calc(100% - 220px);'>\n                        <div class='d-flex flex-row gap-3 w-100 h-100'>\n                            <div class='flex-fill' id='adeptus-compare-section-a'></div>\n                            <div class='flex-fill' id='adeptus-compare-section-b'></div>\n                        </div>\n                    </div>\n                </div>",width:"90vw",heightAuto:!1,showCancelButton:!0,showConfirmButton:!1,customClass:{popup:"swal2-modal-compare-data"},didOpen:()=>{!function(e){a.ajaxWithAuth({url:`${this.backendUrl}/ai-reports/${r}/snapshots`,method:"GET",success:function(t){n=t.snapshots||[],e&&e()},error:function(){h="Failed to load timeline.",e&&e()}})}(()=>{n.length>0?(d=n.find(e=>e.is_current_version)?.id||n[0].id,c=n.length>1?n[1].id:null,d&&c?function(e,t,s){p=!0,u=!0,k(),a.ajaxWithAuth({url:`${this.backendUrl}/ai-reports/${r}/snapshots/${e}/compare/${t}`,method:"GET",success:function(e){f=e.a.data,b=e.b.data,p=!1,u=!1,k(),s&&s(e)},error:function(){h="Failed to compare snapshots.",p=!1,u=!1,k(),s&&s()}})}(d,c,()=>{_="a",C()}):d?v(d,"a",()=>{_="b",C()}):C()):C()})}})},renderDiffTable:function(e,t){if(!Array.isArray(e)||0===e.length)return'<div class="text-muted small">No data</div>';const a=Object.keys(e[0]);let s='<div class="table-responsive"><table class="table table-striped table-hover table-sm">';return s+="<thead><tr>",a.forEach(e=>{s+=`<th>${e}</th>`}),s+="</tr></thead><tbody>",e.forEach((e,r)=>{s+="<tr>",a.forEach(a=>{let n=!1;t&&Array.isArray(t)&&t[r]&&t[r][a]!==e[a]&&(n=!0),s+=`<td${n?' style="background:#ffe5e5;"':""}>${e[a]??""}</td>`}),s+="</tr>"}),s+="</tbody></table></div>",s},testMCQ:function(){this.addMessage("I found an existing wizard report that might meet your needs. However, it doesn't include all the fields you requested.\n\nWhat would you like to do?\n\nA. Use the existing wizard report as-is\nB. Generate a new custom SQL report with all fields\nC. Use the wizard report and create a separate supplementary report\nD. Cancel and try a different approach","ai")},testMCQNumbered:function(){this.addMessage("Please select your preferred report format:\n\n1. PDF Export with charts and graphs\n2. Excel spreadsheet with raw data\n3. CSV file for data analysis\n4. Interactive web dashboard\n5. Email summary report","ai")}};return window.assistant=c,c});