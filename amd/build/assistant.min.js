define(["jquery","core/ajax","core/notification","core/chartjs","core/templates","report_adeptus_insights/auth_utils"],function(_,e,a,k,t,c){var S=window.Swal,s={currentChatId:0,currentMCQ:null,isSending:!1,mcqQueue:[],reportsDataTable:null,cachedReports:[],cachedCategories:[],_initCalled:!1,isCreditLimitExceeded:!1,backendUrl:"https://backend.adeptus360.com/api/v1",init:function(e){if(!this._initCalled){this._initCalled=!0,this.currentChatId=0;const t=()=>_(".assistant-header").siblings(".container-fluid").first();t().hide(),this.initializeLoaderStyles();try{c.isAuthenticated()?(this.setUserName(c.getAuthStatus()?.user?.name||"User"),this.updateSubscriptionInfo(),this.setupEventListeners(),this.loadChatHistory(),this.loadReportsHistory(),this.loadCategories(),t().fadeIn(200)):(c.refreshAuthStatus(),setTimeout(()=>{c.isAuthenticated()?(this.setUserName(c.getAuthStatus()?.user?.name||"User"),this.updateSubscriptionInfo(),this.setupEventListeners(),this.loadChatHistory(),this.loadReportsHistory(),this.loadCategories(),t().fadeIn(200)):this.showAuthenticationError()},500))}catch(e){console.error("[AI Assistant] Failed to initialize authentication:",e),this.setupEventListeners(),t().fadeIn(200)}}},initializeLoaderStyles:function(){0===_("#ai-loader-styles").length&&_("head").append(`
                    <style id="ai-loader-styles">
                        .ai-thinking-loader-wrapper {
                            animation: fadeInLoader 0.3s ease-out forwards;
                        }

                        .ai-thinking-loader {
                            opacity: 1 !important;
                        }

                        @keyframes bounce-loader {
                            0%, 80%, 100% {
                                transform: scale(0.8);
                                opacity: 0.5;
                            }
                            40% {
                                transform: scale(1.2);
                                opacity: 1;
                            }
                        }

                        @keyframes fadeInLoader {
                            from {
                                opacity: 0;
                                transform: translateY(10px);
                            }
                            to {
                                opacity: 1;
                                transform: translateY(0);
                            }
                        }

                        @keyframes pulse-glow-loader {
                            0% {
                                box-shadow: 0 0 0 0 rgba(14, 165, 233, 0.4);
                            }
                            70% {
                                box-shadow: 0 0 0 8px rgba(14, 165, 233, 0);
                            }
                            100% {
                                box-shadow: 0 0 0 0 rgba(14, 165, 233, 0);
                            }
                        }
                    </style>
                `)},showAuthenticationError:function(){const e=_(".assistant-header").siblings(".container-fluid").first();e.html(`
                <div class="alert alert-danger">
                    <h4>Authentication Required</h4>
                    <p>You need to be authenticated to use the AI Assistant. Please contact your administrator for assistance.</p>
                    <button class="btn btn-primary" onclick="location.reload()">Refresh Page</button>
                </div>
            `).show()},setupEventListeners:function(){_("#send-button").on("click",()=>this.sendMessage()),_("#message-input").on("keydown",e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),this.sendMessage())}),_("#chart-type").on("change",()=>this.updateChart()),_("#message-input").on("input",function(){this.style.height="auto",this.style.height=this.scrollHeight+"px"}),_("#create-new-chat").on("click",()=>this.createNewChat())},renderMCQ:function(e,t){this.currentMCQ=!0,_("#message-input, #send-button").prop("disabled",!0);const s=_("#mcq-container").empty().show();s.append(`<p class="mcq-question"><strong>${e}</strong></p>`),t.forEach((e,t)=>{var a=String.fromCharCode(65+t);s.append(`
                <div class="form-check">
                    <input class="form-check-input" type="radio"
                        name="mcq-option" id="mcq-${t}"
                        value="${e}">
                    <label class="form-check-label" for="mcq-${t}">
                    ${a}. ${e}
                    </label>
                </div>`)}),s.append('<button type="button" class="btn btn-link" id="mcq-cancel">Cancel</button>'),s.find('input[name="mcq-option"]').on("change",()=>{_("#mcq-submit").remove(),s.append('<button type="button" id="mcq-submit" class="btn btn-primary mt-2">Submit</button>'),_("#mcq-submit").off("click").on("click",e=>{e.preventDefault(),e.stopPropagation();e=s.find('input[name="mcq-option"]:checked').val();e&&this.sendMCQ(e)})}),s.find("#mcq-cancel").off("click").on("click",e=>{e.preventDefault(),this.mcqQueue=[],this.clearMCQ()})},clearMCQ:function(){this.currentMCQ=null,_("#mcq-container").empty().hide(),_("#message-input").prop("disabled",!1),_("#send-button").prop("disabled",!1)},extractMCQFromText:function(e){if(!e||"string"!=typeof e)return null;try{var t=e.match(/```json\s*(\[[\s\S]*?\])\s*```/);if(t){var a=JSON.parse(t[1]);if(Array.isArray(a)&&0<a.length&&"mcq"===a[0].type)return{questions:a,selectedAnswer:null}}const s=e.match(/\{[\s\S]*?\}/g)||[],r=[];if(s.forEach(e=>{try{var t=JSON.parse(e);"mcq"===t.type&&Array.isArray(t.options)&&r.push(t)}catch(e){}}),0<r.length)return{questions:r,selectedAnswer:null}}catch(e){}return null},renderMCQHistory:function(e,o=null){let n='<div class="mcq-history-container" style="display:flex; flex-direction:column; gap:15px;">';return e.forEach((e,i)=>{n+=`
                    <div class="mcq-history-item" style="background:#f8f9fa; padding:15px; border-radius:8px; border:1px solid #dee2e6; box-shadow:0 1px 3px rgba(0,0,0,0.05);">
                        <p style="font-weight:600; margin-bottom:12px; color:#333; font-size:14px;">
                            <i class="fa fa-question-circle" style="color:#007bff; margin-right:8px;"></i>${e.question}
                        </p>
                        <div class="mcq-options" style="margin-left:24px;">
                `,e.options.forEach((e,t)=>{var a="string"!=typeof e&&e.label||e,e=o&&(o===e||o===a||o.includes(a)),s=e?"background:#e3f0ff; border:2px solid #007bff; font-weight:600;":"border:1px solid #ced4da;",r=e?'<i class="fa fa-check-circle" style="color:#28a745; margin-right:5px;"></i>':"";n+=`
                        <div class="form-check" style="padding:10px 14px; border-radius:6px; margin-bottom:8px; ${s} transition:all 0.2s;">
                            <input class="form-check-input" type="radio" name="mcq-${i}" disabled ${e?"checked":""} style="margin-top:0.3em;">
                            <label class="form-check-label" style="color:#555; cursor:not-allowed; margin-left:5px;">
                                ${r}${a}
                            </label>
                        </div>
                    `}),n+=`
                        </div>
                        <p style="margin-top:12px; margin-bottom:0; font-size:11px; color:#6c757d; font-style:italic;">
                            <i class="fa fa-info-circle" style="margin-right:4px;"></i>Previous question from chat history
                        </p>
                    </div>
                `}),n+="</div>"},checkAuth:function(){return c.isAuthenticated()?(this.loadChatHistory(),!0):(this.showAuthenticationError(),!1)},handleResponse:function(e){if(e.error){if("credit_limit"===e.error_type||"token_limit"===e.error_type)return void this.handleCreditLimitError(e.message);this.addMessage(e.message,"error"),this.showResendIconOnLastUserMessage()}else{if("mcq"===e.type){if(e.questions&&0<e.questions.length){const a=e.questions[0];var t=`Question: ${a.question}
Options: `+a.options.join(", ");this.addMessage(t,"ai",!1,null,null,null,e.credit_info)}return void this.enqueueMCQs(e.questions)}if("sql"===e.type||"report"===e.type){if(e.awaiting_confirmation&&e.report)return void this.showReportConfirmation(e.report,e.report_data||null,e.message,e.credit_info,e.execution_error||null);t=e.report||e;return this.addMessage(t.description||e.message,"ai",!0,t,null,null,e.credit_info),this.updateChatHistoryBadge(this.currentChatId),this.cachedReports.unshift(t),this.updateReportsHistory(this.cachedReports),this.reportsDataTable&&(this.reportsDataTable.destroy(),this.reportsDataTable=null),setTimeout(()=>{try{const e=document.getElementById("reports-history-table");if(e){var t=e.querySelector("thead"),a=e.querySelector("tbody");if(t&&a&&0<t.rows.length&&0<t.rows[0].cells.length){var s=t.rows[0].cells.length;const r=a.rows;let e=0;s===(e=0<r.length?r[0].cells.length:e)&&0<s&&0<r.length&&!r[0].cells[0].textContent.includes("No reports")&&(this.reportsDataTable=new simpleDatatables.DataTable("#reports-history-table",{searchable:!0,fixedHeight:!1,perPage:10,loading:!1}),setTimeout(()=>{_(".datatable-wrapper").removeClass("datatable-loading"),_("#report-history-table-wrapper .datatable-wrapper").removeClass("datatable-loading")},100))}}}catch(e){console.error("Error reinitializing DataTable:",e)}},100),void S.fire({title:"Generating Report",html:`
                        <div class="text-center">
                            <div class="spinner-border text-primary mb-3" role="status">
                            </div>
                            <p>Please wait while we generate your report...</p>
                        </div>
                    `,showConfirmButton:!1,allowOutsideClick:!1,allowEscapeKey:!1,timer:2e3,timerProgressBar:!0}).then(()=>{this.switchToReportsTab(),this.displayCurrentReport(e.report),this.executeReport(e.report.slug)})}this.addMessage(e.message,"ai",!1,null,null,null,e.credit_info)}e.data&&this.updateReportData(e.data),e.visualizations&&this.updateVisualizations(e.visualizations),e.credit_info&&this.showCreditUsageFeedback(e.credit_info),this.scrollToBottom()},showCreditUsageFeedback:function(e){if(e){const t=_(`
                <div class="credit-usage-notification" style="
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: #28a745;
                    color: white;
                    padding: 12px 20px;
                    border-radius: 6px;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                    z-index: 9999;
                    font-size: 14px;
                    font-weight: 500;
                    opacity: 0;
                    transform: translateX(100%);
                    transition: all 0.3s ease;
                ">
                    <i class="fa fa-coins me-2"></i>
                    <span class="credit-text">Credits used: ${e.credits_charged||0} (${e.credit_type||"basic"})</span>
                </div>
            `);_("body").append(t),setTimeout(()=>{t.css({opacity:"1",transform:"translateX(0)"})},100),setTimeout(()=>{t.css({opacity:"0",transform:"translateX(100%)"}),setTimeout(()=>{t.remove()},300)},3e3),this.updateSubscriptionInfoWithCreditUsage(e)}},updateSubscriptionInfoWithCreditUsage:function(e){var t=c.getAuthStatus();if(t&&t.subscription){const a=t.subscription;t=e.credits_charged||0;"premium"===e.credit_type?a.premium_credits_used_this_month=(a.premium_credits_used_this_month||0)+t:a.basic_credits_used_this_month=(a.basic_credits_used_this_month||0)+t,a.ai_credits_used_this_month=(a.ai_credits_used_this_month||0)+t,this.animateCreditCounterUpdate(e.credit_type,t),this.updateSubscriptionInfo()}},animateCreditCounterUpdate:function(e,t){const a=_("premium"===e?".premium-credits-counter":".basic-credits-counter"),s=(a.length&&(a.addClass("credit-update-highlight"),setTimeout(()=>{a.removeClass("credit-update-highlight")},1e3)),_(".total-credits-counter"));s.length&&(s.addClass("credit-update-highlight"),setTimeout(()=>{s.removeClass("credit-update-highlight")},1e3))},addMessage:function(e,t,a=!1,s=null,r=null,i=null,o=null){"ai"===t&&e&&(e=e.replace(/\nConfidence:\s*\d+%\n?/gi,"\n").replace(/Confidence:\s*\d+%/gi,"").trim());const c=document.getElementById("message-template"),n=c.content.cloneNode(!0),l=n.querySelector(".message");l.classList.add(t+"-message"),r&&l.setAttribute("data-message-id",r);var r=this.extractMCQFromText(e);if(r&&0<r.questions.length){r=this.renderMCQHistory(r.questions,r.selectedAnswer);n.querySelector(".message-text").innerHTML=r}else if(a&&s){n.querySelector(".message-text").innerHTML=`
                    <a href="javascript:void(0)"
                       class="report-link"
                       data-report-slug="${s.slug}"
                       style="color: #007bff; text-decoration: none; cursor:pointer; padding:4px 8px; border:1px solid #dee2e6; border-radius:4px; background:#f8f9fa; display:inline-block; transition:all 0.2s;">
                        ðŸ“Š ${e}
                    </a>
                `;const d=this;setTimeout(()=>{const e=l.querySelector(".report-link");e.onclick=function(){d.openReportFromLink(e.getAttribute("data-report-slug"))},e.onmouseenter=function(){_(this).css({"background-color":"#e9ecef","border-color":"#adb5bd",transform:"translateY(-1px)"})},e.onmouseleave=function(){_(this).css({"background-color":"#f8f9fa","border-color":"#dee2e6",transform:"translateY(0)"})}},0)}else"report-preview"===t||"system-action"===t?(n.querySelector(".message-text").innerHTML=e,l.classList.add(t+"-message"),"report-preview"!==t&&"system-action"!==t||(l.style.background="transparent",l.style.padding="0",l.style.border="none",l.style.maxWidth="100%")):"ai"===t&&this.isMultipleChoiceQuestion(e)?(r=this.renderMultipleChoiceOptions(e),n.querySelector(".message-text").innerHTML=r):n.querySelector(".message-text").textContent=e;"ai"===t&&o&&this.addCreditInfoToMessage(n,o);const p=n.querySelector(".message-time");return p.textContent=this.formatTimestamp(i||(new Date).toISOString()),_("#chat-container").append(n),this.scrollToBottom(),_(l)},addCreditInfoToMessage:function(e,t){const a=e.querySelector(".message"),s=document.createElement("div"),r=(s.className="credit-info-badge",s.style.cssText=`
                display: inline-block;
                margin-left: 8px;
                padding: 2px 6px;
                border-radius: 12px;
                font-size: 11px;
                font-weight: 500;
                text-transform: uppercase;
                letter-spacing: 0.5px;
            `,"premium"===t.credit_type?(s.style.backgroundColor="#6f42c1",s.style.color="white",s.textContent="Premium"):(s.style.backgroundColor="#28a745",s.style.color="white",s.textContent="Basic"),s.title=`${t.credit_type.toUpperCase()} Response
Tokens: ${t.tokens_used}
Credits: ${t.credits_charged}
Provider: `+t.provider,a.querySelector(".message-text"));r.appendChild(s)},isMultipleChoiceQuestion:function(e){const a=e.match(/^[A-Z][\.\)]\s+.+$/gim),s=e.match(/^[1-9][0-9]*[\.\)]\s+.+$/gm);if(a&&2<=a.length){const o=a.map(e=>e.match(/^([A-Z])/i)[1].toUpperCase());var r=o[0].charCodeAt(0);let t=!0;for(let e=1;e<Math.min(o.length,4);e++)if(o[e].charCodeAt(0)!==r+e){t=!1;break}return t}if(s&&2<=s.length){var i=s.map(e=>parseInt(e.match(/^([0-9]+)/)[1]));let t=!0;for(let e=1;e<Math.min(i.length,4);e++)if(i[e]!==i[0]+e){t=!1;break}return t}return!1},renderMultipleChoiceOptions:function(e){const o=this,t=e.split("\n");let r=[],n=[],a=(t.forEach(e=>{const t=e.trim(),a=t.match(/^([A-Z])[\.\)]\s+(.+)$/i),s=t.match(/^([1-9][0-9]*)[\.\)]\s+(.+)$/);a?n.push({letter:a[1].toUpperCase(),text:a[2].trim(),isLetter:!0}):s?n.push({letter:s[1],text:s[2].trim(),isLetter:!1}):t&&r.push(t)}),'<div class="mcq-question-container">');return a=(a+='<div class="mcq-question-text" style="margin-bottom: 15px; white-space: pre-wrap;">')+this.escapeHtml(r.join("\n"))+"</div>",0<n.length&&(a+='<div class="mcq-options-grid" style="display: grid; gap: 10px; grid-template-columns: 1fr;">',n.forEach(e=>{var t="mcq-option-"+Date.now()+"-"+e.letter;a+=`
                        <button class="mcq-option-button"
                                data-option="${e.letter}"
                                id="${t}"
                                style="
                                    padding: 12px 16px;
                                    display: flex;
                                    align-items: center;
                                    gap: 12px;
                                    font-size: 14px;
                                    line-height: 1.5;
                                    color: #333;
                                    min-height: 50px;
                                ">
                            <span class="mcq-option-letter" style="
                                background: linear-gradient(135deg, #0ea5e9 0%, #2563eb 100%);
                                color: white;
                                width: 32px;
                                height: 32px;
                                border-radius: 50%;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                font-weight: bold;
                                flex-shrink: 0;
                            ">${e.letter}</span>
                            <span class="mcq-option-text" style="flex: 1;">${this.escapeHtml(e.text)}</span>
                        </button>
                    `}),a+="</div>"),a+="</div>",setTimeout(()=>{const e=document.querySelector("#chat-container"),t=e.querySelectorAll(".mcq-option-button:not([data-handler-attached])");t.forEach(e=>{e.setAttribute("data-handler-attached","true"),e.addEventListener("click",function(){if(!this.disabled){const a=this.getAttribute("data-option");var t=n.find(e=>e.letter===a);const s=this.closest(".mcq-question-container"),r=s.querySelectorAll(".mcq-option-button"),i=(r.forEach(e=>{e.disabled=!0,e.classList.add("disabled")}),this.classList.add("selected"),this.querySelector(".mcq-option-letter"));i.innerHTML="âœ“";let e;e=(t.isLetter,a+". "+t.text),o.sendMessage(e)}})})},100),a},escapeHtml:function(e){const t={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"};return e.replace(/[&<>"']/g,e=>t[e])},handleCreditLimitError:function(e,t=null){t&&t.summary&&this.updateSubscriptionDataFromCreditResponse(t),this.isCreditLimitExceeded=!0,this.updateSendMessageandCreateNewChatButton(),this.showPersistentCreditLimitMessage(e),this.addMessage(e,"error"),S.fire({icon:"warning",title:"Token Limit Reached",html:`
                    <div class="text-center">
                        <p>${e}</p>
                        <p class="text-muted">Your monthly token allowance has been used up.</p>
                        <p class="text-muted">Tokens reset on the 1st of each month.</p>
                    </div>
                `,showCancelButton:!0,confirmButtonText:"View Usage",cancelButtonText:"Close",confirmButtonColor:"#007bff"}).then(e=>{e.isConfirmed&&this.showCreditUsageModal()})},updateSubscriptionDataFromCreditResponse:function(e){var t=c.getAuthStatus();if(t&&t.subscription){const a=t.subscription;void 0!==e.tokens_used&&(a.tokens_used=e.tokens_used),void 0!==e.tokens_limit&&(a.tokens_limit=e.tokens_limit),void 0!==e.tokens_remaining&&(a.tokens_remaining=e.tokens_remaining),c.setAuthStatus(t),this.updateSubscriptionInfo()}},handleTimeoutError:function(e){this.addMessage(e,"error"),S.fire({icon:"info",title:"AI Service Busy",html:`
                    <div class="text-center">
                        <p>${e}</p>
                        <p class="text-muted">The AI service is experiencing high demand. Please try again in a moment.</p>                                                                                       
                    </div>
                `,showCancelButton:!0,confirmButtonText:"Try Again",cancelButtonText:"Cancel",confirmButtonColor:"#007bff",cancelButtonColor:"#6c757d"}).then(e=>{e.isConfirmed&&_("#message-input").focus()})},showPersistentCreditLimitMessage:function(e){_(".credit-limit-alert").remove();var e=`
                <div class="alert alert-danger credit-limit-alert" role="alert" style="margin: 10px 0; border-left: 4px solid #dc3545; background-color: #f8d7da; border-color: #f5c6cb;">
                    <div class="d-flex align-items-center">

                        <div class="flex-grow-1">
                            <strong class="text-danger">Token Limit Reached</strong><br>
                            <small class="text-muted">${e}</small>
                        </div>
                        <div class="ms-3">
                            <button type="button" class="btn btn-sm btn-outline-danger me-2" onclick="window.assistant.showCreditUsageModal()">
                                <i class="fas fa-chart-bar me-1"></i> View Usage
                            </button>

                        </div>
                    </div>
                </div>
            `,t=_(".main-inner");2<=t.length?t.eq(1).before(e):1===t.length?t.eq(0).before(e):_("body").prepend(e)},hidePersistentCreditLimitMessage:function(){_(".credit-limit-alert").fadeOut(300,function(){_(this).remove()})},showCreditUsageModal:function(){S.fire({title:"Loading Usage Data...",text:"Please wait while we fetch your usage information",allowOutsideClick:!1,showConfirmButton:!1,willOpen:()=>{S.showLoading()}}),this.ajaxWithAuth({url:this.backendUrl+"/chat/credits/detailed-usage",method:"GET",success:e=>{e.success?this.displayDetailedUsageModal(e.data):S.fire("Error","Failed to load usage information","error")},error:()=>{S.fire("Error","Failed to load usage information","error")}})},displayDetailedUsageModal:function(t){var e=t.summary;const a=t.usage||[];var s=t.pagination||{total:0},r=e=>1e6<=e?(e/1e6).toFixed(1)+"M":1e3<=e?(e/1e3).toFixed(1)+"K":e.toString(),i=0<e.tokens_limit&&-1!==e.tokens_remaining?Math.min(100,Math.round(e.total_tokens_used/e.tokens_limit*100)):0,o=-1===e.tokens_remaining?"Unlimited":r(e.tokens_limit),i=`
                <div class="detailed-usage-modal" style="font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">
                    <!-- Header with close button -->
                    <div class="usage-modal-header mb-3" style="background: linear-gradient(135deg, #0f6cbf 0%, #3a8dd4 100%); padding: 16px 20px; border-radius: 10px; color: white; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0" style="color: white; font-weight: 600;">
                                <i class="fas fa-chart-line me-2"></i> Token Usage Dashboard
                            </h5>
                            <button type="button" class="usage-modal-close-btn" onclick="Swal.close()" style="background: rgba(255,255,255,0.2); border: none; color: white; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s ease;">
                                <i class="fas fa-times" style="font-size: 14px;"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Summary Cards with proper spacing -->
                    <div class="row mb-3 g-2">
                        <div class="col-md-3">
                            <div class="card border-0 h-100" style="background: linear-gradient(135deg, #0ea5e9 0%, #2563eb 100%); color: white; border-radius: 12px; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);">
                                <div class="card-body text-center" style="padding: 16px 12px;">
                                    <h6 class="card-title mb-2" style="font-weight: 600; opacity: 0.9; font-size: 0.85rem;">Monthly Usage</h6>
                                    <div class="d-flex align-items-center justify-content-center mb-2">
                                        <i class="fas fa-chart-pie me-2" style="opacity: 0.8; font-size: 1.2rem;"></i>
                                        <span style="font-weight: 700; font-size: 1.5rem;">${i}%</span>
                                    </div>
                                    <small style="opacity: 0.8; font-size: 0.75rem;">${r(e.total_tokens_used)} / ${o}</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card border-0 h-100" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; border-radius: 12px; box-shadow: 0 4px 12px rgba(17, 153, 142, 0.2);">
                                <div class="card-body text-center" style="padding: 16px 12px;">
                                    <h6 class="card-title mb-2" style="font-weight: 600; opacity: 0.9; font-size: 0.85rem;">Tokens Used</h6>
                                    <div class="d-flex align-items-center justify-content-center mb-2">
                                        <i class="fas fa-code me-2" style="opacity: 0.8; font-size: 1.2rem;"></i>
                                        <span style="font-weight: 700; font-size: 1.5rem;">${r(e.total_tokens_used)}</span>
                                    </div>
                                    <small style="opacity: 0.8; font-size: 0.75rem;">This Billing Period</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card border-0 h-100" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; border-radius: 12px; box-shadow: 0 4px 12px rgba(240, 147, 251, 0.2);">
                                <div class="card-body text-center" style="padding: 16px 12px;">
                                    <h6 class="card-title mb-2" style="font-weight: 600; opacity: 0.9; font-size: 0.85rem;">Total Requests</h6>
                                    <div class="d-flex align-items-center justify-content-center mb-2">
                                        <i class="fas fa-paper-plane me-2" style="opacity: 0.8; font-size: 1.2rem;"></i>
                                        <span style="font-weight: 700; font-size: 1.5rem;">${e.total_requests}</span>
                                    </div>
                                    <small style="opacity: 0.8; font-size: 0.75rem;">Messages Processed</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card border-0 h-100" style="background: linear-gradient(135deg, #ff6b6b 0%, #ffa500 100%); color: white; border-radius: 12px; box-shadow: 0 4px 12px rgba(255, 107, 107, 0.2);">
                                <div class="card-body text-center" style="padding: 16px 12px;">
                                    <h6 class="card-title mb-2" style="font-weight: 600; opacity: 0.9; font-size: 0.85rem;">Today's Tokens</h6>
                                    <div class="d-flex align-items-center justify-content-center mb-2">
                                        <i class="fas fa-calendar-day me-2" style="opacity: 0.8; font-size: 1.2rem;"></i>
                                        <span style="font-weight: 700; font-size: 1.5rem;">${r(e.today_tokens_used||0)}</span>
                                    </div>
                                    <small style="opacity: 0.8; font-size: 0.75rem;">Tokens Used Today</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Compact Data Table -->
                    <div class="card border-0" style="border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.06);">
                        <div class="card-header" style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-radius: 12px 12px 0 0; border: none; padding: 12px 16px;">
                            <div class="d-flex justify-content-between align-items-center">
                                <h6 class="mb-0" style="font-weight: 600; color: #333;">
                                    Detailed Usage History
                                </h6>
                                <span class="badge bg-primary" style="font-size: 0.7rem; padding: 4px 8px; border-radius: 12px; color: white; background: linear-gradient(135deg, #0ea5e9 0%, #2563eb 100%);">
                                    ${a.length} of ${s.total} records
                                </span>
                            </div>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table id="usage-datatable" class="table table-hover mb-0" style="font-size: 0.9rem;">
                                    <thead style="background: linear-gradient(135deg, #0ea5e9 0%, #2563eb 100%); color: white;">
                                        <tr>
                                            <th style="border: none; padding: 15px 12px; font-weight: 600; text-align: center;">Date</th>
                                            <th style="border: none; padding: 15px 12px; font-weight: 600; text-align: center;">Action</th>
                                            <th style="border: none; padding: 15px 12px; font-weight: 600; text-align: center;">Model</th>
                                            <th style="border: none; padding: 15px 12px; font-weight: 600; text-align: center;">Input</th>
                                            <th style="border: none; padding: 15px 12px; font-weight: 600; text-align: center;">Output</th>
                                            <th style="border: none; padding: 15px 12px; font-weight: 600; text-align: center;">Total Tokens</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${0<a.length?a.map(t=>`
                                            <tr style="border-bottom: 1px solid #f8f9fa;">
                                                <td style="padding: 12px; vertical-align: middle; font-weight: 500;">
                                                    ${(()=>{const e=new Date(t.created_at);return e.getDate()+` ${e.toLocaleString("en-US",{month:"short"})} ${e.getFullYear()} - ${e.getHours().toString().padStart(2,"0")}:`+e.getMinutes().toString().padStart(2,"0")})()}
                                                </td>
                                                <td style="padding: 12px; vertical-align: middle;">
                                                    <span class="badge ${"report_generation"===t.action_type?"bg-primary":"mcq_generation"===t.action_type?"bg-warning":"bg-success"}" style="border-radius: 20px; padding: 6px 12px; font-weight: 500;">
                                                        <i class="fas ${"report_generation"===t.action_type?"fa-file-alt":"mcq_generation"===t.action_type?"fa-question-circle":"fa-comment"} me-1"></i>
                                                        ${t.action_type.replace("_"," ")}
                                                    </span>
                                                </td>
                                                <td style="padding: 12px; vertical-align: middle;">
                                                    <span class="badge bg-light text-dark" style="border-radius: 20px; padding: 4px 8px;">
                                                        ${t.model||"N/A"}
                                                    </span>
                                                </td>
                                                <td style="padding: 12px; vertical-align: middle; font-weight: 500; color: #11998e;">${(t.prompt_tokens||0).toLocaleString()}</td>
                                                <td style="padding: 12px; vertical-align: middle; font-weight: 500; color: #f5576c;">${(t.completion_tokens||0).toLocaleString()}</td>
                                                <td style="padding: 12px; vertical-align: middle; font-weight: 600; color: #667eea;">${(t.tokens_used||0).toLocaleString()}</td>
                                            </tr>
                                        `).join(""):`
                                            <tr>
                                                <td colspan="6" style="padding: 40px; text-align: center;">
                                                    <div style="color: #6c757d;">
                                                        <i class="fas fa-inbox fa-3x mb-3" style="opacity: 0.5;"></i>
                                                        <h5 style="font-weight: 600; margin-bottom: 10px;">No Usage Data Yet</h5>
                                                        <p style="margin: 0; font-size: 0.9rem;">Start using the AI Assistant to generate reports and your usage history will appear here.</p>
                                                    </div>
                                                </td>
                                            </tr>
                                        `}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            `;S.fire({html:i,width:"80%",showConfirmButton:!1,showCancelButton:!1,showCloseButton:!1,allowOutsideClick:!0,customClass:{popup:"usage-modal-popup",htmlContainer:"usage-modal-container"},didOpen:()=>{const e=document.querySelector(".usage-modal-close-btn");e&&(e.addEventListener("mouseenter",()=>{e.style.background="rgba(255,255,255,0.3)"}),e.addEventListener("mouseleave",()=>{e.style.background="rgba(255,255,255,0.2)"})),this.setupUsageModalEventListeners(t)}})},setupUsageModalEventListeners:function(e){const o=this;let n=e.filters;o.usageDataTable=null,setTimeout(()=>{if("undefined"!=typeof simpleDatatables&&simpleDatatables.DataTable)if(_("#usage-datatable").length)try{const t=document.getElementById("usage-datatable");var e;!t||(e=t.querySelector("tbody"))&&0<e.rows.length&&(o.usageDataTable=new simpleDatatables.DataTable("#usage-datatable",{searchable:!0,fixedHeight:!1,perPage:25,perPageSelect:[10,25,50,100],sortable:!0,labels:{placeholder:"Search usage history...",noRows:"No usage data found",info:"Showing {start} to {end} of {rows} entries"}}))}catch(e){console.error("Error initializing Simple DataTable:",e),console.error("Error details:",e.message,e.stack)}else console.error("Usage datatable element not found");else console.error("simpleDatatables library not available")},500),_("#apply-filters").on("click",function(){var e=_("#user-filter").val(),t=_("#credit-type-filter").val(),a=_("#start-date-filter").val(),s=_("#end-date-filter").val();n={user_id:e,credit_type:t,start_date:a,end_date:s},o.loadUsageDataWithFilters(n,1)}),_("#clear-filters").on("click",function(){_("#user-filter").val(""),_("#credit-type-filter").val(""),_("#start-date-filter").val(""),_("#end-date-filter").val(""),n={},o.loadUsageDataWithFilters({},1)}),_(".quick-filter").on("click",function(){var e=_(this).data("period");const t=new Date;let a="";var s=t.toISOString().split("T")[0];switch(e){case"today":a=s;break;case"week":const r=new Date(t);r.setDate(t.getDate()-7),a=r.toISOString().split("T")[0];break;case"month":const i=new Date(t);i.setMonth(t.getMonth()-1),a=i.toISOString().split("T")[0]}_("#start-date-filter").val(a),_("#end-date-filter").val(s),n={user_id:_("#user-filter").val(),credit_type:_("#credit-type-filter").val(),start_date:a,end_date:s},o.loadUsageDataWithFilters(n,1)})},loadUsageDataWithFilters:function(e,t=1){S.fire({title:"Loading...",text:"Applying filters and loading data",allowOutsideClick:!1,showConfirmButton:!1,willOpen:()=>{S.showLoading()}});const a=new URLSearchParams;e.user_id&&a.append("user_id",e.user_id),e.credit_type&&a.append("credit_type",e.credit_type),e.start_date&&a.append("start_date",e.start_date),e.end_date&&a.append("end_date",e.end_date),a.append("page",t),a.append("per_page",1e3),this.ajaxWithAuth({url:this.backendUrl+"/chat/credits/detailed-usage?"+a.toString(),method:"GET",success:e=>{e.success?this.updateUsageModalData(e.data):S.fire("Error","Failed to load filtered data","error")},error:()=>{S.fire("Error","Failed to load filtered data","error")}})},updateUsageModalData:function(e){const t=e.summary,a=e.usage,s=(_(".detailed-usage-modal .card h2").eq(0).text(t.total_credits_used),_(".detailed-usage-modal .card h2").eq(1).text(t.total_tokens_used.toLocaleString()),_(".detailed-usage-modal .card h2").eq(2).text(t.total_requests),_(".detailed-usage-modal .card h2").eq(3).text(t.unique_users),_(".detailed-usage-modal .card h3").eq(0).text(t.premium_credits),_(".detailed-usage-modal .card h3").eq(1).text(t.basic_credits),_(".detailed-usage-modal .badge.bg-primary").text(`${a.length} of ${e.pagination.total} records`),_("#usage-datatable tbody"));if(s.empty(),a.forEach(e=>{e=`
                    <tr style="border-bottom: 1px solid #f8f9fa;">
                        <td style="padding: 12px; vertical-align: middle; font-weight: 500;">${new Date(e.created_at).toLocaleDateString()}</td>
                        <td style="padding: 12px; vertical-align: middle;">
                            <span class="badge bg-light text-dark" style="border-radius: 20px; padding: 4px 8px;">
                                ${e.user_id||"N/A"}
                            </span>
                        </td>
                        <td style="padding: 12px; vertical-align: middle;">
                            <span class="badge ${"premium"===e.credit_type?"bg-primary":"bg-success"}" style="border-radius: 20px; padding: 6px 12px; font-weight: 500;">
                                <i class="fas ${"premium"===e.credit_type?"fa-crown":"fa-layer-group"} me-1"></i>
                                ${e.credit_type}
                            </span>
                        </td>
                        <td style="padding: 12px; vertical-align: middle; font-weight: 600; color: #667eea;">${e.credits_charged}</td>
                        <td style="padding: 12px; vertical-align: middle; font-weight: 500;">${e.tokens_used.toLocaleString()}</td>
                        <td style="padding: 12px; vertical-align: middle;">
                            <span class="badge bg-info text-white" style="border-radius: 20px; padding: 4px 8px;">
                                ${e.llm_provider}
                            </span>
                        </td>
                        <td style="padding: 12px; vertical-align: middle; max-width: 200px;">
                            <div style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${e.message_preview||"No message"}">
                                ${e.message_preview?e.message_preview.substring(0,50)+"...":"N/A"}
                            </div>
                        </td>
                    </tr>
                `;s.append(e)}),this.usageDataTable&&"function"==typeof this.usageDataTable.refresh)try{this.usageDataTable.refresh()}catch(e){console.error("Error refreshing Simple DataTable:",e)}},updateReportData:function(e){const t=_("#report-table"),a=(t.empty(),_("<thead><tr></tr></thead>")),s=(e.columns.forEach(e=>{a.find("tr").append(`<th>${e}</th>`)}),t.append(a),_("<tbody></tbody>"));e.rows.forEach(e=>{const t=_("<tr></tr>");e.forEach(e=>{t.append(`<td>${e}</td>`)}),s.append(t)}),t.append(s)},updateVisualizations:function(e){const t=_("#chart-container");t.empty();var a=_("<canvas></canvas>"),s=(t.append(a),_("#chart-type").val());new k(a[0],{type:s,data:{labels:e.labels,datasets:e.datasets.map(e=>({label:e.label,data:e.data,backgroundColor:e.backgroundColor,borderColor:e.borderColor,borderWidth:1}))},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{position:"top"},title:{display:!0,text:e.title}}}})},detectNumericColumns:function(i,e){return i&&0!==i.length?e.filter(t=>{let a=0;var s=Math.min(i.length,20);for(let e=0;e<s;e++){var r=i[e][t];null!=r&&""!==r&&(r=parseFloat(r),!isNaN(r)&&isFinite(r)&&a++)}return a>=.5*s}):[]},generateChartColors:function(t){var a=["#2563eb","#10b981","#f59e0b","#ef4444","#8b5cf6","#06b6d4","#ec4899","#84cc16","#f97316","#6366f1","#14b8a6","#a855f7","#eab308","#22c55e","#3b82f6"];const s=[];for(let e=0;e<t;e++)s.push(a[e%a.length]);return s},createReportChartConfig:function(e,t,a,s,r,i){i={responsive:!0,maintainAspectRatio:!1,plugins:{title:{display:!0,text:i||"Report Chart",font:{size:16,weight:"bold"},padding:{top:10,bottom:20}},legend:{display:"pie"===e||"doughnut"===e,position:"right"}}};return"pie"===e||"doughnut"===e?{type:e,data:{labels:t,datasets:[{data:a,backgroundColor:r,borderColor:"#fff",borderWidth:2}]},options:i}:"line"===e?{type:"line",data:{labels:t,datasets:[{label:s,data:a,borderColor:r[0],backgroundColor:r[0]+"40",borderWidth:3,fill:!0,tension:.4}]},options:{...i,scales:{y:{beginAtZero:!0},x:{ticks:{maxRotation:45,minRotation:45}}}}}:{type:"bar",data:{labels:t,datasets:[{label:s,data:a,backgroundColor:r,borderColor:r,borderWidth:1}]},options:{...i,scales:{y:{beginAtZero:!0},x:{ticks:{maxRotation:45,minRotation:45}}}}}},renderReportChartFromSelectors:function(e,t){if(e&&0!==e.length){var a=_("#report-chart-type").val()||"bar";const o=_("#report-chart-x-axis").val(),n=_("#report-chart-y-axis").val();if(o&&n){var s=n.replace(/_/g," ").replace(/\b\w/g,e=>e.toUpperCase());const l=e.slice(0,50);var e=l.map(e=>{e=e[o];if(null==e)return"Unknown";const t=String(e);return 30<t.length?t.substring(0,30)+"...":t}),r=l.map(e=>parseFloat(e[n])||0),i=this.generateChartColors(r.length),a=this.createReportChartConfig(a,e,r,s,i,t);const d=document.getElementById("reportChart");if(d){this.reportChartInstance&&this.reportChartInstance.destroy();try{this.reportChartInstance=new k(d.getContext("2d"),a)}catch(e){console.error("Error creating chart:",e)}}}}},showLoading:function(){_(".ai-thinking-loader-wrapper").remove(),this.loaderShownAt=Date.now();const e=_("#chat-container");0<e.length&&(e.append(`
                <div class="message-wrapper ai-message-wrapper ai-thinking-loader-wrapper" style="margin: 10px 0;">
                    <div class="message ai-message ai-thinking-loader" style="
                        max-width: 70%;
                        margin-left: 20px;
                        padding: 15px 20px;
                        background: linear-gradient(135deg, #f0f4f8 0%, #e9ecef 100%);
                        border-radius: 18px 18px 18px 4px;
                        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
                        display: flex;
                        align-items: center;
                        gap: 12px;
                    ">
                        <div class="ai-avatar-loader" style="
                            padding: 8px 12px;
                            background: linear-gradient(135deg, #0ea5e9 0%, #2563eb 100%);
                            border-radius: 20px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            color: white;
                            font-weight: 600;
                            font-size: 13px;
                            flex-shrink: 0;
                            animation: pulse-glow-loader 2s infinite;
                            font-family: system-ui, -apple-system, sans-serif;
                            letter-spacing: 0.5px;
                        ">Adeptus AI</div>
                        <div class="thinking-dots" style="
                            display: flex;
                            align-items: center;
                            gap: 4px;
                        ">
                            <span class="thinking-text" style="
                                color: #6c757d;
                                font-size: 14px;
                                margin-right: 8px;
                                font-style: italic;
                            ">Thinking</span>
                            <span class="dot dot-1" style="
                                width: 8px;
                                height: 8px;
                                border-radius: 50%;
                                background: #0ea5e9;
                                display: inline-block;
                                animation: bounce-loader 1.4s infinite ease-in-out both;
                                animation-delay: -0.32s;
                            "></span>
                            <span class="dot dot-2" style="
                                width: 8px;
                                height: 8px;
                                border-radius: 50%;
                                background: #2563eb;
                                display: inline-block;
                                animation: bounce-loader 1.4s infinite ease-in-out both;
                                animation-delay: -0.16s;
                            "></span>
                            <span class="dot dot-3" style="
                                width: 8px;
                                height: 8px;
                                border-radius: 50%;
                                background: #0ea5e9;
                                display: inline-block;
                                animation: bounce-loader 1.4s infinite ease-in-out both;
                            "></span>
                        </div>
                    </div>
                </div>
            `),this.scrollToBottom())},hideLoading:function(){var e=this.loaderShownAt?Date.now()-this.loaderShownAt:0,e=Math.max(0,800-e);setTimeout(()=>{_(".ai-thinking-loader-wrapper").fadeOut(200,function(){_(this).remove()}),_(".ai-thinking-loader").fadeOut(200,function(){_(this).remove()}),_("#loading-indicator").addClass("d-none")},e)},showError:function(e){const t=_("#error-message");_("#error-text").text(e),t.removeClass("d-none"),setTimeout(()=>{t.addClass("d-none")},5e3)},showSuccess:function(e){0===_("#success-message").length&&_("body").append(`
                    <div class="alert alert-success alert-dismissible fade show d-none" role="alert" id="success-message" style="position:fixed; top:20px; right:20px; z-index:1050;">
                        <i class="fa fa-check-circle me-2"></i>
                        <span id="success-text"></span>
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                `);const t=_("#success-message");_("#success-text").text(e),t.removeClass("d-none"),setTimeout(()=>{t.addClass("d-none")},3e3)},scrollToBottom:function(){const e=_("#chat-container");e.scrollTop(e[0].scrollHeight)},loadChatHistory:function(){const r=_("#chat-history-list");r.html(`
                <li class="list-group-item d-flex justify-content-center" id="chat-history-loading">
                    <div class="spinner-border text-secondary" role="status">
                        <span class="sr-only">Loading...</span>
                    </div>
                </li>
            `),this.ajaxWithAuth({url:this.backendUrl+"/chat/history",method:"GET",success:e=>{r.empty(),e&&e.chats&&Array.isArray(e.chats)?e.chats.length?(e.chats.forEach(e=>{var t=e.created_at?new Date(e.created_at).toLocaleString():"Unknown date",a=e.last_message||e.title||e.snippet||e.first_message||"Chat session",s=e.report_count||0;e.id&&(e=_(`
                                    <li class="list-group-item d-flex justify-content-between align-items-start chat-history-item" data-chat-id="${e.id}">
                                        <div>
                                            <small class="text-muted">${t}</small><br>
                                            ${a}
                                        </div>
                                        ${0<s?`<span class="badge bg-primary d-flex align-items-center report-count"><i class="fa fa-chart-bar me-1"></i>${s}</span>`:""}
                                    </li>
                                `),r.append(e))}),_(".chat-history-item").on("click",e=>{const t=_(e.currentTarget);e=t.data("chat-id");this.loadChatMessages(e,t)}),0===this.currentChatId&&0===_("#chat-container").children().length&&this.showWelcomeMessage()):(e=c.getAuthStatus())&&e.subscription&&0<e.subscription.reports_generated_this_month?r.append('<li class="list-group-item text-center">No chats yet</li>'):(r.append(`
                                <li class="list-group-item text-center">
                                    <div class="text-muted">
                                        <i class="fa fa-comments fa-2x mb-2"></i>
                                        <p class="mb-1">No chat history yet</p>
                                        <small>Start a conversation to see your chat history here</small>
                                    </div>
                                </li>
                            `),0===_("#chat-container").children().length&&this.showWelcomeMessage()):r.append(`
                            <li class="list-group-item text-center">
                                <div class="text-muted">
                                    <i class="fa fa-comments fa-2x mb-2"></i>
                                    <p class="mb-1">No chat history available</p>
                                    <small>Start a conversation to see your chat history here</small>
                                </div>
                            </li>
                        `)},error:(e,t,a)=>{console.error("[Chat History] Failed to load:",a),r.html(`
                        <li class="list-group-item text-center">
                            <div class="text-danger">
                                <i class="fa fa-exclamation-triangle fa-2x mb-2"></i>
                                <p class="mb-2">Failed to load chat history</p>
                                <button id="reload-chat-history" class="btn btn-outline-primary btn-sm">
                                    <i class="fa fa-refresh"></i> Try Again
                                </button>
                            </div>
                        </li>
                    `),_("#reload-chat-history").on("click",()=>this.loadChatHistory())}})},loadChatMessages:function(e,t){this.currentChatId=e,_("#chat-history-list li").removeClass("active"),t.addClass("active"),_("#chat-container").empty(),this.clearMCQ(),this.showLoading();t=this.backendUrl+`/chat/${e}/messages`;this.ajaxWithAuth({url:t,method:"GET",success:l=>{this.hideLoading(),l.credit_data&&l.credit_data.summary&&this.updateSubscriptionDataFromCreditResponse(l.credit_data);var e=c.getAuthStatus();if(e&&e.subscription&&this.checkAndShowCreditLimitWarning(e.subscription),l.messages.forEach((e,t)=>{if(e.sender_type=e.role||e.sender_type,e.body=e.content||e.body,e.timestamp=e.created_at||e.timestamp,"assistant"===e.sender_type&&(e.sender_type="ai"),"sql"!==e.tag){if("ai"===e.sender_type&&"mcq"===e.tag){var a=l.messages[t+1],a=a&&"user"===a.sender_type?a.body:null;const s=this.extractMCQFromText(e.body);if(s&&0<s.questions.length){s.selectedAnswer=a;a=this.renderMCQHistory(s.questions,a);const r=document.getElementById("message-template"),i=r.content.cloneNode(!0),o=i.querySelector(".message");return o.classList.add("ai-message"),o.setAttribute("data-message-id",e.id),i.querySelector(".message-text").innerHTML=a,i.querySelector(".message-time").textContent=this.formatTimestamp(e.timestamp),void _("#chat-container").append(i)}}if("user"===e.sender_type&&0<t){a=l.messages[t-1];if(a&&"ai"===a.sender_type&&"mcq"===a.tag)return}if(e.metadata&&"report"===e.metadata.type||e.body&&e.body.startsWith("ðŸ“Š Report saved:")){if(!e.metadata&&e.body){t=e.body.match(/ðŸ“Š Report saved: (.+)/);const n=t?t[1]:"Report";a=n.toLowerCase().replace(/\s+/g,"-").replace(/[^a-z0-9-]/g,"");e.metadata={type:"report",report_name:n,report_slug:a}}this.displayReportLink(e)}else this.addMessage(e.body,e.sender_type,!1,null,e.id,e.timestamp)}}),this.scrollToBottom(),l.reports&&l.reports.length&&l.reports.forEach(e=>{this.insertReportLinkInChat(e)}),0<l.messages.length){const t=l.messages[l.messages.length-1];if("mcq"===t.tag){const a=t.body.match(/\{[\s\S]*?\}/g)||[],s=[];a.forEach(e=>{try{var t=JSON.parse(e);"mcq"===t.type&&Array.isArray(t.options)&&s.push(t)}catch(e){}}),s.length&&this.enqueueMCQs(s)}}},error:()=>{this.hideLoading(),this.showError("Could not load conversation.")}})},insertReportLinkInChat:function(e){const t=_(`#chat-container .message[data-message-id="${e.message_after_id}"]`);if(t.length){e=`
                <div class="message ai-message">
                  <div class="message-content">
                    <div class="message-text">
                      <a href="javascript:void(0)" class="report-link" data-report-slug="${e.slug}" 
                         style="color: #007bff; text-decoration: none; padding:4px 8px; border:1px solid #dee2e6; border-radius:4px; background:#f8f9fa; display:inline-block; transition:all 0.2s;">
                        ðŸ“Š ${e.description}
                      </a>
                    </div>
                    <div class="message-time small text-muted">${new Date(e.created_at).toLocaleTimeString()}</div>
                  </div>
                </div>
            `;const a=_(e),s=this;a.find(".report-link").on("click",function(){var e=_(this).data("report-slug");s.openReportFromLink(e)}).on("mouseenter",function(){_(this).css({"background-color":"#e9ecef","border-color":"#adb5bd",transform:"translateY(-1px)"})}).on("mouseleave",function(){_(this).css({"background-color":"#f8f9fa","border-color":"#dee2e6",transform:"translateY(0)"})}),t.after(a)}},sendMessage:function(e){if(!this.currentMCQ&&!this.isSending){const a=_("#message-input"),s=(e?String(e):a.val()||"").trim();if(s){const r=s.trim();if(r){this.isSending=!0,_(".welcome-message").remove();const i=this.addMessage(r,"user");e||a.val("").trigger("input"),this.showLoading();var t=c.getAuthStatus()?.user||{},e={message:e?"I selected: "+r:r,chat_id:this.currentChatId||0,user_id:t.id||null,user_name:t.name||null};this.ajaxWithAuth({url:this.backendUrl+"/chat/message",method:"POST",contentType:"application/json",data:JSON.stringify(e),success:e=>{this.hideLoading(),this.isSending=!1,e.error?"credit_limit"===e.error_type||"token_limit"===e.error_type?this.handleCreditLimitError(e.message,e.credit_data):"timeout"===e.error_type?this.handleTimeoutError(e.message):(this.addMessage(e.message,"error"),this.showResendIconOnMessage(i,r)):(_(".failed-reload-icon").remove(),!this.currentChatId&&e.chat_id&&(this.currentChatId=e.chat_id,this.addChatToChatHistory(e.chat_id,r)),this.handleResponse(e),this.refreshSubscriptionInfo())},error:a=>{if(this.hideLoading(),this.isSending=!1,401===a.status)c.clearAuthData(),this.showAuthenticationError();else if(429===a.status){let e="You have reached your credit limit. Please upgrade your plan or wait until your credits refresh.",t=null;a.responseJSON&&(e=a.responseJSON.message||e,t=a.responseJSON.credit_data||null),this.handleCreditLimitError(e,t),i.remove()}else this.showResendIconOnMessage(i,r),this.addMessage("Network error occurred. Please try again.","error")}})}}else S.fire({icon:"error",title:"Oops...",text:"Please enter a message"})}},updateSendMessageandCreateNewChatButton:function(){this.isCreditLimitExceeded?(_("#send-button").prop("disabled",!0).attr("title","Credit limit reached. Your credits will reset on the 1st of next month.").addClass("credit-limit-disabled"),_("#create-new-chat").prop("disabled",!0).attr("title","Credit limit reached. Your credits will reset on the 1st of next month.").addClass("credit-limit-disabled"),_("#message-input").prop("disabled",!0).attr("placeholder","Credit limit reached. Your credits will reset on the 1st of next month.")):(_("#send-button").prop("disabled",!1).removeAttr("title").removeClass("credit-limit-disabled"),_("#create-new-chat").prop("disabled",!1).removeAttr("title").removeClass("credit-limit-disabled"),_("#message-input").prop("disabled",!1).attr("placeholder","Type your message..."))},createNewChat:function(){this.currentChatId=0,_("#chat-history-list li").removeClass("active"),_("#chat-container").empty(),this.clearMCQ(),this.showWelcomeMessage()},showWelcomeMessage:function(){_("#chat-container").html(`
                <div class="welcome-message text-center p-5">
                    <div style="max-width: 600px; margin: 0 auto;">
                        <h3 class="mb-4">Welcome to Adeptus AI Assistant</h3>
                        <p class="text-muted mb-4">
                            I'm here to help you analyze your Moodle data and generate insightful reports.
                        </p>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="p-3 bg-light rounded">
                                    <i class="fa fa-chart-bar fa-2x mb-2 text-primary"></i>
                                    <h5>Generate Reports</h5>
                                    <small class="text-muted">Ask me to create custom reports about courses, users, grades, and more.</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="p-3 bg-light rounded">
                                    <i class="fa fa-question-circle fa-2x mb-2 text-info"></i>
                                    <h5>Get Insights</h5>
                                    <small class="text-muted">I can help you understand your data and provide actionable insights.</small>
                                </div>
                            </div>
                        </div>
                        <hr class="my-4">
                        <p class="text-muted">
                            <i class="fa fa-lightbulb"></i> Try asking: "Show me all active courses with their enrollment counts"
                        </p>
                    </div>
                </div>
            `)},addChatToChatHistory(e,t){const a=_("#chat-history-list");a.find('li:contains("No chat history")').remove(),a.find('li:contains("No chats yet")').remove(),a.find('li:contains("Start a conversation")').remove();var s=(new Date).toLocaleString(),t=t&&100<t.length?t.substring(0,97)+"...":t||"New chat";const r=_(`<li class="list-group-item d-flex justify-content-between align-items-start chat-history-item" data-chat-id="${e}">
                    <div>
                        <small class="text-muted">${s}</small><br>
                        ${t}
                    </div>
                </li>`);a.prepend(r),r.on("click",e=>{const t=_(e.currentTarget);e=t.data("chat-id");this.loadChatMessages(e,t)})},initializeCharts:function(){const e=_("#chart-container");var t=_("<canvas></canvas>");e.append(t),new k(t[0],{type:"bar",data:{labels:[],datasets:[]},options:{responsive:!0,maintainAspectRatio:!1}})},setUserName:function(e){let t="User";"string"==typeof e?t=e:e&&e.name?t=e.name:e&&e.admin_name&&(t=e.admin_name),_(".card-title").each(function(){_(this).text().includes("AI Report Assistant")&&_(this).text(t+": AI Report Assistant")})},isCreditExceeded:function(e,t){return 0!==t&&"âˆž"!==t&&null!=t&&t<=e},checkAndShowCreditLimitWarning:function(e){var t=this.isCreditExceeded(e.basic_credits_used_this_month||0,e.plan_basic_credits_limit||0),a=this.isCreditExceeded(e.premium_credits_used_this_month||0,e.plan_premium_credits_limit||0),e=this.isCreditExceeded(e.ai_credits_used_this_month||0,e.plan_ai_credits_limit||0);t||a||e?(this.showPersistentCreditLimitMessage("You've used all your AI credits for this month. Your credits will reset on the 1st of next month. Consider upgrading your plan for more credits."),this.isCreditLimitExceeded=!0):this.isCreditLimitExceeded=!1,this.updateSendMessageandCreateNewChatButton()},updateSubscriptionInfo:async function(){const a=this;try{const s=await fetch(M.cfg.wwwroot+"/report/adeptus_insights/ajax/check_subscription_status.php?t="+Date.now(),{method:"GET",headers:{"Content-Type":"application/json","Cache-Control":"no-cache"}});var e=await s.json();if(e.success&&e.data){const t=c.getAuthStatus()||{};t.subscription=e.data,"function"==typeof c.updateSubscription&&c.updateSubscription(e.data)}}catch(e){console.error("[AI Assistant] Error fetching latest subscription status:",e)}const t=c.getAuthStatus();if(t&&t.subscription){e=t.subscription,e=(this.checkAndShowCreditLimitWarning(e),_(".subscription-status-bar").remove(),`
                    <div class="subscription-status-bar">
                        <div class="subscription-bar-row">
                            <div class="subscription-info-left">
                                <h6 class="subscription-title">
                                    <i class="fa fa-chart-line subscription-icon"></i> Subscription Status
                                    <button class="btn btn-outline-secondary btn-sm" id="refresh-subscription-btn" title="Refresh subscription data">
                                        <i class="fa fa-refresh"></i>
                                    </button>
                                </h6>
                                <div class="subscription-details">
                                    <span><strong>Plan:</strong> ${e.plan_name||"Unknown"}</span>
                                    <span class="ms-3"><strong>Status:</strong> <span class="badge bg-${"active"===e.status?"success":"warning"}">${e.status||"Unknown"}</span></span>
                                </div>
                            </div>
                            <div class="subscription-actions-right">
                                <a href="javascript:void(0)" onclick="window.assistant.showCreditUsageModal()" class="btn btn-view-usage">
                                    <i class="fa fa-chart-bar"></i> View Usage
                                </a>
                            </div>
                        </div>
                    </div>
                `);const r=_(".assistant-header").siblings(".container-fluid").first();if(r.length)r.append(e);else{const i=_(".assistant-header");i.length&&i.after(e)}const a=this;_("#refresh-subscription-btn").off("click").on("click",function(){const e=_(this),t=e.find("i");t.removeClass("fa-refresh").addClass("fa-spinner fa-spin"),e.prop("disabled",!0),a.refreshSubscriptionInfo(),setTimeout(()=>{t.removeClass("fa-spinner fa-spin").addClass("fa-refresh"),e.prop("disabled",!1)},1e3)})}else _(".subscription-info").remove()},transformBackendAuthData:function(e){return e?{...window.adeptusAuthData||{},user_authorized:!0,has_api_key:!0,installation:e.installation,subscription:e.subscription?{...e.subscription,premium_credits_used_this_month:e.usage&&e.usage.premium_credits_used_this_month||0,basic_credits_used_this_month:e.usage&&e.usage.basic_credits_used_this_month||0,ai_credits_used_this_month:e.usage&&e.usage.ai_credits_used_this_month||0,reports_generated_this_month:e.usage&&e.usage.reports_generated_this_month||0,plan_name:e.plan?e.plan.name:"Unknown",plan_premium_credits_limit:e.plan&&e.plan.premium_credits_per_month||0,plan_basic_credits_limit:e.plan&&e.plan.basic_credits_per_month||"âˆž",plan_ai_credits_limit:e.plan&&e.plan.ai_credits||0,plan_exports_limit:e.plan&&e.plan.exports||"âˆž"}:null,plan:e.plan,usage:e.usage}:null},refreshSubscriptionInfo:async function(){const e=_("#refresh-subscription-btn"),t=e.find("i");e.length&&t.length&&(t.removeClass("fa-refresh").addClass("fa-spinner fa-spin"),e.prop("disabled",!0));try{const s=await fetch(M.cfg.wwwroot+"/report/adeptus_insights/ajax/check_subscription_status.php?t="+Date.now(),{method:"GET",headers:{"Content-Type":"application/json","Cache-Control":"no-cache"}});var a=await s.json();if(a.success&&a.data){const r=c.getAuthStatus()||{};r.subscription=a.data,window.adeptusAuthData&&(window.adeptusAuthData.subscription=a.data)}await this.updateSubscriptionInfo(),this.showRefreshSuccessFeedback()}catch(e){console.error("[AI Assistant] Failed to refresh subscription info:",e),this.showRefreshErrorFeedback()}finally{e.length&&t.length&&(t.removeClass("fa-spinner fa-spin").addClass("fa-refresh"),e.prop("disabled",!1))}},showRefreshSuccessFeedback:function(){const e=_(`
                <div class="refresh-success-notification" style="
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: #28a745;
                    color: white;
                    padding: 8px 16px;
                    border-radius: 4px;
                    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
                    z-index: 9999;
                    font-size: 12px;
                    opacity: 0;
                    transform: translateY(-20px);
                    transition: all 0.3s ease;
                ">
                    <i class="fa fa-check me-1"></i>
                    Usage updated
                </div>
            `);_("body").append(e),setTimeout(()=>{e.css({opacity:"1",transform:"translateY(0)"})},100),setTimeout(()=>{e.css({opacity:"0",transform:"translateY(-20px)"}),setTimeout(()=>e.remove(),300)},2e3)},showRefreshErrorFeedback:function(){const e=_(`
                <div class="refresh-error-notification" style="
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: #dc3545;
                    color: white;
                    padding: 8px 16px;
                    border-radius: 4px;
                    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
                    z-index: 9999;
                    font-size: 12px;
                    opacity: 0;
                    transform: translateY(-20px);
                    transition: all 0.3s ease;
                ">
                    <i class="fa fa-exclamation-triangle me-1"></i>
                    Failed to update usage
                </div>
            `);_("body").append(e),setTimeout(()=>{e.css({opacity:"1",transform:"translateY(0)"})},100),setTimeout(()=>{e.css({opacity:"0",transform:"translateY(-20px)"}),setTimeout(()=>e.remove(),300)},3e3)},calculateUsagePercentage:function(e,t){return t&&"âˆž"!==t&&0!==t?Math.min(e/t*100,100):0},ajaxWithAuth:function(e){if(!c.isAuthenticated())return this.showAuthenticationError(),Promise.reject(new Error("Authentication required"));var t=c.getAuthHeaders();return e.headers={...e.headers,...t},e.timeout||(e.timeout=6e4),_.ajax(e)},loadCategories:function(){const t=this;this.ajaxWithAuth({url:this.backendUrl+"/reports/categories",method:"GET",contentType:"application/json",success:e=>{e.success&&e.data&&(t.cachedCategories=e.data)},error:e=>{console.error("[AI Assistant] Failed to load categories:",e),t.cachedCategories=[{id:null,name:"General",slug:"general",color:"#6c757d",icon:"fa-folder"}]}})},getCategoryOptionsHtml:function(e){if(!this.cachedCategories||0===this.cachedCategories.length)return'<option value="">General</option>';const s=(e||"general").toLowerCase().replace(/[^a-z0-9]/g,"");return this.cachedCategories.map(e=>{var t=e.name.toLowerCase().replace(/[^a-z0-9]/g,""),a=(e.slug||"").toLowerCase().replace(/[^a-z0-9]/g,""),t=t===s||a===s;return`<option value="${e.id}" ${t?"selected":""}>${e.name}</option>`}).join("")},validateToken:function(){return c.isAuthenticated()},resendMessage:function(t,a){var e;this.isSending||(this.isSending=!0,this.showLoading(),e=c.getAuthStatus()?.user||{},this.ajaxWithAuth({url:this.backendUrl+"/chat/message",method:"POST",contentType:"application/json",data:JSON.stringify({message:a,chat_id:this.currentChatId||0,user_id:e.id||null,user_name:e.name||null}),success:e=>{this.hideLoading(),this.isSending=!1,e.error?"credit_limit"===e.error_type||"token_limit"===e.error_type?this.handleCreditLimitError(e.message,e.credit_data):(this.addMessage(e.message,"error"),this.showResendIconOnMessage(t,a)):(_(".failed-reload-icon").remove(),!this.currentChatId&&e.chat_id&&(this.currentChatId=e.chat_id,this.addChatToChatHistory(e.chat_id,a)),this.handleResponse(e))},error:e=>{this.hideLoading(),this.isSending=!1,401===e.status?(c.clearAuthData(),this.showAuthenticationError()):(this.showResendIconOnMessage(t,a),this.addMessage("Network error occurred. Please try again.","error"))}}))},enqueueMCQs:function(e){Array.isArray(e)&&0!==e.length&&(this.mcqQueue=e.slice(),this.showNextMCQ())},showNextMCQ:function(){if(0===this.mcqQueue.length)return this.clearMCQ();var e=this.mcqQueue.shift();this.renderMCQ(e.question,e.options)},sendMCQ:function(t){if(!this.isSending&&t&&"string"==typeof t&&t.trim()){this.showLoading(),this.isSending=!0,this.clearMCQ();const s=this.addMessage(t,"user");var e=c.getAuthStatus()?.user||{},a="I selected: "+t.trim();this.ajaxWithAuth({url:this.backendUrl+"/chat/message",method:"POST",contentType:"application/json",data:JSON.stringify({message:a,chat_id:this.currentChatId||0,user_id:e.id||null,user_name:e.name||null}),success:e=>{this.hideLoading(),this.isSending=!1,e.error?"credit_limit"===e.error_type||"token_limit"===e.error_type?this.handleCreditLimitError(e.message):(this.addMessage(e.message,"error"),this.showResendIconOnMessage(s,t)):(_(".failed-reload-icon").remove(),this.handleResponse(e))},error:()=>{this.hideLoading(),this.isSending=!1,this.addMessage("Failed to send choice","error"),this.showResendIconOnMessage(s,t)}})}},showReportConfirmation:function(e,t,a,s,r){this.addMessage(a||"I've generated a report: "+e.description,"ai",!1,null,null,null,s),t&&0<t.length?this.displayReportInChat(e,t):r?this.addMessage(`âš ï¸ The report could not be executed: ${r}

You can still save it and try executing it later.`,"system"):this.addMessage("â„¹ï¸ The report returned no data. You can still save it for later use.","system"),this.addReportActionButtons(e)},displayReportInChat:function(e,t){let s='<div class="report-preview-container" style="margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 8px; border: 1px solid #dee2e6;">';if(s+=`<h5 style="margin-bottom: 10px; color: #495057;">${e.name||e.description}</h5>`,t&&0<t.length){const r=Object.keys(t[0]);var a;const i=t.slice(0,20);s=(s+='<div class="table-responsive">')+'<table class="table table-sm table-striped table-hover" style="font-size: 0.9rem; margin-bottom: 0;">'+'<thead class="table-light"><tr>',r.forEach(e=>{s+=`<th style="background: #e9ecef; white-space: nowrap;">${e.replace(/_/g," ").replace(/\b\w/g,e=>e.toUpperCase())}</th>`}),s+="</tr></thead><tbody>",i.forEach(a=>{s+="<tr>",r.forEach(e=>{let t=a[e]||"";50<t.toString().length&&(t=t.toString().substring(0,47)+"..."),s+=`<td>${t}</td>`}),s+="</tr>"}),s+="</tbody></table></div>",20<t.length?(a=t.length-20,s=(s=(s=(s+='<div class="text-center mt-3"><p class="text-muted mb-2" style="font-size: 0.85rem;">')+`<strong>Showing 20 of ${t.length} rows</strong>`)+` (${a} more rows available)`+"</p>")+'<small class="text-info"><i class="fa fa-info-circle"></i> Save the report to view all data in the Reports panel</small></div>'):s+=`<p class="text-muted text-center mt-2" style="font-size: 0.85rem;">Showing all ${t.length} rows</p>`,s=(s+='<div class="mt-3 p-2 bg-light rounded" style="font-size: 0.85rem;">')+`<span class="badge badge-secondary">${e.category}</span>`+"</div>"}s+="</div>",this.addMessage(s,"report-preview",!1)},addReportActionButtons:function(r){const i=this,e=document.querySelectorAll(".report-action-container"),o=(0<e.length&&e.forEach(e=>{e.querySelector(".fa-check-circle")||e.querySelector(".fa-info-circle")||e.querySelector(".fa-exclamation-triangle")||e.remove()}),"report-action-"+Date.now());var t=`
                <div class="report-action-container" id="${o}" style="margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 8px; border: 1px solid #dee2e6;">
                    <p style="margin-bottom: 15px; font-weight: 500;">Would you like to save this report to your Reports list?</p>
                    <div class="report-actions" style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn btn-primary btn-save-report" style="padding: 8px 20px;">
                            <i class="fa fa-check-circle"></i> Save Report
                        </button>
                        <button class="btn btn-secondary btn-decline-report" style="padding: 8px 20px;">
                            <i class="fa fa-times-circle"></i> Don't Save
                        </button>
                        <button class="btn btn-outline-secondary btn-decline-feedback" style="padding: 8px 20px;">
                            <i class="fa fa-comment"></i> Decline & Give Feedback
                        </button>
                    </div>
                </div>
            `;this.addMessage(t,"system-action",!1),setTimeout(()=>{const s=document.getElementById(o);if(s){const e=s.querySelector(".btn-save-report"),t=(e&&!e.hasAttribute("data-handler-attached")&&(e.setAttribute("data-handler-attached","true"),e.addEventListener("click",function(){var e=i.getCategoryOptionsHtml(r.category);const t=r.name||r.description||"SCORM Activities Report";S.fire({title:"Save Your Report",html:`
                                <div style="text-align: left;">
                                    <div style="margin-bottom: 15px;">
                                        <label for="swal-report-name" style="display: block; margin-bottom: 5px; font-weight: 500;">
                                            Report Name
                                        </label>
                                        <input type="text" id="swal-report-name" class="swal2-input"
                                               placeholder="e.g., Monthly Student Progress Report"
                                               value="${t.replace(/"/g,"&quot;")}"
                                               style="margin: 0; width: 100%;">
                                    </div>
                                    <div>
                                        <label for="swal-report-category" style="display: block; margin-bottom: 5px; font-weight: 500;">
                                            Category
                                        </label>
                                        <select id="swal-report-category" class="swal2-select"
                                                style="margin: 0; width: 100%; padding: 8px 12px; border: 1px solid #d9d9d9; border-radius: 4px;">
                                            ${e}
                                        </select>
                                    </div>
                                </div>
                            `,showCancelButton:!0,confirmButtonText:'<i class="fa fa-save"></i> Save Report',cancelButtonText:"Cancel",confirmButtonColor:"#28a745",focusConfirm:!1,preConfirm:()=>{const e=document.getElementById("swal-report-name").value;var t=document.getElementById("swal-report-category").value;return e&&""!==e.trim()?255<e.length?(S.showValidationMessage("Report name is too long (max 255 characters)"),!1):{name:e.trim(),categoryId:t}:(S.showValidationMessage("Please enter a name for the report"),!1)}}).then(e=>{e.isConfirmed&&(r.name=e.value.name,r.description=e.value.name,r.category_id=e.value.categoryId?parseInt(e.value.categoryId):null,s.querySelectorAll("button").forEach(e=>e.disabled=!0),s.innerHTML=`
                                    <div style="text-align: center; color: #28a745;">
                                        <i class="fa fa-spinner fa-spin"></i> Saving "${r.name}" to your Reports list...
                                    </div>
                                `,i.confirmReport("accept",r,null))})})),s.querySelector(".btn-decline-report")),a=(t&&!t.hasAttribute("data-handler-attached")&&(t.setAttribute("data-handler-attached","true"),t.addEventListener("click",function(){s.innerHTML=`
                            <div style="text-align: center; color: #6c757d;">
                                <i class="fa fa-info-circle"></i> Report not saved. You can ask me to generate it again anytime.
                            </div>
                        `,i.addMessage("Report was not saved. Feel free to ask me to generate a different report or refine this one.","system")})),s.querySelector(".btn-decline-feedback"));a&&!a.hasAttribute("data-handler-attached")&&(a.setAttribute("data-handler-attached","true"),a.addEventListener("click",function(){s.innerHTML=`
                            <div class="feedback-form">
                                <p style="margin-bottom: 10px;">What would you like to change about this report?</p>
                                <textarea id="feedback-text-${o}" class="form-control" rows="3" placeholder="Please provide your feedback..."></textarea>
                                <div style="margin-top: 10px; display: flex; gap: 10px;">
                                    <button class="btn btn-primary btn-send-feedback">
                                        <i class="fa fa-paper-plane"></i> Send Feedback
                                    </button>
                                    <button class="btn btn-secondary btn-cancel-feedback">
                                        Cancel
                                    </button>
                                </div>
                            </div>
                        `;const e=s.querySelector(".btn-send-feedback"),t=s.querySelector(".btn-cancel-feedback"),a=s.querySelector("#feedback-text-"+o);e&&e.addEventListener("click",function(){const e=a?a.value:"";e.trim()?(s.innerHTML=`
                                        <div style="text-align: center; color: #007bff;">
                                            <i class="fa fa-spinner fa-spin"></i> Sending feedback...
                                        </div>
                                    `,i.confirmReport("decline",r,e)):(a.style.borderColor="#dc3545",a.focus())}),t&&t.addEventListener("click",function(){s.innerHTML=`
                                    <div style="text-align: center; color: #6c757d;">
                                        <i class="fa fa-info-circle"></i> Report not saved.
                                    </div>
                                `})}))}},100)},viewSavedReport:function(t){t&&(_('[href="#reports-history"]').tab("show"),setTimeout(()=>{const e=_(`.report-row[data-report-slug="${t}"]`);e.length?e.click():this.loadReportsHistory(()=>{setTimeout(()=>{const e=_(`.report-row[data-report-slug="${t}"]`);e.length?e.click():a.addNotification({message:"Report not found. Please check if it still exists in the Reports tab.",type:"error"})},500)})},300))},displayReportLink:function(e){const t=document.getElementById("message-template"),a=t.content.cloneNode(!0),s=a.querySelector(".message"),r=(s.classList.add("ai-message"),s.setAttribute("data-message-id",e.id),e.metadata?.report_slug||"");var i=e.metadata?.report_name||"Report",o=e.metadata?.report_description||"",i=`
                <div class="report-link-message">
                    <div style="padding: 15px; background: linear-gradient(135deg, #007bff 0%, #0056b3 100%); color: white; border-radius: 10px; margin: 10px 0;">
                        <div style="display: flex; align-items: center; justify-content: space-between; gap: 20px;">
                            <div style="flex: 1;">
                                <h5 style="margin: 0; color: white;">
                                    <i class="fa fa-chart-bar"></i> ${i}
                                </h5>
                                ${o?`<small style="opacity: 0.9;">${o}</small>`:""}
                            </div>
                            ${r?`
                                <button class="btn btn-light btn-sm view-saved-report-btn"
                                        data-slug="${r}"
                                        style="cursor: pointer; border-radius: 5px; flex-shrink: 0;">
                                    <i class="fa fa-eye"></i> View Report
                                </button>
                            `:""}
                        </div>
                    </div>
                </div>
            `;a.querySelector(".message-text").innerHTML=i,a.querySelector(".message-time").textContent=this.formatTimestamp(e.timestamp),_("#chat-container").append(a);const n=this;setTimeout(()=>{const e=_("#chat-container").find('.view-saved-report-btn[data-slug="'+r+'"]').last();e.length&&!e.hasClass("click-handler-attached")&&(e.addClass("click-handler-attached"),e.on("click",function(e){e.preventDefault(),e.stopPropagation(),n.switchToReportsTab();const t=_(`.report-row[data-report-slug="${r}"]`);0<t.length?t.trigger("click"):n.fetchAndDisplayReport(r)}))},100)},sendReportMessage:function(e){var t=c.getAuthStatus()?.user||{},a="ðŸ“Š Report saved: "+(e.description||e.name),s={id:Date.now(),sender_type:"ai",body:a,timestamp:(new Date).toISOString(),metadata:{type:"report",report_slug:e.slug,report_name:e.name||e.description,report_description:e.description}};this.displayReportLink(s),this.ajaxWithAuth({url:this.backendUrl+"/chat/message",method:"POST",contentType:"application/json",data:JSON.stringify({message:a,chat_id:this.currentChatId,user_id:t.id||null,user_name:t.name||null,metadata:{type:"report",report_slug:e.slug,report_name:e.name||e.description,report_description:e.description}}),success:()=>{},error:()=>{}})},confirmReport:function(o,n,l){const d=this;this.showLoading();var e=c.getAuthStatus()?.user||{},t={name:n.name||n.description||"Generated Report",description:n.description||"",sql:n.sql||"",category:n.category||"general",category_id:n.category_id||null},a=parseInt(this.currentChatId)||0;this.ajaxWithAuth({url:this.backendUrl+"/chat/report-confirmation",method:"POST",contentType:"application/json",timeout:9e4,data:JSON.stringify({chat_id:a,action:o,feedback:l||null,report:t,user_id:e.id||null}),success:e=>{if(this.hideLoading(),"accept"===o&&e.report)Array.isArray(this.cachedReports)||(this.cachedReports=[]),this.cachedReports.unshift(e.report),this.updateReportsHistory(this.cachedReports),this.sendReportMessage(e.report),_("#report-history-loader").addClass("d-none"),_("#report-history-table-wrapper").removeClass("d-none"),_("#reports-history-table").removeClass("d-none"),document.querySelectorAll(".report-action-container").forEach(e=>{e.innerHTML=`
                                <div style="text-align: center; color: #28a745; padding: 10px;">
                                    <i class="fa fa-check-circle"></i> Report saved successfully!
                                </div>
                            `});else if(e.chat_response){const a=e.chat_response;if(a.error||a.message&&(a.message.toLowerCase().includes("trouble connecting")||a.message.toLowerCase().includes("service")||a.message.toLowerCase().includes("try again"))){const s=a.message||"The AI service is temporarily unavailable.";document.querySelectorAll(".report-action-container").forEach(e=>{var t="retry-feedback-"+Date.now();e.innerHTML=`
                                        <div style="text-align: center; padding: 10px;">
                                            <div style="color: #dc3545; margin-bottom: 10px;">
                                                <i class="fa fa-exclamation-circle"></i> ${s}
                                            </div>
                                            <button id="${t}" class="btn btn-primary btn-sm">
                                                <i class="fa fa-refresh"></i> Retry
                                            </button>
                                        </div>
                                    `;const a=document.getElementById(t);a&&a.addEventListener("click",function(){d.confirmReport(o,n,l)})}),this.addMessage(s,"error")}else{var t=a.type&&("sql"===a.type||"report"===a.type)&&a.report&&a.awaiting_confirmation;a.message&&(a.message.toLowerCase().includes("report generated")||a.message.toLowerCase().includes("generated a report")||a.message.toLowerCase().includes("i've generated"))&&!t?(document.querySelectorAll(".report-action-container").forEach(e=>{var t="retry-ghost-"+Date.now();e.innerHTML=`
                                            <div style="text-align: center; padding: 10px;">
                                                <div style="color: #856404; background: #fff3cd; padding: 12px; border-radius: 6px; margin-bottom: 10px;">
                                                    <i class="fa fa-exclamation-triangle"></i>
                                                    The refined report was generated but could not be displayed properly.
                                                </div>
                                                <button id="${t}" class="btn btn-primary btn-sm">
                                                    <i class="fa fa-refresh"></i> Try Again
                                                </button>
                                            </div>
                                        `;const a=document.getElementById(t);a&&a.addEventListener("click",function(){d.confirmReport(o,n,l)})}),this.addMessage("The report refinement encountered an issue. Please try again using the button above, or start a new request.","system")):(t?document.querySelectorAll(".report-action-container").forEach(e=>{e.innerHTML=`
                                            <div style="text-align: center; color: #007bff;">
                                                <i class="fa fa-info-circle"></i> Feedback sent. I'll refine the report based on your input.
                                            </div>
                                        `}):document.querySelectorAll(".report-action-container").forEach(e=>{e.innerHTML=`
                                            <div style="text-align: center; color: #007bff;">
                                                <i class="fa fa-info-circle"></i> Feedback sent.
                                            </div>
                                        `}),this.handleResponse(e.chat_response))}}else document.querySelectorAll(".report-action-container").forEach(e=>{e.innerHTML=`
                                    <div style="text-align: center; color: #007bff;">
                                        <i class="fa fa-info-circle"></i> Feedback sent.
                                    </div>
                                `})},error:(e,t,a)=>{this.hideLoading(),console.error("[AI Assistant] Report confirmation failed:",{status:e.status,statusText:t,error:a,responseText:e.responseText,responseJSON:e.responseJSON});let r="Failed to process request. Please try again.",i=!0;if("timeout"===t)r="Request timed out. The AI service may be busy. Please try again.";else if(0===e.status)r="Network error. Please check your connection and try again.";else if(401===e.status)r="Session expired. Please refresh the page and log in again.",i=!1;else if(429===e.status)r="Too many requests. Please wait a moment and try again.";else if(500<=e.status)r="Server error. Please try again in a moment.";else if(e.responseJSON&&e.responseJSON.errors){console.error("[AI Assistant] Validation errors:",e.responseJSON.errors);const s=e.responseJSON.errors;a=Object.keys(s).map(e=>e+": "+s[e].join(", ")).join("; ");r="Validation failed: "+a,i=!1}else e.responseJSON&&e.responseJSON.message&&(r=e.responseJSON.message);document.querySelectorAll(".report-action-container").forEach(e=>{var t="retry-error-"+Date.now();let a="";if(i&&(a=`
                                <button id="${t}" class="btn btn-outline-primary btn-sm" style="margin-top: 10px;">
                                    <i class="fa fa-refresh"></i> Try Again
                                </button>
                            `),e.innerHTML=`
                            <div style="text-align: center; padding: 10px;">
                                <div style="color: #dc3545;">
                                    <i class="fa fa-exclamation-triangle"></i> ${r}
                                </div>
                                ${a}
                            </div>
                        `,i){const s=document.getElementById(t);s&&s.addEventListener("click",function(){d.confirmReport(o,n,l)})}})}})},switchToReportsTab:function(){setTimeout(()=>{_(".datatable-wrapper").removeClass("datatable-loading"),_("#report-history-table-wrapper .datatable-wrapper").removeClass("datatable-loading")},200),_("#reports-tab").tab("show"),_("#assistant-tab").removeClass("active").attr("aria-selected","false"),_("#reports-tab").addClass("active").attr("aria-selected","true"),_("#assistant-panel").removeClass("show active"),_("#reports-panel").addClass("show active"),_(".report-view-title").text("Select a Report"),_(".report-view-body").html('<div class="text-center py-4"><p class="text-muted">Select a report from history to view details here.</p></div>'),!this.cachedReports||Array.isArray(this.cachedReports)&&0===this.cachedReports.length&&!this.reportsLoaded?this.loadReportsHistory():(_("#report-history-loader").addClass("d-none"),_("#report-history-table-wrapper").removeClass("d-none"),this.cachedReports&&this.updateReportsHistory(this.cachedReports))},loadReportsHistory:function(i){this.cachedReports||(this.cachedReports=[]),_("#report-history-loader").removeClass("d-none"),_("#report-history-table-wrapper").addClass("d-none"),this.ajaxWithAuth({url:this.backendUrl+"/ai-reports",method:"GET",timeout:1e4,success:e=>{e=e.reports||e.data||[];this.cachedReports=Array.isArray(e)?e:[],this.reportsLoaded=!0,this.updateReportsHistory(this.cachedReports),_("#report-history-loader").addClass("d-none"),_("#report-history-table-wrapper").removeClass("d-none"),this.reportsDataTable&&(this.reportsDataTable.destroy(),this.reportsDataTable=null),setTimeout(()=>{try{const e=document.getElementById("reports-history-table");if(!e)return;var t=e.querySelector("tbody"),a=e.querySelector("thead");if(a&&t&&0<a.rows.length&&0<a.rows[0].cells.length){this.reportsDataTable&&(this.reportsDataTable.destroy(),this.reportsDataTable=null);var s=a.rows[0].cells.length;const r=t.rows;let e=0;s===(e=0<r.length?r[0].cells.length:e)&&0<s&&0<r.length&&!r[0].cells[0].textContent.includes("No reports")&&(this.reportsDataTable=new simpleDatatables.DataTable("#reports-history-table",{searchable:!0,fixedHeight:!1,perPage:10,loading:!1}),setTimeout(()=>{_(".datatable-wrapper").removeClass("datatable-loading"),_("#report-history-table-wrapper .datatable-wrapper").removeClass("datatable-loading"),_(".dataTable-loading").remove()},100))}}catch(e){console.error("Error initializing DataTable:",e)}"function"==typeof i&&i()},100)},error:(e,t,a)=>{console.error("[AI Assistant] Failed to load report history:",{status:e.status,statusText:e.statusText,error:a,responseText:e.responseText}),_("#report-history-loader").addClass("d-none"),_("#report-history-table-wrapper").removeClass("d-none");const s=_("#reports-history-table tbody");s.empty(),"timeout"===t?s.append('<tr><td colspan="3" class="text-center text-warning">Loading reports timed out. Please refresh the page.</td></tr>'):401===e.status||403===e.status?s.append('<tr><td colspan="3" class="text-center text-danger">Authentication error. Please log in again.</td></tr>'):this.cachedReports&&0<this.cachedReports.length?this.updateReportsHistory(this.cachedReports):s.append('<tr><td colspan="3" class="text-center text-muted">Unable to load reports. Please try again later.</td></tr>'),"function"==typeof i&&i()}})},updateReportsHistory:function(e){const s=_("#reports-history-table tbody"),i=this;s.empty(),e&&0!==e.length?(e.forEach(e=>{var t=i.getStatusBadge(e.status),a=new Date(e.created_at).toLocaleDateString(),e=_(`
                    <tr class="report-row" data-report-slug="${e.slug}">
                        <td>${e.description}</td>
                        <td>${a}</td>
                        <td>${t}</td>
                    </tr>`);s.append(e)}),_("#report-history-table-wrapper").off("click",".report-row"),_("#report-history-table-wrapper").on("click",".report-row",function(){const e=_(this),t=e.data("report-slug"),a=i.cachedReports.find(e=>e.slug===t);if(a){_("#report-history-loader").addClass("d-none"),_("#report-history-table-wrapper").removeClass("d-none");const s=_("#reports-panel .col-md-8 .card-body");if(s.find(".report-display-wrapper").html('<div class="w-100 d-flex justify-content-center align-items-center" style="min-height:200px"><div class="spinner-border text-primary" role="status"></div></div>'),Array.isArray(i.cachedReports)&&0<i.cachedReports.length){const r=i.cachedReports.find(e=>e.slug===a.slug);r&&r.data&&Array.isArray(r.data)&&0<r.data.length?setTimeout(()=>{i.updateReportsView(r,r.data)},300):i.fetchAndDisplayReport(a.slug,e)}else i.fetchAndDisplayReport(a.slug,e);_(".report-row").removeClass("table-primary"),e.addClass("table-primary")}else console.error("Report not found in cache:",t)})):(e=c.getAuthStatus())&&e.subscription&&0<e.subscription.reports_generated_this_month?s.append('<tr><td colspan="3" class="text-center text-muted">No reports yet</td></tr>'):s.append(`
                        <tr>
                            <td colspan="3" class="text-center text-muted">
                                <div class="py-4">
                                    <i class="fa fa-chart-bar fa-2x mb-2"></i>
                                    <p class="mb-1">No reports generated yet</p>
                                    <small>Ask the AI assistant to create reports for you</small>
                                </div>
                            </td>
                        </tr>
                    `)},fetchAndDisplayReport:function(s,a){const r=_("#reports-panel .col-md-8 .card-body");_("#report-history-loader").addClass("d-none"),_("#report-history-table-wrapper").removeClass("d-none"),r.html('<div class="report-display-wrapper w-100"><div class="w-100 d-flex justify-content-center align-items-center" style="min-height:200px"><div class="spinner-border text-primary" role="status"></div></div></div>'),this.ajaxWithAuth({url:this.backendUrl+"/ai-reports/"+s,method:"GET",success:e=>{Array.isArray(this.cachedReports)||(this.cachedReports=[]);var t=this.cachedReports.findIndex(e=>e.slug===s);-1<t?this.cachedReports[t]=Object.assign({},e.report,{data:e.data}):this.cachedReports.push(Object.assign({},e.report,{data:e.data})),!e.data||Array.isArray(e.data)&&0===e.data.length?r.find(".report-display-wrapper").html('<div class="w-100 text-center text-warning py-4"><i class="fa fa-exclamation-triangle"></i> Report completed but no data is available. The report may need to be re-executed.</div>'):(this.updateReportsView(e.report,e.data),_(".report-row").removeClass("table-primary"),a&&a.addClass("table-primary"))},error:(e,t,a)=>{console.error("fetchAndDisplayReport error:",s,t,a),console.error("XHR:",e),r.find(".report-display-wrapper").html('<div class="w-100 text-center text-danger py-4">Failed to load report. Please try again.</div>')}})},displayCurrentReport:function(e){this.updateReportsView(e),_(`.report-row[data-report-slug="${e.slug}"]`).addClass("table-primary")},displayReport:function(t){var e=this.cachedReports.find(e=>e.slug===t);e&&(this.updateReportsView(e,e.data),_(".report-row").removeClass("table-primary"),_(`.report-row[data-report-slug="${t}"]`).addClass("table-primary"))},updateReportsView:function(t,e=null){const a=this;if(a.currentViewedReport=t,a.currentViewedReportData=e,a.reportChartInstance&&(a.reportChartInstance.destroy(),a.reportChartInstance=null),a.reportGraphInstance&&(a.reportGraphInstance.destroy(),a.reportGraphInstance=null),a._vteController&&"function"==typeof a._vteController.destroy){try{a._vteController.destroy()}catch(e){console.error("Error destroying VTE controller:",e)}a._vteController=null}const r=_("#reports-panel .col-md-8 .card-body");if(0===_("#display-type-icon-style").length&&_("head").append(`
                    <style id="display-type-icon-style">
                        /* View toggle buttons */
                        .view-toggle .view-toggle-btn {
                            background: #f8f9fa;
                            border: 1px solid #dee2e6;
                            color: #495057;
                            padding: 0.35rem 0.75rem;
                            font-size: 13px;
                            transition: all 0.2s ease;
                        }
                        .view-toggle .view-toggle-btn:first-child {
                            border-radius: 6px 0 0 6px;
                        }
                        .view-toggle .view-toggle-btn:last-child {
                            border-radius: 0 6px 6px 0;
                        }
                        .view-toggle .view-toggle-btn:hover {
                            background: #e9ecef;
                        }
                        .view-toggle .view-toggle-btn.active {
                            background: #2563eb;
                            border-color: #2563eb;
                            color: white;
                        }
                        .view-toggle .view-toggle-btn i {
                            margin-right: 5px;
                        }

                        /* Chart controls wrapper */
                        .chart-controls-wrapper {
                            background: #f8f9fa;
                            border-radius: 8px;
                            padding: 1rem;
                            border: 1px solid #e9ecef;
                        }
                        .chart-controls {
                            display: flex;
                            align-items: flex-end;
                            flex-wrap: wrap;
                        }
                        .chart-controls .control-group {
                            display: flex;
                            flex-direction: column;
                            gap: 0.25rem;
                        }
                        .chart-controls .form-label {
                            font-size: 11px;
                            font-weight: 600;
                            color: #6c757d;
                            margin-bottom: 0;
                            text-transform: uppercase;
                            letter-spacing: 0.5px;
                        }
                        .chart-controls .form-select {
                            font-size: 13px;
                            padding: 0.4rem 2rem 0.4rem 0.75rem;
                            border-radius: 6px;
                            border: 1px solid #dee2e6;
                            background-color: white;
                            min-width: 140px;
                        }
                        .chart-controls .form-select:focus {
                            border-color: #2563eb;
                            box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.15);
                        }

                        /* Legacy icon button styles */
                        .btn-icon {
                            transition: transform 0.15s cubic-bezier(.4,2,.6,1), background 0.2s, border 0.2s;
                            background: #f8f9fa;
                            border: 1.5px solid #e0e0e0;
                            color: #333;
                        }
                        .btn-icon:hover {
                            transform: scale(1.15);
                            background: #e9ecef;
                            border-color: #b3d7ff;
                            color: #007bff;
                            z-index: 2;
                        }
                        .btn-icon.active, .btn-icon:focus {
                            background: #e3f0ff;
                            border-color: #007bff;
                            color: #007bff;
                            box-shadow: 0 0 0 2px #b3d7ff33;
                        }
                    </style>
                `),_(".report-view-title").text(t.description),Array.isArray(e)&&0!==e.length){const l=Object.keys(e[0]||{}),d=this.detectNumericColumns(e,l);let s='<div class="chart-controls-wrapper mb-3">';s=(s=(s=(s=(s=(s=s+'<div class="chart-controls d-flex flex-wrap align-items-end gap-3">'+'<div class="control-group">')+'<label for="report-chart-type" class="form-label">Chart Type</label>'+'<select id="report-chart-type" class="form-select form-select-sm">')+'<option value="bar">Bar Chart</option>'+'<option value="line">Line Chart</option>')+'<option value="pie">Pie Chart</option>'+'<option value="doughnut">Doughnut Chart</option>')+"</select></div>"+'<div class="control-group">')+'<label for="report-chart-x-axis" class="form-label">X-Axis (Labels)</label>'+'<select id="report-chart-x-axis" class="form-select form-select-sm">',l.forEach((e,t)=>{var a=e.replace(/_/g," ").replace(/\b\w/g,e=>e.toUpperCase()),t=0===t?" selected":"";s+=`<option value="${e}"${t}>${a}</option>`}),s=(s=s+"</select></div>"+'<div class="control-group">')+'<label for="report-chart-y-axis" class="form-label">Y-Axis (Values)</label>'+'<select id="report-chart-y-axis" class="form-select form-select-sm">',0<d.length?d.forEach((e,t)=>{var a=e.replace(/_/g," ").replace(/\b\w/g,e=>e.toUpperCase()),t=t===d.length-1?" selected":"";s+=`<option value="${e}"${t}>${a}</option>`}):l.forEach((e,t)=>{var a=e.replace(/_/g," ").replace(/\b\w/g,e=>e.toUpperCase()),t=t===l.length-1?" selected":"";s+=`<option value="${e}"${t}>${a}</option>`}),s=s+"</select></div>"+"</div></div>";var i=`
                <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap">
                    <div class="action-buttons d-flex gap-2">
                        <button class="btn btn-outline-secondary btn-sm export-csv-btn mr-10">
                            <i class="fa fa-download me-1"></i>Export CSV
                        </button>
                        <button class="btn btn-outline-secondary btn-sm export-json-btn">
                            <i class="fa fa-code me-1"></i>Export JSON
                        </button>
                    </div>
                    <div class="view-toggle btn-group" role="group">
                        <button type="button" class="btn btn-sm view-toggle-btn${"chart"!==t.display_type?" active":""}" data-type="table"><i class="fa fa-table"></i> Table</button>
                        <button type="button" class="btn btn-sm view-toggle-btn${"chart"===t.display_type?" active":""}" data-type="chart"><i class="fa fa-bar-chart"></i> Chart</button>
                    </div>
                </div>
            `,o="chart"===t.display_type,n='<div class="report-display-area w-100">',n=(n=(n=(n=(n=(n+=`<div class="report-view-panel${o?" d-none":""}" data-type="table">`)+this.renderReportData(e))+"</div>"+`<div class="report-view-panel${o?"":" d-none"}" data-type="chart">`)+s)+'<div class="chart-container" style="position: relative; height: 400px; border: 1px solid #e9ecef; border-radius: 8px; padding: 1rem; background: #fff;">'+'<canvas id="reportChart"></canvas>')+"</div></div>"+"</div>";r.html(`
                ${i}
                <div class="report-display-wrapper w-100 position-relative">
                    ${n}
                </div>
            `),a._currentReportData=e,a._currentReportName=t.description||t.name||"Report",this._pendingTableId&&"chart"!==t.display_type&&setTimeout(()=>{if(document.getElementById(this._pendingTableId)&&window.VTE)try{this._vteController=window.VTE.enhance("#"+this._pendingTableId,{perPage:10,perPageOptions:[10,25,50,100],labels:{search:"Search",rows:"Rows per page",info:(e,t,a)=>`Showing ${e}â€“${t} of ${a} entries`,noData:"No matching records found"}})[0]}catch(e){console.error("Error initializing Vanilla Table Enhancer:",e)}this._pendingTableId=null},100),"chart"===t.display_type&&setTimeout(()=>{a.renderReportChartFromSelectors(e,a._currentReportName)},100),r.find(".view-toggle-btn").on("click",function(){const e=_(this).data("type");r.find(".view-toggle-btn").removeClass("active"),_(this).addClass("active"),r.find(".report-view-panel").addClass("d-none"),r.find(`.report-view-panel[data-type="${e}"]`).removeClass("d-none"),"table"===e&&!a._vteController&&a._pendingTableId&&setTimeout(()=>{if(document.getElementById(a._pendingTableId)&&window.VTE)try{a._vteController=window.VTE.enhance("#"+a._pendingTableId,{perPage:10,perPageOptions:[10,25,50,100],labels:{search:"Search",rows:"Rows per page",info:(e,t,a)=>`Showing ${e}â€“${t} of ${a} entries`,noData:"No matching records found"}})[0]}catch(e){console.error("Error initializing Vanilla Table Enhancer on view switch:",e)}},100),"chart"===e&&setTimeout(()=>{a.renderReportChartFromSelectors(a._currentReportData,a._currentReportName)},100),e!==t.display_type?0===r.find(".save-display-type-btn").length&&(r.find(".view-toggle").after('<button class="btn btn-sm btn-outline-primary save-display-type-btn ms-2"><i class="fa fa-save"></i> Save View</button>'),r.find(".save-display-type-btn").on("click",function(){a.saveDisplayType(t.slug,e)})):r.find(".save-display-type-btn").remove()}),r.find("#report-chart-type, #report-chart-x-axis, #report-chart-y-axis").on("change",function(){a.renderReportChartFromSelectors(a._currentReportData,a._currentReportName)}),r.find(".export-csv-btn").on("click",()=>a.exportReport(t.slug,"csv")),r.find(".export-json-btn").on("click",()=>a.exportReport(t.slug,"json"))}else r.find(".report-display-wrapper").html('<div class="w-100 text-center text-muted py-4">No data available for this report.</div>')},linkifyUrls:function(e){if(!e||"string"!=typeof e)return e||"";const t=String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");return t.replace(/(\bhttps?:\/\/[^\s<>"']+)/gi,function(e){var t=50<e.length?e.substring(0,47)+"...":e;return`<a href="${e}" target="_blank" rel="noopener noreferrer" class="report-url-link" title="${e}">${t}</a>`})},formatCellValue:function(e,t){if(null==e||""===e)return"";const a=String(e),s=(t||"").toLowerCase();return s.includes("url")||s.includes("link")||s.includes("profile")||s.includes("href")||a.match(/^https?:\/\//i)?this.linkifyUrls(a):String(a).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")},renderReportData:function(s){if(!s||0===s.length)return'<p class="text-muted">No data available.</p>';const a=this,e=Object.keys(s[0]);var t="enhanced-report-table-"+Date.now();let r=`<div class="table-responsive"><table id="${t}" class="table table-striped table-hover">`;return r+="<thead><tr>",e.forEach(t=>{var e=s.every(e=>{e=e[t];return null==e||""===e||!isNaN(parseFloat(e))}),a=!e&&s.some(e=>{e=e[t];return e&&!isNaN(Date.parse(e))}),e=e?' data-vte="number"':a?' data-vte="date"':"";r+=`<th${e}>${t.replace(/_/g," ").replace(/\b\w/g,e=>e.toUpperCase())}</th>`}),r=r+"</tr></thead>"+"<tbody>",s.forEach(t=>{r+="<tr>",e.forEach(e=>{e=a.formatCellValue(t[e],e);r+=`<td>${e}</td>`}),r+="</tr>"}),r+="</tbody></table></div>",this._pendingTableId=t,r},getStatusBadge:function(e){return`<span class="badge ${this.getStatusBadgeClass(e)}" style="color: white;">${e}</span>`},getStatusBadgeClass:function(e){switch(e){case"completed":case"ready":return"bg-success";case"processing":return"bg-warning text-dark";case"pending":return"bg-info";case"failed":case"error":return"bg-danger";default:return"bg-secondary"}},executeReport:function(a){const r=_(`.report-row[data-report-slug="${a}"]`),i=r.html();r.html('<td colspan="3" class="text-center"><div class="spinner-border spinner-border-sm text-primary" role="status"><span class="visually-hidden">Executing...</span></div> Executing report...</td>'),this.ajaxWithAuth({url:this.backendUrl+`/ai-reports/${a}/execute`,method:"POST",success:e=>{var t;e.success?(!Array.isArray(this.cachedReports)||-1!==(t=this.cachedReports.findIndex(e=>e.slug===a))&&(this.cachedReports[t]=Object.assign({},this.cachedReports[t],e.report)),setTimeout(()=>{this.fetchAndDisplayReport(a,r)},1e3),this.showSuccess("Report executed successfully!")):(r.html(i),this.showError("Failed to execute report: "+(e.error||"Unknown error")))},error:(e,t,a)=>{r.html(i);let s="Failed to execute report";500===e.status?s="Server error occurred while executing the report. Please check the SQL query and try again.":403===e.status?s="You do not have permission to execute this report.":404===e.status?s="Report not found.":e.responseJSON&&e.responseJSON.error?s=e.responseJSON.error:s+=": "+a,console.error("Report execution failed:",{status:e.status,error:a,response:e.responseText}),this.showError(s)}})},exportReport:async function(t,a){var s,r,i=this;S.fire({title:`Exporting as ${a.toUpperCase()}...`,allowOutsideClick:!1,didOpen:()=>S.showLoading()});try{let e=`reportid=${encodeURIComponent(t)}&format=${a}&sesskey=`+M.cfg.sesskey;e+="&view=table",i.currentViewedReportData&&Array.isArray(i.currentViewedReportData)&&(s=0<i.currentViewedReportData.length?Object.keys(i.currentViewedReportData[0]):[],r={results:i.currentViewedReportData,headers:s},e+="&report_data="+encodeURIComponent(JSON.stringify(r)));const l=await fetch(M.cfg.wwwroot+"/report/adeptus_insights/ajax/export_report.php",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:e}),d=l.headers.get("content-type");var o,p=l.headers.get("content-disposition");if(d&&d.includes("application/json")&&!p)throw o=await l.json(),new Error(o.message||"Export failed");if(!l.ok)throw new Error("Export failed with status: "+l.status);const m=i.currentViewedReport?.description||i.currentViewedReport?.name||"report";var h=m.replace(/[^a-zA-Z0-9\s-]/g,"").replace(/\s+/g,"_").toLowerCase(),u=(new Date).toISOString().split("T")[0],g=await l.blob(),n=window.URL.createObjectURL(g);const c=document.createElement("a");c.href=n,c.download=h+`_${u}.`+a,document.body.appendChild(c),c.click(),window.URL.revokeObjectURL(n),document.body.removeChild(c),S.close(),i.showSuccess(a.toUpperCase()+" file downloaded successfully!"),await i.trackExport(a,t)}catch(e){S.close(),i.showError(e.message||"Failed to export report.")}},trackExport:async function(e,t){try{const a=await fetch(M.cfg.wwwroot+"/report/adeptus_insights/ajax/track_export.php",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:`format=${encodeURIComponent(e)}&report_name=${encodeURIComponent(t)}&sesskey=`+M.cfg.sesskey});await a.json()}catch(e){console.error("Error tracking export:",e)}},openReportFromLink:function(t){this.switchToReportsTab(),this.updateReportsHistory(this.cachedReports),_(".report-row").removeClass("table-primary");const e=_(`.report-row[data-report-slug="${t}"]`);e.addClass("table-primary");var a=this.cachedReports.find(e=>e.slug===t);a&&a.data&&Array.isArray(a.data)&&0<a.data.length?this.updateReportsView(a,a.data):this.fetchAndDisplayReport(t,e)},formatTimestamp:function(e){const t=e instanceof Date?e:new Date(e),a=new Date;e=e=>e.toString().padStart(2,"0"),e=e(t.getHours())+":"+e(t.getMinutes());if(t.getFullYear()!==a.getFullYear()){const r=t.toLocaleString("default",{month:"long"});return`${t.getDate()} ${r} ${t.getFullYear()} - `+e}if(t.toDateString()===a.toDateString())return e;const s=new Date(a.getFullYear(),a.getMonth(),a.getDate()-1);if(t.toDateString()===s.toDateString())return t.toLocaleString("default",{weekday:"long"})+" - "+e;const r=t.toLocaleString("default",{month:"long"});return`${t.getDate()} ${r} - `+e},updateChatHistoryBadge:function(t){const a=_(`#chat-history-list li.chat-history-item[data-chat-id="${t}"]`);if(a.length){let e=a.find(".report-count");e.length?(t=parseInt(e.text(),10)||0,e.text(t+1)):(t=_('<span class="badge bg-primary d-flex align-items-center report-count" style="color: white;"><i class="fa fa-chart-bar me-1"></i>1</span>'),a.append(t))}},saveDisplayType:function(t,a){S.fire({title:"Saving default view...",allowOutsideClick:!1,didOpen:()=>S.showLoading()}),this.ajaxWithAuth({url:this.backendUrl+`/ai-reports/${t}/display-type`,method:"POST",contentType:"application/json",data:JSON.stringify({display_type:a}),success:()=>{S.fire({icon:"success",title:"Default view saved",showConfirmButton:!1,timer:1500});const e=this.cachedReports.find(e=>e.slug===t);e&&(e.display_type=a),_(".save-display-type-btn").remove()},error:()=>{S.fire({icon:"error",title:"Save failed",text:"Could not save default view. Please try again."})}})},showResendIconOnMessage:function(e,t){if(e&&e.length){e.siblings(".failed-reload-icon").remove();const a=_(`
                    <i class="fa fa-refresh failed-reload-icon text-danger"
                   title="Retry sending this message"
                       style="cursor:pointer; float:left; margin-right:0.5rem;"></i>
                `);e.after(a),a.on("click",()=>{a.remove(),this.resendMessage(e,t)})}},showResendIconOnLastUserMessage:function(){const e=_("#chat-container .user-message:last");var t;e.length&&(t=e.find(".message-text").text(),this.showResendIconOnMessage(e,t))},showCompareDataModal:function(e){const h=this,i=e.slug;let s=[],o=null,u=null,x=null,g=!1,m=!1,n=null,f="table",b="table",a,y=null,v=null,p=!1,l="a";function d(t,a,s){"a"===a&&(g=!0),"b"===a&&(m=!0),r(),h.ajaxWithAuth({url:`${this.backendUrl}/ai-reports/${i}/snapshots/`+t,method:"GET",success:function(e){"a"===a?(y=e.data,u=t,g=!1):(v=e.data,x=t,m=!1),r(),s&&s()},error:function(){n="Failed to fetch snapshot data.","a"===a&&(g=!1),"b"===a&&(m=!1),r(),s&&s()}})}function w(t){if(!t)return{bg:"#f8f9fa",border:"#dee2e6",text:"#6c757d"};var e=s.findIndex(e=>e.id===t);if(-1===e)return{bg:"#f8f9fa",border:"#dee2e6",text:"#6c757d"};var a=[{bg:"#e3f2fd",border:"#2196f3",text:"#1976d2"},{bg:"#f3e5f5",border:"#9c27b0",text:"#7b1fa2"},{bg:"#e8f5e8",border:"#4caf50",text:"#388e3c"},{bg:"#fff3e0",border:"#ff9800",text:"#f57c00"},{bg:"#fce4ec",border:"#e91e63",text:"#c2185b"},{bg:"#e0f2f1",border:"#009688",text:"#00695c"},{bg:"#f1f8e9",border:"#8bc34a",text:"#689f38"},{bg:"#fff8e1",border:"#ffc107",text:"#ffa000"}];return a[e%a.length]}function C(t){if(!t)return"";if("string"==typeof t&&"current"===t)return"Current Data";var e=s.find(e=>e.id===t);return e&&e.note?e.note:""}function r(){if(_("#compare-section-a").replaceWith(function(){let e="";var t=w(u),a=C(u);return e+=`<div class="w-100 droppable-snapshot compare-section" id="compare-section-a" data-drop-target="a" style="border: 2px solid ${t.border}; border-radius: 8px; padding: 12px; background-color: ${t.bg}; height: 100%; min-height: 300px; position:relative;">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="fw-bold" style="color: ${t.text};">Snapshot A${a?": "+a:""}</span>
                        <div class="btn-group display-type-switcher-a" role="group" aria-label="Display type switcher">
                            <button class="btn btn-icon btn-sm${"table"===f?" active":""}" data-type="table" data-side="a" tabindex="0" aria-label="Table view" title="Table view"><i class="fa fa-table"></i></button>
                            <button class="btn btn-icon btn-sm${"chart"===f?" active":""}" data-type="chart" data-side="a" tabindex="0" aria-label="Chart view" title="Chart view"><i class="fa fa-bar-chart"></i></button>
                            <button class="btn btn-icon btn-sm${"graph"===f?" active":""}" data-type="graph" data-side="a" tabindex="0" aria-label="Graph view" title="Graph view"><i class="fa fa-line-chart"></i></button>
                            </div>
                        </div>`,g?e+='<div class="w-100 d-flex justify-content-center align-items-center" style="min-height:200px"><div class="spinner-border text-primary" role="status"></div></div>':y?(e+=`<div class="comparison-fade${f?" comparison-fade-in":""}" style="animation:fadeIn .3s; overflow-x: auto; max-height: calc(100% - 50px);">`,"table"===f?e+=h.renderDiffTable(y,v):"chart"===f?e+='<div class="chart-container" style="min-height:260px;" tabindex="0" aria-label="Bar chart" role="region"><canvas id="compareChartA"></canvas></div>':"graph"===f&&(e+='<div class="chart-container" style="min-height:260px;" tabindex="0" aria-label="Line graph" role="region"><canvas id="compareGraphA"></canvas></div>'),e+="</div>"):e+='<div class="text-muted small text-center" style="min-height:200px;">No snapshot selected for A</div>',e+="</div>"}()),_("#compare-section-b").replaceWith(function(){let e="";var t=w(x),a=C(x);return e+=`<div class="w-100 droppable-snapshot compare-section" id="compare-section-b" data-drop-target="b" style="border: 2px solid ${t.border}; border-radius: 8px; padding: 12px; background-color: ${t.bg}; height: 100%; min-height: 300px; position:relative;">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="fw-bold" style="color: ${t.text};">Snapshot B${a?": "+a:""}</span>
                        <div class="btn-group display-type-switcher-b" role="group" aria-label="Display type switcher B">
                            <button class="btn btn-icon btn-sm${"table"===b?" active":""}" data-type="table" data-side="b" tabindex="0" aria-label="Table view for B" title="Table view"><i class="fa fa-table"></i></button>
                            <button class="btn btn-icon btn-sm${"chart"===b?" active":""}" data-type="chart" data-side="b" tabindex="0" aria-label="Chart view for B" title="Chart view"><i class="fa fa-bar-chart"></i></button>
                            <button class="btn btn-icon btn-sm${"graph"===b?" active":""}" data-type="graph" data-side="b" tabindex="0" aria-label="Graph view for B" title="Graph view"><i class="fa fa-line-chart"></i></button>
                        </div>
                    </div>`,m?e+='<div class="w-100 d-flex justify-content-center align-items-center" style="min-height:200px"><div class="spinner-border text-primary" role="status"></div></div>':v?(e+=`<div class="comparison-fade${b?" comparison-fade-in":""}" style="animation:fadeIn .3s; overflow-x: auto; max-height: calc(100% - 50px);">`,"table"===b?e+=h.renderDiffTable(v,y):"chart"===b?e+='<div class="chart-container" style="min-height:260px;" tabindex="0" aria-label="Bar chart for B" role="region"><canvas id="compareChartB"></canvas></div>':"graph"===b&&(e+='<div class="chart-container" style="min-height:260px;" tabindex="0" aria-label="Line graph for B" role="region"><canvas id="compareGraphB"></canvas></div>'),e+="</div>"):e+='<div class="text-muted small text-center" style="min-height:200px;">No snapshot selected for B</div>',e+="</div>"}()),"chart"===f&&Array.isArray(y)&&0<y.length){const r=document.getElementById("compareChartA");if(r){const i=Object.keys(y[0]);let t=i.find(e=>"string"==typeof y[0][e])||i[0],a=i.find(e=>"number"==typeof y[0][e])||i[1];var e=y.map(e=>e[t]),s=y.map(e=>e[a]);window.compareChartAInstance&&window.compareChartAInstance.destroy(),window.compareChartAInstance=new k(r.getContext("2d"),{type:"bar",data:{labels:e,datasets:[{label:a,data:s,backgroundColor:"rgba(0,123,255,0.5)",borderColor:"rgba(0,123,255,1)",borderWidth:1}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1}}}})}}if("graph"===f&&Array.isArray(y)&&0<y.length){const o=document.getElementById("compareGraphA");if(o){const n=Object.keys(y[0]);let a=n.find(e=>"string"==typeof y[0][e])||n[0],t=n.find(e=>"number"==typeof y[0][e])||n[1];e=y.map((e,t)=>e[a]||t+1),s=y.map(e=>e[t]);window.compareGraphAInstance&&window.compareGraphAInstance.destroy(),window.compareGraphAInstance=new k(o.getContext("2d"),{type:"line",data:{labels:e,datasets:[{label:t,data:s,backgroundColor:"rgba(40,167,69,0.5)",borderColor:"rgba(40,167,69,1)",borderWidth:2,fill:!1}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1}}}})}}if("chart"===b&&Array.isArray(v)&&0<v.length){const l=document.getElementById("compareChartB");if(l){const d=Object.keys(v[0]);let t=d.find(e=>"string"==typeof v[0][e])||d[0],a=d.find(e=>"number"==typeof v[0][e])||d[1];e=v.map(e=>e[t]),s=v.map(e=>e[a]);window.compareChartBInstance&&window.compareChartBInstance.destroy(),window.compareChartBInstance=new k(l.getContext("2d"),{type:"bar",data:{labels:e,datasets:[{label:a,data:s,backgroundColor:"rgba(0,123,255,0.5)",borderColor:"rgba(0,123,255,1)",borderWidth:1}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1}}}})}}if("graph"===b&&Array.isArray(v)&&0<v.length){const c=document.getElementById("compareGraphB");if(c){const p=Object.keys(v[0]);let a=p.find(e=>"string"==typeof v[0][e])||p[0],t=p.find(e=>"number"==typeof v[0][e])||p[1];e=v.map((e,t)=>e[a]||t+1),s=v.map(e=>e[t]);window.compareGraphBInstance&&window.compareGraphBInstance.destroy(),window.compareGraphBInstance=new k(c.getContext("2d"),{type:"line",data:{labels:e,datasets:[{label:t,data:s,backgroundColor:"rgba(40,167,69,0.5)",borderColor:"rgba(40,167,69,1)",borderWidth:2,fill:!1}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1}}}})}}}function t(){S.update({html:`<div class='d-flex flex-row' style='height:70vh;min-height:500px;max-height:80vh;'>
                        <div id='timeline-sidebar-modal'></div>
                        <div class='flex-fill px-3' style='overflow:auto;max-width:calc(100% - 220px);'>
                            <div class='d-flex flex-row gap-3 w-100 h-100'>
                                <div class='flex-fill' id='compare-section-a'></div>
                                <div class='flex-fill' id='compare-section-b'></div>
                            </div>
                        </div>
                    </div>`}),_("#timeline-sidebar-modal").html(function(l,d){let c='<div class="timeline-sidebar" style="width:220px;max-width:220px;overflow-y:auto;height:100%;background:#f8f9fa;border-right:1.5px solid #e0e0e0;padding:0.5rem 0.25rem;">';return c=c+'<div class="d-flex flex-column gap-2 mb-3">'+'<button class="btn btn-outline-primary btn-sm w-100 mb-1 fetch-current-btn" title="Fetch current data from database" aria-label="Fetch current data"><i class="fa fa-sync"></i> Fetch Current Data</button>',p&&"current"===u&&(c+=`<div class="mb-2">
                        <input type="text" id="add-timeline-note" class="form-control form-control-sm mb-1" placeholder="Enter snapshot name (required)" required aria-label="Snapshot name">
                        <div class="invalid-feedback" style="display:none;">Snapshot name is required.</div>
                        <button class="btn btn-outline-success btn-sm w-100 add-timeline-btn" id="add-timeline-btn" title="Create snapshot from current data" aria-label="Create snapshot from current data" disabled><span class="btn-label"><i class="fa fa-plus"></i> Create Snapshot From Current Data</span><span class="spinner-border spinner-border-sm ms-2" id="snapshot-loading" style="display:none;" role="status" aria-hidden="true"></span></button>
                    </div>`),c=(c+='<div class="small text-muted text-center px-2 py-1 mb-2" style="border: 1px dashed #dee2e6; border-radius: 4px;">Click or <b>drag</b> snapshots to select for comparison. Each snapshot gets a unique color. You can also drag and drop from the side menu into the snapshot viewer.</div>')+"</div>"+'<div class="timeline-list">',0===s.length?n?c+=`<div class="text-danger small text-center py-2">Error: ${n}</div>`:c+='<div class="text-muted small text-center py-2">No timeline snapshots yet. [DEBUG: Timeline is empty]</div>':s.forEach((e,t)=>{var a=[{bg:"#e3f2fd",border:"#2196f3",text:"#1976d2"},{bg:"#f3e5f5",border:"#9c27b0",text:"#7b1fa2"},{bg:"#e8f5e8",border:"#4caf50",text:"#388e3c"},{bg:"#fff3e0",border:"#ff9800",text:"#f57c00"},{bg:"#fce4ec",border:"#e91e63",text:"#c2185b"},{bg:"#e0f2f1",border:"#009688",text:"#00695c"},{bg:"#f1f8e9",border:"#8bc34a",text:"#689f38"},{bg:"#fff8e1",border:"#ffc107",text:"#ffa000"}],t=a[t%a.length],a=l===e.id||d===e.id,s=a?`background-color: ${t.bg}; border-color: ${t.border}; border-width: 2px;`:"background-color: #fff; border-color: #dee2e6; border-width: 1px;",r=e.is_current_version?'<span class="badge bg-primary ms-1">Current</span>':"",i=a?'draggable="false"':'draggable="true"',o=a?"drag-disabled":"draggable-snapshot",n=a?"This snapshot is currently selected":"Drag to assign to Snapshot A or B",a=a?'<span class="text-muted small">(Selected)</span>':"";c+=`<div class="timeline-item p-2 mb-1 rounded border ${o}" 
                                      style="cursor:pointer; animation:fadeIn .3s; ${s}" 
                                      data-snap-id="${e.id}" 
                                      data-color-bg="${t.bg}" 
                                      data-color-border="${t.border}" 
                                      data-color-text="${t.text}"
                                      tabindex="0" 
                                      aria-label="Snapshot from ${h.formatTimestamp(e.created_at)}${e.is_current_version?" (current)":""}"
                                      ${i}
                                      title="${n}"
                                      >
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="fw-bold small">${h.formatTimestamp(e.created_at)}</span>
                                ${r}
                            </div>
                            <div class="small text-muted">${e.note||""} ${a}</div>
                            <div class="d-flex gap-1 mt-1">
                                <button class="btn btn-outline-secondary btn-xs btn-sm set-current-btn" data-snap-id="${e.id}" title="Set as current version" aria-label="Set as current"><i class="fa fa-check"></i></button>
                            </div>
                        </div>`}),c+="</div></div>"}(u,x)),r(),_(".fetch-current-btn").off("click").on("click",function(){!function(t,a){"a"===t&&(g=!0),"b"===t&&(m=!0),r(),h.ajaxWithAuth({url:`${this.backendUrl}/ai-reports/${i}/data/current`,method:"GET",success:function(e){o=e.data||[],"a"===t?(y=o,u="current",g=!1):(v=o,x="current",m=!1),p=!0,r(),a&&a()},error:function(){n="Failed to fetch current data.","a"===t&&(g=!1),"b"===t&&(m=!1),r(),a&&a()}})}(l)}),_(".timeline-item").off("click").on("click",function(e){var t=_(this).data("snap-id");"a"===l?d(t,"a",()=>{l="b"}):d(t,"b",()=>{l="a"})}),_(".display-type-switcher-a .btn-icon").off("click").on("click",function(){f=_(this).data("type"),r()}),_(".display-type-switcher-b .btn-icon").off("click").on("click",function(){b=_(this).data("type"),r()}),_(".draggable-snapshot").attr("draggable",!0).off("dragstart").on("dragstart",function(e){e.originalEvent.dataTransfer.setData("text/plain",_(this).data("snap-id")),_(this).addClass("dragging")}),_(".draggable-snapshot").off("dragend").on("dragend",function(e){_(this).removeClass("dragging")}),_(".compare-section").off("dragover").on("dragover",function(e){e.preventDefault(),_(this).addClass("drag-over-section")}),_(".compare-section").off("dragleave").on("dragleave",function(e){_(this).removeClass("drag-over-section")}),_(".compare-section").off("drop").on("drop",function(e){e.preventDefault(),_(this).removeClass("drag-over-section");e=e.originalEvent.dataTransfer.getData("text/plain");const t=_(this).data("drop-target");d(e,t,()=>{l="a"===t?"b":"a"})}),0===_("#compare-section-highlight-style").length&&_("head").append('<style id="compare-section-highlight-style">.drag-over-section { box-shadow: 0 0 0 4px #90caf9 !important; border-color: #1976d2 !important; }</style>')}S.fire({title:"<span class='fw-bold'>Compare Report Data</span>",html:`<div class='d-flex flex-row' style='height:60vh;min-height:400px;max-height:70vh;'>
                    <div id='timeline-sidebar-modal'></div>
                    <div class='flex-fill px-3' style='overflow:auto;max-width:calc(100% - 220px);'>
                        <div class='d-flex flex-row gap-3 w-100 h-100'>
                            <div class='flex-fill' id='compare-section-a'></div>
                            <div class='flex-fill' id='compare-section-b'></div>
                        </div>
                    </div>
                </div>`,width:"90vw",heightAuto:!1,showCancelButton:!0,showConfirmButton:!1,customClass:{popup:"swal2-modal-compare-data"},didOpen:()=>{!function(t){h.ajaxWithAuth({url:`${this.backendUrl}/ai-reports/${i}/snapshots`,method:"GET",success:function(e){s=e.snapshots||[],a=(s.find(e=>e.is_current_version)||{}).id||null,t&&t()},error:function(){n="Failed to load timeline.",t&&t()}})}(()=>{0<s.length?(u=s.find(e=>e.is_current_version)?.id||s[0].id,x=1<s.length?s[1].id:null,u&&x?function(e,t,a){g=!0,m=!0,r(),h.ajaxWithAuth({url:`${this.backendUrl}/ai-reports/${i}/snapshots/${e}/compare/`+t,method:"GET",success:function(e){y=e.a.data,v=e.b.data,g=!1,m=!1,r(),a&&a(e)},error:function(){n="Failed to compare snapshots.",g=!1,m=!1,r(),a&&a()}})}(u,x,()=>{l="a",t()}):u?d(u,"a",()=>{l="b",t()}):t()):t()})}})},renderDiffTable:function(e,r){if(!Array.isArray(e)||0===e.length)return'<div class="text-muted small">No data</div>';const t=Object.keys(e[0]);let i='<div class="table-responsive"><table class="table table-striped table-hover table-sm">';return i+="<thead><tr>",t.forEach(e=>{i+=`<th>${e}</th>`}),i+="</tr></thead><tbody>",e.forEach((a,s)=>{i+="<tr>",t.forEach(e=>{let t=!1;r&&Array.isArray(r)&&r[s]&&r[s][e]!==a[e]&&(t=!0),i+=`<td${t?' style="background:#ffe5e5;"':""}>${null!=a[e]?a[e]:""}</td>`}),i+="</tr>"}),i+="</tbody></table></div>"},testMCQ:function(){this.addMessage(`I found an existing wizard report that might meet your needs. However, it doesn't include all the fields you requested.

What would you like to do?

A. Use the existing wizard report as-is
B. Generate a new custom SQL report with all fields
C. Use the wizard report and create a separate supplementary report
D. Cancel and try a different approach`,"ai")},testMCQNumbered:function(){this.addMessage(`Please select your preferred report format:

1. PDF Export with charts and graphs
2. Excel spreadsheet with raw data
3. CSV file for data analysis
4. Interactive web dashboard
5. Email summary report`,"ai")}};return window.assistant=s});