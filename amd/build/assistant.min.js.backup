define("report_adeptus_insights/assistant",["jquery","core/ajax","core/notification","core/chartjs","core/templates","report_adeptus_insights/auth_utils"],(function($,Ajax,Notification,Chart,Templates,AuthUtils){var Swal=window.Swal,assistant={currentChatId:0,mcqQueue:[],reportsDataTable:null,cachedReports:[],_initCalled:!1,isCreditLimitExceeded:!1,init:function(authenticated){if(!this._initCalled){this._initCalled=!0,console.log("[AI Assistant] init called, authenticated:",authenticated),this.currentChatId=0,console.log("[AI Assistant] currentChatId set to",this.currentChatId),$(".container-fluid").hide(),console.log("[AI Assistant] .container-fluid hidden");try{var _AuthUtils$getAuthSta,_AuthUtils$getAuthSta2;if(AuthUtils.isAuthenticated())console.log("[AI Assistant] User authenticated, proceeding with initialization"),this.setUserName((null===(_AuthUtils$getAuthSta=AuthUtils.getAuthStatus())||void 0===_AuthUtils$getAuthSta||null===(_AuthUtils$getAuthSta2=_AuthUtils$getAuthSta.user)||void 0===_AuthUtils$getAuthSta2?void 0:_AuthUtils$getAuthSta2.name)||"User"),this.updateSubscriptionInfo(),this.setupEventListeners(),this.loadChatHistory(),this.loadReportsHistory(),$(".container-fluid").fadeIn(200);else console.log("[AI Assistant] User not authenticated, checking auth status"),AuthUtils.refreshAuthStatus(),setTimeout((()=>{var _AuthUtils$getAuthSta3,_AuthUtils$getAuthSta4;AuthUtils.isAuthenticated()?(this.setUserName((null===(_AuthUtils$getAuthSta3=AuthUtils.getAuthStatus())||void 0===_AuthUtils$getAuthSta3||null===(_AuthUtils$getAuthSta4=_AuthUtils$getAuthSta3.user)||void 0===_AuthUtils$getAuthSta4?void 0:_AuthUtils$getAuthSta4.name)||"User"),this.updateSubscriptionInfo(),this.setupEventListeners(),this.loadChatHistory(),this.loadReportsHistory(),$(".container-fluid").fadeIn(200)):this.showAuthenticationError()}),500)}catch(error){console.error("[AI Assistant] Failed to initialize authentication:",error),this.setupEventListeners(),$(".container-fluid").fadeIn(200)}}},showAuthenticationError:function(){console.log("[AI Assistant] Showing authentication error"),$(".container-fluid").html('\n                <div class="alert alert-danger">\n                    <h4>Authentication Required</h4>\n                    <p>You need to be authenticated to use the AI Assistant. Please contact your administrator for assistance.</p>\n                    <button class="btn btn-primary" onclick="location.reload()">Refresh Page</button>\n                </div>\n            ')},setupEventListeners:function(){$("#send-button").on("click",(()=>this.sendMessage())),$("#message-input").on("keydown",(e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),this.sendMessage())})),$("#chart-type").on("change",(()=>this.updateChart())),$("#message-input").on("input",(function(){this.style.height="auto",this.style.height=this.scrollHeight+"px"})),$("#create-new-chat").on("click",(()=>this.createNewChat()))},isSending:!1,renderMCQ:function(mcq){this.currentMCQ=mcq;var c=$("#mcq-container").empty();c.append("<p><strong>".concat(mcq.question,"</strong></p>")),mcq.options.forEach((opt=>{c.append('\n                  <div class="form-check">\n                    <input class="form-check-input" type="radio"\n                           name="mcq-option" id="mcq-'.concat(opt.key,'"\n                           value="').concat(opt.key,'">\n                    <label class="form-check-label" for="mcq-').concat(opt.key,'">\n                      ').concat(opt.key,". ").concat(opt.label,"\n                    </label>\n                  </div>"))})),c.append('<button id="mcq-cancel" class="btn btn-link">Cancel</button>')},clearMCQ:function(){this.currentMCQ=null,$("#mcq-container").empty().hide(),$("#message-input").prop("disabled",!1),$("#send-button").prop("disabled",!1)},extractMCQFromText:function(text){if(!text||"string"!=typeof text)return null;try{const jsonArrayMatch=text.match(/```json\s*(\[[\s\S]*?\])\s*```/);if(jsonArrayMatch){const questions=JSON.parse(jsonArrayMatch[1]);if(Array.isArray(questions)&&questions.length>0&&"mcq"===questions[0].type)return{questions:questions,selectedAnswer:null}}const jsonMatches=text.match(/\{[\s\S]*?\}/g)||[],questions=[];if(jsonMatches.forEach((jsonStr=>{try{const obj=JSON.parse(jsonStr);"mcq"===obj.type&&Array.isArray(obj.options)&&questions.push(obj)}catch(e){}})),questions.length>0)return{questions:questions,selectedAnswer:null}}catch(e){console.log("Error extracting MCQ from text:",e)}return null},renderMCQHistory:function(questions){let selectedAnswer=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,html='<div class="mcq-history-container" style="display:flex; flex-direction:column; gap:15px;">';return questions.forEach(((mcq,idx)=>{html+='\n                    <div class="mcq-history-item" style="background:#f8f9fa; padding:15px; border-radius:8px; border:1px solid #dee2e6; box-shadow:0 1px 3px rgba(0,0,0,0.05);">\n                        <p style="font-weight:600; margin-bottom:12px; color:#333; font-size:14px;">\n                            <i class="fa fa-question-circle" style="color:#007bff; margin-right:8px;"></i>'.concat(mcq.question,'\n                        </p>\n                        <div class="mcq-options" style="margin-left:24px;">\n                '),mcq.options.forEach(((option,optIdx)=>{const optionText="string"==typeof option?option:option.label||option,isSelected=selectedAnswer&&(selectedAnswer===option||selectedAnswer===optionText||selectedAnswer.includes(optionText)),selectedIcon=isSelected?'<i class="fa fa-check-circle" style="color:#28a745; margin-right:5px;"></i>':"";html+='\n                        <div class="form-check" style="padding:10px 14px; border-radius:6px; margin-bottom:8px; '.concat(isSelected?"background:#e3f0ff; border:2px solid #007bff; font-weight:600;":"border:1px solid #ced4da;",' transition:all 0.2s;">\n                            <input class="form-check-input" type="radio" name="mcq-').concat(idx,'" disabled ').concat(isSelected?"checked":"",' style="margin-top:0.3em;">\n                            <label class="form-check-label" style="color:#555; cursor:not-allowed; margin-left:5px;">\n                                ').concat(selectedIcon).concat(optionText,"\n                            </label>\n                        </div>\n                    ")})),html+='\n                        </div>\n                        <p style="margin-top:12px; margin-bottom:0; font-size:11px; color:#6c757d; font-style:italic;">\n                            <i class="fa fa-info-circle" style="margin-right:4px;"></i>Previous question from chat history\n                        </p>\n                    </div>\n                '})),html+="</div>",html},checkAuth:function(){return AuthUtils.isAuthenticated()?(this.loadChatHistory(),!0):(console.log("[AI Assistant] User not authenticated"),this.showAuthenticationError(),!1)},handleResponse:function(response){if(response.error){if("credit_limit"===response.error_type)return void this.handleCreditLimitError(response.message);this.addMessage(response.message,"error"),this.showResendIconOnLastUserMessage()}else{if("mcq"===response.type){if(response.questions&&response.questions.length>0){const firstQuestion=response.questions[0],mcqText="Question: ".concat(firstQuestion.question,"\nOptions: ").concat(firstQuestion.options.join(", "));this.addMessage(mcqText,"ai",!1,null,null,null,response.credit_info)}return void this.enqueueMCQs(response.questions)}if("sql"===response.type)return this.addMessage(response.report.description,"ai",!0,response.report,null,null,response.credit_info),this.updateChatHistoryBadge(this.currentChatId),this.cachedReports.unshift(response.report),this.updateReportsHistory(this.cachedReports),this.reportsDataTable&&(this.reportsDataTable.destroy(),this.reportsDataTable=null),setTimeout((()=>{try{const tableElement=document.getElementById("reports-history-table");if(tableElement){const thead=tableElement.querySelector("thead"),tbody=tableElement.querySelector("tbody");if(thead&&tbody&&thead.rows.length>0&&thead.rows[0].cells.length>0){const headerCells=thead.rows[0].cells.length,dataRows=tbody.rows;let dataCells=0;dataRows.length>0&&(dataCells=dataRows[0].cells.length),headerCells===dataCells&&headerCells>0&&dataRows.length>0&&!dataRows[0].cells[0].textContent.includes("No reports")&&(this.reportsDataTable=new simpleDatatables.DataTable("#reports-history-table",{searchable:!0,fixedHeight:!1,perPage:10}))}}}catch(error){console.error("Error reinitializing DataTable:",error)}}),100),void Swal.fire({title:"Generating Report",html:'\n                        <div class="text-center">\n                            <div class="spinner-border text-primary mb-3" role="status">\n                            </div>\n                            <p>Please wait while we generate your report...</p>\n                        </div>\n                    ',showConfirmButton:!1,allowOutsideClick:!1,allowEscapeKey:!1,timer:2e3,timerProgressBar:!0}).then((()=>{this.switchToReportsTab(),this.displayCurrentReport(response.report),this.executeReport(response.report.slug)}));this.addMessage(response.message,"ai",!1,null,null,null,response.credit_info)}response.data&&this.updateReportData(response.data),response.visualizations&&this.updateVisualizations(response.visualizations),response.credit_info&&this.showCreditUsageFeedback(response.credit_info),this.scrollToBottom()},showCreditUsageFeedback:function(creditInfo){if(!creditInfo)return;const notification=$('\n                <div class="credit-usage-notification" style="\n                    position: fixed;\n                    top: 20px;\n                    right: 20px;\n                    background: #28a745;\n                    color: white;\n                    padding: 12px 20px;\n                    border-radius: 6px;\n                    box-shadow: 0 4px 12px rgba(0,0,0,0.15);\n                    z-index: 9999;\n                    font-size: 14px;\n                    font-weight: 500;\n                    opacity: 0;\n                    transform: translateX(100%);\n                    transition: all 0.3s ease;\n                ">\n                    <i class="fa fa-coins me-2"></i>\n                    <span class="credit-text">Credits used: '.concat(creditInfo.credits_charged||0," (").concat(creditInfo.credit_type||"basic",")</span>\n                </div>\n            "));$("body").append(notification),setTimeout((()=>{notification.css({opacity:"1",transform:"translateX(0)"})}),100),setTimeout((()=>{notification.css({opacity:"0",transform:"translateX(100%)"}),setTimeout((()=>{notification.remove()}),300)}),3e3),this.updateSubscriptionInfoWithCreditUsage(creditInfo)},updateSubscriptionInfoWithCreditUsage:function(creditInfo){const authStatus=AuthUtils.getAuthStatus();if(!authStatus||!authStatus.subscription)return;const subscription=authStatus.subscription,creditsUsed=creditInfo.credits_charged||0;"premium"===creditInfo.credit_type?subscription.premium_credits_used_this_month=(subscription.premium_credits_used_this_month||0)+creditsUsed:subscription.basic_credits_used_this_month=(subscription.basic_credits_used_this_month||0)+creditsUsed,subscription.ai_credits_used_this_month=(subscription.ai_credits_used_this_month||0)+creditsUsed,this.animateCreditCounterUpdate(creditInfo.credit_type,creditsUsed),this.updateSubscriptionInfo()},animateCreditCounterUpdate:function(creditType,creditsUsed){const $counter=$("premium"===creditType?".premium-credits-counter":".basic-credits-counter");$counter.length&&($counter.addClass("credit-update-highlight"),setTimeout((()=>{$counter.removeClass("credit-update-highlight")}),1e3));const $totalCounter=$(".total-credits-counter");$totalCounter.length&&($totalCounter.addClass("credit-update-highlight"),setTimeout((()=>{$totalCounter.removeClass("credit-update-highlight")}),1e3))},addMessage:function(text,type){let isReportLink=arguments.length>2&&void 0!==arguments[2]&&arguments[2],reportData=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,messageId=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,timestamp=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null,creditInfo=arguments.length>6&&void 0!==arguments[6]?arguments[6]:null;const template=document.getElementById("message-template"),frag=template.content.cloneNode(!0),messageEl=frag.querySelector(".message");messageEl.classList.add(type+"-message"),messageId&&messageEl.setAttribute("data-message-id",messageId);const mcqData=this.extractMCQFromText(text);if(mcqData&&mcqData.questions.length>0){const mcqHtml=this.renderMCQHistory(mcqData.questions,mcqData.selectedAnswer);frag.querySelector(".message-text").innerHTML=mcqHtml}else if(isReportLink&&reportData){frag.querySelector(".message-text").innerHTML='\n                    <a href="javascript:void(0)" \n                       class="report-link" \n                       data-report-slug="'.concat(reportData.slug,'"\n                       style="color: #007bff; text-decoration: none; cursor:pointer; padding:4px 8px; border:1px solid #dee2e6; border-radius:4px; background:#f8f9fa; display:inline-block; transition:all 0.2s;">\n                        ðŸ“Š ').concat(text,"\n                    </a>\n                ");const self=this;setTimeout((()=>{const link=messageEl.querySelector(".report-link");link.onclick=function(){self.openReportFromLink(link.getAttribute("data-report-slug"))},link.onmouseenter=function(){$(this).css({"background-color":"#e9ecef","border-color":"#adb5bd",transform:"translateY(-1px)"})},link.onmouseleave=function(){$(this).css({"background-color":"#f8f9fa","border-color":"#dee2e6",transform:"translateY(0)"})}}),0)}else frag.querySelector(".message-text").textContent=text;"ai"===type&&creditInfo&&this.addCreditInfoToMessage(frag,creditInfo);const timeEl=frag.querySelector(".message-time");return timeEl.textContent=this.formatTimestamp(timestamp||(new Date).toISOString()),$("#chat-container").append(frag),this.scrollToBottom(),$(messageEl)},addCreditInfoToMessage:function(frag,creditInfo){const messageEl=frag.querySelector(".message"),creditBadge=document.createElement("div");creditBadge.className="credit-info-badge",creditBadge.style.cssText="\n                display: inline-block;\n                margin-left: 8px;\n                padding: 2px 6px;\n                border-radius: 12px;\n                font-size: 11px;\n                font-weight: 500;\n                text-transform: uppercase;\n                letter-spacing: 0.5px;\n            ","premium"===creditInfo.credit_type?(creditBadge.style.backgroundColor="#6f42c1",creditBadge.style.color="white",creditBadge.textContent="Premium"):(creditBadge.style.backgroundColor="#28a745",creditBadge.style.color="white",creditBadge.textContent="Basic"),creditBadge.title="".concat(creditInfo.credit_type.toUpperCase()," Response\nTokens: ").concat(creditInfo.tokens_used,"\nCredits: ").concat(creditInfo.credits_charged,"\nProvider: ").concat(creditInfo.provider);messageEl.querySelector(".message-text").appendChild(creditBadge)},handleCreditLimitError:function(message){let creditData=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;creditData&&creditData.summary&&this.updateSubscriptionDataFromCreditResponse(creditData),this.showPersistentCreditLimitMessage(message),this.addMessage(message,"error"),Swal.fire({icon:"warning",title:"Credit Limit Reached",html:'\n                    <div class="text-center">\n                        <p>'.concat(message,'</p>\n                        <p class="text-muted">Your monthly credit allowance has been used up.</p>\n                        <p class="text-muted">Credits reset on the 1st of each month.</p>\n                    </div>\n                '),showCancelButton:!0,confirmButtonText:"View Usage",cancelButtonText:"Close",confirmButtonColor:"#007bff"}).then((result=>{result.isConfirmed&&this.showCreditUsageModal()}))},updateSubscriptionDataFromCreditResponse:function(creditData){const authStatus=AuthUtils.getAuthStatus();if(!authStatus||!authStatus.subscription)return;const subscription=authStatus.subscription,summary=creditData.summary;summary.basic&&(subscription.basic_credits_used_this_month=summary.basic.used,subscription.plan_basic_credits_limit=summary.basic.available),summary.premium&&(subscription.premium_credits_used_this_month=summary.premium.used,subscription.plan_premium_credits_limit=summary.premium.available),summary.total&&(subscription.ai_credits_used_this_month=summary.total.used,subscription.plan_ai_credits_limit=summary.total.available),AuthUtils.setAuthStatus(authStatus),this.updateSubscriptionInfo()},handleTimeoutError:function(message){this.addMessage(message,"error"),Swal.fire({icon:"info",title:"AI Service Busy",html:'\n                    <div class="text-center">\n                        <p>'.concat(message,'</p>\n                        <p class="text-muted">The AI service is experiencing high demand. Please try again in a moment.</p>                                                                                       \n                    </div>\n                '),showCancelButton:!0,confirmButtonText:"Try Again",cancelButtonText:"Cancel",confirmButtonColor:"#007bff",cancelButtonColor:"#6c757d"}).then((result=>{result.isConfirmed&&$("#message-input").focus()}))},showPersistentCreditLimitMessage:function(message){$(".credit-limit-alert").remove();const alertHtml='\n                <div class="alert alert-danger credit-limit-alert" role="alert" style="margin: 10px 0; border-left: 4px solid #dc3545; background-color: #f8d7da; border-color: #f5c6cb;">\n                    <div class="d-flex align-items-center">\n                        \n                        <div class="flex-grow-1">\n                            <strong class="text-danger">Credit Limit Reached</strong><br>\n                            <small class="text-muted">'.concat(message,'</small>\n                        </div>\n                        <div class="ms-3">\n                            <button type="button" class="btn btn-sm btn-outline-danger me-2" onclick="window.assistant.showCreditUsageModal()">\n                                <i class="fas fa-chart-bar me-1"></i> View Usage\n                            </button>\n                           \n                        </div>\n                    </div>\n                </div>\n            ');var $mainInners=$(".main-inner");$mainInners.length>=2?$mainInners.eq(1).before(alertHtml):1===$mainInners.length?$mainInners.eq(0).before(alertHtml):$("body").prepend(alertHtml)},hidePersistentCreditLimitMessage:function(){$(".credit-limit-alert").fadeOut(300,(function(){$(this).remove()}))},showCreditUsageModal:function(){Swal.fire({title:"Loading Usage Data...",text:"Please wait while we fetch your usage information",allowOutsideClick:!1,showConfirmButton:!1,willOpen:()=>{Swal.showLoading()}}),this.ajaxWithAuth({url:"https://ai-backend.stagingwithswift.com/api/chat/credits/detailed-usage",method:"GET",success:response=>{response.success?this.displayDetailedUsageModal(response.data):Swal.fire("Error","Failed to load usage information","error")},error:()=>{Swal.fire("Error","Failed to load usage information","error")}})},displayDetailedUsageModal:function(data){const summary=data.summary,usage=(data.daily_usage,data.user_breakdown,data.usage),pagination=data.pagination;data.filters;console.log("displayDetailedUsageModal",data);const modalHtml='\n                <div class="detailed-usage-modal" style="font-family: \'Segoe UI\', Tahoma, Geneva, Verdana, sans-serif;">\n                    \x3c!-- Compact Header with improved filters --\x3e\n                    <div class="usage-header mb-3 assistant-header" style=" padding: 16px; border-radius: 10px; color: white; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">\n                        <div class="d-flex justify-content-between align-items-center">\n                            <h5 class="mb-0" style="color: white; font-weight: 600;">\n                            <i class="fas fa-chart-line me-2"></i> Usage Analytics Dashboard\n                            </h5>\n                        </div>\n                        </div>\n                        \n                    \x3c!-- Compact Summary Cards --\x3e\n                    <div class="row mb-3 g-2" style="height: 109px;">\n                        <div class="col-md-3" style="height: 109px;">\n                            <div class="card border-0" style="height: 109px;background:linear-gradient(135deg, #0ea5e9 0%, #2563eb 100%); color: white; border-radius: 12px; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);">\n                                <div class="card-body text-center p-3">\n                                \n                                    <div class="d-flex align-items-center justify-content-center mb-2">\n                                        \n                                        <div>\n                                            <h6 class="card-title mb-0 small" style="font-weight: 600; opacity: 0.9;">Total Credits</h6>\n                                            <div class="row" style="display: inline-flexalign-content: space-between;align-items: center;justify-content: center;">\n                                                <i class="fas fa-coins fa-lg me-2" style="opacity: 0.8;"></i>&nbsp;<h4 class="mb-0" style="font-weight: 700; font-size: 1.8rem;">'.concat(summary.total_credits_used,'</h4>\n                                        </div>\n                                            \n                                    </div>\n                                        \n                                </div>\n                                    <small style="opacity: 0.8; font-size: 0.75rem;">Used This Period</small>\n                            </div>\n                                        </div>\n                                        </div>\n                        <div class="col-md-3" style="height: 109px;">\n                            <div class="card border-0" style="height: 109px;background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; border-radius: 12px; box-shadow: 0 4px 12px rgba(17, 153, 142, 0.2);">\n                                <div class="card-body text-center p-3">\n                                    <div class="d-flex align-items-center justify-content-center mb-2">\n                                        \n                                        <div>\n                                            <h6 class="card-title mb-0 small" style="font-weight: 600; opacity: 0.9;">Total Tokens</h6>\n                                            <div class="row" style="display: inline-flexalign-content: space-between;align-items: center;justify-content: center;">\n                                                <i class="fas fa-code fa-lg me-2" style="opacity: 0.8;"></i>&nbsp;<h4 class="mb-0" style="font-weight: 700; font-size: 1.8rem;">').concat(summary.total_tokens_used.toLocaleString(),'</h4>\n                                        </div>\n                                    </div>\n                                </div>\n                                    <small style="opacity: 0.8; font-size: 0.75rem;">AI Tokens Processed</small>\n                            </div>\n                        </div>\n                        </div>\n                        <div class="col-md-3" style="height: 109px;">\n                            <div class="card border-0" style="height: 109px;background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; border-radius: 12px; box-shadow: 0 4px 12px rgba(240, 147, 251, 0.2);">\n                                <div class="card-body text-center p-3">\n                                    <div class="d-flex align-items-center justify-content-center mb-2">\n                                        \n                                        <div>\n                                             <h6 class="card-title mb-0 small" style="font-weight: 600; opacity: 0.9;">Total Requests</h6>\n                                            <div class="row" style="display: inline-flexalign-content: space-between;align-items: center;justify-content: center;">\n                                                <i class="fas fa-paper-plane fa-lg me-2" style="opacity: 0.8;"></i>&nbsp;<h4 class="mb-0" style="font-weight: 700; font-size: 1.8rem;">').concat(summary.total_requests,'</h4>\n                                        </div>\n                                    </div>\n                                    </div>\n                                    <small style="opacity: 0.8; font-size: 0.75rem;">Messages Processed</small>\n                                </div>\n                            </div>\n                        </div>\n                        <div class="col-md-3" style="height: 109px;">\n                            <div class="card border-0" style="height: 109px;background: linear-gradient(135deg, #ff6b6b 0%, #ffa500 100%); color: white; border-radius: 12px; box-shadow: 0 4px 12px rgba(255, 107, 107, 0.2);">\n                                <div class="card-body text-center p-3">\n                                    <div class="d-flex align-items-center justify-content-center mb-2">\n\n                                        <div>\n                                            <h6 class="card-title mb-0 small" style="font-weight: 600; opacity: 0.9;">Today\'s Credits</h6>\n                                            <div class="row" style="display: inline-flexalign-content: space-between;align-items: center;justify-content: center;">\n                                                <i class="fas fa-calendar-day fa-lg me-2" style="opacity: 0.8;"></i>&nbsp;<h4 class="mb-0" style="font-weight: 700; font-size: 1.8rem;">').concat(summary.today_credits_used||0,'</h4>\n                                        </div>\n                                        </div>\n                                    </div>\n                                    <small style="opacity: 0.8; font-size: 0.75rem;">Credits Used Today</small>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n\n                    \x3c!-- Compact Data Table --\x3e\n                    <div class="card border-0" style="border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.06);">\n                        <div class="card-header" style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-radius: 12px 12px 0 0; border: none; padding: 12px 16px;">\n                            <div class="d-flex justify-content-between align-items-center">\n                                <h6 class="mb-0" style="font-weight: 600; color: linear-gradient(135deg, #0ea5e9 0%, #2563eb 100%);">\n                                    Detailed Usage History\n                                </h6>\n                                <span class="badge bg-primary" style="font-size: 0.7rem; padding: 4px 8px; border-radius: 12px;color: white; background:linear-gradient(135deg, #0ea5e9 0%, #2563eb 100%);">\n                                    ').concat(usage.length," of ").concat(pagination.total,' records\n                                </span>\n                        </div>\n                    </div>\n                        <div class="card-body p-0">\n                            <div class="table-responsive">\n                                <table id="usage-datatable" class="table table-hover mb-0" style="font-size: 0.9rem;">\n                                    <thead style="background:linear-gradient(135deg, #0ea5e9 0%, #2563eb 100%); color: white;">\n                                        <tr>\n                                            <th style="border: none; padding: 15px 12px; font-weight: 600; text-align: center;">Date</th>\n                                            <th style="border: none; padding: 15px 12px; font-weight: 600; text-align: center;">User</th>\n                                            <th style="border: none; padding: 15px 12px; font-weight: 600; text-align: center;">Type</th>\n                                            <th style="border: none; padding: 15px 12px; font-weight: 600; text-align: center;">Credits</th>\n                                            <th style="border: none; padding: 15px 12px; font-weight: 600; text-align: center;">Tokens</th>\n                                            <th style="border: none; padding: 15px 12px; font-weight: 600; text-align: center;">Message Preview</th>\n                                        </tr>\n                                    </thead>\n                                    <tbody>\n                                        ').concat(usage.map((item=>'\n                                            <tr style="border-bottom: 1px solid #f8f9fa;">\n                                                <td style="padding: 12px; vertical-align: middle; font-weight: 500;">\n                                                    '.concat((()=>{const d=new Date(item.created_at),day=d.getDate(),month=d.toLocaleString("en-US",{month:"short"}),year=d.getFullYear(),hours=d.getHours().toString().padStart(2,"0"),minutes=d.getMinutes().toString().padStart(2,"0");return"".concat(day," ").concat(month," ").concat(year," - ").concat(hours,":").concat(minutes)})(),'\n                                                </td>\n                                                <td style="padding: 12px; vertical-align: middle;">\n                                                    <span class="badge bg-light text-dark" style="border-radius: 20px; padding: 4px 8px;">\n                                                        ').concat(item.username||"N/A",'\n                                                    </span>\n                                                </td>\n                                                <td style="padding: 12px; vertical-align: middle;">\n                                                    <span class="badge ').concat("premium"===item.credit_type?"bg-primary":"bg-success",'" style="border-radius: 20px; padding: 6px 12px; font-weight: 500;">\n                                                        <i class="fas ').concat("premium"===item.credit_type?"fa-crown":"fa-layer-group",' me-1"></i>\n                                                        ').concat(item.credit_type,'\n                                                    </span>\n                                                </td>\n                                                <td style="padding: 12px; vertical-align: middle; font-weight: 600; color: #667eea;">').concat(item.credits_charged,'</td>\n                                                <td style="padding: 12px; vertical-align: middle; font-weight: 500;">').concat(item.tokens_used.toLocaleString(),'</td>\n                                                \n                                                <td style="padding: 12px; vertical-align: middle; max-width: 200px;">\n                                                    <div style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="').concat(item.message_preview||"No message",'">\n                                                        ').concat(item.message_preview?item.message_preview.substring(0,80)+"...":"N/A","\n                                                    </div>\n                                                </td>\n                                            </tr>\n                                        "))).join(""),"\n                                    </tbody>\n                                </table>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n            ");Swal.fire({title:"Detailed Usage Report",html:modalHtml,width:"80%",height:"80%",showConfirmButton:!1,showCancelButton:!0,cancelButtonText:"Close",allowOutsideClick:!0,didOpen:()=>{this.setupUsageModalEventListeners(data)}})},setupUsageModalEventListeners:function(data){const self=this;let currentFilters=data.filters;self.usageDataTable=null,setTimeout((()=>{if("undefined"!=typeof simpleDatatables&&simpleDatatables.DataTable)if($("#usage-datatable").length)try{console.log("Initializing Simple DataTable for usage analytics...");const tableElement=document.getElementById("usage-datatable");if(tableElement){const tbody=tableElement.querySelector("tbody");tbody&&tbody.rows.length>0?(self.usageDataTable=new simpleDatatables.DataTable("#usage-datatable",{searchable:!0,fixedHeight:!1,perPage:25,perPageSelect:[10,25,50,100],sortable:!0,labels:{placeholder:"Search usage history...",noRows:"No usage data found",info:"Showing {start} to {end} of {rows} entries"}}),console.log("Simple DataTable initialized successfully:",self.usageDataTable)):console.log("No data in table, skipping DataTable initialization")}}catch(error){console.error("Error initializing Simple DataTable:",error),console.error("Error details:",error.message,error.stack)}else console.error("Usage datatable element not found");else console.error("simpleDatatables library not available")}),500),$("#apply-filters").on("click",(function(){const userId=$("#user-filter").val(),creditType=$("#credit-type-filter").val(),startDate=$("#start-date-filter").val(),endDate=$("#end-date-filter").val();currentFilters={user_id:userId,credit_type:creditType,start_date:startDate,end_date:endDate},self.loadUsageDataWithFilters(currentFilters,1)})),$("#clear-filters").on("click",(function(){$("#user-filter").val(""),$("#credit-type-filter").val(""),$("#start-date-filter").val(""),$("#end-date-filter").val(""),currentFilters={},self.loadUsageDataWithFilters({},1)})),$(".quick-filter").on("click",(function(){const period=$(this).data("period"),today=new Date;let startDate="",endDate=today.toISOString().split("T")[0];switch(period){case"today":startDate=endDate;break;case"week":const weekAgo=new Date(today);weekAgo.setDate(today.getDate()-7),startDate=weekAgo.toISOString().split("T")[0];break;case"month":const monthAgo=new Date(today);monthAgo.setMonth(today.getMonth()-1),startDate=monthAgo.toISOString().split("T")[0]}$("#start-date-filter").val(startDate),$("#end-date-filter").val(endDate),currentFilters={user_id:$("#user-filter").val(),credit_type:$("#credit-type-filter").val(),start_date:startDate,end_date:endDate},self.loadUsageDataWithFilters(currentFilters,1)}))},loadUsageDataWithFilters:function(filters){let page=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;Swal.fire({title:"Loading...",text:"Applying filters and loading data",allowOutsideClick:!1,showConfirmButton:!1,willOpen:()=>{Swal.showLoading()}});const params=new URLSearchParams;filters.user_id&&params.append("user_id",filters.user_id),filters.credit_type&&params.append("credit_type",filters.credit_type),filters.start_date&&params.append("start_date",filters.start_date),filters.end_date&&params.append("end_date",filters.end_date),params.append("page",page),params.append("per_page",1e3),this.ajaxWithAuth({url:"https://ai-backend.stagingwithswift.com/api/chat/credits/detailed-usage?".concat(params.toString()),method:"GET",success:response=>{response.success?(console.log("usage data",response.data),this.updateUsageModalData(response.data)):Swal.fire("Error","Failed to load filtered data","error")},error:()=>{Swal.fire("Error","Failed to load filtered data","error")}})},updateUsageModalData:function(data){const summary=data.summary,usage=data.usage;$(".detailed-usage-modal .card h2").eq(0).text(summary.total_credits_used),$(".detailed-usage-modal .card h2").eq(1).text(summary.total_tokens_used.toLocaleString()),$(".detailed-usage-modal .card h2").eq(2).text(summary.total_requests),$(".detailed-usage-modal .card h2").eq(3).text(summary.unique_users),$(".detailed-usage-modal .card h3").eq(0).text(summary.premium_credits),$(".detailed-usage-modal .card h3").eq(1).text(summary.basic_credits),$(".detailed-usage-modal .badge.bg-primary").text("".concat(usage.length," of ").concat(data.pagination.total," records"));const tableBody=$("#usage-datatable tbody");if(tableBody.empty(),usage.forEach((item=>{const row='\n                    <tr style="border-bottom: 1px solid #f8f9fa;">\n                        <td style="padding: 12px; vertical-align: middle; font-weight: 500;">'.concat(new Date(item.created_at).toLocaleDateString(),'</td>\n                        <td style="padding: 12px; vertical-align: middle;">\n                            <span class="badge bg-light text-dark" style="border-radius: 20px; padding: 4px 8px;">\n                                ').concat(item.user_id||"N/A",'\n                            </span>\n                        </td>\n                        <td style="padding: 12px; vertical-align: middle;">\n                            <span class="badge ').concat("premium"===item.credit_type?"bg-primary":"bg-success",'" style="border-radius: 20px; padding: 6px 12px; font-weight: 500;">\n                                <i class="fas ').concat("premium"===item.credit_type?"fa-crown":"fa-layer-group",' me-1"></i>\n                                ').concat(item.credit_type,'\n                            </span>\n                        </td>\n                        <td style="padding: 12px; vertical-align: middle; font-weight: 600; color: #667eea;">').concat(item.credits_charged,'</td>\n                        <td style="padding: 12px; vertical-align: middle; font-weight: 500;">').concat(item.tokens_used.toLocaleString(),'</td>\n                        <td style="padding: 12px; vertical-align: middle;">\n                            <span class="badge bg-info text-white" style="border-radius: 20px; padding: 4px 8px;">\n                                ').concat(item.llm_provider,'\n                            </span>\n                        </td>\n                        <td style="padding: 12px; vertical-align: middle; max-width: 200px;">\n                            <div style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="').concat(item.message_preview||"No message",'">\n                                ').concat(item.message_preview?item.message_preview.substring(0,50)+"...":"N/A","\n                            </div>\n                        </td>\n                    </tr>\n                ");tableBody.append(row)})),this.usageDataTable&&"function"==typeof this.usageDataTable.refresh)try{this.usageDataTable.refresh(),console.log("Simple DataTable refreshed with new data")}catch(error){console.error("Error refreshing Simple DataTable:",error)}else console.log("Simple DataTable not found, skipping update")},updateReportData:function(data){const table=$("#report-table");table.empty();const thead=$("<thead><tr></tr></thead>");data.columns.forEach((column=>{thead.find("tr").append("<th>".concat(column,"</th>"))})),table.append(thead);const tbody=$("<tbody></tbody>");data.rows.forEach((row=>{const tr=$("<tr></tr>");row.forEach((cell=>{tr.append("<td>".concat(cell,"</td>"))})),tbody.append(tr)})),table.append(tbody)},updateVisualizations:function(visualizations){const container=$("#chart-container");container.empty();const canvas=$("<canvas></canvas>");container.append(canvas);const type=$("#chart-type").val();new Chart(canvas[0],{type:type,data:{labels:visualizations.labels,datasets:visualizations.datasets.map((dataset=>({label:dataset.label,data:dataset.data,backgroundColor:dataset.backgroundColor,borderColor:dataset.borderColor,borderWidth:1})))},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{position:"top"},title:{display:!0,text:visualizations.title}}}})},showLoading:function(){$("#loading-indicator").removeClass("d-none")},hideLoading:function(){$("#loading-indicator").addClass("d-none")},showError:function(message){const errorDiv=$("#error-message");$("#error-text").text(message),errorDiv.removeClass("d-none"),setTimeout((()=>{errorDiv.addClass("d-none")}),5e3)},showSuccess:function(message){if(0===$("#success-message").length){const successHtml='\n                    <div class="alert alert-success alert-dismissible fade show d-none" role="alert" id="success-message" style="position:fixed; top:20px; right:20px; z-index:1050;">\n                        <i class="fa fa-check-circle me-2"></i>\n                        <span id="success-text"></span>\n                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>\n                    </div>\n                ';$("body").append(successHtml)}const successDiv=$("#success-message");$("#success-text").text(message),successDiv.removeClass("d-none"),setTimeout((()=>{successDiv.addClass("d-none")}),3e3)},scrollToBottom:function(){const container=$("#chat-container");container.scrollTop(container[0].scrollHeight)},loadChatHistory:function(){const list=$("#chat-history-list");list.html('\n                <li class="list-group-item d-flex justify-content-center" id="chat-history-loading">\n                    <div class="spinner-border text-secondary" role="status">\n                    </div>\n                </li>\n                '),this.ajaxWithAuth({url:"https://ai-backend.stagingwithswift.com/api/chat/history",method:"GET",success:response=>{if(list.empty(),response.chats.length)response.chats.forEach((chat=>{const date=new Date(chat.created_at).toLocaleString(),snippet=chat.snippet,reportCount=chat.report_count||0,badgeHtml=reportCount>0?'<span class="badge bg-primary d-flex align-items-center report-count"><i class="fa fa-chart-bar me-1"></i>'.concat(reportCount,"</span>"):"",item=$('\n                                <li class="list-group-item d-flex justify-content-between align-items-start chat-history-item" data-chat-id="'.concat(chat.id,'">\n                                    <div>\n                                        <small class="text-muted">').concat(date,"</small><br>\n                                        ").concat(snippet,"\n                                    </div>\n                                    ").concat(badgeHtml,"\n                                </li>\n                            "));list.prepend(item)})),$(".chat-history-item").on("click",(e=>{const li=$(e.currentTarget),chatId=li.data("chat-id");this.loadChatMessages(chatId,li)}));else{const authStatus=AuthUtils.getAuthStatus();authStatus&&authStatus.subscription&&authStatus.subscription.reports_generated_this_month>0?list.append('<li class="list-group-item text-center">No chats yet</li>'):list.append('\n                                <li class="list-group-item text-center">\n                                    <div class="text-muted">\n                                        <i class="fa fa-comments fa-2x mb-2"></i>\n                                        <p class="mb-1">No chat history yet</p>\n                                        <small>Start a conversation to see your chat history here</small>\n                                    </div>\n                                </li>\n                            ')}},error:()=>{list.html('\n                        <li class="list-group-item text-danger d-flex flex-column align-items-center">\n                            <span>Failed to load chats</span>\n                            <button id="reload-chat-history" class="btn btn-outline-primary btn-sm mt-2">Reload</button>\n                        </li>\n                    '),$("#reload-chat-history").on("click",(()=>this.loadChatHistory()))}})},loadChatMessages:function(chatId,listItem){console.log("loadChatMessages",chatId,listItem),this.currentChatId=chatId,$("#chat-history-list li").removeClass("active"),listItem.addClass("active"),$("#chat-container").empty(),this.clearMCQ(),this.showLoading(),this.ajaxWithAuth({url:"https://ai-backend.stagingwithswift.com/api/chat/".concat(chatId,"/messages"),method:"GET",success:response=>{this.hideLoading(),console.log(response),response.credit_data&&response.credit_data.summary&&this.updateSubscriptionDataFromCreditResponse(response.credit_data);const authStatus=AuthUtils.getAuthStatus();if(console.log("[loadChatMessages] Checking credit limit status:",authStatus),authStatus&&authStatus.subscription&&(console.log("[loadChatMessages] Subscription data:",authStatus.subscription),this.checkAndShowCreditLimitWarning(authStatus.subscription)),response.messages.forEach(((msg,idx)=>{if("sql"!==msg.tag){if("ai"===msg.sender_type&&"mcq"===msg.tag){const nextMsg=response.messages[idx+1],selectedAnswer=nextMsg&&"user"===nextMsg.sender_type?nextMsg.body:null,mcqData=this.extractMCQFromText(msg.body);if(mcqData&&mcqData.questions.length>0){mcqData.selectedAnswer=selectedAnswer;const mcqHtml=this.renderMCQHistory(mcqData.questions,selectedAnswer),frag=document.getElementById("message-template").content.cloneNode(!0),messageEl=frag.querySelector(".message");return messageEl.classList.add("ai-message"),messageEl.setAttribute("data-message-id",msg.id),frag.querySelector(".message-text").innerHTML=mcqHtml,frag.querySelector(".message-time").textContent=this.formatTimestamp(msg.timestamp),void $("#chat-container").append(frag)}}if("user"===msg.sender_type&&idx>0){const prevMsg=response.messages[idx-1];if(prevMsg&&"ai"===prevMsg.sender_type&&"mcq"===prevMsg.tag)return}this.addMessage(msg.body,msg.sender_type,!1,null,msg.id,msg.timestamp)}})),this.scrollToBottom(),response.reports&&response.reports.length&&response.reports.forEach((report=>{this.insertReportLinkInChat(report)})),response.messages.length>0){const lastMsg=response.messages[response.messages.length-1];if("mcq"===lastMsg.tag){const jsonMatches=lastMsg.body.match(/\{[\s\S]*?\}/g)||[],questions=[];jsonMatches.forEach((jsonStr=>{try{const obj=JSON.parse(jsonStr);"mcq"===obj.type&&Array.isArray(obj.options)&&questions.push(obj)}catch(e){}})),questions.length&&this.enqueueMCQs(questions)}}},error:()=>{this.hideLoading(),this.showError("Could not load conversation.")}})},insertReportLinkInChat:function(report){const $msg=$('#chat-container .message[data-message-id="'.concat(report.message_after_id,'"]'));if(!$msg.length)return;const linkHtml='\n                <div class="message ai-message">\n                  <div class="message-content">\n                    <div class="message-text">\n                      <a href="javascript:void(0)" class="report-link" data-report-slug="'.concat(report.slug,'" \n                         style="color: #007bff; text-decoration: none; padding:4px 8px; border:1px solid #dee2e6; border-radius:4px; background:#f8f9fa; display:inline-block; transition:all 0.2s;">\n                        ðŸ“Š ').concat(report.description,'\n                      </a>\n                    </div>\n                    <div class="message-time small text-muted">').concat(new Date(report.created_at).toLocaleTimeString(),"</div>\n                  </div>\n                </div>\n            "),$linkMsg=$(linkHtml),self=this;$linkMsg.find(".report-link").on("click",(function(){const slug=$(this).data("report-slug");self.openReportFromLink(slug)})).on("mouseenter",(function(){$(this).css({"background-color":"#e9ecef","border-color":"#adb5bd",transform:"translateY(-1px)"})})).on("mouseleave",(function(){$(this).css({"background-color":"#f8f9fa","border-color":"#dee2e6",transform:"translateY(0)"})})),$msg.after($linkMsg)},sendMessage:function(){if(this.currentMCQ)return;if(this.isSending)return;const input=$("#message-input"),rawValue=(input.val()||"").trim();if(console.log("rawValue",rawValue),!rawValue)return void Swal.fire({icon:"error",title:"Oops...",text:"Please enter a message"});const message=rawValue.trim();if(!message)return;this.isSending=!0,this.showLoading();const $userMsg=this.addMessage(message,"user");input.val("").trigger("input");const authStatus=AuthUtils.getAuthStatus(),userInfo=(null==authStatus?void 0:authStatus.user)||{};this.ajaxWithAuth({url:"https://ai-backend.stagingwithswift.com/api/chat/message",method:"POST",contentType:"application/json",data:JSON.stringify({message:message,chat_id:this.currentChatId||0,user_id:userInfo.id||null,user_name:userInfo.name||null}),success:response=>{this.hideLoading(),this.isSending=!1,response.error?"credit_limit"===response.error_type?this.handleCreditLimitError(response.message,response.credit_data):"timeout"===response.error_type?this.handleTimeoutError(response.message):(this.addMessage(response.message,"error"),this.showResendIconOnMessage($userMsg,message)):($(".failed-reload-icon").remove(),!this.currentChatId&&response.chat_id&&(this.currentChatId=response.chat_id,this.addChatToChatHistory(response.chat_id,message)),this.handleResponse(response),this.refreshSubscriptionInfo())},error:err=>{if(this.hideLoading(),this.isSending=!1,401!==err.status)return this.showResendIconOnMessage($userMsg,message),void this.addMessage("Network error occurred. Please try again.","error");AuthUtils.clearAuthData(),this.showAuthenticationError()}})},updateSendMessageandCreateNewChatButton:function(){console.log("[updateSendMessageandCreateNewChatButton] isCreditLimitExceeded:",this.isCreditLimitExceeded),this.isCreditLimitExceeded?(console.log("[updateSendMessageandCreateNewChatButton] Disabling send button and create new chat button"),$("#send-button").prop("disabled",!0),$("#create-new-chat").prop("disabled",!0)):(console.log("[updateSendMessageandCreateNewChatButton] Enabling send button and create new chat button"),$("#send-button").prop("disabled",!1),$("#create-new-chat").prop("disabled",!1))},createNewChat:function(){console.log("createNewChat",this.currentChatId),this.currentChatId=0,$("#chat-history-list li").removeClass("active"),$("#chat-container").empty(),this.clearMCQ()},addChatToChatHistory(chatId,firstMessage){const list=$("#chat-history-list");list.find('li:contains("No chat history yet")').remove();const date=(new Date).toLocaleString(),item=$('<li class="list-group-item d-flex justify-content-between align-items-start chat-history-item" data-chat-id="'.concat(chatId,'">\n                    <div>\n                        <small class="text-muted">').concat(date,"</small><br>\n                        ").concat(firstMessage,"\n                    </div>\n                </li>"));list.prepend(item),item.on("click",(e=>{const li=$(e.currentTarget),chatId=li.data("chat-id");this.loadChatMessages(chatId,li)}))},initializeCharts:function(){const container=$("#chart-container"),canvas=$("<canvas></canvas>");container.append(canvas),new Chart(canvas[0],{type:"bar",data:{labels:[],datasets:[]},options:{responsive:!0,maintainAspectRatio:!1}})},setUserName:function(user){let userName="User";"string"==typeof user?userName=user:user&&user.name?userName=user.name:user&&user.admin_name&&(userName=user.admin_name),$(".card-title").each((function(){$(this).text().includes("AI Report Assistant")&&$(this).text(userName+": AI Report Assistant")}))},isCreditExceeded:function(used,limit){return 0!==limit&&"âˆž"!==limit&&null!=limit&&used>=limit},checkAndShowCreditLimitWarning:function(subscription){console.log("[checkAndShowCreditLimitWarning] Checking subscription:",subscription);const basicExceeded=this.isCreditExceeded(subscription.basic_credits_used_this_month||0,subscription.plan_basic_credits_limit||0),premiumExceeded=this.isCreditExceeded(subscription.premium_credits_used_this_month||0,subscription.plan_premium_credits_limit||0),totalExceeded=this.isCreditExceeded(subscription.ai_credits_used_this_month||0,subscription.plan_ai_credits_limit||0);if(console.log("[checkAndShowCreditLimitWarning] Credit status:",{basicExceeded:basicExceeded,premiumExceeded:premiumExceeded,totalExceeded:totalExceeded,basicUsed:subscription.basic_credits_used_this_month||0,basicLimit:subscription.plan_basic_credits_limit||0,premiumUsed:subscription.premium_credits_used_this_month||0,premiumLimit:subscription.plan_premium_credits_limit||0,totalUsed:subscription.ai_credits_used_this_month||0,totalLimit:subscription.plan_ai_credits_limit||0}),basicExceeded||premiumExceeded||totalExceeded){console.log("[checkAndShowCreditLimitWarning] Credit limit exceeded, disabling send button");const message="You've used all your AI credits for this month. Your credits will reset on the 1st of next month. Consider upgrading your plan for more credits.";this.showPersistentCreditLimitMessage(message),this.isCreditLimitExceeded=!0,this.updateSendMessageandCreateNewChatButton()}else console.log("[checkAndShowCreditLimitWarning] Credit limit not exceeded, enabling send button"),this.isCreditLimitExceeded=!1,this.updateSendMessageandCreateNewChatButton()},updateSubscriptionInfo:async function(){try{console.log("[AI Assistant] Fetching latest subscription status...");const response=await fetch("".concat(M.cfg.wwwroot,"/report/adeptus_insights/ajax/check_subscription_status.php?t=").concat(Date.now()),{method:"GET",headers:{"Content-Type":"application/json","Cache-Control":"no-cache"}}),data=await response.json();if(console.log("[AI Assistant] Latest subscription status response:",data),data.success&&data.data){console.log("[AI Assistant] ===== SUBSCRIPTION DATA BREAKDOWN ====="),console.log("[AI Assistant] Plan Name:",data.data.plan_name),console.log("[AI Assistant] Status:",data.data.status),console.log("[AI Assistant] Credit Type:",data.data.credit_type),console.log("[AI Assistant] Reports Generated:",data.data.reports_generated_this_month),console.log("[AI Assistant] Reports Limit:",data.data.plan_exports_limit),console.log("[AI Assistant] AI Credits Used:",data.data.total_credits_used_this_month),console.log("[AI Assistant] AI Credits Limit:",data.data.plan_total_credits_limit),console.log("[AI Assistant] Exports Used:",data.data.exports_used),console.log("[AI Assistant] Exports Remaining:",data.data.exports_remaining),console.log("[AI Assistant] ========================================");(AuthUtils.getAuthStatus()||{}).subscription=data.data,"function"==typeof AuthUtils.updateSubscription&&AuthUtils.updateSubscription(data.data)}}catch(error){console.error("[AI Assistant] Error fetching latest subscription status:",error)}const authStatus=AuthUtils.getAuthStatus();if(console.log("[AI Assistant] Updating subscription info with auth status:",authStatus),authStatus&&authStatus.subscription){const subscription=authStatus.subscription;this.checkAndShowCreditLimitWarning(subscription),$(".assistant-header").remove();let subscriptionHtml='\n                    <div class="assistant-header">\n                        <div class="subscription-header-content">\n                            <h6 class="subscription-title">\n                                <i class="fa fa-chart-line me-1 subscription-icon"></i> Subscription Status <button class="btn btn-outline-secondary btn-sm" id="refresh-subscription-btn" title="Refresh subscription data">\n                                <i class="fa fa-refresh"></i></button>\n                            </h6>\n                            \n                            </button>\n                        <div class="row">\n                            <div class="col-md-6">\n                                <strong>Plan:</strong> '.concat(subscription.plan_name||"Unknown",'<br>\n                                <strong>Status:</strong> <span class="badge bg-').concat("active"===subscription.status?"success":"warning",'">').concat(subscription.status||"Unknown",'</span>\n                            </div>\n                            <div class="col-md-6">\n                                <strong>Reports:</strong> ').concat(subscription.reports_generated_this_month||0,"/").concat(subscription.plan_exports_limit||"âˆž","<br>\n                                <strong>AI Credits (").concat(subscription.credit_type||"basic",'):</strong> <span class="total-credits-counter ').concat(this.isCreditExceeded(subscription.total_credits_used_this_month||0,subscription.plan_total_credits_limit||0)?"text-danger":"",'">').concat(subscription.total_credits_used_this_month||0,"</span>/").concat(subscription.plan_total_credits_limit||"âˆž",'\n                            </div>\n                        </div>\n                        </div>\n                        \n                        <div class="row mt-2" style="display: none;">\n                            <div class="col-md-6">\n                                <div class="mb-2">\n                                    <small class="text-muted">Premium Credits</small>\n                                    <div class="progress mb-1" style="height: 6px;">\n                                        <div class="progress-bar bg-primary" role="progressbar" \n                                             style="width: ').concat(this.calculateUsagePercentage(subscription.premium_credits_used_this_month||0,subscription.plan_premium_credits_limit||1),'%">\n                            </div>\n                                    </div>\n                                </div>\n                            </div>\n                            <div class="col-md-6">\n                                <div class="mb-2">\n                                    <small class="text-muted">Basic Credits</small>\n                                    <div class="progress mb-1" style="height: 6px;">\n                                        <div class="progress-bar bg-success" role="progressbar" \n                                             style="width: ').concat(this.calculateUsagePercentage(subscription.basic_credits_used_this_month||0,subscription.plan_basic_credits_limit||1),'%">\n                                        </div>\n                                    </div>\n                                </div>\n                            </div>\n                        </div>\n                        <div class="assistant-header-actions">\n                            <a style="margin: 0 20px 17px 0" href="javascript:void(0)" onclick="window.assistant.showCreditUsageModal()" class="btn btn-primary diagnostics-btn">\n                                <i class="fa fa-stethoscope"></i> View Usage\n                            </a>\n                        </div>\n                    </div>\n                '),assistantHtml='\n                     <div class="assistant-header">\n                        <div class="assistant-header-content">\n                            <h1 class="assistant-title">\n                                <i class="fa fa-bolt wizard-icon"></i>\n                                Adeptus Insights: AI Assistant\n                            </h1>\n                            <p class="wizard-subtitle">Generate the reports you need by speaking to our AI assistant.</p>\n                        </div>\n                        <div class="wizard-header-section">\n                            <a style="margin-bottom: 17px;" href="/report/adeptus_insights/index.php" class="btn btn-primary">\n                                    <i class="fa fa-arrow-left"></i> Back to Dashboard\n                                </a>\n                        </div>\n                    </div>\n                ';const tabNav=$(".tab-nav");if(tabNav.length&&!$(".subscription-info").length)tabNav.before(assistantHtml);else if($(".subscription-info").length)$(".subscription-info").replaceWith(assistantHtml);else{const mainTitle=$("h1, h2, .page-title").first();mainTitle.length&&mainTitle.after(assistantHtml)}const tabContainer=$("#assistant-panel, #reports-panel").closest(".tab-content, .tab-pane").parent();if($(".subscription-info").remove(),tabContainer.length)tabContainer.after(subscriptionHtml);else{const mainTitle=$("h1, h2, .page-title").first();mainTitle.length&&mainTitle.after(subscriptionHtml)}const self=this;$("#refresh-subscription-btn").off("click").on("click",(function(){const $btn=$(this),$icon=$btn.find("i");$icon.removeClass("fa-refresh").addClass("fa-spinner fa-spin"),$btn.prop("disabled",!0),self.refreshSubscriptionInfo(),setTimeout((()=>{$icon.removeClass("fa-spinner fa-spin").addClass("fa-refresh"),$btn.prop("disabled",!1)}),1e3)}))}else console.log("[AI Assistant] No subscription data available in auth status"),$(".subscription-info").remove()},transformBackendAuthData:function(backendData){if(!backendData)return null;return{...window.adeptusAuthData||{},user_authorized:!0,has_api_key:!0,installation:backendData.installation,subscription:backendData.subscription?{...backendData.subscription,premium_credits_used_this_month:backendData.usage&&backendData.usage.premium_credits_used_this_month||0,basic_credits_used_this_month:backendData.usage&&backendData.usage.basic_credits_used_this_month||0,ai_credits_used_this_month:backendData.usage&&backendData.usage.ai_credits_used_this_month||0,reports_generated_this_month:backendData.usage&&backendData.usage.reports_generated_this_month||0,plan_name:backendData.plan?backendData.plan.name:"Unknown",plan_premium_credits_limit:backendData.plan&&backendData.plan.premium_credits_per_month||0,plan_basic_credits_limit:backendData.plan&&backendData.plan.basic_credits_per_month||"âˆž",plan_ai_credits_limit:backendData.plan&&backendData.plan.ai_credits||0,plan_exports_limit:backendData.plan&&backendData.plan.exports||"âˆž"}:null,plan:backendData.plan,usage:backendData.usage}},refreshSubscriptionInfo:async function(){console.log("[AI Assistant] Refreshing subscription info...");const $refreshBtn=$("#refresh-subscription-btn"),$refreshIcon=$refreshBtn.find("i");$refreshBtn.length&&$refreshIcon.length&&($refreshIcon.removeClass("fa-refresh").addClass("fa-spinner fa-spin"),$refreshBtn.prop("disabled",!0));try{const localResponse=await fetch("".concat(M.cfg.wwwroot,"/report/adeptus_insights/ajax/check_subscription_status.php?t=").concat(Date.now()),{method:"GET",headers:{"Content-Type":"application/json","Cache-Control":"no-cache"}}),localData=await localResponse.json();if(console.log("[AI Assistant] Latest local subscription status:",localData),localData.success&&localData.data){(AuthUtils.getAuthStatus()||{}).subscription=localData.data,window.adeptusAuthData&&(window.adeptusAuthData.subscription=localData.data)}await this.updateSubscriptionInfo(),console.log("[AI Assistant] Subscription info refreshed successfully"),this.showRefreshSuccessFeedback()}catch(error){console.error("[AI Assistant] Failed to refresh subscription info:",error),this.showRefreshErrorFeedback()}finally{$refreshBtn.length&&$refreshIcon.length&&($refreshIcon.removeClass("fa-spinner fa-spin").addClass("fa-refresh"),$refreshBtn.prop("disabled",!1))}},showRefreshSuccessFeedback:function(){const notification=$('\n                <div class="refresh-success-notification" style="\n                    position: fixed;\n                    top: 20px;\n                    right: 20px;\n                    background: #28a745;\n                    color: white;\n                    padding: 8px 16px;\n                    border-radius: 4px;\n                    box-shadow: 0 2px 8px rgba(0,0,0,0.15);\n                    z-index: 9999;\n                    font-size: 12px;\n                    opacity: 0;\n                    transform: translateY(-20px);\n                    transition: all 0.3s ease;\n                ">\n                    <i class="fa fa-check me-1"></i>\n                    Usage updated\n                </div>\n            ');$("body").append(notification),setTimeout((()=>{notification.css({opacity:"1",transform:"translateY(0)"})}),100),setTimeout((()=>{notification.css({opacity:"0",transform:"translateY(-20px)"}),setTimeout((()=>notification.remove()),300)}),2e3)},showRefreshErrorFeedback:function(){const notification=$('\n                <div class="refresh-error-notification" style="\n                    position: fixed;\n                    top: 20px;\n                    right: 20px;\n                    background: #dc3545;\n                    color: white;\n                    padding: 8px 16px;\n                    border-radius: 4px;\n                    box-shadow: 0 2px 8px rgba(0,0,0,0.15);\n                    z-index: 9999;\n                    font-size: 12px;\n                    opacity: 0;\n                    transform: translateY(-20px);\n                    transition: all 0.3s ease;\n                ">\n                    <i class="fa fa-exclamation-triangle me-1"></i>\n                    Failed to update usage\n                </div>\n            ');$("body").append(notification),setTimeout((()=>{notification.css({opacity:"1",transform:"translateY(0)"})}),100),setTimeout((()=>{notification.css({opacity:"0",transform:"translateY(-20px)"}),setTimeout((()=>notification.remove()),300)}),3e3)},calculateUsagePercentage:function(used,limit){if(!limit||"âˆž"===limit||0===limit)return 0;const percentage=used/limit*100;return Math.min(percentage,100)},ajaxWithAuth:function(options){if(!AuthUtils.isAuthenticated())return this.showAuthenticationError(),Promise.reject(new Error("Authentication required"));const authHeaders=AuthUtils.getAuthHeaders();return options.headers={...options.headers,...authHeaders},$.ajax(options)},validateToken:function(){return AuthUtils.isAuthenticated()},resendMessage:function($msgElem,message){if(this.isSending)return;this.isSending=!0,this.showLoading();const authStatus=AuthUtils.getAuthStatus(),userInfo=(null==authStatus?void 0:authStatus.user)||{};this.ajaxWithAuth({url:"https://ai-backend.stagingwithswift.com/api/chat/message",method:"POST",contentType:"application/json",data:JSON.stringify({message:message,chat_id:this.currentChatId||0,user_id:userInfo.id||null,user_name:userInfo.name||null}),success:response=>{this.hideLoading(),this.isSending=!1,response.error?"credit_limit"===response.error_type?this.handleCreditLimitError(response.message,response.credit_data):(this.addMessage(response.message,"error"),this.showResendIconOnMessage($msgElem,message)):($(".failed-reload-icon").remove(),!this.currentChatId&&response.chat_id&&(this.currentChatId=response.chat_id,this.addChatToChatHistory(response.chat_id,message)),this.handleResponse(response))},error:err=>{this.hideLoading(),this.isSending=!1,401===err.status?(AuthUtils.clearAuthData(),this.showAuthenticationError()):(this.showResendIconOnMessage($msgElem,message),this.addMessage("Network error occurred. Please try again.","error"))}})},enqueueMCQs:function(questions){Array.isArray(questions)&&0!==questions.length&&(this.mcqQueue=questions.slice(),this.showNextMCQ())},showNextMCQ:function(){if(0===this.mcqQueue.length)return this.clearMCQ();const next=this.mcqQueue.shift();this.renderMCQ(next.question,next.options)},renderMCQ:function(question,options){this.currentMCQ=!0,$("#message-input, #send-button").prop("disabled",!0);const c=$("#mcq-container").empty().show();c.append('<p class="mcq-question"><strong>'.concat(question,"</strong></p>")),options.forEach(((opt,idx)=>{const key=String.fromCharCode(65+idx);c.append('\n                <div class="form-check">\n                    <input class="form-check-input" type="radio"\n                        name="mcq-option" id="mcq-'.concat(idx,'"\n                        value="').concat(opt,'">\n                    <label class="form-check-label" for="mcq-').concat(idx,'">\n                    ').concat(key,". ").concat(opt,"\n                    </label>\n                </div>"))})),c.append('<button class="btn btn-link" id="mcq-cancel">Cancel</button>'),c.find('input[name="mcq-option"]').on("change",(()=>{$("#mcq-submit").remove(),c.append('<button id="mcq-submit" class="btn btn-primary mt-2">Submit</button>'),$("#mcq-submit").off("click").on("click",(()=>{const selected=c.find('input[name="mcq-option"]:checked').val();this.sendMCQ(selected)}))})),c.find("#mcq-cancel").off("click").on("click",(()=>{this.mcqQueue=[],this.clearMCQ()}))},sendMCQ:function(answer){if(this.isSending)return;this.showLoading(),this.isSending=!0,this.clearMCQ();const $userMsg=this.addMessage(answer,"user"),authStatus=AuthUtils.getAuthStatus(),userInfo=(null==authStatus?void 0:authStatus.user)||{};this.ajaxWithAuth({url:"https://ai-backend.stagingwithswift.com/api/chat/message",method:"POST",contentType:"application/json",data:JSON.stringify({message:answer,chat_id:this.currentChatId||0,user_id:userInfo.id||null,user_name:userInfo.name||null}),success:response=>{this.hideLoading(),this.isSending=!1,response.error?"credit_limit"===response.error_type?this.handleCreditLimitError(response.message):(this.addMessage(response.message,"error"),this.showResendIconOnMessage($userMsg,answer)):($(".failed-reload-icon").remove(),this.handleResponse(response))},error:()=>{this.hideLoading(),this.isSending=!1,this.addMessage("Failed to send choice","error"),this.showResendIconOnMessage($userMsg,answer)}})},switchToReportsTab:function(){$("#reports-tab").tab("show"),$("#assistant-tab").removeClass("active").attr("aria-selected","false"),$("#reports-tab").addClass("active").attr("aria-selected","true"),$("#assistant-panel").removeClass("show active"),$("#reports-panel").addClass("show active"),$(".report-view-title").text("Select a Report"),$(".report-view-body").html('<div class="text-center py-4"><p class="text-muted">Select a report from history to view details here.</p></div>'),$("#report-history-loader").addClass("d-none"),$("#report-history-table-wrapper").removeClass("d-none")},loadReportsHistory:function(callback){$("#report-history-loader").removeClass("d-none"),$("#report-history-table-wrapper").addClass("d-none"),this.ajaxWithAuth({url:"https://ai-backend.stagingwithswift.com/api/reports",method:"GET",success:response=>{this.cachedReports=response.reports,this.updateReportsHistory(response.reports),$("#report-history-loader").addClass("d-none"),$("#report-history-table-wrapper").removeClass("d-none"),this.reportsDataTable&&(this.reportsDataTable.destroy(),this.reportsDataTable=null),setTimeout((()=>{try{const tableElement=document.getElementById("reports-history-table");if(!tableElement)return void console.warn("Table element not found");const tbody=tableElement.querySelector("tbody"),thead=tableElement.querySelector("thead");if(thead&&tbody&&thead.rows.length>0&&thead.rows[0].cells.length>0){this.reportsDataTable&&(this.reportsDataTable.destroy(),this.reportsDataTable=null);const headerCells=thead.rows[0].cells.length,dataRows=tbody.rows;let dataCells=0;dataRows.length>0&&(dataCells=dataRows[0].cells.length),console.log("Table structure check - Headers: ".concat(headerCells,", Data: ").concat(dataCells)),headerCells===dataCells&&headerCells>0?dataRows.length>0&&!dataRows[0].cells[0].textContent.includes("No reports")?(this.reportsDataTable=new simpleDatatables.DataTable("#reports-history-table",{searchable:!0,fixedHeight:!1,perPage:10}),console.log("DataTable initialized successfully")):console.log("Skipping DataTable initialization - no data rows or empty state"):console.warn("Column mismatch - Headers: ".concat(headerCells,", Data: ").concat(dataCells))}else console.warn("Table structure not ready for DataTable initialization")}catch(error){console.error("Error initializing DataTable:",error)}"function"==typeof callback&&callback()}),100)},error:(xhr,status,error)=>{console.error("Failed to load report history:",error),this.showError("Failed to load report history"),$("#report-history-loader").addClass("d-none");const tbody=$("#reports-history-table tbody");tbody.empty(),tbody.append('<tr><td colspan="3" class="text-center text-danger">Failed to load reports</td></tr>'),$("#report-history-table-wrapper").removeClass("d-none")}})},updateReportsHistory:function(reports){const tbody=$("#reports-history-table tbody"),self=this;if(tbody.empty(),reports&&0!==reports.length)reports.forEach((report=>{const statusBadge=self.getStatusBadge(report.status),date=new Date(report.created_at).toLocaleDateString(),row=$('\n                    <tr class="report-row" data-report-slug="'.concat(report.slug,'">\n                        <td>').concat(report.description,"</td>\n                        <td>").concat(date,"</td>\n                        <td>").concat(statusBadge,"</td>\n                    </tr>"));row.on("click",(function(){if($("#reports-panel .col-md-8 .card-body").find(".report-display-wrapper").html('<div class="w-100 d-flex justify-content-center align-items-center" style="min-height:200px"><div class="spinner-border text-primary" role="status"></div></div>'),console.log("cachedReports",self.cachedReports),console.log("report",report),Array.isArray(self.cachedReports)&&self.cachedReports.length>0){const rep=self.cachedReports.find((r=>r.slug===report.slug));rep?(console.log("Found in cache - rep:",rep),console.log("Has data?",rep.data?"YES":"NO"),console.log("Data length:",rep.data?rep.data.length:"N/A"),rep.data&&Array.isArray(rep.data)&&rep.data.length>0?(console.log("Using cached data"),setTimeout((()=>{self.updateReportsView(rep,rep.data)}),300)):(console.log("Cached report has no data, fetching from API"),self.fetchAndDisplayReport(report.slug,row))):(console.log("Report not in cache, fetching from API"),self.fetchAndDisplayReport(report.slug,row))}else console.log("No cached reports, fetching from API"),self.fetchAndDisplayReport(report.slug,row);$(".report-row").removeClass("table-primary"),row.addClass("table-primary")})),tbody.append(row)}));else{const authStatus=AuthUtils.getAuthStatus();authStatus&&authStatus.subscription&&authStatus.subscription.reports_generated_this_month>0?tbody.append('<tr><td colspan="3" class="text-center text-muted">No reports yet</td></tr>'):tbody.append('\n                        <tr>\n                            <td colspan="3" class="text-center text-muted">\n                                <div class="py-4">\n                                    <i class="fa fa-chart-bar fa-2x mb-2"></i>\n                                    <p class="mb-1">No reports generated yet</p>\n                                    <small>Ask the AI assistant to create reports for you</small>\n                                </div>\n                            </td>\n                        </tr>\n                    ')}},fetchAndDisplayReport:function(reportSlug,rowElem){console.log("fetchAndDisplayReport",reportSlug,rowElem);const reportsView=$("#reports-panel .col-md-8 .card-body");reportsView.html('<div class="report-display-wrapper w-100"><div class="w-100 d-flex justify-content-center align-items-center" style="min-height:200px"><div class="spinner-border text-primary" role="status"></div></div></div>'),this.ajaxWithAuth({url:"https://ai-backend.stagingwithswift.com/api/reports/".concat(reportSlug),method:"GET",success:response=>{console.log("fetchAndDisplayReport success - full response:",response),console.log("fetchAndDisplayReport - report:",response.report),console.log("fetchAndDisplayReport - data:",response.data),console.log("fetchAndDisplayReport - data type:",typeof response.data),console.log("fetchAndDisplayReport - data is array:",Array.isArray(response.data)),console.log("fetchAndDisplayReport - data length:",response.data?response.data.length:"null/undefined"),Array.isArray(this.cachedReports)||(this.cachedReports=[]);let idx=this.cachedReports.findIndex((r=>r.slug===reportSlug));if(idx>-1?this.cachedReports[idx]=Object.assign({},response.report,{data:response.data}):this.cachedReports.push(Object.assign({},response.report,{data:response.data})),!response.data||Array.isArray(response.data)&&0===response.data.length)return console.warn("No data returned from backend for report:",reportSlug),void reportsView.find(".report-display-wrapper").html('<div class="w-100 text-center text-warning py-4"><i class="fa fa-exclamation-triangle"></i> Report completed but no data is available. The report may need to be re-executed.</div>');console.log("Calling updateReportsView with:",response.report,response.data),this.updateReportsView(response.report,response.data),$(".report-row").removeClass("table-primary"),rowElem&&rowElem.addClass("table-primary")},error:(xhr,status,error)=>{console.error("fetchAndDisplayReport error:",reportSlug,status,error),console.error("XHR:",xhr),reportsView.find(".report-display-wrapper").html('<div class="w-100 text-center text-danger py-4">Failed to load report. Please try again.</div>')}})},displayCurrentReport:function(report){this.updateReportsView(report),$('.report-row[data-report-slug="'.concat(report.slug,'"]')).addClass("table-primary")},displayReport:function(reportSlug){const rep=this.cachedReports.find((r=>r.slug===reportSlug));rep&&(this.updateReportsView(rep,rep.data),$(".report-row").removeClass("table-primary"),$('.report-row[data-report-slug="'.concat(reportSlug,'"]')).addClass("table-primary"))},updateReportsView:function(report){let data=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;const self=this;if(self.reportChartInstance&&(self.reportChartInstance.destroy(),self.reportChartInstance=null),self.reportGraphInstance&&(self.reportGraphInstance.destroy(),self.reportGraphInstance=null),self._vteController&&"function"==typeof self._vteController.destroy){try{self._vteController.destroy()}catch(e){console.error("Error destroying VTE controller:",e)}self._vteController=null}const reportsView=$("#reports-panel .col-md-8 .card-body");if(0===$("#display-type-icon-style").length&&$("head").append('\n                    <style id="display-type-icon-style">\n                        .btn-icon {\n                            transition: transform 0.15s cubic-bezier(.4,2,.6,1), background 0.2s, border 0.2s;\n                            background: #f8f9fa;\n                            border: 1.5px solid #e0e0e0;\n                            color: #333;\n                        }\n                        .btn-icon:hover {\n                            transform: scale(1.15);\n                            background: #e9ecef;\n                            border-color: #b3d7ff;\n                            color: #007bff;\n                            z-index: 2;\n                        }\n                        .btn-icon.active, .btn-icon:focus {\n                            background: #e3f0ff;\n                            border-color: #007bff;\n                            color: #007bff;\n                            box-shadow: 0 0 0 2px #b3d7ff33;\n                        }\n                        .display-fade {\n                            opacity: 0;\n                            transition: opacity 0.25s;\n                        }\n                        .display-fade.display-fade-in {\n                            opacity: 1;\n                        }\n                    </style>\n                '),$(".report-view-title").text(report.description),!Array.isArray(data)||0===data.length)return void reportsView.find(".report-display-wrapper").html('<div class="w-100 text-center text-muted py-4">No data available for this report.</div>');const types=["table","chart","graph"],typeLabels={table:"Table",chart:"Chart",graph:"Graph"},typeIcons={table:'<i class="fa fa-table"></i>',chart:'<i class="fa fa-bar-chart"></i>',graph:'<i class="fa fa-line-chart"></i>'};let controlsHtml='\n                <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap">\n                    <div class="action-buttons d-flex gap-2">\n                        <button class="btn btn-outline-secondary btn-sm export-csv-btn mr-10">\n                            <i class="fa fa-download me-1"></i>Export CSV\n                        </button>\n                        <button class="btn btn-outline-secondary btn-sm export-json-btn">\n                            <i class="fa fa-code me-1"></i>Export JSON\n                        </button>\n                    </div>\n                    <div class="display-type-icons d-flex gap-2 align-items-center">\n            ';types.forEach((type=>{const active=report.display_type===type?" active":"";controlsHtml+='<button class="btn btn-icon mr-10 mb-0'.concat(active,'" data-type="').concat(type,'" title="').concat(typeLabels[type],' View" style="font-size:1.5rem; width:40px; height:40px; border-radius:50%; display:flex; align-items:center; justify-content:center; padding:0;">').concat(typeIcons[type],"</button>")})),controlsHtml+="</div></div>";let displayHtml='<div class="report-display-area w-100 position-relative" style="min-height:300px;">';types.forEach((type=>{const isActive=report.display_type===type;let content="";"table"===type?content=this.renderReportData(data):"chart"===type?content='<div class="chart-container"><canvas id="reportChart"></canvas></div>':"graph"===type&&(content='<div class="chart-container"><canvas id="reportGraph"></canvas></div>'),displayHtml+='<div class="display-fade'.concat(isActive?" display-fade-in":"",'" data-type="').concat(type,'" style="position:absolute; top:0; left:0; width:100%;').concat(isActive?"z-index:1;":"z-index:0; pointer-events:none;",'">').concat(content,"</div>")})),displayHtml+="</div>",reportsView.html("\n                ".concat(controlsHtml,'\n                <div class="report-display-wrapper w-100 position-relative">\n                    ').concat(displayHtml,"\n                </div>\n            ")),this._pendingTableId&&"table"===report.display_type&&setTimeout((()=>{if(document.getElementById(this._pendingTableId)&&window.VTE){console.log("Initializing Vanilla Table Enhancer on table:",this._pendingTableId);try{this._vteController=window.VTE.enhance("#"+this._pendingTableId,{perPage:10,perPageOptions:[10,25,50,100],labels:{search:"Search",rows:"Rows per page",info:(start,end,total)=>"Showing ".concat(start,"â€“").concat(end," of ").concat(total," entries"),noData:"No matching records found"}})[0]}catch(e){console.error("Error initializing Vanilla Table Enhancer:",e)}}this._pendingTableId=null}),100);const initialType=report.display_type;"chart"===initialType?setTimeout((()=>{const chartEl=document.getElementById("reportChart");if(chartEl){const headers=Object.keys(data[0]||{});let labelKey=headers.find((h=>"string"==typeof data[0][h]))||headers[0],valueKey=headers.find((h=>"number"==typeof data[0][h]&&!/^([a-zA-Z0-9]*_)?id$/.test(h)))||headers.find((h=>"number"==typeof data[0][h]&&!h.endsWith("_id")))||headers.find((h=>"number"==typeof data[0][h]))||headers[1];const labels=data.map((r=>r[labelKey])),values=data.map((r=>r[valueKey]));self.reportChartInstance&&self.reportChartInstance.destroy(),self.reportChartInstance=new Chart(chartEl.getContext("2d"),{type:"bar",data:{labels:labels,datasets:[{label:valueKey.replace(/_/g," ").replace(/\b\w/g,(l=>l.toUpperCase())),data:values,backgroundColor:"rgba(0,123,255,0.5)",borderColor:"rgba(0,123,255,1)",borderWidth:1}]},options:{responsive:!0,maintainAspectRatio:!1}})}}),100):"graph"===initialType&&setTimeout((()=>{const graphEl=document.getElementById("reportGraph");if(graphEl){const headers=Object.keys(data[0]||{});let labelKey=headers.find((h=>"string"==typeof data[0][h]))||headers[0],valueKey=headers.find((h=>"number"==typeof data[0][h]&&!/^([a-zA-Z0-9]*_)?id$/.test(h)))||headers.find((h=>"number"==typeof data[0][h]&&!h.endsWith("_id")))||headers.find((h=>"number"==typeof data[0][h]))||headers[1];const labels=data.map((r=>r[labelKey])),values=data.map((r=>r[valueKey]));self.reportGraphInstance&&self.reportGraphInstance.destroy(),self.reportGraphInstance=new Chart(graphEl.getContext("2d"),{type:"line",data:{labels:labels,datasets:[{label:valueKey.replace(/_/g," ").replace(/\b\w/g,(l=>l.toUpperCase())),data:values,backgroundColor:"rgba(40,167,69,0.5)",borderColor:"rgba(40,167,69,1)",borderWidth:1}]},options:{responsive:!0,maintainAspectRatio:!1}})}}),100);const iconButtons=reportsView.find(".display-type-icons .btn-icon");iconButtons.on("click",(function(){const type=$(this).data("type");iconButtons.removeClass("active"),$(this).addClass("active"),types.forEach((t=>{const $el=reportsView.find('.display-fade[data-type="'.concat(t,'"]'));t===type?$el.addClass("display-fade-in").css({"z-index":1,"pointer-events":"auto"}):$el.removeClass("display-fade-in").css({"z-index":0,"pointer-events":"none"})})),"table"===type&&!self._vteController&&self._pendingTableId&&setTimeout((()=>{if(document.getElementById(self._pendingTableId)&&window.VTE){console.log("Initializing Vanilla Table Enhancer on table (view switch):",self._pendingTableId);try{self._vteController=window.VTE.enhance("#"+self._pendingTableId,{perPage:10,perPageOptions:[10,25,50,100],labels:{search:"Search",rows:"Rows per page",info:(start,end,total)=>"Showing ".concat(start,"â€“").concat(end," of ").concat(total," entries"),noData:"No matching records found"}})[0]}catch(e){console.error("Error initializing Vanilla Table Enhancer on view switch:",e)}}}),100),"chart"===type?setTimeout((()=>{const chartEl=document.getElementById("reportChart");if(chartEl){const headers=Object.keys(data[0]||{});let labelKey=headers.find((h=>"string"==typeof data[0][h]))||headers[0],valueKey=headers.find((h=>"number"==typeof data[0][h]&&!/^([a-zA-Z0-9]*_)?id$/.test(h)))||headers.find((h=>"number"==typeof data[0][h]&&!h.endsWith("_id")))||headers.find((h=>"number"==typeof data[0][h]))||headers[1];const labels=data.map((r=>r[labelKey])),values=data.map((r=>r[valueKey]));self.reportChartInstance&&self.reportChartInstance.destroy(),self.reportChartInstance=new Chart(chartEl.getContext("2d"),{type:"bar",data:{labels:labels,datasets:[{label:valueKey.replace(/_/g," ").replace(/\b\w/g,(l=>l.toUpperCase())),data:values,backgroundColor:"rgba(0,123,255,0.5)",borderColor:"rgba(0,123,255,1)",borderWidth:1}]},options:{responsive:!0,maintainAspectRatio:!1}})}}),100):"graph"===type&&setTimeout((()=>{const graphEl=document.getElementById("reportGraph");if(graphEl){const headers=Object.keys(data[0]||{});let labelKey=headers.find((h=>"string"==typeof data[0][h]))||headers[0],valueKey=headers.find((h=>"number"==typeof data[0][h]&&!/^([a-zA-Z0-9]*_)?id$/.test(h)))||headers.find((h=>"number"==typeof data[0][h]&&!h.endsWith("_id")))||headers.find((h=>"number"==typeof data[0][h]))||headers[1];const labels=data.map((r=>r[labelKey])),values=data.map((r=>r[valueKey]));self.reportGraphInstance&&self.reportGraphInstance.destroy(),self.reportGraphInstance=new Chart(graphEl.getContext("2d"),{type:"line",data:{labels:labels,datasets:[{label:valueKey.replace(/_/g," ").replace(/\b\w/g,(l=>l.toUpperCase())),data:values,backgroundColor:"rgba(40,167,69,0.5)",borderColor:"rgba(40,167,69,1)",borderWidth:1}]},options:{responsive:!0,maintainAspectRatio:!1}})}}),100),type!==report.display_type?0===reportsView.find(".save-display-type-btn").length&&(reportsView.find(".display-type-icons").append('<button class="btn btn-icon save-display-type-btn" style="font-size:1.5rem; width:40px; height:40px; border-radius:50%;"><i class="fa fa-save"></i></button>'),reportsView.find(".save-display-type-btn").on("click",(function(){self.saveDisplayType(report.slug,type)}))):reportsView.find(".save-display-type-btn").remove()})),reportsView.find(".export-csv-btn").on("click",(()=>self.exportReport(report.slug,"csv"))),reportsView.find(".export-json-btn").on("click",(()=>self.exportReport(report.slug,"json")))},renderReportData:function(data){if(!data||0===data.length)return'<p class="text-muted">No data available.</p>';const headers=Object.keys(data[0]),tableId="enhanced-report-table-"+Date.now();let tableHtml='<div class="table-responsive"><table id="'.concat(tableId,'" class="table table-striped table-hover">');return tableHtml+="<thead><tr>",headers.forEach((header=>{const isNumeric=data.every((row=>{const val=row[header];return null==val||""===val||!isNaN(parseFloat(val))})),isDate=!isNumeric&&data.some((row=>{const val=row[header];return val&&!isNaN(Date.parse(val))}));tableHtml+="<th".concat(isNumeric?' data-vte="number"':isDate?' data-vte="date"':"",">").concat(header.replace(/_/g," ").replace(/\b\w/g,(l=>l.toUpperCase())),"</th>")})),tableHtml+="</tr></thead>",tableHtml+="<tbody>",data.forEach((row=>{tableHtml+="<tr>",headers.forEach((header=>{tableHtml+="<td>".concat(row[header]||"","</td>")})),tableHtml+="</tr>"})),tableHtml+="</tbody></table></div>",this._pendingTableId=tableId,tableHtml},getStatusBadge:function(status){const badgeClass=this.getStatusBadgeClass(status);return'<span class="badge '.concat(badgeClass,'" style="color: white;">').concat(status,"</span>")},getStatusBadgeClass:function(status){switch(status){case"completed":return"bg-success";case"processing":return"bg-warning text-dark";case"pending":return"bg-info";case"failed":return"bg-danger";default:return"bg-secondary"}},executeReport:function(reportSlug){const reportRow=$('.report-row[data-report-slug="'.concat(reportSlug,'"]')),originalContent=reportRow.html();reportRow.html('<td colspan="3" class="text-center"><div class="spinner-border spinner-border-sm text-primary" role="status"><span class="visually-hidden">Executing...</span></div> Executing report...</td>'),this.ajaxWithAuth({url:"https://ai-backend.stagingwithswift.com/api/reports/".concat(reportSlug,"/execute"),method:"POST",success:response=>{if(response.success){if(Array.isArray(this.cachedReports)){const reportIndex=this.cachedReports.findIndex((r=>r.slug===reportSlug));-1!==reportIndex&&(this.cachedReports[reportIndex]=Object.assign({},this.cachedReports[reportIndex],response.report))}setTimeout((()=>{this.fetchAndDisplayReport(reportSlug,reportRow)}),1e3),this.showSuccess("Report executed successfully!")}else reportRow.html(originalContent),this.showError("Failed to execute report: "+(response.error||"Unknown error"))},error:(xhr,status,error)=>{reportRow.html(originalContent);let errorMessage="Failed to execute report";500===xhr.status?errorMessage="Server error occurred while executing the report. Please check the SQL query and try again.":403===xhr.status?errorMessage="You do not have permission to execute this report.":404===xhr.status?errorMessage="Report not found.":xhr.responseJSON&&xhr.responseJSON.error?errorMessage=xhr.responseJSON.error:errorMessage+=": "+error,console.error("Report execution failed:",{status:xhr.status,error:error,response:xhr.responseText}),this.showError(errorMessage)}})},exportReport:function(reportSlug,format){const url="https://ai-backend.stagingwithswift.com/api/reports/".concat(reportSlug,"/export/").concat(format),token=sessionStorage.getItem("ai_token");token?(Swal.fire({title:"Exporting report...",allowOutsideClick:!1,didOpen:()=>Swal.showLoading()}),fetch(url,{method:"GET",headers:{Authorization:"Bearer "+token}}).then((response=>{if(!response.ok)throw new Error("Export failed");return response.blob()})).then((blob=>{Swal.close();const link=document.createElement("a");link.href=window.URL.createObjectURL(blob),link.download="report-".concat(reportSlug,".").concat(format),document.body.appendChild(link),link.click(),document.body.removeChild(link)})).catch((()=>{Swal.close(),this.showError("Failed to export report.")}))):this.showError("You must be logged in to export reports.")},openReportFromLink:function(reportSlug){console.log("openReportFromLink called with slug:",reportSlug),this.switchToReportsTab(),this.updateReportsHistory(this.cachedReports),$(".report-row").removeClass("table-primary");const reportRow=$('.report-row[data-report-slug="'.concat(reportSlug,'"]'));reportRow.addClass("table-primary");const cached=this.cachedReports.find((r=>r.slug===reportSlug));console.log("Cached report found:",cached),console.log("Has data?",cached&&cached.data?"YES":"NO"),console.log("Data length:",cached&&cached.data?cached.data.length:"N/A"),cached&&cached.data&&Array.isArray(cached.data)&&cached.data.length>0?(console.log("Using cached data for report:",reportSlug),this.updateReportsView(cached,cached.data)):(console.log("Fetching report data from API:",reportSlug),this.fetchAndDisplayReport(reportSlug,reportRow))},formatTimestamp:function(ts){const date=ts instanceof Date?ts:new Date(ts),now=new Date,pad=n=>n.toString().padStart(2,"0"),time="".concat(pad(date.getHours()),":").concat(pad(date.getMinutes()));if(date.getFullYear()!==now.getFullYear()){const month=date.toLocaleString("default",{month:"long"});return"".concat(date.getDate()," ").concat(month," ").concat(date.getFullYear()," - ").concat(time)}if(date.toDateString()===now.toDateString())return time;const yesterday=new Date(now.getFullYear(),now.getMonth(),now.getDate()-1);if(date.toDateString()===yesterday.toDateString()){const weekday=date.toLocaleString("default",{weekday:"long"});return"".concat(weekday," - ").concat(time)}const month=date.toLocaleString("default",{month:"long"});return"".concat(date.getDate()," ").concat(month," - ").concat(time)},updateChatHistoryBadge:function(chatId){const $item=$('#chat-history-list li.chat-history-item[data-chat-id="'.concat(chatId,'"]'));if(!$item.length)return;let $badge=$item.find(".report-count");if($badge.length){const current=parseInt($badge.text(),10)||0;$badge.text(current+1)}else{const $newBadge=$('<span class="badge bg-primary d-flex align-items-center report-count" style="color: white;"><i class="fa fa-chart-bar me-1"></i>1</span>');$item.append($newBadge)}},saveDisplayType:function(reportSlug,displayType){Swal.fire({title:"Saving default view...",allowOutsideClick:!1,didOpen:()=>Swal.showLoading()}),this.ajaxWithAuth({url:"https://ai-backend.stagingwithswift.com/api/reports/".concat(reportSlug,"/display-type"),method:"POST",contentType:"application/json",data:JSON.stringify({display_type:displayType}),success:()=>{Swal.fire({icon:"success",title:"Default view saved",showConfirmButton:!1,timer:1500});const rep=this.cachedReports.find((r=>r.slug===reportSlug));rep&&(rep.display_type=displayType),$(".save-display-type-btn").remove()},error:()=>{Swal.fire({icon:"error",title:"Save failed",text:"Could not save default view. Please try again."})}})},showResendIconOnMessage:function($messageElement,messageText){if(!$messageElement||!$messageElement.length)return;$messageElement.siblings(".failed-reload-icon").remove();const $icon=$('\n                    <i class="fa fa-refresh failed-reload-icon text-danger"\n                   title="Retry sending this message"\n                       style="cursor:pointer; float:left; margin-right:0.5rem;"></i>\n                ');$messageElement.after($icon),$icon.on("click",(()=>{$icon.remove(),this.resendMessage($messageElement,messageText)}))},showResendIconOnLastUserMessage:function(){const $lastUserMessage=$("#chat-container .user-message:last");if($lastUserMessage.length){const messageText=$lastUserMessage.find(".message-text").text();this.showResendIconOnMessage($lastUserMessage,messageText)}},showCompareDataModal:function(report){const self=this,reportSlug=report.slug;let timeline=[],currentData=null,selectedA=null,selectedB=null,loadingA=!1,loadingB=!1,error=null,displayTypeA="table",displayTypeB="table",currentSnapshotId=null,compareDataA=null,compareDataB=null,currentDataFetched=!1,nextSection="a";function fetchSnapshotData(snapId,section,cb){"a"===section&&(loadingA=!0),"b"===section&&(loadingB=!0),renderSections(),self.ajaxWithAuth({url:"https://ai-backend.stagingwithswift.com/api/reports/".concat(reportSlug,"/snapshots/").concat(snapId),method:"GET",success:function(res){"a"===section?(compareDataA=res.data,selectedA=snapId,loadingA=!1):(compareDataB=res.data,selectedB=snapId,loadingB=!1),renderSections(),cb&&cb()},error:function(){error="Failed to fetch snapshot data.","a"===section&&(loadingA=!1),"b"===section&&(loadingB=!1),renderSections(),cb&&cb()}})}function getSnapshotColor(snapId){if(!snapId)return{bg:"#f8f9fa",border:"#dee2e6",text:"#6c757d"};const snapIndex=timeline.findIndex((s=>s.id===snapId));if(-1===snapIndex)return{bg:"#f8f9fa",border:"#dee2e6",text:"#6c757d"};const colors=[{bg:"#e3f2fd",border:"#2196f3",text:"#1976d2"},{bg:"#f3e5f5",border:"#9c27b0",text:"#7b1fa2"},{bg:"#e8f5e8",border:"#4caf50",text:"#388e3c"},{bg:"#fff3e0",border:"#ff9800",text:"#f57c00"},{bg:"#fce4ec",border:"#e91e63",text:"#c2185b"},{bg:"#e0f2f1",border:"#009688",text:"#00695c"},{bg:"#f1f8e9",border:"#8bc34a",text:"#689f38"},{bg:"#fff8e1",border:"#ffc107",text:"#ffa000"}];return colors[snapIndex%colors.length]}function getSnapshotNote(snapId){if(!snapId)return"";if("string"==typeof snapId&&"current"===snapId)return"Current Data";const snap=timeline.find((s=>s.id===snapId));return snap&&snap.note?snap.note:""}function renderSections(){if($("#compare-section-a").replaceWith(function(){let html="";const colorA=getSnapshotColor(selectedA),noteA=getSnapshotNote(selectedA);return html+='<div class="w-100 droppable-snapshot compare-section" id="compare-section-a" data-drop-target="a" style="border: 2px solid '.concat(colorA.border,"; border-radius: 8px; padding: 12px; background-color: ").concat(colorA.bg,'; height: 100%; min-height: 300px; position:relative;">\n                    <div class="d-flex justify-content-between align-items-center mb-2">\n                        <span class="fw-bold" style="color: ').concat(colorA.text,';">Snapshot A').concat(noteA?": "+noteA:"",'</span>\n                        <div class="btn-group display-type-switcher-a" role="group" aria-label="Display type switcher">\n                            <button class="btn btn-icon btn-sm').concat("table"===displayTypeA?" active":"",'" data-type="table" data-side="a" tabindex="0" aria-label="Table view" title="Table view"><i class="fa fa-table"></i></button>\n                            <button class="btn btn-icon btn-sm').concat("chart"===displayTypeA?" active":"",'" data-type="chart" data-side="a" tabindex="0" aria-label="Chart view" title="Chart view"><i class="fa fa-bar-chart"></i></button>\n                            <button class="btn btn-icon btn-sm').concat("graph"===displayTypeA?" active":"",'" data-type="graph" data-side="a" tabindex="0" aria-label="Graph view" title="Graph view"><i class="fa fa-line-chart"></i></button>\n                            </div>\n                        </div>'),loadingA?html+='<div class="w-100 d-flex justify-content-center align-items-center" style="min-height:200px"><div class="spinner-border text-primary" role="status"></div></div>':compareDataA?(html+='<div class="comparison-fade'.concat(displayTypeA?" comparison-fade-in":"",'" style="animation:fadeIn .3s; overflow-x: auto; max-height: calc(100% - 50px);">'),"table"===displayTypeA?html+=self.renderDiffTable(compareDataA,compareDataB):"chart"===displayTypeA?html+='<div class="chart-container" style="min-height:260px;" tabindex="0" aria-label="Bar chart" role="region"><canvas id="compareChartA"></canvas></div>':"graph"===displayTypeA&&(html+='<div class="chart-container" style="min-height:260px;" tabindex="0" aria-label="Line graph" role="region"><canvas id="compareGraphA"></canvas></div>'),html+="</div>"):html+='<div class="text-muted small text-center" style="min-height:200px;">No snapshot selected for A</div>',html+="</div>",html}()),$("#compare-section-b").replaceWith(function(){let html="";const colorB=getSnapshotColor(selectedB),noteB=getSnapshotNote(selectedB);return html+='<div class="w-100 droppable-snapshot compare-section" id="compare-section-b" data-drop-target="b" style="border: 2px solid '.concat(colorB.border,"; border-radius: 8px; padding: 12px; background-color: ").concat(colorB.bg,'; height: 100%; min-height: 300px; position:relative;">\n                    <div class="d-flex justify-content-between align-items-center mb-2">\n                        <span class="fw-bold" style="color: ').concat(colorB.text,';">Snapshot B').concat(noteB?": "+noteB:"",'</span>\n                        <div class="btn-group display-type-switcher-b" role="group" aria-label="Display type switcher B">\n                            <button class="btn btn-icon btn-sm').concat("table"===displayTypeB?" active":"",'" data-type="table" data-side="b" tabindex="0" aria-label="Table view for B" title="Table view"><i class="fa fa-table"></i></button>\n                            <button class="btn btn-icon btn-sm').concat("chart"===displayTypeB?" active":"",'" data-type="chart" data-side="b" tabindex="0" aria-label="Chart view for B" title="Chart view"><i class="fa fa-bar-chart"></i></button>\n                            <button class="btn btn-icon btn-sm').concat("graph"===displayTypeB?" active":"",'" data-type="graph" data-side="b" tabindex="0" aria-label="Graph view for B" title="Graph view"><i class="fa fa-line-chart"></i></button>\n                        </div>\n                    </div>'),loadingB?html+='<div class="w-100 d-flex justify-content-center align-items-center" style="min-height:200px"><div class="spinner-border text-primary" role="status"></div></div>':compareDataB?(html+='<div class="comparison-fade'.concat(displayTypeB?" comparison-fade-in":"",'" style="animation:fadeIn .3s; overflow-x: auto; max-height: calc(100% - 50px);">'),"table"===displayTypeB?html+=self.renderDiffTable(compareDataB,compareDataA):"chart"===displayTypeB?html+='<div class="chart-container" style="min-height:260px;" tabindex="0" aria-label="Bar chart for B" role="region"><canvas id="compareChartB"></canvas></div>':"graph"===displayTypeB&&(html+='<div class="chart-container" style="min-height:260px;" tabindex="0" aria-label="Line graph for B" role="region"><canvas id="compareGraphB"></canvas></div>'),html+="</div>"):html+='<div class="text-muted small text-center" style="min-height:200px;">No snapshot selected for B</div>',html+="</div>",html}()),"chart"===displayTypeA&&Array.isArray(compareDataA)&&compareDataA.length>0){const ctxA=document.getElementById("compareChartA");if(ctxA){const headers=Object.keys(compareDataA[0]);let labelKey=headers.find((h=>"string"==typeof compareDataA[0][h]))||headers[0],valueKey=headers.find((h=>"number"==typeof compareDataA[0][h]))||headers[1];const labels=compareDataA.map((r=>r[labelKey])),values=compareDataA.map((r=>r[valueKey]));window.compareChartAInstance&&window.compareChartAInstance.destroy(),window.compareChartAInstance=new Chart(ctxA.getContext("2d"),{type:"bar",data:{labels:labels,datasets:[{label:valueKey,data:values,backgroundColor:"rgba(0,123,255,0.5)",borderColor:"rgba(0,123,255,1)",borderWidth:1}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1}}}})}}if("graph"===displayTypeA&&Array.isArray(compareDataA)&&compareDataA.length>0){const ctxA=document.getElementById("compareGraphA");if(ctxA){const headers=Object.keys(compareDataA[0]);let labelKey=headers.find((h=>"string"==typeof compareDataA[0][h]))||headers[0],valueKey=headers.find((h=>"number"==typeof compareDataA[0][h]))||headers[1];const labels=compareDataA.map(((r,i)=>r[labelKey]||i+1)),values=compareDataA.map((r=>r[valueKey]));window.compareGraphAInstance&&window.compareGraphAInstance.destroy(),window.compareGraphAInstance=new Chart(ctxA.getContext("2d"),{type:"line",data:{labels:labels,datasets:[{label:valueKey,data:values,backgroundColor:"rgba(40,167,69,0.5)",borderColor:"rgba(40,167,69,1)",borderWidth:2,fill:!1}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1}}}})}}if("chart"===displayTypeB&&Array.isArray(compareDataB)&&compareDataB.length>0){const ctxB=document.getElementById("compareChartB");if(ctxB){const headers=Object.keys(compareDataB[0]);let labelKey=headers.find((h=>"string"==typeof compareDataB[0][h]))||headers[0],valueKey=headers.find((h=>"number"==typeof compareDataB[0][h]))||headers[1];const labels=compareDataB.map((r=>r[labelKey])),values=compareDataB.map((r=>r[valueKey]));window.compareChartBInstance&&window.compareChartBInstance.destroy(),window.compareChartBInstance=new Chart(ctxB.getContext("2d"),{type:"bar",data:{labels:labels,datasets:[{label:valueKey,data:values,backgroundColor:"rgba(0,123,255,0.5)",borderColor:"rgba(0,123,255,1)",borderWidth:1}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1}}}})}}if("graph"===displayTypeB&&Array.isArray(compareDataB)&&compareDataB.length>0){const ctxB=document.getElementById("compareGraphB");if(ctxB){const headers=Object.keys(compareDataB[0]);let labelKey=headers.find((h=>"string"==typeof compareDataB[0][h]))||headers[0],valueKey=headers.find((h=>"number"==typeof compareDataB[0][h]))||headers[1];const labels=compareDataB.map(((r,i)=>r[labelKey]||i+1)),values=compareDataB.map((r=>r[valueKey]));window.compareGraphBInstance&&window.compareGraphBInstance.destroy(),window.compareGraphBInstance=new Chart(ctxB.getContext("2d"),{type:"line",data:{labels:labels,datasets:[{label:valueKey,data:values,backgroundColor:"rgba(40,167,69,0.5)",borderColor:"rgba(40,167,69,1)",borderWidth:2,fill:!1}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1}}}})}}}function renderModal(){Swal.update({html:"<div class='d-flex flex-row' style='height:70vh;min-height:500px;max-height:80vh;'>\n                        <div id='timeline-sidebar-modal'></div>\n                        <div class='flex-fill px-3' style='overflow:auto;max-width:calc(100% - 220px);'>\n                            <div class='d-flex flex-row gap-3 w-100 h-100'>\n                                <div class='flex-fill' id='compare-section-a'></div>\n                                <div class='flex-fill' id='compare-section-b'></div>\n                            </div>\n                        </div>\n                    </div>"}),$("#timeline-sidebar-modal").html(function(selectedAId,selectedBId){console.log("[DEBUG] renderTimeline called. Timeline:",timeline);let html='<div class="timeline-sidebar" style="width:220px;max-width:220px;overflow-y:auto;height:100%;background:#f8f9fa;border-right:1.5px solid #e0e0e0;padding:0.5rem 0.25rem;">';return html+='<div class="d-flex flex-column gap-2 mb-3">',html+='<button class="btn btn-outline-primary btn-sm w-100 mb-1 fetch-current-btn" title="Fetch current data from database" aria-label="Fetch current data"><i class="fa fa-sync"></i> Fetch Current Data</button>',currentDataFetched&&"current"===selectedA&&(html+='<div class="mb-2">\n                        <input type="text" id="add-timeline-note" class="form-control form-control-sm mb-1" placeholder="Enter snapshot name (required)" required aria-label="Snapshot name">\n                        <div class="invalid-feedback" style="display:none;">Snapshot name is required.</div>\n                        <button class="btn btn-outline-success btn-sm w-100 add-timeline-btn" id="add-timeline-btn" title="Create snapshot from current data" aria-label="Create snapshot from current data" disabled><span class="btn-label"><i class="fa fa-plus"></i> Create Snapshot From Current Data</span><span class="spinner-border spinner-border-sm ms-2" id="snapshot-loading" style="display:none;" role="status" aria-hidden="true"></span></button>\n                    </div>'),html+='<div class="small text-muted text-center px-2 py-1 mb-2" style="border: 1px dashed #dee2e6; border-radius: 4px;">Click or <b>drag</b> snapshots to select for comparison. Each snapshot gets a unique color. You can also drag and drop from the side menu into the snapshot viewer.</div>',html+="</div>",html+='<div class="timeline-list">',0===timeline.length?html+=error?'<div class="text-danger small text-center py-2">Error: '.concat(error,"</div>"):'<div class="text-muted small text-center py-2">No timeline snapshots yet. [DEBUG: Timeline is empty]</div>':timeline.forEach(((snap,index)=>{const colors=[{bg:"#e3f2fd",border:"#2196f3",text:"#1976d2"},{bg:"#f3e5f5",border:"#9c27b0",text:"#7b1fa2"},{bg:"#e8f5e8",border:"#4caf50",text:"#388e3c"},{bg:"#fff3e0",border:"#ff9800",text:"#f57c00"},{bg:"#fce4ec",border:"#e91e63",text:"#c2185b"},{bg:"#e0f2f1",border:"#009688",text:"#00695c"},{bg:"#f1f8e9",border:"#8bc34a",text:"#689f38"},{bg:"#fff8e1",border:"#ffc107",text:"#ffa000"}],color=colors[index%colors.length],isSelected=selectedAId===snap.id||selectedBId===snap.id,selectedStyle=isSelected?"background-color: ".concat(color.bg,"; border-color: ").concat(color.border,"; border-width: 2px;"):"background-color: #fff; border-color: #dee2e6; border-width: 1px;",isCurrent=snap.is_current_version?'<span class="badge bg-primary ms-1">Current</span>':"",dragDisabled=isSelected?'draggable="false"':'draggable="true"',dragTitle=isSelected?"This snapshot is currently selected":"Drag to assign to Snapshot A or B",dragText=isSelected?'<span class="text-muted small">(Selected)</span>':"";html+='<div class="timeline-item p-2 mb-1 rounded border '.concat(isSelected?"drag-disabled":"draggable-snapshot",'" \n                                      style="cursor:pointer; animation:fadeIn .3s; ').concat(selectedStyle,'" \n                                      data-snap-id="').concat(snap.id,'" \n                                      data-color-bg="').concat(color.bg,'" \n                                      data-color-border="').concat(color.border,'" \n                                      data-color-text="').concat(color.text,'"\n                                      tabindex="0" \n                                      aria-label="Snapshot from ').concat(self.formatTimestamp(snap.created_at)).concat(snap.is_current_version?" (current)":"",'"\n                                      ').concat(dragDisabled,'\n                                      title="').concat(dragTitle,'"\n                                      >\n                            <div class="d-flex justify-content-between align-items-center">\n                                <span class="fw-bold small">').concat(self.formatTimestamp(snap.created_at),"</span>\n                                ").concat(isCurrent,'\n                            </div>\n                            <div class="small text-muted">').concat(snap.note?snap.note:""," ").concat(dragText,'</div>\n                            <div class="d-flex gap-1 mt-1">\n                                <button class="btn btn-outline-secondary btn-xs btn-sm set-current-btn" data-snap-id="').concat(snap.id,'" title="Set as current version" aria-label="Set as current"><i class="fa fa-check"></i></button>\n                            </div>\n                        </div>')})),html+="</div></div>",html}(selectedA,selectedB)),renderSections(),$(".fetch-current-btn").off("click").on("click",(function(){var section,cb;"a"===(section=nextSection)&&(loadingA=!0),"b"===section&&(loadingB=!0),renderSections(),self.ajaxWithAuth({url:"https://ai-backend.stagingwithswift.com/api/reports/".concat(reportSlug,"/data/current"),method:"GET",success:function(res){currentData=res.data||[],"a"===section?(compareDataA=currentData,selectedA="current",loadingA=!1):(compareDataB=currentData,selectedB="current",loadingB=!1),currentDataFetched=!0,renderSections(),cb&&cb()},error:function(){error="Failed to fetch current data.","a"===section&&(loadingA=!1),"b"===section&&(loadingB=!1),renderSections(),cb&&cb()}})})),$(".timeline-item").off("click").on("click",(function(e){const snapId=$(this).data("snap-id");"a"===nextSection?fetchSnapshotData(snapId,"a",(()=>{nextSection="b"})):fetchSnapshotData(snapId,"b",(()=>{nextSection="a"}))})),$(".display-type-switcher-a .btn-icon").off("click").on("click",(function(){displayTypeA=$(this).data("type"),renderSections()})),$(".display-type-switcher-b .btn-icon").off("click").on("click",(function(){displayTypeB=$(this).data("type"),renderSections()})),$(".draggable-snapshot").attr("draggable",!0).off("dragstart").on("dragstart",(function(e){e.originalEvent.dataTransfer.setData("text/plain",$(this).data("snap-id")),$(this).addClass("dragging")})),$(".draggable-snapshot").off("dragend").on("dragend",(function(e){$(this).removeClass("dragging")})),$(".compare-section").off("dragover").on("dragover",(function(e){e.preventDefault(),$(this).addClass("drag-over-section")})),$(".compare-section").off("dragleave").on("dragleave",(function(e){$(this).removeClass("drag-over-section")})),$(".compare-section").off("drop").on("drop",(function(e){e.preventDefault(),$(this).removeClass("drag-over-section");const snapId=e.originalEvent.dataTransfer.getData("text/plain"),target=$(this).data("drop-target");fetchSnapshotData(snapId,target,(()=>{nextSection="a"===target?"b":"a"}))})),0===$("#compare-section-highlight-style").length&&$("head").append('<style id="compare-section-highlight-style">.drag-over-section { box-shadow: 0 0 0 4px #90caf9 !important; border-color: #1976d2 !important; }</style>')}Swal.fire({title:"<span class='fw-bold'>Compare Report Data</span>",html:"<div class='d-flex flex-row' style='height:60vh;min-height:400px;max-height:70vh;'>\n                    <div id='timeline-sidebar-modal'></div>\n                    <div class='flex-fill px-3' style='overflow:auto;max-width:calc(100% - 220px);'>\n                        <div class='d-flex flex-row gap-3 w-100 h-100'>\n                            <div class='flex-fill' id='compare-section-a'></div>\n                            <div class='flex-fill' id='compare-section-b'></div>\n                        </div>\n                    </div>\n                </div>",width:"90vw",heightAuto:!1,showCancelButton:!0,showConfirmButton:!1,customClass:{popup:"swal2-modal-compare-data"},didOpen:()=>{var cb;cb=()=>{var _timeline$find,aId,bId,cb;timeline.length>0?(selectedA=(null===(_timeline$find=timeline.find((s=>s.is_current_version)))||void 0===_timeline$find?void 0:_timeline$find.id)||timeline[0].id,selectedB=timeline.length>1?timeline[1].id:null,selectedA&&selectedB?(aId=selectedA,bId=selectedB,cb=()=>{nextSection="a",renderModal()},loadingA=!0,loadingB=!0,renderSections(),self.ajaxWithAuth({url:"https://ai-backend.stagingwithswift.com/api/reports/".concat(reportSlug,"/snapshots/").concat(aId,"/compare/").concat(bId),method:"GET",success:function(res){compareDataA=res.a.data,compareDataB=res.b.data,loadingA=!1,loadingB=!1,renderSections(),cb&&cb(res)},error:function(){error="Failed to compare snapshots.",loadingA=!1,loadingB=!1,renderSections(),cb&&cb()}})):selectedA?fetchSnapshotData(selectedA,"a",(()=>{nextSection="b",renderModal()})):renderModal()):renderModal()},self.ajaxWithAuth({url:"https://ai-backend.stagingwithswift.com/api/reports/".concat(reportSlug,"/snapshots"),method:"GET",success:function(res){timeline=res.snapshots||[],currentSnapshotId=(timeline.find((s=>s.is_current_version))||{}).id||null,console.log("[DEBUG] Timeline fetched:",timeline),cb&&cb()},error:function(){error="Failed to load timeline.",console.error("[DEBUG] Timeline fetch error:",error),cb&&cb()}})}})},renderDiffTable:function(a,b){if(!Array.isArray(a)||0===a.length)return'<div class="text-muted small">No data</div>';const headers=Object.keys(a[0]);let html='<div class="table-responsive"><table class="table table-striped table-hover table-sm">';return html+="<thead><tr>",headers.forEach((h=>{html+="<th>".concat(h,"</th>")})),html+="</tr></thead><tbody>",a.forEach(((row,i)=>{html+="<tr>",headers.forEach((h=>{let diff=!1;b&&Array.isArray(b)&&b[i]&&b[i][h]!==row[h]&&(diff=!0),html+="<td".concat(diff?' style="background:#ffe5e5;"':"",">").concat(null!=row[h]?row[h]:"","</td>")})),html+="</tr>"})),html+="</tbody></table></div>",html}};return window.assistant=assistant,assistant}));

//# sourceMappingURL=assistant.min.js.map