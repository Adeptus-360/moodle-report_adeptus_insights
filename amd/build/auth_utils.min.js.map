{"version":3,"file":"auth_utils.min.js","sources":["../src/auth_utils.js"],"sourcesContent":["// jshint ignore:start\ndefine(['jquery', 'core/ajax', 'core/notification'], function($, Ajax, Notification) {\n    'use strict';\n\n    /**\n     * Authentication utilities for Adeptus Insights plugin\n     */\n    var AuthUtils = {\n        \n        /**\n         * Initialize authentication from Moodle data\n         */\n        initializeFromMoodle: function(authData) {\n            if (!authData) {\n                return;\n            }\n            \n            // Transform subscription data to ensure consistent field names\n            if (authData.subscription) {\n                // Map ai_credits fields to total_credits fields for display compatibility\n                if (authData.subscription.ai_credits_used_this_month !== undefined) {\n                    authData.subscription.total_credits_used_this_month = authData.subscription.ai_credits_used_this_month;\n                }\n                if (authData.subscription.plan_ai_credits_limit !== undefined) {\n                    authData.subscription.plan_total_credits_limit = authData.subscription.plan_ai_credits_limit;\n                }\n                \n                // Also map from plan object if available\n                if (authData.plan && authData.plan.ai_credits) {\n                    authData.subscription.plan_total_credits_limit = authData.plan.ai_credits;\n                }\n            }\n            \n            // Store auth data globally\n            window.adeptusAuthData = authData;\n            \n            // Initialize read-only mode if needed\n            this.checkReadOnlyMode(authData);\n            \n            // Initialize other auth-dependent features\n            this.initializeAuthFeatures(authData);\n        },\n        \n        /**\n         * Check if read-only mode should be enabled\n         */\n        checkReadOnlyMode: function(authData) {\n            var shouldEnableReadOnly = !authData ||\n                                     !authData.user_authorized ||\n                                     !authData.has_api_key ||\n                                     (authData.auth_errors && authData.auth_errors > 0);\n\n            if (shouldEnableReadOnly) {\n                // Trigger read-only mode initialization\n                $(document).trigger('adeptus:enableReadOnly');\n            }\n        },\n        \n        /**\n         * Initialize authentication-dependent features\n         */\n        initializeAuthFeatures: function(authData) {\n            if (authData && authData.user_authorized && authData.has_api_key) {\n                // Enable interactive features\n                $(document).trigger('adeptus:enableInteractiveFeatures');\n                \n                // Initialize AI Assistant if available\n                if (typeof window.AdeptusAI !== 'undefined') {\n                    window.AdeptusAI.init();\n                }\n            }\n        },\n        \n        /**\n         * Check if user is authenticated\n         */\n        isAuthenticated: function() {\n            return window.adeptusAuthData && \n                   window.adeptusAuthData.user_authorized && \n                   window.adeptusAuthData.has_api_key;\n        },\n        \n        /**\n         * Get authentication data\n         */\n        getAuthData: function() {\n            return window.adeptusAuthData || null;\n        },\n\n        /**\n         * Get authentication status (alias for getAuthData for compatibility)\n         */\n        getAuthStatus: function() {\n            return window.adeptusAuthData || null;\n        },\n\n        /**\n         * Get authentication headers for API requests\n         */\n        getAuthHeaders: function() {\n            const authData = this.getAuthData();\n            if (authData && authData.api_key) {\n                return {\n                    'Authorization': 'Bearer ' + authData.api_key,\n                    'X-API-Key': authData.api_key\n                };\n            }\n            return {};\n        },\n\n        /**\n         * Set/update authentication status with field name mapping\n         */\n        setAuthStatus: function(authData) {\n            if (!authData) {\n                return;\n            }\n            \n            // Transform subscription data to ensure consistent field names\n            if (authData.subscription) {\n                // Map ai_credits fields to total_credits fields for display compatibility\n                if (authData.subscription.ai_credits_used_this_month !== undefined) {\n                    authData.subscription.total_credits_used_this_month = authData.subscription.ai_credits_used_this_month;\n                }\n                if (authData.subscription.plan_ai_credits_limit !== undefined) {\n                    authData.subscription.plan_total_credits_limit = authData.subscription.plan_ai_credits_limit;\n                }\n                \n                // Also map from plan object if available\n                if (authData.plan && authData.plan.ai_credits) {\n                    authData.subscription.plan_total_credits_limit = authData.plan.ai_credits;\n                }\n            }\n            \n            window.adeptusAuthData = authData;\n        },\n\n        /**\n         * Clear authentication data\n         */\n        clearAuthData: function() {\n            window.adeptusAuthData = null;\n        },\n        \n        /**\n         * Show authentication error\n         */\n        showAuthError: function(message) {\n            if (Notification) {\n                Notification.addNotification({\n                    message: message || 'Authentication required',\n                    type: 'error'\n                });\n            } else {\n                alert(message || 'Authentication required');\n            }\n        },\n        \n        /**\n         * Refresh authentication status\n         * Note: Auth data is now provided directly from PHP, so this function is no longer needed\n         * Keeping for backward compatibility but making it a no-op\n         */\n        refreshAuthStatus: function() {\n            // Auth data is provided directly from PHP via initializeFromMoodle\n            // No need to make additional AJAX calls\n        }\n    };\n\n    return AuthUtils;\n});\n"],"names":["define","$","Ajax","Notification","initializeFromMoodle","authData","subscription","undefined","ai_credits_used_this_month","total_credits_used_this_month","plan_ai_credits_limit","plan_total_credits_limit","plan","ai_credits","window","adeptusAuthData","checkReadOnlyMode","initializeAuthFeatures","user_authorized","has_api_key","auth_errors","document","trigger","AdeptusAI","init","isAuthenticated","getAuthData","getAuthStatus","getAuthHeaders","this","api_key","setAuthStatus","clearAuthData","showAuthError","message","addNotification","type","alert","refreshAuthStatus"],"mappings":"AACAA,4CAAO,CAAC,SAAU,YAAa,sBAAsB,SAASC,EAAGC,KAAMC,oBAMnD,CAKZC,qBAAsB,SAASC,UACtBA,WAKDA,SAASC,oBAEgDC,IAArDF,SAASC,aAAaE,6BACtBH,SAASC,aAAaG,8BAAgCJ,SAASC,aAAaE,iCAE5BD,IAAhDF,SAASC,aAAaI,wBACtBL,SAASC,aAAaK,yBAA2BN,SAASC,aAAaI,uBAIvEL,SAASO,MAAQP,SAASO,KAAKC,aAC/BR,SAASC,aAAaK,yBAA2BN,SAASO,KAAKC,aAKvEC,OAAOC,gBAAkBV,cAGpBW,kBAAkBX,eAGlBY,uBAAuBZ,YAMhCW,kBAAmB,SAASX,YACIA,WACFA,SAASa,kBACTb,SAASc,aACTd,SAASe,aAAef,SAASe,YAAc,IAIrEnB,EAAEoB,UAAUC,QAAQ,2BAO5BL,uBAAwB,SAASZ,UACzBA,UAAYA,SAASa,iBAAmBb,SAASc,cAEjDlB,EAAEoB,UAAUC,QAAQ,0CAGY,IAArBR,OAAOS,WACdT,OAAOS,UAAUC,SAQ7BC,gBAAiB,kBACNX,OAAOC,iBACPD,OAAOC,gBAAgBG,iBACvBJ,OAAOC,gBAAgBI,aAMlCO,YAAa,kBACFZ,OAAOC,iBAAmB,MAMrCY,cAAe,kBACJb,OAAOC,iBAAmB,MAMrCa,eAAgB,iBACNvB,SAAWwB,KAAKH,qBAClBrB,UAAYA,SAASyB,QACd,eACc,UAAYzB,SAASyB,oBACzBzB,SAASyB,SAGvB,IAMXC,cAAe,SAAS1B,UACfA,WAKDA,SAASC,oBAEgDC,IAArDF,SAASC,aAAaE,6BACtBH,SAASC,aAAaG,8BAAgCJ,SAASC,aAAaE,iCAE5BD,IAAhDF,SAASC,aAAaI,wBACtBL,SAASC,aAAaK,yBAA2BN,SAASC,aAAaI,uBAIvEL,SAASO,MAAQP,SAASO,KAAKC,aAC/BR,SAASC,aAAaK,yBAA2BN,SAASO,KAAKC,aAIvEC,OAAOC,gBAAkBV,WAM7B2B,cAAe,WACXlB,OAAOC,gBAAkB,MAM7BkB,cAAe,SAASC,SAChB/B,aACAA,aAAagC,gBAAgB,CACzBD,QAASA,SAAW,0BACpBE,KAAM,UAGVC,MAAMH,SAAW,4BASzBI,kBAAmB"}