{"version":3,"file":"auth_utils.min.js","sources":["../src/auth_utils.js"],"sourcesContent":["// jshint ignore:start\ndefine(['jquery', 'core/ajax', 'core/notification'], function($, Ajax, Notification) {\n    'use strict';\n\n    /**\n     * Authentication utilities for Adeptus Insights plugin\n     */\n    var AuthUtils = {\n        \n        /**\n         * Initialize authentication from Moodle data\n         */\n        initializeFromMoodle: function(authData) {\n            console.log('[Auth Utils] Initializing with data:', authData);\n            \n            if (!authData) {\n                console.warn('[Auth Utils] No moodle auth data provided');\n                return;\n            }\n            \n            // Transform subscription data to ensure consistent field names\n            if (authData.subscription) {\n                // Map ai_credits fields to total_credits fields for display compatibility\n                if (authData.subscription.ai_credits_used_this_month !== undefined) {\n                    authData.subscription.total_credits_used_this_month = authData.subscription.ai_credits_used_this_month;\n                }\n                if (authData.subscription.plan_ai_credits_limit !== undefined) {\n                    authData.subscription.plan_total_credits_limit = authData.subscription.plan_ai_credits_limit;\n                }\n                \n                // Also map from plan object if available\n                if (authData.plan && authData.plan.ai_credits) {\n                    authData.subscription.plan_total_credits_limit = authData.plan.ai_credits;\n                }\n            }\n            \n            // Store auth data globally\n            window.adeptusAuthData = authData;\n            \n            // Initialize read-only mode if needed\n            this.checkReadOnlyMode(authData);\n            \n            // Initialize other auth-dependent features\n            this.initializeAuthFeatures(authData);\n        },\n        \n        /**\n         * Check if read-only mode should be enabled\n         */\n        checkReadOnlyMode: function(authData) {\n            console.log('[Auth Utils] Checking read-only mode with auth data:', authData);\n            \n            var shouldEnableReadOnly = !authData || \n                                     !authData.user_authorized || \n                                     !authData.has_api_key || \n                                     (authData.auth_errors && authData.auth_errors > 0);\n            \n            console.log('[Auth Utils] Read-only mode should be enabled:', shouldEnableReadOnly, \n                       '| authData:', !!authData, \n                       '| user_authorized:', authData?.user_authorized, \n                       '| has_api_key:', authData?.has_api_key, \n                       '| auth_errors:', authData?.auth_errors);\n            \n            if (shouldEnableReadOnly) {\n                // Trigger read-only mode initialization\n                $(document).trigger('adeptus:enableReadOnly');\n            }\n        },\n        \n        /**\n         * Initialize authentication-dependent features\n         */\n        initializeAuthFeatures: function(authData) {\n            if (authData && authData.user_authorized && authData.has_api_key) {\n                // Enable interactive features\n                $(document).trigger('adeptus:enableInteractiveFeatures');\n                \n                // Initialize AI Assistant if available\n                if (typeof window.AdeptusAI !== 'undefined') {\n                    window.AdeptusAI.init();\n                }\n            }\n        },\n        \n        /**\n         * Check if user is authenticated\n         */\n        isAuthenticated: function() {\n            return window.adeptusAuthData && \n                   window.adeptusAuthData.user_authorized && \n                   window.adeptusAuthData.has_api_key;\n        },\n        \n        /**\n         * Get authentication data\n         */\n        getAuthData: function() {\n            return window.adeptusAuthData || null;\n        },\n\n        /**\n         * Get authentication status (alias for getAuthData for compatibility)\n         */\n        getAuthStatus: function() {\n            return window.adeptusAuthData || null;\n        },\n\n        /**\n         * Get authentication headers for API requests\n         */\n        getAuthHeaders: function() {\n            const authData = this.getAuthData();\n            if (authData && authData.api_key) {\n                return {\n                    'Authorization': 'Bearer ' + authData.api_key,\n                    'X-API-Key': authData.api_key\n                };\n            }\n            return {};\n        },\n\n        /**\n         * Set/update authentication status with field name mapping\n         */\n        setAuthStatus: function(authData) {\n            if (!authData) {\n                console.warn('[Auth Utils] Attempting to set null auth data');\n                return;\n            }\n            \n            // Transform subscription data to ensure consistent field names\n            if (authData.subscription) {\n                // Map ai_credits fields to total_credits fields for display compatibility\n                if (authData.subscription.ai_credits_used_this_month !== undefined) {\n                    authData.subscription.total_credits_used_this_month = authData.subscription.ai_credits_used_this_month;\n                }\n                if (authData.subscription.plan_ai_credits_limit !== undefined) {\n                    authData.subscription.plan_total_credits_limit = authData.subscription.plan_ai_credits_limit;\n                }\n                \n                // Also map from plan object if available\n                if (authData.plan && authData.plan.ai_credits) {\n                    authData.subscription.plan_total_credits_limit = authData.plan.ai_credits;\n                }\n            }\n            \n            window.adeptusAuthData = authData;\n            console.log('[Auth Utils] Authentication status updated with mapped fields');\n        },\n\n        /**\n         * Clear authentication data\n         */\n        clearAuthData: function() {\n            window.adeptusAuthData = null;\n            console.log('[Auth Utils] Authentication data cleared');\n        },\n        \n        /**\n         * Show authentication error\n         */\n        showAuthError: function(message) {\n            if (Notification) {\n                Notification.addNotification({\n                    message: message || 'Authentication required',\n                    type: 'error'\n                });\n            } else {\n                alert(message || 'Authentication required');\n            }\n        },\n        \n        /**\n         * Refresh authentication status\n         * Note: Auth data is now provided directly from PHP, so this function is no longer needed\n         * Keeping for backward compatibility but making it a no-op\n         */\n        refreshAuthStatus: function() {\n            console.log('[Auth Utils] refreshAuthStatus called - auth data is now provided directly from PHP');\n            // Auth data is provided directly from PHP via initializeFromMoodle\n            // No need to make additional AJAX calls\n        }\n    };\n\n    return AuthUtils;\n});\n"],"names":["define","$","Ajax","Notification","initializeFromMoodle","authData","console","log","subscription","undefined","ai_credits_used_this_month","total_credits_used_this_month","plan_ai_credits_limit","plan_total_credits_limit","plan","ai_credits","window","adeptusAuthData","checkReadOnlyMode","initializeAuthFeatures","warn","shouldEnableReadOnly","user_authorized","has_api_key","auth_errors","document","trigger","AdeptusAI","init","isAuthenticated","getAuthData","getAuthStatus","getAuthHeaders","this","api_key","setAuthStatus","clearAuthData","showAuthError","message","addNotification","type","alert","refreshAuthStatus"],"mappings":"AACAA,4CAAO,CAAC,SAAU,YAAa,sBAAsB,SAASC,EAAGC,KAAMC,oBAMnD,CAKZC,qBAAsB,SAASC,UAC3BC,QAAQC,IAAI,uCAAwCF,UAE/CA,UAMDA,SAASG,oBAEgDC,IAArDJ,SAASG,aAAaE,6BACtBL,SAASG,aAAaG,8BAAgCN,SAASG,aAAaE,iCAE5BD,IAAhDJ,SAASG,aAAaI,wBACtBP,SAASG,aAAaK,yBAA2BR,SAASG,aAAaI,uBAIvEP,SAASS,MAAQT,SAASS,KAAKC,aAC/BV,SAASG,aAAaK,yBAA2BR,SAASS,KAAKC,aAKvEC,OAAOC,gBAAkBZ,cAGpBa,kBAAkBb,eAGlBc,uBAAuBd,WA3BxBC,QAAQc,KAAK,8CAiCrBF,kBAAmB,SAASb,UACxBC,QAAQC,IAAI,uDAAwDF,cAEhEgB,sBAAwBhB,WACFA,SAASiB,kBACTjB,SAASkB,aACTlB,SAASmB,aAAenB,SAASmB,YAAc,EAEzElB,QAAQC,IAAI,iDAAkDc,qBACnD,gBAAiBhB,SACjB,qBAAsBA,MAAAA,gBAAAA,SAAUiB,gBAChC,iBAAkBjB,MAAAA,gBAAAA,SAAUkB,YAC5B,iBAAkBlB,MAAAA,gBAAAA,SAAUmB,aAEnCH,sBAEApB,EAAEwB,UAAUC,QAAQ,2BAO5BP,uBAAwB,SAASd,UACzBA,UAAYA,SAASiB,iBAAmBjB,SAASkB,cAEjDtB,EAAEwB,UAAUC,QAAQ,0CAGY,IAArBV,OAAOW,WACdX,OAAOW,UAAUC,SAQ7BC,gBAAiB,kBACNb,OAAOC,iBACPD,OAAOC,gBAAgBK,iBACvBN,OAAOC,gBAAgBM,aAMlCO,YAAa,kBACFd,OAAOC,iBAAmB,MAMrCc,cAAe,kBACJf,OAAOC,iBAAmB,MAMrCe,eAAgB,iBACN3B,SAAW4B,KAAKH,qBAClBzB,UAAYA,SAAS6B,QACd,eACc,UAAY7B,SAAS6B,oBACzB7B,SAAS6B,SAGvB,IAMXC,cAAe,SAAS9B,UACfA,UAMDA,SAASG,oBAEgDC,IAArDJ,SAASG,aAAaE,6BACtBL,SAASG,aAAaG,8BAAgCN,SAASG,aAAaE,iCAE5BD,IAAhDJ,SAASG,aAAaI,wBACtBP,SAASG,aAAaK,yBAA2BR,SAASG,aAAaI,uBAIvEP,SAASS,MAAQT,SAASS,KAAKC,aAC/BV,SAASG,aAAaK,yBAA2BR,SAASS,KAAKC,aAIvEC,OAAOC,gBAAkBZ,SACzBC,QAAQC,IAAI,kEArBRD,QAAQc,KAAK,kDA2BrBgB,cAAe,WACXpB,OAAOC,gBAAkB,KACzBX,QAAQC,IAAI,6CAMhB8B,cAAe,SAASC,SAChBnC,aACAA,aAAaoC,gBAAgB,CACzBD,QAASA,SAAW,0BACpBE,KAAM,UAGVC,MAAMH,SAAW,4BASzBI,kBAAmB,WACfpC,QAAQC,IAAI"}