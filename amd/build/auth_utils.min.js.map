{"version":3,"file":"auth_utils.min.js","sources":["../src/auth_utils.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Authentication utilities for Adeptus Insights plugin.\n *\n * Provides helper functions for managing authentication state, checking\n * authorization status, and handling read-only mode based on auth status.\n *\n * @module     report_adeptus_insights/auth_utils\n * @copyright  2026 Adeptus 360 <info@adeptus360.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\ndefine(['jquery', 'core/ajax', 'core/notification'], function($, Ajax, Notification) {\n    'use strict';\n\n    /**\n     * Authentication utilities for Adeptus Insights plugin\n     */\n    var AuthUtils = {\n\n        /**\n         * Initialize authentication from Moodle data.\n         *\n         * @param {Object} authData - Authentication data from Moodle\n         */\n        initializeFromMoodle: function(authData) {\n            if (!authData) {\n                return;\n            }\n\n            // Transform subscription data to ensure consistent field names.\n            if (authData.subscription) {\n                // Map ai_credits fields to total_credits fields for display compatibility.\n                if (authData.subscription.ai_credits_used_this_month !== undefined) {\n                    authData.subscription.total_credits_used_this_month = authData.subscription.ai_credits_used_this_month;\n                }\n                if (authData.subscription.plan_ai_credits_limit !== undefined) {\n                    authData.subscription.plan_total_credits_limit = authData.subscription.plan_ai_credits_limit;\n                }\n\n                // Also map from plan object if available.\n                if (authData.plan && authData.plan.ai_credits) {\n                    authData.subscription.plan_total_credits_limit = authData.plan.ai_credits;\n                }\n            }\n\n            // Store auth data globally.\n            window.adeptusAuthData = authData;\n\n            // Initialize read-only mode if needed.\n            this.checkReadOnlyMode(authData);\n\n            // Initialize other auth-dependent features.\n            this.initializeAuthFeatures(authData);\n        },\n\n        /**\n         * Check if read-only mode should be enabled.\n         *\n         * @param {Object} authData - Authentication data to check\n         */\n        checkReadOnlyMode: function(authData) {\n            var shouldEnableReadOnly = !authData ||\n                                     !authData.user_authorized ||\n                                     !authData.has_api_key ||\n                                     (authData.auth_errors && authData.auth_errors > 0);\n\n            if (shouldEnableReadOnly) {\n                // Trigger read-only mode initialization.\n                $(document).trigger('adeptus:enableReadOnly');\n            }\n        },\n\n        /**\n         * Initialize authentication-dependent features.\n         *\n         * @param {Object} authData - Authentication data\n         */\n        initializeAuthFeatures: function(authData) {\n            if (authData && authData.user_authorized && authData.has_api_key) {\n                // Enable interactive features.\n                $(document).trigger('adeptus:enableInteractiveFeatures');\n\n                // Initialize AI Assistant if available.\n                if (typeof window.AdeptusAI !== 'undefined') {\n                    window.AdeptusAI.init();\n                }\n            }\n        },\n\n        /**\n         * Check if user is authenticated.\n         *\n         * @returns {boolean} True if user is authenticated\n         */\n        isAuthenticated: function() {\n            return window.adeptusAuthData &&\n                   window.adeptusAuthData.user_authorized &&\n                   window.adeptusAuthData.has_api_key;\n        },\n\n        /**\n         * Get authentication data.\n         *\n         * @returns {Object|null} Authentication data or null\n         */\n        getAuthData: function() {\n            return window.adeptusAuthData || null;\n        },\n\n        /**\n         * Get authentication status (alias for getAuthData for compatibility).\n         *\n         * @returns {Object|null} Authentication data or null\n         */\n        getAuthStatus: function() {\n            return window.adeptusAuthData || null;\n        },\n\n        /**\n         * Get authentication headers for API requests.\n         *\n         * @returns {Object} Headers object with authorization\n         */\n        getAuthHeaders: function() {\n            var authData = this.getAuthData();\n            if (authData && authData.api_key) {\n                return {\n                    'Authorization': 'Bearer ' + authData.api_key,\n                    'X-API-Key': authData.api_key\n                };\n            }\n            return {};\n        },\n\n        /**\n         * Set/update authentication status with field name mapping.\n         *\n         * @param {Object} authData - Authentication data to set\n         */\n        setAuthStatus: function(authData) {\n            if (!authData) {\n                return;\n            }\n\n            // Transform subscription data to ensure consistent field names.\n            if (authData.subscription) {\n                // Map ai_credits fields to total_credits fields for display compatibility.\n                if (authData.subscription.ai_credits_used_this_month !== undefined) {\n                    authData.subscription.total_credits_used_this_month = authData.subscription.ai_credits_used_this_month;\n                }\n                if (authData.subscription.plan_ai_credits_limit !== undefined) {\n                    authData.subscription.plan_total_credits_limit = authData.subscription.plan_ai_credits_limit;\n                }\n\n                // Also map from plan object if available.\n                if (authData.plan && authData.plan.ai_credits) {\n                    authData.subscription.plan_total_credits_limit = authData.plan.ai_credits;\n                }\n            }\n\n            window.adeptusAuthData = authData;\n        },\n\n        /**\n         * Clear authentication data.\n         */\n        clearAuthData: function() {\n            window.adeptusAuthData = null;\n        },\n\n        /**\n         * Show authentication error.\n         *\n         * @param {string} message - Error message to display\n         */\n        showAuthError: function(message) {\n            var errorMsg = message || 'Authentication required';\n            if (Notification) {\n                Notification.addNotification({\n                    message: errorMsg,\n                    type: 'error'\n                });\n            } else {\n                // Fallback for when Notification is not available.\n                Notification.alert('Authentication Error', errorMsg);\n            }\n        },\n\n        /**\n         * Refresh authentication status.\n         * Note: Auth data is now provided directly from PHP, so this function is no longer needed.\n         * Keeping for backward compatibility but making it a no-op.\n         */\n        refreshAuthStatus: function() {\n            // Auth data is provided directly from PHP via initializeFromMoodle.\n            // No need to make additional AJAX calls.\n        }\n    };\n\n    return AuthUtils;\n});\n"],"names":["define","$","Ajax","Notification","initializeFromMoodle","authData","subscription","undefined","ai_credits_used_this_month","total_credits_used_this_month","plan_ai_credits_limit","plan_total_credits_limit","plan","ai_credits","window","adeptusAuthData","checkReadOnlyMode","initializeAuthFeatures","user_authorized","has_api_key","auth_errors","document","trigger","AdeptusAI","init","isAuthenticated","getAuthData","getAuthStatus","getAuthHeaders","this","api_key","setAuthStatus","clearAuthData","showAuthError","message","errorMsg","addNotification","type","alert","refreshAuthStatus"],"mappings":";;;;;;;;;;AA0BAA,4CAAO,CAAC,SAAU,YAAa,sBAAsB,SAASC,EAAGC,KAAMC,oBAMnD,CAOZC,qBAAsB,SAASC,UACtBA,WAKDA,SAASC,oBAEgDC,IAArDF,SAASC,aAAaE,6BACtBH,SAASC,aAAaG,8BAAgCJ,SAASC,aAAaE,iCAE5BD,IAAhDF,SAASC,aAAaI,wBACtBL,SAASC,aAAaK,yBAA2BN,SAASC,aAAaI,uBAIvEL,SAASO,MAAQP,SAASO,KAAKC,aAC/BR,SAASC,aAAaK,yBAA2BN,SAASO,KAAKC,aAKvEC,OAAOC,gBAAkBV,cAGpBW,kBAAkBX,eAGlBY,uBAAuBZ,YAQhCW,kBAAmB,SAASX,YACIA,WACFA,SAASa,kBACTb,SAASc,aACTd,SAASe,aAAef,SAASe,YAAc,IAIrEnB,EAAEoB,UAAUC,QAAQ,2BAS5BL,uBAAwB,SAASZ,UACzBA,UAAYA,SAASa,iBAAmBb,SAASc,cAEjDlB,EAAEoB,UAAUC,QAAQ,0CAGY,IAArBR,OAAOS,WACdT,OAAOS,UAAUC,SAU7BC,gBAAiB,kBACNX,OAAOC,iBACPD,OAAOC,gBAAgBG,iBACvBJ,OAAOC,gBAAgBI,aAQlCO,YAAa,kBACFZ,OAAOC,iBAAmB,MAQrCY,cAAe,kBACJb,OAAOC,iBAAmB,MAQrCa,eAAgB,eACRvB,SAAWwB,KAAKH,qBAChBrB,UAAYA,SAASyB,QACd,eACc,UAAYzB,SAASyB,oBACzBzB,SAASyB,SAGvB,IAQXC,cAAe,SAAS1B,UACfA,WAKDA,SAASC,oBAEgDC,IAArDF,SAASC,aAAaE,6BACtBH,SAASC,aAAaG,8BAAgCJ,SAASC,aAAaE,iCAE5BD,IAAhDF,SAASC,aAAaI,wBACtBL,SAASC,aAAaK,yBAA2BN,SAASC,aAAaI,uBAIvEL,SAASO,MAAQP,SAASO,KAAKC,aAC/BR,SAASC,aAAaK,yBAA2BN,SAASO,KAAKC,aAIvEC,OAAOC,gBAAkBV,WAM7B2B,cAAe,WACXlB,OAAOC,gBAAkB,MAQ7BkB,cAAe,SAASC,aAChBC,SAAWD,SAAW,0BACtB/B,aACAA,aAAaiC,gBAAgB,CACzBF,QAASC,SACTE,KAAM,UAIVlC,aAAamC,MAAM,uBAAwBH,WASnDI,kBAAmB"}