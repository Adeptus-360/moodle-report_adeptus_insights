/**
 * Global authentication handling for Adeptus Insights plugin.
 *
 * Manages global authentication state, login modal display, authentication
 * verification, and UI updates based on authentication status.
 *
 * @module     report_adeptus_insights/global_auth
 * @copyright  2026 Adeptus 360 <info@adeptus360.com>
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("report_adeptus_insights/global_auth",["jquery","core/ajax","core/notification"],(function($,Ajax,Notification){return{init:function(){var self=this;return new Promise((function(resolve,reject){self.isAuthenticated()?resolve():self.checkAuthStatus().then((function(){return resolve(),!0})).catch((function(err){reject(err)}))}))},checkAuthStatus:function(){var self=this;return new Promise((function(resolve,reject){Ajax.call([{methodname:"report_adeptus_insights_get_auth_status",args:{}}])[0].done((function(result){var response=result.data?result.data:result;if(response&&response.success){var authData={is_authenticated:response.is_authenticated,user_email:response.user_email,token_expires_at:response.token_expires_at};if(response.installation_info)try{authData.installation_info=JSON.parse(response.installation_info)}catch(parseError){authData.installation_info={}}self.handleAuthSuccess(authData),resolve()}else self.handleAuthFailure(response.message||"Authentication failed"),reject(new Error(response.message||"Authentication failed"))})).fail((function(){self.handleAuthFailure("Failed to check authentication status"),reject(new Error("Failed to check authentication status"))}))}))},handleAuthSuccess:function(authData){window.adeptusAuthData=authData,this.hideModal(),$(document).trigger("adeptus:enableInteractiveFeatures"),this.updateUIForAuthenticatedUser()},handleAuthFailure:function(){this.showModal(),$(document).trigger("adeptus:enableReadOnly")},showModal:function(){if($("#global-auth-modal").length)$("#global-auth-modal").modal("show");else{var modalHtml=this.createModalHTML();$("body").append(modalHtml),$("#global-auth-modal").modal("show"),this.initModalFunctionality()}},hideModal:function(){var $modal=$("#global-auth-modal");$modal.length&&$modal.hasClass("show")&&$modal.modal("hide"),$(".modal-backdrop").remove(),$("body").removeClass("modal-open")},createModalHTML:function(){return'<div class="modal fade" id="global-auth-modal" tabindex="-1" role="dialog" aria-labelledby="global-auth-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-centered" role="document"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="global-auth-modal-label"><i class="fa fa-lock"></i> Adeptus Insights Authentication</h5><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div><div class="modal-body"><div class="auth-form"><div class="form-group mb-3"><label for="site-url">Site URL</label><input type="text" class="form-control" id="site-url" value="'+window.location.origin+'" disabled></div><div class="form-group mb-3"><label for="admin-email">Admin Email</label><input type="email" class="form-control" id="admin-email" value="admin@example.com" disabled></div><div class="form-group mb-3"><label for="auth-password">Password</label><div class="input-group"><input type="password" class="form-control" id="auth-password" placeholder="Enter your password"><button class="btn btn-outline-secondary" type="button" id="toggle-password"><i class="fa fa-eye"></i></button></div></div></div></div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button><button type="button" class="btn btn-primary" id="auth-submit"><i class="fa fa-sign-in"></i> Authenticate</button></div></div></div></div>'},initModalFunctionality:function(){var self=this;$("#auth-submit").on("click",(function(){self.handleLogin()})),$("#toggle-password").on("click",(function(){self.togglePasswordVisibility()})),$("#auth-password").on("keypress",(function(e){13===e.which&&self.handleLogin()})),this.autoFillSiteInfo(),this.includeCustomCSS()},handleLogin:function(){var self=this,password=$("#auth-password").val();password?($("#auth-submit").prop("disabled",!0).html('<i class="fa fa-spinner fa-spin"></i> Authenticating...'),this.authenticate(password).then((function(){return self.hideModal(),Notification.addNotification({message:"Authentication successful!",type:"success"}),!0})).catch((function(error){Notification.addNotification({message:error.message||"Authentication failed",type:"error"}),$("#auth-submit").prop("disabled",!1).html('<i class="fa fa-sign-in"></i> Authenticate')}))):Notification.addNotification({message:"Please enter your password",type:"error"})},authenticate:function(password){var self=this;return new Promise((function(resolve,reject){$.ajax({url:M.cfg.wwwroot+"/report/adeptus_insights/ajax/authenticate.php",method:"POST",data:{password:password,sesskey:M.cfg.sesskey},dataType:"json",success:function(response){response&&response.success?(self.handleAuthSuccess(response.data),resolve()):reject(new Error(response.message||"Authentication failed"))},error:function(){reject(new Error("Failed to authenticate"))}})}))},togglePasswordVisibility:function(){var $passwordField=$("#auth-password"),$icon=$("#toggle-password").find("i");"password"===$passwordField.attr("type")?($passwordField.attr("type","text"),$icon.removeClass("fa-eye").addClass("fa-eye-slash")):($passwordField.attr("type","password"),$icon.removeClass("fa-eye-slash").addClass("fa-eye"))},autoFillSiteInfo:function(){"undefined"!=typeof M&&M.user&&M.user.email&&$("#admin-email").val(M.user.email)},includeCustomCSS:function(){if(!$("#global-auth-modal-css").length){$("head").append('<style id="global-auth-modal-css">#global-auth-modal .modal-content {border-radius: 15px;border: none;box-shadow: 0 10px 30px rgba(0,0,0,0.2);}#global-auth-modal .modal-header {background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);color: white;border-radius: 15px 15px 0 0;}#global-auth-modal .modal-title i {margin-right: 8px;}#global-auth-modal .form-control:disabled {background-color: #f8f9fa;color: #6c757d;}#global-auth-modal .btn-primary {background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);border: none;border-radius: 25px;padding: 10px 25px;}#global-auth-modal .btn-primary:hover {transform: translateY(-2px);box-shadow: 0 5px 15px rgba(0,0,0,0.2);}#global-auth-modal .input-group-text {background-color: #f8f9fa;border-color: #ced4da;}</style>')}},updateUIForAuthenticatedUser:function(){$(".auth-required").hide(),$(".auth-not-required").show(),window.adeptusAuthData&&window.adeptusAuthData.user_name&&$(".user-name").text(window.adeptusAuthData.user_name)},isAuthenticated:function(){return window.adeptusAuthData&&window.adeptusAuthData.user_authorized&&window.adeptusAuthData.has_api_key},getAuthData:function(){return window.adeptusAuthData||null},logout:function(){window.adeptusAuthData=null,this.showModal(),$(document).trigger("adeptus:enableReadOnly"),this.updateUIForUnauthenticatedUser()},updateUIForUnauthenticatedUser:function(){$(".auth-required").show(),$(".auth-not-required").hide(),$(".user-name").text("Guest")}}}));

//# sourceMappingURL=global_auth.min.js.map