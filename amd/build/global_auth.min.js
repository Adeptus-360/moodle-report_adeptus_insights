define(["jquery","core/ajax","core/notification"],function(e,a,t){"use strict";return{init:function(){return new Promise((a,t)=>{this.isAuthenticated()?a():this.checkAuthStatus().then(()=>{a()}).catch(a=>{console.error("[GlobalAuth] Authentication failed:",a),t(a)})})},checkAuthStatus:function(){return new Promise((t,o)=>{e.ajax({url:M.cfg.wwwroot+"/report/adeptus_insights/ajax/get_auth_status.php",method:"GET",dataType:"json",success:a=>{a&&a.success?(this.handleAuthSuccess(a.data),t()):(this.handleAuthFailure(a.message||"Authentication failed"),o(new Error(a.message||"Authentication failed")))},error:(a,t,e)=>{console.error("[GlobalAuth] Error getting auth status:",e),this.handleAuthFailure("Failed to check authentication status"),o(new Error("Failed to check authentication status"))}})})},handleAuthSuccess:function(a){window.adeptusAuthData=a,this.hideModal(),e(document).trigger("adeptus:enableInteractiveFeatures"),this.updateUIForAuthenticatedUser()},handleAuthFailure:function(a){this.showModal(),e(document).trigger("adeptus:enableReadOnly")},showModal:function(){var a;e("#global-auth-modal").length?e("#global-auth-modal").modal("show"):(a=this.createModalHTML(),e("body").append(a),e("#global-auth-modal").modal("show"),this.initModalFunctionality())},hideModal:function(){e("#global-auth-modal").modal("hide")},createModalHTML:function(){return`
                <div class="modal fade" id="global-auth-modal" tabindex="-1" role="dialog" aria-labelledby="global-auth-modal-label" aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered" role="document">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="global-auth-modal-label">
                                    <i class="fa fa-lock"></i> Adeptus Insights Authentication
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <div class="auth-form">
                                    <div class="form-group mb-3">
                                        <label for="site-url">Site URL</label>
                                        <input type="text" class="form-control" id="site-url" value="${window.location.origin}" disabled>
                                    </div>
                                    <div class="form-group mb-3">
                                        <label for="admin-email">Admin Email</label>
                                        <input type="email" class="form-control" id="admin-email" value="admin@example.com" disabled>
                                    </div>
                                    <div class="form-group mb-3">
                                        <label for="auth-password">Password</label>
                                        <div class="input-group">
                                            <input type="password" class="form-control" id="auth-password" placeholder="Enter your password">
                                            <button class="btn btn-outline-secondary" type="button" id="toggle-password">
                                                <i class="fa fa-eye"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-primary" id="auth-submit">
                                    <i class="fa fa-sign-in"></i> Authenticate
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `},initModalFunctionality:function(){e("#auth-submit").on("click",()=>{this.handleLogin()}),e("#toggle-password").on("click",()=>{this.togglePasswordVisibility()}),e("#auth-password").on("keypress",a=>{13===a.which&&this.handleLogin()}),this.autoFillSiteInfo(),this.includeCustomCSS()},handleLogin:function(){var a=e("#auth-password").val();a?(e("#auth-submit").prop("disabled",!0).html('<i class="fa fa-spinner fa-spin"></i> Authenticating...'),this.authenticate(a).then(()=>{this.hideModal(),t.addNotification({message:"Authentication successful!",type:"success"})}).catch(a=>{t.addNotification({message:a.message||"Authentication failed",type:"error"}),e("#auth-submit").prop("disabled",!1).html('<i class="fa fa-sign-in"></i> Authenticate')})):t.addNotification({message:"Please enter your password",type:"error"})},authenticate:function(a){return new Promise((t,o)=>{e.ajax({url:M.cfg.wwwroot+"/report/adeptus_insights/ajax/authenticate.php",method:"POST",data:{password:a,sesskey:M.cfg.sesskey},dataType:"json",success:a=>{a&&a.success?(this.handleAuthSuccess(a.data),t()):o(new Error(a.message||"Authentication failed"))},error:(a,t,e)=>{o(new Error("Failed to authenticate"))}})})},togglePasswordVisibility:function(){var a=e("#auth-password"),t=e("#toggle-password").find("i");"password"===a.attr("type")?(a.attr("type","text"),t.removeClass("fa-eye").addClass("fa-eye-slash")):(a.attr("type","password"),t.removeClass("fa-eye-slash").addClass("fa-eye"))},autoFillSiteInfo:function(){"undefined"!=typeof M&&M.user&&M.user.email&&e("#admin-email").val(M.user.email)},includeCustomCSS:function(){e("#global-auth-modal-css").length||e("head").append(`
                    <style id="global-auth-modal-css">
                        #global-auth-modal .modal-content {
                            border-radius: 15px;
                            border: none;
                            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
                        }
                        #global-auth-modal .modal-header {
                            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                            color: white;
                            border-radius: 15px 15px 0 0;
                        }
                        #global-auth-modal .modal-title i {
                            margin-right: 8px;
                        }
                        #global-auth-modal .form-control:disabled {
                            background-color: #f8f9fa;
                            color: #6c757d;
                        }
                        #global-auth-modal .btn-primary {
                            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                            border: none;
                            border-radius: 25px;
                            padding: 10px 25px;
                        }
                        #global-auth-modal .btn-primary:hover {
                            transform: translateY(-2px);
                            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
                        }
                        #global-auth-modal .input-group-text {
                            background-color: #f8f9fa;
                            border-color: #ced4da;
                        }
                    </style>
                `)},updateUIForAuthenticatedUser:function(){e(".auth-required").hide(),e(".auth-not-required").show(),window.adeptusAuthData&&window.adeptusAuthData.user_name&&e(".user-name").text(window.adeptusAuthData.user_name)},isAuthenticated:function(){return window.adeptusAuthData&&window.adeptusAuthData.user_authorized&&window.adeptusAuthData.has_api_key},getAuthData:function(){return window.adeptusAuthData||null},logout:function(){window.adeptusAuthData=null,this.showModal(),e(document).trigger("adeptus:enableReadOnly"),this.updateUIForUnauthenticatedUser()},updateUIForUnauthenticatedUser:function(){e(".auth-required").show(),e(".auth-not-required").hide(),e(".user-name").text("Guest")}}});