define(["jquery","core/ajax","core/notification"],function(r,o,e){"use strict";var a=window.Swal,s={planId:0,subscriptionData:{},init:function(){this.initEventHandlers(),this.checkForCheckoutSuccess(),this.updateSubscriptionDisplay()},checkForCheckoutSuccess:function(){var e=new URLSearchParams(window.location.search),t=e.get("checkout"),e=e.get("session_id");"success"===t&&e?(a.fire({title:"Verifying Payment...",html:"<p>Please wait while we confirm your subscription upgrade.</p>",allowOutsideClick:!1,showConfirmButton:!1,didOpen:function(){a.showLoading()}}),o.call([{methodname:"report_adeptus_insights_verify_checkout_session",args:{session_id:e,sesskey:M.cfg.sesskey},done:function(e){e&&e.success?a.fire({icon:"success",title:"Upgrade Successful!",html:"<p>Your subscription has been upgraded to <strong>"+(e.plan_name||"Pro")+"</strong>.</p><p>Your new features are now available.</p>",confirmButtonColor:"#2563eb",confirmButtonText:"Continue"}).then(function(){var e=window.location.href.split("?")[0];window.location.href=e}):a.fire({icon:"warning",title:"Verification Issue",html:"<p>"+(e.message||"Could not verify payment.")+"</p><p>If you completed payment, your subscription will be updated shortly.</p>",confirmButtonColor:"#2563eb"})},fail:function(e){console.error("[Subscription] Verification failed:",e),a.fire({icon:"info",title:"Processing Payment",html:"<p>Your payment is being processed.</p><p>Your subscription will be updated within a few minutes.</p>",confirmButtonColor:"#2563eb"})}}]),e=window.location.href.split("?")[0],window.history.replaceState({},document.title,e)):"cancelled"===t&&(a.fire({icon:"info",title:"Checkout Cancelled",text:"Your checkout was cancelled. No charges were made.",confirmButtonColor:"#2563eb"}),e=window.location.href.split("?")[0],window.history.replaceState({},document.title,e))},initEventHandlers:function(){r(document).on("click",".btn-upgrade-plan, #upgrade-plan",function(e){e.preventDefault(),s.handleUpgradeFromFree()}),r(document).on("click",".btn-downgrade-plan",function(e){e.preventDefault(),s.handleDowngradePlan(r(this))}),r(document).on("click",".btn-cancel-subscription, #cancel-subscription",function(e){e.preventDefault(),s.handleCancelSubscription(r(this))}),r(document).on("click",".btn-billing-portal",function(e){e.preventDefault(),s.openBillingPortal()}),r(document).on("click",".btn-modify-subscription, #modify-subscription",function(e){e.preventDefault(),s.openBillingPortal()}),r(document).on("click",".btn-view-plans, #view-plans",function(e){e.preventDefault(),s.openBillingPortal()}),r(document).on("click",".select-plan-btn",function(e){e.preventDefault();var e=r(this).data("plan-id"),t=r(this).data("plan-name");s.handleSelectPlan(r(this),e,t)}),r(document).on("click","#renew-subscription",function(e){e.preventDefault(),s.handleRenewSubscription()}),r(document).on("click","#update-payment",function(e){e.preventDefault(),s.openBillingPortal()})},handleUpgradePlan:function(e){var t=e.data("plan-id"),e=e.data("plan-name");if(!t)return console.error("[Subscription] No plan ID available"),void a.fire({icon:"error",title:"Error",text:"Plan ID not available. Please try again.",confirmButtonColor:"#3085d6"});a.fire({icon:"question",title:"Upgrade to "+e+"?",html:"<p>You will be redirected to the billing portal to complete the upgrade.</p>",showCancelButton:!0,confirmButtonColor:"#f39c12",cancelButtonColor:"#95a5a6",confirmButtonText:'<i class="fa fa-arrow-up"></i> Upgrade',cancelButtonText:"Cancel"}).then(function(e){e.isConfirmed&&s.createBillingPortalSession(t,"upgrade")})},handleDowngradePlan:function(e){var t=e.data("plan-id"),e=e.data("plan-name");if(!t)return console.error("[Subscription] No plan ID available"),void a.fire({icon:"error",title:"Error",text:"Plan ID not available. Please try again.",confirmButtonColor:"#3085d6"});a.fire({icon:"warning",title:"Downgrade to "+e+"?",html:'<p>You will be redirected to the billing portal to complete the downgrade.</p><p class="text-muted"><small>Your current plan features will remain active until the end of the billing period.</small></p>',showCancelButton:!0,confirmButtonColor:"#17a2b8",cancelButtonColor:"#95a5a6",confirmButtonText:'<i class="fa fa-arrow-down"></i> Downgrade',cancelButtonText:"Cancel"}).then(function(e){e.isConfirmed&&s.createBillingPortalSession(t,"downgrade")})},handleCancelSubscription:function(e){a.fire({icon:"warning",title:"Cancel Subscription?",html:'<p><strong>Are you sure you want to cancel your subscription?</strong></p><p>You will lose access to premium features at the end of your billing period.</p><p class="text-danger"><small>This action cannot be undone.</small></p>',showCancelButton:!0,confirmButtonColor:"#e74c3c",cancelButtonColor:"#95a5a6",confirmButtonText:'<i class="fa fa-times"></i> Yes, Cancel Subscription',cancelButtonText:"Keep Subscription",focusCancel:!0}).then(function(e){e.isConfirmed&&s.createBillingPortalSession(null,"cancel")})},openBillingPortal:function(){s.createBillingPortalSession(s.subscriptionData.plan_id,"modify")},createBillingPortalSession:function(e,t){var n={return_url:window.location.href,sesskey:M.cfg.sesskey};e&&"undefined"!==e&&null!==e&&(n.plan_id=e),t&&"undefined"!==t&&null!==t&&(n.action=t),o.call([{methodname:"report_adeptus_insights_create_billing_portal_session",args:n,done:function(t){t&&t.success&&t.portal_url?(a.fire({icon:"success",title:"Redirecting...",html:"<p>Opening billing portal in a new window...</p>",timer:2e3,timerProgressBar:!0,showConfirmButton:!1,allowOutsideClick:!1,didOpen:function(){a.showLoading()}}),setTimeout(function(){var e=window.open(t.portal_url,"_blank");e&&!e.closed&&void 0!==e.closed||a.fire({icon:"warning",title:"Popup Blocked",html:'<p>Please allow popups for this site and try again.</p><p><a href="'+t.portal_url+'" target="_blank" class="btn btn-primary">Open Portal Manually</a></p>',showConfirmButton:!0,confirmButtonText:"OK"})},1e3)):a.fire({icon:"error",title:"Portal Creation Failed",text:t&&t.message||"Failed to create billing portal session. Please try again.",confirmButtonColor:"#3085d6"})},fail:function(e){console.error("[Subscription] AJAX failed:",e),a.fire({icon:"error",title:"Connection Error",text:"Failed to create billing portal session. Please check your connection and try again.",confirmButtonColor:"#3085d6"})}}])},updateSubscriptionDisplay:function(){o.call([{methodname:"report_adeptus_insights_get_subscription_details",args:{},done:function(e){e.success&&e.data&&(s.subscriptionData=e.data,s.renderSubscriptionInfo(e.data))},fail:function(e){console.error("[Subscription] Failed to get subscription details:",e)}}])},renderSubscriptionInfo:function(e){var t,n,i,o=r(".subscription-info");o.length&&(t='<div class="current-subscription">',t=(t+="<h3>Current Subscription</h3>")+'<div class="subscription-details"><p><strong>Plan:</strong> '+(e.plan_name||"Unknown")+"</p>",i="text-success",n=e.status||"Unknown",e.should_disable_api_access?i="text-danger":(e.is_cancelled||e.has_payment_issues)&&(i="text-warning"),t+='<p><strong>Status:</strong> <span class="'+i+'">'+n+"</span></p>",e.status_message&&(i="text-muted",e.should_disable_api_access?i="text-danger":(e.is_cancelled||e.has_payment_issues)&&(i="text-warning"),t+='<p class="'+i+'"><small>'+e.status_message+"</small></p>"),e.cancel_at_period_end&&(t+='<p class="text-warning"><strong>⚠️ Cancelled:</strong> Access ends on '+new Date(1e3*e.current_period_end).toLocaleDateString()+"</p>"),0<e.failed_payment_attempts&&(t+='<p class="text-danger"><strong>❌ Payment Failed:</strong> '+e.failed_payment_attempts+" failed attempts</p>"),e.current_period_end&&(t+="<p><strong>Next billing:</strong> "+new Date(1e3*e.current_period_end).toLocaleDateString()+"</p>"),o.html(t=t+"</div>"+"</div>"),s.updateApiAccessStatus(e))},updateApiAccessStatus:function(e){var t=e.should_disable_api_access||!1;"undefined"!=typeof window&&(window.adeptusApiAccessDisabled=t,window.adeptusSubscriptionStatus=e),t?(r(".btn-send-message, .btn-generate-report, .btn-ai-assistant").prop("disabled",!0).attr("title","API access disabled: "+(e.status_message||"Subscription issue")),this.showApiAccessWarning(e)):(r(".btn-send-message, .btn-generate-report, .btn-ai-assistant").prop("disabled",!1).removeAttr("title"),this.hideApiAccessWarning())},showApiAccessWarning:function(e){var t;r(".api-access-warning").length||(t=(t='<div class="api-access-warning alert alert-danger alert-dismissible fade show" role="alert">')+"<strong>⚠️ API Access Disabled</strong><br>"+(e.status_message||"Your subscription has an issue that prevents API access."),e.has_payment_issues?t+="<br><small>Please update your payment method to restore access.</small>":e.is_cancelled&&(t+="<br><small>Your subscription has been cancelled. Please reactivate to restore access.</small>"),t+='<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button></div>',r("body").prepend(t))},hideApiAccessWarning:function(){r(".api-access-warning").remove()},refresh:function(){this.updateSubscriptionDisplay()},plansData:null,currentInterval:"monthly",handleUpgradeFromFree:function(){a.fire({title:"Loading Plans...",html:'<div style="padding: 20px;"><i class="fa fa-spinner fa-spin fa-2x"></i></div>',showConfirmButton:!1,allowOutsideClick:!1}),fetch(M.cfg.wwwroot+"/report/adeptus_insights/ajax/get_available_plans.php?sesskey="+M.cfg.sesskey).then(function(e){return e.json()}).then(function(e){e.success&&(0<e.monthly_plans.length||0<e.yearly_plans.length)?(s.plansData={monthly:e.monthly_plans||[],yearly:e.yearly_plans||[]},s.currentInterval="monthly",s.showPlansModal(e)):a.fire({icon:"error",title:"Error",text:e.message||"Failed to load plans. Please try again.",confirmButtonColor:"#3085d6"})}).catch(function(e){console.error("[Subscription] Error fetching plans:",e),a.fire({icon:"error",title:"Connection Error",text:"Failed to load plans. Please check your connection and try again.",confirmButtonColor:"#3085d6"})})},showPlansModal:function(e){var t=e.has_yearly_plans||!1,n=e.max_yearly_savings||0,i='<div class="plans-modal-container" style="text-align: left;">';t&&(i+='<div class="billing-toggle-container" style="display: flex; justify-content: center; margin-bottom: 24px;"><div class="billing-toggle" style="display: inline-flex; align-items: center; background: #f3f4f6; border-radius: 50px; padding: 6px; gap: 4px;"><button type="button" class="billing-toggle-btn active" data-interval="monthly" style="padding: 10px 24px; border: none; background: white; border-radius: 50px; font-weight: 600; font-size: 14px; cursor: pointer; color: #1f2937; box-shadow: 0 2px 8px rgba(0,0,0,0.1); transition: all 0.3s ease;">Monthly</button><button type="button" class="billing-toggle-btn" data-interval="yearly" style="padding: 10px 24px; border: none; background: transparent; border-radius: 50px; font-weight: 600; font-size: 14px; cursor: pointer; color: #6b7280; transition: all 0.3s ease;">Annual',0<n&&(i+='<span style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; font-size: 10px; font-weight: 700; padding: 2px 8px; border-radius: 20px; margin-left: 6px; text-transform: uppercase;">Save '+n+"%</span>"),i+="</button></div></div>"),i=(i+='<div id="plans-grid-container">')+s.buildPlansGrid(e.monthly_plans||[],"monthly"),a.fire({title:'<i class="fa fa-rocket" style="color: #2563eb;"></i> Choose Your Plan',html:i=i+"</div>"+"</div>",width:"95%",showCancelButton:!0,showConfirmButton:!1,cancelButtonText:"Cancel",cancelButtonColor:"#95a5a6",customClass:{popup:"plans-modal-popup"},didOpen:function(){s.initPlansModalHandlers()}})},buildPlansGrid:function(e,i){if(!e||0===e.length)return'<div style="text-align: center; padding: 40px; color: #6b7280;"><i class="fa fa-calendar-times-o fa-2x" style="margin-bottom: 10px;"></i><p>Annual plans coming soon!</p></div>';var o='<div class="plans-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 24px; max-width: 1000px; margin: 0 auto;">';return e.forEach(function(e){var t=e.is_current?"#10b981":e.is_popular?"#2563eb":"#e5e7eb",n=e.is_current?"linear-gradient(135deg, #f0fdf4 0%, #ecfdf5 100%)":"white";o+='<div class="plan-card" style="background: '+n+"; border: 2px solid "+t+'; border-radius: 16px; padding: 28px 24px; position: relative; transition: all 0.3s ease; display: flex; flex-direction: column;">',e.is_current?o+='<div style="position: absolute; top: -12px; left: 50%; transform: translateX(-50%); background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; font-size: 11px; font-weight: 700; padding: 5px 14px; border-radius: 20px; text-transform: uppercase; letter-spacing: 0.5px;">Current Plan</div>':e.is_popular&&(o+='<div style="position: absolute; top: -12px; left: 50%; transform: translateX(-50%); background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%); color: white; font-size: 11px; font-weight: 700; padding: 5px 14px; border-radius: 20px; text-transform: uppercase; letter-spacing: 0.5px;">Most Popular</div>'),o=(o+='<div style="text-align: center; margin-bottom: 20px; padding-top: 8px;">')+'<div style="font-size: 22px; font-weight: 700; color: #1f2937; margin-bottom: 8px;">'+e.short_name+"</div>",e.description&&(o+='<div style="color: #6b7280; font-size: 13px; line-height: 1.5;">'+e.description+"</div>"),o+='</div><div style="text-align: center; margin-bottom: 24px; padding-bottom: 24px; border-bottom: 1px solid #e5e7eb;">',e.is_free?o+='<div style="font-size: 42px; font-weight: 800; color: #10b981;">Free</div><div style="color: #6b7280; font-size: 13px;">Forever</div>':(o=(o+='<div style="font-size: 42px; font-weight: 800; color: #1f2937;">'+e.price_formatted+"</div>")+'<div style="color: #6b7280; font-size: 13px;">'+("yearly"===i?"per year":"per month")+"</div>",e.has_savings&&(o+='<div style="margin-top: 6px;"><span style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; font-size: 11px; font-weight: 700; padding: 3px 10px; border-radius: 20px;">Save '+e.savings_percent+"%</span></div>")),o=(o=(o=(o=(o+='</div><div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid #e5e7eb;">')+'<div style="text-align: center; padding: 12px; background: #f9fafb; border-radius: 10px;"><div style="font-size: 16px; font-weight: 700; color: #1f2937;">'+e.tokens_limit+'</div><div style="font-size: 11px; color: #6b7280; text-transform: uppercase; letter-spacing: 0.5px;">AI Tokens</div></div>')+'<div style="text-align: center; padding: 12px; background: #f9fafb; border-radius: 10px;"><div style="font-size: 16px; font-weight: 700; color: #1f2937;">'+e.exports_limit+'</div><div style="font-size: 11px; color: #6b7280; text-transform: uppercase; letter-spacing: 0.5px;">Exports/mo</div></div>')+'<div style="text-align: center; padding: 12px; background: #f9fafb; border-radius: 10px;"><div style="font-size: 16px; font-weight: 700; color: #1f2937;">'+e.reports_limit+'</div><div style="font-size: 11px; color: #6b7280; text-transform: uppercase; letter-spacing: 0.5px;">Saved Reports</div></div>')+'<div style="text-align: center; padding: 12px; background: #f9fafb; border-radius: 10px;"><div style="font-size: 16px; font-weight: 700; color: #1f2937;">'+e.export_formats+'</div><div style="font-size: 11px; color: #6b7280; text-transform: uppercase; letter-spacing: 0.5px;">Formats</div></div></div>',e.features&&0<e.features.length&&(o+='<div style="flex: 1; margin-bottom: 20px;"><ul style="list-style: none; padding: 0; margin: 0;">',e.features.forEach(function(e){o+='<li style="display: flex; align-items: flex-start; gap: 10px; padding: 8px 0; color: #374151; font-size: 13px; line-height: 1.4;"><i class="fa fa-check" style="color: #10b981; font-size: 12px; margin-top: 3px; flex-shrink: 0;"></i> '+e+"</li>"}),o+="</ul></div>"),o+='<div style="margin-top: auto;">',e.is_current?o+='<button class="plan-select-btn" disabled style="display: block; width: 100%; padding: 14px; border: none; border-radius: 10px; background: #e5e7eb; color: #6b7280; font-weight: 600; font-size: 14px; cursor: default;"><i class="fa fa-check-circle"></i> Current Plan</button>':e.is_free?o+='<button class="plan-select-btn" disabled style="display: block; width: 100%; padding: 14px; border: 2px solid #e5e7eb; border-radius: 10px; background: white; color: #374151; font-weight: 600; font-size: 14px; cursor: default;">Free Plan</button>':(n=e.stripe_price_id||"",t=e.stripe_configured||!1,o+='<button class="plan-select-btn" data-plan-id="'+(e.id||"")+'" data-plan-name="'+e.short_name+'" data-stripe-price-id="'+n+'" data-stripe-configured="'+t+'" style="display: block; width: 100%; padding: 14px; border: none; border-radius: 10px; background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%); color: white; font-weight: 600; font-size: 14px; cursor: pointer; transition: all 0.3s ease;"><i class="fa fa-arrow-up"></i> Upgrade to '+e.short_name+"</button>"),o+="</div></div>"}),o+="</div>"},initPlansModalHandlers:function(){document.querySelectorAll(".billing-toggle-btn").forEach(function(e){e.addEventListener("click",function(){var e,t,n=this.getAttribute("data-interval");n!==s.currentInterval&&(document.querySelectorAll(".billing-toggle-btn").forEach(function(e){e.classList.remove("active"),e.style.background="transparent",e.style.color="#6b7280",e.style.boxShadow="none"}),this.classList.add("active"),this.style.background="white",this.style.color="#1f2937",this.style.boxShadow="0 2px 8px rgba(0,0,0,0.1)",s.currentInterval=n,e=s.plansData[n]||[],(t=document.getElementById("plans-grid-container"))&&(t.innerHTML=s.buildPlansGrid(e,n),s.initPlanButtonHandlers()))})}),s.initPlanButtonHandlers()},initPlanButtonHandlers:function(){document.querySelectorAll(".plan-select-btn:not([disabled])").forEach(function(e){e.addEventListener("click",function(){var e=this.getAttribute("data-plan-name"),t=this.getAttribute("data-plan-id"),n=this.getAttribute("data-stripe-price-id");"true"===this.getAttribute("data-stripe-configured")&&n?s.createCheckoutSession(t,n,e):s.openBillingPortalForUpgrade(e,t)}),e.addEventListener("mouseenter",function(){this.style.transform="translateY(-2px)",this.style.boxShadow="0 8px 20px rgba(37, 99, 235, 0.3)"}),e.addEventListener("mouseleave",function(){this.style.transform="translateY(0)",this.style.boxShadow="none"})})},openBillingPortalForUpgrade:function(n,e){a.fire({title:"Opening Billing Portal...",html:"<p>Preparing upgrade to "+n+"...</p>",allowOutsideClick:!1,showConfirmButton:!1,didOpen:function(){a.showLoading()}});var t={return_url:window.location.href,sesskey:M.cfg.sesskey};e&&(t.plan_id=e),o.call([{methodname:"report_adeptus_insights_create_billing_portal_session",args:t,done:function(e){var t;e&&e.success&&e.portal_url?(a.fire({icon:"success",title:"Redirecting...",html:"<p>Opening billing portal...</p>",timer:2e3,timerProgressBar:!0,showConfirmButton:!1,allowOutsideClick:!1}),setTimeout(function(){window.location.href=e.portal_url},1e3)):-1!==(t=e&&e.message||"Failed to open billing portal.").indexOf("NO_STRIPE_CUSTOMER")||-1!==t.indexOf("payment_enabled")||-1!==t.indexOf("Stripe")?a.fire({icon:"info",title:"Upgrade Coming Soon",html:"<p>Online payments are not yet configured for this installation.</p><p>To upgrade to <strong>"+n+'</strong>, please contact your administrator or email:</p><p><a href="mailto:support@adeptus360.com?subject=Upgrade%20to%20'+n+'">support@adeptus360.com</a></p>',confirmButtonColor:"#2563eb",confirmButtonText:"OK"}):a.fire({icon:"error",title:"Billing Portal Error",text:t,confirmButtonColor:"#3085d6"})},fail:function(e){console.error("[Subscription] Billing portal failed:",e),a.fire({icon:"error",title:"Connection Error",text:"Failed to open billing portal. Please try again.",confirmButtonColor:"#3085d6"})}}])},createCheckoutSession:function(e,t,n){a.fire({title:"Preparing Checkout...",html:"<p>Setting up payment for "+n+"...</p>",allowOutsideClick:!1,showConfirmButton:!1,didOpen:function(){a.showLoading()}});var i=window.location.href,e={plan_id:parseInt(e),stripe_price_id:t,return_url:i,sesskey:M.cfg.sesskey};o.call([{methodname:"report_adeptus_insights_create_checkout_session",args:e,done:function(e){var t;e&&e.success&&e.checkout_url?(a.fire({icon:"success",title:"Redirecting to Checkout...",html:"<p>You will be redirected to complete your payment.</p>",timer:2e3,timerProgressBar:!0,showConfirmButton:!1,allowOutsideClick:!1}),setTimeout(function(){window.location.href=e.checkout_url},1e3)):(t=e&&e.message||"Failed to create checkout session.","STRIPE_NOT_CONFIGURED"===(e&&e.error_code||"")?a.fire({icon:"info",title:"Payment Not Available",html:"<p>Stripe is not yet configured for the <strong>"+n+'</strong> plan.</p><p>Please contact your administrator or email:</p><p><a href="mailto:support@adeptus360.com?subject=Upgrade%20to%20'+n+'">support@adeptus360.com</a></p>',confirmButtonColor:"#2563eb",confirmButtonText:"OK"}):a.fire({icon:"error",title:"Checkout Error",text:t,confirmButtonColor:"#3085d6"}))},fail:function(e){console.error("[Subscription] Checkout session failed:",e),a.fire({icon:"error",title:"Connection Error",text:"Failed to create checkout session. Please try again.",confirmButtonColor:"#3085d6"})}}])},handleSelectPlan:function(e,t,n){if(!t)return console.error("[Subscription] No plan ID available"),void a.fire({icon:"error",title:"Error",text:"Plan ID not available. Please try again.",confirmButtonColor:"#3085d6"});a.fire({icon:"info",title:"Subscribe to "+n+"?",html:"<p>You will be redirected to complete your subscription.</p>",showCancelButton:!0,confirmButtonColor:"#3498db",cancelButtonColor:"#95a5a6",confirmButtonText:'<i class="fa fa-credit-card"></i> Subscribe Now',cancelButtonText:"Cancel"}).then(function(e){e.isConfirmed&&s.createBillingPortalSession(t,"subscribe")})},handleRenewSubscription:function(){a.fire({icon:"success",title:"Renew Your Subscription?",html:"<p>Welcome back! Renew your subscription to regain access to all premium features.</p>",showCancelButton:!0,confirmButtonColor:"#27ae60",cancelButtonColor:"#95a5a6",confirmButtonText:'<i class="fa fa-refresh"></i> Renew Subscription',cancelButtonText:"Not Now"}).then(function(e){e.isConfirmed&&s.createBillingPortalSession(null,"renew")})}};return s});