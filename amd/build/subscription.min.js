define(["jquery","core/ajax","core/notification","core/str"],(function(e,t,n,o){"use strict";var i=window.Swal,r={},a=function(e,t){return r[e]||t||e},s={planId:0,subscriptionData:{},init:function(){var e=this;o.get_strings([{key:"js_verifying_payment",component:"report_adeptus_insights"},{key:"js_verifying_payment_text",component:"report_adeptus_insights"},{key:"js_upgrade_successful",component:"report_adeptus_insights"},{key:"js_verification_issue",component:"report_adeptus_insights"},{key:"js_verification_issue_text",component:"report_adeptus_insights"},{key:"js_processing_payment",component:"report_adeptus_insights"},{key:"js_processing_payment_text",component:"report_adeptus_insights"},{key:"js_checkout_cancelled",component:"report_adeptus_insights"},{key:"js_checkout_cancelled_text",component:"report_adeptus_insights"},{key:"js_cancel_subscription_title",component:"report_adeptus_insights"},{key:"js_cancel_subscription_text",component:"report_adeptus_insights"},{key:"js_yes_cancel",component:"report_adeptus_insights"},{key:"js_upgrade_to",component:"report_adeptus_insights"},{key:"js_downgrade_to",component:"report_adeptus_insights"},{key:"js_choose_your_plan",component:"report_adeptus_insights"},{key:"js_redirecting",component:"report_adeptus_insights"},{key:"js_popup_blocked",component:"report_adeptus_insights"},{key:"js_popup_blocked_text",component:"report_adeptus_insights"},{key:"js_portal_creation_failed",component:"report_adeptus_insights"},{key:"js_connection_error",component:"report_adeptus_insights"},{key:"js_preparing_checkout",component:"report_adeptus_insights"},{key:"js_redirecting_checkout",component:"report_adeptus_insights"},{key:"js_upgrade_coming_soon",component:"report_adeptus_insights"},{key:"js_billing_portal_error",component:"report_adeptus_insights"},{key:"js_opening_billing_portal",component:"report_adeptus_insights"},{key:"js_loading_plans",component:"report_adeptus_insights"},{key:"js_continue",component:"report_adeptus_insights"},{key:"error",component:"report_adeptus_insights"},{key:"cancel",component:"report_adeptus_insights"},{key:"js_ok",component:"report_adeptus_insights"},{key:"js_plan_id_not_available",component:"report_adeptus_insights"},{key:"js_failed_billing_portal",component:"report_adeptus_insights"},{key:"js_failed_load_plans",component:"report_adeptus_insights"},{key:"js_failed_open_billing",component:"report_adeptus_insights"},{key:"js_failed_checkout",component:"report_adeptus_insights"},{key:"js_payment_not_available",component:"report_adeptus_insights"},{key:"js_checkout_error",component:"report_adeptus_insights"},{key:"js_subscribe_to",component:"report_adeptus_insights"},{key:"js_renew_subscription",component:"report_adeptus_insights"},{key:"js_keep_subscription",component:"report_adeptus_insights"},{key:"js_yes_cancel_subscription",component:"report_adeptus_insights"},{key:"js_monthly",component:"report_adeptus_insights"},{key:"js_annual",component:"report_adeptus_insights"},{key:"js_current_plan",component:"report_adeptus_insights"},{key:"js_most_popular",component:"report_adeptus_insights"},{key:"js_free",component:"report_adeptus_insights"},{key:"js_forever",component:"report_adeptus_insights"},{key:"js_per_year",component:"report_adeptus_insights"},{key:"js_per_month",component:"report_adeptus_insights"},{key:"js_save_percent",component:"report_adeptus_insights"},{key:"js_ai_tokens",component:"report_adeptus_insights"},{key:"js_exports_mo",component:"report_adeptus_insights"},{key:"js_saved_reports",component:"report_adeptus_insights"},{key:"js_formats",component:"report_adeptus_insights"},{key:"js_free_plan",component:"report_adeptus_insights"},{key:"js_annual_plans_soon",component:"report_adeptus_insights"},{key:"js_upgrade",component:"report_adeptus_insights"},{key:"js_downgrade",component:"report_adeptus_insights"},{key:"js_upgrade_redirect_text",component:"report_adeptus_insights"},{key:"js_downgrade_redirect_text",component:"report_adeptus_insights"},{key:"js_downgrade_features_text",component:"report_adeptus_insights"},{key:"js_action_undone",component:"report_adeptus_insights"},{key:"js_opening_billing_portal_new_window",component:"report_adeptus_insights"},{key:"js_open_portal_manually",component:"report_adeptus_insights"},{key:"js_current_subscription",component:"report_adeptus_insights"},{key:"js_plan_label",component:"report_adeptus_insights"},{key:"js_status_label",component:"report_adeptus_insights"},{key:"js_cancelled_access_ends",component:"report_adeptus_insights"},{key:"js_payment_failed_attempts",component:"report_adeptus_insights"},{key:"js_next_billing",component:"report_adeptus_insights"},{key:"js_api_access_disabled",component:"report_adeptus_insights"},{key:"js_update_payment_restore",component:"report_adeptus_insights"},{key:"js_subscription_cancelled_reactivate",component:"report_adeptus_insights"},{key:"js_preparing_upgrade",component:"report_adeptus_insights"},{key:"js_opening_billing",component:"report_adeptus_insights"},{key:"js_online_payments_not_configured",component:"report_adeptus_insights"},{key:"js_setting_up_payment",component:"report_adeptus_insights"},{key:"js_redirect_complete_payment",component:"report_adeptus_insights"},{key:"js_stripe_not_configured",component:"report_adeptus_insights"},{key:"js_contact_admin",component:"report_adeptus_insights"},{key:"js_redirect_complete_subscription",component:"report_adeptus_insights"},{key:"js_welcome_back_renew",component:"report_adeptus_insights"},{key:"js_not_now",component:"report_adeptus_insights"},{key:"js_renew_now",component:"report_adeptus_insights"}]).then((function(e){return r={verifying_payment:e[0],verifying_payment_text:e[1],upgrade_successful:e[2],verification_issue:e[3],verification_issue_text:e[4],processing_payment:e[5],processing_payment_text:e[6],checkout_cancelled:e[7],checkout_cancelled_text:e[8],cancel_subscription_title:e[9],cancel_subscription_text:e[10],yes_cancel:e[11],upgrade_to:e[12],downgrade_to:e[13],choose_your_plan:e[14],redirecting:e[15],popup_blocked:e[16],popup_blocked_text:e[17],portal_creation_failed:e[18],connection_error:e[19],preparing_checkout:e[20],redirecting_checkout:e[21],upgrade_coming_soon:e[22],billing_portal_error:e[23],opening_billing_portal:e[24],loading_plans:e[25],continue_text:e[26],error:e[27],cancel:e[28],ok:e[29],plan_id_not_available:e[30],failed_billing_portal:e[31],failed_load_plans:e[32],failed_open_billing:e[33],failed_checkout:e[34],payment_not_available:e[35],checkout_error:e[36],subscribe_to:e[37],renew_subscription:e[38],keep_subscription:e[39],yes_cancel_subscription:e[40],monthly:e[41],annual:e[42],current_plan:e[43],most_popular:e[44],free:e[45],forever:e[46],per_year:e[47],per_month:e[48],save_percent:e[49],ai_tokens:e[50],exports_mo:e[51],saved_reports:e[52],formats:e[53],free_plan:e[54],annual_plans_soon:e[55],upgrade:e[56],downgrade:e[57],upgrade_redirect_text:e[58],downgrade_redirect_text:e[59],downgrade_features_text:e[60],action_undone:e[61],opening_billing_portal_new_window:e[62],open_portal_manually:e[63],current_subscription:e[64],plan_label:e[65],status_label:e[66],cancelled_access_ends:e[67],payment_failed_attempts:e[68],next_billing:e[69],api_access_disabled:e[70],update_payment_restore:e[71],subscription_cancelled_reactivate:e[72],preparing_upgrade:e[73],opening_billing:e[74],online_payments_not_configured:e[75],setting_up_payment:e[76],redirect_complete_payment:e[77],stripe_not_configured:e[78],contact_admin:e[79],redirect_complete_subscription:e[80],welcome_back_renew:e[81],not_now:e[82],renew_now:e[83]}})).then((function(){e._initAfterStrings()})).catch((function(){e._initAfterStrings()}))},_initAfterStrings:function(){this.initEventHandlers(),this.checkForCheckoutSuccess(),this.updateSubscriptionDisplay()},checkForCheckoutSuccess:function(){var e=new URLSearchParams(window.location.search),n=e.get("checkout"),o=e.get("session_id");if("success"===n&&o){i.fire({title:a("verifying_payment","Verifying Payment..."),html:"<p>"+a("verifying_payment_text","Please wait while we confirm your subscription upgrade.")+"</p>",allowOutsideClick:!1,showConfirmButton:!1,didOpen:function(){i.showLoading()}}),t.call([{methodname:"report_adeptus_insights_verify_checkout_session",args:{session_id:o,sesskey:M.cfg.sesskey},done:function(e){if(e&&e.success){var t=e.plan_name||"Pro";i.fire({icon:"success",title:a("upgrade_successful","Upgrade Successful!"),html:"<p>"+a("upgrade_successful_text","Your subscription has been upgraded to <strong>"+t+"</strong>. Your new features are now available.").replace("{$a}","<strong>"+t+"</strong>")+"</p>",confirmButtonColor:"#2563eb",confirmButtonText:a("continue_text","Continue")}).then((function(){var e=window.location.href.split("?")[0];window.location.href=e}))}else i.fire({icon:"warning",title:a("verification_issue","Verification Issue"),html:"<p>"+(e.message||"Could not verify payment.")+"</p><p>"+a("verification_issue_text","If you completed payment, your subscription will be updated shortly.")+"</p>",confirmButtonColor:"#2563eb"})},fail:function(e){i.fire({icon:"info",title:a("processing_payment","Processing Payment"),html:"<p>"+a("processing_payment_text","Your payment is being processed. Your subscription will be updated within a few minutes.")+"</p>",confirmButtonColor:"#2563eb"})}}]);var r=window.location.href.split("?")[0];window.history.replaceState({},document.title,r)}else if("cancelled"===n){i.fire({icon:"info",title:a("checkout_cancelled","Checkout Cancelled"),text:a("checkout_cancelled_text","Your checkout was cancelled. No charges were made."),confirmButtonColor:"#2563eb"});var s=window.location.href.split("?")[0];window.history.replaceState({},document.title,s)}},initEventHandlers:function(){e(document).on("click",".btn-upgrade-plan, #upgrade-plan",(function(e){e.preventDefault(),s.handleUpgradeFromFree()})),e(document).on("click",".btn-downgrade-plan",(function(t){t.preventDefault(),s.handleDowngradePlan(e(this))})),e(document).on("click",".btn-cancel-subscription, #cancel-subscription",(function(t){t.preventDefault(),s.handleCancelSubscription(e(this))})),e(document).on("click",".btn-billing-portal",(function(e){e.preventDefault(),s.openBillingPortal()})),e(document).on("click",".btn-modify-subscription, #modify-subscription",(function(e){e.preventDefault(),s.openBillingPortal()})),e(document).on("click",".btn-view-plans, #view-plans",(function(e){e.preventDefault(),s.openBillingPortal()})),e(document).on("click",".select-plan-btn",(function(t){t.preventDefault();var n=e(this).data("plan-id"),o=e(this).data("plan-name");s.handleSelectPlan(e(this),n,o)})),e(document).on("click","#renew-subscription",(function(e){e.preventDefault(),s.handleRenewSubscription()})),e(document).on("click","#update-payment",(function(e){e.preventDefault(),s.openBillingPortal()}))},handleUpgradePlan:function(e){var t=e.data("plan-id"),n=e.data("plan-name");t?i.fire({icon:"question",title:a("upgrade_to","Upgrade to {$a}?").replace("{$a}",n),html:"<p>"+a("upgrade_redirect_text","You will be redirected to the billing portal to complete the upgrade.")+"</p>",showCancelButton:!0,confirmButtonColor:"#f39c12",cancelButtonColor:"#95a5a6",confirmButtonText:'<i class="fa fa-arrow-up"></i> '+a("upgrade","Upgrade"),cancelButtonText:a("cancel","Cancel")}).then((function(e){e.isConfirmed&&s.createBillingPortalSession(t,"upgrade")})):i.fire({icon:"error",title:a("error","Error"),text:a("plan_id_not_available","Plan ID not available. Please try again."),confirmButtonColor:"#3085d6"})},handleDowngradePlan:function(e){var t=e.data("plan-id"),n=e.data("plan-name");t?i.fire({icon:"warning",title:a("downgrade_to","Downgrade to {$a}?").replace("{$a}",n),html:"<p>"+a("downgrade_redirect_text","You will be redirected to the billing portal to complete the downgrade.")+'</p><p class="text-muted"><small>'+a("downgrade_features_text","Your current plan features will remain active until the end of the billing period.")+"</small></p>",showCancelButton:!0,confirmButtonColor:"#17a2b8",cancelButtonColor:"#95a5a6",confirmButtonText:'<i class="fa fa-arrow-down"></i> '+a("downgrade","Downgrade"),cancelButtonText:a("cancel","Cancel")}).then((function(e){e.isConfirmed&&s.createBillingPortalSession(t,"downgrade")})):i.fire({icon:"error",title:a("error","Error"),text:a("plan_id_not_available","Plan ID not available. Please try again."),confirmButtonColor:"#3085d6"})},handleCancelSubscription:function(e){i.fire({icon:"warning",title:a("cancel_subscription_title","Cancel Subscription?"),html:"<p><strong>"+a("cancel_subscription_text","Are you sure you want to cancel your subscription? You will lose access to premium features at the end of your billing period.")+'</strong></p><p class="text-danger"><small>'+a("action_undone","This action cannot be undone.")+"</small></p>",showCancelButton:!0,confirmButtonColor:"#e74c3c",cancelButtonColor:"#95a5a6",confirmButtonText:'<i class="fa fa-times"></i> '+a("yes_cancel","Yes, cancel it"),cancelButtonText:a("keep_subscription","Keep Subscription"),focusCancel:!0}).then((function(e){e.isConfirmed&&s.createBillingPortalSession(null,"cancel")}))},openBillingPortal:function(){s.createBillingPortalSession(s.subscriptionData.plan_id,"modify")},createBillingPortalSession:function(e,n){var o={return_url:window.location.href,sesskey:M.cfg.sesskey};e&&"undefined"!==e&&null!==e&&(o.plan_id=e),n&&"undefined"!==n&&null!==n&&(o.action=n),t.call([{methodname:"report_adeptus_insights_create_billing_portal_session",args:o,done:function(e){e&&e.success&&e.portal_url?(i.fire({icon:"success",title:a("redirecting","Redirecting..."),html:"<p>"+a("opening_billing_portal_new_window","Opening billing portal in a new window...")+"</p>",timer:2e3,timerProgressBar:!0,showConfirmButton:!1,allowOutsideClick:!1,didOpen:function(){i.showLoading()}}),setTimeout((function(){var t=window.open(e.portal_url,"_blank");t&&!t.closed&&void 0!==t.closed||i.fire({icon:"warning",title:a("popup_blocked","Popup Blocked"),html:"<p>"+a("popup_blocked_text","Please allow popups for this site to access the billing portal.")+'</p><p><a href="'+e.portal_url+'" target="_blank" class="btn btn-primary">'+a("open_portal_manually","Open Portal Manually")+"</a></p>",showConfirmButton:!0,confirmButtonText:a("ok","OK")})}),1e3)):i.fire({icon:"error",title:a("portal_creation_failed","Portal Creation Failed"),text:e&&e.message||a("failed_billing_portal","Failed to create billing portal session. Please try again."),confirmButtonColor:"#3085d6"})},fail:function(e){i.fire({icon:"error",title:a("connection_error","Connection Error"),text:a("failed_billing_portal","Failed to create billing portal session. Please check your connection and try again."),confirmButtonColor:"#3085d6"})}}])},updateSubscriptionDisplay:function(){t.call([{methodname:"report_adeptus_insights_get_subscription_details",args:{},done:function(e){e.success&&e.data&&(s.subscriptionData=e.data,s.renderSubscriptionInfo(e.data))},fail:function(e){}}])},renderSubscriptionInfo:function(t){var n=e(".subscription-info");if(n.length){var o='<div class="current-subscription">';o+="<h3>"+a("current_subscription","Current Subscription")+"</h3>",o+='<div class="subscription-details">',o+="<p><strong>"+a("plan_label","Plan:")+"</strong> "+(t.plan_name||"Unknown")+"</p>";var i="text-success",r=t.status||"Unknown";if(t.should_disable_api_access?i="text-danger":(t.is_cancelled||t.has_payment_issues)&&(i="text-warning"),o+="<p><strong>"+a("status_label","Status:")+'</strong> <span class="'+i+'">'+r+"</span></p>",t.status_message){var l="text-muted";t.should_disable_api_access?l="text-danger":(t.is_cancelled||t.has_payment_issues)&&(l="text-warning"),o+='<p class="'+l+'"><small>'+t.status_message+"</small></p>"}if(t.cancel_at_period_end){var p=new Date(1e3*t.current_period_end);o+='<p class="text-warning"><strong>'+a("cancelled_access_ends","Cancelled: Access ends on {$a}").replace("{$a}",p.toLocaleDateString())+"</strong></p>"}if(t.failed_payment_attempts>0&&(o+='<p class="text-danger"><strong>'+a("payment_failed_attempts","Payment Failed: {$a} failed attempts").replace("{$a}",t.failed_payment_attempts)+"</strong></p>"),t.current_period_end){var c=new Date(1e3*t.current_period_end);o+="<p><strong>"+a("next_billing","Next billing:")+"</strong> "+c.toLocaleDateString()+"</p>"}o+="</div>",o+="</div>",n.html(o),s.updateApiAccessStatus(t)}},updateApiAccessStatus:function(t){var n=t.should_disable_api_access||!1;"undefined"!=typeof window&&(window.adeptusApiAccessDisabled=n,window.adeptusSubscriptionStatus=t),n?(e(".btn-send-message, .btn-generate-report, .btn-ai-assistant").prop("disabled",!0).attr("title",a("api_access_disabled","API access disabled")+": "+(t.status_message||"")),this.showApiAccessWarning(t)):(e(".btn-send-message, .btn-generate-report, .btn-ai-assistant").prop("disabled",!1).removeAttr("title"),this.hideApiAccessWarning())},showApiAccessWarning:function(t){if(!e(".api-access-warning").length){var n='<div class="api-access-warning alert alert-danger alert-dismissible fade show" role="alert">';n+="<strong>"+a("api_access_disabled","API Access Disabled")+"</strong><br>",n+=t.status_message||"",t.has_payment_issues?n+="<br><small>"+a("update_payment_restore","Please update your payment method to restore access.")+"</small>":t.is_cancelled&&(n+="<br><small>"+a("subscription_cancelled_reactivate","Your subscription has been cancelled. Please reactivate to restore access.")+"</small>"),n+='<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>',n+="</div>",e("body").prepend(n)}},hideApiAccessWarning:function(){e(".api-access-warning").remove()},refresh:function(){this.updateSubscriptionDisplay()},plansData:null,currentInterval:"monthly",handleUpgradeFromFree:function(){i.fire({title:a("loading_plans","Loading Plans..."),html:'<div style="padding: 20px;"><i class="fa fa-spinner fa-spin fa-2x"></i></div>',showConfirmButton:!1,allowOutsideClick:!1}),fetch(M.cfg.wwwroot+"/report/adeptus_insights/ajax/get_available_plans.php?sesskey="+M.cfg.sesskey).then((function(e){return e.json()})).then((function(e){e.success&&(e.monthly_plans.length>0||e.yearly_plans.length>0)?(s.plansData={monthly:e.monthly_plans||[],yearly:e.yearly_plans||[]},s.currentInterval="monthly",s.showPlansModal(e)):i.fire({icon:"error",title:a("error","Error"),text:e.message||a("failed_load_plans","Failed to load plans. Please try again."),confirmButtonColor:"#3085d6"})})).catch((function(e){i.fire({icon:"error",title:a("connection_error","Connection Error"),text:a("failed_load_plans","Failed to load plans. Please check your connection and try again."),confirmButtonColor:"#3085d6"})}))},showPlansModal:function(e){var t=e.has_yearly_plans||!1,n=e.max_yearly_savings||0,o='<div class="plans-modal-container" style="text-align: left;">';t&&(o+='<div class="billing-toggle-container" style="display: flex; justify-content: center; margin-bottom: 24px;">',o+='<div class="billing-toggle" style="display: inline-flex; align-items: center; background: #f3f4f6; border-radius: 50px; padding: 6px; gap: 4px;">',o+='<button type="button" class="billing-toggle-btn active" data-interval="monthly" style="padding: 10px 24px; border: none; background: white; border-radius: 50px; font-weight: 600; font-size: 14px; cursor: pointer; color: #1f2937; box-shadow: 0 2px 8px rgba(0,0,0,0.1); transition: all 0.3s ease;">'+a("monthly","Monthly")+"</button>",o+='<button type="button" class="billing-toggle-btn" data-interval="yearly" style="padding: 10px 24px; border: none; background: transparent; border-radius: 50px; font-weight: 600; font-size: 14px; cursor: pointer; color: #6b7280; transition: all 0.3s ease;">'+a("annual","Annual"),n>0&&(o+='<span style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; font-size: 10px; font-weight: 700; padding: 2px 8px; border-radius: 20px; margin-left: 6px; text-transform: uppercase;">'+a("save_percent","Save {$a}%").replace("{$a}",n)+"</span>"),o+="</button>",o+="</div></div>"),o+='<div id="plans-grid-container">',o+=s.buildPlansGrid(e.monthly_plans||[],"monthly"),o+="</div>",o+="</div>",i.fire({title:'<i class="fa fa-rocket" style="color: #2563eb;"></i> '+a("choose_your_plan","Choose Your Plan"),html:o,width:"95%",showCancelButton:!0,showConfirmButton:!1,cancelButtonText:a("cancel","Cancel"),cancelButtonColor:"#95a5a6",customClass:{popup:"plans-modal-popup"},didOpen:function(){s.initPlansModalHandlers()}})},buildPlansGrid:function(e,t){if(!e||0===e.length)return'<div style="text-align: center; padding: 40px; color: #6b7280;"><i class="fa fa-calendar-times-o fa-2x" style="margin-bottom: 10px;"></i><p>'+a("annual_plans_soon","Annual plans coming soon!")+"</p></div>";var n='<div class="plans-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 24px; max-width: 1000px; margin: 0 auto;">';return e.forEach((function(e){var o=e.is_current?"#10b981":e.is_popular?"#2563eb":"#e5e7eb",i=e.is_current?"linear-gradient(135deg, #f0fdf4 0%, #ecfdf5 100%)":"white";if(n+='<div class="plan-card" style="background: '+i+"; border: 2px solid "+o+'; border-radius: 16px; padding: 28px 24px; position: relative; transition: all 0.3s ease; display: flex; flex-direction: column;">',e.is_current?n+='<div style="position: absolute; top: -12px; left: 50%; transform: translateX(-50%); background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; font-size: 11px; font-weight: 700; padding: 5px 14px; border-radius: 20px; text-transform: uppercase; letter-spacing: 0.5px;">'+a("current_plan","Current Plan")+"</div>":e.is_popular&&(n+='<div style="position: absolute; top: -12px; left: 50%; transform: translateX(-50%); background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%); color: white; font-size: 11px; font-weight: 700; padding: 5px 14px; border-radius: 20px; text-transform: uppercase; letter-spacing: 0.5px;">'+a("most_popular","Most Popular")+"</div>"),n+='<div style="text-align: center; margin-bottom: 20px; padding-top: 8px;">',n+='<div style="font-size: 22px; font-weight: 700; color: #1f2937; margin-bottom: 8px;">'+e.short_name+"</div>",e.description&&(n+='<div style="color: #6b7280; font-size: 13px; line-height: 1.5;">'+e.description+"</div>"),n+="</div>",n+='<div style="text-align: center; margin-bottom: 24px; padding-bottom: 24px; border-bottom: 1px solid #e5e7eb;">',e.is_free)n+='<div style="font-size: 42px; font-weight: 800; color: #10b981;">'+a("free","Free")+"</div>",n+='<div style="color: #6b7280; font-size: 13px;">'+a("forever","Forever")+"</div>";else{n+='<div style="font-size: 42px; font-weight: 800; color: #1f2937;">'+e.price_formatted+"</div>";var r="yearly"===t?a("per_year","per year"):a("per_month","per month");n+='<div style="color: #6b7280; font-size: 13px;">'+r+"</div>",e.has_savings&&(n+='<div style="margin-top: 6px;"><span style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; font-size: 11px; font-weight: 700; padding: 3px 10px; border-radius: 20px;">'+a("save_percent","Save {$a}%").replace("{$a}",e.savings_percent)+"</span></div>")}if(n+="</div>",n+='<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid #e5e7eb;">',n+='<div style="text-align: center; padding: 12px; background: #f9fafb; border-radius: 10px;"><div style="font-size: 16px; font-weight: 700; color: #1f2937;">'+e.tokens_limit+'</div><div style="font-size: 11px; color: #6b7280; text-transform: uppercase; letter-spacing: 0.5px;">'+a("ai_tokens","AI Tokens")+"</div></div>",n+='<div style="text-align: center; padding: 12px; background: #f9fafb; border-radius: 10px;"><div style="font-size: 16px; font-weight: 700; color: #1f2937;">'+e.exports_limit+'</div><div style="font-size: 11px; color: #6b7280; text-transform: uppercase; letter-spacing: 0.5px;">'+a("exports_mo","Exports/mo")+"</div></div>",n+='<div style="text-align: center; padding: 12px; background: #f9fafb; border-radius: 10px;"><div style="font-size: 16px; font-weight: 700; color: #1f2937;">'+e.reports_limit+'</div><div style="font-size: 11px; color: #6b7280; text-transform: uppercase; letter-spacing: 0.5px;">'+a("saved_reports","Saved Reports")+"</div></div>",n+='<div style="text-align: center; padding: 12px; background: #f9fafb; border-radius: 10px;"><div style="font-size: 16px; font-weight: 700; color: #1f2937;">'+e.export_formats+'</div><div style="font-size: 11px; color: #6b7280; text-transform: uppercase; letter-spacing: 0.5px;">'+a("formats","Formats")+"</div></div>",n+="</div>",e.features&&e.features.length>0&&(n+='<div style="flex: 1; margin-bottom: 20px;">',n+='<ul style="list-style: none; padding: 0; margin: 0;">',e.features.forEach((function(e){n+='<li style="display: flex; align-items: flex-start; gap: 10px; padding: 8px 0; color: #374151; font-size: 13px; line-height: 1.4;"><i class="fa fa-check" style="color: #10b981; font-size: 12px; margin-top: 3px; flex-shrink: 0;"></i> '+e+"</li>"})),n+="</ul></div>"),n+='<div style="margin-top: auto;">',e.is_current)n+='<button class="plan-select-btn" disabled style="display: block; width: 100%; padding: 14px; border: none; border-radius: 10px; background: #e5e7eb; color: #6b7280; font-weight: 600; font-size: 14px; cursor: default;"><i class="fa fa-check-circle"></i> '+a("current_plan","Current Plan")+"</button>";else if(e.is_free)n+='<button class="plan-select-btn" disabled style="display: block; width: 100%; padding: 14px; border: 2px solid #e5e7eb; border-radius: 10px; background: white; color: #374151; font-weight: 600; font-size: 14px; cursor: default;">'+a("free_plan","Free Plan")+"</button>";else{var s=e.stripe_price_id||"",l=e.stripe_configured||!1;n+='<button class="plan-select-btn" data-plan-id="'+(e.id||"")+'" data-plan-name="'+e.short_name+'" data-stripe-price-id="'+s+'" data-stripe-configured="'+l+'" style="display: block; width: 100%; padding: 14px; border: none; border-radius: 10px; background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%); color: white; font-weight: 600; font-size: 14px; cursor: pointer; transition: all 0.3s ease;"><i class="fa fa-arrow-up"></i> '+a("upgrade_to","Upgrade to")+" "+e.short_name+"</button>"}n+="</div>",n+="</div>"})),n+="</div>"},initPlansModalHandlers:function(){document.querySelectorAll(".billing-toggle-btn").forEach((function(e){e.addEventListener("click",(function(){var e=this.getAttribute("data-interval");if(e!==s.currentInterval){document.querySelectorAll(".billing-toggle-btn").forEach((function(e){e.classList.remove("active"),e.style.background="transparent",e.style.color="#6b7280",e.style.boxShadow="none"})),this.classList.add("active"),this.style.background="white",this.style.color="#1f2937",this.style.boxShadow="0 2px 8px rgba(0,0,0,0.1)",s.currentInterval=e;var t=s.plansData[e]||[],n=document.getElementById("plans-grid-container");n&&(n.innerHTML=s.buildPlansGrid(t,e),s.initPlanButtonHandlers())}}))})),s.initPlanButtonHandlers()},initPlanButtonHandlers:function(){document.querySelectorAll(".plan-select-btn:not([disabled])").forEach((function(e){e.addEventListener("click",(function(){var e=this.getAttribute("data-plan-name"),t=this.getAttribute("data-plan-id"),n=this.getAttribute("data-stripe-price-id");"true"===this.getAttribute("data-stripe-configured")&&n?s.createCheckoutSession(t,n,e):s.openBillingPortalForUpgrade(e,t)})),e.addEventListener("mouseenter",(function(){this.style.transform="translateY(-2px)",this.style.boxShadow="0 8px 20px rgba(37, 99, 235, 0.3)"})),e.addEventListener("mouseleave",(function(){this.style.transform="translateY(0)",this.style.boxShadow="none"}))}))},openBillingPortalForUpgrade:function(e,n){i.fire({title:a("opening_billing_portal","Opening Billing Portal..."),html:"<p>"+a("preparing_upgrade","Preparing upgrade to {$a}...").replace("{$a}",e)+"</p>",allowOutsideClick:!1,showConfirmButton:!1,didOpen:function(){i.showLoading()}});var o={return_url:window.location.href,sesskey:M.cfg.sesskey};n&&(o.plan_id=n),t.call([{methodname:"report_adeptus_insights_create_billing_portal_session",args:o,done:function(t){if(t&&t.success&&t.portal_url)i.fire({icon:"success",title:a("redirecting","Redirecting..."),html:"<p>"+a("opening_billing","Opening billing portal...")+"</p>",timer:2e3,timerProgressBar:!0,showConfirmButton:!1,allowOutsideClick:!1}),setTimeout((function(){window.location.href=t.portal_url}),1e3);else{var n=t&&t.message||a("failed_open_billing","Failed to open billing portal.");-1!==n.indexOf("NO_STRIPE_CUSTOMER")||-1!==n.indexOf("payment_enabled")||-1!==n.indexOf("Stripe")?i.fire({icon:"info",title:a("upgrade_coming_soon","Upgrade Coming Soon"),html:"<p>"+a("online_payments_not_configured","Online payments are not yet configured for this installation.")+"</p><p>"+a("contact_admin","To upgrade to <strong>{$a}</strong>, please contact your administrator or email:").replace("{$a}",e)+'</p><p><a href="mailto:support@adeptus360.com?subject=Upgrade%20to%20'+e+'">support@adeptus360.com</a></p>',confirmButtonColor:"#2563eb",confirmButtonText:a("ok","OK")}):i.fire({icon:"error",title:a("billing_portal_error","Billing Portal Error"),text:n,confirmButtonColor:"#3085d6"})}},fail:function(e){i.fire({icon:"error",title:a("connection_error","Connection Error"),text:a("failed_open_billing","Failed to open billing portal. Please try again."),confirmButtonColor:"#3085d6"})}}])},createCheckoutSession:function(e,n,o){i.fire({title:a("preparing_checkout","Preparing Checkout..."),html:"<p>"+a("setting_up_payment","Setting up payment for {$a}...").replace("{$a}",o)+"</p>",allowOutsideClick:!1,showConfirmButton:!1,didOpen:function(){i.showLoading()}});var r=window.location.href,s={plan_id:parseInt(e),stripe_price_id:n,return_url:r,sesskey:M.cfg.sesskey};t.call([{methodname:"report_adeptus_insights_create_checkout_session",args:s,done:function(e){if(e&&e.success&&e.checkout_url)i.fire({icon:"success",title:a("redirecting_checkout","Redirecting to Checkout..."),html:"<p>"+a("redirect_complete_payment","You will be redirected to complete your payment.")+"</p>",timer:2e3,timerProgressBar:!0,showConfirmButton:!1,allowOutsideClick:!1}),setTimeout((function(){window.location.href=e.checkout_url}),1e3);else{var t=e&&e.message||a("failed_checkout","Failed to create checkout session.");"STRIPE_NOT_CONFIGURED"===(e&&e.error_code||"")?i.fire({icon:"info",title:a("payment_not_available","Payment Not Available"),html:"<p>"+a("stripe_not_configured","Stripe is not yet configured for the <strong>{$a}</strong> plan.").replace("{$a}",o)+"</p><p>"+a("contact_admin","Please contact your administrator or email:")+'</p><p><a href="mailto:support@adeptus360.com?subject=Upgrade%20to%20'+o+'">support@adeptus360.com</a></p>',confirmButtonColor:"#2563eb",confirmButtonText:a("ok","OK")}):i.fire({icon:"error",title:a("checkout_error","Checkout Error"),text:t,confirmButtonColor:"#3085d6"})}},fail:function(e){i.fire({icon:"error",title:a("connection_error","Connection Error"),text:a("failed_checkout","Failed to create checkout session. Please try again."),confirmButtonColor:"#3085d6"})}}])},handleSelectPlan:function(e,t,n){t?i.fire({icon:"info",title:a("subscribe_to","Subscribe to {$a}?").replace("{$a}",n),html:"<p>"+a("redirect_complete_subscription","You will be redirected to complete your subscription.")+"</p>",showCancelButton:!0,confirmButtonColor:"#3498db",cancelButtonColor:"#95a5a6",confirmButtonText:'<i class="fa fa-credit-card"></i> '+a("subscribe_to","Subscribe Now"),cancelButtonText:a("cancel","Cancel")}).then((function(e){e.isConfirmed&&s.createBillingPortalSession(t,"subscribe")})):i.fire({icon:"error",title:a("error","Error"),text:a("plan_id_not_available","Plan ID not available. Please try again."),confirmButtonColor:"#3085d6"})},handleRenewSubscription:function(){i.fire({icon:"success",title:a("renew_subscription","Renew Your Subscription?"),html:"<p>"+a("welcome_back_renew","Welcome back! Renew your subscription to regain access to all premium features.")+"</p>",showCancelButton:!0,confirmButtonColor:"#27ae60",cancelButtonColor:"#95a5a6",confirmButtonText:'<i class="fa fa-refresh"></i> '+a("renew_now","Renew Subscription"),cancelButtonText:a("not_now","Not Now")}).then((function(e){e.isConfirmed&&s.createBillingPortalSession(null,"renew")}))}};return s}));