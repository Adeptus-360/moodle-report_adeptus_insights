/**
 * Subscription management for Adeptus Insights plugin.
 *
 * Handles subscription plan selection, upgrades, downgrades, cancellations,
 * Stripe checkout integration, and billing portal access.
 *
 * @module     report_adeptus_insights/subscription
 * @package    report_adeptus_insights
 * @copyright  2026 Adeptus 360 <info@adeptus360.com>
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("report_adeptus_insights/subscription",["jquery","core/ajax","core/notification","core/str"],(function($,Ajax,Notification,Str){var Swal=window.Swal,strings={},getString=function(key,fallback){return strings[key]||fallback||key},Subscription={planId:0,subscriptionData:{},init:function(){var self=this;Str.get_strings([{key:"js_verifying_payment",component:"report_adeptus_insights"},{key:"js_verifying_payment_text",component:"report_adeptus_insights"},{key:"js_upgrade_successful",component:"report_adeptus_insights"},{key:"js_verification_issue",component:"report_adeptus_insights"},{key:"js_verification_issue_text",component:"report_adeptus_insights"},{key:"js_processing_payment",component:"report_adeptus_insights"},{key:"js_processing_payment_text",component:"report_adeptus_insights"},{key:"js_checkout_cancelled",component:"report_adeptus_insights"},{key:"js_checkout_cancelled_text",component:"report_adeptus_insights"},{key:"js_cancel_subscription_title",component:"report_adeptus_insights"},{key:"js_cancel_subscription_text",component:"report_adeptus_insights"},{key:"js_yes_cancel",component:"report_adeptus_insights"},{key:"js_upgrade_to",component:"report_adeptus_insights"},{key:"js_downgrade_to",component:"report_adeptus_insights"},{key:"js_choose_your_plan",component:"report_adeptus_insights"},{key:"js_redirecting",component:"report_adeptus_insights"},{key:"js_popup_blocked",component:"report_adeptus_insights"},{key:"js_popup_blocked_text",component:"report_adeptus_insights"},{key:"js_portal_creation_failed",component:"report_adeptus_insights"},{key:"js_connection_error",component:"report_adeptus_insights"},{key:"js_preparing_checkout",component:"report_adeptus_insights"},{key:"js_redirecting_checkout",component:"report_adeptus_insights"},{key:"js_upgrade_coming_soon",component:"report_adeptus_insights"},{key:"js_billing_portal_error",component:"report_adeptus_insights"},{key:"js_opening_billing_portal",component:"report_adeptus_insights"},{key:"js_loading_plans",component:"report_adeptus_insights"},{key:"js_continue",component:"report_adeptus_insights"},{key:"error",component:"report_adeptus_insights"},{key:"cancel",component:"report_adeptus_insights"},{key:"js_ok",component:"report_adeptus_insights"},{key:"js_plan_id_not_available",component:"report_adeptus_insights"},{key:"js_failed_billing_portal",component:"report_adeptus_insights"},{key:"js_failed_load_plans",component:"report_adeptus_insights"},{key:"js_failed_open_billing",component:"report_adeptus_insights"},{key:"js_failed_checkout",component:"report_adeptus_insights"},{key:"js_payment_not_available",component:"report_adeptus_insights"},{key:"js_checkout_error",component:"report_adeptus_insights"},{key:"js_subscribe_to",component:"report_adeptus_insights"},{key:"js_renew_subscription",component:"report_adeptus_insights"},{key:"js_keep_subscription",component:"report_adeptus_insights"},{key:"js_yes_cancel_subscription",component:"report_adeptus_insights"},{key:"js_monthly",component:"report_adeptus_insights"},{key:"js_annual",component:"report_adeptus_insights"},{key:"js_current_plan",component:"report_adeptus_insights"},{key:"js_most_popular",component:"report_adeptus_insights"},{key:"js_free",component:"report_adeptus_insights"},{key:"js_forever",component:"report_adeptus_insights"},{key:"js_per_year",component:"report_adeptus_insights"},{key:"js_per_month",component:"report_adeptus_insights"},{key:"js_save_percent",component:"report_adeptus_insights"},{key:"js_ai_tokens",component:"report_adeptus_insights"},{key:"js_exports_mo",component:"report_adeptus_insights"},{key:"js_saved_reports",component:"report_adeptus_insights"},{key:"js_formats",component:"report_adeptus_insights"},{key:"js_free_plan",component:"report_adeptus_insights"},{key:"js_annual_plans_soon",component:"report_adeptus_insights"},{key:"js_upgrade",component:"report_adeptus_insights"},{key:"js_downgrade",component:"report_adeptus_insights"},{key:"js_upgrade_redirect_text",component:"report_adeptus_insights"},{key:"js_downgrade_redirect_text",component:"report_adeptus_insights"},{key:"js_downgrade_features_text",component:"report_adeptus_insights"},{key:"js_action_undone",component:"report_adeptus_insights"},{key:"js_opening_billing_portal_new_window",component:"report_adeptus_insights"},{key:"js_open_portal_manually",component:"report_adeptus_insights"},{key:"js_current_subscription",component:"report_adeptus_insights"},{key:"js_plan_label",component:"report_adeptus_insights"},{key:"js_status_label",component:"report_adeptus_insights"},{key:"js_cancelled_access_ends",component:"report_adeptus_insights"},{key:"js_payment_failed_attempts",component:"report_adeptus_insights"},{key:"js_next_billing",component:"report_adeptus_insights"},{key:"js_api_access_disabled",component:"report_adeptus_insights"},{key:"js_update_payment_restore",component:"report_adeptus_insights"},{key:"js_subscription_cancelled_reactivate",component:"report_adeptus_insights"},{key:"js_preparing_upgrade",component:"report_adeptus_insights"},{key:"js_opening_billing",component:"report_adeptus_insights"},{key:"js_online_payments_not_configured",component:"report_adeptus_insights"},{key:"js_setting_up_payment",component:"report_adeptus_insights"},{key:"js_redirect_complete_payment",component:"report_adeptus_insights"},{key:"js_stripe_not_configured",component:"report_adeptus_insights"},{key:"js_contact_admin",component:"report_adeptus_insights"},{key:"js_redirect_complete_subscription",component:"report_adeptus_insights"},{key:"js_welcome_back_renew",component:"report_adeptus_insights"},{key:"js_not_now",component:"report_adeptus_insights"},{key:"js_renew_now",component:"report_adeptus_insights"}]).then((function(results){return strings={verifying_payment:results[0],verifying_payment_text:results[1],upgrade_successful:results[2],verification_issue:results[3],verification_issue_text:results[4],processing_payment:results[5],processing_payment_text:results[6],checkout_cancelled:results[7],checkout_cancelled_text:results[8],cancel_subscription_title:results[9],cancel_subscription_text:results[10],yes_cancel:results[11],upgrade_to:results[12],downgrade_to:results[13],choose_your_plan:results[14],redirecting:results[15],popup_blocked:results[16],popup_blocked_text:results[17],portal_creation_failed:results[18],connection_error:results[19],preparing_checkout:results[20],redirecting_checkout:results[21],upgrade_coming_soon:results[22],billing_portal_error:results[23],opening_billing_portal:results[24],loading_plans:results[25],continue_text:results[26],error:results[27],cancel:results[28],ok:results[29],plan_id_not_available:results[30],failed_billing_portal:results[31],failed_load_plans:results[32],failed_open_billing:results[33],failed_checkout:results[34],payment_not_available:results[35],checkout_error:results[36],subscribe_to:results[37],renew_subscription:results[38],keep_subscription:results[39],yes_cancel_subscription:results[40],monthly:results[41],annual:results[42],current_plan:results[43],most_popular:results[44],free:results[45],forever:results[46],per_year:results[47],per_month:results[48],save_percent:results[49],ai_tokens:results[50],exports_mo:results[51],saved_reports:results[52],formats:results[53],free_plan:results[54],annual_plans_soon:results[55],upgrade:results[56],downgrade:results[57],upgrade_redirect_text:results[58],downgrade_redirect_text:results[59],downgrade_features_text:results[60],action_undone:results[61],opening_billing_portal_new_window:results[62],open_portal_manually:results[63],current_subscription:results[64],plan_label:results[65],status_label:results[66],cancelled_access_ends:results[67],payment_failed_attempts:results[68],next_billing:results[69],api_access_disabled:results[70],update_payment_restore:results[71],subscription_cancelled_reactivate:results[72],preparing_upgrade:results[73],opening_billing:results[74],online_payments_not_configured:results[75],setting_up_payment:results[76],redirect_complete_payment:results[77],stripe_not_configured:results[78],contact_admin:results[79],redirect_complete_subscription:results[80],welcome_back_renew:results[81],not_now:results[82],renew_now:results[83]}})).then((function(){self._initAfterStrings()})).catch((function(){self._initAfterStrings()}))},_initAfterStrings:function(){this.initProgressBars(),this.initEventHandlers(),this.checkForCheckoutSuccess(),this.updateSubscriptionDisplay()},initProgressBars:function(){$(".adeptus-progress-fill[data-width]").each((function(){var width=$(this).data("width")||0;$(this).css("width",width+"%")}))},checkForCheckoutSuccess:function(){var urlParams=new URLSearchParams(window.location.search),checkoutStatus=urlParams.get("checkout"),sessionId=urlParams.get("session_id");if("success"===checkoutStatus&&sessionId){Swal.fire({title:getString("verifying_payment","Verifying Payment..."),html:"<p>"+getString("verifying_payment_text","Please wait while we confirm your subscription upgrade.")+"</p>",allowOutsideClick:!1,showConfirmButton:!1,didOpen:function(){Swal.showLoading()}}),Ajax.call([{methodname:"report_adeptus_insights_verify_checkout_session",args:{session_id:sessionId,sesskey:M.cfg.sesskey},done:function(response){if(response&&response.success){var planName=response.plan_name||"Pro";Swal.fire({icon:"success",title:getString("upgrade_successful","Upgrade Successful!"),html:"<p>"+getString("upgrade_successful_text","Your subscription has been upgraded to <strong>"+planName+"</strong>. Your new features are now available.").replace("{$a}","<strong>"+planName+"</strong>")+"</p>",confirmButtonColor:"#2563eb",confirmButtonText:getString("continue_text","Continue")}).then((function(){var cleanUrl=window.location.href.split("?")[0];window.location.href=cleanUrl}))}else Swal.fire({icon:"warning",title:getString("verification_issue","Verification Issue"),html:"<p>"+(response.message||"Could not verify payment.")+"</p><p>"+getString("verification_issue_text","If you completed payment, your subscription will be updated shortly.")+"</p>",confirmButtonColor:"#2563eb"})},fail:function(){Swal.fire({icon:"info",title:getString("processing_payment","Processing Payment"),html:"<p>"+getString("processing_payment_text","Your payment is being processed. Your subscription will be updated within a few minutes.")+"</p>",confirmButtonColor:"#2563eb"})}}]);var cleanUrl=window.location.href.split("?")[0];window.history.replaceState({},document.title,cleanUrl)}else if("cancelled"===checkoutStatus){Swal.fire({icon:"info",title:getString("checkout_cancelled","Checkout Cancelled"),text:getString("checkout_cancelled_text","Your checkout was cancelled. No charges were made."),confirmButtonColor:"#2563eb"});var cancelUrl=window.location.href.split("?")[0];window.history.replaceState({},document.title,cancelUrl)}},initEventHandlers:function(){$(document).on("click",".btn-upgrade-plan, #upgrade-plan",(function(e){e.preventDefault(),Subscription.handleUpgradeFromFree()})),$(document).on("click",".btn-downgrade-plan",(function(e){e.preventDefault(),Subscription.handleDowngradePlan($(this))})),$(document).on("click",".btn-cancel-subscription, #cancel-subscription",(function(e){e.preventDefault(),Subscription.handleCancelSubscription($(this))})),$(document).on("click",".btn-billing-portal",(function(e){e.preventDefault(),Subscription.openBillingPortal()})),$(document).on("click",".btn-modify-subscription, #modify-subscription",(function(e){e.preventDefault(),Subscription.openBillingPortal()})),$(document).on("click",".btn-view-plans, #view-plans",(function(e){e.preventDefault(),Subscription.openBillingPortal()})),$(document).on("click",".select-plan-btn",(function(e){e.preventDefault();var planId=$(this).data("plan-id"),planName=$(this).data("plan-name");Subscription.handleSelectPlan($(this),planId,planName)})),$(document).on("click","#renew-subscription",(function(e){e.preventDefault(),Subscription.handleRenewSubscription()})),$(document).on("click","#update-payment",(function(e){e.preventDefault(),Subscription.openBillingPortal()}))},handleUpgradePlan:function($button){var planId=$button.data("plan-id"),planName=$button.data("plan-name");planId?Swal.fire({icon:"question",title:getString("upgrade_to","Upgrade to {$a}?").replace("{$a}",planName),html:"<p>"+getString("upgrade_redirect_text","You will be redirected to the billing portal to complete the upgrade.")+"</p>",showCancelButton:!0,confirmButtonColor:"#f39c12",cancelButtonColor:"#95a5a6",confirmButtonText:'<i class="fa fa-arrow-up"></i> '+getString("upgrade","Upgrade"),cancelButtonText:getString("cancel","Cancel")}).then((function(result){result.isConfirmed&&Subscription.createBillingPortalSession(planId,"upgrade")})):Swal.fire({icon:"error",title:getString("error","Error"),text:getString("plan_id_not_available","Plan ID not available. Please try again."),confirmButtonColor:"#3085d6"})},handleDowngradePlan:function($button){var planId=$button.data("plan-id"),planName=$button.data("plan-name");planId?Swal.fire({icon:"warning",title:getString("downgrade_to","Downgrade to {$a}?").replace("{$a}",planName),html:"<p>"+getString("downgrade_redirect_text","You will be redirected to the billing portal to complete the downgrade.")+'</p><p class="text-muted"><small>'+getString("downgrade_features_text","Your current plan features will remain active until the end of the billing period.")+"</small></p>",showCancelButton:!0,confirmButtonColor:"#17a2b8",cancelButtonColor:"#95a5a6",confirmButtonText:'<i class="fa fa-arrow-down"></i> '+getString("downgrade","Downgrade"),cancelButtonText:getString("cancel","Cancel")}).then((function(result){result.isConfirmed&&Subscription.createBillingPortalSession(planId,"downgrade")})):Swal.fire({icon:"error",title:getString("error","Error"),text:getString("plan_id_not_available","Plan ID not available. Please try again."),confirmButtonColor:"#3085d6"})},handleCancelSubscription:function(){Swal.fire({icon:"warning",title:getString("cancel_subscription_title","Cancel Subscription?"),html:"<p><strong>"+getString("cancel_subscription_text","Are you sure you want to cancel your subscription? You will lose access to premium features at the end of your billing period.")+'</strong></p><p class="text-danger"><small>'+getString("action_undone","This action cannot be undone.")+"</small></p>",showCancelButton:!0,confirmButtonColor:"#e74c3c",cancelButtonColor:"#95a5a6",confirmButtonText:'<i class="fa fa-times"></i> '+getString("yes_cancel","Yes, cancel it"),cancelButtonText:getString("keep_subscription","Keep Subscription"),focusCancel:!0}).then((function(result){result.isConfirmed&&Subscription.createBillingPortalSession(null,"cancel")}))},openBillingPortal:function(){Subscription.createBillingPortalSession(Subscription.subscriptionData.plan_id,"modify")},createBillingPortalSession:function(planId,action){var data={return_url:window.location.href,sesskey:M.cfg.sesskey};planId&&"undefined"!==planId&&null!==planId&&(data.plan_id=planId),action&&"undefined"!==action&&null!==action&&(data.action=action),Ajax.call([{methodname:"report_adeptus_insights_create_billing_portal_session",args:data,done:function(response){response&&response.success&&response.portal_url?(Swal.fire({icon:"success",title:getString("redirecting","Redirecting..."),html:"<p>"+getString("opening_billing_portal_new_window","Opening billing portal in a new window...")+"</p>",timer:2e3,timerProgressBar:!0,showConfirmButton:!1,allowOutsideClick:!1,didOpen:function(){Swal.showLoading()}}),setTimeout((function(){var newWindow=window.open(response.portal_url,"_blank");newWindow&&!newWindow.closed&&void 0!==newWindow.closed||Swal.fire({icon:"warning",title:getString("popup_blocked","Popup Blocked"),html:"<p>"+getString("popup_blocked_text","Please allow popups for this site to access the billing portal.")+'</p><p><a href="'+response.portal_url+'" target="_blank" class="btn btn-primary">'+getString("open_portal_manually","Open Portal Manually")+"</a></p>",showConfirmButton:!0,confirmButtonText:getString("ok","OK")})}),1e3)):Swal.fire({icon:"error",title:getString("portal_creation_failed","Portal Creation Failed"),text:response&&response.message||getString("failed_billing_portal","Failed to create billing portal session. Please try again."),confirmButtonColor:"#3085d6"})},fail:function(){Swal.fire({icon:"error",title:getString("connection_error","Connection Error"),text:getString("failed_billing_portal","Failed to create billing portal session. Please check your connection and try again."),confirmButtonColor:"#3085d6"})}}])},updateSubscriptionDisplay:function(){Ajax.call([{methodname:"report_adeptus_insights_get_subscription_details",args:{},done:function(response){response.success&&response.data&&(Subscription.subscriptionData=response.data,Subscription.renderSubscriptionInfo(response.data))},fail:function(){}}])},renderSubscriptionInfo:function(subscriptionData){var $container=$(".subscription-info");if($container.length){var html='<div class="current-subscription">';html+="<h3>"+getString("current_subscription","Current Subscription")+"</h3>",html+='<div class="adeptus-subscription-details">',html+="<p><strong>"+getString("plan_label","Plan:")+"</strong> "+(subscriptionData.plan_name||"Unknown")+"</p>";var statusClass="text-success",statusText=subscriptionData.status||"Unknown";if(subscriptionData.should_disable_api_access?statusClass="text-danger":(subscriptionData.is_cancelled||subscriptionData.has_payment_issues)&&(statusClass="text-warning"),html+="<p><strong>"+getString("status_label","Status:")+'</strong> <span class="'+statusClass+'">'+statusText+"</span></p>",subscriptionData.status_message){var messageClass="text-muted";subscriptionData.should_disable_api_access?messageClass="text-danger":(subscriptionData.is_cancelled||subscriptionData.has_payment_issues)&&(messageClass="text-warning"),html+='<p class="'+messageClass+'"><small>'+subscriptionData.status_message+"</small></p>"}if(subscriptionData.cancel_at_period_end){var cancelDate=new Date(1e3*subscriptionData.current_period_end);html+='<p class="text-warning"><strong>'+getString("cancelled_access_ends","Cancelled: Access ends on {$a}").replace("{$a}",cancelDate.toLocaleDateString())+"</strong></p>"}if(subscriptionData.failed_payment_attempts>0&&(html+='<p class="text-danger"><strong>'+getString("payment_failed_attempts","Payment Failed: {$a} failed attempts").replace("{$a}",subscriptionData.failed_payment_attempts)+"</strong></p>"),subscriptionData.current_period_end){var endDate=new Date(1e3*subscriptionData.current_period_end);html+="<p><strong>"+getString("next_billing","Next billing:")+"</strong> "+endDate.toLocaleDateString()+"</p>"}html+="</div>",html+="</div>",$container.html(html),Subscription.updateApiAccessStatus(subscriptionData)}},updateApiAccessStatus:function(subscriptionData){var apiAccessDisabled=subscriptionData.should_disable_api_access||!1;"undefined"!=typeof window&&(window.adeptusApiAccessDisabled=apiAccessDisabled,window.adeptusSubscriptionStatus=subscriptionData),apiAccessDisabled?($(".btn-send-message, .btn-generate-report, .btn-ai-assistant").prop("disabled",!0).attr("title",getString("api_access_disabled","API access disabled")+": "+(subscriptionData.status_message||"")),this.showApiAccessWarning(subscriptionData)):($(".btn-send-message, .btn-generate-report, .btn-ai-assistant").prop("disabled",!1).removeAttr("title"),this.hideApiAccessWarning())},showApiAccessWarning:function(subscriptionData){if(!$(".api-access-warning").length){var warningHtml='<div class="api-access-warning alert alert-danger alert-dismissible fade show" role="alert">';warningHtml+="<strong>"+getString("api_access_disabled","API Access Disabled")+"</strong><br>",warningHtml+=subscriptionData.status_message||"",subscriptionData.has_payment_issues?warningHtml+="<br><small>"+getString("update_payment_restore","Please update your payment method to restore access.")+"</small>":subscriptionData.is_cancelled&&(warningHtml+="<br><small>"+getString("subscription_cancelled_reactivate","Your subscription has been cancelled. Please reactivate to restore access.")+"</small>"),warningHtml+='<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>',warningHtml+="</div>",$("body").prepend(warningHtml)}},hideApiAccessWarning:function(){$(".api-access-warning").remove()},refresh:function(){this.updateSubscriptionDisplay()},plansData:null,currentInterval:"monthly",handleUpgradeFromFree:function(){Swal.fire({title:getString("loading_plans","Loading Plans..."),html:'<div style="padding: 20px;"><i class="fa fa-spinner fa-spin fa-2x"></i></div>',showConfirmButton:!1,allowOutsideClick:!1}),Ajax.call([{methodname:"report_adeptus_insights_get_available_plans",args:{}}])[0].done((function(result){var data=result.data?result.data:result;data.success&&(data.monthly_plans.length>0||data.yearly_plans.length>0)?(Subscription.plansData={monthly:data.monthly_plans||[],yearly:data.yearly_plans||[]},Subscription.currentInterval="monthly",Subscription.showPlansModal(data)):Swal.fire({icon:"error",title:getString("error","Error"),text:data.message||getString("failed_load_plans","Failed to load plans. Please try again."),confirmButtonColor:"#3085d6"})})).fail((function(){Swal.fire({icon:"error",title:getString("connection_error","Connection Error"),text:getString("failed_load_plans","Failed to load plans. Please check your connection and try again."),confirmButtonColor:"#3085d6"})}))},showPlansModal:function(data){var hasYearlyPlans=data.has_yearly_plans||!1,maxYearlySavings=data.max_yearly_savings||0,modalHtml='<div class="adeptus-plans-modal-container" style="text-align: left;">';hasYearlyPlans&&(modalHtml+='<div class="adeptus-billing-toggle-container" style="display: flex; justify-content: center; margin-bottom: 24px;">',modalHtml+='<div class="adeptus-billing-toggle" style="display: inline-flex; align-items: center; background: #f3f4f6; border-radius: 50px; padding: 6px; gap: 4px;">',modalHtml+='<button type="button" class="adeptus-billing-toggle-btn active" data-interval="monthly" style="padding: 10px 24px; border: none; background: white; border-radius: 50px; font-weight: 600; font-size: 14px; cursor: pointer; color: #1f2937; box-shadow: 0 2px 8px rgba(0,0,0,0.1); transition: all 0.3s ease;">'+getString("monthly","Monthly")+"</button>",modalHtml+='<button type="button" class="adeptus-billing-toggle-btn" data-interval="yearly" style="padding: 10px 24px; border: none; background: transparent; border-radius: 50px; font-weight: 600; font-size: 14px; cursor: pointer; color: #6b7280; transition: all 0.3s ease;">'+getString("annual","Annual"),maxYearlySavings>0&&(modalHtml+='<span style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; font-size: 10px; font-weight: 700; padding: 2px 8px; border-radius: 20px; margin-left: 6px; text-transform: uppercase;">'+getString("save_percent","Save {$a}%").replace("{$a}",maxYearlySavings)+"</span>"),modalHtml+="</button>",modalHtml+="</div></div>"),modalHtml+='<div id="plans-grid-container">',modalHtml+=Subscription.buildPlansGrid(data.monthly_plans||[],"monthly"),modalHtml+="</div>",modalHtml+="</div>",Swal.fire({title:'<i class="fa fa-rocket" style="color: #2563eb;"></i> '+getString("choose_your_plan","Choose Your Plan"),html:modalHtml,width:"95%",showCancelButton:!0,showConfirmButton:!1,cancelButtonText:getString("cancel","Cancel"),cancelButtonColor:"#95a5a6",customClass:{popup:"plans-modal-popup"},didOpen:function(){Subscription.initPlansModalHandlers()}})},buildPlansGrid:function(plans,interval){if(!plans||0===plans.length)return'<div style="text-align: center; padding: 40px; color: #6b7280;"><i class="fa fa-calendar-times-o fa-2x" style="margin-bottom: 10px;"></i><p>'+getString("annual_plans_soon","Annual plans coming soon!")+"</p></div>";var html='<div class="plans-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 24px; max-width: 1000px; margin: 0 auto;">';return plans.forEach((function(plan){var borderColor=plan.is_current?"#10b981":plan.is_popular?"#2563eb":"#e5e7eb",bgColor=plan.is_current?"linear-gradient(135deg, #f0fdf4 0%, #ecfdf5 100%)":"white";if(html+='<div class="adeptus-plan-card" style="background: '+bgColor+"; border: 2px solid "+borderColor+'; border-radius: 16px; padding: 28px 24px; position: relative; transition: all 0.3s ease; display: flex; flex-direction: column;">',plan.is_current?html+='<div style="position: absolute; top: -12px; left: 50%; transform: translateX(-50%); background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; font-size: 11px; font-weight: 700; padding: 5px 14px; border-radius: 20px; text-transform: uppercase; letter-spacing: 0.5px;">'+getString("current_plan","Current Plan")+"</div>":plan.is_popular&&(html+='<div style="position: absolute; top: -12px; left: 50%; transform: translateX(-50%); background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%); color: white; font-size: 11px; font-weight: 700; padding: 5px 14px; border-radius: 20px; text-transform: uppercase; letter-spacing: 0.5px;">'+getString("most_popular","Most Popular")+"</div>"),html+='<div style="text-align: center; margin-bottom: 20px; padding-top: 8px;">',html+='<div style="font-size: 22px; font-weight: 700; color: #1f2937; margin-bottom: 8px;">'+plan.short_name+"</div>",plan.description&&(html+='<div style="color: #6b7280; font-size: 13px; line-height: 1.5;">'+plan.description+"</div>"),html+="</div>",html+='<div style="text-align: center; margin-bottom: 24px; padding-bottom: 24px; border-bottom: 1px solid #e5e7eb;">',plan.is_free)html+='<div style="font-size: 42px; font-weight: 800; color: #10b981;">'+getString("free","Free")+"</div>",html+='<div style="color: #6b7280; font-size: 13px;">'+getString("forever","Forever")+"</div>";else{html+='<div style="font-size: 42px; font-weight: 800; color: #1f2937;">'+plan.price_formatted+"</div>";var periodText="yearly"===interval?getString("per_year","per year"):getString("per_month","per month");html+='<div style="color: #6b7280; font-size: 13px;">'+periodText+"</div>",plan.has_savings&&(html+='<div style="margin-top: 6px;"><span style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; font-size: 11px; font-weight: 700; padding: 3px 10px; border-radius: 20px;">'+getString("save_percent","Save {$a}%").replace("{$a}",plan.savings_percent)+"</span></div>")}if(html+="</div>",html+='<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid #e5e7eb;">',html+='<div style="text-align: center; padding: 12px; background: #f9fafb; border-radius: 10px;"><div style="font-size: 16px; font-weight: 700; color: #1f2937;">'+plan.tokens_limit+'</div><div style="font-size: 11px; color: #6b7280; text-transform: uppercase; letter-spacing: 0.5px;">'+getString("ai_tokens","AI Tokens")+"</div></div>",html+='<div style="text-align: center; padding: 12px; background: #f9fafb; border-radius: 10px;"><div style="font-size: 16px; font-weight: 700; color: #1f2937;">'+plan.exports_limit+'</div><div style="font-size: 11px; color: #6b7280; text-transform: uppercase; letter-spacing: 0.5px;">'+getString("exports_mo","Exports/mo")+"</div></div>",html+='<div style="text-align: center; padding: 12px; background: #f9fafb; border-radius: 10px;"><div style="font-size: 16px; font-weight: 700; color: #1f2937;">'+plan.reports_limit+'</div><div style="font-size: 11px; color: #6b7280; text-transform: uppercase; letter-spacing: 0.5px;">'+getString("saved_reports","Saved Reports")+"</div></div>",html+='<div style="text-align: center; padding: 12px; background: #f9fafb; border-radius: 10px;"><div style="font-size: 16px; font-weight: 700; color: #1f2937;">'+plan.export_formats+'</div><div style="font-size: 11px; color: #6b7280; text-transform: uppercase; letter-spacing: 0.5px;">'+getString("formats","Formats")+"</div></div>",html+="</div>",plan.features&&plan.features.length>0&&(html+='<div style="flex: 1; margin-bottom: 20px;">',html+='<ul style="list-style: none; padding: 0; margin: 0;">',plan.features.forEach((function(feature){html+='<li style="display: flex; align-items: flex-start; gap: 10px; padding: 8px 0; color: #374151; font-size: 13px; line-height: 1.4;"><i class="fa fa-check" style="color: #10b981; font-size: 12px; margin-top: 3px; flex-shrink: 0;"></i> '+feature+"</li>"})),html+="</ul></div>"),html+='<div style="margin-top: auto;">',plan.is_current)html+='<button class="adeptus-plan-select-btn" disabled style="display: block; width: 100%; padding: 14px; border: none; border-radius: 10px; background: #e5e7eb; color: #6b7280; font-weight: 600; font-size: 14px; cursor: default;"><i class="fa fa-check-circle"></i> '+getString("current_plan","Current Plan")+"</button>";else if(plan.is_free)html+='<button class="adeptus-plan-select-btn" disabled style="display: block; width: 100%; padding: 14px; border: 2px solid #e5e7eb; border-radius: 10px; background: white; color: #374151; font-weight: 600; font-size: 14px; cursor: default;">'+getString("free_plan","Free Plan")+"</button>";else{var stripePriceId=plan.stripe_price_id||"",stripeConfigured=plan.stripe_configured||!1;html+='<button class="adeptus-plan-select-btn" data-plan-id="'+(plan.id||"")+'" data-plan-name="'+plan.short_name+'" data-stripe-price-id="'+stripePriceId+'" data-stripe-configured="'+stripeConfigured+'" style="display: block; width: 100%; padding: 14px; border: none; border-radius: 10px; background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%); color: white; font-weight: 600; font-size: 14px; cursor: pointer; transition: all 0.3s ease;"><i class="fa fa-arrow-up"></i> '+getString("upgrade_to","Upgrade to")+" "+plan.short_name+"</button>"}html+="</div>",html+="</div>"})),html+="</div>"},initPlansModalHandlers:function(){document.querySelectorAll(".adeptus-billing-toggle-btn").forEach((function(btn){btn.addEventListener("click",(function(){var interval=this.getAttribute("data-interval");if(interval!==Subscription.currentInterval){document.querySelectorAll(".adeptus-billing-toggle-btn").forEach((function(b){b.classList.remove("active"),b.style.background="transparent",b.style.color="#6b7280",b.style.boxShadow="none"})),this.classList.add("active"),this.style.background="white",this.style.color="#1f2937",this.style.boxShadow="0 2px 8px rgba(0,0,0,0.1)",Subscription.currentInterval=interval;var plans=Subscription.plansData[interval]||[],container=document.getElementById("plans-grid-container");container&&(container.innerHTML=Subscription.buildPlansGrid(plans,interval),Subscription.initPlanButtonHandlers())}}))})),Subscription.initPlanButtonHandlers()},initPlanButtonHandlers:function(){document.querySelectorAll(".adeptus-plan-select-btn:not([disabled])").forEach((function(btn){btn.addEventListener("click",(function(){var planName=this.getAttribute("data-plan-name"),planId=this.getAttribute("data-plan-id"),stripePriceId=this.getAttribute("data-stripe-price-id");"true"===this.getAttribute("data-stripe-configured")&&stripePriceId?Subscription.createCheckoutSession(planId,stripePriceId,planName):Subscription.openBillingPortalForUpgrade(planName,planId)})),btn.addEventListener("mouseenter",(function(){this.style.transform="translateY(-2px)",this.style.boxShadow="0 8px 20px rgba(37, 99, 235, 0.3)"})),btn.addEventListener("mouseleave",(function(){this.style.transform="translateY(0)",this.style.boxShadow="none"}))}))},openBillingPortalForUpgrade:function(planName,planId){Swal.fire({title:getString("opening_billing_portal","Opening Billing Portal..."),html:"<p>"+getString("preparing_upgrade","Preparing upgrade to {$a}...").replace("{$a}",planName)+"</p>",allowOutsideClick:!1,showConfirmButton:!1,didOpen:function(){Swal.showLoading()}});var args={return_url:window.location.href,sesskey:M.cfg.sesskey};planId&&(args.plan_id=planId),Ajax.call([{methodname:"report_adeptus_insights_create_billing_portal_session",args:args,done:function(response){if(response&&response.success&&response.portal_url)Swal.fire({icon:"success",title:getString("redirecting","Redirecting..."),html:"<p>"+getString("opening_billing","Opening billing portal...")+"</p>",timer:2e3,timerProgressBar:!0,showConfirmButton:!1,allowOutsideClick:!1}),setTimeout((function(){window.location.href=response.portal_url}),1e3);else{var errorMessage=response&&response.message||getString("failed_open_billing","Failed to open billing portal.");-1!==errorMessage.indexOf("NO_STRIPE_CUSTOMER")||-1!==errorMessage.indexOf("payment_enabled")||-1!==errorMessage.indexOf("Stripe")?Swal.fire({icon:"info",title:getString("upgrade_coming_soon","Upgrade Coming Soon"),html:"<p>"+getString("online_payments_not_configured","Online payments are not yet configured for this installation.")+"</p><p>"+getString("contact_admin","To upgrade to <strong>{$a}</strong>, please contact your administrator or email:").replace("{$a}",planName)+'</p><p><a href="mailto:support@adeptus360.com?subject=Upgrade%20to%20'+planName+'">support@adeptus360.com</a></p>',confirmButtonColor:"#2563eb",confirmButtonText:getString("ok","OK")}):Swal.fire({icon:"error",title:getString("billing_portal_error","Billing Portal Error"),text:errorMessage,confirmButtonColor:"#3085d6"})}},fail:function(){Swal.fire({icon:"error",title:getString("connection_error","Connection Error"),text:getString("failed_open_billing","Failed to open billing portal. Please try again."),confirmButtonColor:"#3085d6"})}}])},createCheckoutSession:function(planId,stripePriceId,planName){Swal.fire({title:getString("preparing_checkout","Preparing Checkout..."),html:"<p>"+getString("setting_up_payment","Setting up payment for {$a}...").replace("{$a}",planName)+"</p>",allowOutsideClick:!1,showConfirmButton:!1,didOpen:function(){Swal.showLoading()}});var returnUrl=window.location.href,args={plan_id:parseInt(planId),stripe_price_id:stripePriceId,return_url:returnUrl,sesskey:M.cfg.sesskey};Ajax.call([{methodname:"report_adeptus_insights_create_checkout_session",args:args,done:function(response){if(response&&response.success&&response.checkout_url)Swal.fire({icon:"success",title:getString("redirecting_checkout","Redirecting to Checkout..."),html:"<p>"+getString("redirect_complete_payment","You will be redirected to complete your payment.")+"</p>",timer:2e3,timerProgressBar:!0,showConfirmButton:!1,allowOutsideClick:!1}),setTimeout((function(){window.location.href=response.checkout_url}),1e3);else{var errorMessage=response&&response.message||getString("failed_checkout","Failed to create checkout session.");"STRIPE_NOT_CONFIGURED"===(response&&response.error_code||"")?Swal.fire({icon:"info",title:getString("payment_not_available","Payment Not Available"),html:"<p>"+getString("stripe_not_configured","Stripe is not yet configured for the <strong>{$a}</strong> plan.").replace("{$a}",planName)+"</p><p>"+getString("contact_admin","Please contact your administrator or email:")+'</p><p><a href="mailto:support@adeptus360.com?subject=Upgrade%20to%20'+planName+'">support@adeptus360.com</a></p>',confirmButtonColor:"#2563eb",confirmButtonText:getString("ok","OK")}):Swal.fire({icon:"error",title:getString("checkout_error","Checkout Error"),text:errorMessage,confirmButtonColor:"#3085d6"})}},fail:function(){Swal.fire({icon:"error",title:getString("connection_error","Connection Error"),text:getString("failed_checkout","Failed to create checkout session. Please try again."),confirmButtonColor:"#3085d6"})}}])},handleSelectPlan:function($button,planId,planName){planId?Swal.fire({icon:"info",title:getString("subscribe_to","Subscribe to {$a}?").replace("{$a}",planName),html:"<p>"+getString("redirect_complete_subscription","You will be redirected to complete your subscription.")+"</p>",showCancelButton:!0,confirmButtonColor:"#3498db",cancelButtonColor:"#95a5a6",confirmButtonText:'<i class="fa fa-credit-card"></i> '+getString("subscribe_to","Subscribe Now"),cancelButtonText:getString("cancel","Cancel")}).then((function(result){result.isConfirmed&&Subscription.createBillingPortalSession(planId,"subscribe")})):Swal.fire({icon:"error",title:getString("error","Error"),text:getString("plan_id_not_available","Plan ID not available. Please try again."),confirmButtonColor:"#3085d6"})},handleRenewSubscription:function(){Swal.fire({icon:"success",title:getString("renew_subscription","Renew Your Subscription?"),html:"<p>"+getString("welcome_back_renew","Welcome back! Renew your subscription to regain access to all premium features.")+"</p>",showCancelButton:!0,confirmButtonColor:"#27ae60",cancelButtonColor:"#95a5a6",confirmButtonText:'<i class="fa fa-refresh"></i> '+getString("renew_now","Renew Subscription"),cancelButtonText:getString("not_now","Not Now")}).then((function(result){result.isConfirmed&&Subscription.createBillingPortalSession(null,"renew")}))}};return Subscription}));

//# sourceMappingURL=subscription.min.js.map