{"version":3,"file":"subscription.min.js","sources":["../src/subscription.js"],"sourcesContent":["// jshint ignore:start\ndefine(['jquery', 'core/ajax', 'core/notification'], function($, Ajax, Notification) {\n    'use strict';\n\n    var Swal = window.Swal;\n\n    /**\n     * Subscription management for Adeptus Insights plugin\n     */\n    var Subscription = {\n        planId: 0,\n        subscriptionData: {},\n        /**\n         * Initialize subscription functionality\n         */\n        init: function() {\n            // Initialize event handlers\n            this.initEventHandlers();\n\n            // Check for checkout success in URL\n            this.checkForCheckoutSuccess();\n\n            // Initialize subscription display\n            this.updateSubscriptionDisplay();\n        },\n\n        /**\n         * Check if returning from Stripe Checkout and verify the session\n         */\n        checkForCheckoutSuccess: function() {\n            var urlParams = new URLSearchParams(window.location.search);\n            var checkoutStatus = urlParams.get('checkout');\n            var sessionId = urlParams.get('session_id');\n\n            if (checkoutStatus === 'success' && sessionId) {\n                console.log('[Subscription] Checkout success detected, verifying session:', sessionId);\n\n                // Show loading\n                Swal.fire({\n                    title: 'Verifying Payment...',\n                    html: '<p>Please wait while we confirm your subscription upgrade.</p>',\n                    allowOutsideClick: false,\n                    showConfirmButton: false,\n                    didOpen: function() {\n                        Swal.showLoading();\n                    }\n                });\n\n                // Call verification endpoint\n                Ajax.call([{\n                    methodname: 'report_adeptus_insights_verify_checkout_session',\n                    args: {\n                        session_id: sessionId,\n                        sesskey: M.cfg.sesskey\n                    },\n                    done: function(response) {\n                        console.log('[Subscription] Verification response:', response);\n\n                        if (response && response.success) {\n                            Swal.fire({\n                                icon: 'success',\n                                title: 'Upgrade Successful!',\n                                html: '<p>Your subscription has been upgraded to <strong>' +\n                                      (response.plan_name || 'Pro') + '</strong>.</p>' +\n                                      '<p>Your new features are now available.</p>',\n                                confirmButtonColor: '#2563eb',\n                                confirmButtonText: 'Continue'\n                            }).then(function() {\n                                // Clean URL and refresh to show new plan\n                                var cleanUrl = window.location.href.split('?')[0];\n                                window.location.href = cleanUrl;\n                            });\n                        } else {\n                            Swal.fire({\n                                icon: 'warning',\n                                title: 'Verification Issue',\n                                html: '<p>' + (response.message || 'Could not verify payment.') + '</p>' +\n                                      '<p>If you completed payment, your subscription will be updated shortly.</p>',\n                                confirmButtonColor: '#2563eb'\n                            });\n                        }\n                    },\n                    fail: function(error) {\n                        console.error('[Subscription] Verification failed:', error);\n                        Swal.fire({\n                            icon: 'info',\n                            title: 'Processing Payment',\n                            html: '<p>Your payment is being processed.</p>' +\n                                  '<p>Your subscription will be updated within a few minutes.</p>',\n                            confirmButtonColor: '#2563eb'\n                        });\n                    }\n                }]);\n\n                // Clean URL to remove checkout params (without refresh)\n                var cleanUrl = window.location.href.split('?')[0];\n                window.history.replaceState({}, document.title, cleanUrl);\n\n            } else if (checkoutStatus === 'cancelled') {\n                console.log('[Subscription] Checkout was cancelled');\n                Swal.fire({\n                    icon: 'info',\n                    title: 'Checkout Cancelled',\n                    text: 'Your checkout was cancelled. No charges were made.',\n                    confirmButtonColor: '#2563eb'\n                });\n\n                // Clean URL\n                var cancelUrl = window.location.href.split('?')[0];\n                window.history.replaceState({}, document.title, cancelUrl);\n            }\n        },\n\n        /**\n         * Initialize event handlers\n         */\n        initEventHandlers: function() {\n            // Handle upgrade plan button - redirects to wizard for plan selection\n            $(document).on('click', '.btn-upgrade-plan, #upgrade-plan', function(e) {\n                e.preventDefault();\n                Subscription.handleUpgradeFromFree();\n            });\n\n            // Handle downgrade plan buttons (for paid plan users via billing portal)\n            $(document).on('click', '.btn-downgrade-plan', function(e) {\n                e.preventDefault();\n                Subscription.handleDowngradePlan($(this));\n            });\n\n            // Handle cancel subscription buttons\n            $(document).on('click', '.btn-cancel-subscription, #cancel-subscription', function(e) {\n                e.preventDefault();\n                Subscription.handleCancelSubscription($(this));\n            });\n\n            // Handle billing portal access\n            $(document).on('click', '.btn-billing-portal', function(e) {\n                e.preventDefault();\n                Subscription.openBillingPortal();\n            });\n\n            // Handle modify subscription button\n            $(document).on('click', '.btn-modify-subscription, #modify-subscription', function(e) {\n                e.preventDefault();\n                Subscription.openBillingPortal();\n            });\n\n            // Handle view plans button (open billing portal)\n            $(document).on('click', '.btn-view-plans, #view-plans', function(e) {\n                e.preventDefault();\n                Subscription.openBillingPortal();\n            });\n\n            // Handle select plan button (new subscriptions)\n            $(document).on('click', '.select-plan-btn', function(e) {\n                e.preventDefault();\n                var planId = $(this).data('plan-id');\n                var planName = $(this).data('plan-name');\n                Subscription.handleSelectPlan($(this), planId, planName);\n            });\n\n            // Handle renew subscription button\n            $(document).on('click', '#renew-subscription', function(e) {\n                e.preventDefault();\n                Subscription.handleRenewSubscription();\n            });\n\n            // Handle update payment button\n            $(document).on('click', '#update-payment', function(e) {\n                e.preventDefault();\n                Subscription.openBillingPortal();\n            });\n        },\n\n        /**\n         * Handle upgrade plan\n         */\n        handleUpgradePlan: function($button) {\n            var planId = $button.data('plan-id');\n            var planName = $button.data('plan-name');\n\n            if (!planId) {\n                console.error('[Subscription] No plan ID available');\n                Swal.fire({\n                    icon: 'error',\n                    title: 'Error',\n                    text: 'Plan ID not available. Please try again.',\n                    confirmButtonColor: '#3085d6'\n                });\n                return;\n            }\n\n            // Show confirmation dialog\n            Swal.fire({\n                icon: 'question',\n                title: 'Upgrade to ' + planName + '?',\n                html: '<p>You will be redirected to the billing portal to complete the upgrade.</p>',\n                showCancelButton: true,\n                confirmButtonColor: '#f39c12',\n                cancelButtonColor: '#95a5a6',\n                confirmButtonText: '<i class=\"fa fa-arrow-up\"></i> Upgrade',\n                cancelButtonText: 'Cancel'\n            }).then(function(result) {\n                if (result.isConfirmed) {\n                    Subscription.createBillingPortalSession(planId, 'upgrade');\n                }\n            });\n        },\n\n        /**\n         * Handle downgrade plan\n         */\n        handleDowngradePlan: function($button) {\n            var planId = $button.data('plan-id');\n            var planName = $button.data('plan-name');\n\n            if (!planId) {\n                console.error('[Subscription] No plan ID available');\n                Swal.fire({\n                    icon: 'error',\n                    title: 'Error',\n                    text: 'Plan ID not available. Please try again.',\n                    confirmButtonColor: '#3085d6'\n                });\n                return;\n            }\n\n            // Show confirmation dialog\n            Swal.fire({\n                icon: 'warning',\n                title: 'Downgrade to ' + planName + '?',\n                html: '<p>You will be redirected to the billing portal to complete the downgrade.</p>' +\n                      '<p class=\"text-muted\"><small>Your current plan features will remain active until the end of the billing period.</small></p>',\n                showCancelButton: true,\n                confirmButtonColor: '#17a2b8',\n                cancelButtonColor: '#95a5a6',\n                confirmButtonText: '<i class=\"fa fa-arrow-down\"></i> Downgrade',\n                cancelButtonText: 'Cancel'\n            }).then(function(result) {\n                if (result.isConfirmed) {\n                    Subscription.createBillingPortalSession(planId, 'downgrade');\n                }\n            });\n        },\n\n        /**\n         * Handle cancel subscription\n         */\n        handleCancelSubscription: function($button) {\n            Swal.fire({\n                icon: 'warning',\n                title: 'Cancel Subscription?',\n                html: '<p><strong>Are you sure you want to cancel your subscription?</strong></p>' +\n                      '<p>You will lose access to premium features at the end of your billing period.</p>' +\n                      '<p class=\"text-danger\"><small>This action cannot be undone.</small></p>',\n                showCancelButton: true,\n                confirmButtonColor: '#e74c3c',\n                cancelButtonColor: '#95a5a6',\n                confirmButtonText: '<i class=\"fa fa-times\"></i> Yes, Cancel Subscription',\n                cancelButtonText: 'Keep Subscription',\n                focusCancel: true\n            }).then(function(result) {\n                if (result.isConfirmed) {\n                    Subscription.createBillingPortalSession(null, 'cancel');\n                }\n            });\n        },\n\n        /**\n         * Open billing portal\n         */\n        openBillingPortal: function() {\n            Subscription.createBillingPortalSession(Subscription.subscriptionData.plan_id, 'modify');\n        },\n\n        /**\n         * Create billing portal session\n         */\n        createBillingPortalSession: function(planId, action) {\n            var returnUrl = window.location.href;\n            var data = {\n                return_url: returnUrl,\n                sesskey: M.cfg.sesskey\n            };\n\n            // Only add plan_id and action if they are defined and not null\n            if (planId && planId !== 'undefined' && planId !== null) {\n                data.plan_id = planId;\n            }\n\n            if (action && action !== 'undefined' && action !== null) {\n                data.action = action;\n            }\n\n            Ajax.call([{\n                methodname: 'report_adeptus_insights_create_billing_portal_session',\n                args: data,\n                done: function(response) {\n                    if (response && response.success && response.portal_url) {\n                        Swal.fire({\n                            icon: 'success',\n                            title: 'Redirecting...',\n                            html: '<p>Opening billing portal in a new window...</p>',\n                            timer: 2000,\n                            timerProgressBar: true,\n                            showConfirmButton: false,\n                            allowOutsideClick: false,\n                            didOpen: function() {\n                                Swal.showLoading();\n                            }\n                        });\n\n                        // Open in new tab\n                        setTimeout(function() {\n                            var newWindow = window.open(response.portal_url, '_blank');\n                            if (!newWindow || newWindow.closed || typeof newWindow.closed === 'undefined') {\n                                Swal.fire({\n                                    icon: 'warning',\n                                    title: 'Popup Blocked',\n                                    html: '<p>Please allow popups for this site and try again.</p>' +\n                                          '<p><a href=\"' + response.portal_url + '\" target=\"_blank\" class=\"btn btn-primary\">Open Portal Manually</a></p>',\n                                    showConfirmButton: true,\n                                    confirmButtonText: 'OK'\n                                });\n                            }\n                        }, 1000);\n                    } else {\n                        Swal.fire({\n                            icon: 'error',\n                            title: 'Portal Creation Failed',\n                            text: (response && response.message) || 'Failed to create billing portal session. Please try again.',\n                            confirmButtonColor: '#3085d6'\n                        });\n                    }\n                },\n                fail: function(error) {\n                    console.error('[Subscription] AJAX failed:', error);\n                    Swal.fire({\n                        icon: 'error',\n                        title: 'Connection Error',\n                        text: 'Failed to create billing portal session. Please check your connection and try again.',\n                        confirmButtonColor: '#3085d6'\n                    });\n                }\n            }]);\n        },\n\n        /**\n         * Update subscription display\n         */\n        updateSubscriptionDisplay: function() {\n            // Get current subscription data\n            Ajax.call([{\n                methodname: 'report_adeptus_insights_get_subscription_details',\n                args: {},\n                done: function(response) {\n                    if (response.success && response.data) {\n                        Subscription.subscriptionData = response.data;\n                        Subscription.renderSubscriptionInfo(response.data);\n                    }\n                },\n                fail: function(error) {\n                    console.error('[Subscription] Failed to get subscription details:', error);\n                }\n            }]);\n        },\n\n        /**\n         * Render subscription information\n         */\n        renderSubscriptionInfo: function(subscriptionData) {\n            var $container = $('.subscription-info');\n            if (!$container.length) return;\n\n            var html = '<div class=\"current-subscription\">';\n            html += '<h3>Current Subscription</h3>';\n            html += '<div class=\"subscription-details\">';\n            html += '<p><strong>Plan:</strong> ' + (subscriptionData.plan_name || 'Unknown') + '</p>';\n\n            // Display status with appropriate styling and messaging\n            var statusClass = 'text-success';\n            var statusText = subscriptionData.status || 'Unknown';\n\n            if (subscriptionData.should_disable_api_access) {\n                statusClass = 'text-danger';\n            } else if (subscriptionData.is_cancelled) {\n                statusClass = 'text-warning';\n            } else if (subscriptionData.has_payment_issues) {\n                statusClass = 'text-warning';\n            }\n\n            html += '<p><strong>Status:</strong> <span class=\"' + statusClass + '\">' + statusText + '</span></p>';\n\n            // Display status message if available\n            if (subscriptionData.status_message) {\n                var messageClass = 'text-muted';\n                if (subscriptionData.should_disable_api_access) {\n                    messageClass = 'text-danger';\n                } else if (subscriptionData.is_cancelled || subscriptionData.has_payment_issues) {\n                    messageClass = 'text-warning';\n                }\n                html += '<p class=\"' + messageClass + '\"><small>' + subscriptionData.status_message + '</small></p>';\n            }\n\n            // Show cancellation info\n            if (subscriptionData.cancel_at_period_end) {\n                var cancelDate = new Date(subscriptionData.current_period_end * 1000);\n                html += '<p class=\"text-warning\"><strong>⚠️ Cancelled:</strong> Access ends on ' + cancelDate.toLocaleDateString() + '</p>';\n            }\n\n            // Show payment failure info\n            if (subscriptionData.failed_payment_attempts > 0) {\n                html += '<p class=\"text-danger\"><strong>❌ Payment Failed:</strong> ' + subscriptionData.failed_payment_attempts + ' failed attempts</p>';\n            }\n\n            if (subscriptionData.current_period_end) {\n                var endDate = new Date(subscriptionData.current_period_end * 1000);\n                html += '<p><strong>Next billing:</strong> ' + endDate.toLocaleDateString() + '</p>';\n            }\n\n            html += '</div>';\n            html += '</div>';\n\n            $container.html(html);\n\n            // Update API access status globally\n            Subscription.updateApiAccessStatus(subscriptionData);\n        },\n\n        /**\n         * Update API access status globally\n         */\n        updateApiAccessStatus: function(subscriptionData) {\n            var apiAccessDisabled = subscriptionData.should_disable_api_access || false;\n\n            // Store the status globally for other modules to check\n            if (typeof window !== 'undefined') {\n                window.adeptusApiAccessDisabled = apiAccessDisabled;\n                window.adeptusSubscriptionStatus = subscriptionData;\n            }\n\n            // Disable/enable API-dependent elements\n            if (apiAccessDisabled) {\n                $('.btn-send-message, .btn-generate-report, .btn-ai-assistant').prop('disabled', true)\n                    .attr('title', 'API access disabled: ' + (subscriptionData.status_message || 'Subscription issue'));\n\n                // Show warning message\n                this.showApiAccessWarning(subscriptionData);\n            } else {\n                $('.btn-send-message, .btn-generate-report, .btn-ai-assistant').prop('disabled', false)\n                    .removeAttr('title');\n\n                // Hide warning message\n                this.hideApiAccessWarning();\n            }\n        },\n\n        /**\n         * Show API access warning\n         */\n        showApiAccessWarning: function(subscriptionData) {\n            var $existingWarning = $('.api-access-warning');\n            if ($existingWarning.length) return;\n\n            var warningHtml = '<div class=\"api-access-warning alert alert-danger alert-dismissible fade show\" role=\"alert\">';\n            warningHtml += '<strong>⚠️ API Access Disabled</strong><br>';\n            warningHtml += subscriptionData.status_message || 'Your subscription has an issue that prevents API access.';\n\n            if (subscriptionData.has_payment_issues) {\n                warningHtml += '<br><small>Please update your payment method to restore access.</small>';\n            } else if (subscriptionData.is_cancelled) {\n                warningHtml += '<br><small>Your subscription has been cancelled. Please reactivate to restore access.</small>';\n            }\n\n            warningHtml += '<button type=\"button\" class=\"btn-close\" data-bs-dismiss=\"alert\" aria-label=\"Close\"></button>';\n            warningHtml += '</div>';\n\n            $('body').prepend(warningHtml);\n        },\n\n        /**\n         * Hide API access warning\n         */\n        hideApiAccessWarning: function() {\n            $('.api-access-warning').remove();\n        },\n\n        /**\n         * Refresh subscription data\n         */\n        refresh: function() {\n            this.updateSubscriptionDisplay();\n        },\n\n        /**\n         * Stored plans data for toggle switching\n         */\n        plansData: null,\n        currentInterval: 'monthly',\n\n        /**\n         * Handle upgrade from free plan\n         * Shows a modal with available plans\n         */\n        handleUpgradeFromFree: function() {\n            // Show loading state\n            Swal.fire({\n                title: 'Loading Plans...',\n                html: '<div style=\"padding: 20px;\"><i class=\"fa fa-spinner fa-spin fa-2x\"></i></div>',\n                showConfirmButton: false,\n                allowOutsideClick: false\n            });\n\n            // Fetch available plans\n            fetch(M.cfg.wwwroot + '/report/adeptus_insights/ajax/get_available_plans.php?sesskey=' + M.cfg.sesskey)\n                .then(function(response) { return response.json(); })\n                .then(function(data) {\n                    if (data.success && (data.monthly_plans.length > 0 || data.yearly_plans.length > 0)) {\n                        // Store plans data for toggle switching\n                        Subscription.plansData = {\n                            monthly: data.monthly_plans || [],\n                            yearly: data.yearly_plans || []\n                        };\n                        Subscription.currentInterval = 'monthly';\n                        Subscription.showPlansModal(data);\n                    } else {\n                        Swal.fire({\n                            icon: 'error',\n                            title: 'Error',\n                            text: data.message || 'Failed to load plans. Please try again.',\n                            confirmButtonColor: '#3085d6'\n                        });\n                    }\n                })\n                .catch(function(error) {\n                    console.error('[Subscription] Error fetching plans:', error);\n                    Swal.fire({\n                        icon: 'error',\n                        title: 'Connection Error',\n                        text: 'Failed to load plans. Please check your connection and try again.',\n                        confirmButtonColor: '#3085d6'\n                    });\n                });\n        },\n\n        /**\n         * Show plans selection modal with monthly/yearly toggle\n         */\n        showPlansModal: function(data) {\n            var hasYearlyPlans = data.has_yearly_plans || false;\n            var maxYearlySavings = data.max_yearly_savings || 0;\n\n            // Build modal HTML with toggle\n            var modalHtml = '<div class=\"plans-modal-container\" style=\"text-align: left;\">';\n\n            // Billing toggle (only if yearly plans exist)\n            if (hasYearlyPlans) {\n                modalHtml += '<div class=\"billing-toggle-container\" style=\"display: flex; justify-content: center; margin-bottom: 24px;\">';\n                modalHtml += '<div class=\"billing-toggle\" style=\"display: inline-flex; align-items: center; background: #f3f4f6; border-radius: 50px; padding: 6px; gap: 4px;\">';\n                modalHtml += '<button type=\"button\" class=\"billing-toggle-btn active\" data-interval=\"monthly\" style=\"' +\n                    'padding: 10px 24px; border: none; background: white; border-radius: 50px; ' +\n                    'font-weight: 600; font-size: 14px; cursor: pointer; color: #1f2937; ' +\n                    'box-shadow: 0 2px 8px rgba(0,0,0,0.1); transition: all 0.3s ease;\">Monthly</button>';\n                modalHtml += '<button type=\"button\" class=\"billing-toggle-btn\" data-interval=\"yearly\" style=\"' +\n                    'padding: 10px 24px; border: none; background: transparent; border-radius: 50px; ' +\n                    'font-weight: 600; font-size: 14px; cursor: pointer; color: #6b7280; transition: all 0.3s ease;\">' +\n                    'Annual';\n                if (maxYearlySavings > 0) {\n                    modalHtml += '<span style=\"background: linear-gradient(135deg, #10b981 0%, #059669 100%); ' +\n                        'color: white; font-size: 10px; font-weight: 700; padding: 2px 8px; border-radius: 20px; ' +\n                        'margin-left: 6px; text-transform: uppercase;\">Save ' + maxYearlySavings + '%</span>';\n                }\n                modalHtml += '</button>';\n                modalHtml += '</div></div>';\n            }\n\n            // Plans grid container\n            modalHtml += '<div id=\"plans-grid-container\">';\n            modalHtml += Subscription.buildPlansGrid(data.monthly_plans || [], 'monthly');\n            modalHtml += '</div>';\n\n            modalHtml += '</div>';\n\n            Swal.fire({\n                title: '<i class=\"fa fa-rocket\" style=\"color: #2563eb;\"></i> Choose Your Plan',\n                html: modalHtml,\n                width: '95%',\n                showCancelButton: true,\n                showConfirmButton: false,\n                cancelButtonText: 'Cancel',\n                cancelButtonColor: '#95a5a6',\n                customClass: {\n                    popup: 'plans-modal-popup'\n                },\n                didOpen: function() {\n                    Subscription.initPlansModalHandlers();\n                }\n            });\n        },\n\n        /**\n         * Build plans grid HTML\n         */\n        buildPlansGrid: function(plans, interval) {\n            if (!plans || plans.length === 0) {\n                return '<div style=\"text-align: center; padding: 40px; color: #6b7280;\">' +\n                    '<i class=\"fa fa-calendar-times-o fa-2x\" style=\"margin-bottom: 10px;\"></i>' +\n                    '<p>Annual plans coming soon!</p></div>';\n            }\n\n            var html = '<div class=\"plans-grid\" style=\"display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 24px; max-width: 1000px; margin: 0 auto;\">';\n\n            plans.forEach(function(plan) {\n                var borderColor = plan.is_current ? '#10b981' : (plan.is_popular ? '#2563eb' : '#e5e7eb');\n                var bgColor = plan.is_current ? 'linear-gradient(135deg, #f0fdf4 0%, #ecfdf5 100%)' : 'white';\n\n                html += '<div class=\"plan-card\" style=\"' +\n                    'background: ' + bgColor + '; ' +\n                    'border: 2px solid ' + borderColor + '; ' +\n                    'border-radius: 16px; ' +\n                    'padding: 28px 24px; ' +\n                    'position: relative; ' +\n                    'transition: all 0.3s ease; ' +\n                    'display: flex; ' +\n                    'flex-direction: column;\">';\n\n                // Badge\n                if (plan.is_current) {\n                    html += '<div style=\"position: absolute; top: -12px; left: 50%; transform: translateX(-50%); ' +\n                        'background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; ' +\n                        'font-size: 11px; font-weight: 700; padding: 5px 14px; border-radius: 20px; ' +\n                        'text-transform: uppercase; letter-spacing: 0.5px;\">Current Plan</div>';\n                } else if (plan.is_popular) {\n                    html += '<div style=\"position: absolute; top: -12px; left: 50%; transform: translateX(-50%); ' +\n                        'background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%); color: white; ' +\n                        'font-size: 11px; font-weight: 700; padding: 5px 14px; border-radius: 20px; ' +\n                        'text-transform: uppercase; letter-spacing: 0.5px;\">Most Popular</div>';\n                }\n\n                // Header\n                html += '<div style=\"text-align: center; margin-bottom: 20px; padding-top: 8px;\">';\n                html += '<div style=\"font-size: 22px; font-weight: 700; color: #1f2937; margin-bottom: 8px;\">' +\n                    plan.short_name + '</div>';\n                if (plan.description) {\n                    html += '<div style=\"color: #6b7280; font-size: 13px; line-height: 1.5;\">' +\n                        plan.description + '</div>';\n                }\n                html += '</div>';\n\n                // Price\n                html += '<div style=\"text-align: center; margin-bottom: 24px; padding-bottom: 24px; border-bottom: 1px solid #e5e7eb;\">';\n                if (plan.is_free) {\n                    html += '<div style=\"font-size: 42px; font-weight: 800; color: #10b981;\">Free</div>';\n                    html += '<div style=\"color: #6b7280; font-size: 13px;\">Forever</div>';\n                } else {\n                    html += '<div style=\"font-size: 42px; font-weight: 800; color: #1f2937;\">' +\n                        plan.price_formatted + '</div>';\n                    var periodText = interval === 'yearly' ? 'per year' : 'per month';\n                    html += '<div style=\"color: #6b7280; font-size: 13px;\">' + periodText + '</div>';\n                    if (plan.has_savings) {\n                        html += '<div style=\"margin-top: 6px;\"><span style=\"background: linear-gradient(135deg, #10b981 0%, #059669 100%); ' +\n                            'color: white; font-size: 11px; font-weight: 700; padding: 3px 10px; border-radius: 20px;\">' +\n                            'Save ' + plan.savings_percent + '%</span></div>';\n                    }\n                }\n                html += '</div>';\n\n                // Limits - 4 items in 2x2 grid\n                html += '<div style=\"display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid #e5e7eb;\">';\n                html += '<div style=\"text-align: center; padding: 12px; background: #f9fafb; border-radius: 10px;\">' +\n                    '<div style=\"font-size: 16px; font-weight: 700; color: #1f2937;\">' + plan.tokens_limit + '</div>' +\n                    '<div style=\"font-size: 11px; color: #6b7280; text-transform: uppercase; letter-spacing: 0.5px;\">AI Tokens</div></div>';\n                html += '<div style=\"text-align: center; padding: 12px; background: #f9fafb; border-radius: 10px;\">' +\n                    '<div style=\"font-size: 16px; font-weight: 700; color: #1f2937;\">' + plan.exports_limit + '</div>' +\n                    '<div style=\"font-size: 11px; color: #6b7280; text-transform: uppercase; letter-spacing: 0.5px;\">Exports/mo</div></div>';\n                html += '<div style=\"text-align: center; padding: 12px; background: #f9fafb; border-radius: 10px;\">' +\n                    '<div style=\"font-size: 16px; font-weight: 700; color: #1f2937;\">' + plan.reports_limit + '</div>' +\n                    '<div style=\"font-size: 11px; color: #6b7280; text-transform: uppercase; letter-spacing: 0.5px;\">Saved Reports</div></div>';\n                html += '<div style=\"text-align: center; padding: 12px; background: #f9fafb; border-radius: 10px;\">' +\n                    '<div style=\"font-size: 16px; font-weight: 700; color: #1f2937;\">' + plan.export_formats + '</div>' +\n                    '<div style=\"font-size: 11px; color: #6b7280; text-transform: uppercase; letter-spacing: 0.5px;\">Formats</div></div>';\n                html += '</div>';\n\n                // Features list\n                if (plan.features && plan.features.length > 0) {\n                    html += '<div style=\"flex: 1; margin-bottom: 20px;\">';\n                    html += '<ul style=\"list-style: none; padding: 0; margin: 0;\">';\n                    plan.features.forEach(function(feature) {\n                        html += '<li style=\"display: flex; align-items: flex-start; gap: 10px; padding: 8px 0; ' +\n                            'color: #374151; font-size: 13px; line-height: 1.4;\">' +\n                            '<i class=\"fa fa-check\" style=\"color: #10b981; font-size: 12px; margin-top: 3px; flex-shrink: 0;\"></i> ' +\n                            feature + '</li>';\n                    });\n                    html += '</ul></div>';\n                }\n\n                // Action button\n                html += '<div style=\"margin-top: auto;\">';\n                if (plan.is_current) {\n                    html += '<button class=\"plan-select-btn\" disabled style=\"' +\n                        'display: block; width: 100%; padding: 14px; border: none; border-radius: 10px; ' +\n                        'background: #e5e7eb; color: #6b7280; font-weight: 600; font-size: 14px; cursor: default;\">' +\n                        '<i class=\"fa fa-check-circle\"></i> Current Plan</button>';\n                } else if (plan.is_free) {\n                    html += '<button class=\"plan-select-btn\" disabled style=\"' +\n                        'display: block; width: 100%; padding: 14px; border: 2px solid #e5e7eb; border-radius: 10px; ' +\n                        'background: white; color: #374151; font-weight: 600; font-size: 14px; cursor: default;\">' +\n                        'Free Plan</button>';\n                } else {\n                    // Include stripe_price_id if available for checkout\n                    var stripePriceId = plan.stripe_price_id || '';\n                    var stripeConfigured = plan.stripe_configured || false;\n                    html += '<button class=\"plan-select-btn\" data-plan-id=\"' + (plan.id || '') + '\" ' +\n                        'data-plan-name=\"' + plan.short_name + '\" ' +\n                        'data-stripe-price-id=\"' + stripePriceId + '\" ' +\n                        'data-stripe-configured=\"' + stripeConfigured + '\" style=\"' +\n                        'display: block; width: 100%; padding: 14px; border: none; border-radius: 10px; ' +\n                        'background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%); color: white; ' +\n                        'font-weight: 600; font-size: 14px; cursor: pointer; transition: all 0.3s ease;\">' +\n                        '<i class=\"fa fa-arrow-up\"></i> Upgrade to ' + plan.short_name + '</button>';\n                }\n                html += '</div>';\n\n                html += '</div>'; // end plan-card\n            });\n\n            html += '</div>'; // end plans-grid\n            return html;\n        },\n\n        /**\n         * Initialize plans modal event handlers\n         */\n        initPlansModalHandlers: function() {\n            // Billing toggle handler\n            document.querySelectorAll('.billing-toggle-btn').forEach(function(btn) {\n                btn.addEventListener('click', function() {\n                    var interval = this.getAttribute('data-interval');\n                    if (interval === Subscription.currentInterval) return;\n\n                    // Update toggle UI\n                    document.querySelectorAll('.billing-toggle-btn').forEach(function(b) {\n                        b.classList.remove('active');\n                        b.style.background = 'transparent';\n                        b.style.color = '#6b7280';\n                        b.style.boxShadow = 'none';\n                    });\n                    this.classList.add('active');\n                    this.style.background = 'white';\n                    this.style.color = '#1f2937';\n                    this.style.boxShadow = '0 2px 8px rgba(0,0,0,0.1)';\n\n                    Subscription.currentInterval = interval;\n\n                    // Update plans display\n                    var plans = Subscription.plansData[interval] || [];\n                    var container = document.getElementById('plans-grid-container');\n                    if (container) {\n                        container.innerHTML = Subscription.buildPlansGrid(plans, interval);\n                        Subscription.initPlanButtonHandlers();\n                    }\n                });\n            });\n\n            // Initialize plan button handlers\n            Subscription.initPlanButtonHandlers();\n        },\n\n        /**\n         * Initialize plan button click handlers\n         */\n        initPlanButtonHandlers: function() {\n            document.querySelectorAll('.plan-select-btn:not([disabled])').forEach(function(btn) {\n                btn.addEventListener('click', function() {\n                    var planName = this.getAttribute('data-plan-name');\n                    var planId = this.getAttribute('data-plan-id');\n                    var stripePriceId = this.getAttribute('data-stripe-price-id');\n                    var stripeConfigured = this.getAttribute('data-stripe-configured') === 'true';\n\n                    console.log('[Subscription] Plan button clicked:', {\n                        planName: planName,\n                        planId: planId,\n                        stripePriceId: stripePriceId,\n                        stripeConfigured: stripeConfigured\n                    });\n\n                    // If Stripe is configured for this plan, use checkout session\n                    if (stripeConfigured && stripePriceId) {\n                        Subscription.createCheckoutSession(planId, stripePriceId, planName);\n                    } else {\n                        // Fallback to billing portal or show \"coming soon\" message\n                        Subscription.openBillingPortalForUpgrade(planName, planId);\n                    }\n                });\n\n                // Hover effects\n                btn.addEventListener('mouseenter', function() {\n                    this.style.transform = 'translateY(-2px)';\n                    this.style.boxShadow = '0 8px 20px rgba(37, 99, 235, 0.3)';\n                });\n                btn.addEventListener('mouseleave', function() {\n                    this.style.transform = 'translateY(0)';\n                    this.style.boxShadow = 'none';\n                });\n            });\n        },\n\n        /**\n         * Open billing portal for upgrade\n         * Uses the same approach as Step 2 - opens billing portal where user can select plan\n         */\n        openBillingPortalForUpgrade: function(planName, planId) {\n            Swal.fire({\n                title: 'Opening Billing Portal...',\n                html: '<p>Preparing upgrade to ' + planName + '...</p>',\n                allowOutsideClick: false,\n                showConfirmButton: false,\n                didOpen: function() {\n                    Swal.showLoading();\n                }\n            });\n\n            var returnUrl = window.location.href;\n            var args = {\n                return_url: returnUrl,\n                sesskey: M.cfg.sesskey\n            };\n\n            // Pass plan_id if available (needed for customer creation)\n            if (planId) {\n                args.plan_id = planId;\n            }\n\n            Ajax.call([{\n                methodname: 'report_adeptus_insights_create_billing_portal_session',\n                args: args,\n                done: function(response) {\n                    if (response && response.success && response.portal_url) {\n                        Swal.fire({\n                            icon: 'success',\n                            title: 'Redirecting...',\n                            html: '<p>Opening billing portal...</p>',\n                            timer: 2000,\n                            timerProgressBar: true,\n                            showConfirmButton: false,\n                            allowOutsideClick: false\n                        });\n\n                        setTimeout(function() {\n                            // Redirect in same window (like Step 2 does)\n                            window.location.href = response.portal_url;\n                        }, 1000);\n                    } else {\n                        var errorMessage = (response && response.message) || 'Failed to open billing portal.';\n\n                        // Check for specific error codes and provide helpful messages\n                        if (errorMessage.indexOf('NO_STRIPE_CUSTOMER') !== -1 ||\n                            errorMessage.indexOf('payment_enabled') !== -1 ||\n                            errorMessage.indexOf('Stripe') !== -1) {\n                            Swal.fire({\n                                icon: 'info',\n                                title: 'Upgrade Coming Soon',\n                                html: '<p>Online payments are not yet configured for this installation.</p>' +\n                                      '<p>To upgrade to <strong>' + planName + '</strong>, please contact your administrator or email:</p>' +\n                                      '<p><a href=\"mailto:support@adeptus360.com?subject=Upgrade%20to%20' + planName + '\">support@adeptus360.com</a></p>',\n                                confirmButtonColor: '#2563eb',\n                                confirmButtonText: 'OK'\n                            });\n                        } else {\n                            Swal.fire({\n                                icon: 'error',\n                                title: 'Billing Portal Error',\n                                text: errorMessage,\n                                confirmButtonColor: '#3085d6'\n                            });\n                        }\n                    }\n                },\n                fail: function(error) {\n                    console.error('[Subscription] Billing portal failed:', error);\n                    Swal.fire({\n                        icon: 'error',\n                        title: 'Connection Error',\n                        text: 'Failed to open billing portal. Please try again.',\n                        confirmButtonColor: '#3085d6'\n                    });\n                }\n            }]);\n        },\n\n        /**\n         * Create Stripe Checkout session for new subscriptions\n         * @param {string} planId - The plan ID\n         * @param {string} stripePriceId - The Stripe price ID\n         * @param {string} planName - The plan name for display\n         */\n        createCheckoutSession: function(planId, stripePriceId, planName) {\n            Swal.fire({\n                title: 'Preparing Checkout...',\n                html: '<p>Setting up payment for ' + planName + '...</p>',\n                allowOutsideClick: false,\n                showConfirmButton: false,\n                didOpen: function() {\n                    Swal.showLoading();\n                }\n            });\n\n            var returnUrl = window.location.href;\n            var args = {\n                plan_id: parseInt(planId),\n                stripe_price_id: stripePriceId,\n                return_url: returnUrl,\n                sesskey: M.cfg.sesskey\n            };\n\n            console.log('[Subscription] Creating checkout session with args:', args);\n\n            Ajax.call([{\n                methodname: 'report_adeptus_insights_create_checkout_session',\n                args: args,\n                done: function(response) {\n                    console.log('[Subscription] Checkout session response:', response);\n\n                    if (response && response.success && response.checkout_url) {\n                        Swal.fire({\n                            icon: 'success',\n                            title: 'Redirecting to Checkout...',\n                            html: '<p>You will be redirected to complete your payment.</p>',\n                            timer: 2000,\n                            timerProgressBar: true,\n                            showConfirmButton: false,\n                            allowOutsideClick: false\n                        });\n\n                        setTimeout(function() {\n                            window.location.href = response.checkout_url;\n                        }, 1000);\n                    } else {\n                        var errorMessage = (response && response.message) || 'Failed to create checkout session.';\n                        var errorCode = (response && response.error_code) || '';\n\n                        // Handle specific error codes\n                        if (errorCode === 'STRIPE_NOT_CONFIGURED') {\n                            Swal.fire({\n                                icon: 'info',\n                                title: 'Payment Not Available',\n                                html: '<p>Stripe is not yet configured for the <strong>' + planName + '</strong> plan.</p>' +\n                                      '<p>Please contact your administrator or email:</p>' +\n                                      '<p><a href=\"mailto:support@adeptus360.com?subject=Upgrade%20to%20' + planName + '\">support@adeptus360.com</a></p>',\n                                confirmButtonColor: '#2563eb',\n                                confirmButtonText: 'OK'\n                            });\n                        } else {\n                            Swal.fire({\n                                icon: 'error',\n                                title: 'Checkout Error',\n                                text: errorMessage,\n                                confirmButtonColor: '#3085d6'\n                            });\n                        }\n                    }\n                },\n                fail: function(error) {\n                    console.error('[Subscription] Checkout session failed:', error);\n                    Swal.fire({\n                        icon: 'error',\n                        title: 'Connection Error',\n                        text: 'Failed to create checkout session. Please try again.',\n                        confirmButtonColor: '#3085d6'\n                    });\n                }\n            }]);\n        },\n\n        /**\n         * Handle select plan (for new subscriptions)\n         */\n        handleSelectPlan: function($button, planId, planName) {\n            if (!planId) {\n                console.error('[Subscription] No plan ID available');\n                Swal.fire({\n                    icon: 'error',\n                    title: 'Error',\n                    text: 'Plan ID not available. Please try again.',\n                    confirmButtonColor: '#3085d6'\n                });\n                return;\n            }\n\n            // Show confirmation dialog\n            Swal.fire({\n                icon: 'info',\n                title: 'Subscribe to ' + planName + '?',\n                html: '<p>You will be redirected to complete your subscription.</p>',\n                showCancelButton: true,\n                confirmButtonColor: '#3498db',\n                cancelButtonColor: '#95a5a6',\n                confirmButtonText: '<i class=\"fa fa-credit-card\"></i> Subscribe Now',\n                cancelButtonText: 'Cancel'\n            }).then(function(result) {\n                if (result.isConfirmed) {\n                    Subscription.createBillingPortalSession(planId, 'subscribe');\n                }\n            });\n        },\n\n        /**\n         * Handle renew subscription\n         */\n        handleRenewSubscription: function() {\n            Swal.fire({\n                icon: 'success',\n                title: 'Renew Your Subscription?',\n                html: '<p>Welcome back! Renew your subscription to regain access to all premium features.</p>',\n                showCancelButton: true,\n                confirmButtonColor: '#27ae60',\n                cancelButtonColor: '#95a5a6',\n                confirmButtonText: '<i class=\"fa fa-refresh\"></i> Renew Subscription',\n                cancelButtonText: 'Not Now'\n            }).then(function(result) {\n                if (result.isConfirmed) {\n                    // Open billing portal for renewal\n                    Subscription.createBillingPortalSession(null, 'renew');\n                }\n            });\n        }\n    };\n\n    return Subscription;\n});\n"],"names":["define","$","Ajax","Notification","Swal","window","Subscription","planId","subscriptionData","init","initEventHandlers","checkForCheckoutSuccess","updateSubscriptionDisplay","urlParams","URLSearchParams","location","search","checkoutStatus","get","sessionId","console","log","fire","title","html","allowOutsideClick","showConfirmButton","didOpen","showLoading","call","methodname","args","session_id","sesskey","M","cfg","done","response","success","icon","plan_name","confirmButtonColor","confirmButtonText","then","cleanUrl","href","split","message","fail","error","history","replaceState","document","text","cancelUrl","on","e","preventDefault","handleUpgradeFromFree","handleDowngradePlan","this","handleCancelSubscription","openBillingPortal","data","planName","handleSelectPlan","handleRenewSubscription","handleUpgradePlan","$button","showCancelButton","cancelButtonColor","cancelButtonText","result","isConfirmed","createBillingPortalSession","focusCancel","plan_id","action","return_url","portal_url","timer","timerProgressBar","setTimeout","newWindow","open","closed","renderSubscriptionInfo","$container","length","statusClass","statusText","status","should_disable_api_access","is_cancelled","has_payment_issues","status_message","messageClass","cancel_at_period_end","Date","current_period_end","toLocaleDateString","failed_payment_attempts","updateApiAccessStatus","apiAccessDisabled","adeptusApiAccessDisabled","adeptusSubscriptionStatus","prop","attr","showApiAccessWarning","removeAttr","hideApiAccessWarning","warningHtml","prepend","remove","refresh","plansData","currentInterval","fetch","wwwroot","json","monthly_plans","yearly_plans","monthly","yearly","showPlansModal","catch","hasYearlyPlans","has_yearly_plans","maxYearlySavings","max_yearly_savings","modalHtml","buildPlansGrid","width","customClass","popup","initPlansModalHandlers","plans","interval","forEach","plan","borderColor","is_current","is_popular","bgColor","short_name","description","is_free","price_formatted","has_savings","savings_percent","tokens_limit","exports_limit","reports_limit","export_formats","features","feature","stripePriceId","stripe_price_id","stripeConfigured","stripe_configured","id","querySelectorAll","btn","addEventListener","getAttribute","b","classList","style","background","color","boxShadow","add","container","getElementById","innerHTML","initPlanButtonHandlers","createCheckoutSession","openBillingPortalForUpgrade","transform","errorMessage","indexOf","returnUrl","parseInt","checkout_url","error_code"],"mappings":"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"}