{"version":3,"file":"global_auth.min.js","sources":["../src/global_auth.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Global authentication handling for Adeptus Insights plugin.\n *\n * Manages global authentication state, login modal display, authentication\n * verification, and UI updates based on authentication status.\n *\n * @module     report_adeptus_insights/global_auth\n * @package    report_adeptus_insights\n * @copyright  2026 Adeptus 360 <info@adeptus360.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\n// jshint ignore:start\ndefine(['jquery', 'core/ajax', 'core/notification'], function($, Ajax, Notification) {\n    'use strict';\n\n    /**\n     * Global Authentication for Adeptus Insights plugin\n     */\n    var GlobalAuth = {\n        \n        /**\n         * Initialize global authentication\n         */\n        init: function() {\n            // Removed debug logs for production\n            return new Promise((resolve, reject) => {\n                // Check if already authenticated\n                if (this.isAuthenticated()) {\n                    resolve();\n                    return;\n                }\n                \n                // Check authentication status\n                this.checkAuthStatus().then(() => {\n                    resolve();\n                }).catch((error) => {\n                    reject(error);\n                });\n            });\n        },\n        \n        /**\n         * Check authentication status\n         */\n        checkAuthStatus: function() {\n            var self = this;\n            return new Promise((resolve, reject) => {\n                var promises = Ajax.call([{\n                    methodname: 'report_adeptus_insights_get_auth_status',\n                    args: {}\n                }]);\n\n                promises[0].done(function(result) {\n                    var response = result.data ? result.data : result;\n                    if (response && response.success) {\n                        // Build auth data from response\n                        var authData = {\n                            is_authenticated: response.is_authenticated,\n                            user_email: response.user_email,\n                            token_expires_at: response.token_expires_at\n                        };\n                        // Parse installation_info if it's a JSON string\n                        if (response.installation_info) {\n                            try {\n                                authData.installation_info = JSON.parse(response.installation_info);\n                            } catch (e) {\n                                authData.installation_info = {};\n                            }\n                        }\n                        self.handleAuthSuccess(authData);\n                        resolve();\n                    } else {\n                        self.handleAuthFailure(response.message || 'Authentication failed');\n                        reject(new Error(response.message || 'Authentication failed'));\n                    }\n                }).fail(function(error) {\n                    self.handleAuthFailure('Failed to check authentication status');\n                    reject(new Error('Failed to check authentication status'));\n                });\n            });\n        },\n        \n        /**\n         * Handle successful authentication\n         */\n        handleAuthSuccess: function(authData) {\n            // Removed sensitive debug log for production\n\n            // Store auth data globally\n            window.adeptusAuthData = authData;\n            \n            // Hide any auth modals\n            this.hideModal();\n            \n            // Enable interactive features\n            $(document).trigger('adeptus:enableInteractiveFeatures');\n            \n            // Update UI elements\n            this.updateUIForAuthenticatedUser();\n        },\n        \n        /**\n         * Handle authentication failure\n         */\n        handleAuthFailure: function(message) {\n            // Removed debug log for production\n\n            // Show login modal\n            this.showModal();\n            \n            // Disable interactive features\n            $(document).trigger('adeptus:enableReadOnly');\n        },\n        \n        /**\n         * Show authentication modal\n         */\n        showModal: function() {\n            // Check if modal already exists\n            if ($('#global-auth-modal').length) {\n                $('#global-auth-modal').modal('show');\n                return;\n            }\n            \n            // Create modal HTML\n            var modalHtml = this.createModalHTML();\n            $('body').append(modalHtml);\n            \n            // Show modal\n            $('#global-auth-modal').modal('show');\n            \n            // Initialize modal functionality\n            this.initModalFunctionality();\n        },\n        \n        /**\n         * Hide authentication modal\n         */\n        hideModal: function() {\n            var $modal = $('#global-auth-modal');\n            // Only try to hide if modal exists and is visible\n            if ($modal.length && $modal.hasClass('show')) {\n                $modal.modal('hide');\n            }\n            // Clean up any orphaned modal backdrops that might block clicks\n            $('.modal-backdrop').remove();\n            // Ensure body doesn't have modal-open class stuck\n            $('body').removeClass('modal-open');\n        },\n        \n        /**\n         * Create modal HTML\n         */\n        createModalHTML: function() {\n            return `\n                <div class=\"modal fade\" id=\"global-auth-modal\" tabindex=\"-1\" role=\"dialog\" aria-labelledby=\"global-auth-modal-label\" aria-hidden=\"true\">\n                    <div class=\"modal-dialog modal-dialog-centered\" role=\"document\">\n                        <div class=\"modal-content\">\n                            <div class=\"modal-header\">\n                                <h5 class=\"modal-title\" id=\"global-auth-modal-label\">\n                                    <i class=\"fa fa-lock\"></i> Adeptus Insights Authentication\n                                </h5>\n                                <button type=\"button\" class=\"btn-close\" data-bs-dismiss=\"modal\" aria-label=\"Close\"></button>\n                            </div>\n                            <div class=\"modal-body\">\n                                <div class=\"auth-form\">\n                                    <div class=\"form-group mb-3\">\n                                        <label for=\"site-url\">Site URL</label>\n                                        <input type=\"text\" class=\"form-control\" id=\"site-url\" value=\"${window.location.origin}\" disabled>\n                                    </div>\n                                    <div class=\"form-group mb-3\">\n                                        <label for=\"admin-email\">Admin Email</label>\n                                        <input type=\"email\" class=\"form-control\" id=\"admin-email\" value=\"admin@example.com\" disabled>\n                                    </div>\n                                    <div class=\"form-group mb-3\">\n                                        <label for=\"auth-password\">Password</label>\n                                        <div class=\"input-group\">\n                                            <input type=\"password\" class=\"form-control\" id=\"auth-password\" placeholder=\"Enter your password\">\n                                            <button class=\"btn btn-outline-secondary\" type=\"button\" id=\"toggle-password\">\n                                                <i class=\"fa fa-eye\"></i>\n                                            </button>\n                                        </div>\n                                    </div>\n                                </div>\n                            </div>\n                            <div class=\"modal-footer\">\n                                <button type=\"button\" class=\"btn btn-secondary\" data-bs-dismiss=\"modal\">Cancel</button>\n                                <button type=\"button\" class=\"btn btn-primary\" id=\"auth-submit\">\n                                    <i class=\"fa fa-sign-in\"></i> Authenticate\n                                </button>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n            `;\n        },\n        \n        /**\n         * Initialize modal functionality\n         */\n        initModalFunctionality: function() {\n            // Handle form submission\n            $('#auth-submit').on('click', () => {\n                this.handleLogin();\n            });\n            \n            // Handle password toggle\n            $('#toggle-password').on('click', () => {\n                this.togglePasswordVisibility();\n            });\n            \n            // Handle Enter key in password field\n            $('#auth-password').on('keypress', (e) => {\n                if (e.which === 13) {\n                    this.handleLogin();\n                }\n            });\n            \n            // Auto-fill site info\n            this.autoFillSiteInfo();\n            \n            // Include custom CSS\n            this.includeCustomCSS();\n        },\n        \n        /**\n         * Handle login submission\n         */\n        handleLogin: function() {\n            var password = $('#auth-password').val();\n            \n            if (!password) {\n                Notification.addNotification({\n                    message: 'Please enter your password',\n                    type: 'error'\n                });\n                return;\n            }\n            \n            // Disable submit button\n            $('#auth-submit').prop('disabled', true).html('<i class=\"fa fa-spinner fa-spin\"></i> Authenticating...');\n            \n            // Attempt authentication\n            this.authenticate(password).then(() => {\n                this.hideModal();\n                Notification.addNotification({\n                    message: 'Authentication successful!',\n                    type: 'success'\n                });\n            }).catch((error) => {\n                Notification.addNotification({\n                    message: error.message || 'Authentication failed',\n                    type: 'error'\n                });\n                \n                // Re-enable submit button\n                $('#auth-submit').prop('disabled', false).html('<i class=\"fa fa-sign-in\"></i> Authenticate');\n            });\n        },\n        \n        /**\n         * Authenticate with backend\n         */\n        authenticate: function(password) {\n            return new Promise((resolve, reject) => {\n                $.ajax({\n                    url: M.cfg.wwwroot + '/report/adeptus_insights/ajax/authenticate.php',\n                    method: 'POST',\n                    data: {\n                        password: password,\n                        sesskey: M.cfg.sesskey\n                    },\n                    dataType: 'json',\n                    success: (response) => {\n                        if (response && response.success) {\n                            this.handleAuthSuccess(response.data);\n                            resolve();\n                        } else {\n                            reject(new Error(response.message || 'Authentication failed'));\n                        }\n                    },\n                    error: (xhr, status, error) => {\n                        reject(new Error('Failed to authenticate'));\n                    }\n                });\n            });\n        },\n        \n        /**\n         * Toggle password visibility\n         */\n        togglePasswordVisibility: function() {\n            var $passwordField = $('#auth-password');\n            var $toggleBtn = $('#toggle-password');\n            var $icon = $toggleBtn.find('i');\n            \n            if ($passwordField.attr('type') === 'password') {\n                $passwordField.attr('type', 'text');\n                $icon.removeClass('fa-eye').addClass('fa-eye-slash');\n            } else {\n                $passwordField.attr('type', 'password');\n                $icon.removeClass('fa-eye-slash').addClass('fa-eye');\n            }\n        },\n        \n        /**\n         * Auto-fill site information\n         */\n        autoFillSiteInfo: function() {\n            // Site URL is already filled from window.location.origin\n            // Admin email could be filled from user data if available\n            if (typeof M !== 'undefined' && M.user && M.user.email) {\n                $('#admin-email').val(M.user.email);\n            }\n        },\n        \n        /**\n         * Include custom CSS\n         */\n        includeCustomCSS: function() {\n            if (!$('#global-auth-modal-css').length) {\n                var css = `\n                    <style id=\"global-auth-modal-css\">\n                        #global-auth-modal .modal-content {\n                            border-radius: 15px;\n                            border: none;\n                            box-shadow: 0 10px 30px rgba(0,0,0,0.2);\n                        }\n                        #global-auth-modal .modal-header {\n                            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n                            color: white;\n                            border-radius: 15px 15px 0 0;\n                        }\n                        #global-auth-modal .modal-title i {\n                            margin-right: 8px;\n                        }\n                        #global-auth-modal .form-control:disabled {\n                            background-color: #f8f9fa;\n                            color: #6c757d;\n                        }\n                        #global-auth-modal .btn-primary {\n                            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n                            border: none;\n                            border-radius: 25px;\n                            padding: 10px 25px;\n                        }\n                        #global-auth-modal .btn-primary:hover {\n                            transform: translateY(-2px);\n                            box-shadow: 0 5px 15px rgba(0,0,0,0.2);\n                        }\n                        #global-auth-modal .input-group-text {\n                            background-color: #f8f9fa;\n                            border-color: #ced4da;\n                        }\n                    </style>\n                `;\n                $('head').append(css);\n            }\n        },\n        \n        /**\n         * Update UI for authenticated user\n         */\n        updateUIForAuthenticatedUser: function() {\n            // Hide auth-related elements\n            $('.auth-required').hide();\n            $('.auth-not-required').show();\n            \n            // Update user info if available\n            if (window.adeptusAuthData && window.adeptusAuthData.user_name) {\n                $('.user-name').text(window.adeptusAuthData.user_name);\n            }\n        },\n        \n        /**\n         * Check if user is authenticated\n         */\n        isAuthenticated: function() {\n            return window.adeptusAuthData && \n                   window.adeptusAuthData.user_authorized && \n                   window.adeptusAuthData.has_api_key;\n        },\n        \n        /**\n         * Get authentication data\n         */\n        getAuthData: function() {\n            return window.adeptusAuthData || null;\n        },\n        \n        /**\n         * Logout user\n         */\n        logout: function() {\n            // Clear auth data\n            window.adeptusAuthData = null;\n            \n            // Show login modal\n            this.showModal();\n            \n            // Disable interactive features\n            $(document).trigger('adeptus:enableReadOnly');\n            \n            // Update UI\n            this.updateUIForUnauthenticatedUser();\n        },\n        \n        /**\n         * Update UI for unauthenticated user\n         */\n        updateUIForUnauthenticatedUser: function() {\n            // Show auth-related elements\n            $('.auth-required').show();\n            $('.auth-not-required').hide();\n            \n            // Clear user info\n            $('.user-name').text('Guest');\n        }\n    };\n\n    return GlobalAuth;\n});\n"],"names":["define","$","Ajax","Notification","init","Promise","resolve","reject","this","isAuthenticated","checkAuthStatus","then","catch","error","self","call","methodname","args","done","result","response","data","success","authData","is_authenticated","user_email","token_expires_at","installation_info","JSON","parse","e","handleAuthSuccess","handleAuthFailure","message","Error","fail","window","adeptusAuthData","hideModal","document","trigger","updateUIForAuthenticatedUser","showModal","length","modal","modalHtml","createModalHTML","append","initModalFunctionality","$modal","hasClass","remove","removeClass","location","origin","on","handleLogin","togglePasswordVisibility","which","autoFillSiteInfo","includeCustomCSS","password","val","prop","html","authenticate","addNotification","type","ajax","url","M","cfg","wwwroot","method","sesskey","dataType","xhr","status","$passwordField","$icon","find","attr","addClass","user","email","hide","show","user_name","text","user_authorized","has_api_key","getAuthData","logout","updateUIForUnauthenticatedUser"],"mappings":"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"}