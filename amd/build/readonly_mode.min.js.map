{"version":3,"file":"readonly_mode.min.js","sources":["../src/readonly_mode.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Read-only mode functionality for Adeptus Insights plugin.\n *\n * Manages read-only mode activation/deactivation based on authentication\n * status, disabling interactive elements and forms when unauthorized.\n *\n * @module     report_adeptus_insights/readonly_mode\n * @package    report_adeptus_insights\n * @copyright  2026 Adeptus 360 <info@adeptus360.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\ndefine(['jquery', 'core/notification', 'core/str'], function($, Notification, Str) {\n    'use strict';\n\n    /** @var {Object} strings - Loaded language strings. */\n    var strings = {};\n\n    /**\n     * Load required language strings.\n     * @returns {Promise} Promise that resolves when strings are loaded.\n     */\n    var loadStrings = function() {\n        return Str.get_strings([\n            {key: 'js_plugin_readonly_mode', component: 'report_adeptus_insights'}\n        ]).then(function(results) {\n            strings.readonlyMessage = results[0];\n            return strings;\n        }).catch(function() {\n            // Fallback if string loading fails.\n            strings.readonlyMessage = 'Plugin is in read-only mode due to authentication issues';\n            return strings;\n        });\n    };\n\n    /**\n     * Read-only mode functionality for Adeptus Insights plugin\n     */\n    var ReadonlyMode = {\n\n        /**\n         * Initialize read-only mode\n         */\n        init: function() {\n            // Load strings first, then set up event listeners.\n            loadStrings().then(function() {\n                // Listen for read-only mode enable event.\n                $(document).on('adeptus:enableReadOnly', function() {\n                    ReadonlyMode.enable();\n                });\n\n                // Listen for read-only mode disable event.\n                $(document).on('adeptus:disableReadOnly', function() {\n                    ReadonlyMode.disable();\n                });\n\n                // Check if we should start in read-only mode.\n                if (window.adeptusAuthData) {\n                    ReadonlyMode.checkInitialState();\n                }\n            });\n        },\n\n        /**\n         * Check initial state and enable read-only if needed\n         */\n        checkInitialState: function() {\n            var authData = window.adeptusAuthData;\n            var shouldEnableReadOnly = !authData ||\n                                     !authData.user_authorized ||\n                                     !authData.has_api_key ||\n                                     (authData.auth_errors && authData.auth_errors > 0);\n\n            if (shouldEnableReadOnly) {\n                this.enable();\n            }\n        },\n\n        /**\n         * Enable read-only mode\n         */\n        enable: function() {\n            // Add read-only class to body\n            $('body').addClass('adeptus-readonly-mode');\n\n            // Disable all interactive elements\n            this.disableInteractiveElements();\n\n            // Show read-only notification\n            this.showReadOnlyNotification();\n\n            // Disable forms\n            this.disableForms();\n\n            // Disable buttons\n            this.disableButtons();\n\n            // Trigger custom event\n            $(document).trigger('adeptus:readOnlyEnabled');\n        },\n\n        /**\n         * Disable read-only mode\n         */\n        disable: function() {\n            // Remove read-only class from body\n            $('body').removeClass('adeptus-readonly-mode');\n\n            // Re-enable all interactive elements\n            this.enableInteractiveElements();\n\n            // Hide read-only notification\n            this.hideReadOnlyNotification();\n\n            // Re-enable forms\n            this.enableForms();\n\n            // Re-enable buttons\n            this.enableButtons();\n\n            // Trigger custom event\n            $(document).trigger('adeptus:readOnlyDisabled');\n        },\n\n        /**\n         * Disable interactive elements\n         */\n        disableInteractiveElements: function() {\n            // Disable inputs, textareas, selects\n            $('input, textarea, select').prop('disabled', true);\n\n            // Disable links that are not navigation\n            $('a:not(.nav-link):not(.breadcrumb-item a)').addClass('disabled').css('pointer-events', 'none');\n\n            // Disable buttons\n            $('button:not(.nav-toggle)').prop('disabled', true);\n\n            // Disable form submissions\n            $('form').on('submit.adeptus-readonly', function(e) {\n                e.preventDefault();\n                return false;\n            });\n        },\n\n        /**\n         * Enable interactive elements\n         */\n        enableInteractiveElements: function() {\n            // Re-enable inputs, textareas, selects\n            $('input, textarea, select').prop('disabled', false);\n\n            // Re-enable links\n            $('a.disabled').removeClass('disabled').css('pointer-events', '');\n\n            // Re-enable buttons\n            $('button').prop('disabled', false);\n\n            // Re-enable form submissions\n            $('form').off('submit.adeptus-readonly');\n        },\n\n        /**\n         * Disable forms\n         */\n        disableForms: function() {\n            $('form').each(function() {\n                var $form = $(this);\n                if (!$form.data('adeptus-original-action')) {\n                    $form.data('adeptus-original-action', $form.attr('action'));\n                    $form.attr('action', 'javascript:void(0)');\n                }\n            });\n        },\n\n        /**\n         * Enable forms\n         */\n        enableForms: function() {\n            $('form').each(function() {\n                var $form = $(this);\n                var originalAction = $form.data('adeptus-original-action');\n                if (originalAction) {\n                    $form.attr('action', originalAction);\n                    $form.removeData('adeptus-original-action');\n                }\n            });\n        },\n\n        /**\n         * Disable buttons\n         */\n        disableButtons: function() {\n            $('button:not(.nav-toggle)').each(function() {\n                var $btn = $(this);\n                if (!$btn.data('adeptus-original-text')) {\n                    $btn.data('adeptus-original-text', $btn.text());\n                    $btn.text('Read-Only Mode');\n                    $btn.addClass('btn-secondary').removeClass('btn-primary btn-success btn-danger btn-warning btn-info');\n                }\n            });\n        },\n\n        /**\n         * Enable buttons\n         */\n        enableButtons: function() {\n            $('button').each(function() {\n                var $btn = $(this);\n                var originalText = $btn.data('adeptus-original-text');\n                if (originalText) {\n                    $btn.text(originalText);\n                    $btn.removeData('adeptus-original-text');\n                    $btn.removeClass('btn-secondary');\n                }\n            });\n        },\n\n        /**\n         * Show read-only notification\n         */\n        showReadOnlyNotification: function() {\n            var message = strings.readonlyMessage || 'Plugin is in read-only mode due to authentication issues';\n            if (Notification) {\n                this.readOnlyNotification = Notification.addNotification({\n                    message: message,\n                    type: 'warning',\n                    closebutton: false\n                });\n            } else {\n                // Fallback to alert if Notification is not available.\n                if (!this.readOnlyAlertShown) {\n                    // eslint-disable-next-line no-alert\n                    alert(message);\n                    this.readOnlyAlertShown = true;\n                }\n            }\n        },\n\n        /**\n         * Hide read-only notification\n         */\n        hideReadOnlyNotification: function() {\n            if (this.readOnlyNotification && Notification) {\n                Notification.closeNotification(this.readOnlyNotification);\n                this.readOnlyNotification = null;\n            }\n            this.readOnlyAlertShown = false;\n        },\n\n        /**\n         * Check if read-only mode is active\n         */\n        isEnabled: function() {\n            return $('body').hasClass('adeptus-readonly-mode');\n        }\n    };\n\n    return ReadonlyMode;\n});\n"],"names":["define","$","Notification","Str","strings","ReadonlyMode","init","get_strings","key","component","then","results","readonlyMessage","catch","document","on","enable","disable","window","adeptusAuthData","checkInitialState","authData","user_authorized","has_api_key","auth_errors","addClass","disableInteractiveElements","showReadOnlyNotification","disableForms","disableButtons","trigger","removeClass","enableInteractiveElements","hideReadOnlyNotification","enableForms","enableButtons","prop","css","e","preventDefault","off","each","$form","this","data","attr","originalAction","removeData","$btn","text","originalText","message","readOnlyNotification","addNotification","type","closebutton","readOnlyAlertShown","alert","closeNotification","isEnabled","hasClass"],"mappings":";;;;;;;;;;;AA2BAA,+CAAO,CAAC,SAAU,oBAAqB,aAAa,SAASC,EAAGC,aAAcC,SAItEC,QAAU,GAsBVC,aAAe,CAKfC,KAAM,WApBCH,IAAII,YAAY,CACnB,CAACC,IAAK,0BAA2BC,UAAW,6BAC7CC,MAAK,SAASC,gBACbP,QAAQQ,gBAAkBD,QAAQ,GAC3BP,WACRS,OAAM,kBAELT,QAAQQ,gBAAkB,2DACnBR,WAcOM,MAAK,WAEfT,EAAEa,UAAUC,GAAG,0BAA0B,WACrCV,aAAaW,YAIjBf,EAAEa,UAAUC,GAAG,2BAA2B,WACtCV,aAAaY,aAIbC,OAAOC,iBACPd,aAAae,wBAQzBA,kBAAmB,eACXC,SAAWH,OAAOC,kBACME,WACFA,SAASC,kBACTD,SAASE,aACTF,SAASG,aAAeH,SAASG,YAAc,SAGhER,UAObA,OAAQ,WAEJf,EAAE,QAAQwB,SAAS,8BAGdC,kCAGAC,gCAGAC,oBAGAC,iBAGL5B,EAAEa,UAAUgB,QAAQ,4BAMxBb,QAAS,WAELhB,EAAE,QAAQ8B,YAAY,8BAGjBC,iCAGAC,gCAGAC,mBAGAC,gBAGLlC,EAAEa,UAAUgB,QAAQ,6BAMxBJ,2BAA4B,WAExBzB,EAAE,2BAA2BmC,KAAK,YAAY,GAG9CnC,EAAE,4CAA4CwB,SAAS,YAAYY,IAAI,iBAAkB,QAGzFpC,EAAE,2BAA2BmC,KAAK,YAAY,GAG9CnC,EAAE,QAAQc,GAAG,2BAA2B,SAASuB,UAC7CA,EAAEC,kBACK,MAOfP,0BAA2B,WAEvB/B,EAAE,2BAA2BmC,KAAK,YAAY,GAG9CnC,EAAE,cAAc8B,YAAY,YAAYM,IAAI,iBAAkB,IAG9DpC,EAAE,UAAUmC,KAAK,YAAY,GAG7BnC,EAAE,QAAQuC,IAAI,4BAMlBZ,aAAc,WACV3B,EAAE,QAAQwC,MAAK,eACPC,MAAQzC,EAAE0C,MACTD,MAAME,KAAK,6BACZF,MAAME,KAAK,0BAA2BF,MAAMG,KAAK,WACjDH,MAAMG,KAAK,SAAU,2BAQjCX,YAAa,WACTjC,EAAE,QAAQwC,MAAK,eACPC,MAAQzC,EAAE0C,MACVG,eAAiBJ,MAAME,KAAK,2BAC5BE,iBACAJ,MAAMG,KAAK,SAAUC,gBACrBJ,MAAMK,WAAW,gCAQ7BlB,eAAgB,WACZ5B,EAAE,2BAA2BwC,MAAK,eAC1BO,KAAO/C,EAAE0C,MACRK,KAAKJ,KAAK,2BACXI,KAAKJ,KAAK,wBAAyBI,KAAKC,QACxCD,KAAKC,KAAK,kBACVD,KAAKvB,SAAS,iBAAiBM,YAAY,gEAQvDI,cAAe,WACXlC,EAAE,UAAUwC,MAAK,eACTO,KAAO/C,EAAE0C,MACTO,aAAeF,KAAKJ,KAAK,yBACzBM,eACAF,KAAKC,KAAKC,cACVF,KAAKD,WAAW,yBAChBC,KAAKjB,YAAY,sBAQ7BJ,yBAA0B,eAClBwB,QAAU/C,QAAQQ,iBAAmB,2DACrCV,kBACKkD,qBAAuBlD,aAAamD,gBAAgB,CACrDF,QAASA,QACTG,KAAM,UACNC,aAAa,IAIZZ,KAAKa,qBAENC,MAAMN,cACDK,oBAAqB,IAQtCvB,yBAA0B,WAClBU,KAAKS,sBAAwBlD,eAC7BA,aAAawD,kBAAkBf,KAAKS,2BAC/BA,qBAAuB,WAE3BI,oBAAqB,GAM9BG,UAAW,kBACA1D,EAAE,QAAQ2D,SAAS,kCAI3BvD"}