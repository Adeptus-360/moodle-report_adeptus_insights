{{! report/adeptus_insights/templates/generated_reports.mustache }}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.all.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/simple-datatables@latest" type="text/javascript"></script>
<link href="https://cdn.jsdelivr.net/npm/simple-datatables@latest/dist/style.css" rel="stylesheet" type="text/css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="stylesheet" href="{{config.wwwroot}}/report/adeptus_insights/styles/assistant.css">

<div class="generated-reports-container">
    <!-- Header Banner -->
    <div class="page-header-banner">
        <div class="page-header-content">
            <h1 class="page-header-title">
                <i class="fa fa-chart-bar page-header-icon"></i>
                {{#str}}generated_reports_title, report_adeptus_insights{{/str}}
            </h1>
            <p class="page-header-subtitle">{{#str}}generated_reports_desc, report_adeptus_insights{{/str}}</p>
        </div>
        <div class="page-header-actions">
            <button type="button" class="btn btn-outline-light" id="manage-categories-btn">
                <i class="fa fa-tags"></i> Manage Categories
            </button>
            <a href="{{config.wwwroot}}/report/adeptus_insights/assistant.php" class="btn btn-outline-light">
                <i class="fa fa-plus"></i> Generate New Report
            </a>
            <a href="{{config.wwwroot}}/report/adeptus_insights/index.php" class="btn btn-light">
                <i class="fa fa-arrow-left"></i> Back to Dashboard
            </a>
        </div>
    </div>

    <div class="container-fluid">
        <!-- Main Content -->
        <div class="row">
            <!-- Reports List -->
            <div class="col-md-4">
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="card-title mb-0"><i class="fa fa-list"></i> All Reports</h5>
                    </div>
                    <div class="card-body p-0 position-relative" style="height: calc(100vh - 280px); overflow-y: auto; min-height: 400px; max-height: 800px;">
                        <div id="reports-loader" class="p-4 d-flex justify-content-center align-items-center" style="min-height: 200px;">
                            <div class="spinner-border text-primary" role="status">
                                <span class="sr-only">Loading...</span>
                            </div>
                        </div>
                        <div class="d-none" id="reports-table-wrapper">
                            <table id="reports-table" class="table mb-0">
                                <thead>
                                    <tr>
                                        <th>Report Name</th>
                                        <th>Date</th>
                                        <th>From</th>
                                    </tr>
                                </thead>
                                <tbody id="reports-tbody">
                                    <!-- Report rows will be injected here -->
                                </tbody>
                            </table>
                        </div>
                        <div id="no-reports-message" class="text-center py-5 d-none">
                            <i class="fa fa-inbox fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">{{#str}}no_reports_yet, report_adeptus_insights{{/str}}</h5>
                            <p class="text-muted">{{#str}}no_reports_yet_desc, report_adeptus_insights{{/str}}</p>
                            <a href="{{config.wwwroot}}/report/adeptus_insights/assistant.php" class="btn btn-outline-primary mt-2">
                                <i class="fa fa-robot"></i> Go to AI Assistant
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Report Preview -->
            <div class="col-md-8">
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="card-title mb-0 report-view-title">Select a Report</h5>
                    </div>
                    <div class="card-body p-4 report-view-body" style="height: calc(100vh - 280px); overflow-y: auto; min-height: 400px; max-height: 800px;">
                        <div id="report-placeholder" class="text-center py-5">
                            <i class="fa fa-file-alt fa-4x text-muted mb-3"></i>
                            <h5 class="text-muted">Select a report to view details</h5>
                            <p class="text-muted">Click on any report from the list to see its data here.</p>
                        </div>
                        <div id="report-loading" class="text-center py-5 d-none">
                            <div class="spinner-border text-primary" role="status">
                                <span class="sr-only">Loading report...</span>
                            </div>
                            <p class="mt-3 text-muted">Loading report data...</p>
                        </div>
                        <div id="report-content" class="d-none">
                            <!-- Report content will be injected here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{{#js}}
require(['jquery', 'core/chartjs'], function($, Chart) {
    'use strict';

    var GeneratedReports = {
        cachedReports: [],
        cachedCategories: [],
        currentReport: null,
        currentReportData: null,
        reportsDataTable: null,
        retryCount: 0,
        maxRetries: 3,
        currentView: 'table',
        chartInstance: null,
        Chart: Chart,

        init: function() {
            this.loadReports();
            this.loadCategories();
            this.bindViewToggle();
            this.bindCategoryManagement();
        },

        bindViewToggle: function() {
            var self = this;
            $(document).on('click', '.view-toggle-btn', function() {
                var view = $(this).data('view');
                self.switchView(view);
            });
            $(document).on('change', '#chart-type-select, #chart-x-axis, #chart-y-axis', function() {
                self.renderChart();
            });
        },

        bindCategoryManagement: function() {
            var self = this;
            $('#manage-categories-btn').on('click', function() {
                self.showCategoryManagementModal();
            });
        },

        loadCategories: function() {
            var self = this;
            var token = this.getAuthToken();
            if (!token) return;

            $.ajax({
                url: 'https://a360backend.stagingwithswift.com/api/v1/reports/categories',
                method: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + token,
                    'Content-Type': 'application/json'
                },
                success: function(response) {
                    if (response.success && response.data) {
                        self.cachedCategories = response.data;
                    }
                },
                error: function() {
                    self.cachedCategories = [];
                }
            });
        },

        showCategoryManagementModal: function() {
            var self = this;

            // Build category list HTML
            var categoriesHtml = self.cachedCategories.length > 0 ?
                self.cachedCategories.map(function(cat) {
                    var isSystem = cat.is_system;
                    var editBtn = !isSystem ? '<button class="btn btn-sm btn-outline-primary edit-cat-btn" data-id="' + cat.id + '"><i class="fa fa-edit"></i></button>' : '';
                    var deleteBtn = !isSystem ? '<button class="btn btn-sm btn-outline-danger delete-cat-btn" data-id="' + cat.id + '"><i class="fa fa-trash"></i></button>' : '';
                    var systemBadge = isSystem ? '<span class="badge bg-secondary ms-2">System</span>' : '';

                    return '<div class="category-item d-flex justify-content-between align-items-center py-2 px-3 border-bottom" data-id="' + cat.id + '">' +
                        '<div class="d-flex align-items-center">' +
                            '<span class="category-color-dot me-2" style="background-color: ' + (cat.color || '#6c757d') + ';"></span>' +
                            '<i class="fa ' + (cat.icon || 'fa-folder') + ' me-2 text-muted"></i>' +
                            '<span class="category-name">' + cat.name + '</span>' +
                            systemBadge +
                            '<span class="badge bg-info ms-2">' + (cat.report_count || 0) + ' reports</span>' +
                        '</div>' +
                        '<div class="category-actions d-flex gap-1">' +
                            editBtn + deleteBtn +
                        '</div>' +
                    '</div>';
                }).join('') :
                '<div class="text-center text-muted py-4"><i class="fa fa-folder-open fa-2x mb-2"></i><p>No categories found</p></div>';

            Swal.fire({
                title: '<i class="fa fa-tags me-2"></i> Manage Categories',
                html: '<div class="category-management-modal">' +
                    '<div class="category-add-form mb-3">' +
                        '<div class="input-group">' +
                            '<input type="text" id="new-category-name" class="form-control" placeholder="New category name...">' +
                            '<input type="color" id="new-category-color" class="form-control form-control-color" value="#6c757d" title="Pick a color">' +
                            '<button type="button" class="btn btn-primary" id="add-category-btn">' +
                                '<i class="fa fa-plus"></i> Add' +
                            '</button>' +
                        '</div>' +
                    '</div>' +
                    '<div class="categories-list" style="max-height: 350px; overflow-y: auto;">' +
                        categoriesHtml +
                    '</div>' +
                '</div>',
                showConfirmButton: false,
                showCloseButton: true,
                width: '550px',
                customClass: {
                    popup: 'category-modal-popup'
                },
                didOpen: function() {
                    // Add category button handler
                    $('#add-category-btn').on('click', function() {
                        var name = $('#new-category-name').val().trim();
                        var color = $('#new-category-color').val();
                        if (name) {
                            self.createCategory(name, color);
                        }
                    });

                    // Enter key in input
                    $('#new-category-name').on('keypress', function(e) {
                        if (e.which === 13) {
                            $('#add-category-btn').click();
                        }
                    });

                    // Edit button handlers
                    $('.edit-cat-btn').on('click', function() {
                        var catId = $(this).data('id');
                        var cat = self.cachedCategories.find(function(c) { return c.id == catId; });
                        if (cat) {
                            self.showEditCategoryDialog(cat);
                        }
                    });

                    // Delete button handlers
                    $('.delete-cat-btn').on('click', function() {
                        var catId = $(this).data('id');
                        var cat = self.cachedCategories.find(function(c) { return c.id == catId; });
                        if (cat) {
                            self.confirmDeleteCategory(cat);
                        }
                    });
                }
            });
        },

        createCategory: function(name, color) {
            var self = this;
            var token = this.getAuthToken();
            if (!token) return;

            $.ajax({
                url: 'https://a360backend.stagingwithswift.com/api/v1/reports/categories',
                method: 'POST',
                headers: {
                    'Authorization': 'Bearer ' + token,
                    'Content-Type': 'application/json'
                },
                data: JSON.stringify({ name: name, color: color }),
                success: function(response) {
                    if (response.success) {
                        self.cachedCategories.push(response.data);
                        Swal.close();
                        Swal.fire({
                            icon: 'success',
                            title: 'Category Created',
                            text: 'Category "' + name + '" has been created.',
                            timer: 1500,
                            showConfirmButton: false
                        }).then(function() {
                            self.showCategoryManagementModal();
                        });
                    } else {
                        Swal.showValidationMessage(response.message || 'Failed to create category');
                    }
                },
                error: function(xhr) {
                    var msg = xhr.responseJSON?.message || 'Failed to create category';
                    Swal.fire({ icon: 'error', title: 'Error', text: msg });
                }
            });
        },

        showEditCategoryDialog: function(category) {
            var self = this;

            Swal.fire({
                title: 'Edit Category',
                html: '<div class="mb-3">' +
                    '<label class="form-label">Name</label>' +
                    '<input type="text" id="edit-cat-name" class="form-control" value="' + category.name.replace(/"/g, '&quot;') + '">' +
                '</div>' +
                '<div class="mb-3">' +
                    '<label class="form-label">Color</label>' +
                    '<input type="color" id="edit-cat-color" class="form-control form-control-color w-100" value="' + (category.color || '#6c757d') + '">' +
                '</div>',
                showCancelButton: true,
                confirmButtonText: 'Save Changes',
                confirmButtonColor: '#28a745',
                preConfirm: function() {
                    var name = document.getElementById('edit-cat-name').value.trim();
                    var color = document.getElementById('edit-cat-color').value;
                    if (!name) {
                        Swal.showValidationMessage('Please enter a category name');
                        return false;
                    }
                    return { name: name, color: color };
                }
            }).then(function(result) {
                if (result.isConfirmed) {
                    self.updateCategory(category.id, result.value.name, result.value.color);
                }
            });
        },

        updateCategory: function(categoryId, name, color) {
            var self = this;
            var token = this.getAuthToken();
            if (!token) return;

            $.ajax({
                url: 'https://a360backend.stagingwithswift.com/api/v1/reports/categories/' + categoryId,
                method: 'PUT',
                headers: {
                    'Authorization': 'Bearer ' + token,
                    'Content-Type': 'application/json'
                },
                data: JSON.stringify({ name: name, color: color }),
                success: function(response) {
                    if (response.success) {
                        // Update cached category
                        var idx = self.cachedCategories.findIndex(function(c) { return c.id == categoryId; });
                        if (idx !== -1) {
                            self.cachedCategories[idx] = response.data;
                        }
                        Swal.fire({
                            icon: 'success',
                            title: 'Category Updated',
                            timer: 1500,
                            showConfirmButton: false
                        }).then(function() {
                            self.showCategoryManagementModal();
                        });
                    } else {
                        Swal.fire({ icon: 'error', title: 'Error', text: response.message || 'Failed to update category' });
                    }
                },
                error: function(xhr) {
                    var msg = xhr.responseJSON?.message || 'Failed to update category';
                    Swal.fire({ icon: 'error', title: 'Error', text: msg });
                }
            });
        },

        confirmDeleteCategory: function(category) {
            var self = this;

            Swal.fire({
                title: 'Delete Category?',
                html: '<p>Are you sure you want to delete <strong>' + category.name + '</strong>?</p>' +
                      '<p class="text-muted small">Reports in this category will be moved to "General".</p>',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#dc3545',
                confirmButtonText: 'Yes, Delete',
                cancelButtonText: 'Cancel'
            }).then(function(result) {
                if (result.isConfirmed) {
                    self.deleteCategory(category.id);
                }
            });
        },

        deleteCategory: function(categoryId) {
            var self = this;
            var token = this.getAuthToken();
            if (!token) return;

            $.ajax({
                url: 'https://a360backend.stagingwithswift.com/api/v1/reports/categories/' + categoryId,
                method: 'DELETE',
                headers: {
                    'Authorization': 'Bearer ' + token,
                    'Content-Type': 'application/json'
                },
                success: function(response) {
                    if (response.success) {
                        // Remove from cache
                        self.cachedCategories = self.cachedCategories.filter(function(c) { return c.id != categoryId; });
                        Swal.fire({
                            icon: 'success',
                            title: 'Category Deleted',
                            text: response.data?.reports_reassigned ? response.data.reports_reassigned + ' reports moved to General' : 'Category has been deleted',
                            timer: 2000,
                            showConfirmButton: false
                        }).then(function() {
                            self.showCategoryManagementModal();
                        });
                    } else {
                        Swal.fire({ icon: 'error', title: 'Error', text: response.message || 'Failed to delete category' });
                    }
                },
                error: function(xhr) {
                    var msg = xhr.responseJSON?.message || 'Failed to delete category';
                    Swal.fire({ icon: 'error', title: 'Error', text: msg });
                }
            });
        },

        detectNumericColumns: function(data, headers) {
            if (!data || data.length === 0) return [];

            return headers.filter(function(header) {
                // Check if at least 50% of values are numeric
                var numericCount = 0;
                var sampleSize = Math.min(data.length, 20);

                for (var i = 0; i < sampleSize; i++) {
                    var val = data[i][header];
                    if (val !== null && val !== undefined && val !== '') {
                        var num = parseFloat(val);
                        if (!isNaN(num) && isFinite(num)) {
                            numericCount++;
                        }
                    }
                }

                return numericCount >= sampleSize * 0.5;
            });
        },

        switchView: function(view) {
            this.currentView = view;
            $('.view-toggle-btn').removeClass('active');
            $('.view-toggle-btn[data-view="' + view + '"]').addClass('active');

            if (view === 'table') {
                $('#report-table-view').removeClass('d-none');
                $('#report-chart-view').addClass('d-none');
            } else {
                $('#report-table-view').addClass('d-none');
                $('#report-chart-view').removeClass('d-none');
                this.renderChart();
            }
        },

        getAuthToken: function() {
            var authData = window.adeptusAuthData;
            if (authData && authData.api_key) {
                return authData.api_key;
            }
            return null;
        },

        formatDate: function(dateStr) {
            if (!dateStr) return 'N/A';
            var date = new Date(dateStr);
            var now = new Date();
            var diff = now - date;
            var days = Math.floor(diff / (1000 * 60 * 60 * 24));

            if (days === 0) {
                return 'Today, ' + date.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});
            } else if (days === 1) {
                return 'Yesterday, ' + date.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});
            } else if (days < 7) {
                var weekdays = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
                return weekdays[date.getDay()] + ', ' + date.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});
            } else {
                return date.toLocaleDateString() + ', ' + date.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});
            }
        },

        loadReports: function() {
            var self = this;
            var token = this.getAuthToken();

            if (!token) {
                if (self.retryCount < self.maxRetries) {
                    self.retryCount++;
                    setTimeout(function() {
                        self.loadReports();
                    }, 500);
                    return;
                } else {
                    $('#reports-loader').addClass('d-none');
                    $('#no-reports-message').removeClass('d-none').html(
                        '<i class="fa fa-exclamation-triangle fa-3x text-warning mb-3"></i>' +
                        '<h5 class="text-muted">Authentication Required</h5>' +
                        '<p class="text-muted">Please ensure you are logged in to view reports.</p>'
                    );
                    return;
                }
            }

            // Fetch from both AI Assistant reports (external API) and Wizard reports (local Moodle)
            var assistantPromise = $.ajax({
                url: 'https://a360backend.stagingwithswift.com/api/v1/ai-reports',
                method: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + token,
                    'Content-Type': 'application/json'
                },
                timeout: 15000
            }).catch(function() {
                return { reports: [], data: [] };
            });

            // Fetch wizard reports from local Moodle endpoint
            var wizardPromise = $.ajax({
                url: M.cfg.wwwroot + '/report/adeptus_insights/ajax/get_wizard_reports.php',
                method: 'GET',
                timeout: 15000
            }).catch(function() {
                return { success: true, reports: [] };
            });

            // Wait for both requests
            $.when(assistantPromise, wizardPromise).then(
                function(assistantRes, wizardRes) {
                    // Extract reports from both responses
                    var aRes = assistantRes[0] || assistantRes || {};
                    var wRes = wizardRes[0] || wizardRes || {};

                    var assistantReports = aRes.reports || aRes.data || [];
                    var wizardReports = wRes.reports || [];

                    // Tag each report with its source
                    assistantReports = (Array.isArray(assistantReports) ? assistantReports : []).map(function(r) {
                        r.source = r.source || 'assistant';
                        return r;
                    });
                    wizardReports = (Array.isArray(wizardReports) ? wizardReports : []).map(function(r) {
                        r.source = 'wizard';
                        return r;
                    });

                    // Combine all reports
                    self.cachedReports = assistantReports.concat(wizardReports);

                    // Sort by date (newest first)
                    self.cachedReports.sort(function(a, b) {
                        return new Date(b.created_at) - new Date(a.created_at);
                    });

                    self.renderReportsList(self.cachedReports);
                    self.updateReportCount(self.cachedReports.length);
                },
                function(xhr, status, error) {
                    $('#reports-loader').addClass('d-none');
                    if (xhr.status === 401) {
                        $('#no-reports-message').removeClass('d-none').html(
                            '<i class="fa fa-lock fa-3x text-warning mb-3"></i>' +
                            '<h5 class="text-muted">Session Expired</h5>' +
                            '<p class="text-muted">Please refresh the page to continue.</p>' +
                            '<button class="btn btn-primary btn-sm" onclick="location.reload()"><i class="fa fa-refresh"></i> Refresh Page</button>'
                        );
                    } else {
                        $('#no-reports-message').removeClass('d-none').html(
                            '<i class="fa fa-exclamation-circle fa-3x text-danger mb-3"></i>' +
                            '<h5 class="text-muted">Failed to Load Reports</h5>' +
                            '<p class="text-muted">Please try again later.</p>' +
                            '<button class="btn btn-outline-primary btn-sm" onclick="location.reload()"><i class="fa fa-refresh"></i> Retry</button>'
                        );
                    }
                }
            );
        },

        updateReportCount: function(count) {
            var countText = count === 1 ? '1 Report' : count + ' Reports';
            $('.page-header-subtitle').text('You have ' + countText.toLowerCase() + ' saved');
        },

        renderReportsList: function(reports) {
            var self = this;
            var tbody = $('#reports-tbody');
            tbody.empty();

            $('#reports-loader').addClass('d-none');

            if (!reports || reports.length === 0) {
                $('#no-reports-message').removeClass('d-none');
                $('#reports-table-wrapper').addClass('d-none');
                return;
            }

            $('#no-reports-message').addClass('d-none');
            $('#reports-table-wrapper').removeClass('d-none');

            reports.forEach(function(report, index) {
                var date = self.formatDate(report.created_at);
                var rowCount = report.row_count || report.data_count || '';
                var rowCountBadge = rowCount ? '<span class="badge bg-info ms-1" title="' + rowCount + ' rows"><i class="fa fa-table"></i> ' + rowCount + '</span>' : '';
                var categoryBadge = report.category ? '<span class="badge bg-secondary ms-1">' + report.category + '</span>' : '';

                // Determine source badge
                var source = (report.source || 'assistant').toLowerCase();
                var sourceBadge = '';
                if (source === 'wizard') {
                    sourceBadge = '<span class="badge badge-wizard"><i class="fa fa-magic"></i> Wizard</span>';
                } else {
                    sourceBadge = '<span class="badge badge-ai"><i class="fa fa-robot"></i> AI</span>';
                }

                var row = $('<tr class="report-row" data-report-slug="' + report.slug + '" data-report-source="' + source + '"></tr>');
                row.html(
                    '<td>' +
                        '<div class="report-name-cell">' +
                            '<span class="report-name">' + (report.description || report.name || 'Untitled Report') + '</span>' +
                            '<div class="report-badges mt-1">' + categoryBadge + rowCountBadge + '</div>' +
                        '</div>' +
                    '</td>' +
                    '<td><small class="text-muted">' + date + '</small></td>' +
                    '<td>' + sourceBadge + '</td>'
                );

                tbody.append(row);
            });

            // Use event delegation for click handlers (survives DataTable re-rendering)
            $('#reports-table-wrapper').off('click', '.report-row').on('click', '.report-row', function() {
                var $row = $(this);
                var slug = $row.data('report-slug');

                $('.report-row').removeClass('table-primary');
                $row.addClass('table-primary');
                self.loadReportDetails(slug);
            });

            // Initialize DataTable
            if (this.reportsDataTable) {
                this.reportsDataTable.destroy();
                this.reportsDataTable = null;
            }

            setTimeout(function() {
                try {
                    self.reportsDataTable = new simpleDatatables.DataTable("#reports-table", {
                        searchable: true,
                        fixedHeight: false,
                        perPage: 15,
                        loading: false,
                        labels: {
                            placeholder: "Search reports...",
                            noRows: "No reports found",
                            info: "Showing {start} to {end} of {rows} reports"
                        }
                    });

                    // Remove loading class
                    setTimeout(function() {
                        $('.datatable-wrapper').removeClass('datatable-loading');
                    }, 100);

                    // Auto-select first report after DataTable is ready
                    setTimeout(function() {
                        var firstRow = $('.report-row').first();
                        if (firstRow.length && !self.currentReport) {
                            firstRow.addClass('table-primary');
                            var firstSlug = firstRow.data('report-slug');
                            if (firstSlug) {
                                self.loadReportDetails(firstSlug);
                            }
                        }
                    }, 150);
                } catch (e) {
                    console.warn('DataTable initialization failed:', e);
                }
            }, 100);
        },

        loadReportDetails: function(slug) {
            var self = this;
            var token = this.getAuthToken();

            $('#report-placeholder').addClass('d-none');
            $('#report-content').addClass('d-none');
            $('#report-loading').removeClass('d-none');

            // Find cached report for immediate title update and source detection
            var cachedReport = this.cachedReports.find(function(r) { return r.slug === slug; });
            var source = cachedReport ? (cachedReport.source || 'assistant') : 'assistant';

            if (cachedReport) {
                $('.report-view-title').text(cachedReport.description || cachedReport.name || 'Report Details');
            }

            // Handle wizard reports differently - they need to be executed
            if (source === 'wizard' && cachedReport) {
                self.loadWizardReport(cachedReport);
                return;
            }

            // For assistant reports, fetch from external API
            $.ajax({
                url: 'https://a360backend.stagingwithswift.com/api/v1/ai-reports/' + slug,
                method: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + token,
                    'Content-Type': 'application/json'
                },
                timeout: 30000,
                success: function(response) {
                    // API returns: response.report (metadata) and response.data (rows)
                    var report = response.report || response;
                    var data = response.data || [];

                    // Preserve source
                    report.source = source;

                    self.currentReport = report;
                    self.currentReportData = data;

                    // Update cached report with full data
                    var cacheIndex = self.cachedReports.findIndex(function(r) { return r.slug === slug; });
                    if (cacheIndex !== -1) {
                        self.cachedReports[cacheIndex] = Object.assign({}, report, { data: data, source: source });
                    }

                    self.renderReportContent(report, data);
                },
                error: function(xhr, status, error) {
                    $('#report-loading').addClass('d-none');
                    $('#report-content').html(
                        '<div class="alert alert-danger">' +
                            '<i class="fa fa-exclamation-circle"></i> Failed to load report details.' +
                            '<button class="btn btn-sm btn-outline-danger ms-3" onclick="GeneratedReports.loadReportDetails(\'' + slug + '\')"><i class="fa fa-refresh"></i> Retry</button>' +
                        '</div>'
                    ).removeClass('d-none');
                }
            });
        },

        // Load and execute a wizard report
        loadWizardReport: function(cachedReport) {
            var self = this;

            // Build form data for the generate_report.php endpoint
            var formData = 'reportid=' + encodeURIComponent(cachedReport.name) + '&sesskey=' + M.cfg.sesskey;

            // Add saved parameters if available
            if (cachedReport.parameters && typeof cachedReport.parameters === 'object') {
                Object.keys(cachedReport.parameters).forEach(function(key) {
                    formData += '&' + encodeURIComponent(key) + '=' + encodeURIComponent(cachedReport.parameters[key]);
                });
            }

            $.ajax({
                url: M.cfg.wwwroot + '/report/adeptus_insights/ajax/generate_report.php',
                method: 'POST',
                data: formData,
                timeout: 60000, // Longer timeout for report generation
                success: function(response) {
                    if (response.success) {
                        var data = response.results || response.data || [];
                        var report = {
                            name: cachedReport.name,
                            description: cachedReport.description || cachedReport.name,
                            category: response.report?.category || cachedReport.category || 'Wizard Report',
                            created_at: cachedReport.created_at,
                            source: 'wizard',
                            slug: cachedReport.slug
                        };

                        self.currentReport = report;
                        self.currentReportData = data;

                        // Update cached report with full data
                        var cacheIndex = self.cachedReports.findIndex(function(r) { return r.slug === cachedReport.slug; });
                        if (cacheIndex !== -1) {
                            self.cachedReports[cacheIndex].data = data;
                            self.cachedReports[cacheIndex].row_count = data.length;
                        }

                        self.renderReportContent(report, data);
                    } else {
                        $('#report-loading').addClass('d-none');
                        $('#report-content').html(
                            '<div class="alert alert-warning">' +
                                '<i class="fa fa-exclamation-triangle"></i> ' + (response.message || 'Failed to generate report.') +
                                '<button class="btn btn-sm btn-outline-warning ms-3" onclick="GeneratedReports.loadReportDetails(\'' + cachedReport.slug + '\')"><i class="fa fa-refresh"></i> Retry</button>' +
                            '</div>'
                        ).removeClass('d-none');
                    }
                },
                error: function(xhr, status, error) {
                    $('#report-loading').addClass('d-none');
                    $('#report-content').html(
                        '<div class="alert alert-danger">' +
                            '<i class="fa fa-exclamation-circle"></i> Failed to execute wizard report.' +
                            '<button class="btn btn-sm btn-outline-danger ms-3" onclick="GeneratedReports.loadReportDetails(\'' + cachedReport.slug + '\')"><i class="fa fa-refresh"></i> Retry</button>' +
                        '</div>'
                    ).removeClass('d-none');
                }
            });
        },

        renderReportContent: function(report, data) {
            var self = this;
            $('#report-loading').addClass('d-none');

            var contentHtml = '';
            var rowCount = data ? data.length : 0;

            // Report header with enhanced styling
            contentHtml += '<div class="report-detail-header mb-4">';
            contentHtml += '<h4 class="mb-2">' + (report.description || report.name || 'Report') + '</h4>';
            contentHtml += '<div class="report-meta d-flex flex-wrap align-items-center gap-2">';

            // Source badge
            var reportSource = (report.source || 'assistant').toLowerCase();
            if (reportSource === 'wizard') {
                contentHtml += '<span class="badge badge-wizard"><i class="fa fa-magic"></i> Wizard</span>';
            } else {
                contentHtml += '<span class="badge badge-ai"><i class="fa fa-robot"></i> AI</span>';
            }

            // Row count badge
            contentHtml += '<span class="badge badge-rowcount"><i class="fa fa-table"></i> ' + rowCount + ' rows</span>';
            contentHtml += '</div>';
            contentHtml += '</div>';

            // Action bar with view toggle and export buttons
            contentHtml += '<div class="action-bar d-flex justify-content-between align-items-center mb-3">';

            // View toggle buttons
            contentHtml += '<div class="view-toggle btn-group" role="group">';
            contentHtml += '<button type="button" class="btn btn-sm view-toggle-btn active" data-view="table"><i class="fa fa-table"></i> Table</button>';
            contentHtml += '<button type="button" class="btn btn-sm view-toggle-btn" data-view="chart"><i class="fa fa-bar-chart"></i> Chart</button>';
            contentHtml += '</div>';

            // Export buttons
            contentHtml += '<div class="export-buttons d-flex gap-2">';
            contentHtml += '<button class="btn btn-outline-primary btn-sm export-csv-btn"><i class="fa fa-file-excel-o"></i> Export CSV</button>';
            contentHtml += '<button class="btn btn-outline-secondary btn-sm export-json-btn"><i class="fa fa-code"></i> Export JSON</button>';
            contentHtml += '</div>';
            contentHtml += '</div>';

            // Data views container
            if (data && data.length > 0) {
                var headers = Object.keys(data[0]);
                var displayLimit = 100;

                // Table View
                contentHtml += '<div id="report-table-view" class="report-view">';
                contentHtml += '<div class="report-data-wrapper">';
                contentHtml += '<div class="table-responsive report-table-container">';
                contentHtml += '<table class="table table-striped table-hover table-sm report-data-table">';
                contentHtml += '<thead class="table-light sticky-header"><tr>';
                headers.forEach(function(header) {
                    var formattedHeader = header.replace(/_/g, ' ').replace(/\b\w/g, function(l) { return l.toUpperCase(); });
                    contentHtml += '<th>' + formattedHeader + '</th>';
                });
                contentHtml += '</tr></thead>';
                contentHtml += '<tbody>';

                var displayData = data.slice(0, displayLimit);
                displayData.forEach(function(row) {
                    contentHtml += '<tr>';
                    headers.forEach(function(header) {
                        var value = row[header];
                        if (value === null || value === undefined) value = '';
                        var displayValue = String(value);
                        if (displayValue.length > 100) {
                            displayValue = displayValue.substring(0, 100) + '...';
                        }
                        contentHtml += '<td title="' + String(value).replace(/"/g, '&quot;') + '">' + displayValue + '</td>';
                    });
                    contentHtml += '</tr>';
                });

                contentHtml += '</tbody></table>';
                contentHtml += '</div>';
                contentHtml += '</div>';

                if (data.length > displayLimit) {
                    contentHtml += '<div class="alert alert-info mt-3 d-flex align-items-center justify-content-between">';
                    contentHtml += '<span><i class="fa fa-info-circle"></i> Showing first ' + displayLimit + ' rows of ' + data.length + ' total rows.</span>';
                    contentHtml += '<span class="text-primary">Export to see all data</span>';
                    contentHtml += '</div>';
                }
                contentHtml += '</div>'; // Close table view

                // Chart View
                contentHtml += '<div id="report-chart-view" class="report-view d-none">';
                contentHtml += '<div class="chart-controls-wrapper mb-3">';
                contentHtml += '<div class="chart-controls d-flex flex-wrap align-items-center gap-3">';

                // Chart type selector
                contentHtml += '<div class="control-group">';
                contentHtml += '<label for="chart-type-select" class="form-label">Chart Type</label>';
                contentHtml += '<select id="chart-type-select" class="form-select form-select-sm">';
                contentHtml += '<option value="bar">Bar Chart</option>';
                contentHtml += '<option value="line">Line Chart</option>';
                contentHtml += '<option value="pie">Pie Chart</option>';
                contentHtml += '<option value="doughnut">Doughnut Chart</option>';
                contentHtml += '</select>';
                contentHtml += '</div>';

                // X-Axis selector
                contentHtml += '<div class="control-group">';
                contentHtml += '<label for="chart-x-axis" class="form-label">X-Axis (Labels)</label>';
                contentHtml += '<select id="chart-x-axis" class="form-select form-select-sm">';
                headers.forEach(function(header, idx) {
                    var formattedHeader = header.replace(/_/g, ' ').replace(/\b\w/g, function(l) { return l.toUpperCase(); });
                    var selected = idx === 0 ? ' selected' : '';
                    contentHtml += '<option value="' + header + '"' + selected + '>' + formattedHeader + '</option>';
                });
                contentHtml += '</select>';
                contentHtml += '</div>';

                // Y-Axis selector (only numeric columns)
                var numericCols = self.detectNumericColumns(data, headers);
                contentHtml += '<div class="control-group">';
                contentHtml += '<label for="chart-y-axis" class="form-label">Y-Axis (Values)</label>';
                contentHtml += '<select id="chart-y-axis" class="form-select form-select-sm">';
                if (numericCols.length > 0) {
                    numericCols.forEach(function(col, idx) {
                        var formattedHeader = col.replace(/_/g, ' ').replace(/\b\w/g, function(l) { return l.toUpperCase(); });
                        var selected = idx === numericCols.length - 1 ? ' selected' : '';
                        contentHtml += '<option value="' + col + '"' + selected + '>' + formattedHeader + '</option>';
                    });
                } else {
                    // Fallback to all columns if no numeric found
                    headers.forEach(function(header, idx) {
                        var formattedHeader = header.replace(/_/g, ' ').replace(/\b\w/g, function(l) { return l.toUpperCase(); });
                        var selected = idx === headers.length - 1 ? ' selected' : '';
                        contentHtml += '<option value="' + header + '"' + selected + '>' + formattedHeader + '</option>';
                    });
                }
                contentHtml += '</select>';
                contentHtml += '</div>';

                contentHtml += '</div>'; // End chart-controls
                contentHtml += '</div>'; // End chart-controls-wrapper

                contentHtml += '<div class="chart-container" style="position: relative; height: 400px;">';
                contentHtml += '<canvas id="report-chart"></canvas>';
                contentHtml += '</div>';
                contentHtml += '</div>';

            } else {
                contentHtml += '<div class="alert alert-warning text-center py-4">';
                contentHtml += '<i class="fa fa-inbox fa-2x mb-2 d-block"></i>';
                contentHtml += '<strong>No data available</strong><br>';
                contentHtml += '<small class="text-muted">This report has no data rows.</small>';
                contentHtml += '</div>';
            }

            $('#report-content').html(contentHtml).removeClass('d-none');

            // Reset view to table
            self.currentView = 'table';

            // Attach export handlers
            $('#report-content .export-csv-btn').on('click', function() {
                self.exportReport(report.slug, 'csv');
            });
            $('#report-content .export-json-btn').on('click', function() {
                self.exportReport(report.slug, 'json');
            });
        },

        renderChart: function() {
            var self = this;
            var data = this.currentReportData;

            if (!data || data.length === 0) return;

            var chartType = $('#chart-type-select').val() || 'bar';
            var canvas = document.getElementById('report-chart');
            if (!canvas) return;

            // Destroy existing chart
            if (this.chartInstance) {
                this.chartInstance.destroy();
                this.chartInstance = null;
            }

            // Get user-selected axis columns
            var labelKey = $('#chart-x-axis').val();
            var valueKey = $('#chart-y-axis').val();

            // Fallback if not set
            if (!labelKey || !valueKey) {
                var headers = Object.keys(data[0]);
                labelKey = labelKey || headers[0];
                valueKey = valueKey || headers[headers.length - 1];
            }

            // Format the value key for display
            var valueKeyFormatted = valueKey.replace(/_/g, ' ').replace(/\b\w/g, function(l) { return l.toUpperCase(); });

            // Limit data for chart (max 50 items for readability)
            var chartData = data.slice(0, 50);
            var labels = chartData.map(function(r) {
                var label = r[labelKey];
                if (label === null || label === undefined) return 'Unknown';
                // Truncate long labels
                var labelStr = String(label);
                return labelStr.length > 30 ? labelStr.substring(0, 30) + '...' : labelStr;
            });
            var values = chartData.map(function(r) { return parseFloat(r[valueKey]) || 0; });

            // Generate colors
            var colors = this.generateChartColors(values.length, chartType);

            // Create chart config
            var chartConfig = this.createChartConfig(chartType, labels, values, valueKeyFormatted, colors);

            try {
                this.chartInstance = new this.Chart(canvas.getContext('2d'), chartConfig);
            } catch (error) {
                console.error('Error creating chart:', error);
                $('#report-chart-view .chart-container').html(
                    '<div class="alert alert-danger"><i class="fa fa-exclamation-triangle"></i> Error rendering chart: ' + error.message + '</div>'
                );
            }
        },

        generateChartColors: function(count, chartType) {
            var baseColors = [
                '#2563eb', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6',
                '#06b6d4', '#ec4899', '#84cc16', '#f97316', '#6366f1',
                '#14b8a6', '#a855f7', '#eab308', '#22c55e', '#3b82f6'
            ];

            var colors = [];
            for (var i = 0; i < count; i++) {
                colors.push(baseColors[i % baseColors.length]);
            }
            return colors;
        },

        createChartConfig: function(chartType, labels, values, valueKey, colors) {
            var self = this;
            var reportName = this.currentReport?.description || this.currentReport?.name || 'Report';

            var baseConfig = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: reportName,
                        font: { size: 16, weight: 'bold' },
                        padding: { top: 10, bottom: 20 }
                    },
                    legend: {
                        display: chartType === 'pie' || chartType === 'doughnut',
                        position: 'right'
                    }
                }
            };

            if (chartType === 'pie' || chartType === 'doughnut') {
                return {
                    type: chartType,
                    data: {
                        labels: labels,
                        datasets: [{
                            data: values,
                            backgroundColor: colors,
                            borderColor: '#fff',
                            borderWidth: 2
                        }]
                    },
                    options: baseConfig
                };
            } else if (chartType === 'line') {
                return {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: valueKey,
                            data: values,
                            borderColor: colors[0],
                            backgroundColor: colors[0] + '40',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        ...baseConfig,
                        scales: {
                            y: { beginAtZero: true },
                            x: { ticks: { maxRotation: 45, minRotation: 45 } }
                        }
                    }
                };
            } else {
                // Bar chart (default)
                return {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: valueKey,
                            data: values,
                            backgroundColor: colors,
                            borderColor: colors.map(function(c) { return c; }),
                            borderWidth: 1
                        }]
                    },
                    options: {
                        ...baseConfig,
                        scales: {
                            y: { beginAtZero: true },
                            x: { ticks: { maxRotation: 45, minRotation: 45 } }
                        }
                    }
                };
            }
        },

        exportReport: async function(reportSlug, format) {
            var self = this;

            // Check if we have data to export
            if (!self.currentReportData || !Array.isArray(self.currentReportData) || self.currentReportData.length === 0) {
                Swal.fire({
                    icon: 'warning',
                    title: 'No Data',
                    text: 'No data available to export. Please load the report first.'
                });
                return;
            }

            Swal.fire({
                title: 'Exporting as ' + format.toUpperCase() + '...',
                allowOutsideClick: false,
                didOpen: function() { Swal.showLoading(); }
            });

            try {
                // For wizard reports, use the actual report name instead of the slug
                var reportId = reportSlug;
                var isWizardReport = self.currentReport && self.currentReport.source === 'wizard';
                if (isWizardReport && self.currentReport.name) {
                    reportId = self.currentReport.name;
                }

                var body = 'reportid=' + encodeURIComponent(reportId) + '&format=' + format + '&sesskey=' + M.cfg.sesskey;
                body += '&view=table';

                // Always pass the frontend data for export
                var headers = self.currentReportData.length > 0 ? Object.keys(self.currentReportData[0]) : [];
                var reportDataPayload = {
                    results: self.currentReportData,
                    headers: headers,
                    report_name: self.currentReport?.description || self.currentReport?.name || 'report',
                    report_category: self.currentReport?.category || ''
                };
                body += '&report_data=' + encodeURIComponent(JSON.stringify(reportDataPayload));

                var response = await fetch(M.cfg.wwwroot + '/report/adeptus_insights/ajax/export_report.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: body
                });

                var contentType = response.headers.get('content-type');
                var contentDisposition = response.headers.get('content-disposition');

                if (contentType && contentType.includes('application/json') && !contentDisposition) {
                    var errorData = await response.json();
                    throw new Error(errorData.message || 'Export failed');
                }

                if (!response.ok) {
                    throw new Error('Export failed with status: ' + response.status);
                }

                var reportName = self.currentReport?.description || self.currentReport?.name || 'report';
                var sanitizedName = reportName.replace(/[^a-zA-Z0-9\s-]/g, '').replace(/\s+/g, '_').toLowerCase();
                var dateSuffix = new Date().toISOString().split('T')[0];

                var blob = await response.blob();
                var url = window.URL.createObjectURL(blob);
                var link = document.createElement('a');
                link.href = url;
                link.download = sanitizedName + '_' + dateSuffix + '.' + format;
                document.body.appendChild(link);
                link.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(link);

                Swal.close();
                Swal.fire({
                    icon: 'success',
                    title: 'Success',
                    text: format.toUpperCase() + ' file downloaded successfully!',
                    timer: 2000,
                    showConfirmButton: false
                });

            } catch (error) {
                Swal.close();
                Swal.fire({
                    icon: 'error',
                    title: 'Export Failed',
                    text: error.message || 'Failed to export report.'
                });
            }
        }
    };

    // Make available globally for retry buttons
    window.GeneratedReports = GeneratedReports;

    // Initialize when DOM is ready
    $(document).ready(function() {
        // Wait for auth data to be available
        var checkAuth = setInterval(function() {
            if (window.adeptusAuthData) {
                clearInterval(checkAuth);
                GeneratedReports.init();
            }
        }, 100);

        // Timeout after 5 seconds
        setTimeout(function() {
            clearInterval(checkAuth);
            if (!window.adeptusAuthData) {
                $('#reports-loader').addClass('d-none');
                $('#no-reports-message').removeClass('d-none').html(
                    '<i class="fa fa-exclamation-triangle fa-3x text-warning mb-3"></i>' +
                    '<h5 class="text-muted">Authentication Required</h5>' +
                    '<p class="text-muted">Please ensure you are logged in to view reports.</p>'
                );
            }
        }, 5000);
    });
});
{{/js}}

<style>
/* Page Header Banner - Consistent with Wizard/Assistant */
.page-header-banner {
    background: linear-gradient(135deg, #0f6cbf 0%, #3a8dd4 100%);
    color: white;
    padding: 30px;
    border-radius: 0.75rem;
    margin-bottom: 30px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: relative;
    overflow: hidden;
}

.page-header-banner::before {
    content: '';
    position: absolute;
    top: -50%;
    right: -20%;
    width: 100%;
    height: 200%;
    background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="2" fill="rgba(255,255,255,0.1)"/></svg>') repeat;
    animation: float 20s linear infinite;
}

@keyframes float {
    0% { transform: translateY(0) rotate(0deg); }
    100% { transform: translateY(-50%) rotate(360deg); }
}

.page-header-content {
    z-index: 1;
}

.page-header-title {
    font-size: 1.75rem;
    font-weight: 700;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 12px;
}

.page-header-icon {
    font-size: 1.5rem;
    animation: iconPulse 3s ease-in-out infinite;
}

@keyframes iconPulse {
    0%, 100% { transform: scale(1) rotate(0deg); }
    50% { transform: scale(1.1) rotate(5deg); }
}

.page-header-subtitle {
    font-size: 1rem;
    opacity: 0.9;
    margin: 10px 0 0 0;
}

.page-header-actions {
    display: flex;
    gap: 10px;
    z-index: 1;
}

.page-header-actions .btn-light {
    background: white;
    color: #0f6cbf;
    border: none;
    font-weight: 500;
}

.page-header-actions .btn-light:hover {
    background: #f8f9fa;
    color: #0a5299;
}

.page-header-actions .btn-outline-light {
    border: 2px solid rgba(255,255,255,0.8);
    color: white;
    font-weight: 500;
}

.page-header-actions .btn-outline-light:hover {
    background: rgba(255,255,255,0.15);
    border-color: white;
}

@media (max-width: 768px) {
    .page-header-banner {
        flex-direction: column;
        text-align: center;
        gap: 20px;
    }

    .page-header-actions {
        flex-direction: column;
        width: 100%;
    }

    .page-header-actions .btn {
        width: 100%;
    }
}

.generated-reports-container {
    padding: 0;
}

.generated-reports-container .card {
    border: none;
    border-radius: 0.75rem;
    overflow: hidden;
    box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,0.075);
}

.generated-reports-container .card-header {
    border: none;
}

.report-row {
    cursor: pointer;
    transition: background-color 0.15s ease;
}

.report-row:hover {
    background-color: #f8f9fa;
}

.report-row.table-primary {
    background-color: #e7f3ff !important;
}

.report-header h4 {
    color: #2c3e50;
    font-weight: 600;
}

.report-meta {
    margin-top: 0.5rem;
}

.gap-2 {
    gap: 0.5rem;
}

/* DataTable styling */
.datatable-wrapper .datatable-top,
.datatable-wrapper .datatable-bottom {
    padding: 0.75rem 1rem;
}

.datatable-wrapper .datatable-search input {
    border-radius: 0.5rem;
    padding: 0.5rem 1rem;
}

/* Export buttons */
.export-csv-btn, .export-json-btn {
    border-radius: 0.5rem;
}

/* Table styling */
.table-responsive {
    border-radius: 0.5rem;
    overflow: hidden;
}

.table thead th {
    background-color: #f8f9fa;
    font-weight: 600;
    border-bottom: 2px solid #dee2e6;
    white-space: nowrap;
}

.table tbody td {
    vertical-align: middle;
}

/* Badge styling */
.badge {
    font-weight: 500;
    padding: 0.35rem 0.65rem;
}

/* Source badges */
.badge-ai {
    background: linear-gradient(135deg, #1e3a5f 0%, #2563eb 100%);
    color: white;
    font-size: 11px;
    padding: 0.4rem 0.75rem;
    border-radius: 20px;
    display: inline-flex;
    align-items: center;
    gap: 5px;
}

.badge-wizard {
    background: linear-gradient(135deg, #0ea5e9 0%, #06b6d4 100%);
    color: white;
    font-size: 11px;
    padding: 0.4rem 0.75rem;
    border-radius: 20px;
    display: inline-flex;
    align-items: center;
    gap: 5px;
}

.badge-ai i,
.badge-wizard i,
.badge-rowcount i {
    font-size: 10px;
}

.badge-rowcount {
    background: #6c757d;
    color: white;
    font-size: 11px;
    padding: 0.4rem 0.75rem;
    border-radius: 20px;
    display: inline-flex;
    align-items: center;
    gap: 5px;
}

/* View toggle buttons */
.view-toggle .view-toggle-btn {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    color: #495057;
    padding: 0.35rem 0.75rem;
    font-size: 13px;
    transition: all 0.2s ease;
}

.view-toggle .view-toggle-btn:first-child {
    border-radius: 6px 0 0 6px;
}

.view-toggle .view-toggle-btn:last-child {
    border-radius: 0 6px 6px 0;
}

.view-toggle .view-toggle-btn:hover {
    background: #e9ecef;
}

.view-toggle .view-toggle-btn.active {
    background: #2563eb;
    border-color: #2563eb;
    color: white;
}

.view-toggle .view-toggle-btn i {
    margin-right: 5px;
}

/* Chart container */
.chart-container {
    background: #fff;
    border-radius: 8px;
    padding: 1rem;
    border: 1px solid #e9ecef;
}

.chart-controls-wrapper {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 1rem;
    border: 1px solid #e9ecef;
}

.chart-controls {
    display: flex;
    align-items: flex-end;
    flex-wrap: wrap;
}

.chart-controls .control-group {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
}

.chart-controls .form-label {
    font-size: 11px;
    font-weight: 600;
    color: #6c757d;
    margin-bottom: 0;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.chart-controls .form-select {
    font-size: 13px;
    padding: 0.4rem 2rem 0.4rem 0.75rem;
    border-radius: 6px;
    border: 1px solid #dee2e6;
    background-color: white;
    min-width: 140px;
}

.chart-controls .form-select:focus {
    border-color: #2563eb;
    box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.15);
}

/* Hide loader completely when d-none is applied */
#reports-loader.d-none {
    display: none !important;
    height: 0 !important;
    min-height: 0 !important;
    padding: 0 !important;
    margin: 0 !important;
    overflow: hidden !important;
}

/* DataTable filter layout fix */
.datatable-wrapper .datatable-top {
    display: flex;
    flex-wrap: wrap;
    justify-content: space-between;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 0.75rem !important;
}

.datatable-wrapper .datatable-dropdown {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    flex-shrink: 0;
}

.datatable-wrapper .datatable-dropdown label {
    margin: 0;
    font-size: 13px;
    white-space: nowrap;
}

.datatable-wrapper .datatable-dropdown select {
    padding: 0.25rem 0.5rem;
    font-size: 13px;
    border-radius: 4px;
    border: 1px solid #dee2e6;
    min-width: 60px;
}

.datatable-wrapper .datatable-search {
    flex: 1;
    min-width: 150px;
    max-width: 250px;
}

.datatable-wrapper .datatable-search input {
    width: 100%;
    padding: 0.35rem 0.75rem;
    font-size: 13px;
    border: 1px solid #dee2e6;
    border-radius: 4px;
}

.datatable-wrapper .datatable-bottom {
    display: flex;
    flex-wrap: wrap;
    justify-content: space-between;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 0.75rem !important;
    font-size: 13px;
}

.datatable-wrapper .datatable-info {
    color: #6c757d;
}

.datatable-wrapper .datatable-pagination {
    display: flex;
    gap: 0.25rem;
}

.datatable-wrapper .datatable-pagination a {
    padding: 0.25rem 0.5rem;
    font-size: 12px;
    border-radius: 4px;
    text-decoration: none;
    color: #495057;
    background: #f8f9fa;
    border: 1px solid #dee2e6;
}

.datatable-wrapper .datatable-pagination a.active,
.datatable-wrapper .datatable-pagination a:hover {
    background: #2563eb;
    color: white;
    border-color: #2563eb;
}

/* Responsive */
@media (max-width: 768px) {
    .generated-reports-container .col-md-4,
    .generated-reports-container .col-md-8 {
        margin-bottom: 1rem;
    }

    .card-body[style*="calc(100vh"] {
        height: auto !important;
        max-height: 400px !important;
        min-height: 250px !important;
    }
}

/* Category Management Modal */
.category-management-modal .categories-list {
    border: 1px solid #e9ecef;
    border-radius: 8px;
    background: #f8f9fa;
}

.category-management-modal .category-item {
    background: white;
    transition: background-color 0.15s ease;
}

.category-management-modal .category-item:hover {
    background-color: #f8f9fa;
}

.category-management-modal .category-item:first-child {
    border-radius: 8px 8px 0 0;
}

.category-management-modal .category-item:last-child {
    border-radius: 0 0 8px 8px;
    border-bottom: none;
}

.category-color-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    display: inline-block;
    border: 1px solid rgba(0,0,0,0.1);
}

.category-management-modal .input-group {
    border-radius: 8px;
    overflow: hidden;
}

.category-management-modal .form-control-color {
    width: 45px;
    padding: 0.375rem;
    cursor: pointer;
}

.category-management-modal .category-actions {
    opacity: 0.6;
    transition: opacity 0.15s ease;
}

.category-management-modal .category-item:hover .category-actions {
    opacity: 1;
}

.category-modal-popup {
    border-radius: 12px !important;
}

.category-modal-popup .swal2-title {
    font-size: 1.25rem;
}
</style>
