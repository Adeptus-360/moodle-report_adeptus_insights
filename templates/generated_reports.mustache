{{!
    This file is part of Moodle - http://moodle.org/

    Moodle is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    Moodle is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
}}
{{!
    @template   report_adeptus_insights/generated_reports

    Generated reports list template displaying saved reports with filtering,
    sorting, and export options.

    Note: Do NOT load Bootstrap from CDN - Moodle includes Bootstrap and
    loading another version breaks navigation.

    @package    report_adeptus_insights
    @copyright  2026 Adeptus 360 <info@adeptus360.com>
    @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
}}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.all.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/simple-datatables@latest" type="text/javascript"></script>
<link href="https://cdn.jsdelivr.net/npm/simple-datatables@latest/dist/style.css" rel="stylesheet" type="text/css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="stylesheet" href="{{config.wwwroot}}/report/adeptus_insights/styles/assistant.css">

<div class="adeptus-generated-reports-container">
    <!-- Toast Container for notifications -->
    <div id="adeptus-toast-container" style="position: fixed; top: 20px; right: 20px; z-index: 10000;"></div>

    <!-- Header Banner -->
    <div class="adeptus-page-header-banner">
        <div class="adeptus-page-header-content">
            <h1 class="adeptus-page-header-title">
                <i class="fa fa-chart-bar adeptus-page-header-icon"></i>
                {{#str}}generated_reports_title, report_adeptus_insights{{/str}}
            </h1>
            <p class="adeptus-page-header-subtitle">{{#str}}generated_reports_desc, report_adeptus_insights{{/str}}</p>
        </div>
        <div class="adeptus-page-header-actions">
            <button type="button" class="btn btn-outline-light" id="manage-categories-btn">
                <i class="fa fa-tags"></i> {{#str}}manage_categories, report_adeptus_insights{{/str}}
            </button>
            <a href="{{config.wwwroot}}/report/adeptus_insights/assistant.php" class="btn btn-outline-light">
                <i class="fa fa-plus"></i> {{#str}}generate_new_report, report_adeptus_insights{{/str}}
            </a>
            <a href="{{config.wwwroot}}/report/adeptus_insights/index.php" class="btn btn-light">
                <i class="fa fa-arrow-left"></i> {{#str}}back_to_dashboard, report_adeptus_insights{{/str}}
            </a>
        </div>
    </div>

    <div class="container-fluid">
        <!-- Main Content -->
        <div class="row">
            <!-- Reports List -->
            <div class="col-md-4">
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="card-title mb-0"><i class="fa fa-list"></i> {{#str}}all_reports, report_adeptus_insights{{/str}}</h5>
                    </div>
                    <div class="card-body p-0 position-relative" style="height: calc(100vh - 280px); overflow-y: auto; min-height: 400px; max-height: 800px;">
                        <div id="reports-loader" class="p-4 d-flex justify-content-center align-items-center" style="min-height: 200px;">
                            <div class="spinner-border text-primary" role="status">
                                <span class="sr-only">{{#str}}loading, report_adeptus_insights{{/str}}</span>
                            </div>
                        </div>
                        <div class="d-none" id="reports-table-wrapper">
                            <table id="reports-table" class="table mb-0">
                                <thead>
                                    <tr>
                                        <th>{{#str}}report_name, report_adeptus_insights{{/str}}</th>
                                        <th>{{#str}}date, report_adeptus_insights{{/str}}</th>
                                        <th>{{#str}}from, report_adeptus_insights{{/str}}</th>
                                    </tr>
                                </thead>
                                <tbody id="reports-tbody">
                                    <!-- Report rows will be injected here -->
                                </tbody>
                            </table>
                        </div>
                        <div id="no-reports-message" class="text-center py-5 d-none">
                            <i class="fa fa-inbox fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">{{#str}}no_reports_yet, report_adeptus_insights{{/str}}</h5>
                            <p class="text-muted">{{#str}}no_reports_yet_desc, report_adeptus_insights{{/str}}</p>
                            <a href="{{config.wwwroot}}/report/adeptus_insights/assistant.php" class="btn btn-outline-primary mt-2">
                                <i class="fa fa-robot"></i> {{#str}}go_to_ai_assistant, report_adeptus_insights{{/str}}
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Report Preview -->
            <div class="col-md-8">
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0 adeptus-report-view-title">{{#str}}select_a_report, report_adeptus_insights{{/str}}</h5>
                        <div class="adeptus-report-category-selector d-none" id="report-category-selector">
                            <div class="adeptus-category-dropdown-wrapper">
                                <button type="button" class="adeptus-category-current-btn" id="category-current-btn">
                                    <span class="adeptus-category-dot" id="category-dot"></span>
                                    <span class="adeptus-category-name" id="category-name">{{#str}}general, report_adeptus_insights{{/str}}</span>
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"></polyline></svg>
                                </button>
                                <div class="adeptus-category-dropdown-menu" id="category-dropdown-menu">
                                    <!-- Categories will be injected here -->
                                </div>
                            </div>
                            <button type="button" class="btn btn-sm btn-outline-danger adeptus-delete-report-header-btn" id="delete-report-header-btn" title="Delete Report">
                                <i class="fa fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body p-4 adeptus-report-view-body" style="height: calc(100vh - 280px); overflow-y: auto; min-height: 400px; max-height: 800px;">
                        <div id="report-placeholder" class="text-center py-5">
                            <i class="fa fa-file-alt fa-4x text-muted mb-3"></i>
                            <h5 class="text-muted">{{#str}}select_report_to_view, report_adeptus_insights{{/str}}</h5>
                            <p class="text-muted">{{#str}}click_report_to_view, report_adeptus_insights{{/str}}</p>
                        </div>
                        <div id="report-loading" class="text-center py-5 d-none">
                            <div class="spinner-border text-primary" role="status">
                                <span class="sr-only">{{#str}}loading_report, report_adeptus_insights{{/str}}</span>
                            </div>
                            <p class="mt-3 text-muted">{{#str}}loading_report_data, report_adeptus_insights{{/str}}</p>
                        </div>
                        <div id="report-content" class="d-none">
                            <!-- Report content will be injected here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{{#js}}
require(['jquery', 'core/chartjs'], function($, Chart) {
    'use strict';

    // Localized strings injected from Mustache
    var STRINGS = {
        // General
        general: '{{#str}}general, report_adeptus_insights{{/str}}',
        wizard: '{{#str}}wizard, report_adeptus_insights{{/str}}',
        ai: '{{#str}}ai, report_adeptus_insights{{/str}}',
        report: '{{#str}}report, report_adeptus_insights{{/str}}',
        reportDetails: '{{#str}}report_details, report_adeptus_insights{{/str}}',
        untitledReport: '{{#str}}untitled_report, report_adeptus_insights{{/str}}',
        unknown: '{{#str}}unknown, report_adeptus_insights{{/str}}',
        rows: '{{#str}}rows, report_adeptus_insights{{/str}}',
        table: '{{#str}}table, report_adeptus_insights{{/str}}',
        chart: '{{#str}}chart, report_adeptus_insights{{/str}}',
        retry: '{{#str}}retry, report_adeptus_insights{{/str}}',
        cancel: '{{#str}}cancel, report_adeptus_insights{{/str}}',
        error: '{{#str}}error, report_adeptus_insights{{/str}}',

        // Export
        exportPdf: '{{#str}}export_pdf, report_adeptus_insights{{/str}}',
        exportCsv: '{{#str}}export_csv, report_adeptus_insights{{/str}}',
        exportJson: '{{#str}}export_json, report_adeptus_insights{{/str}}',
        exportingAs: '{{#str}}exporting_as, report_adeptus_insights{{/str}}',
        exportNotAvailable: '{{#str}}export_not_available, report_adeptus_insights{{/str}}',
        exportNotEligible: '{{#str}}export_not_eligible, report_adeptus_insights{{/str}}',
        exportFailed: '{{#str}}export_failed, report_adeptus_insights{{/str}}',
        exportFailedMessage: '{{#str}}export_failed_message, report_adeptus_insights{{/str}}',
        fileDownloadedSuccess: '{{#str}}file_downloaded_success, report_adeptus_insights{{/str}}',
        noData: '{{#str}}no_data, report_adeptus_insights{{/str}}',
        noDataToExport: '{{#str}}no_data_to_export, report_adeptus_insights{{/str}}',
        noDataAvailable: '{{#str}}no_data_available, report_adeptus_insights{{/str}}',
        noDataRows: '{{#str}}no_data_rows, report_adeptus_insights{{/str}}',

        // Premium
        premiumExportFormat: '{{#str}}premium_export_format, report_adeptus_insights{{/str}}',
        premiumFeature: '{{#str}}premium_feature, report_adeptus_insights{{/str}}',
        upgradeNow: '{{#str}}upgrade_now, report_adeptus_insights{{/str}}',
        freePlan: '{{#str}}free_plan_label, report_adeptus_insights{{/str}}',
        freePlanPdfOnly: '{{#str}}free_plan_pdf_only, report_adeptus_insights{{/str}}',
        paidPlans: '{{#str}}paid_plans_label, report_adeptus_insights{{/str}}',
        paidPlansAllFormats: '{{#str}}paid_plans_all_formats, report_adeptus_insights{{/str}}',
        exportUpgradeMessage: '{{#str}}export_upgrade_message, report_adeptus_insights{{/str}}',

        // Categories
        categories: '{{#str}}categories, report_adeptus_insights{{/str}}',
        createNewCategory: '{{#str}}create_new_category, report_adeptus_insights{{/str}}',
        customColor: '{{#str}}custom_color, report_adeptus_insights{{/str}}',
        yourCategories: '{{#str}}your_categories, report_adeptus_insights{{/str}}',
        defaultCategories: '{{#str}}default_categories, report_adeptus_insights{{/str}}',
        readOnly: '{{#str}}read_only, report_adeptus_insights{{/str}}',
        noCustomCategories: '{{#str}}no_custom_categories, report_adeptus_insights{{/str}}',
        createFirstCategory: '{{#str}}create_first_category, report_adeptus_insights{{/str}}',
        categoryCreated: '{{#str}}category_created, report_adeptus_insights{{/str}}',
        categoryUpdated: '{{#str}}category_updated, report_adeptus_insights{{/str}}',
        categoryDeleted: '{{#str}}category_deleted, report_adeptus_insights{{/str}}',
        editCategory: '{{#str}}edit_category, report_adeptus_insights{{/str}}',
        deleteCategory: '{{#str}}delete_category, report_adeptus_insights{{/str}}',
        deleteCategoryConfirm: '{{#str}}delete_category_confirm, report_adeptus_insights{{/str}}',
        deleteCategoryWarning: '{{#str}}delete_category_warning, report_adeptus_insights{{/str}}',
        yesDelete: '{{#str}}yes_delete, report_adeptus_insights{{/str}}',
        categoryName: '{{#str}}category_name, report_adeptus_insights{{/str}}',
        pleaseEnterCategoryName: '{{#str}}please_enter_category_name, report_adeptus_insights{{/str}}',
        name: '{{#str}}name, report_adeptus_insights{{/str}}',
        color: '{{#str}}color, report_adeptus_insights{{/str}}',
        custom: '{{#str}}custom, report_adeptus_insights{{/str}}',
        saveChanges: '{{#str}}save_changes, report_adeptus_insights{{/str}}',

        // Reports
        selectAReport: '{{#str}}select_a_report, report_adeptus_insights{{/str}}',
        noReportSelected: '{{#str}}no_report_selected, report_adeptus_insights{{/str}}',
        deleteReport: '{{#str}}delete_report, report_adeptus_insights{{/str}}',
        deleteReportConfirm: '{{#str}}delete_report_confirm, report_adeptus_insights{{/str}}',
        deleteReportWarning: '{{#str}}delete_report_warning, report_adeptus_insights{{/str}}',
        deletingReport: '{{#str}}deleting_report, report_adeptus_insights{{/str}}',
        deletingReportWait: '{{#str}}deleting_report_wait, report_adeptus_insights{{/str}}',
        deleteFailed: '{{#str}}delete_failed, report_adeptus_insights{{/str}}',
        reportDeletedSuccess: '{{#str}}report_deleted_success, report_adeptus_insights{{/str}}',
        reportCount: '{{#str}}report_count, report_adeptus_insights{{/str}}',
        reportsCount: '{{#str}}reports_count, report_adeptus_insights{{/str}}',
        youHaveReportsSaved: '{{#str}}you_have_reports_saved, report_adeptus_insights{{/str}}',

        // Loading/Errors
        sessionExpired: '{{#str}}session_expired, report_adeptus_insights{{/str}}',
        refreshPage: '{{#str}}refresh_page, report_adeptus_insights{{/str}}',
        refreshPageToContinue: '{{#str}}refresh_page_to_continue, report_adeptus_insights{{/str}}',
        failedToLoadReports: '{{#str}}failed_to_load_reports, report_adeptus_insights{{/str}}',
        tryAgainLater: '{{#str}}try_again_later, report_adeptus_insights{{/str}}',
        failedToExecuteReport: '{{#str}}failed_to_execute_report, report_adeptus_insights{{/str}}',
        failedToLoadReportDetails: '{{#str}}failed_to_load_report_details, report_adeptus_insights{{/str}}',
        failedToGenerateReport: '{{#str}}failed_to_generate_report, report_adeptus_insights{{/str}}',
        failedToExecuteWizardReport: '{{#str}}failed_to_execute_wizard_report, report_adeptus_insights{{/str}}',
        authenticationRequired: '{{#str}}authentication_required, report_adeptus_insights{{/str}}',
        authenticationRequiredMessage: '{{#str}}authentication_required_message, report_adeptus_insights{{/str}}',

        // DataTable
        searchReports: '{{#str}}search_reports, report_adeptus_insights{{/str}}',
        noReportsFound: '{{#str}}no_reports_found, report_adeptus_insights{{/str}}',
        showingReports: '{{#str}}showing_reports, report_adeptus_insights{{/str}}',
        showingFirstRows: '{{#str}}showing_first_rows, report_adeptus_insights{{/str}}',
        exportToSeeAll: '{{#str}}export_to_see_all, report_adeptus_insights{{/str}}',

        // Chart
        chartType: '{{#str}}chart_type, report_adeptus_insights{{/str}}',
        barChart: '{{#str}}bar_chart, report_adeptus_insights{{/str}}',
        lineChart: '{{#str}}line_chart, report_adeptus_insights{{/str}}',
        pieChart: '{{#str}}pie_chart, report_adeptus_insights{{/str}}',
        doughnutChart: '{{#str}}doughnut_chart, report_adeptus_insights{{/str}}',
        xAxisLabels: '{{#str}}x_axis_labels, report_adeptus_insights{{/str}}',
        yAxisValues: '{{#str}}y_axis_values, report_adeptus_insights{{/str}}',
        errorRenderingChart: '{{#str}}error_rendering_chart, report_adeptus_insights{{/str}}'
    };

    var GeneratedReports = {
        backendUrl: '{{backendUrl}}',
        cachedReports: [],
        cachedCategories: [],
        currentReport: null,
        currentReportData: null,
        reportsDataTable: null,
        retryCount: 0,
        maxRetries: 3,
        currentView: 'table',
        chartInstance: null,
        Chart: Chart,
        strings: STRINGS,
        isFreePlan: {{#is_free_plan}}true{{/is_free_plan}}{{^is_free_plan}}false{{/is_free_plan}},

        init: function() {
            this.loadReports();
            this.loadCategories();
            this.bindViewToggle();
            this.bindCategoryManagement();
        },

        /**
         * Show upgrade prompt for premium export formats
         */
        showExportUpgradePrompt: function(format) {
            var subscriptionUrl = M.cfg.wwwroot + '/report/adeptus_insights/subscription.php';
            var formatNames = {
                'csv': 'CSV',
                'excel': 'Excel',
                'json': 'JSON'
            };
            var formatName = formatNames[format] || format.toUpperCase();

            Swal.fire({
                title: STRINGS.premiumExportFormat,
                html: '<div style="text-align: center; padding: 20px;">' +
                    '<div style="font-size: 48px; color: #f39c12; margin-bottom: 15px;">' +
                    '<i class="fa fa-crown"></i></div>' +
                    '<h3 style="color: #2c3e50; margin-bottom: 15px;">' + formatName + ' ' + STRINGS.premiumFeature + '</h3>' +
                    '<p style="color: #7f8c8d; font-size: 16px; line-height: 1.6; margin-bottom: 25px;">' +
                    STRINGS.exportUpgradeMessage.replace('{format}', formatName) + '</p>' +
                    '<div style="background: #ecf0f1; padding: 15px; border-radius: 8px; margin-bottom: 20px;">' +
                    '<p style="margin: 0; font-size: 14px; color: #34495e;">' +
                    '<strong>' + STRINGS.freePlan + '</strong> ' + STRINGS.freePlanPdfOnly + '<br>' +
                    '<strong>' + STRINGS.paidPlans + '</strong> ' + STRINGS.paidPlansAllFormats + '</p></div></div>',
                showCancelButton: true,
                confirmButtonText: '<i class="fa fa-arrow-up"></i> ' + STRINGS.upgradeNow,
                cancelButtonText: '<i class="fa fa-times"></i> ' + STRINGS.cancel,
                confirmButtonColor: '#3498db',
                cancelButtonColor: '#95a5a6',
                width: 500
            }).then(function(result) {
                if (result.isConfirmed) {
                    window.open(subscriptionUrl, '_blank');
                }
            });
        },

        /**
         * Check export eligibility before exporting using external service
         */
        checkExportEligibility: async function(format) {
            return new Promise(function(resolve) {
                require(['core/ajax'], function(Ajax) {
                    Ajax.call([{
                        methodname: 'report_adeptus_insights_check_export_eligibility',
                        args: { format: format }
                    }])[0].done(function(result) {
                        var data = result.data ? result.data : result;
                        resolve(data);
                    }).fail(function(error) {
                        console.error('Error checking export eligibility:', error);
                        resolve({ success: false, eligible: false, message: 'Unable to verify export eligibility.' });
                    });
                });
            });
        },

        /**
         * Capture chart as image for PDF export
         * Uses native toDataURL with html2canvas fallback
         */
        captureChartImage: async function() {
            var self = this;

            // Wait for chart animation to complete
            await new Promise(function(resolve) { setTimeout(resolve, 300); });

            var chartCanvas = document.getElementById('report-chart');
            if (!chartCanvas) {
                console.warn('[GeneratedReports] Chart canvas not found');
                return null;
            }

            // Method 1: Native canvas toDataURL (fastest, most reliable)
            try {
                var dataUrl = chartCanvas.toDataURL('image/png', 0.8);
                if (dataUrl && dataUrl.length > 100 && dataUrl.length < 2000000) {
                    console.log('[GeneratedReports] Chart captured via toDataURL, size:', dataUrl.length);
                    return dataUrl;
                }
            } catch (e) {
                console.warn('[GeneratedReports] Native canvas capture failed:', e);
            }

            // Method 2: html2canvas fallback (handles CORS/tainted canvas)
            try {
                if (!window.html2canvas) {
                    await self.loadHtml2Canvas();
                }

                if (window.html2canvas) {
                    var capturedCanvas = await window.html2canvas(chartCanvas, {
                        backgroundColor: '#ffffff',
                        scale: 1.5,
                        useCORS: true,
                        allowTaint: true,
                        logging: false
                    });
                    var dataUrl = capturedCanvas.toDataURL('image/png', 0.8);
                    if (dataUrl && dataUrl.length > 100 && dataUrl.length < 2000000) {
                        console.log('[GeneratedReports] Chart captured via html2canvas, size:', dataUrl.length);
                        return dataUrl;
                    }
                }
            } catch (e) {
                console.warn('[GeneratedReports] html2canvas capture failed:', e);
            }

            return null;
        },

        /**
         * Load html2canvas library from CDN
         */
        loadHtml2Canvas: function() {
            return new Promise(function(resolve, reject) {
                if (window.html2canvas) {
                    resolve();
                    return;
                }
                var script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';
                script.onload = function() { resolve(); };
                script.onerror = function() { reject(new Error('Failed to load html2canvas')); };
                document.head.appendChild(script);
            });
        },

        /**
         * Show toast notification
         */
        showToast: function(message, type) {
            type = type || 'success';
            var toastContainer = document.getElementById('adeptus-toast-container');
            if (!toastContainer) {
                toastContainer = document.createElement('div');
                toastContainer.id = 'adeptus-toast-container';
                toastContainer.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 10000;';
                document.body.appendChild(toastContainer);
            }

            var iconMap = {
                'success': 'fa-check-circle',
                'error': 'fa-times-circle',
                'warning': 'fa-exclamation-triangle',
                'info': 'fa-info-circle'
            };
            var bgColorMap = {
                'success': '#28a745',
                'error': '#dc3545',
                'warning': '#ffc107',
                'info': '#17a2b8'
            };
            var textColorMap = {
                'success': 'white',
                'error': 'white',
                'warning': '#212529',
                'info': 'white'
            };

            var toast = document.createElement('div');
            toast.style.cssText = 'background: ' + bgColorMap[type] + '; color: ' + textColorMap[type] + '; padding: 12px 20px; border-radius: 8px; margin-bottom: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); display: flex; align-items: center; gap: 10px; animation: slideIn 0.3s ease; min-width: 280px;';
            toast.innerHTML = '<i class="fa ' + iconMap[type] + '"></i><span>' + message + '</span>';
            toastContainer.appendChild(toast);

            setTimeout(function() {
                toast.style.animation = 'slideOut 0.3s ease forwards';
                setTimeout(function() {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            }, 3000);
        },

        /**
         * Track export for usage monitoring
         */
        trackExport: function(format, reportName) {
            require(['core/ajax'], function(Ajax) {
                Ajax.call([{
                    methodname: 'report_adeptus_insights_track_export',
                    args: {
                        format: format,
                        report_name: reportName
                    }
                }])[0].done(function(result) {
                    var data = result.data ? result.data : result;
                    console.log('[GeneratedReports] Export tracked:', data);
                }).fail(function(error) {
                    console.error('[GeneratedReports] Error tracking export:', error);
                });
            });
        },

        bindViewToggle: function() {
            var self = this;
            $(document).on('click', '.adeptus-view-toggle-btn', function() {
                var view = $(this).data('view');
                self.switchView(view);
            });
            $(document).on('change', '#chart-type-select, #chart-x-axis, #chart-y-axis', function() {
                self.renderChart();
            });
        },

        bindCategoryManagement: function() {
            var self = this;
            $('#manage-categories-btn').on('click', function() {
                self.showCategoryManagementModal();
            });
        },

        loadCategories: function() {
            var self = this;

            // Use external service to load categories
            require(['core/ajax'], function(Ajax) {
                Ajax.call([{
                    methodname: 'report_adeptus_insights_manage_category',
                    args: {
                        action: 'list'
                    }
                }])[0].done(function(result) {
                    var data = result.data ? result.data : result;
                    if (data.success && data.categories) {
                        try {
                            self.cachedCategories = JSON.parse(data.categories);
                        } catch (e) {
                            self.cachedCategories = [];
                        }
                    }
                }).fail(function() {
                    self.cachedCategories = [];
                });
            });
        },

        showCategoryManagementModal: function() {
            var self = this;

            // Separate system and custom categories
            var systemCategories = self.cachedCategories.filter(function(c) { return c.is_system; });
            var customCategories = self.cachedCategories.filter(function(c) { return !c.is_system; });

            // Preset colors for quick selection
            var presetColors = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#06b6d4', '#84cc16'];

            // Build custom categories HTML
            var customCategoriesHtml = customCategories.length > 0 ?
                customCategories.map(function(cat) {
                    return '<div class="adeptus-cat-card" data-id="' + cat.id + '">' +
                        '<div class="adeptus-cat-card-color" style="background: ' + (cat.color || '#6c757d') + ';"></div>' +
                        '<div class="adeptus-cat-card-content">' +
                            '<div class="adeptus-cat-card-name">' + cat.name + '</div>' +
                            '<div class="adeptus-cat-card-meta">' + (cat.report_count || 0) + ' report' + (cat.report_count !== 1 ? 's' : '') + '</div>' +
                        '</div>' +
                        '<div class="adeptus-cat-card-actions">' +
                            '<button class="adeptus-cat-action-btn edit-cat-btn" data-id="' + cat.id + '" title="Edit">' +
                                '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>' +
                            '</button>' +
                            '<button class="adeptus-cat-action-btn adeptus-cat-action-btn-danger delete-cat-btn" data-id="' + cat.id + '" title="Delete">' +
                                '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>' +
                            '</button>' +
                        '</div>' +
                    '</div>';
                }).join('') :
                '<div class="adeptus-cat-empty-state">' +
                    '<div class="adeptus-cat-empty-icon">' +
                        '<svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path><line x1="12" y1="11" x2="12" y2="17"></line><line x1="9" y1="14" x2="15" y2="14"></line></svg>' +
                    '</div>' +
                    '<div class="adeptus-cat-empty-text">' + STRINGS.noCustomCategories + '</div>' +
                    '<div class="adeptus-cat-empty-hint">' + STRINGS.createFirstCategory + '</div>' +
                '</div>';

            // Build system categories HTML
            var systemCategoriesHtml = systemCategories.map(function(cat) {
                return '<div class="adeptus-cat-system-item">' +
                    '<span class="adeptus-cat-system-dot" style="background: ' + (cat.color || '#6c757d') + ';"></span>' +
                    '<span class="adeptus-cat-system-name">' + cat.name + '</span>' +
                    '<span class="adeptus-cat-system-count">' + (cat.report_count || 0) + '</span>' +
                '</div>';
            }).join('');

            // Build color swatches HTML
            var colorSwatchesHtml = presetColors.map(function(color) {
                return '<button type="button" class="adeptus-cat-color-swatch" data-color="' + color + '" style="background: ' + color + ';"></button>';
            }).join('');

            Swal.fire({
                title: STRINGS.categories,
                html: '<div class="adeptus-cat-modal">' +
                    // Add new category section
                    '<div class="adeptus-cat-add-section">' +
                        '<div class="adeptus-cat-add-header">' + STRINGS.createNewCategory + '</div>' +
                        '<div class="adeptus-cat-add-form">' +
                            '<div class="adeptus-cat-add-input-wrapper">' +
                                '<input type="text" id="new-category-name" class="adeptus-cat-add-input" placeholder="' + STRINGS.categoryName + '">' +
                                '<div class="adeptus-cat-add-color-wrapper">' +
                                    '<button type="button" class="adeptus-cat-add-color-btn" id="color-picker-toggle">' +
                                        '<span class="adeptus-cat-add-color-preview" id="selected-color-preview" style="background: #3b82f6;"></span>' +
                                        '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"></polyline></svg>' +
                                    '</button>' +
                                    '<div class="adeptus-cat-color-dropdown" id="color-dropdown">' +
                                        '<div class="adeptus-cat-color-swatches">' + colorSwatchesHtml + '</div>' +
                                        '<div class="adeptus-cat-color-custom">' +
                                            '<input type="color" id="new-category-color" value="#3b82f6">' +
                                            '<span>' + STRINGS.customColor + '</span>' +
                                        '</div>' +
                                    '</div>' +
                                '</div>' +
                            '</div>' +
                            '<button type="button" class="adeptus-cat-add-btn" id="add-category-btn">' +
                                '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>' +
                                'Add' +
                            '</button>' +
                        '</div>' +
                    '</div>' +
                    // Custom categories section
                    '<div class="adeptus-cat-section">' +
                        '<div class="adeptus-cat-section-header">' +
                            '<span class="adeptus-cat-section-title">' + STRINGS.yourCategories + '</span>' +
                            '<span class="adeptus-cat-section-count">' + customCategories.length + '</span>' +
                        '</div>' +
                        '<div class="adeptus-cat-cards-list">' + customCategoriesHtml + '</div>' +
                    '</div>' +
                    // System categories section
                    '<div class="adeptus-cat-section adeptus-cat-section-system">' +
                        '<div class="adeptus-cat-section-header">' +
                            '<span class="adeptus-cat-section-title">' + STRINGS.defaultCategories + '</span>' +
                            '<span class="adeptus-cat-section-badge">' + STRINGS.readOnly + '</span>' +
                        '</div>' +
                        '<div class="adeptus-cat-system-list">' + systemCategoriesHtml + '</div>' +
                    '</div>' +
                '</div>',
                showConfirmButton: false,
                showCloseButton: true,
                width: '480px',
                customClass: {
                    popup: 'adeptus-cat-modal-popup',
                    title: 'adeptus-cat-modal-title',
                    closeButton: 'adeptus-cat-modal-close',
                    htmlContainer: 'adeptus-cat-modal-container'
                },
                didOpen: function() {
                    var selectedColor = '#3b82f6';

                    // Color picker toggle
                    $('#color-picker-toggle').on('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        var dropdown = $('#color-dropdown');
                        dropdown.toggleClass('show');
                    });

                    // Prevent dropdown from closing when clicking inside it
                    $('#color-dropdown').on('click', function(e) {
                        e.stopPropagation();
                    });

                    // Close dropdown when clicking outside
                    $(document).on('click.colorDropdown', function(e) {
                        if (!$(e.target).closest('.adeptus-cat-add-color-wrapper').length) {
                            $('#color-dropdown').removeClass('show');
                        }
                    });

                    // Color swatch selection
                    $('.adeptus-cat-color-swatch').on('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        selectedColor = $(this).data('color');
                        $('#selected-color-preview').css('background', selectedColor);
                        $('#new-category-color').val(selectedColor);
                        $('#color-dropdown').removeClass('show');
                    });

                    // Custom color picker
                    $('#new-category-color').on('input change', function(e) {
                        e.stopPropagation();
                        selectedColor = $(this).val();
                        $('#selected-color-preview').css('background', selectedColor);
                    });

                    // Add category button handler
                    $('#add-category-btn').on('click', function() {
                        var name = $('#new-category-name').val().trim();
                        if (name) {
                            self.createCategory(name, selectedColor);
                        } else {
                            $('#new-category-name').addClass('error').focus();
                            setTimeout(function() { $('#new-category-name').removeClass('error'); }, 500);
                        }
                    });

                    // Enter key in input
                    $('#new-category-name').on('keypress', function(e) {
                        if (e.which === 13) {
                            $('#add-category-btn').click();
                        }
                    });

                    // Edit button handlers
                    $('.edit-cat-btn').on('click', function(e) {
                        e.stopPropagation();
                        var catId = $(this).data('id');
                        var cat = self.cachedCategories.find(function(c) { return c.id == catId; });
                        if (cat) {
                            $(document).off('click.colorDropdown');
                            self.showEditCategoryDialog(cat);
                        }
                    });

                    // Delete button handlers
                    $('.delete-cat-btn').on('click', function(e) {
                        e.stopPropagation();
                        var catId = $(this).data('id');
                        var cat = self.cachedCategories.find(function(c) { return c.id == catId; });
                        if (cat) {
                            $(document).off('click.colorDropdown');
                            self.confirmDeleteCategory(cat);
                        }
                    });
                },
                willClose: function() {
                    $(document).off('click.colorDropdown');
                }
            });
        },

        createCategory: function(name, color) {
            var self = this;

            // Use external service to create category
            require(['core/ajax'], function(Ajax) {
                Ajax.call([{
                    methodname: 'report_adeptus_insights_manage_category',
                    args: {
                        action: 'create',
                        name: name,
                        color: color
                    }
                }])[0].done(function(result) {
                    var data = result.data ? result.data : result;
                    if (data.success) {
                        try {
                            var newCategory = data.category ? JSON.parse(data.category) : null;
                            if (newCategory) {
                                self.cachedCategories.push(newCategory);
                            }
                        } catch (e) {
                            console.warn('[GeneratedReports] Failed to parse category:', e);
                        }
                        Swal.close();
                        Swal.fire({
                            icon: 'success',
                            title: STRINGS.categoryCreated,
                            timer: 1500,
                            showConfirmButton: false
                        }).then(function() {
                            self.showCategoryManagementModal();
                        });
                    } else {
                        Swal.showValidationMessage(data.message);
                    }
                }).fail(function(error) {
                    var msg = error.message || 'Failed to create category';
                    Swal.fire({ icon: 'error', title: STRINGS.error, text: msg });
                });
            });
        },

        showEditCategoryDialog: function(category) {
            var self = this;
            var presetColors = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#06b6d4', '#84cc16'];

            var colorSwatchesHtml = presetColors.map(function(color) {
                var isSelected = color.toLowerCase() === (category.color || '#6c757d').toLowerCase();
                return '<button type="button" class="adeptus-edit-color-swatch' + (isSelected ? ' selected' : '') + '" data-color="' + color + '" style="background: ' + color + ';"></button>';
            }).join('');

            Swal.fire({
                title: STRINGS.editCategory,
                html: '<div class="adeptus-cat-edit-modal">' +
                    '<div class="adeptus-cat-edit-preview" id="edit-preview">' +
                        '<div class="adeptus-cat-edit-preview-color" id="edit-preview-color" style="background: ' + (category.color || '#6c757d') + ';"></div>' +
                        '<span class="adeptus-cat-edit-preview-name" id="edit-preview-name">' + category.name + '</span>' +
                    '</div>' +
                    '<div class="adeptus-cat-edit-field">' +
                        '<label class="adeptus-cat-edit-label">' + STRINGS.name + '</label>' +
                        '<input type="text" id="edit-cat-name" class="adeptus-cat-edit-input" value="' + category.name.replace(/"/g, '&quot;') + '">' +
                    '</div>' +
                    '<div class="adeptus-cat-edit-field">' +
                        '<label class="adeptus-cat-edit-label">' + STRINGS.color + '</label>' +
                        '<div class="adeptus-cat-edit-colors">' +
                            '<div class="adeptus-cat-edit-swatches">' + colorSwatchesHtml + '</div>' +
                            '<div class="adeptus-cat-edit-custom">' +
                                '<input type="color" id="edit-adeptus-cat-color" value="' + (category.color || '#6c757d') + '">' +
                                '<span>' + STRINGS.custom + '</span>' +
                            '</div>' +
                        '</div>' +
                    '</div>' +
                '</div>',
                showCancelButton: true,
                confirmButtonText: STRINGS.saveChanges,
                cancelButtonText: STRINGS.cancel,
                customClass: {
                    popup: 'adeptus-cat-edit-popup',
                    confirmButton: 'adeptus-cat-edit-confirm-btn',
                    cancelButton: 'adeptus-cat-edit-cancel-btn'
                },
                didOpen: function() {
                    var selectedColor = category.color || '#6c757d';

                    // Live preview update
                    $('#edit-cat-name').on('input', function() {
                        $('#edit-preview-name').text($(this).val() || 'Category');
                    });

                    // Color swatch selection
                    $('.adeptus-edit-color-swatch').on('click', function() {
                        selectedColor = $(this).data('color');
                        $('.adeptus-edit-color-swatch').removeClass('selected');
                        $(this).addClass('selected');
                        $('#edit-preview-color').css('background', selectedColor);
                        $('#edit-adeptus-cat-color').val(selectedColor);
                    });

                    // Custom color picker
                    $('#edit-adeptus-cat-color').on('input', function() {
                        selectedColor = $(this).val();
                        $('.adeptus-edit-color-swatch').removeClass('selected');
                        $('#edit-preview-color').css('background', selectedColor);
                    });
                },
                preConfirm: function() {
                    var name = document.getElementById('edit-cat-name').value.trim();
                    var color = document.getElementById('edit-adeptus-cat-color').value;
                    if (!name) {
                        Swal.showValidationMessage(STRINGS.pleaseEnterCategoryName);
                        return false;
                    }
                    return { name: name, color: color };
                }
            }).then(function(result) {
                if (result.isConfirmed) {
                    self.updateCategory(category.id, result.value.name, result.value.color);
                }
            });
        },

        updateCategory: function(categoryId, name, color) {
            var self = this;

            // Use external service to update category
            require(['core/ajax'], function(Ajax) {
                Ajax.call([{
                    methodname: 'report_adeptus_insights_manage_category',
                    args: {
                        action: 'update',
                        category_id: categoryId,
                        name: name,
                        color: color
                    }
                }])[0].done(function(result) {
                    var data = result.data ? result.data : result;
                    if (data.success) {
                        // Update cached category
                        var idx = self.cachedCategories.findIndex(function(c) { return c.id == categoryId; });
                        if (idx !== -1) {
                            try {
                                var updatedCategory = data.category ? JSON.parse(data.category) : null;
                                if (updatedCategory) {
                                    self.cachedCategories[idx] = updatedCategory;
                                }
                            } catch (e) {
                                self.cachedCategories[idx].name = name;
                                self.cachedCategories[idx].color = color;
                            }
                        }
                        Swal.fire({
                            icon: 'success',
                            title: STRINGS.categoryUpdated,
                            timer: 1500,
                            showConfirmButton: false
                        }).then(function() {
                            self.showCategoryManagementModal();
                        });
                    } else {
                        Swal.fire({ icon: 'error', title: STRINGS.error, text: data.message });
                    }
                }).fail(function(error) {
                    var msg = error.message || '';
                    Swal.fire({ icon: 'error', title: STRINGS.error, text: msg });
                });
            });
        },

        confirmDeleteCategory: function(category) {
            var self = this;

            Swal.fire({
                title: STRINGS.deleteCategoryConfirm,
                html: '<p>' + STRINGS.deleteCategoryWarning.replace('{name}', '<strong>' + category.name + '</strong>') + '</p>',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#dc3545',
                confirmButtonText: STRINGS.yesDelete,
                cancelButtonText: STRINGS.cancel
            }).then(function(result) {
                if (result.isConfirmed) {
                    self.deleteCategory(category.id);
                }
            });
        },

        deleteCategory: function(categoryId) {
            var self = this;

            // Use external service to delete category
            require(['core/ajax'], function(Ajax) {
                Ajax.call([{
                    methodname: 'report_adeptus_insights_manage_category',
                    args: {
                        action: 'delete',
                        category_id: categoryId
                    }
                }])[0].done(function(result) {
                    var data = result.data ? result.data : result;
                    if (data.success) {
                        // Remove from cache
                        self.cachedCategories = self.cachedCategories.filter(function(c) { return c.id != categoryId; });
                        Swal.fire({
                            icon: 'success',
                            title: STRINGS.categoryDeleted,
                            timer: 2000,
                            showConfirmButton: false
                        }).then(function() {
                            self.showCategoryManagementModal();
                        });
                    } else {
                        Swal.fire({ icon: 'error', title: STRINGS.error, text: data.message });
                    }
                }).fail(function(error) {
                    var msg = error.message || 'Failed to delete category';
                    Swal.fire({ icon: 'error', title: STRINGS.error, text: msg });
                });
            });
        },

        /**
         * Show delete confirmation dialog for a report
         */
        confirmDeleteReport: function(report) {
            var self = this;

            if (!report) {
                report = self.currentReport;
            }

            if (!report || !report.slug) {
                Swal.fire({
                    icon: 'warning',
                    title: STRINGS.noReportSelected,
                    text: STRINGS.selectAReport
                });
                return;
            }

            var reportName = report.description || report.name || STRINGS.untitledReport;
            var source = (report.source || 'assistant').toLowerCase();
            var sourceLabel = source === 'wizard' ? STRINGS.wizard : STRINGS.ai;

            Swal.fire({
                title: STRINGS.deleteReportConfirm,
                html: '<p>' + STRINGS.deleteReportWarning.replace('{name}', '<strong>' + reportName + '</strong>') + '</p>',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#dc3545',
                confirmButtonText: '<i class="fa fa-trash"></i> ' + STRINGS.yesDelete,
                cancelButtonText: STRINGS.cancel
            }).then(function(result) {
                if (result.isConfirmed) {
                    self.deleteReport(report.slug, source, reportName);
                }
            });
        },

        /**
         * Delete a report
         * @param {string} slug - The report slug/identifier
         * @param {string} source - The report source ('assistant' or 'wizard')
         * @param {string} reportName - The report name for display
         */
        deleteReport: function(slug, source, reportName) {
            var self = this;

            // Show loading state
            Swal.fire({
                title: STRINGS.deletingReport,
                text: STRINGS.deletingReportWait,
                allowOutsideClick: false,
                allowEscapeKey: false,
                didOpen: function() {
                    Swal.showLoading();
                }
            });

            // Use external service for both wizard and AI reports
            require(['core/ajax'], function(Ajax) {
                Ajax.call([{
                    methodname: 'report_adeptus_insights_manage_generated_reports',
                    args: {
                        action: 'remove_single',
                        slug: slug,
                        source: source
                    }
                }])[0].done(function(result) {
                    var response = result.data ? result.data : result;

                    // Check if deletion was successful
                    if (!response.success) {
                        Swal.close();
                        Swal.fire({
                            icon: 'error',
                            title: STRINGS.deleteFailed,
                            text: response.message
                        });
                        return;
                    }

                    // Track the deletion to update quota
                    self.trackReportDeleted(reportName, source === 'assistant');

                    // Remove from cached reports
                    self.cachedReports = self.cachedReports.filter(function(r) {
                        return r.slug !== slug;
                    });

                    // Clear current report if it was the deleted one
                    if (self.currentReport && self.currentReport.slug === slug) {
                        self.currentReport = null;
                        self.currentReportData = null;
                    }

                    // Refresh the reports list
                    self.renderReportsList(self.cachedReports);
                    self.updateReportCount(self.cachedReports.length);

                    // Reset the report view
                    $('#report-content').addClass('d-none');
                    $('#report-placeholder').removeClass('d-none');
                    $('#report-category-selector').addClass('d-none');
                    $('.adeptus-report-view-title').text(STRINGS.selectAReport);

                    Swal.close();

                    // Show success toast
                    self.showToast(STRINGS.reportDeletedSuccess, 'success');

                }).fail(function(error) {
                    Swal.close();
                    var errorMsg = error.message || '';
                    Swal.fire({
                        icon: 'error',
                        title: STRINGS.deleteFailed,
                        text: errorMsg
                    });
                });
            });
        },

        /**
         * Track report deletion to update quota
         * @param {string} reportName - The name of the deleted report
         * @param {boolean} isAiGenerated - Whether the report was AI-generated
         */
        trackReportDeleted: function(reportName, isAiGenerated) {
            require(['core/ajax'], function(Ajax) {
                Ajax.call([{
                    methodname: 'report_adeptus_insights_track_report_deleted',
                    args: {
                        report_name: reportName,
                        is_ai_generated: isAiGenerated ? true : false
                    }
                }])[0].done(function(result) {
                    var data = result.data ? result.data : result;
                    console.log('[GeneratedReports] Report deletion tracked:', data);
                }).fail(function(error) {
                    console.warn('[GeneratedReports] Failed to track report deletion:', error);
                });
            });
        },

        /**
         * Show the category selector for the current report
         */
        showReportCategorySelector: function(report) {
            var self = this;
            var categoryInfo = report.category_info || { name: report.category || STRINGS.general, color: '#6c757d' };

            // Store current report for category updates
            this.currentCategoryReport = report;

            // Update current category display
            $('#category-dot').css('background', categoryInfo.color || '#6c757d');
            $('#category-name').text(categoryInfo.name || STRINGS.general);
            $('#report-category-selector').removeClass('d-none');

            // Helper function to build and bind dropdown
            var buildDropdown = function() {
                // Build dropdown menu
                var menuHtml = self.cachedCategories.map(function(cat) {
                    var isSelected = (categoryInfo.id && cat.id === categoryInfo.id) ||
                                     (!categoryInfo.id && cat.name.toLowerCase() === (categoryInfo.name || 'general').toLowerCase());
                    return '<button type="button" class="adeptus-category-menu-item' + (isSelected ? ' selected' : '') + '" data-id="' + cat.id + '" data-name="' + cat.name + '" data-color="' + (cat.color || '#6c757d') + '">' +
                        '<span class="adeptus-category-menu-dot" style="background: ' + (cat.color || '#6c757d') + ';"></span>' +
                        '<span class="adeptus-category-menu-name">' + cat.name + '</span>' +
                        (isSelected ? '<svg class="adeptus-category-menu-check" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"></polyline></svg>' : '') +
                    '</button>';
                }).join('');

                $('#category-dropdown-menu').html(menuHtml);

                // Bind click events for menu items
                $('.adeptus-category-menu-item').off('click').on('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    var catId = $(this).data('id');
                    var catName = $(this).data('name');
                    var catColor = $(this).data('color');
                    $('#category-dropdown-menu').removeClass('show');
                    self.updateReportCategory(report.slug, catId, catName, catColor, report);
                });
            };

            // If categories not loaded yet, load them first
            if (!this.cachedCategories || this.cachedCategories.length === 0) {
                require(['core/ajax'], function(Ajax) {
                    Ajax.call([{
                        methodname: 'report_adeptus_insights_manage_category',
                        args: {
                            action: 'list'
                        }
                    }])[0].done(function(result) {
                        var data = result.data ? result.data : result;
                        if (data.success && data.categories) {
                            try {
                                self.cachedCategories = JSON.parse(data.categories);
                            } catch (e) {
                                self.cachedCategories = [];
                            }
                        }
                        buildDropdown();
                    }).fail(function() {
                        self.cachedCategories = [];
                        buildDropdown();
                    });
                });
            } else {
                buildDropdown();
            }

            // Bind events for dropdown toggle (remove old ones first)
            $('#category-current-btn').off('click').on('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                $('#category-dropdown-menu').toggleClass('show');
            });

            $('#category-dropdown-menu').off('click').on('click', function(e) {
                e.stopPropagation();
            });

            // Close on outside click
            $(document).off('click.categoryDropdown').on('click.categoryDropdown', function(e) {
                if (!$(e.target).closest('.category-dropdown-wrapper').length) {
                    $('#category-dropdown-menu').removeClass('show');
                }
            });
        },

        /**
         * Update a report's category
         */
        updateReportCategory: function(slug, categoryId, categoryName, categoryColor, report) {
            var self = this;
            var source = report ? (report.source || 'assistant') : 'assistant';

            // Optimistic update
            $('#category-dot').css('background', categoryColor);
            $('#category-name').text(categoryName);

            // Use external service to update report category
            require(['core/ajax'], function(Ajax) {
                Ajax.call([{
                    methodname: 'report_adeptus_insights_update_report_category',
                    args: {
                        slug: slug,
                        category_id: categoryId,
                        source: source
                    }
                }])[0].done(function(result) {
                    var response = result.data ? result.data : result;
                    if (response.success) {
                        // Update cached report
                        var cacheIndex = self.cachedReports.findIndex(function(r) { return r.slug === slug; });
                        if (cacheIndex !== -1) {
                            self.cachedReports[cacheIndex].category = categoryName;
                            self.cachedReports[cacheIndex].category_id = categoryId;
                            self.cachedReports[cacheIndex].category_info = {
                                id: categoryId,
                                name: categoryName,
                                color: categoryColor
                            };
                        }

                        // Show subtle success feedback
                        $('#category-current-btn').addClass('success-flash');
                        setTimeout(function() {
                            $('#category-current-btn').removeClass('success-flash');
                        }, 600);
                    } else {
                        // Revert on failure.
                        Swal.fire({
                            icon: 'error',
                            title: STRINGS.error,
                            text: response.message
                        });
                    }
                }).fail(function(error) {
                    var msg = error.message || '';
                    Swal.fire({ icon: 'error', title: STRINGS.error, text: msg });
                });
            });
        },

        detectNumericColumns: function(data, headers) {
            if (!data || data.length === 0) return [];

            return headers.filter(function(header) {
                // Check if at least 50% of values are numeric
                var numericCount = 0;
                var sampleSize = Math.min(data.length, 20);

                for (var i = 0; i < sampleSize; i++) {
                    var val = data[i][header];
                    if (val !== null && val !== undefined && val !== '') {
                        var num = parseFloat(val);
                        if (!isNaN(num) && isFinite(num)) {
                            numericCount++;
                        }
                    }
                }

                return numericCount >= sampleSize * 0.5;
            });
        },

        switchView: function(view) {
            this.currentView = view;
            $('.adeptus-view-toggle-btn').removeClass('active');
            $('.adeptus-view-toggle-btn[data-view="' + view + '"]').addClass('active');

            if (view === 'table') {
                $('#report-table-view').removeClass('d-none');
                $('#report-chart-view').addClass('d-none');
            } else {
                $('#report-table-view').addClass('d-none');
                $('#report-chart-view').removeClass('d-none');
                this.renderChart();
            }
        },

        getAuthToken: function() {
            var authData = window.adeptusAuthData;
            if (authData && authData.api_key) {
                return authData.api_key;
            }
            return null;
        },

        formatDate: function(dateStr) {
            if (!dateStr) return 'N/A';
            var date = new Date(dateStr);
            var now = new Date();
            var diff = now - date;
            var days = Math.floor(diff / (1000 * 60 * 60 * 24));

            if (days === 0) {
                return 'Today, ' + date.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});
            } else if (days === 1) {
                return 'Yesterday, ' + date.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});
            } else if (days < 7) {
                var weekdays = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
                return weekdays[date.getDay()] + ', ' + date.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});
            } else {
                return date.toLocaleDateString() + ', ' + date.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});
            }
        },

        loadReports: function() {
            var self = this;
            var token = this.getAuthToken();

            if (!token) {
                if (self.retryCount < self.maxRetries) {
                    self.retryCount++;
                    setTimeout(function() {
                        self.loadReports();
                    }, 500);
                    return;
                } else {
                    $('#reports-loader').addClass('d-none');
                    $('#no-reports-message').removeClass('d-none').html(
                        '<i class="fa fa-exclamation-triangle fa-3x text-warning mb-3"></i>' +
                        '<h5 class="text-muted">Authentication Required</h5>' +
                        '<p class="text-muted">Please ensure you are logged in to view reports.</p>'
                    );
                    return;
                }
            }

            // Fetch from both AI Assistant reports (external API) and Wizard reports (local Moodle)
            var assistantPromise = $.ajax({
                url: this.backendUrl + '/ai-reports',
                method: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + token,
                    'Content-Type': 'application/json'
                },
                timeout: 15000
            }).catch(function() {
                return { reports: [], data: [] };
            });

            // Fetch wizard reports using Moodle External Service
            var wizardPromise = new Promise(function(resolve) {
                require(['core/ajax'], function(Ajax) {
                    Ajax.call([{
                        methodname: 'report_adeptus_insights_get_wizard_reports',
                        args: {}
                    }])[0].done(function(result) {
                        // Extract from Moodle's wrapper: {error: false, data: {...}}
                        var response = (result && result.data) ? result.data : (result || {});
                        resolve({ success: true, reports: response.reports || [] });
                    }).fail(function() {
                        resolve({ success: true, reports: [] });
                    });
                });
            });

            // Wait for both requests
            $.when(assistantPromise, wizardPromise).then(
                function(assistantRes, wizardRes) {
                    // Extract reports from both responses
                    var aRes = assistantRes[0] || assistantRes || {};
                    var wRes = wizardRes[0] || wizardRes || {};

                    var assistantReports = aRes.reports || aRes.data || [];
                    var wizardReports = wRes.reports || [];

                    // Tag each report with its source
                    assistantReports = (Array.isArray(assistantReports) ? assistantReports : []).map(function(r) {
                        r.source = r.source || 'assistant';
                        return r;
                    });
                    wizardReports = (Array.isArray(wizardReports) ? wizardReports : []).map(function(r) {
                        r.source = 'wizard';
                        return r;
                    });

                    // Combine all reports
                    self.cachedReports = assistantReports.concat(wizardReports);

                    // Sort by date (newest first)
                    self.cachedReports.sort(function(a, b) {
                        return new Date(b.created_at) - new Date(a.created_at);
                    });

                    self.renderReportsList(self.cachedReports);
                    self.updateReportCount(self.cachedReports.length);
                },
                function(xhr, status, error) {
                    $('#reports-loader').addClass('d-none');
                    if (xhr.status === 401) {
                        $('#no-reports-message').removeClass('d-none').html(
                            '<i class="fa fa-lock fa-3x text-warning mb-3"></i>' +
                            '<h5 class="text-muted">' + STRINGS.sessionExpired + '</h5>' +
                            '<p class="text-muted">' + STRINGS.refreshPageToContinue + '</p>' +
                            '<button class="btn btn-primary btn-sm" onclick="location.reload()"><i class="fa fa-refresh"></i> ' + STRINGS.refreshPage + '</button>'
                        );
                    } else {
                        $('#no-reports-message').removeClass('d-none').html(
                            '<i class="fa fa-exclamation-circle fa-3x text-danger mb-3"></i>' +
                            '<h5 class="text-muted">' + STRINGS.failedToLoadReports + '</h5>' +
                            '<p class="text-muted">' + STRINGS.tryAgainLater + '</p>' +
                            '<button class="btn btn-outline-primary btn-sm" onclick="location.reload()"><i class="fa fa-refresh"></i> ' + STRINGS.retry + '</button>'
                        );
                    }
                }
            );
        },

        updateReportCount: function(count) {
            var countText = count === 1 ? STRINGS.reportCount : count + ' ' + STRINGS.reportsCount;
            $('.adeptus-page-header-subtitle').text(STRINGS.youHaveReportsSaved.replace('{count}', countText.toLowerCase()));
        },

        renderReportsList: function(reports) {
            var self = this;

            // Destroy existing DataTable BEFORE modifying the DOM
            if (this.reportsDataTable) {
                this.reportsDataTable.destroy();
                this.reportsDataTable = null;
            }

            var tbody = $('#reports-tbody');
            tbody.empty();

            $('#reports-loader').addClass('d-none');

            if (!reports || reports.length === 0) {
                $('#no-reports-message').removeClass('d-none');
                $('#reports-table-wrapper').addClass('d-none');
                return;
            }

            $('#no-reports-message').addClass('d-none');
            $('#reports-table-wrapper').removeClass('d-none');

            reports.forEach(function(report, index) {
                var date = self.formatDate(report.created_at);
                var rowCount = report.row_count || report.data_count || '';
                var rowCountBadge = rowCount ? '<span class="badge bg-info ms-1" title="' + rowCount + ' rows"><i class="fa fa-table"></i> ' + rowCount + '</span>' : '';
                var categoryBadge = report.category ? '<span class="badge bg-secondary ms-1">' + report.category + '</span>' : '';

                // Determine source badge
                var source = (report.source || 'assistant').toLowerCase();
                var sourceBadge = '';
                if (source === 'wizard') {
                    sourceBadge = '<span class="badge adeptus-badge-wizard"><i class="fa fa-magic"></i> ' + STRINGS.wizard + '</span>';
                } else {
                    sourceBadge = '<span class="badge adeptus-badge-ai"><i class="fa fa-robot"></i> ' + STRINGS.ai + '</span>';
                }

                var row = $('<tr class="adeptus-report-row" data-report-slug="' + report.slug + '" data-report-source="' + source + '"></tr>');
                row.html(
                    '<td>' +
                        '<div class="adeptus-report-name-cell">' +
                            '<span class="adeptus-report-name">' + (report.description || report.name || STRINGS.untitledReport) + '</span>' +
                            '<div class="adeptus-report-badges mt-1">' + categoryBadge + rowCountBadge + '</div>' +
                        '</div>' +
                    '</td>' +
                    '<td><small class="text-muted">' + date + '</small></td>' +
                    '<td>' + sourceBadge + '</td>'
                );

                tbody.append(row);
            });

            // Use event delegation for click handlers (survives DataTable re-rendering)
            $('#reports-table-wrapper').off('click', '.adeptus-report-row').on('click', '.adeptus-report-row', function() {
                var $row = $(this);
                var slug = $row.data('report-slug');

                $('.adeptus-report-row').removeClass('table-primary');
                $row.addClass('table-primary');
                self.loadReportDetails(slug);
            });

            // Initialize DataTable
            setTimeout(function() {
                try {
                    self.reportsDataTable = new simpleDatatables.DataTable("#reports-table", {
                        searchable: true,
                        fixedHeight: false,
                        perPage: 15,
                        loading: false,
                        labels: {
                            placeholder: STRINGS.searchReports,
                            noRows: STRINGS.noReportsFound,
                            info: STRINGS.showingReports
                        }
                    });

                    // Remove loading class
                    setTimeout(function() {
                        $('.datatable-wrapper').removeClass('datatable-loading');
                    }, 100);

                    // Auto-select first report after DataTable is ready
                    setTimeout(function() {
                        var firstRow = $('.adeptus-report-row').first();
                        if (firstRow.length && !self.currentReport) {
                            firstRow.addClass('table-primary');
                            var firstSlug = firstRow.data('report-slug');
                            if (firstSlug) {
                                self.loadReportDetails(firstSlug);
                            }
                        }
                    }, 150);
                } catch (e) {
                    console.warn('DataTable initialization failed:', e);
                }
            }, 100);
        },

        loadReportDetails: function(slug) {
            var self = this;
            var token = this.getAuthToken();

            $('#report-placeholder').addClass('d-none');
            $('#report-content').addClass('d-none');
            $('#report-loading').removeClass('d-none');

            // Find cached report for immediate title update and source detection
            var cachedReport = this.cachedReports.find(function(r) { return r.slug === slug; });
            var source = cachedReport ? (cachedReport.source || 'assistant') : 'assistant';

            if (cachedReport) {
                $('.adeptus-report-view-title').text(cachedReport.description || cachedReport.name || STRINGS.reportDetails);
                // Show category selector for all report types (both assistant and wizard)
                self.showReportCategorySelector(cachedReport);
            }

            // Handle wizard reports differently - they need to be executed
            if (source === 'wizard' && cachedReport) {
                self.loadWizardReport(cachedReport);
                return;
            }

            // For assistant reports, fetch from external API
            $.ajax({
                url: this.backendUrl + '/ai-reports/' + slug,
                method: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + token,
                    'Content-Type': 'application/json'
                },
                timeout: 30000,
                success: function(response) {
                    // API returns: response.report (metadata) and response.data (rows)
                    var report = response.report || response;
                    var data = response.data || [];

                    // Preserve source
                    report.source = source;

                    // Check if local execution is required (SaaS model)
                    // Get SQL from response - check multiple possible locations
                    var sqlQuery = response.sql || (report && report.sql_query) || (report && report.sql);
                    var needsLocalExecution = response.execution_required || (!data || data.length === 0) && sqlQuery;

                    if (needsLocalExecution && sqlQuery) {
                        // Execute SQL locally
                        self.executeReportLocally(sqlQuery, report.params || {})
                            .then(function(executionResult) {
                                var localData = executionResult.data || [];

                                self.currentReport = report;
                                self.currentReportData = localData;

                                // Update cached report with full data
                                var cacheIndex = self.cachedReports.findIndex(function(r) { return r.slug === slug; });
                                if (cacheIndex !== -1) {
                                    self.cachedReports[cacheIndex] = Object.assign({}, report, { data: localData, source: source });
                                }

                                self.renderReportContent(report, localData);
                            })
                            .catch(function(error) {
                                $('#report-loading').addClass('d-none');
                                $('#report-content').html(
                                    '<div class="alert alert-danger">' +
                                        '<i class="fa fa-exclamation-circle"></i> ' + STRINGS.failedToExecuteReport + ': ' + error.message +
                                        '<button class="btn btn-sm btn-outline-danger ms-3" onclick="GeneratedReports.loadReportDetails(\'' + slug + '\')"><i class="fa fa-refresh"></i> ' + STRINGS.retry + '</button>' +
                                    '</div>'
                                ).removeClass('d-none');
                            });
                        return;
                    }

                    self.currentReport = report;
                    self.currentReportData = data;

                    // Update cached report with full data
                    var cacheIndex = self.cachedReports.findIndex(function(r) { return r.slug === slug; });
                    if (cacheIndex !== -1) {
                        self.cachedReports[cacheIndex] = Object.assign({}, report, { data: data, source: source });
                    }

                    self.renderReportContent(report, data);
                },
                error: function(xhr, status, error) {
                    $('#report-loading').addClass('d-none');
                    $('#report-content').html(
                        '<div class="alert alert-danger">' +
                            '<i class="fa fa-exclamation-circle"></i> ' + STRINGS.failedToLoadReportDetails +
                            '<button class="btn btn-sm btn-outline-danger ms-3" onclick="GeneratedReports.loadReportDetails(\'' + slug + '\')"><i class="fa fa-refresh"></i> ' + STRINGS.retry + '</button>' +
                        '</div>'
                    ).removeClass('d-none');
                }
            });
        },

        // Load and execute a wizard report
        loadWizardReport: function(cachedReport) {
            var self = this;

            // Build parameters object for the external service
            // Include reexecution=true to skip eligibility check (this is a saved report being viewed)
            var parameters = cachedReport.parameters || {};

            // Call external service
            // Use report_template_id (the actual template name) as reportid, not the user's custom name
            var reportTemplateId = cachedReport.report_template_id || cachedReport.name;
            $.ajax({
                url: M.cfg.wwwroot + '/lib/ajax/service.php?sesskey=' + M.cfg.sesskey + '&info=report_adeptus_insights_generate_report',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify([{
                    index: 0,
                    methodname: 'report_adeptus_insights_generate_report',
                    args: {
                        reportid: reportTemplateId,
                        parameters: JSON.stringify(parameters),
                        reexecution: true
                    }
                }]),
                timeout: 60000, // Longer timeout for report generation
                success: function(results) {
                    // External services return an array of results
                    // Moodle wraps the response: {error: false, data: {actual response}}
                    var result = Array.isArray(results) && results.length > 0 ? results[0] : null;

                    if (result && result.error) {
                        $('#report-loading').addClass('d-none');
                        $('#report-content').html(
                            '<div class="alert alert-danger">' +
                                '<i class="fa fa-exclamation-circle"></i> ' + (result.exception?.message || result.error) +
                                '<button class="btn btn-sm btn-outline-danger ms-3" onclick="GeneratedReports.loadReportDetails(\'' + cachedReport.slug + '\')"><i class="fa fa-refresh"></i> ' + STRINGS.retry + '</button>' +
                            '</div>'
                        ).removeClass('d-none');
                        return;
                    }

                    // Extract the actual response from Moodle's wrapper
                    var response = (result && result.data) ? result.data : (result || {});
                    if (response.success) {
                        // Transform external service format (cells with key/value) to flat objects
                        var rawResults = response.results || response.data || [];
                        var data = rawResults.map(function(row) {
                            if (row.cells && Array.isArray(row.cells)) {
                                var flatRow = {};
                                row.cells.forEach(function(cell) {
                                    flatRow[cell.key] = cell.value;
                                });
                                return flatRow;
                            }
                            return row; // Already flat format
                        });
                        var report = {
                            name: cachedReport.name,
                            description: cachedReport.description || cachedReport.name,
                            category: response.report?.category || cachedReport.category || 'Wizard Report',
                            created_at: cachedReport.created_at,
                            source: 'wizard',
                            slug: cachedReport.slug
                        };

                        self.currentReport = report;
                        self.currentReportData = data;

                        // Update cached report with full data
                        var cacheIndex = self.cachedReports.findIndex(function(r) { return r.slug === cachedReport.slug; });
                        if (cacheIndex !== -1) {
                            self.cachedReports[cacheIndex].data = data;
                            self.cachedReports[cacheIndex].row_count = data.length;
                        }

                        self.renderReportContent(report, data);
                    } else {
                        $('#report-loading').addClass('d-none');
                        $('#report-content').html(
                            '<div class="alert alert-warning">' +
                                '<i class="fa fa-exclamation-triangle"></i> ' + (response.message || STRINGS.failedToGenerateReport) +
                                '<button class="btn btn-sm btn-outline-warning ms-3" onclick="GeneratedReports.loadReportDetails(\'' + cachedReport.slug + '\')"><i class="fa fa-refresh"></i> ' + STRINGS.retry + '</button>' +
                            '</div>'
                        ).removeClass('d-none');
                    }
                },
                error: function(xhr, status, error) {
                    $('#report-loading').addClass('d-none');
                    $('#report-content').html(
                        '<div class="alert alert-danger">' +
                            '<i class="fa fa-exclamation-circle"></i> ' + STRINGS.failedToExecuteWizardReport +
                            '<button class="btn btn-sm btn-outline-danger ms-3" onclick="GeneratedReports.loadReportDetails(\'' + cachedReport.slug + '\')"><i class="fa fa-refresh"></i> ' + STRINGS.retry + '</button>' +
                        '</div>'
                    ).removeClass('d-none');
                }
            });
        },

        /**
         * Execute SQL locally for SaaS model
         * @param {string} sql - The SQL query to execute
         * @param {object} params - Query parameters
         * @returns {Promise} - Resolves with execution result
         */
        executeReportLocally: function(sql, params) {
            var self = this;
            params = params || {};

            return new Promise(function(resolve, reject) {
                $.ajax({
                    url: M.cfg.wwwroot + '/report/adeptus_insights/ajax/execute_ai_report.php',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        sql: sql,
                        params: params,
                        sesskey: M.cfg.sesskey
                    }),
                    timeout: 60000,
                    success: function(response) {
                        if (response.success) {
                            resolve({
                                data: response.data || [],
                                headers: response.headers || [],
                                row_count: response.row_count || 0,
                                error: null
                            });
                        } else {
                            resolve({
                                data: [],
                                headers: [],
                                row_count: 0,
                                error: response.message || 'Query execution failed'
                            });
                        }
                    },
                    error: function(xhr, status, error) {
                        var errorMessage = 'Failed to execute report';
                        try {
                            var response = JSON.parse(xhr.responseText);
                            errorMessage = response.message || errorMessage;
                        } catch (e) {
                            errorMessage = error || errorMessage;
                        }
                        reject(new Error(errorMessage));
                    }
                });
            });
        },

        renderReportContent: function(report, data) {
            var self = this;
            $('#report-loading').addClass('d-none');

            var contentHtml = '';
            var rowCount = data ? data.length : 0;

            // Report header with enhanced styling
            contentHtml += '<div class="adeptus-report-detail-header mb-4">';
            contentHtml += '<h4 class="mb-2">' + (report.description || report.name || STRINGS.report) + '</h4>';
            contentHtml += '<div class="adeptus-report-meta d-flex flex-wrap align-items-center gap-2">';

            // Source badge
            var reportSource = (report.source || 'assistant').toLowerCase();
            if (reportSource === 'wizard') {
                contentHtml += '<span class="badge adeptus-badge-wizard"><i class="fa fa-magic"></i> ' + STRINGS.wizard + '</span>';
            } else {
                contentHtml += '<span class="badge adeptus-badge-ai"><i class="fa fa-robot"></i> ' + STRINGS.ai + '</span>';
            }

            // Row count badge
            contentHtml += '<span class="badge adeptus-badge-rowcount"><i class="fa fa-table"></i> ' + rowCount + ' ' + STRINGS.rows + '</span>';
            contentHtml += '</div>';
            contentHtml += '</div>';

            // Action bar with view toggle and export buttons
            contentHtml += '<div class="adeptus-action-bar d-flex justify-content-between align-items-center mb-3">';

            // View toggle buttons
            contentHtml += '<div class="adeptus-view-toggle btn-group" role="group">';
            contentHtml += '<button type="button" class="btn btn-sm adeptus-view-toggle-btn active" data-view="table"><i class="fa fa-table"></i> ' + STRINGS.table + '</button>';
            contentHtml += '<button type="button" class="btn btn-sm adeptus-view-toggle-btn" data-view="chart"><i class="fa fa-bar-chart"></i> ' + STRINGS.chart + '</button>';
            contentHtml += '</div>';

            // Export buttons - PDF available for all, CSV/JSON premium on free plan
            var premiumClass = self.isFreePlan ? ' adeptus-export-premium' : '';
            contentHtml += '<div class="adeptus-export-buttons d-flex gap-2">';
            contentHtml += '<button class="btn btn-outline-danger btn-sm adeptus-export-pdf-btn"><i class="fa fa-file-pdf-o"></i> ' + STRINGS.exportPdf + '</button>';
            contentHtml += '<button class="btn btn-outline-primary btn-sm adeptus-export-csv-btn' + premiumClass + '"><i class="fa fa-file-excel-o"></i> ' + STRINGS.exportCsv + (self.isFreePlan ? ' <i class="fa fa-crown text-warning" style="font-size: 10px;"></i>' : '') + '</button>';
            contentHtml += '<button class="btn btn-outline-secondary btn-sm adeptus-export-json-btn' + premiumClass + '"><i class="fa fa-code"></i> ' + STRINGS.exportJson + (self.isFreePlan ? ' <i class="fa fa-crown text-warning" style="font-size: 10px;"></i>' : '') + '</button>';
            contentHtml += '</div>';
            contentHtml += '</div>';

            // Data views container
            if (data && data.length > 0) {
                var headers = Object.keys(data[0]);
                var displayLimit = 100;

                // Table View
                contentHtml += '<div id="report-table-view" class="adeptus-report-view">';
                contentHtml += '<div class="adeptus-report-data-wrapper">';
                contentHtml += '<div class="table-responsive report-table-container">';
                contentHtml += '<table class="table table-striped table-hover table-sm report-data-table">';
                contentHtml += '<thead class="table-light sticky-header"><tr>';
                headers.forEach(function(header) {
                    var formattedHeader = header.replace(/_/g, ' ').replace(/\b\w/g, function(l) { return l.toUpperCase(); });
                    contentHtml += '<th>' + formattedHeader + '</th>';
                });
                contentHtml += '</tr></thead>';
                contentHtml += '<tbody>';

                var displayData = data.slice(0, displayLimit);
                displayData.forEach(function(row) {
                    contentHtml += '<tr>';
                    headers.forEach(function(header) {
                        var value = row[header];
                        if (value === null || value === undefined) value = '';
                        var displayValue = String(value);
                        if (displayValue.length > 100) {
                            displayValue = displayValue.substring(0, 100) + '...';
                        }
                        contentHtml += '<td title="' + String(value).replace(/"/g, '&quot;') + '">' + displayValue + '</td>';
                    });
                    contentHtml += '</tr>';
                });

                contentHtml += '</tbody></table>';
                contentHtml += '</div>';
                contentHtml += '</div>';

                if (data.length > displayLimit) {
                    contentHtml += '<div class="alert alert-info mt-3 d-flex align-items-center justify-content-between">';
                    contentHtml += '<span><i class="fa fa-info-circle"></i> ' + STRINGS.showingFirstRows.replace('{first}', displayLimit).replace('{total}', data.length) + '</span>';
                    contentHtml += '<span class="text-primary">' + STRINGS.exportToSeeAll + '</span>';
                    contentHtml += '</div>';
                }
                contentHtml += '</div>'; // Close table view

                // Chart View
                contentHtml += '<div id="report-chart-view" class="adeptus-report-view d-none">';
                contentHtml += '<div class="adeptus-chart-controls-wrapper mb-3">';
                contentHtml += '<div class="adeptus-chart-controls d-flex flex-wrap align-items-center gap-3">';

                // Chart type selector
                contentHtml += '<div class="adeptus-control-group">';
                contentHtml += '<label for="chart-type-select" class="form-label">' + STRINGS.chartType + '</label>';
                contentHtml += '<select id="chart-type-select" class="form-select form-select-sm">';
                contentHtml += '<option value="bar">' + STRINGS.barChart + '</option>';
                contentHtml += '<option value="line">' + STRINGS.lineChart + '</option>';
                contentHtml += '<option value="pie">' + STRINGS.pieChart + '</option>';
                contentHtml += '<option value="doughnut">' + STRINGS.doughnutChart + '</option>';
                contentHtml += '</select>';
                contentHtml += '</div>';

                // X-Axis selector
                contentHtml += '<div class="adeptus-control-group">';
                contentHtml += '<label for="chart-x-axis" class="form-label">' + STRINGS.xAxisLabels + '</label>';
                contentHtml += '<select id="chart-x-axis" class="form-select form-select-sm">';
                headers.forEach(function(header, idx) {
                    var formattedHeader = header.replace(/_/g, ' ').replace(/\b\w/g, function(l) { return l.toUpperCase(); });
                    var selected = idx === 0 ? ' selected' : '';
                    contentHtml += '<option value="' + header + '"' + selected + '>' + formattedHeader + '</option>';
                });
                contentHtml += '</select>';
                contentHtml += '</div>';

                // Y-Axis selector (only numeric columns)
                var numericCols = self.detectNumericColumns(data, headers);
                contentHtml += '<div class="adeptus-control-group">';
                contentHtml += '<label for="chart-y-axis" class="form-label">' + STRINGS.yAxisValues + '</label>';
                contentHtml += '<select id="chart-y-axis" class="form-select form-select-sm">';
                if (numericCols.length > 0) {
                    numericCols.forEach(function(col, idx) {
                        var formattedHeader = col.replace(/_/g, ' ').replace(/\b\w/g, function(l) { return l.toUpperCase(); });
                        var selected = idx === numericCols.length - 1 ? ' selected' : '';
                        contentHtml += '<option value="' + col + '"' + selected + '>' + formattedHeader + '</option>';
                    });
                } else {
                    // Fallback to all columns if no numeric found
                    headers.forEach(function(header, idx) {
                        var formattedHeader = header.replace(/_/g, ' ').replace(/\b\w/g, function(l) { return l.toUpperCase(); });
                        var selected = idx === headers.length - 1 ? ' selected' : '';
                        contentHtml += '<option value="' + header + '"' + selected + '>' + formattedHeader + '</option>';
                    });
                }
                contentHtml += '</select>';
                contentHtml += '</div>';

                contentHtml += '</div>'; // End adeptus-chart-controls
                contentHtml += '</div>'; // End adeptus-chart-controls-wrapper

                contentHtml += '<div class="adeptus-chart-container" style="position: relative; height: 400px;">';
                contentHtml += '<canvas id="report-chart"></canvas>';
                contentHtml += '</div>';
                contentHtml += '</div>';

            } else {
                contentHtml += '<div class="alert alert-warning text-center py-4">';
                contentHtml += '<i class="fa fa-inbox fa-2x mb-2 d-block"></i>';
                contentHtml += '<strong>' + STRINGS.noDataAvailable + '</strong><br>';
                contentHtml += '<small class="text-muted">' + STRINGS.noDataRows + '</small>';
                contentHtml += '</div>';
            }

            $('#report-content').html(contentHtml).removeClass('d-none');

            // Reset view to table
            self.currentView = 'table';

            // Attach export handlers
            $('#report-content .adeptus-export-pdf-btn').on('click', function() {
                self.exportReport(report.slug, 'pdf');
            });
            $('#report-content .adeptus-export-csv-btn').on('click', function() {
                if ($(this).hasClass('adeptus-export-premium')) {
                    self.showExportUpgradePrompt('csv');
                    return;
                }
                self.exportReport(report.slug, 'csv');
            });
            $('#report-content .adeptus-export-json-btn').on('click', function() {
                if ($(this).hasClass('adeptus-export-premium')) {
                    self.showExportUpgradePrompt('json');
                    return;
                }
                self.exportReport(report.slug, 'json');
            });

            // Delete button handler (header)
            $('#delete-report-header-btn').off('click').on('click', function() {
                self.confirmDeleteReport(report);
            });
        },

        renderChart: function() {
            var self = this;
            var data = this.currentReportData;

            if (!data || data.length === 0) return;

            var chartType = $('#chart-type-select').val() || 'bar';
            var canvas = document.getElementById('report-chart');
            if (!canvas) return;

            // Destroy existing chart
            if (this.chartInstance) {
                this.chartInstance.destroy();
                this.chartInstance = null;
            }

            // Get user-selected axis columns
            var labelKey = $('#chart-x-axis').val();
            var valueKey = $('#chart-y-axis').val();

            // Fallback if not set
            if (!labelKey || !valueKey) {
                var headers = Object.keys(data[0]);
                labelKey = labelKey || headers[0];
                valueKey = valueKey || headers[headers.length - 1];
            }

            // Format the value key for display
            var valueKeyFormatted = valueKey.replace(/_/g, ' ').replace(/\b\w/g, function(l) { return l.toUpperCase(); });

            // Limit data for chart (max 50 items for readability)
            var chartData = data.slice(0, 50);
            var labels = chartData.map(function(r) {
                var label = r[labelKey];
                if (label === null || label === undefined) return STRINGS.unknown;
                // Truncate long labels
                var labelStr = String(label);
                return labelStr.length > 30 ? labelStr.substring(0, 30) + '...' : labelStr;
            });
            var values = chartData.map(function(r) { return parseFloat(r[valueKey]) || 0; });

            // Generate colors
            var colors = this.generateChartColors(values.length, chartType);

            // Create chart config
            var chartConfig = this.createChartConfig(chartType, labels, values, valueKeyFormatted, colors);

            try {
                this.chartInstance = new this.Chart(canvas.getContext('2d'), chartConfig);
            } catch (error) {
                console.error('Error creating chart:', error);
                $('#report-chart-view .adeptus-chart-container').html(
                    '<div class="alert alert-danger"><i class="fa fa-exclamation-triangle"></i> ' + STRINGS.errorRenderingChart + ': ' + error.message + '</div>'
                );
            }
        },

        generateChartColors: function(count, chartType) {
            var baseColors = [
                '#2563eb', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6',
                '#06b6d4', '#ec4899', '#84cc16', '#f97316', '#6366f1',
                '#14b8a6', '#a855f7', '#eab308', '#22c55e', '#3b82f6'
            ];

            var colors = [];
            for (var i = 0; i < count; i++) {
                colors.push(baseColors[i % baseColors.length]);
            }
            return colors;
        },

        createChartConfig: function(chartType, labels, values, valueKey, colors) {
            var self = this;
            var reportName = this.currentReport?.description || this.currentReport?.name || STRINGS.report;

            var baseConfig = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: reportName,
                        font: { size: 16, weight: 'bold' },
                        padding: { top: 10, bottom: 20 }
                    },
                    legend: {
                        display: chartType === 'pie' || chartType === 'doughnut',
                        position: 'right'
                    }
                }
            };

            if (chartType === 'pie' || chartType === 'doughnut') {
                return {
                    type: chartType,
                    data: {
                        labels: labels,
                        datasets: [{
                            data: values,
                            backgroundColor: colors,
                            borderColor: '#fff',
                            borderWidth: 2
                        }]
                    },
                    options: baseConfig
                };
            } else if (chartType === 'line') {
                return {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: valueKey,
                            data: values,
                            borderColor: colors[0],
                            backgroundColor: colors[0] + '40',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        ...baseConfig,
                        scales: {
                            y: { beginAtZero: true },
                            x: { ticks: { maxRotation: 45, minRotation: 45 } }
                        }
                    }
                };
            } else {
                // Bar chart (default)
                return {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: valueKey,
                            data: values,
                            backgroundColor: colors,
                            borderColor: colors.map(function(c) { return c; }),
                            borderWidth: 1
                        }]
                    },
                    options: {
                        ...baseConfig,
                        scales: {
                            y: { beginAtZero: true },
                            x: { ticks: { maxRotation: 45, minRotation: 45 } }
                        }
                    }
                };
            }
        },

        exportReport: async function(reportSlug, format) {
            var self = this;

            // Check if we have data to export
            if (!self.currentReportData || !Array.isArray(self.currentReportData) || self.currentReportData.length === 0) {
                Swal.fire({
                    icon: 'warning',
                    title: STRINGS.noData,
                    text: STRINGS.noDataToExport
                });
                return;
            }

            Swal.fire({
                title: STRINGS.exportingAs.replace('{format}', format.toUpperCase()),
                allowOutsideClick: false,
                didOpen: function() { Swal.showLoading(); }
            });

            try {
                // Check export eligibility first
                var eligibility = await self.checkExportEligibility(format);
                if (!eligibility.success || !eligibility.eligible) {
                    Swal.close();
                    if (self.isFreePlan && format !== 'pdf') {
                        self.showExportUpgradePrompt(format);
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: STRINGS.exportNotAvailable,
                            text: eligibility.message || STRINGS.exportNotEligible
                        });
                    }
                    return;
                }

                // For wizard reports, use the actual report name instead of the slug
                var reportId = reportSlug;
                var isWizardReport = self.currentReport && self.currentReport.source === 'wizard';
                if (isWizardReport && self.currentReport.name) {
                    reportId = self.currentReport.name;
                }

                var body = 'reportid=' + encodeURIComponent(reportId) + '&format=' + format + '&sesskey=' + M.cfg.sesskey;
                body += '&view=' + self.currentView;

                // Always pass the frontend data for export
                var headers = self.currentReportData.length > 0 ? Object.keys(self.currentReportData[0]) : [];
                var reportDataPayload = {
                    results: self.currentReportData,
                    headers: headers,
                    report_name: self.currentReport?.description || self.currentReport?.name || 'report',
                    report_category: self.currentReport?.category || ''
                };
                body += '&report_data=' + encodeURIComponent(JSON.stringify(reportDataPayload));

                // For PDF, capture chart image if in chart view
                if (format === 'pdf' && self.currentView === 'chart') {
                    try {
                        // Use robust chart capture with timeout protection
                        var chartImagePromise = self.captureChartImage();
                        var timeoutPromise = new Promise(function(_, reject) {
                            setTimeout(function() { reject(new Error('Chart capture timeout')); }, 10000);
                        });

                        var chartImage = await Promise.race([chartImagePromise, timeoutPromise]);

                        if (chartImage && chartImage.length > 100) {
                            body += '&chart_image=' + encodeURIComponent(chartImage);
                            console.log('[GeneratedReports] Chart image included in export');
                        } else {
                            console.warn('[GeneratedReports] Chart capture returned empty or invalid data');
                        }
                    } catch (e) {
                        console.warn('[GeneratedReports] Chart capture failed, continuing without chart:', e.message);
                    }
                }

                var response = await fetch(M.cfg.wwwroot + '/report/adeptus_insights/ajax/export_report.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: body,
                    credentials: 'same-origin'
                });

                var contentType = response.headers.get('content-type');
                var contentDisposition = response.headers.get('content-disposition');

                if (contentType && contentType.includes('application/json') && !contentDisposition) {
                    var errorData = await response.json();
                    throw new Error(errorData.message || 'Export failed');
                }

                if (!response.ok) {
                    throw new Error('Export failed with status: ' + response.status);
                }

                var reportName = self.currentReport?.description || self.currentReport?.name || 'report';
                var sanitizedName = reportName.replace(/[^a-zA-Z0-9\s-]/g, '').replace(/\s+/g, '_').toLowerCase();
                var dateSuffix = new Date().toISOString().split('T')[0];

                var blob = await response.blob();
                var url = window.URL.createObjectURL(blob);
                var link = document.createElement('a');
                link.href = url;
                link.download = sanitizedName + '_' + dateSuffix + '.' + format;
                document.body.appendChild(link);
                link.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(link);

                Swal.close();

                // Track the export
                var reportName = self.currentReport?.description || self.currentReport?.name || 'report';
                self.trackExport(format, reportName);

                // Show toast notification instead of SweetAlert
                self.showToast(format.toUpperCase() + ' ' + STRINGS.fileDownloadedSuccess, 'success');

            } catch (error) {
                Swal.close();
                Swal.fire({
                    icon: 'error',
                    title: STRINGS.exportFailed,
                    text: error.message || STRINGS.exportFailedMessage
                });
            }
        }
    };

    // Make available globally for retry buttons
    window.GeneratedReports = GeneratedReports;

    // Initialize when DOM is ready
    $(document).ready(function() {
        // Wait for auth data to be available
        var checkAuth = setInterval(function() {
            if (window.adeptusAuthData) {
                clearInterval(checkAuth);
                GeneratedReports.init();
            }
        }, 100);

        // Timeout after 5 seconds
        setTimeout(function() {
            clearInterval(checkAuth);
            if (!window.adeptusAuthData) {
                $('#reports-loader').addClass('d-none');
                $('#no-reports-message').removeClass('d-none').html(
                    '<i class="fa fa-exclamation-triangle fa-3x text-warning mb-3"></i>' +
                    '<h5 class="text-muted">' + STRINGS.authenticationRequired + '</h5>' +
                    '<p class="text-muted">' + STRINGS.authenticationRequiredMessage + '</p>'
                );
            }
        }, 5000);
    });
});
{{/js}}

<style>
/* Page Header Banner - Consistent with Wizard/Assistant */
.adeptus-page-header-banner {
    background: linear-gradient(135deg, #0f6cbf 0%, #3a8dd4 100%);
    color: white;
    padding: 30px;
    border-radius: 0.75rem;
    margin-bottom: 30px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: relative;
    overflow: hidden;
}

.adeptus-page-header-banner::before {
    content: '';
    position: absolute;
    top: -50%;
    right: -20%;
    width: 100%;
    height: 200%;
    background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="2" fill="rgba(255,255,255,0.1)"/></svg>') repeat;
    animation: float 20s linear infinite;
}

@keyframes float {
    0% { transform: translateY(0) rotate(0deg); }
    100% { transform: translateY(-50%) rotate(360deg); }
}

/* Toast notification animations */
@keyframes slideIn {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

@keyframes slideOut {
    from {
        transform: translateX(0);
        opacity: 1;
    }
    to {
        transform: translateX(100%);
        opacity: 0;
    }
}

.adeptus-page-header-content {
    z-index: 1;
}

.adeptus-page-header-title {
    font-size: 1.75rem;
    font-weight: 700;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 12px;
}

.adeptus-page-header-icon {
    font-size: 1.5rem;
    animation: iconPulse 3s ease-in-out infinite;
}

@keyframes iconPulse {
    0%, 100% { transform: scale(1) rotate(0deg); }
    50% { transform: scale(1.1) rotate(5deg); }
}

.adeptus-page-header-subtitle {
    font-size: 1rem;
    opacity: 0.9;
    margin: 10px 0 0 0;
}

.adeptus-page-header-actions {
    display: flex;
    gap: 10px;
    z-index: 1;
}

.adeptus-page-header-actions .btn-light {
    background: white;
    color: #0f6cbf;
    border: none;
    font-weight: 500;
}

.adeptus-page-header-actions .btn-light:hover {
    background: #f8f9fa;
    color: #0a5299;
}

.adeptus-page-header-actions .btn-outline-light {
    border: 2px solid rgba(255,255,255,0.8);
    color: white;
    font-weight: 500;
}

.adeptus-page-header-actions .btn-outline-light:hover {
    background: rgba(255,255,255,0.15);
    border-color: white;
}

@media (max-width: 768px) {
    .adeptus-page-header-banner {
        flex-direction: column;
        text-align: center;
        gap: 20px;
    }

    .adeptus-page-header-actions {
        flex-direction: column;
        width: 100%;
    }

    .adeptus-page-header-actions .btn {
        width: 100%;
    }
}

.adeptus-generated-reports-container {
    padding: 0;
}

.adeptus-generated-reports-container .card {
    border: none;
    border-radius: 0.75rem;
    overflow: hidden;
    box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,0.075);
}

.adeptus-generated-reports-container .card-header {
    border: none;
}

.adeptus-report-row {
    cursor: pointer;
    transition: background-color 0.15s ease;
}

.adeptus-report-row:hover {
    background-color: #f8f9fa;
}

.adeptus-report-row.table-primary {
    background-color: #e7f3ff !important;
}

.report-header h4 {
    color: #2c3e50;
    font-weight: 600;
}

.adeptus-report-meta {
    margin-top: 0.5rem;
}

.gap-2 {
    gap: 0.5rem;
}

/* DataTable styling */
.datatable-wrapper .datatable-top,
.datatable-wrapper .datatable-bottom {
    padding: 0.75rem 1rem;
}

.datatable-wrapper .datatable-search input {
    border-radius: 0.5rem;
    padding: 0.5rem 1rem;
}

/* Export buttons */
.adeptus-export-csv-btn, .adeptus-export-json-btn {
    border-radius: 0.5rem;
}

/* Table styling */
.table-responsive {
    border-radius: 0.5rem;
    overflow: hidden;
}

.table thead th {
    background-color: #f8f9fa;
    font-weight: 600;
    border-bottom: 2px solid #dee2e6;
    white-space: nowrap;
}

.table tbody td {
    vertical-align: middle;
}

/* Badge styling */
.badge {
    font-weight: 500;
    padding: 0.35rem 0.65rem;
}

/* Source badges */
.adeptus-badge-ai {
    background: linear-gradient(135deg, #1e3a5f 0%, #2563eb 100%);
    color: white;
    font-size: 11px;
    padding: 0.4rem 0.75rem;
    border-radius: 20px;
    display: inline-flex;
    align-items: center;
    gap: 5px;
}

.adeptus-badge-wizard {
    background: linear-gradient(135deg, #0ea5e9 0%, #06b6d4 100%);
    color: white;
    font-size: 11px;
    padding: 0.4rem 0.75rem;
    border-radius: 20px;
    display: inline-flex;
    align-items: center;
    gap: 5px;
}

.adeptus-badge-ai i,
.adeptus-badge-wizard i,
.adeptus-badge-rowcount i {
    font-size: 10px;
}

.adeptus-badge-rowcount {
    background: #6c757d;
    color: white;
    font-size: 11px;
    padding: 0.4rem 0.75rem;
    border-radius: 20px;
    display: inline-flex;
    align-items: center;
    gap: 5px;
}

/* View toggle buttons */
.adeptus-view-toggle .adeptus-view-toggle-btn {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    color: #495057;
    padding: 0.35rem 0.75rem;
    font-size: 13px;
    transition: all 0.2s ease;
}

.adeptus-view-toggle .adeptus-view-toggle-btn:first-child {
    border-radius: 6px 0 0 6px;
}

.adeptus-view-toggle .adeptus-view-toggle-btn:last-child {
    border-radius: 0 6px 6px 0;
}

.adeptus-view-toggle .adeptus-view-toggle-btn:hover {
    background: #e9ecef;
}

.adeptus-view-toggle .adeptus-view-toggle-btn.active {
    background: #2563eb;
    border-color: #2563eb;
    color: white;
}

.adeptus-view-toggle .adeptus-view-toggle-btn i {
    margin-right: 5px;
}

/* Chart container */
.adeptus-chart-container {
    background: #fff;
    border-radius: 8px;
    padding: 1rem;
    border: 1px solid #e9ecef;
}

.adeptus-chart-controls-wrapper {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 1rem;
    border: 1px solid #e9ecef;
}

.adeptus-chart-controls {
    display: flex;
    align-items: flex-end;
    flex-wrap: wrap;
}

.adeptus-chart-controls .adeptus-control-group {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
}

.adeptus-chart-controls .form-label {
    font-size: 11px;
    font-weight: 600;
    color: #6c757d;
    margin-bottom: 0;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.adeptus-chart-controls .form-select {
    font-size: 13px;
    padding: 0.4rem 2rem 0.4rem 0.75rem;
    border-radius: 6px;
    border: 1px solid #dee2e6;
    background-color: white;
    min-width: 140px;
}

.adeptus-chart-controls .form-select:focus {
    border-color: #2563eb;
    box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.15);
}

/* Hide loader completely when d-none is applied */
#reports-loader.d-none {
    display: none !important;
    height: 0 !important;
    min-height: 0 !important;
    padding: 0 !important;
    margin: 0 !important;
    overflow: hidden !important;
}

/* DataTable filter layout fix */
.datatable-wrapper .datatable-top {
    display: flex;
    flex-wrap: wrap;
    justify-content: space-between;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 0.75rem !important;
}

.datatable-wrapper .datatable-dropdown {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    flex-shrink: 0;
}

.datatable-wrapper .datatable-dropdown label {
    margin: 0;
    font-size: 13px;
    white-space: nowrap;
}

.datatable-wrapper .datatable-dropdown select {
    padding: 0.25rem 0.5rem;
    font-size: 13px;
    border-radius: 4px;
    border: 1px solid #dee2e6;
    min-width: 60px;
}

.datatable-wrapper .datatable-search {
    flex: 1;
    min-width: 150px;
    max-width: 250px;
}

.datatable-wrapper .datatable-search input {
    width: 100%;
    padding: 0.35rem 0.75rem;
    font-size: 13px;
    border: 1px solid #dee2e6;
    border-radius: 4px;
}

.datatable-wrapper .datatable-bottom {
    display: flex;
    flex-wrap: wrap;
    justify-content: space-between;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 0.75rem !important;
    font-size: 13px;
}

.datatable-wrapper .datatable-info {
    color: #6c757d;
}

.datatable-wrapper .datatable-pagination {
    display: flex;
    gap: 0.25rem;
}

.datatable-wrapper .datatable-pagination a {
    padding: 0.25rem 0.5rem;
    font-size: 12px;
    border-radius: 4px;
    text-decoration: none;
    color: #495057;
    background: #f8f9fa;
    border: 1px solid #dee2e6;
}

.datatable-wrapper .datatable-pagination a.active,
.datatable-wrapper .datatable-pagination a:hover {
    background: #2563eb;
    color: white;
    border-color: #2563eb;
}

/* Responsive */
@media (max-width: 768px) {
    .adeptus-generated-reports-container .col-md-4,
    .adeptus-generated-reports-container .col-md-8 {
        margin-bottom: 1rem;
    }

    .card-body[style*="calc(100vh"] {
        height: auto !important;
        max-height: 400px !important;
        min-height: 250px !important;
    }
}

/* Category Management Modal - Modern Design */
.adeptus-cat-modal-popup {
    border-radius: 16px !important;
    padding: 0 !important;
    overflow: visible !important;
}

.adeptus-cat-modal-popup .swal2-title {
    display: none !important;
}

.adeptus-cat-modal-popup .swal2-close {
    position: absolute;
    top: 16px;
    right: 16px;
    width: 32px;
    height: 32px;
    border-radius: 8px;
    background: #f1f5f9;
    color: #64748b;
    font-size: 24px;
    transition: all 0.15s ease;
    z-index: 10;
}

.adeptus-cat-modal-popup .swal2-close:hover {
    background: #e2e8f0;
    color: #334155;
}

.adeptus-cat-modal-popup .swal2-html-container {
    margin: 0 !important;
    padding: 0 !important;
}

.adeptus-cat-modal {
    text-align: left;
}

/* Add Section */
.adeptus-cat-add-section {
    background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
    padding: 24px;
    border-bottom: 1px solid #e2e8f0;
}

.adeptus-cat-add-header {
    font-size: 13px;
    font-weight: 600;
    color: #64748b;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 12px;
}

.adeptus-cat-add-form {
    display: flex;
    gap: 10px;
}

.adeptus-cat-add-input-wrapper {
    flex: 1;
    display: flex;
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 10px;
    overflow: hidden;
    transition: all 0.15s ease;
}

.adeptus-cat-add-input-wrapper:focus-within {
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.adeptus-cat-add-input {
    flex: 1;
    border: none;
    padding: 12px 14px;
    font-size: 14px;
    outline: none;
    background: transparent;
}

.adeptus-cat-add-input::placeholder {
    color: #94a3b8;
}

.adeptus-cat-add-input.error {
    animation: shake 0.3s ease;
}

@keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-4px); }
    75% { transform: translateX(4px); }
}

.adeptus-cat-add-color-wrapper {
    position: relative;
    z-index: 10;
}

/* Ensure SweetAlert doesn't clip the dropdown */
.adeptus-cat-modal-popup .swal2-html-container {
    overflow: visible !important;
}

.adeptus-cat-add-section {
    overflow: visible;
}

.adeptus-cat-add-form {
    overflow: visible;
}

.adeptus-cat-add-input-wrapper {
    overflow: visible;
}

.adeptus-cat-add-color-btn {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 8px 12px;
    border: none;
    border-left: 1px solid #e2e8f0;
    background: transparent;
    cursor: pointer;
    transition: background 0.15s ease;
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
    outline: none;
}

.adeptus-cat-add-color-btn:hover {
    background: #f1f5f9;
}

.adeptus-cat-add-color-btn:focus {
    background: #f1f5f9;
    outline: none;
}

.adeptus-cat-add-color-preview {
    width: 20px;
    height: 20px;
    border-radius: 6px;
    box-shadow: inset 0 0 0 1px rgba(0,0,0,0.1);
}

.adeptus-cat-add-color-btn svg {
    color: #94a3b8;
}

/* Color Dropdown */
.adeptus-cat-color-dropdown {
    position: absolute;
    top: calc(100% + 8px);
    right: 0;
    background: white;
    border-radius: 12px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.2), 0 0 0 1px rgba(0,0,0,0.05);
    padding: 12px;
    z-index: 9999;
    opacity: 0;
    visibility: hidden;
    transform: translateY(-8px);
    transition: opacity 0.2s ease, transform 0.2s ease, visibility 0.2s ease;
    pointer-events: none;
    min-width: 180px;
}

.adeptus-cat-color-dropdown.show {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
    pointer-events: auto;
}

.adeptus-cat-color-swatches {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 8px;
    margin-bottom: 12px;
}

.adeptus-cat-color-swatch {
    width: 32px;
    height: 32px;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    transition: transform 0.15s ease, box-shadow 0.15s ease;
    box-shadow: inset 0 0 0 1px rgba(0,0,0,0.1);
}

.adeptus-cat-color-swatch:hover {
    transform: scale(1.1);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15), inset 0 0 0 1px rgba(0,0,0,0.1);
}

.adeptus-cat-color-custom {
    display: flex;
    align-items: center;
    gap: 10px;
    padding-top: 12px;
    border-top: 1px solid #e2e8f0;
}

.adeptus-cat-color-custom input[type="color"] {
    width: 32px;
    height: 32px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    padding: 0;
    overflow: hidden;
}

.adeptus-cat-color-custom input[type="color"]::-webkit-color-swatch-wrapper {
    padding: 0;
}

.adeptus-cat-color-custom input[type="color"]::-webkit-color-swatch {
    border: none;
    border-radius: 8px;
}

.adeptus-cat-color-custom span {
    font-size: 13px;
    color: #64748b;
}

/* Add Button */
.adeptus-cat-add-btn {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 12px 20px;
    background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    color: white;
    border: none;
    border-radius: 10px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.15s ease;
    box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
}

.adeptus-cat-add-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
}

.adeptus-cat-add-btn:active {
    transform: translateY(0);
}

/* Sections */
.adeptus-cat-section {
    padding: 20px 24px;
}

.adeptus-cat-section-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 14px;
}

.adeptus-cat-section-title {
    font-size: 14px;
    font-weight: 600;
    color: #1e293b;
}

.adeptus-cat-section-count {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 22px;
    height: 22px;
    padding: 0 7px;
    background: #e2e8f0;
    color: #64748b;
    border-radius: 6px;
    font-size: 12px;
    font-weight: 600;
}

.adeptus-cat-section-badge {
    font-size: 11px;
    font-weight: 500;
    color: #94a3b8;
    background: #f1f5f9;
    padding: 4px 8px;
    border-radius: 4px;
}

/* Custom Category Cards */
.adeptus-cat-cards-list {
    display: flex;
    flex-direction: column;
    gap: 8px;
    max-height: 200px;
    overflow-y: auto;
}

.adeptus-cat-card {
    display: flex;
    align-items: center;
    gap: 14px;
    padding: 14px 16px;
    background: #f8fafc;
    border-radius: 12px;
    transition: all 0.15s ease;
}

.adeptus-cat-card:hover {
    background: #f1f5f9;
}

.adeptus-cat-card-color {
    width: 6px;
    height: 40px;
    border-radius: 3px;
    flex-shrink: 0;
}

.adeptus-cat-card-content {
    flex: 1;
    min-width: 0;
}

.adeptus-cat-card-name {
    font-size: 14px;
    font-weight: 600;
    color: #1e293b;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.adeptus-cat-card-meta {
    font-size: 12px;
    color: #94a3b8;
    margin-top: 2px;
}

.adeptus-cat-card-actions {
    display: flex;
    gap: 4px;
    opacity: 0;
    transition: opacity 0.15s ease;
}

.adeptus-cat-card:hover .adeptus-cat-card-actions {
    opacity: 1;
}

.adeptus-cat-action-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 32px;
    height: 32px;
    border: none;
    border-radius: 8px;
    background: white;
    color: #64748b;
    cursor: pointer;
    transition: all 0.15s ease;
    box-shadow: 0 1px 3px rgba(0,0,0,0.08);
}

.adeptus-cat-action-btn:hover {
    background: white;
    color: #3b82f6;
    box-shadow: 0 2px 8px rgba(0,0,0,0.12);
}

.adeptus-cat-action-btn-danger:hover {
    color: #ef4444;
}

/* Empty State */
.adeptus-cat-empty-state {
    text-align: center;
    padding: 32px 20px;
}

.adeptus-cat-empty-icon {
    color: #cbd5e1;
    margin-bottom: 12px;
}

.adeptus-cat-empty-text {
    font-size: 14px;
    font-weight: 600;
    color: #64748b;
}

.adeptus-cat-empty-hint {
    font-size: 13px;
    color: #94a3b8;
    margin-top: 4px;
}

/* System Categories */
.adeptus-cat-section-system {
    background: #fafbfc;
    border-top: 1px solid #e2e8f0;
}

.adeptus-cat-system-list {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
}

.adeptus-cat-system-item {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 8px 12px;
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    font-size: 13px;
}

.adeptus-cat-system-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    flex-shrink: 0;
}

.adeptus-cat-system-name {
    color: #475569;
    font-weight: 500;
}

.adeptus-cat-system-count {
    color: #94a3b8;
    font-size: 12px;
}

/* Scrollbar styling */
.adeptus-cat-cards-list::-webkit-scrollbar {
    width: 6px;
}

.adeptus-cat-cards-list::-webkit-scrollbar-track {
    background: transparent;
}

.adeptus-cat-cards-list::-webkit-scrollbar-thumb {
    background: #cbd5e1;
    border-radius: 3px;
}

.adeptus-cat-cards-list::-webkit-scrollbar-thumb:hover {
    background: #94a3b8;
}

/* Edit Category Dialog */
.adeptus-cat-edit-popup {
    border-radius: 16px !important;
    padding: 24px !important;
}

.adeptus-cat-edit-popup .swal2-title {
    font-size: 18px;
    font-weight: 600;
    color: #1e293b;
    margin-bottom: 20px;
}

.adeptus-cat-edit-modal {
    text-align: left;
}

.adeptus-cat-edit-preview {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 16px;
    background: #f8fafc;
    border-radius: 12px;
    margin-bottom: 20px;
}

.adeptus-cat-edit-preview-color {
    width: 8px;
    height: 36px;
    border-radius: 4px;
    flex-shrink: 0;
}

.adeptus-cat-edit-preview-name {
    font-size: 15px;
    font-weight: 600;
    color: #1e293b;
}

.adeptus-cat-edit-field {
    margin-bottom: 16px;
}

.adeptus-cat-edit-label {
    display: block;
    font-size: 13px;
    font-weight: 600;
    color: #64748b;
    margin-bottom: 8px;
}

.adeptus-cat-edit-input {
    width: 100%;
    padding: 12px 14px;
    border: 1px solid #e2e8f0;
    border-radius: 10px;
    font-size: 14px;
    transition: all 0.15s ease;
}

.adeptus-cat-edit-input:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.adeptus-cat-edit-colors {
    display: flex;
    align-items: center;
    gap: 16px;
}

.adeptus-cat-edit-swatches {
    display: flex;
    gap: 8px;
}

.adeptus-edit-color-swatch {
    width: 28px;
    height: 28px;
    border-radius: 8px;
    border: 2px solid transparent;
    cursor: pointer;
    transition: all 0.15s ease;
    box-shadow: inset 0 0 0 1px rgba(0,0,0,0.1);
}

.adeptus-edit-color-swatch:hover {
    transform: scale(1.1);
}

.adeptus-edit-color-swatch.selected {
    border-color: #1e293b;
    box-shadow: 0 0 0 2px white, 0 0 0 4px currentColor;
}

.adeptus-cat-edit-custom {
    display: flex;
    align-items: center;
    gap: 8px;
    padding-left: 16px;
    border-left: 1px solid #e2e8f0;
}

.adeptus-cat-edit-custom input[type="color"] {
    width: 28px;
    height: 28px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    padding: 0;
}

.adeptus-cat-edit-custom input[type="color"]::-webkit-color-swatch-wrapper {
    padding: 0;
}

.adeptus-cat-edit-custom input[type="color"]::-webkit-color-swatch {
    border: none;
    border-radius: 8px;
    box-shadow: inset 0 0 0 1px rgba(0,0,0,0.1);
}

.adeptus-cat-edit-custom span {
    font-size: 13px;
    color: #94a3b8;
}

.adeptus-cat-edit-confirm-btn {
    background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%) !important;
    border: none !important;
    border-radius: 10px !important;
    padding: 12px 24px !important;
    font-weight: 600 !important;
    box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3) !important;
}

.adeptus-cat-edit-confirm-btn:hover {
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4) !important;
}

.adeptus-cat-edit-cancel-btn {
    background: #f1f5f9 !important;
    color: #64748b !important;
    border: none !important;
    border-radius: 10px !important;
    padding: 12px 24px !important;
    font-weight: 600 !important;
}

.adeptus-cat-edit-cancel-btn:hover {
    background: #e2e8f0 !important;
    color: #475569 !important;
}

/* Report Category Selector in Header */
.adeptus-report-category-selector {
    position: relative;
    display: flex;
    align-items: center;
    gap: 10px;
}

/* Delete button in header */
.adeptus-delete-report-header-btn {
    padding: 6px 10px;
    border-radius: 8px;
    background: rgba(220, 53, 69, 0.15);
    border: 1px solid rgba(220, 53, 69, 0.3);
    color: #fff;
    transition: all 0.15s ease;
}

.adeptus-delete-report-header-btn:hover {
    background: rgba(220, 53, 69, 0.9);
    border-color: rgba(220, 53, 69, 1);
    color: #fff;
}

.adeptus-delete-report-header-btn:focus {
    outline: none;
    box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.3);
}

/* Action separator in action bar */
.action-separator {
    width: 1px;
    height: 24px;
    background: #dee2e6;
    margin: 0 8px;
}

/* Delete button in action bar */
.delete-report-btn {
    transition: all 0.15s ease;
}

.delete-report-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(220, 53, 69, 0.3);
}

.adeptus-category-dropdown-wrapper {
    position: relative;
}

.adeptus-category-current-btn {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 6px 12px;
    background: rgba(255, 255, 255, 0.15);
    border: 1px solid rgba(255, 255, 255, 0.25);
    border-radius: 8px;
    color: white;
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.15s ease;
    -webkit-appearance: none;
    appearance: none;
    outline: none;
}

.adeptus-category-current-btn:hover {
    background: rgba(255, 255, 255, 0.25);
    border-color: rgba(255, 255, 255, 0.4);
}

.adeptus-category-current-btn:focus {
    background: rgba(255, 255, 255, 0.25);
    outline: none;
}

.adeptus-category-current-btn .adeptus-category-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    flex-shrink: 0;
    box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.3);
}

.adeptus-category-current-btn .adeptus-category-name {
    max-width: 120px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.adeptus-category-current-btn svg {
    opacity: 0.7;
    flex-shrink: 0;
}

.adeptus-category-current-btn.success-flash {
    animation: categorySuccessFlash 0.6s ease;
}

@keyframes categorySuccessFlash {
    0%, 100% { background: rgba(255, 255, 255, 0.15); }
    50% { background: rgba(16, 185, 129, 0.5); }
}

/* Category Dropdown Menu */
.adeptus-category-dropdown-menu {
    position: absolute;
    top: calc(100% + 8px);
    right: 0;
    min-width: 200px;
    max-height: 300px;
    overflow-y: auto;
    background: white;
    border-radius: 12px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2), 0 0 0 1px rgba(0, 0, 0, 0.05);
    padding: 6px;
    z-index: 1000;
    opacity: 0;
    visibility: hidden;
    transform: translateY(-8px);
    transition: opacity 0.2s ease, transform 0.2s ease, visibility 0.2s ease;
    pointer-events: none;
}

.adeptus-category-dropdown-menu.show {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
    pointer-events: auto;
}

.adeptus-category-menu-item {
    display: flex;
    align-items: center;
    gap: 10px;
    width: 100%;
    padding: 10px 12px;
    background: transparent;
    border: none;
    border-radius: 8px;
    color: #1e293b;
    font-size: 14px;
    text-align: left;
    cursor: pointer;
    transition: background 0.15s ease;
    -webkit-appearance: none;
    appearance: none;
}

.adeptus-category-menu-item:hover {
    background: #f1f5f9;
}

.adeptus-category-menu-item.selected {
    background: #eff6ff;
}

.adeptus-category-menu-item.selected .adeptus-category-menu-name {
    color: #2563eb;
    font-weight: 600;
}

.adeptus-category-menu-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    flex-shrink: 0;
    box-shadow: inset 0 0 0 1px rgba(0, 0, 0, 0.1);
}

.adeptus-category-menu-name {
    flex: 1;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.adeptus-category-menu-check {
    color: #2563eb;
    flex-shrink: 0;
}

/* Dropdown scrollbar */
.adeptus-category-dropdown-menu::-webkit-scrollbar {
    width: 6px;
}

.adeptus-category-dropdown-menu::-webkit-scrollbar-track {
    background: transparent;
}

.adeptus-category-dropdown-menu::-webkit-scrollbar-thumb {
    background: #cbd5e1;
    border-radius: 3px;
}

.adeptus-category-dropdown-menu::-webkit-scrollbar-thumb:hover {
    background: #94a3b8;
}
</style>
