{{!
    This file is part of Moodle - http://moodle.org/
    Diagnostic Template - Modern, Beautiful, Responsive Interface
}}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.all.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

{{#js}}
require(['jquery', 'core/ajax', 'core/notification'], function($, Ajax, Notification) {
    // Diagnostic page loaded successfully
    console.log('Adeptus Insights Diagnostic page loaded');
});
{{/js}}

<!-- Global Authentication Header -->
{{> report_adeptus_insights/global_auth_header }}

<div class="diagnostic-actions">
    <a href="{{config.wwwroot}}/report/adeptus_insights/subscription.php" class="btn btn-primary">
        <i class="fa fa-arrow-left"></i> Back to Subscription Management
    </a>
    <a href="{{config.wwwroot}}/report/adeptus_insights/register_plugin.php" class="btn btn-warning">
        <i class="fa fa-key"></i> Register Plugin
    </a>
</div>

<div class="adeptus-diagnostic-container" id="diagnostic-container">
    <!-- Header Section -->
    <div class="diagnostic-header">
        <div class="diagnostic-header-content">
            <h1 class="diagnostic-title">
                <i class="fa fa-stethoscope diagnostic-icon"></i>
                {{#str}}system_diagnostics, report_adeptus_insights{{/str}}
            </h1>
            <p class="diagnostic-subtitle">{{#str}}diagnostic_subtitle, report_adeptus_insights{{/str}}</p>
        </div>
        <div class="diagnostic-user-info">
            <span class="user-welcome">Welcome, {{user_fullname}}</span>
        </div>
    </div>

    <!-- Diagnostic Content Grid -->
    <div class="diagnostic-content">
        <!-- Installation Status Card -->
        <div class="diagnostic-card">
            <div class="card-header">
                <h3><i class="fa fa-server"></i> {{#str}}installation_status, report_adeptus_insights{{/str}}</h3>
            </div>
            <div class="card-content">
                <div class="status-grid">
                    <div class="status-item {{#is_registered}}status-success{{/is_registered}}{{^is_registered}}status-error{{/is_registered}}">
                        <div class="status-icon">
                            <i class="fa {{#is_registered}}fa-check-circle{{/is_registered}}{{^is_registered}}fa-times-circle{{/is_registered}}"></i>
                        </div>
                        <div class="status-details">
                            <h4>{{#str}}registration_status, report_adeptus_insights{{/str}}</h4>
                            <p>{{#is_registered}}{{#str}}registered, report_adeptus_insights{{/str}}{{/is_registered}}{{^is_registered}}{{#str}}plugin_not_registered_status, report_adeptus_insights{{/str}}{{/is_registered}}</p>
                        </div>
                    </div>
                    
                    <div class="status-item {{#api_key}}status-success{{/api_key}}{{^api_key}}status-error{{/api_key}}">
                        <div class="status-icon">
                            <i class="fa {{#api_key}}fa-key{{/api_key}}{{^api_key}}fa-times-circle{{/api_key}}"></i>
                        </div>
                        <div class="status-details">
                            <h4>{{#str}}api_key_status, report_adeptus_insights{{/str}}</h4>
                            <p>{{#api_key}}{{#str}}present, report_adeptus_insights{{/str}}{{/api_key}}{{^api_key}}{{#str}}api_key_missing_status, report_adeptus_insights{{/str}}{{/api_key}}</p>
                        </div>
                    </div>
                    
                    <div class="status-item {{#installation_id}}status-success{{/installation_id}}{{^installation_id}}status-error{{/installation_id}}">
                        <div class="status-icon">
                            <i class="fa {{#installation_id}}fa-id-card{{/installation_id}}{{^installation_id}}fa-times-circle{{/installation_id}}"></i>
                        </div>
                        <div class="status-details">
                            <h4>{{#str}}installation_id_status, report_adeptus_insights{{/str}}</h4>
                            <p>{{installation_id}}{{^installation_id}}{{#str}}installation_id_not_set_status, report_adeptus_insights{{/str}}{{/installation_id}}</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Database Tables Card -->
        <div class="diagnostic-card">
            <div class="card-header">
                <h3><i class="fa fa-database"></i> {{#str}}database_tables, report_adeptus_insights{{/str}}</h3>
            </div>
            <div class="card-content">
                <div class="table-grid">
                    {{#database_tables}}
                    <div class="table-item {{#exists}}table-exists{{/exists}}{{^exists}}table-missing{{/exists}}">
                        <div class="table-icon">
                            <i class="fa {{#exists}}fa-table{{/exists}}{{^exists}}fa-times-circle{{/exists}}"></i>
                        </div>
                        <div class="table-details">
                            <h4>{{name}}</h4>
                            <p>{{#exists}}{{#str}}exists, report_adeptus_insights{{/str}} ({{records}} {{#str}}records, report_adeptus_insights{{/str}}){{/exists}}{{^exists}}{{#str}}missing, report_adeptus_insights{{/str}}{{/exists}}</p>
                        </div>
                    </div>
                    {{/database_tables}}
                </div>
                <div class="note">
                    <i class="fa fa-info-circle"></i>
                    <span>{{#str}}subscription_plans_backend_note, report_adeptus_insights{{/str}}</span>
                </div>
            </div>
        </div>

        <!-- API Connectivity Card -->
        <div class="diagnostic-card">
            <div class="card-header">
                <h3><i class="fa fa-plug"></i> {{#str}}api_connectivity, report_adeptus_insights{{/str}}</h3>
            </div>
            <div class="card-content">
                <div class="connectivity-status {{#api_connected}}status-success{{/api_connected}}{{^api_connected}}status-error{{/api_connected}}">
                    <div class="status-icon">
                        <i class="fa {{#api_connected}}fa-check-circle{{/api_connected}}{{^api_connected}}fa-times-circle{{/api_connected}}"></i>
                    </div>
                    <div class="status-details">
                        <h4>{{#str}}backend_connection, report_adeptus_insights{{/str}}</h4>
                        <p>{{#api_connected}}{{#str}}connected_successfully, report_adeptus_insights{{/str}}{{/api_connected}}{{^api_connected}}{{#str}}connection_failed, report_adeptus_insights{{/str}}{{/api_connected}}</p>
                        {{#api_error}}
                        <div class="error-details">
                            <strong>{{#str}}error, report_adeptus_insights{{/str}}:</strong> {{api_error}}
                        </div>
                        {{/api_error}}
                    </div>
                </div>
            </div>
        </div>

        <!-- Available Plans Card -->
        <div class="diagnostic-card">
            <div class="card-header">
                <h3><i class="fa fa-list"></i> {{#str}}available_plans, report_adeptus_insights{{/str}}</h3>
            </div>
            <div class="card-content">
                <div class="plans-status {{#plans_available}}status-success{{/plans_available}}{{^plans_available}}status-error{{/plans_available}}">
                    <div class="status-icon">
                        <i class="fa {{#plans_available}}fa-check-circle{{/plans_available}}{{^plans_available}}fa-times-circle{{/plans_available}}"></i>
                    </div>
                    <div class="status-details">
                        <h4>{{#str}}subscription_plans, report_adeptus_insights{{/str}}</h4>
                        <p>{{#plans_available}}{{plans_count}} {{#str}}plans_available, report_adeptus_insights{{/str}}{{/plans_available}}{{^plans_available}}{{#str}}no_plans_available, report_adeptus_insights{{/str}}{{/plans_available}}</p>
                        {{#plans_error}}
                        <div class="error-details">
                            <strong>{{#str}}error, report_adeptus_insights{{/str}}:</strong> 
                            {{#user_friendly_message}}{{user_friendly_message}}{{/user_friendly_message}}
                            {{^user_friendly_message}}{{plans_error}}{{/user_friendly_message}}
                        </div>
                        {{/plans_error}}
                    </div>
                </div>
                
                {{#plans_list}}
                <div class="plans-list">
                    <h4>{{#str}}available_plans_colon, report_adeptus_insights{{/str}}</h4>
                    <div class="plans-grid">
                        {{#plans}}
                        <div class="plan-item">
                            <div class="plan-name">{{name}}</div>
                            <div class="plan-price">{{price}}</div>
                            <div class="plan-features">
                                {{#features}}
                                <span class="feature-tag">{{.}}</span>
                                {{/features}}
                            </div>
                        </div>
                        {{/plans}}
                    </div>
                </div>
                {{/plans_list}}
            </div>
        </div>

        <!-- Current Subscription Card -->
        <div class="diagnostic-card">
            <div class="card-header">
                <h3><i class="fa fa-credit-card"></i> {{#str}}current_subscription, report_adeptus_insights{{/str}}</h3>
            </div>
            <div class="card-content">
                {{#current_subscription}}
                <div class="subscription-details">
                    <div class="subscription-info">
                        <div class="info-item">
                            <strong>{{#str}}plan, report_adeptus_insights{{/str}}:</strong> {{plan_name}}
                        </div>
                        <div class="info-item">
                            <strong>{{#str}}status, report_adeptus_insights{{/str}}:</strong> 
                            <span class="status-badge status-{{status}}">{{status}}</span>
                        </div>
                        <div class="info-item">
                            <strong>{{#str}}price, report_adeptus_insights{{/str}}:</strong> {{price}}
                        </div>
                        <div class="info-item">
                            <strong>{{#str}}ai_credits, report_adeptus_insights{{/str}}:</strong> {{ai_credits_remaining}}
                        </div>
                        <div class="info-item">
                            <strong>{{#str}}exports, report_adeptus_insights{{/str}}:</strong> {{exports_remaining}}
                        </div>
                        {{#next_billing}}
                        <div class="info-item">
                            <strong>{{#str}}next_billing, report_adeptus_insights{{/str}}:</strong> {{next_billing}}
                        </div>
                        {{/next_billing}}
                    </div>
                </div>
                {{/current_subscription}}
                {{^current_subscription}}
                <div class="no-subscription">
                    <i class="fa fa-info-circle"></i>
                    <span>{{#str}}no_active_subscription, report_adeptus_insights{{/str}}</span>
                </div>
                {{/current_subscription}}
            </div>
        </div>

        <!-- System Information Card -->
        <div class="diagnostic-card">
            <div class="card-header">
                <h3><i class="fa fa-cog"></i> {{#str}}system_information, report_adeptus_insights{{/str}}</h3>
            </div>
            <div class="card-content">
                <div class="system-info">
                    <div class="info-item">
                        <strong>{{#str}}moodle_version, report_adeptus_insights{{/str}}:</strong> {{moodle_version}}
                    </div>
                    <div class="info-item">
                        <strong>{{#str}}php_version, report_adeptus_insights{{/str}}:</strong> {{php_version}}
                    </div>
                    <div class="info-item">
                        <strong>{{#str}}database_type, report_adeptus_insights{{/str}}:</strong> {{database_type}}
                    </div>
                    <div class="info-item">
                        <strong>{{#str}}last_updated, report_adeptus_insights{{/str}}:</strong> {{last_updated}}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* Diagnostic Styles */
.adeptus-diagnostic-container {
    max-width: 100% !important;
    width: 100% !important;
    margin: 0 !important;
    padding: 20px;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    box-sizing: border-box;
}

.diagnostic-actions {
    margin-bottom: 17px;
    display: flex;
    gap: 10px;
}

.diagnostic-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 30px;
    border-radius: 12px;
    margin-bottom: 30px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.diagnostic-title {
    margin: 0;
    font-size: 28px;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 12px;
}

.diagnostic-icon {
    font-size: 24px;
}

.diagnostic-subtitle {
    margin: 8px 0 0 0;
    opacity: 0.9;
    font-size: 16px;
}

.diagnostic-user-info {
    text-align: right;
}

.user-welcome {
    font-size: 14px;
    opacity: 0.9;
}

.diagnostic-content {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
    gap: 20px;
    margin-top: 20px;
}

.diagnostic-card {
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    overflow: hidden;
    border: 1px solid #e9ecef;
    height: 100%;
    display: flex;
    flex-direction: column;
}

.card-header {
    background: #f8f9fa;
    padding: 20px;
    border-bottom: 1px solid #e9ecef;
}

.card-header h3 {
    margin: 0;
    font-size: 18px;
    font-weight: 600;
    color: #495057;
    display: flex;
    align-items: center;
    gap: 10px;
}

.card-content {
    padding: 20px;
    flex-grow: 1;
}

.status-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
}

.status-item {
    display: flex;
    align-items: center;
    gap: 15px;
    padding: 15px;
    border-radius: 8px;
    border: 1px solid #e9ecef;
    background: #f8f9fa;
}

.status-success {
    border-color: #d4edda;
    background: #d1ecf1;
}

.status-error {
    border-color: #f5c6cb;
    background: #f8d7da;
}

.status-icon {
    font-size: 20px;
}

.status-success .status-icon {
    color: #28a745;
}

.status-error .status-icon {
    color: #dc3545;
}

.status-details h4 {
    margin: 0 0 5px 0;
    font-size: 14px;
    font-weight: 600;
    color: #495057;
}

.status-details p {
    margin: 0;
    font-size: 13px;
    color: #6c757d;
}

.table-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
}

.table-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px;
    border-radius: 6px;
    border: 1px solid #e9ecef;
    background: #f8f9fa;
}

.table-exists {
    border-color: #d4edda;
    background: #d1ecf1;
}

.table-missing {
    border-color: #f5c6cb;
    background: #f8d7da;
}

.table-icon {
    font-size: 16px;
}

.table-exists .table-icon {
    color: #28a745;
}

.table-missing .table-icon {
    color: #dc3545;
}

.table-details h4 {
    margin: 0 0 3px 0;
    font-size: 13px;
    font-weight: 600;
    color: #495057;
}

.table-details p {
    margin: 0;
    font-size: 12px;
    color: #6c757d;
}

.note {
    margin-top: 15px;
    padding: 10px;
    background: #fff3cd;
    border: 1px solid #ffeaa7;
    border-radius: 6px;
    color: #856404;
    font-size: 13px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.connectivity-status {
    display: flex;
    align-items: center;
    gap: 15px;
    padding: 20px;
    border-radius: 8px;
    border: 1px solid #e9ecef;
}

.connectivity-status.status-success {
    border-color: #d4edda;
    background: #d1ecf1;
}

.connectivity-status.status-error {
    border-color: #f5c6cb;
    background: #f8d7da;
}

.error-details {
    margin-top: 10px;
    padding: 10px;
    background: rgba(220, 53, 69, 0.1);
    border-radius: 4px;
    font-size: 12px;
    color: #721c24;
}

.plans-status {
    display: flex;
    align-items: center;
    gap: 15px;
    padding: 20px;
    border-radius: 8px;
    border: 1px solid #e9ecef;
    margin-bottom: 20px;
}

.plans-status.status-success {
    border-color: #d4edda;
    background: #d1ecf1;
}

.plans-status.status-error {
    border-color: #f5c6cb;
    background: #f8d7da;
}

.plans-list {
    margin-top: 20px;
}

.plans-list h4 {
    margin: 0 0 15px 0;
    font-size: 16px;
    color: #495057;
}

.plans-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
}

.plan-item {
    padding: 15px;
    border: 1px solid #e9ecef;
    border-radius: 8px;
    background: #f8f9fa;
}

.plan-name {
    font-weight: 600;
    color: #495057;
    margin-bottom: 5px;
}

.plan-price {
    font-size: 14px;
    color: #28a745;
    font-weight: 600;
    margin-bottom: 8px;
}

.plan-features {
    display: flex;
    flex-wrap: wrap;
    gap: 5px;
}

.feature-tag {
    background: #e9ecef;
    color: #495057;
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 11px;
}

.subscription-details {
    padding: 20px;
    background: #f8f9fa;
    border-radius: 8px;
    border: 1px solid #e9ecef;
}

.subscription-info {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
}

.info-item {
    display: flex;
    align-items: center;
    gap: 8px;
}

.info-item strong {
    color: #495057;
    min-width: 100px;
}

.status-badge {
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
}

.status-active {
    background: #d4edda;
    color: #155724;
}

.status-cancelled {
    background: #f8d7da;
    color: #721c24;
}

.status-pending {
    background: #fff3cd;
    color: #856404;
}

.no-subscription {
    text-align: center;
    padding: 30px;
    color: #6c757d;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
}

.system-info {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
}

.system-info .info-item {
    padding: 10px;
    background: #f8f9fa;
    border-radius: 6px;
    border: 1px solid #e9ecef;
}

@media (max-width: 768px) {
    .diagnostic-header {
        flex-direction: column;
        text-align: center;
        gap: 15px;
    }
    
    .diagnostic-content {
        grid-template-columns: 1fr;
    }
    
    .status-grid,
    .table-grid,
    .plans-grid {
        grid-template-columns: 1fr;
    }
    
    .subscription-info,
    .system-info {
        grid-template-columns: 1fr;
    }
}

@media (min-width: 768px) {
    .pagelayout-standard #page.drawers .main-inner, body.limitedwidth #page.drawers .main-inner {
        max-width: 100% !important;
    }
}

.diagnostic-actions{
    padding-left: 20px;
    padding-right: 20px;
}
</style> 