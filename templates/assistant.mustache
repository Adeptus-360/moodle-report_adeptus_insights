{{!
    This file is part of Moodle - http://moodle.org/

    Moodle is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    Moodle is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
}}
{{!
    @template   report_adeptus_insights/assistant

    AI Report Assistant interface template with chat functionality, message history,
    and report generation capabilities.

    CSS is loaded from: styles/assistant.css
    JS is loaded from: amd/src/assistant.js (via PHP)

    Note: Do NOT load Bootstrap from CDN - Moodle includes Bootstrap and loading another version breaks navigation

    @package    report_adeptus_insights
    @copyright  2026 Adeptus 360 <info@adeptus360.com>
    @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
}}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.all.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/simple-datatables@latest"></script>
<link href="https://cdn.jsdelivr.net/npm/simple-datatables@latest/dist/style.css" rel="stylesheet" type="text/css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="stylesheet" href="{{config.wwwroot}}/report/adeptus_insights/styles/assistant.css">

{{#js}}
require(['jquery', 'core/ajax', 'core/notification', 'core/templates', 'report_adeptus_insights/assistant'], function($, Ajax, Notification, Templates, Assistant) {
// Note: Chart.js is loaded by assistant.js directly (not core/chartjs) to avoid Moodle reactive component conflicts
// Clear any existing AMD cache for our module
require.undef('report_adeptus_insights/assistant');
// Initialize the assistant with authentication status and plan type
Assistant.init({{authenticated}}, {{#is_free_plan}}true{{/is_free_plan}}{{^is_free_plan}}false{{/is_free_plan}});
});
{{/js}}

<!-- Header Banner -->
<div class="adeptus-assistant-header">
    <div class="adeptus-assistant-header-content">
        <h1 class="adeptus-assistant-title">
            <i class="fa fa-robot adeptus-assistant-icon"></i>
            {{#str}}ai_report_assistant, report_adeptus_insights{{/str}}
        </h1>
        <p class="adeptus-assistant-subtitle">{{#str}}assistant_subtitle, report_adeptus_insights{{/str}}</p>
    </div>
    <div class="adeptus-assistant-header-actions">
        <a href="{{config.wwwroot}}/report/adeptus_insights/index.php" class="btn btn-light">
            <i class="fa fa-arrow-left"></i> {{#str}}back_to_dashboard, report_adeptus_insights{{/str}}
        </a>
    </div>
</div>

<div id="adeptus-assistant-container" class="container-fluid">
    <div class="main-inner position-relative">
        <!-- Top-level tabs: AI Assistant vs. Reports -->
        <ul class="nav nav-tabs mb-4" id="mainTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active"
                        id="assistant-tab"
                        data-toggle="tab"
                        data-target="#assistant-panel"
                        type="button"
                        role="tab"
                        aria-controls="assistant-panel"
                        aria-selected="true">
                    <i class="fa fa-robot"></i>&nbsp;{{#str}}ai_assistant, report_adeptus_insights{{/str}}
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link"
                        id="reports-tab"
                        data-toggle="tab"
                        data-target="#reports-panel"
                        type="button"
                        role="tab"
                        aria-controls="reports-panel"
                        aria-selected="false">
                    <i class="fa fa-file-alt"></i>&nbsp;{{#str}}reports, report_adeptus_insights{{/str}}
                </button>
            </li>
        </ul>
        <div class="tab-content" id="mainTabsContent">
            <!-- AI Assistant Tab -->
            <div class="tab-pane fade show active"
                id="assistant-panel"
                role="tabpanel"
                aria-labelledby="assistant-tab">
                <div class="row">
                    <!-- Chat Interface -->
                    <div class="col-md-8">
                        <div class="card shadow-sm mb-4">
                            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                                <h5 class="card-title mb-0">{{#str}}ai_report_assistant, report_adeptus_insights{{/str}}</h5>
                                <div class="btn-group">
                                    <button class="btn btn-primary" id="create-new-chat">
                                        <i class="fa fa-plus"></i> {{#str}}new_chat, report_adeptus_insights{{/str}}
                                    </button>
                                </div>
                            </div>
                            <div class="card-body p-0 position-relative adeptus-chat-card-body">
                                <!-- Chat Messages -->
                                <div id="adeptus-chat-container" class="adeptus-chat-container fade-in"></div>
                                <!-- MCQ Container -->
                                <div id="adeptus-mcq-container" class="adeptus-mcq-container"></div>
                                <!-- Loading Indicator -->
                                <div id="adeptus-loading-indicator" class="adeptus-loading-indicator d-none">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="sr-only">{{#str}}loading, report_adeptus_insights{{/str}}</span>
                                    </div>
                                </div>
                                <!-- Error Message -->
                                <div id="adeptus-error-message" class="adeptus-error-message d-none">
                                    <div class="alert alert-danger m-3">
                                        <i class="fa fa-exclamation-circle"></i>
                                        <span id="error-text"></span>
                                        <button type="button" class="btn-close" data-dismiss="alert"></button>
                                    </div>
                                </div>
                            </div>
                            <div class="card-footer bg-white adeptus-chat-input-area border-top">
                                <div class="input-group">
                                    <textarea id="message-input"
                                            class="form-control"
                                            placeholder="{{#str}}describe_report_placeholder, report_adeptus_insights{{/str}}"
                                            rows="1"></textarea>
                                    <button id="send-button" class="btn btn-primary">
                                        <i class="fa fa-paper-plane"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Chat History -->
                    <div class="col-md-4">
                        <div class="card shadow-sm mb-4">
                            <div class="card-header bg-primary text-white">
                                <h5 class="card-title mb-0 adeptus-chat-history-title">{{#str}}chat_history, report_adeptus_insights{{/str}}</h5>
                            </div>
                            <div class="card-body adeptus-history-card-body">
                                <ul id="chat-history-list" class="list-group list-group-flush">
                                    <li id="chat-history-loading"
                                        class="list-group-item d-flex justify-content-center">
                                        <div class="spinner-border text-secondary" role="status">
                                            <span class="visually-hidden">{{#str}}loading_chats, report_adeptus_insights{{/str}}</span>
                                        </div>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Reports Tab -->
            <div class="tab-pane fade"
                id="reports-panel"
                role="tabpanel"
                aria-labelledby="reports-tab">
                <div class="row">
                    <!-- Reports View -->
                    <div class="col-md-8">
                        <div class="card shadow-sm mb-4">
                            <div class="card-header bg-primary text-white">
                                <h5 class="card-title mb-0 adeptus-report-view-title">{{#str}}select_a_report, report_adeptus_insights{{/str}}</h5>
                            </div>
                            <div class="card-body p-4 adeptus-report-view-body">
                                <div class="text-center py-4">
                                    <p class="text-muted">{{#str}}select_report_instruction, report_adeptus_insights{{/str}}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Reports History -->
                    <div class="col-md-4">
                        <div class="card shadow-sm mb-4">
                            <div class="card-header bg-primary text-white">
                                <h5 class="card-title mb-0">{{#str}}report_history, report_adeptus_insights{{/str}}</h5>
                            </div>
                            <div class="card-body p-0 position-relative adeptus-reports-history-body">
                                <div id="report-history-loader" class="p-4 d-flex justify-content-center">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="sr-only">{{#str}}loading, report_adeptus_insights{{/str}}</span>
                                    </div>
                                </div>
                                <div class="table-responsive d-none" id="report-history-table-wrapper">
                                    <table id="reports-history-table" class="table mb-0">
                                        <thead>
                                            <tr>
                                                <th>{{#str}}report_name, report_adeptus_insights{{/str}}</th>
                                                <th>{{#str}}date, report_adeptus_insights{{/str}}</th>
                                                <th>{{#str}}status, report_adeptus_insights{{/str}}</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <!-- Report history rows will be injected here -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- /tab-content -->
        </div>
    </div>
</div>
<!-- /container-fluid -->
<!-- Templates -->
<template id="message-template">
    <div class="adeptus-message">
        <div class="adeptus-message-content">
            <div class="adeptus-message-text"></div>
            <div class="adeptus-message-time small text-muted"></div>
        </div>
    </div>
</template>
<template id="optimization-suggestion-template">
    <div class="alert alert-info">
        <i class="fa fa-lightbulb"></i>
        <span class="adeptus-suggestion-text"></span>
    </div>
</template>
<template id="metric-template">
    <div class="adeptus-metric-item">
        <span class="adeptus-metric-label"></span>
        <span class="adeptus-metric-value"></span>
    </div>
</template>
