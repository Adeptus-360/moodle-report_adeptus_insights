{{!
    This file is part of Moodle - http://moodle.org/

    Moodle is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    Moodle is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
}}
{{!
    @template    report_adeptus_insights/wizard
    @package     report_adeptus_insights
    @copyright   2026 Adeptus 360 <info@adeptus360.com>
    @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later

    Report Wizard Template - Modern, Beautiful, Animated Interface
    Note: Do NOT load Bootstrap or Font Awesome from CDN - Moodle includes them and loading another version breaks things
}}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.all.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/simple-datatables@latest" type="text/javascript"></script>
<link href="https://cdn.jsdelivr.net/npm/simple-datatables@latest/dist/style.css" rel="stylesheet" type="text/css">

<style>
/* Premium Report Styles */
.adeptus-premium-report {
    position: relative;
    border: 2px solid #f39c12 !important;
    background: linear-gradient(135deg, #fff9e6 0%, #fff3cd 100%) !important;
}

.adeptus-premium-badge {
    background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
    color: white;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 10px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    box-shadow: 0 2px 4px rgba(243, 156, 18, 0.3);
    display: inline-flex;
    align-items: center;
    gap: 4px;
}

.adeptus-premium-badge i {
    font-size: 8px;
}

.adeptus-report-meta {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    align-items: center;
    margin-top: 8px;
}

/* Upgrade Popup Styles */
.adeptus-upgrade-popup .swal2-popup {
    border-radius: 15px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
}

.adeptus-upgrade-popup .swal2-title {
    color: #2c3e50;
    font-weight: 700;
}

/* Category Card Free Tier Indicator */
.adeptus-report-count {
    font-size: 12px;
    color: #7f8c8d;
    font-weight: 500;
}

.adeptus-category-card {
    position: relative;
}

/* Loading indicator styles - removed categories loading since we use full-screen loader */

/* New Section Styles */
.adeptus-wizard-section {
    margin: 40px 0;
    padding: 0 20px;
}

.adeptus-wizard-section .adeptus-step-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 30px;
    flex-wrap: wrap;
    gap: 15px;
}

.adeptus-wizard-section .adeptus-step-header h2 {
    margin: 0;
    font-size: 24px;
    color: #2c3e50;
    display: flex;
    align-items: center;
    gap: 12px;
}

.adeptus-wizard-section .adeptus-step-header p {
    margin: 5px 0 0 0;
    color: #7f8c8d;
    font-size: 14px;
}

.adeptus-wizard-section .adeptus-section-actions {
    display: flex;
    gap: 10px;
}

.adeptus-wizard-section .adeptus-section-actions button {
    padding: 8px 16px;
    border: 1px solid #ddd;
    background: white;
    border-radius: 6px;
    font-size: 12px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.adeptus-wizard-section .adeptus-section-actions button:hover {
    background: #f8f9fa;
    border-color: #007bff;
}

/* Report Card Styles (similar to category cards but with differences) */
.adeptus-report-card {
    background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
    border: 2px solid #e9ecef;
    border-radius: 12px;
    padding: 20px;
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.adeptus-report-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.1);
    border-color: #007bff;
}

.adeptus-report-card::after {
    content: '\f105';
    font-family: 'Font Awesome 6 Free';
    font-weight: 900;
    position: absolute;
    right: 20px;
    top: 50%;
    transform: translateY(-50%);
    color: #007bff;
    font-size: 16px;
    opacity: 0.7;
}

.adeptus-report-card .adeptus-card-icon {
    width: 50px;
    height: 50px;
    background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 15px;
    color: white;
    font-size: 20px;
}

.adeptus-report-card .adeptus-card-content h4 {
    margin: 0 0 8px 0;
    font-size: 16px;
    color: #2c3e50;
    font-weight: 600;
}

.adeptus-report-card .adeptus-card-content p {
    margin: 0 0 5px 0;
    color: #7f8c8d;
    font-size: 13px;
}

.adeptus-report-card .adeptus-card-content .adeptus-card-date {
    color: #95a5a6;
    font-size: 11px;
}

.adeptus-report-card .adeptus-card-actions {
    position: absolute;
    top: 15px;
    right: 50px;
    display: flex;
    gap: 5px;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.adeptus-report-card:hover .adeptus-card-actions {
    opacity: 1;
}

.adeptus-report-card .adeptus-card-actions button {
    min-width: 30px;
    height: 30px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 12px;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 4px;
    padding: 0 8px;
    white-space: nowrap;
}

.adeptus-report-card .adeptus-card-actions button span {
    font-size: 11px;
    font-weight: 500;
}

.adeptus-report-card .adeptus-card-actions .adeptus-btn-load-config {
    background: #28a745;
    color: white;
}

.adeptus-report-card .adeptus-card-actions .adeptus-btn-load-config:hover {
    background: #218838;
}

.adeptus-report-card .adeptus-card-actions .adeptus-btn-remove {
    background: #dc3545;
    color: white;
}

.adeptus-report-card .adeptus-card-actions .adeptus-btn-remove:hover {
    background: #c82333;
}

/* Category title styling */
.adeptus-category-title {
    font-size: 16px !important;
    font-weight: 600 !important;
}

/* Blue arrow for category cards */
.adeptus-category-card::after {
    content: '\f105'; /* FontAwesome chevron-right icon */
    font-family: 'Font Awesome 6 Free';
    font-weight: 900;
    position: absolute;
    top: 50%;
    right: 15px;
    transform: translateY(-50%);
    color: #3498db;
    font-size: 16px;
    opacity: 0.7;
}

/* Form Controls Styling */
.adeptus-form-control {
    width: 100% !important;
    padding: 8px 12px !important;
    font-size: 14px !important;
    line-height: 1.4 !important;
    border: 1px solid #ddd !important;
    border-radius: 4px !important;
    background-color: #fff !important;
    color: #333 !important;
    box-sizing: border-box !important;
}

.adeptus-form-control:focus {
    border-color: #3498db !important;
    outline: none !important;
    box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2) !important;
}

select.adeptus-form-control {
    height: auto !important;
    min-height: 38px !important;
}

select.adeptus-form-control option {
    padding: 8px 12px !important;
    font-size: 14px !important;
    line-height: 1.4 !important;
}

/* Parameter field styling */
.adeptus-parameter-field {
    margin-bottom: 20px;
}

.adeptus-parameter-field label {
    display: block;
    margin-bottom: 6px;
    font-weight: 600;
    color: #2c3e50;
    font-size: 14px;
}

.adeptus-parameter-field .adeptus-form-control {
    width: 100%;
}

.adeptus-parameter-field .adeptus-help-text {
    font-size: 12px;
    color: #7f8c8d;
    margin-top: 4px;
    font-style: italic;
}
</style>

{{#js}}
require(['jquery', 'core/ajax', 'core/notification', 'core/templates', 'report_adeptus_insights/global_auth'], function($, Ajax, Notification, Templates, GlobalAuth) {
    // Initialize global authentication first
    // Note: Chart.js is loaded by wizard.js directly (not core/chartjs) to avoid Moodle reactive component conflicts
    GlobalAuth.init().then(() => {
        // Reduced delay to 100ms for faster perceived load time
        setTimeout(function() {
            if (typeof AdeptusWizard !== 'undefined') {
                const wizard = new AdeptusWizard();
                window.adeptusWizardInstance = wizard;

                // Show loading modal IMMEDIATELY before async initialization
                wizard.showLoading('Loading categories...');

                wizard.init()
                    .catch(error => {
                        console.error('Failed to initialize AdeptusWizard:', error);
                        wizard.hideLoading();
                    });
            } else {
                console.error('AdeptusWizard class not found');
            }
        }, 100); // Reduced from 1000ms to 100ms
    }).catch((error) => {
        console.error('Failed to initialize global authentication:', error);
    });
});
{{/js}}

<!-- Global Authentication Header -->
{{> report_adeptus_insights/global_auth_header }}

<div class="adeptus-wizard-container" id="wizard-container">
    <!-- Header Section -->
    <div class="adeptus-wizard-header">
        <div class="adeptus-wizard-header-content">
            <h1 class="adeptus-wizard-title">
                <i class="fa-solid fa-wand-magic-sparkles adeptus-wizard-icon"></i>
                {{wizard_title}}
            </h1>
            <p class="adeptus-wizard-subtitle">{{#str}}wizard_subtitle, report_adeptus_insights{{/str}}</p>

        </div>
        <div class="adeptus-wizard-header-section">
            <a href="{{wwwroot}}/report/adeptus_insights/index.php" class="btn btn-primary adeptus-back-to-dashboard-btn">
                <i class="fa-solid fa-arrow-left"></i> {{#str}}back_to_dashboard, report_adeptus_insights{{/str}}
            </a>
        </div>
    </div>

    <!-- Main Wizard Steps -->
    <div class="adeptus-wizard-steps-container">

        <!-- Step 1: Select Report Category -->
        <div class="adeptus-wizard-step active" id="step-select-category">
            <div class="adeptus-step-header">
                <h2><span class="adeptus-step-number">1</span> {{#str}}choose_report_category, report_adeptus_insights{{/str}}</h2>
                <p>{{#str}}category_select_description, report_adeptus_insights{{/str}}</p>
            </div>

            <div class="adeptus-category-grid">
                {{#categories}}
                <div class="adeptus-category-card" data-category="{{name}}">
                    <div class="adeptus-category-icon">
                        <i class="fa-solid {{icon}}"></i>
                    </div>
                    <div class="adeptus-category-content">
                        <h6>{{name}}</h6>
                        {{#is_free_plan}}
                        <span class="adeptus-report-count">{{free_reports_count}} out of {{report_count}} reports on free tier</span>
                        {{/is_free_plan}}
                        {{^is_free_plan}}
                        <span class="adeptus-report-count">{{report_count}} reports</span>
                        {{/is_free_plan}}
                    </div>
                    <div class="adeptus-category-arrow">
                        <i class="fa-solid fa-chevron-right"></i>
                    </div>
                </div>
                {{/categories}}
            </div>
        </div>

        <!-- Step 2: Select Specific Report -->
        <div class="adeptus-wizard-step" id="step-select-report">
            <div class="adeptus-step-header" style="display: flex; justify-content: space-between;">
                <div class="adeptus-assistant-header">
                    <h2><span class="adeptus-step-number">2</span> {{#str}}choose_your_report, report_adeptus_insights{{/str}}</h2>
                    <p id="selected-category-name">{{#str}}reports_in_category, report_adeptus_insights{{/str}}</p>
               </div>
               <div class="adeptus-back-to-categories-btn">
                    <button class="adeptus-btn-back" id="back-to-categories">
                        <i class="fa-solid fa-arrow-left"></i> {{#str}}back_to_categories, report_adeptus_insights{{/str}}
                    </button>
                </div>
            </div>

            <div class="adeptus-reports-grid" id="reports-grid">
                <!-- Reports will be populated dynamically -->
            </div>
        </div>

        <!-- Step 3: Configure Parameters -->
        <div class="adeptus-wizard-step" id="step-configure">
            <div class="adeptus-step-header" style="display: flex; justify-content: space-between;">
                <div class="adeptus-assistant-header">
                    <h2><span class="adeptus-step-number">3</span> {{#str}}configure_report, report_adeptus_insights{{/str}}</h2>
                    <p id="selected-report-name">{{#str}}configure_parameters, report_adeptus_insights{{/str}}</p>

                </div>
               <div class="adeptus-back-to-categories-btn">
                    <button class="adeptus-btn-back" id="back-to-reports">
                        <i class="fa-solid fa-arrow-left"></i> {{#str}}back_to_reports, report_adeptus_insights{{/str}}
                    </button>
                </div>
            </div>

            <div class="adeptus-configuration-container">
                <div class="adeptus-config-form" id="config-form">
                    <!-- Parameters will be populated dynamically -->
                </div>

                <div class="adeptus-config-preview">
                    <h3>{{#str}}report_preview, report_adeptus_insights{{/str}}</h3>
                    <div class="adeptus-preview-content" id="preview-content">
                        <div class="adeptus-preview-placeholder">
                            <i class="fa-solid fa-eye"></i>
                            <p>{{#str}}configure_for_preview, report_adeptus_insights{{/str}}</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="adeptus-step-actions">
                <button class="adeptus-btn-primary adeptus-btn-generate-report" id="generate-report">
                    <i class="fa-solid fa-play"></i> {{#str}}generate_report, report_adeptus_insights{{/str}}
                </button>
                <button class="adeptus-btn-secondary adeptus-btn-save-config" id="save-config">
                    <i class="fa-solid fa-bookmark"></i> {{#str}}bookmark_configuration, report_adeptus_insights{{/str}}
                </button>
            </div>
        </div>

        <!-- Step 4: View Results -->
        <div class="adeptus-wizard-step" id="step-results">
            <div class="adeptus-step-header" style="display: flex; justify-content: space-between;">
                <div class="adeptus-assistant-header">
                    <h2><span class="adeptus-step-number">4</span> {{#str}}report_results, report_adeptus_insights{{/str}}</h2>
                    <p id="results-report-name">{{#str}}your_generated_report, report_adeptus_insights{{/str}}</p>
                </div>
               <div class="adeptus-back-to-categories-btn">
                     <button class="adeptus-btn-back" id="back-to-config">
                    <i class="fa-solid fa-arrow-left"></i> {{#str}}back_to_configuration, report_adeptus_insights{{/str}}
                     </button>
                </div>
            </div>

            <div class="adeptus-results-container">
                <div class="adeptus-results-toolbar">
                    <div class="adeptus-results-info">
                        <span id="results-count">{{#str}}loading, report_adeptus_insights{{/str}}</span>
                    </div>
                    <div class="adeptus-results-actions">
                        <div class="adeptus-export-dropdown">
                            <button class="adeptus-btn-export" id="export-btn">
                                <i class="fa-solid fa-download"></i> {{#str}}export, report_adeptus_insights{{/str}}
                                <i class="fa-solid fa-chevron-down"></i>
                            </button>
                            <div class="adeptus-export-menu" id="export-menu">
                                <a href="#" data-format="csv" class="{{#is_free_plan}}adeptus-export-premium{{/is_free_plan}}">
                                    <i class="fa-regular fa-file-lines"></i> CSV
                                    {{#is_free_plan}}<span class="adeptus-premium-badge-small"><i class="fa-solid fa-crown"></i></span>{{/is_free_plan}}
                                </a>
                                <a href="#" data-format="excel" class="{{#is_free_plan}}adeptus-export-premium{{/is_free_plan}}">
                                    <i class="fa-regular fa-file-excel"></i> Excel
                                    {{#is_free_plan}}<span class="adeptus-premium-badge-small"><i class="fa-solid fa-crown"></i></span>{{/is_free_plan}}
                                </a>
                                <a href="#" data-format="pdf"><i class="fa-regular fa-file-pdf"></i> PDF</a>
                                <a href="#" data-format="json" class="{{#is_free_plan}}adeptus-export-premium{{/is_free_plan}}">
                                    <i class="fa-solid fa-code"></i> JSON
                                    {{#is_free_plan}}<span class="adeptus-premium-badge-small"><i class="fa-solid fa-crown"></i></span>{{/is_free_plan}}
                                </a>
                            </div>
                        </div>
                        <button class="adeptus-btn-bookmark" id="bookmark-report">
                            <i class="fa-regular fa-star"></i> {{#str}}bookmark, report_adeptus_insights{{/str}}
                        </button>
                        <button class="adeptus-btn-regenerate" id="regenerate-report">
                            <i class="fa-solid fa-rotate"></i> {{#str}}regenerate, report_adeptus_insights{{/str}}
                        </button>
                    </div>
                </div>

                <div class="adeptus-results-content">
                    <div class="adeptus-results-view-header">
                        <div class="adeptus-view-toggle btn-group" role="group">
                            <button type="button" class="btn btn-sm adeptus-view-toggle-btn active" data-view="table">
                                <i class="fa-solid fa-table"></i> {{#str}}table, report_adeptus_insights{{/str}}
                            </button>
                            <button type="button" class="btn btn-sm adeptus-view-toggle-btn" data-view="chart">
                                <i class="fa-solid fa-chart-bar"></i> {{#str}}chart, report_adeptus_insights{{/str}}
                            </button>
                        </div>
                    </div>

                    <div class="adeptus-results-data">
                        <div class="adeptus-view-panel" id="table-view">
                            <div class="adeptus-table-container" id="results-table">
                                <!-- Table will be populated dynamically -->
                            </div>
                        </div>
                        <div class="adeptus-view-panel d-none" id="chart-view">
                            <div class="adeptus-chart-controls-wrapper" id="chart-controls">
                                <!-- Chart controls will be populated dynamically -->
                            </div>
                            <div class="adeptus-chart-container" id="results-chart">
                                <!-- Chart will be populated dynamically -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Generated Reports Section -->
    <div class="adeptus-wizard-section" id="generated-reports-section" style="display: none;">
        <div class="adeptus-step-header">
            <h2><span class="adeptus-step-number">üìä</span> {{#str}}generated_reports_section, report_adeptus_insights{{/str}}</h2>
            <p>{{#str}}generated_reports_section_desc, report_adeptus_insights{{/str}}</p>
        </div>

        <div class="adeptus-category-grid" id="generated-reports-grid">
            <!-- Generated report cards will be populated by JavaScript -->
        </div>
    </div>

    <!-- Recent Reports Section -->
    <div class="adeptus-wizard-section" id="recent-reports-section" style="display: none;">
        <div class="adeptus-step-header">
            <h2><span class="adeptus-step-number">üïí</span> {{#str}}recent_reports, report_adeptus_insights{{/str}}</h2>
            <p>{{#str}}recent_reports_desc, report_adeptus_insights{{/str}}</p>
            <div class="adeptus-section-actions">
                <button class="adeptus-btn-toggle-recent" id="toggle-recent-reports">
                    <i class="fa-solid fa-eye"></i> {{#str}}show_all, report_adeptus_insights{{/str}}
                </button>
                <button class="adeptus-btn-clear-recent" id="clear-recent-reports">
                    <i class="fa-solid fa-trash"></i> {{#str}}clear_all, report_adeptus_insights{{/str}}
                </button>
            </div>
        </div>

        <div class="adeptus-category-grid" id="recent-reports-grid">
            <!-- Recent report cards will be populated by JavaScript -->
        </div>
    </div>

    <!-- Bookmarks Section -->
    <div class="adeptus-wizard-section" id="bookmarks-section" style="display: none;">
        <div class="adeptus-step-header">
            <h2><span class="adeptus-step-number">‚≠ê</span> {{#str}}bookmarked_reports, report_adeptus_insights{{/str}}</h2>
            <p>{{#str}}bookmarked_reports_desc, report_adeptus_insights{{/str}}</p>
            <div class="adeptus-section-actions">
                <button class="adeptus-btn-clear-bookmarks" id="clear-bookmarked-reports">
                    <i class="fa-solid fa-trash"></i> {{#str}}clear_all, report_adeptus_insights{{/str}}
                </button>
            </div>
        </div>

        <div class="adeptus-category-grid" id="bookmarks-grid">
            <!-- Bookmark cards will be populated by JavaScript -->
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="adeptus-loading-overlay" id="loading-overlay">
        <div class="adeptus-loading-content">
            <div class="adeptus-loading-spinner"></div>
            <h3>{{#str}}generating_report, report_adeptus_insights{{/str}}</h3>
            <p>{{#str}}processing_request, report_adeptus_insights{{/str}}</p>
        </div>
    </div>

    <!-- Success/Error Popup -->
    <div class="adeptus-popup-overlay" id="popup-overlay">
        <div class="adeptus-popup-content" id="popup-content">
            <h3 id="popup-title">{{#str}}message, report_adeptus_insights{{/str}}</h3>
            <p id="popup-message"></p>
            <button class="adeptus-btn-close" id="popup-close">{{#str}}ok, report_adeptus_insights{{/str}}</button>
        </div>
    </div>

    <!-- Hidden Data for JavaScript -->
    <script type="application/json" id="wizard-data">
        {
            "categories": {{{categories_json}}},
            "wwwroot": "{{wwwroot}}",
            "sesskey": "{{sesskey}}",
            "api_key": "{{api_key}}",
            "backend_api_url": "{{backend_api_url}}",
            "bookmarked_report_ids": {{{bookmarked_report_ids}}},
            "is_free_plan": {{is_free_plan}},
            "subscription": {{{subscription_json}}},
            "recent_reports": {{{recent_reports_json}}},
            "generated_reports": {{{generated_reports_json}}},
            "bookmarks": {{{bookmarks_json}}}
        }
    </script>
</div>

