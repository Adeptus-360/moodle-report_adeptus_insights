{{!
    This file is part of Moodle - http://moodle.org/
    Subscription Installation Step Template - Part of Plugin Installation Flow
}}

<style>
.adeptus-installation-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
}

.installation-header {
    background: linear-gradient(135deg, #0ea5e9 0%, #2563eb 100%);
    color: white;
    padding: 40px;
    border-radius: 15px;
    text-align: center;
    margin-bottom: 30px;
    box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
}

.installation-header h1 {
    margin: 0;
    font-size: 32px;
    font-weight: 600;
}

.installation-header p {
    margin: 15px 0 0 0;
    opacity: 0.9;
    font-size: 18px;
}

.installation-progress {
    display: flex;
    justify-content: center;
    margin-bottom: 30px;
}

.progress-step {
    display: flex;
    align-items: center;
    margin: 0 20px;
}

.progress-step .step-number {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    margin-right: 10px;
}

.progress-step.completed .step-number {
    background: #28a745;
    color: white;
}

.progress-step.current .step-number {
    background: #2563eb;
    color: white;
}

.progress-step.pending .step-number {
    background: #e9ecef;
    color: #6c757d;
}

.progress-step .step-label {
    font-weight: 500;
    color: #333;
}

.progress-step.completed .step-label {
    color: #28a745;
}

.progress-step.current .step-label {
    color: #2563eb;
}

.progress-step.pending .step-label {
    color: #6c757d;
}

.progress-connector {
    width: 60px;
    height: 2px;
    background: #e9ecef;
    margin: 0 10px;
}

.progress-connector.completed {
    background: #28a745;
}

.current-plan-section {
    background: white;
    border: 2px solid #28a745;
    border-radius: 15px;
    padding: 30px;
    margin-bottom: 30px;
    box-shadow: 0 4px 15px rgba(40, 167, 69, 0.1);
}

.current-plan-header {
    text-align: center;
    margin-bottom: 25px;
}

.current-plan-header h3 {
    color: #28a745;
    font-size: 24px;
    margin: 0 0 10px 0;
}

.current-plan-header .status-badge {
    background: #28a745;
    color: white;
    padding: 8px 20px;
    border-radius: 20px;
    font-weight: 600;
    font-size: 14px;
}

.current-plan-details {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 25px;
}

.plan-feature {
    text-align: center;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 10px;
}

.plan-feature i {
    font-size: 24px;
    color: #2563eb;
    margin-bottom: 10px;
}

.plan-feature .feature-value {
    font-size: 20px;
    font-weight: 600;
    color: #333;
    margin-bottom: 5px;
}

.plan-feature .feature-label {
    color: #666;
    font-size: 14px;
}

.upgrade-options-section {
    background: white;
    border: 1px solid #e1e5e9;
    border-radius: 15px;
    padding: 30px;
    margin-bottom: 30px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.upgrade-options-header {
    text-align: center;
    margin-bottom: 30px;
}

.upgrade-options-header h3 {
    color: #333;
    font-size: 24px;
    margin: 0 0 10px 0;
}

.upgrade-options-header p {
    color: #666;
    font-size: 16px;
    margin: 0;
}

.plans-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 25px;
    margin-bottom: 30px;
}

.plan-card {
    background: white;
    border: 2px solid #e1e5e9;
    border-radius: 15px;
    padding: 25px;
    text-align: center;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.plan-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
}

.plan-card.current {
    border-color: #28a745;
    background: linear-gradient(135deg, #f8fff9 0%, #f0fff4 100%);
}

.plan-card.upgrade {
    border-color: #2563eb;
    background: linear-gradient(135deg, #f8f9ff 0%, #f0f4ff 100%);
}

.plan-card .plan-badge {
    position: absolute;
    top: 15px;
    right: 15px;
    padding: 5px 12px;
    border-radius: 15px;
    font-size: 12px;
    font-weight: 600;
}

.plan-card.current .plan-badge {
    background: #28a745;
    color: white;
}

.plan-card.upgrade .plan-badge {
    background: #2563eb;
    color: white;
}

.plan-card .plan-name {
    font-size: 22px;
    font-weight: 600;
    color: #333;
    margin-bottom: 15px;
}

.plan-card .plan-price {
    font-size: 32px;
    font-weight: 700;
    color: #2563eb;
    margin-bottom: 10px;
}

.plan-card .plan-price .currency {
    font-size: 20px;
    vertical-align: top;
}

.plan-card .plan-price .billing-cycle {
    font-size: 16px;
    color: #666;
    font-weight: 400;
}

.plan-card .plan-description {
    color: #666;
    margin-bottom: 25px;
    line-height: 1.5;
}

.plan-features-list {
    text-align: left;
    margin-bottom: 25px;
}

.plan-features-list ul {
    list-style: none;
    padding: 0;
    margin: 0;
}

.plan-features-list li {
    padding: 8px 0;
    color: #555;
    display: flex;
    align-items: center;
}

.plan-features-list li i {
    color: #28a745;
    margin-right: 10px;
    width: 16px;
}

.plan-card .plan-actions {
    margin-top: auto;
}

.plan-card.current .plan-actions button {
    background: #28a745;
    color: white;
    border: none;
    padding: 12px 30px;
    border-radius: 25px;
    font-weight: 600;
    cursor: pointer;
    opacity: 0.8;
}

.plan-card.upgrade .plan-actions button {
    background: linear-gradient(135deg, #0ea5e9 0%, #2563eb 100%);
    color: white;
    border: none;
    padding: 12px 30px;
    border-radius: 25px;
    font-weight: 600;
    cursor: pointer;
    transition: transform 0.2s ease;
}

.plan-card.upgrade .plan-actions button:hover {
    transform: translateY(-2px);
}

.installation-actions {
    text-align: center;
    padding: 30px;
    background: white;
    border: 1px solid #e1e5e9;
    border-radius: 15px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.installation-actions h3 {
    color: #333;
    font-size: 20px;
    margin-bottom: 20px;
}

.installation-actions p {
    color: #666;
    margin-bottom: 25px;
    line-height: 1.6;
}

    .action-buttons {
        display: flex;
        gap: 20px;
        justify-content: center;
        flex-wrap: wrap;
    }
    
    .upgrade-form,
    .complete-form {
        display: inline;
    }
    
    .upgrade-form,
    .complete-form {
        display: inline;
    }

.btn-complete {
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    color: white;
    border: none;
    padding: 15px 40px;
    border-radius: 25px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: transform 0.2s ease;
    text-decoration: none;
    display: inline-block;
}

.btn-complete:hover {
    transform: translateY(-2px);
    color: white;
    text-decoration: none;
}

.btn-upgrade-later {
    background: white;
    color: #2563eb;
    border: 2px solid #2563eb;
    padding: 15px 40px;
    border-radius: 25px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: transform 0.2s ease;
    text-decoration: none;
    display: inline-block;
}

.btn-upgrade-later:hover {
    transform: translateY(-2px);
    color: #2563eb;
    text-decoration: none;
}

@media (max-width: 768px) {
    .installation-progress {
        flex-direction: column;
        gap: 15px;
    }
    
    .progress-connector {
        display: none;
    }
    
    .plans-grid {
        grid-template-columns: 1fr;
    }
    
    .action-buttons {
        flex-direction: column;
        align-items: center;
    }
}
</style>

<div class="adeptus-installation-container">
    <!-- Installation Header -->
    <div class="installation-header">
        <h1><i class="fa fa-credit-card"></i> {{#str}}subscription_setup, report_adeptus_insights{{/str}}</h1>
        <p>Choose your plan and complete the plugin installation</p>
    </div>

    <!-- Installation Progress -->
    <div class="installation-progress">
        <div class="progress-step completed">
            <div class="step-number">1</div>
            <div class="step-label">Plugin Registration</div>
        </div>
        <div class="progress-connector completed"></div>
        <div class="progress-step current">
            <div class="step-number">2</div>
            <div class="step-label">Subscription Setup</div>
        </div>
        <div class="progress-connector"></div>
        <div class="progress-step pending">
            <div class="step-number">3</div>
            <div class="step-label">Installation Complete</div>
        </div>
    </div>

    <!-- Current Plan Section -->
    {{#current_subscription}}
    <div class="current-plan-section">
        <div class="current-plan-header">
            <h3><i class="fa fa-check-circle"></i> Your Current Plan</h3>
            <div class="status-badge">Active</div>
        </div>
        
        <div class="current-plan-details">
            <div class="plan-feature">
                <i class="fa fa-brain"></i>
                <div class="feature-value">{{ai_credits_remaining}}</div>
                <div class="feature-label">AI Credits</div>
            </div>
            <div class="plan-feature">
                <i class="fa fa-download"></i>
                <div class="feature-value">{{exports_remaining}}</div>
                <div class="feature-label">Exports</div>
            </div>
            <div class="plan-feature">
                <i class="fa fa-calendar"></i>
                <div class="feature-value">{{plan_name}}</div>
                <div class="feature-label">Plan Type</div>
            </div>
            <div class="plan-feature">
                <i class="fa fa-clock-o"></i>
                <div class="feature-value">Free</div>
                <div class="feature-label">Price</div>
            </div>
        </div>
    </div>
    {{/current_subscription}}

    <!-- Upgrade Options Section -->
    <div class="upgrade-options-section">
        <div class="upgrade-options-header">
            <h3><i class="fa fa-arrow-up"></i> Available Plans</h3>
            <p>You can upgrade or downgrade your plan at any time from your subscription dashboard</p>
        </div>
        
        <div class="plans-grid">
            {{#available_plans}}
            <div class="plan-card {{#is_current}}current{{/is_current}}{{^is_current}}upgrade{{/is_current}}">
                <div class="plan-badge">
                    {{#is_current}}Current{{/is_current}}{{^is_current}}Upgrade{{/is_current}}
                </div>
                
                <div class="plan-name">{{name}}</div>
                <div class="plan-price">
                    <span class="currency">{{#is_free}}Free{{/is_free}}{{^is_free}}${{/is_free}}</span>
                    {{^is_free}}{{price}}{{/is_free}}
                    <div class="billing-cycle">{{billing_cycle}}</div>
                </div>
                
                <div class="plan-description">{{description}}</div>
                
                <div class="plan-features-list">
                    <ul>
                        {{#ai_credits_pro}}
                        <li><i class="fa fa-star"></i> {{ai_credits_pro}} Pro AI Credits</li>
                        {{/ai_credits_pro}}
                        {{#ai_credits_basic}}
                        <li><i class="fa fa-circle"></i> {{ai_credits_basic}} Basic AI Credits</li>
                        {{/ai_credits_basic}}
                        <li><i class="fa fa-download"></i> {{exports}} Exports per month</li>
                        {{#features}}
                        <li><i class="fa fa-check"></i> {{.}}</li>
                        {{/features}}
                    </ul>
                </div>
                
                <div class="plan-actions">
                    {{#is_current}}
                    <button disabled>Current Plan</button>
                    {{/is_current}}
                    {{^is_current}}
                    <button type="button" class="btn-upgrade-plan" data-product-id="{{stripe_product_id}}" data-plan-name="{{name}}">
                        Upgrade to {{name}}
                    </button>
                    {{/is_current}}
                </div>
            </div>
            {{/available_plans}}
        </div>

<div class="action-buttons">
        <form method="post" class="complete-form">
                <input type="hidden" name="sesskey" value="{{sesskey}}">
                <input type="hidden" name="action" value="complete_installation">
                <button type="submit" class="btn-complete">
                    <i class="fa fa-check"></i> Complete Installation
                </button>
            </form>
            </div> 
    </div>

</div>

{{#js}}
require(['jquery', 'core/ajax', 'core/notification'], function($, Ajax, Notification) {
    // Handle upgrade plan buttons in installation step
    $(document).ready(function() {
        $('.btn-upgrade-plan').on('click', function() {
            const stripeProductId = $(this).data('product-id');
            const planName = $(this).data('plan-name');
            
            if (!stripeProductId) {
                Notification.addNotification({
                    message: 'Product ID not available. Please contact support.',
                    type: 'warning'
                });
                return;
            }
            
            // Create portal session for this specific product
            createProductPortalSession(stripeProductId, planName);
        });
        
        function createProductPortalSession(stripeProductId, planName) {
            const returnUrl = window.location.href;
            
            Ajax.call([{
                methodname: 'report_adeptus_insights_create_product_portal_session',
                args: {
                    product_id: stripeProductId,
                    return_url: returnUrl,
                    sesskey: M.cfg.sesskey
                },
                done: function(response) {
                    if (response.success && response.portal_url) {
                        Notification.addNotification({
                            message: `Redirecting to upgrade ${planName}...`,
                            type: 'success'
                        });
                        
                        // Redirect to Stripe portal
                        setTimeout(function() {
                            window.location.href = response.portal_url;
                        }, 1000);
                    } else {
                        Notification.addNotification({
                            message: response.message || 'Failed to create upgrade portal session',
                            type: 'error'
                        });
                    }
                },
                fail: function(error) {
                    Notification.addNotification({
                        message: 'Failed to create upgrade portal session. Please try again.',
                        type: 'error'
                    });
                }
            }]);
        }
    });
});
{{/js}}